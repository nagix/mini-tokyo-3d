/*!
 * mt3d-plugin-plateau v0.2.0
 * https://minitokyo3d.com
 * (c) 2022-2026 Akihiko Kusanagi
 * Released under the MIT license
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).mt3dPlateau=t()}(this,(function(){"use strict";class e{constructor(e){const t=this;t.id="plateau",t.name={de:"PLATEAU",en:"PLATEAU",es:"PLATEAU",fr:"PLATEAU",ja:"PLATEAU",ko:"PLATEAU",ne:"PLATEAU",pt:"PLATEAU",th:"PLATEAU","zh-Hans":"PLATEAU","zh-Hant":"PLATEAU"},t.iconStyle={backgroundSize:"32px",backgroundImage:"url(\"data:image/svg+xml,%3csvg width='40' height='40' fill='white' version='1.1' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='m19.59 16.06-13.5-7.793v15.59l27.82 16.06v-15.59l-5.565-3.213-5.565-3.213z'/%3e%3cpath d='m19.59 0-13.09 7.555 13.09 7.555z'/%3e%3cpath d='m26.75 19.24v-7.793l6.749-3.897-13.08-7.555v15.59l2.534 1.463z'/%3e%3cpath d='m33.91 23.38v-15.11l-6.336 3.658v7.794l1.267 0.7315z'/%3e%3c/svg%3e\")"},t.viewModes=["ground"],t.enabled=e&&e.enabled,t._tick=t._tick.bind(t),t._updateLayers=t._updateLayers.bind(t),t._layers=new Set}onAdd(e){this.map=e}onRemove(e){for(const t of["gsi-ortho","plateau-ortho","plateau-model"])e.removeLayer(t);for(const t of this._layer)e.removeLayer(`tile-3d-${t}`)}onEnabled(){const{map:e,_tick:t,_updateLayers:a}=this;e.setLayerVisibility("building-3d","none"),e.getMapboxMap().getLayer("plateau-ortho")||(e.addLayer({id:"gsi-ortho",type:"raster",source:{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg"],maxzoom:18,minzoom:2,attribution:'<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>'}},"stations-marked-13"),e.addLayer({id:"plateau-ortho",type:"raster",source:{type:"raster",tiles:["https://api.plateauview.mlit.go.jp/tiles/plateau-ortho-2023/{z}/{x}/{y}.png"],maxzoom:19,minzoom:10,attribution:'<a href="https://www.mlit.go.jp/plateau/">国土交通省Project PLATEAU</a>'}},"stations-marked-13"),e.addLayer({id:"plateau-model",type:"fill",source:{type:"geojson",data:"https://mini-tokyo.appspot.com/plateau-models.geojson"},paint:{"fill-opacity":0}},"stations-marked-13"),t(),e.on("move",a))}_tick(){const e=this,{map:t,lastRefresh:a,_tick:o}=e,i=t.getMapboxMap(),s=t.clock.getTime();if(i.getLayer("plateau-ortho")){if(Math.floor(s/6e4)!==Math.floor(a/6e4)){const{r:a,g:o,b:r}=t.getLightColor(),n=.2126*a+.7152*o+.0722*r;for(const e of["gsi-ortho","plateau-ortho"])i.setPaintProperty(e,"raster-brightness-max",n);e.lastRefresh=s}requestAnimationFrame(o)}}_updateLayers(){const{map:e,_layers:t}=this,{width:a,height:o}=e.container.getBoundingClientRect(),i=e.getMapboxMap().queryRenderedFeatures([a/2,o/2],{layers:["plateau-model"]}),s=new Set(t);for(const a of i){const{code:o,url:i}=a.properties;s.delete(o),t.has(o)||(e.addLayer({id:`tile-3d-${o}`,type:"tile-3d",data:i,loadOptions:{tileset:{throttleRequests:!1}},minzoom:13,opacity:.8,onTileLoad:({content:e})=>{const t=e.batchTableJson._zmin,a=e.cartographicOrigin;if(t){const o=e.featureTableJson.BATCH_LENGTH,i=new DataView(e.batchTableBinary.buffer,t.byteOffset,8*o),s=[];for(let e=0;e<o;e++)s.push(i.getFloat64(8*e,!0));s.sort(((e,t)=>e-t)),a.z-=s[Math.floor(o/2)]}a.z-=36.6641,e.featureTableBinary=null,e.featureTableJson=null,e.batchTableBinary=null,e.batchTableJson=null;for(const t of e.gltf.images||[]){const e=t.image;createImageBitmap(e,{resizeWidth:e.width/4,resizeHeight:e.height/4}).then((e=>{t.image=e}))}}}),t.add(o))}for(const a of s)e.removeLayer(`tile-3d-${a}`),t.delete(a)}onDisabled(){const{map:e,_updateLayers:t}=this;e.setLayerVisibility("building-3d","visible"),e.off("move",t)}onVisibilityChanged(e){const{map:t,_layers:a,_updateLayers:o}=this,i=t.getMapboxMap();if(i.getLayer("plateau-ortho")){const s=e?"visible":"none";for(const e of["gsi-ortho","plateau-ortho","plateau-model"])t.setLayerVisibility(e,s);for(const e of a)t.setLayerVisibility(`tile-3d-${e}`,s);i.once("idle",o)}}}return function(t){return new e(t)}}));
//# sourceMappingURL=mt3d-plugin-plateau.min.js.map
