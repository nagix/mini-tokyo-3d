/*!
 * mt3d-plugin-precipitation v1.4.0
 * https://minitokyo3d.com
 * (c) 2021-2026 Akihiko Kusanagi
 * Released under the MIT license
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("mini-tokyo-3d")):"function"==typeof define&&define.amd?define(["mini-tokyo-3d"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).mt3dPrecipitation=t(e.mt3d)}(this,(function(e){"use strict";var t,i={};var o=function(){if(t)return i;t=1;var e={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function o(e){return(e=Math.round(e))<0?0:e>255?255:e}function r(e){return e<0?0:e>1?1:e}function a(e){return o("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e))}function n(e){return r("%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))}function s(e,t,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?e+(t-e)*i*6:2*i<1?t:3*i<2?e+(t-e)*(2/3-i)*6:e}try{i.parseCSSColor=function(t){var i,r=t.replace(/ /g,"").toLowerCase();if(r in e)return e[r].slice();if("#"===r[0])return 4===r.length?(i=parseInt(r.substr(1),16))>=0&&i<=4095?[(3840&i)>>4|(3840&i)>>8,240&i|(240&i)>>4,15&i|(15&i)<<4,1]:null:7===r.length&&(i=parseInt(r.substr(1),16))>=0&&i<=16777215?[(16711680&i)>>16,(65280&i)>>8,255&i,1]:null;var F=r.indexOf("("),l=r.indexOf(")");if(-1!==F&&l+1===r.length){var c=r.substr(0,F),h=r.substr(F+1,l-(F+1)).split(","),u=1;switch(c){case"rgba":if(4!==h.length)return null;u=n(h.pop());case"rgb":return 3!==h.length?null:[a(h[0]),a(h[1]),a(h[2]),u];case"hsla":if(4!==h.length)return null;u=n(h.pop());case"hsl":if(3!==h.length)return null;var m=(parseFloat(h[0])%360+360)%360/360,d=n(h[1]),p=n(h[2]),f=p<=.5?p*(d+1):p+d-p*d,g=2*p-f;return[o(255*s(g,f,m+1/3)),o(255*s(g,f,m)),o(255*s(g,f,m-1/3)),u];default:return null}}return null}}catch(e){}return i}();const{Evented:r,MercatorCoordinate:a}=e.mapboxgl,{AmbientLight:n,BoxGeometry:s,BufferAttribute:F,Camera:l,Color:c,DirectionalLight:h,DoubleSide:u,Group:m,InstancedBufferGeometry:d,InstancedMesh:p,InstancedBufferAttribute:f,Matrix4:g,Mesh:y,MeshLambertMaterial:_,RawShaderMaterial:v,Scene:w,Vector4:b,WebGLRenderer:C}=e.THREE;var M={noaa:{scale:[{value:0,color:"#000000"},{value:5,color:"#69E5E4"},{value:10,color:"#4599E9"},{value:15,color:"#0F02E7"},{value:20,color:"#72F44A"},{value:25,color:"#59C239"},{value:30,color:"#3E8B27"},{value:35,color:"#F8F551"},{value:40,color:"#DDBC3F"},{value:45,color:"#EA9736"},{value:50,color:"#E33323"},{value:55,color:"#BF281C"},{value:60,color:"#A72318"},{value:65,color:"#E131F0"},{value:70,color:"#8D54BF"},{value:75,color:"#FEFEFE"}],align:"center"}},x={jma:{type:"raster",tiles:["https://www.jma.go.jp/bosai/jmatile/data/nowc/${[0].basetime}/none/${[0].validtime}/surf/hrpns/{z}/{x}/{y}.png"],tileSize:256,minzoom:0,maxzoom:10,attribution:'<a href="https://www.jma.go.jp">© Japan Meteorological Agency</a>',catalog:"https://www.jma.go.jp/bosai/jmatile/data/nowc/targetTimes_N1.json",interval:3e5,colors:{"#00000000":0,"#F2F2FFFF":39,"#A0D2FFFF":55,"#218CFFFF":66,"#0041FFFF":71,"#FAF500FF":76,"#FF9900FF":79,"#FF2800FF":82,"#B40068FF":86},timestamp:"${[0].basetime}"},rainviewer:{type:"raster",tiles:["${host}${radar.past[-1].path}/256/{z}/{x}/{y}/0/0_1.png"],tileSize:256,minzoom:1,maxzoom:7,attribution:'<a href="https://www.rainviewer.com">© RainViewer</a>',catalog:"https://api.rainviewer.com/public/weather-maps.json",interval:6e5,colors:{"#00000000":0,"#63615914":22,"#66635A19":23,"#69665C1E":24,"#6C685D24":25,"#6F6B5F29":26,"#726E612E":27,"#75706234":28,"#78736439":29,"#7C75653E":30,"#7F786744":31,"#827B6949":32,"#857D6A4E":33,"#88806C54":34,"#8B826D59":35,"#8E856F5E":36,"#92887164":37,"#9E93756E":38,"#AA9E7978":39,"#B6A97E82":40,"#C2B4828C":41,"#CEC08796":42,"#D2C48BA0":43,"#D6C88FAA":44,"#DACC93B4":45,"#DED097BE":46,"#88DDEEFF":47,"#6CD1EBFF":48,"#51C5E8FF":49,"#36BAE5FF":50,"#1BAEE2FF":51,"#00A3E0FF":52,"#009AD5FF":53,"#0091CAFF":54,"#0088BFFF":55,"#007FB4FF":56,"#0077AAFF":57,"#0070A3FF":58,"#00699CFF":59,"#006295FF":60,"#005B8EFF":61,"#005588FF":62,"#005180FF":63,"#004E78FF":64,"#004A70FF":65,"#004768FF":66,"#FFEE00FF":67,"#FFE000FF":68,"#FFD200FF":69,"#FFC500FF":70,"#FFB700FF":71,"#FFAA00FF":72,"#FF9F00FF":73,"#FF9500FF":74,"#FF8B00FF":75,"#FF8100FF":76,"#FF4400FF":77,"#F23600FF":78,"#E62800FF":79,"#D91B00FF":80,"#CD0D00FF":81,"#C10000FF":82,"#A80000FF":83,"#8F0000FF":84,"#760000FF":85,"#5D0000FF":86,"#FFAAFFFF":87,"#FF9FFFFF":88,"#FF95FFFF":89,"#FF8BFFFF":90,"#FF81FFFF":91,"#FF77FFFF":92,"#FF6CFFFF":93,"#FF62FFFF":94,"#FF58FFFF":95,"#FF4EFFFF":96,"#FFFFFFFF":97,"#00FF00FF":107,"#CFFFFF00":150,"#CEFFFF0C":151,"#CDFFFF19":152,"#CCFFFF26":153,"#CBFFFF33":154,"#CBFFFF3F":155,"#CAFFFF4C":156,"#C9FFFF59":157,"#C8FFFF66":158,"#C7FFFF72":159,"#C7FFFF7F":160,"#C6FFFF8C":161,"#C5FFFF99":162,"#C4FFFFA5":163,"#C3FFFFB2":164,"#C3FFFFBF":165,"#C2FFFFCC":166,"#C1FFFFD8":167,"#C0FFFFE5":168,"#BFFFFFF2":169,"#BFFFFFFF":170,"#B8F8FFFF":171,"#B2F2FFFF":172,"#ABEBFFFF":173,"#A5E5FFFF":174,"#9FDFFFFF":175,"#98D8FFFF":176,"#92D2FFFF":177,"#8BCBFFFF":178,"#85C5FFFF":179,"#7FBFFFFF":180,"#78B8FFFF":181,"#72B2FFFF":182,"#6BABFFFF":183,"#65A5FFFF":184,"#5F9FFFFF":185,"#5B9BFFFF":186,"#5898FFFF":187,"#5595FFFF":188,"#5292FFFF":189,"#4F8FFFFF":190,"#4B8BFFFF":191,"#4888FFFF":192,"#4585FFFF":193,"#4282FFFF":194,"#3F7FFFFF":195,"#3B7BFFFF":196,"#3878FFFF":197,"#3575FFFF":198,"#3272FFFF":199,"#2F6FFFFF":200,"#2B6BFFFF":201,"#2868FFFF":202,"#2565FFFF":203,"#2262FFFF":204,"#1F5FFFFF":205,"#1B5BFFFF":206,"#1858FFFF":207,"#1555FFFF":208,"#1252FFFF":209,"#0F4FFFFF":210,"#0C4BFFFF":211,"#0948FFFF":212,"#0645FFFF":213,"#0242FFFF":214,"#003FFFFF":215,"#003BFFFF":216,"#0038FFFF":217,"#0035FFFF":218,"#0032FFFF":219,"#002FFFFF":220,"#002BFFFF":221,"#0028FFFF":222,"#0025FFFF":223,"#0022FFFF":224,"#001FFFFF":225,"#001BFFFF":226,"#0018FFFF":227,"#0015FFFF":228,"#0012FFFF":229,"#000FFFFF":230,"#000CFFFF":231,"#0009FFFF":232,"#0006FFFF":233,"#0002FFFF":234,"#0000FFFF":235},timestamp:"${radar.past[-1].time}"}};const B=new s(1,-1,1);B.translate(.5,.5,.5);const z=new Float32Array([-.002,.002,.01,.002,.002,.01,-.002,.002,-.01,.002,.002,-.01,-.002,-.002,.01,-.002,.002,.01,-.002,-.002,-.01,-.002,.002,-.01,-.002,.002,.01,.002,.002,.01,-.002,-.002,.01,.002,-.002,.01]),A=new Uint16Array([0,1,2,2,1,3,4,5,6,6,5,7,8,9,10,10,9,11]),E=new Float32Array([-.004,.004,.001,.004,.004,.001,-.004,.004,-.001,.004,.004,-.001,-.004,-.004,.001,-.004,.004,.001,-.004,-.004,-.001,-.004,.004,-.001,-.004,.004,.001,.004,.004,.001,-.004,-.004,.001,.004,-.004,.001]),k=new Uint16Array([0,1,2,2,1,3,4,5,6,6,5,7,8,9,10,10,9,11]),S="\n    precision highp float;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n    uniform float time;\n    uniform float scale;\n    attribute vec3 position;\n    attribute vec3 offset;\n\n    void main(void) {\n        vec3 translate = vec3(position.x * scale + offset.x, position.y * scale + offset.y, position.z + mod(offset.z - time + 1.0, 1.0));\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(translate, 1.0);\n    }\n",L="\n    precision highp float;\n    uniform vec4 color;\n\n    void main(void) {\n        gl_FragColor = color;\n    }\n";function D(e,t,i){return Math.min(Math.max(e,t),i)}function T(e,t){return void 0===e?t:e}function R(e,t){let i=t.split(/\.|(?=\[)/)[0];const o=t.slice(i.length).replace(/^\./,"");return Array.isArray(e)&&i.match(/^\[-?\d+\]$/)&&(i=+i.slice(1,-1),i<0&&(i+=e.length)),i in e&&o?R(e[i],o):e[i]}function $(e,t){const i=e.match(/\$\{[^}]+\}/g);if(i)for(const o of i)e=e.replace(o,R(t,o.slice(2,-1)));return e}function I(e,t,i,o,r){const{x:a,y:n,z:s}=e,F=D(s,t,i),l=Math.pow(2,F-s),c=(a+o)*l,h=(n+r)*l,u=Math.floor(c),m=Math.floor(h);return{key:`${F}/${u}/${m}`,u:c-u,v:h-m}}function j(e,t,i,o,r,a){const{dbz:n,resolutionX:s,resolutionY:l}=i,c=o[0][0],h=[];for(let t=0;t<l;t++)for(let i=0;i<s;i++){const o=n[t*s+i];if(!a==!(128&o)&&(127&o)>=c)for(let r=0;r<Math.pow(2,((127&o)-c)/10)*Math.max(1,e-14);r++)h.push({x:i,y:t})}if(0===h.length)return;const u=new d,m=new F(a?E:z,3);u.setAttribute("position",m),u.setIndex(new F(a?k:A,1));const p=new Float32Array(3*h.length),g=new f(p,3);for(let e=0;e<h.length;e++){const{x:t,y:i}=h[e];g.setXYZ(e,(t+Math.random())/s,(i+Math.random())/l,Math.random())}u.setAttribute("offset",g);const _=new y(u,r);return _.position.x=t.x,_.position.y=t.y,_.scale.x=t.dx,_.scale.y=t.dy,_.scale.z=2e-4*Math.pow(2,e<10?10-e:e<14?0:14-e),_.updateMatrix(),_.matrixAutoUpdate=!1,_.frustumCulled=!1,_}function Z(e){e.geometry instanceof d&&e.geometry.dispose(),e instanceof p&&e.dispose()}function O(e,t){this.constructor.prototype.loadTile.call(this,e,(i=>{const{x:o,y:r,z:a}=e.tileID.canonical,n=`${a}/${o}/${r}`,s=e.texture,F=this._parentLayer,l=this._imageTiles;if(s&&F&&!l[n]){const t=this.map.painter.context.gl,i=t.createFramebuffer(),[o,r]=s.size,a=new Uint8Array(o*r*4),c=F._colors,h=e._dbz=new Uint8Array(o*r);t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s.texture,0),t.readPixels(0,0,o,r,t.RGBA,t.UNSIGNED_BYTE,a),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(i);for(let e=0;e<h.length;e++){h[e]=c.get(256*(256*(256*a[4*e]+a[4*e+1])+a[4*e+2])+a[4*e+3])}l[n]=e;for(const e of this._imageTileCallbacks[n]||[])e()}t(i)}))}function G(e,t){this.constructor.prototype.unloadTile.call(this,e,(i=>{const{x:o,y:r,z:a}=e.tileID.canonical,n=`${a}/${o}/${r}`;delete this._imageTiles[n],delete this._imageTileCallbacks[n],t&&t(i)}))}function P(e,t){const i=this._parentLayer,o=i.source,r=this.map.getSource(o),n=r._imageTiles,s=r._imageTileCallbacks,{minzoom:F,maxzoom:l}=x[o],c=e.tileID.canonical,h=function(e,t,i){const{x:o,y:r,z:a}=e,n=D(a,t,i),s=Math.pow(2,n-a),F=[];for(let e=Math.floor(r*s);e<(r+1)*s;e++)for(let t=Math.floor(o*s);t<(o+1)*s;t++)F.push(`${n}/${t}/${e}`);return F}(c,F,l);!function(e,t,i){const o=[];for(const r of e)t(r,(t=>{o.push(t),o.length===e.length&&i(o)}))}(h,((e,t)=>{const i=s[e];n[e]?t():i?i.push(t):s[e]=[t]}),(()=>{if("unloaded"===e.state)return void t(null);const o=c.z,r=1/Math.pow(2,(o-1)/3),s=Math.ceil(64*r),h=Math.ceil(64*r),u={dbz:new Uint8Array(s*h),resolutionX:s,resolutionY:h};for(let e=0;e<h;e++)for(let t=0;t<s;t++){const{key:i,u:o,v:r}=I(c,F,l,(t+.5)/s,(e+.5)/h),a=n[i],[m,d]=a.texture.size;u.dbz[e*s+t]=a._dbz[Math.floor(r*d)*m+Math.floor(o*m)]}const m=function(e){const{x:t,y:i,z:o}=e,r=Math.pow(2,o),n=t/r*360-180,s=180*Math.atan(Math.sinh(Math.PI*(1-2*i/r)))/Math.PI,F=(t+1)/r*360-180,l=180*Math.atan(Math.sinh(Math.PI*(1-2*(i+1)/r)))/Math.PI,c=a.fromLngLat([n,s]),h=a.fromLngLat([F,l]);return{x:c.x,y:c.y,dx:h.x-c.x,dy:h.y-c.y}}(c),d=i._scaleColors,f=i._zoomGroups[o-1],y=function(e,t,i,o,r){const{dbz:a,resolutionX:n,resolutionY:s}=i,F=o[0][0],l=[];for(let e=0;e<s;e++)for(let t=0;t<n;t++){const i=127&a[e*n+t];if(i>=F)for(let r=1;r<o.length;r++)if(i<o[r][0]){l.push({x:t,y:e,p:r});break}}if(0===l.length)return;const c=new p(B,r,l.length);for(let e=0;e<l.length;e++){const{x:t,y:i,p:r}=l[e],a=(new g).makeScale(1/n,1/s,1).setPosition(t/n,i/s,0);c.setMatrixAt(e,a),c.setColorAt(e,o[r][1])}return c.position.x=t.x,c.position.y=t.y,c.scale.x=t.dx,c.scale.y=t.dy,c.scale.z=2e-4*Math.pow(2,e<10?10-e:e<14?0:14-e),c.updateMatrix(),c.matrixAutoUpdate=!1,c.renderOrder=1,c}(o,m,u,d,i._meshMaterial);y&&(e._boxMesh=y,f.add(y));const _=j(o,m,u,d,i._rainMaterial);_&&(e._rainMesh=_,f.add(_));const v=j(o,m,u,d,i._snowMaterial,!0);v&&(e._snowMesh=v,f.add(v)),e.state="loaded",t(null)}))}function U(e,t){this.constructor.prototype.unloadTile.call(this,e,(i=>{const o=e._boxMesh,r=e._rainMesh,a=e._snowMesh;o&&(o.parent.remove(o),Z(o),delete e._boxMesh),r&&(r.parent.remove(r),Z(r),delete e._rainMesh),a&&(a.parent.remove(a),Z(a),delete e._snowMesh),t&&t(i)}))}class q extends r{constructor(e){super(),this.id=e.id,this.type="custom",this.renderingMode="3d",this.slot=e.slot,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,this.source=e.source||"rainviewer",this.scale=e.scale||"noaa",this.rainColor=e.rainColor||"#ccf",this.snowColor=e.snowColor||"#fff",this.meshOpacity=T(e.meshOpacity,.1),this.repaint=T(e.repaint,!0),this._interval=x[this.source].interval;const t=x[this.source].colors,i=this._colors=new Map;for(const e of Object.keys(t))i.set(parseInt(e.replace("#","0x"),16),t[e]);this._onZoom=this._onZoom.bind(this)}onAdd(e,t){this._scene=new w,this._camera=new l,this._directionalLight=new h(16777215),this._directionalLight.position.set(0,-70,100).normalize(),this._scene.add(this._directionalLight),this._ambientLight=new n(16777215,.4),this._scene.add(this._ambientLight),this._meshMaterial=new _({opacity:this.meshOpacity,transparent:this.meshOpacity<1,visible:this.meshOpacity>0});let i=o.parseCSSColor(this.rainColor);this._rainMaterial=new v({uniforms:{time:{type:"f",value:0},scale:{type:"f",value:1},color:{type:"v4",value:new b(i[0],i[1],i[2],i[3])}},vertexShader:S,fragmentShader:L,transparent:i[3]<1,side:u}),i=o.parseCSSColor(this.snowColor),this._snowMaterial=new v({uniforms:{time:{type:"f",value:0},scale:{type:"f",value:1},color:{type:"v4",value:new b(i[0],i[1],i[2],i[3])}},vertexShader:S,fragmentShader:L,transparent:i[3]<1,side:u}),this._baseZoom=Math.round(e.getZoom()),this._zoomGroups=[];for(let e=0;e<=24;e++)this._zoomGroups[e]=new m,this._zoomGroups[e].visible=e===this._baseZoom,this._scene.add(this._zoomGroups[e]);const{scale:r,align:a}=M[this.scale];this._scaleColors=r.map((({value:e,color:t},i,o)=>{if("center"===a){e=(e+(i<o.length-1?o[i+1].value:1/0))/2}return[e+32,new c(t)]})),this._map=e,this._map.setLayerZoomRange(this.id,this.minzoom,this.maxzoom),this._map.on("zoom",this._onZoom),this._renderer=new C({canvas:e.getCanvas(),context:t,antialias:!0}),this._renderer.autoClear=!1,this._refreshSource(),this._timer=setInterval(this._refreshSource.bind(this),this._interval)}onRemove(){this._scene.remove(this._directionalLight),this._directionalLight.dispose(),delete this._directionalLight,this._scene.remove(this._ambientLight),this._ambientLight.dispose(),delete this._ambientLight,this._meshMaterial.dispose(),delete this._meshMaterial,this._rainMaterial.dispose(),delete this._rainMaterial,delete this._baseZoom;for(let e=0;e<=24;e++)this._scene.remove(this._zoomGroups[e]);delete this._zoomGroups,delete this._scaleColors,delete this._camera,delete this._scene,this._renderer.dispose(),delete this._renderer,this._map.off("zoom",this._onZoom),this._removeSource(),delete this._map,clearInterval(this._timer),delete this._timer}render(e,t){const i=this._map.getZoom();this._rainMaterial.uniforms.time.value=6e-4*performance.now(),this._rainMaterial.uniforms.scale.value=Math.pow(2,this._baseZoom-i-(i>=10.5?1:0)),this._snowMaterial.uniforms.time.value=15e-5*performance.now(),this._snowMaterial.uniforms.scale.value=Math.pow(2,this._baseZoom-i-(i>=10.5?1:0)),this._camera.projectionMatrix=(new g).fromArray(t),this._renderer.resetState(),this._renderer.render(this._scene,this._camera),this.repaint&&this._map.triggerRepaint()}_onZoom(){this._baseZoom=Math.round(this._map.getZoom());for(let e=0;e<=24;e++)this._zoomGroups[e].visible=e===this._baseZoom}_refreshSource(){const e=this.source,{tiles:t,tileSize:i,minzoom:o,maxzoom:r,attribution:a,catalog:n,timestamp:s}=x[e];fetch(n).then((e=>e.json())).then((n=>{const F=this._map;this._removeSource(),F.addSource(e,{type:"raster",tiles:t.map((e=>$(e,n))),tileSize:i,minzoom:o,maxzoom:r,attribution:a});const l=F.getSource(e);l._parentLayer=this,l._imageTiles={},l._imageTileCallbacks={},l.loadTile=O,l.unloadTile=G,F.addLayer({id:e,type:"raster",source:e,paint:{"raster-opacity":0}},this.id),F.addSource("rain-particles",{type:"raster",tiles:[],tileSize:i,minzoom:1,maxzoom:24});const c=F.getSource("rain-particles");c._parentLayer=this,c.loadTile=P,c.unloadTile=U,F.addLayer({id:"rain-particles",type:"raster",source:"rain-particles",paint:{"raster-opacity":0}},this.id),this.fire({type:"refresh",timestamp:+$(s,n)})}))}_removeSource(){const e=this.source,t=this._map,i=t.getSource(e),o=t.getSource("rain-particles");i&&(t.removeLayer(e),t.removeSource(e),delete i._parentLayer),o&&(t.removeLayer("rain-particles"),t.removeSource("rain-particles"),delete o._parentLayer)}setRainColor(e){if(this.rainColor=e||"#ccf",this._rainMaterial){const[e,t,i,r]=o.parseCSSColor(this.rainColor);this._rainMaterial.uniforms.color.value=new b(e,t,i,r),this._rainMaterial.transparent=r<1}return this}setSnowColor(e){if(this.snowColor=e||"#fff",this._snowMaterial){const[e,t,i,r]=o.parseCSSColor(this.snowColor);this._snowMaterial.uniforms.color.value=new b(e,t,i,r),this._snowMaterial.transparent=r<1}return this}setMeshOpacity(e){return this.meshOpacity=T(e,.1),this._meshMaterial&&(this._meshMaterial.opacity=e,this._meshMaterial.transparent=e<1,this._meshMaterial.visible=e>0),this}getLegendHTML(){return['<div style="font-size: 10px; line-height: 14px;"><div>dBZ</div>',...M[this.scale].scale.slice(1).reverse().map((e=>`\n                <div>\n                    <div style="display: inline-block; vertical-align: top; width: 14px; height: 14px; background-color: ${e.color}; border: solid 0.5px #aaa;"></div>\n                    <div style="display: inline-block; vertical-align: top;">${e.value}</div>\n                </div>\n            `)),"</div>"].join("")}}function V(e,t){const i=t.replace("#","%23");return e.replace("%3e",` fill='${i}' stroke='${i}'%3e`)}class Y{constructor(){const e=this;e.id="precipitation",e.name={de:"Niederschlag",en:"Precipitation",es:"Precipitación",fr:"Précipitation",ja:"降水",ko:"강수",ne:"वर्षा",pt:"Precipitação",th:"ฝน","zh-Hans":"降水","zh-Hant":"降水"},e.iconStyle={backgroundSize:"32px",backgroundImage:`url("${V("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3e%3c!--! Font Awesome Free 6.7.2 by %40fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0%2c Fonts: SIL OFL 1.1%2c Code: MIT License) Copyright 2024 Fonticons%2c Inc. --%3e%3cpath d='M96 320c-53 0-96-43-96-96c0-42.5 27.6-78.6 65.9-91.2C64.7 126.1 64 119.1 64 112C64 50.1 114.1 0 176 0c43.1 0 80.5 24.3 99.2 60c14.7-17.1 36.5-28 60.8-28c44.2 0 80 35.8 80 80c0 5.5-.6 10.8-1.6 16c.5 0 1.1 0 1.6 0c53 0 96 43 96 96s-43 96-96 96L96 320zM81.5 353.9c12.2 5.2 17.8 19.3 12.6 31.5l-48 112c-5.2 12.2-19.3 17.8-31.5 12.6S-3.3 490.7 1.9 478.5l48-112c5.2-12.2 19.3-17.8 31.5-12.6zm120 0c12.2 5.2 17.8 19.3 12.6 31.5l-48 112c-5.2 12.2-19.3 17.8-31.5 12.6s-17.8-19.3-12.6-31.5l48-112c5.2-12.2 19.3-17.8 31.5-12.6zm244.6 31.5l-48 112c-5.2 12.2-19.3 17.8-31.5 12.6s-17.8-19.3-12.6-31.5l48-112c5.2-12.2 19.3-17.8 31.5-12.6s17.8 19.3 12.6 31.5zM313.5 353.9c12.2 5.2 17.8 19.3 12.6 31.5l-48 112c-5.2 12.2-19.3 17.8-31.5 12.6s-17.8-19.3-12.6-31.5l48-112c5.2-12.2 19.3-17.8 31.5-12.6z'/%3e%3c/svg%3e","white")}")`},e.clockModes=["realtime"],e.viewModes=["ground"],e.layer=new q({id:e.id,rainColor:"#00f",meshOpacity:0,repaint:!1}),e._onRefresh=e._onRefresh.bind(e)}onAdd(e){this.map=e,e.addLayer(this.layer)}onRemove(e){e.removeLayer(this.id)}onEnabled(){const e=this;e.layer.on("refresh",e._onRefresh),document.addEventListener("visibilitychange",e._onRefresh),e._onRefresh()}onDisabled(){const e=this;e.layer.off("refresh",e._onRefresh),document.removeEventListener("visibilitychange",e._onRefresh)}onVisibilityChanged(e){this.map.setLayerVisibility(this.id,e?"visible":"none")}_onRefresh(){const{layer:e,map:t}=this;e.setRainColor(t.hasDarkBackground()?"#ccf":"#00f"),e.setSnowColor(t.hasDarkBackground()?"#fff":"#ccf")}}return function(){return new Y}}));
//# sourceMappingURL=mt3d-plugin-precipitation.min.js.map
