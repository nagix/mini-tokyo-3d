/*!
 * Mini Tokyo 3D v4.0.0-beta.2
 * https://minitokyo3d.com
 * (c) 2019-2026 Akihiko Kusanagi
 * Released under the MIT license
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).mt3d=t()}(this,(function(){"use strict";function _mergeNamespaces(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if("default"!==i&&!(i in e)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}}))})),Object.freeze(e)}var u8=Uint8Array,u16=Uint16Array,i32=Int32Array,fleb=new u8([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fdeb=new u8([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),clim=new u8([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),freb=function(e,t){for(var i=new u16(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];var r=new i32(i[30]);for(n=1;n<30;++n)for(var o=i[n];o<i[n+1];++o)r[o]=o-i[n]<<5|n;return{b:i,r:r}},_a=freb(fleb,2),fl=_a.b,revfl=_a.r;fl[28]=258,revfl[258]=28;for(var _b=freb(fdeb,0),fd=_b.b,rev=new u16(32768),i$1=0;i$1<32768;++i$1){var x=(43690&i$1)>>1|(21845&i$1)<<1;x=(52428&x)>>2|(13107&x)<<2,x=(61680&x)>>4|(3855&x)<<4,rev[i$1]=((65280&x)>>8|(255&x)<<8)>>1}for(var hMap=function(e,t,i){for(var n=e.length,r=0,o=new u16(t);r<n;++r)e[r]&&++o[e[r]-1];var s,a=new u16(t);for(r=1;r<t;++r)a[r]=a[r-1]+o[r-1]<<1;if(i){s=new u16(1<<t);var l=15-t;for(r=0;r<n;++r)if(e[r])for(var c=r<<4|e[r],u=t-e[r],h=a[e[r]-1]++<<u,d=h|(1<<u)-1;h<=d;++h)s[rev[h]>>l]=c}else for(s=new u16(n),r=0;r<n;++r)e[r]&&(s[r]=rev[a[e[r]-1]++]>>15-e[r]);return s},flt=new u8(288),i$1=0;i$1<144;++i$1)flt[i$1]=8;for(var i$1=144;i$1<256;++i$1)flt[i$1]=9;for(var i$1=256;i$1<280;++i$1)flt[i$1]=7;for(var i$1=280;i$1<288;++i$1)flt[i$1]=8;for(var fdt=new u8(32),i$1=0;i$1<32;++i$1)fdt[i$1]=5;var flrm=hMap(flt,9,1),fdrm=hMap(fdt,5,1),max=function(e){for(var t=e[0],i=1;i<e.length;++i)e[i]>t&&(t=e[i]);return t},bits=function(e,t,i){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(7&t)&i},bits16=function(e,t){var i=t/8|0;return(e[i]|e[i+1]<<8|e[i+2]<<16)>>(7&t)},shft=function(e){return(e+7)/8|0},slc=function(e,t,i){return(null==t||t<0)&&(t=0),(null==i||i>e.length)&&(i=e.length),new u8(e.subarray(t,i))},ec=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],err=function(e,t,i){var n=new Error(t||ec[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,err),!i)throw n;return n},inflt=function(e,t,i,n){var r=e.length;if(!r||t.f&&!t.l)return i||new u8(0);var o=!i,s=o||2!=t.i,a=t.i;o&&(i=new u8(3*r));var l=function(e){var t=i.length;if(e>t){var n=new u8(Math.max(2*t,e));n.set(i),i=n}},c=t.f||0,u=t.p||0,h=t.b||0,d=t.l,p=t.d,f=t.m,m=t.n,g=8*r;do{if(!d){c=bits(e,u,1);var _=bits(e,u+1,3);if(u+=3,!_){var y=e[(C=shft(u)+4)-4]|e[C-3]<<8,v=C+y;if(v>r){a&&err(0);break}s&&l(h+y),i.set(e.subarray(C,v),h),t.b=h+=y,t.p=u=8*v,t.f=c;continue}if(1==_)d=flrm,p=fdrm,f=9,m=5;else if(2==_){var x=bits(e,u,31)+257,b=bits(e,u+10,15)+4,T=x+bits(e,u+5,31)+1;u+=14;for(var w=new u8(T),E=new u8(19),S=0;S<b;++S)E[clim[S]]=bits(e,u+3*S,7);u+=3*b;var A=max(E),M=(1<<A)-1,I=hMap(E,A,1);for(S=0;S<T;){var C,P=I[bits(e,u,M)];if(u+=15&P,(C=P>>4)<16)w[S++]=C;else{var L=0,R=0;for(16==C?(R=3+bits(e,u,3),u+=2,L=w[S-1]):17==C?(R=3+bits(e,u,7),u+=3):18==C&&(R=11+bits(e,u,127),u+=7);R--;)w[S++]=L}}var O=w.subarray(0,x),D=w.subarray(x);f=max(O),m=max(D),d=hMap(O,f,1),p=hMap(D,m,1)}else err(1);if(u>g){a&&err(0);break}}s&&l(h+131072);for(var B=(1<<f)-1,F=(1<<m)-1,N=u;;N=u){var k=(L=d[bits16(e,u)&B])>>4;if((u+=15&L)>g){a&&err(0);break}if(L||err(2),k<256)i[h++]=k;else{if(256==k){N=u,d=null;break}var U=k-254;k>264&&(U=bits(e,u,(1<<(G=fleb[S=k-257]))-1)+fl[S],u+=G);var z=p[bits16(e,u)&F],V=z>>4;z||err(3),u+=15&z;D=fd[V];if(V>3){var G=fdeb[V];D+=bits16(e,u)&(1<<G)-1,u+=G}if(u>g){a&&err(0);break}s&&l(h+131072);var j=h+U;if(h<D){var H=0-D,$=Math.min(D,j);for(H+h<0&&err(3);h<$;++h)i[h]=n[H+h]}for(;h<j;++h)i[h]=i[h-D]}}t.l=d,t.p=N,t.b=h,t.f=c,d&&(c=1,t.m=f,t.d=p,t.n=m)}while(!c);return h!=i.length&&o?slc(i,0,h):i.subarray(0,h)},et=new u8(0),gzs=function(e){31==e[0]&&139==e[1]&&8==e[2]||err(6,"invalid gzip data");var t=e[3],i=10;4&t&&(i+=2+(e[10]|e[11]<<8));for(var n=(t>>3&1)+(t>>4&1);n>0;n-=!e[i++]);return i+(2&t)},Inflate=function(){function e(e,t){"function"==typeof e&&(t=e,e={}),this.ondata=t;var i=e&&e.dictionary&&e.dictionary.subarray(-32768);this.s={i:0,b:i?i.length:0},this.o=new u8(32768),this.p=new u8(0),i&&this.o.set(i)}return e.prototype.e=function(e){if(this.ondata||err(5),this.d&&err(4),this.p.length){if(e.length){var t=new u8(this.p.length+e.length);t.set(this.p),t.set(e,this.p.length),this.p=t}}else this.p=e},e.prototype.c=function(e){this.s.i=+(this.d=e||!1);var t=this.s.b,i=inflt(this.p,this.s,this.o);this.ondata(slc(i,t,this.s.b),this.d),this.o=slc(i,this.s.b-32768),this.s.b=this.o.length,this.p=slc(this.p,this.s.p/8|0),this.s.p&=7},e.prototype.push=function(e,t){this.e(e),this.c(t)},e}(),Gunzip=function(){function e(e,t){this.v=1,this.r=0,Inflate.call(this,e,t)}return e.prototype.push=function(e,t){if(Inflate.prototype.e.call(this,e),this.r+=e.length,this.v){var i=this.p.subarray(this.v-1),n=i.length>3?gzs(i):4;if(n>i.length){if(!t)return}else this.v>1&&this.onmember&&this.onmember(this.r-i.length);this.p=i.subarray(n),this.v=0}Inflate.prototype.c.call(this,t),!this.s.f||this.s.l||t||(this.v=shft(this.s.p)+9,this.s={i:0},this.o=new u8(0),this.push(new u8(0),t))},e}(),td="undefined"!=typeof TextDecoder&&new TextDecoder,tds=0;try{td.decode(et,{stream:!0}),tds=1}catch(e){}var dutf8=function(e){for(var t="",i=0;;){var n=e[i++],r=(n>127)+(n>223)+(n>239);if(i+r>e.length)return{s:t,r:slc(e,i-1)};r?3==r?(n=((15&n)<<18|(63&e[i++])<<12|(63&e[i++])<<6|63&e[i++])-65536,t+=String.fromCharCode(55296|n>>10,56320|1023&n)):t+=String.fromCharCode(1&r?(31&n)<<6|63&e[i++]:(15&n)<<12|(63&e[i++])<<6|63&e[i++]):t+=String.fromCharCode(n)}},DecodeUTF8=function(){function e(e){this.ondata=e,tds?this.t=new TextDecoder:this.p=et}return e.prototype.push=function(e,t){if(this.ondata||err(5),t=!!t,this.t)return this.ondata(this.t.decode(e,{stream:!0}),t),void(t&&(this.t.decode().length&&err(8),this.t=null));this.p||err(4);var i=new u8(this.p.length+e.length);i.set(this.p),i.set(e,this.p.length);var n=dutf8(i),r=n.s,o=n.r;t?(o.length&&err(8),this.p=null):this.p=o,this.ondata(r,t)},e}();const configs={standingDuration:6e4,minStandingDuration:3e4,minBusStandingDuration:15e3,refreshInterval:6e4,refreshTimeout:1e4,realtimeCheckInterval:15e3,maxSpeedKMPH:80,accelerationKMPHPS:3,get maxSpeed(){return configs.maxSpeedKMPH/36e5},get acceleration(){return configs.accelerationKMPHPS/36e8},get maxAccelerationTime(){return configs.maxSpeed/configs.acceleration},get maxAccDistance(){return configs.maxAccelerationTime*configs.maxSpeed/2},maxFlightSpeedKMPH:500,flightAccelerationKMPHPS:12,get maxFlightSpeed(){return configs.maxFlightSpeedKMPH/36e5},get flightAcceleration(){return configs.flightAccelerationKMPHPS/36e8},maxBusSpeedKMPH:30,busAccelerationKMPHPS:3,get maxBusSpeed(){return configs.maxBusSpeedKMPH/36e5},get busAcceleration(){return configs.busAccelerationKMPHPS/36e8},get maxBusAccelerationTime(){return configs.maxBusSpeed/configs.busAcceleration},get maxBusAccDistance(){return configs.maxBusAccelerationTime*configs.maxBusSpeed/2},minDelay:25e3,minFlightInterval:9e4,transitionDuration:300,fadeDuration:1e3,defaultCenter:[139.767,35.6814],defaultZoom:14,defaultBearing:0,defaultPitch:60,defaultEcoFrameRate:1,defaultViewMode:"ground",defaultTrackingMode:"position",defaultClockMode:"realtime",defaultEcoMode:"normal",apiUrl:{odpt:"https://api.odpt.org/api/v4/",challenge2025:"https://api-challenge.odpt.org/api/v4/"},tidUrl:"https://mini-tokyo.appspot.com/tid",trainInfoUrl:"https://mini-tokyo.appspot.com/traininfo",atisUrl:"https://mini-tokyo.appspot.com/atisinfo",flightUrl:"https://mini-tokyo.appspot.com/flight",dataUrl:"https://minitokyo3d.com/data",dataSources:[],searchUrl:"https://search.minitokyo3d.com/api/v1/routes",lastStaticUpdate:"2025-12-20 03:00:00",customAttribution:'<a href="https://github.com/nagix/mini-tokyo-3d">© Akihiko Kusanagi</a>',copyright:"© 2019-2026 Akihiko Kusanagi",shareUrl:"https://minitokyo3d.com",events:["boxzoomcancel","boxzoomend","boxzoomstart","click","contextmenu","dblclick","drag","dragend","dragstart","error","load","mousedown","mousemove","mouseout","mouseover","mouseup","move","moveend","movestart","pitch","pitchend","pitchstart","resize","rotate","rotateend","rotatestart","touchcancel","touchend","touchmove","touchstart","wheel","zoom","zoomend","zoomstart"],langs:["de","en","es","fr","ja","ko","ne","pt-BR","th","zh-Hans","zh-Hant"]};let touchDevice=!1;function isTouchDevice(){return touchDevice}function loadJSON(e){return fetch(e).then((t=>{if(e.endsWith(".gz")){let e="";const i=t.body.getReader(),n=new DecodeUTF8((t=>{e+=t})),r=new Gunzip(((e,t)=>{n.push(e,t)}));return i.read().then((function t({done:n,value:o}){return n?(r.push(new Uint8Array(0),!0),JSON.parse(e)):(r.push(o),i.read().then(t))}))}return t.json()}))}function lerp$5(e,t,i){return e*(1-i)+t*i}function clamp$3(e,t,i){return Math.min(Math.max(e,t),i)}function includes(e,t){let i,n;if(!Array.isArray(e)&&"string"!=typeof e)return!1;if(!Array.isArray(t))return-1!==e.indexOf(t);for(i=0,n=t.length;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0}function flat$1(e){return e.reduce(((e,t)=>e.concat(t)),[])}function normalize$5(e){return e.normalize("NFD").replace(/\(.*\)|<.*>|〈.*〉|[\u0300-\u036F]/g,"")}function valueOrDefault(e,t){return void 0===e?t:e}function isString(e){return"string"==typeof e||e instanceof String}function getTimeString(e){return`${("0"+(Math.floor(e/36e5)+3)%24).slice(-2)}:${("0"+Math.floor(e/6e4)%60).slice(-2)}`}function getTimeOffset(e){return 6e4*((+e.substring(0,2)+21)%24*60+ +e.substring(3,5))}function bindAll(e,t){for(const i of e)t[i]&&(t[i]=t[i].bind(t))}function removePrefix(e){return"string"==typeof e?e.replace(/.*:/,""):Array.isArray(e)?e.map(removePrefix):e}function blink(){const e=performance.now()%1500/1500*2;return e<1?e:2-e}function measureFrameRate(){return new Promise((e=>{let t=0;const i=performance.now(),n=()=>{t++<60?requestAnimationFrame(n):e(1e3/((performance.now()-i)/60))};n()}))}function luminance(e){return.2126*e.r+.7152*e.g+.0722*e.b}function colorToRGBArray(e){const t=parseInt(e.replace("#",""),16);return[Math.floor(t/65536)%256,Math.floor(t/256)%256,t%256]}function createElement$1(e,t,i){const n=document.createElement(e);for(const e of Object.keys(t))try{n[e]=t[e]}catch(i){n.setAttribute(e,t[e])}return i&&i.appendChild(n),n}function showNotification(e,t){const i=createElement$1("div",{className:"notification",innerHTML:t},e);setTimeout((()=>{i.style.opacity=0}),1e3),setTimeout((()=>{e.removeChild(i)}),2e3)}function normalizeLang(e){return includes(configs.langs.map((e=>e.replace("pt-BR","pt"))),e=e.match(/^zh-(Hant|TW|HK|MO)/)?"zh-Hant":e.match(/^zh/)?"zh-Hans":e.substring(0,2))?e:void 0}function getLang(e){if(!includes(configs.langs,e)){const t=window.navigator;e=t.languages&&t.languages[0]||t.language||t.userLanguage||t.browserLanguage||""}return normalizeLang(e)||"en"}"undefined"!=typeof window&&window.addEventListener("touchstart",(()=>{touchDevice=!0}),{once:!0});var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function getAugmentedNamespace(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var i=function e(){var i=!1;try{i=this instanceof e}catch(e){}return i?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};i.prototype=t.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(i,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})})),i}var mapboxGl$1={exports:{}},mapboxGl=mapboxGl$1.exports,hasRequiredMapboxGl;function requireMapboxGl(){return hasRequiredMapboxGl||(hasRequiredMapboxGl=1,function(e){e.exports=function(){var e,t,i;function n(n,r){if(e)if(t){var o="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+e+")(sharedChunk); ("+t+")(sharedChunk); self.onerror = null;",s={};e(s),i=r(s),"undefined"!=typeof window&&window&&window.URL&&window.URL.createObjectURL&&(i.workerUrl=window.URL.createObjectURL(new Blob([o],{type:"text/javascript"})))}else t=r;else e=r}n(["exports"],(function(e){var t=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array;function n(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i*o-r*n;return s?(e[0]=o*(s=1/s),e[1]=-n*s,e[2]=-r*s,e[3]=i*s,e):null}function r(){var e=new i(9);return i!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function o(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8];return e[0]=s*u-a*c,e[1]=r*c-n*u,e[2]=n*a-r*s,e[3]=a*l-o*u,e[4]=i*u-r*l,e[5]=r*o-i*a,e[6]=o*c-s*l,e[7]=n*l-i*c,e[8]=i*s-n*o,e}function s(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=i[0],p=i[1],f=i[2],m=i[3],g=i[4],_=i[5],y=i[6],v=i[7],x=i[8];return e[0]=d*n+p*s+f*c,e[1]=d*r+p*a+f*u,e[2]=d*o+p*l+f*h,e[3]=m*n+g*s+_*c,e[4]=m*r+g*a+_*u,e[5]=m*o+g*l+_*h,e[6]=y*n+v*s+x*c,e[7]=y*r+v*a+x*u,e[8]=y*o+v*l+x*h,e}function a(){var e=new i(16);return i!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function l(e){var t=new i(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function c(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function u(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=t[9],d=t[10],p=t[11],f=t[12],m=t[13],g=t[14],_=t[15],y=i*a-n*s,v=i*l-r*s,x=i*c-o*s,b=n*l-r*a,T=n*c-o*a,w=r*c-o*l,E=u*m-h*f,S=u*g-d*f,A=u*_-p*f,M=h*g-d*m,I=h*_-p*m,C=d*_-p*g,P=y*C-v*I+x*M+b*A-T*S+w*E;return P?(e[0]=(a*C-l*I+c*M)*(P=1/P),e[1]=(r*I-n*C-o*M)*P,e[2]=(m*w-g*T+_*b)*P,e[3]=(d*T-h*w-p*b)*P,e[4]=(l*A-s*C-c*S)*P,e[5]=(i*C-r*A+o*S)*P,e[6]=(g*x-f*w-_*v)*P,e[7]=(u*w-d*x+p*v)*P,e[8]=(s*I-a*A+c*E)*P,e[9]=(n*A-i*I-o*E)*P,e[10]=(f*T-m*x+_*y)*P,e[11]=(h*x-u*T-p*y)*P,e[12]=(a*S-s*M-l*E)*P,e[13]=(i*M-n*S+r*E)*P,e[14]=(m*v-f*b-g*y)*P,e[15]=(u*b-h*v+d*y)*P,e):null}function h(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],p=t[10],f=t[11],m=t[12],g=t[13],_=t[14],y=t[15],v=i[0],x=i[1],b=i[2],T=i[3];return e[0]=v*n+x*a+b*h+T*m,e[1]=v*r+x*l+b*d+T*g,e[2]=v*o+x*c+b*p+T*_,e[3]=v*s+x*u+b*f+T*y,e[4]=(v=i[4])*n+(x=i[5])*a+(b=i[6])*h+(T=i[7])*m,e[5]=v*r+x*l+b*d+T*g,e[6]=v*o+x*c+b*p+T*_,e[7]=v*s+x*u+b*f+T*y,e[8]=(v=i[8])*n+(x=i[9])*a+(b=i[10])*h+(T=i[11])*m,e[9]=v*r+x*l+b*d+T*g,e[10]=v*o+x*c+b*p+T*_,e[11]=v*s+x*u+b*f+T*y,e[12]=(v=i[12])*n+(x=i[13])*a+(b=i[14])*h+(T=i[15])*m,e[13]=v*r+x*l+b*d+T*g,e[14]=v*o+x*c+b*p+T*_,e[15]=v*s+x*u+b*f+T*y,e}function d(e,t,i){var n,r,o,s,a,l,c,u,h,d,p,f,m=i[0],g=i[1],_=i[2];return t===e?(e[12]=t[0]*m+t[4]*g+t[8]*_+t[12],e[13]=t[1]*m+t[5]*g+t[9]*_+t[13],e[14]=t[2]*m+t[6]*g+t[10]*_+t[14],e[15]=t[3]*m+t[7]*g+t[11]*_+t[15]):(r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],p=t[10],f=t[11],e[0]=n=t[0],e[1]=r,e[2]=o,e[3]=s,e[4]=a,e[5]=l,e[6]=c,e[7]=u,e[8]=h,e[9]=d,e[10]=p,e[11]=f,e[12]=n*m+a*g+h*_+t[12],e[13]=r*m+l*g+d*_+t[13],e[14]=o*m+c*g+p*_+t[14],e[15]=s*m+u*g+f*_+t[15]),e}function p(e,t,i){var n=i[0],r=i[1],o=i[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function f(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[4],s=t[5],a=t[6],l=t[7],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*r+c*n,e[5]=s*r+u*n,e[6]=a*r+h*n,e[7]=l*r+d*n,e[8]=c*r-o*n,e[9]=u*r-s*n,e[10]=h*r-a*n,e[11]=d*r-l*n,e}function m(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[0],s=t[1],a=t[2],l=t[3],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r-c*n,e[1]=s*r-u*n,e[2]=a*r-h*n,e[3]=l*r-d*n,e[8]=o*n+c*r,e[9]=s*n+u*r,e[10]=a*n+h*r,e[11]=l*n+d*r,e}function g(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[0],s=t[1],a=t[2],l=t[3],c=t[4],u=t[5],h=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r+c*n,e[1]=s*r+u*n,e[2]=a*r+h*n,e[3]=l*r+d*n,e[4]=c*r-o*n,e[5]=u*r-s*n,e[6]=h*r-a*n,e[7]=d*r-l*n,e}function _(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function y(e,i,n){var r,o,s,a=n[0],l=n[1],c=n[2],u=Math.sqrt(a*a+l*l+c*c);return u<t?null:(a*=u=1/u,l*=u,c*=u,r=Math.sin(i),o=Math.cos(i),e[0]=a*a*(s=1-o)+o,e[1]=l*a*s+c*r,e[2]=c*a*s-l*r,e[3]=0,e[4]=a*l*s-c*r,e[5]=l*l*s+o,e[6]=c*l*s+a*r,e[7]=0,e[8]=a*c*s+l*r,e[9]=l*c*s-a*r,e[10]=c*c*s+o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function v(e,t){var i=t[0],n=t[1],r=t[2],o=t[4],s=t[5],a=t[6],l=t[8],c=t[9],u=t[10];return e[0]=Math.sqrt(i*i+n*n+r*r),e[1]=Math.sqrt(o*o+s*s+a*a),e[2]=Math.sqrt(l*l+c*c+u*u),e}function x(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i+i,a=n+n,l=r+r,c=i*s,u=n*s,h=n*a,d=r*s,p=r*a,f=r*l,m=o*s,g=o*a,_=o*l;return e[0]=1-h-f,e[1]=u+_,e[2]=d-g,e[3]=0,e[4]=u-_,e[5]=1-c-f,e[6]=p+m,e[7]=0,e[8]=d+g,e[9]=p-m,e[10]=1-c-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}var b=h;function T(){var e=new i(3);return i!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function w(e){var t=new i(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function E(e){var t=e[0],i=e[1],n=e[2];return Math.sqrt(t*t+i*i+n*n)}function S(e,t,n){var r=new i(3);return r[0]=e,r[1]=t,r[2]=n,r}function A(e,t,i,n){return e[0]=t,e[1]=i,e[2]=n,e}function M(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function I(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function C(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e}function P(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e}function L(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e}function R(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function O(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e}function D(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(i*i+n*n+r*r)}function B(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return i*i+n*n+r*r}function F(e){var t=e[0],i=e[1],n=e[2];return t*t+i*i+n*n}function N(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function k(e,t){var i=t[0],n=t[1],r=t[2],o=i*i+n*n+r*r;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function U(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function z(e,t,i){var n=t[0],r=t[1],o=t[2],s=i[0],a=i[1],l=i[2];return e[0]=r*l-o*a,e[1]=o*s-n*l,e[2]=n*a-r*s,e}function V(e,t,i,n){var r=t[0],o=t[1],s=t[2];return e[0]=r+n*(i[0]-r),e[1]=o+n*(i[1]-o),e[2]=s+n*(i[2]-s),e}function G(e,t,i){var n=t[0],r=t[1],o=t[2],s=i[3]*n+i[7]*r+i[11]*o+i[15];return e[0]=(i[0]*n+i[4]*r+i[8]*o+i[12])/(s=s||1),e[1]=(i[1]*n+i[5]*r+i[9]*o+i[13])/s,e[2]=(i[2]*n+i[6]*r+i[10]*o+i[14])/s,e}function j(e,t,i){var n=t[0],r=t[1],o=t[2];return e[0]=n*i[0]+r*i[3]+o*i[6],e[1]=n*i[1]+r*i[4]+o*i[7],e[2]=n*i[2]+r*i[5]+o*i[8],e}function H(e,t,i){var n=i[0],r=i[1],o=i[2],s=i[3],a=t[0],l=t[1],c=t[2],u=r*c-o*l,h=o*a-n*c,d=n*l-r*a;return e[0]=a+s*(u+=u)+r*(d+=d)-o*(h+=h),e[1]=l+s*h+o*u-n*d,e[2]=c+s*d+n*h-r*u,e}function $(e){return e[0]=0,e[1]=0,e[2]=0,e}function W(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var q=I,X=C,Y=E;function Z(){var e=new i(4);return i!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function J(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function K(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i*i+n*n+r*r+o*o;return s>0&&(s=1/Math.sqrt(s)),e[0]=i*s,e[1]=n*s,e[2]=r*s,e[3]=o*s,e}function Q(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3];return e[0]=i[0]*n+i[4]*r+i[8]*o+i[12]*s,e[1]=i[1]*n+i[5]*r+i[9]*o+i[13]*s,e[2]=i[2]*n+i[6]*r+i[10]*o+i[14]*s,e[3]=i[3]*n+i[7]*r+i[11]*o+i[15]*s,e}function ee(){var e=new i(4);return i!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function te(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function ie(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l+s*a,e[1]=r*l+o*a,e[2]=o*l-r*a,e[3]=s*l-n*a,e}function ne(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l-o*a,e[1]=r*l+s*a,e[2]=o*l+n*a,e[3]=s*l-r*a,e}T(),Z();var re,oe,se,ae=K,le=(re=T(),oe=S(1,0,0),se=S(0,1,0),function(e,t,i){var n=U(t,i);return n<-.999999?(z(re,oe,t),Y(re)<1e-6&&z(re,se,t),k(re,re),function(e,t,i){i*=.5;var n=Math.sin(i);e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(i)}(e,re,Math.PI),e):n>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(z(re,t,i),e[0]=re[0],e[1]=re[1],e[2]=re[2],e[3]=1+n,ae(e,e))});function ce(){var e=new i(2);return i!=Float32Array&&(e[0]=0,e[1]=0),e}function ue(e,t){var n=new i(2);return n[0]=e,n[1]=t,n}function he(e,t,i){return e[0]=t,e[1]=i,e}function de(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function pe(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function fe(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e}function me(e){var t=e[0],i=e[1];return Math.sqrt(t*t+i*i)}function ge(e,t){var i=t[0],n=t[1],r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e}function _e(e,t){return e[0]*t[0]+e[1]*t[1]}ee(),ee(),r();var ye,ve,xe=pe;function be(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}ce();var Te=function(){if(ve)return ye;function e(e,t,i,n){this.cx=3*e,this.bx=3*(i-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(n-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=i,this.p2y=n}return ve=1,ye=e,e.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(void 0===t&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var i=e,n=0;n<8;n++){var r=this.sampleCurveX(i)-e;if(Math.abs(r)<t)return i;var o=this.sampleCurveDerivativeX(i);if(Math.abs(o)<1e-6)break;i-=r/o}var s=0,a=1;for(i=e,n=0;n<20&&(r=this.sampleCurveX(i),!(Math.abs(r-e)<t));n++)e>r?s=i:a=i,i=.5*(a-s)+s;return i},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}},ye}(),we=be(Te);function Ee(e,t){this.x=e,this.y=t}function Se(e,t){if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!Se(e[i],t[i]))return!1;return!0}if("object"==typeof e&&null!==e&&null!==t){if("object"!=typeof t)return!1;if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const i in e)if(!Se(e[i],t[i]))return!1;return!0}return e===t}Ee.prototype={clone(){return new Ee(this.x,this.y)},add(e){return this.clone()._add(e)},sub(e){return this.clone()._sub(e)},multByPoint(e){return this.clone()._multByPoint(e)},divByPoint(e){return this.clone()._divByPoint(e)},mult(e){return this.clone()._mult(e)},div(e){return this.clone()._div(e)},rotate(e){return this.clone()._rotate(e)},rotateAround(e,t){return this.clone()._rotateAround(e,t)},matMult(e){return this.clone()._matMult(e)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(e){return this.x===e.x&&this.y===e.y},dist(e){return Math.sqrt(this.distSqr(e))},distSqr(e){const t=e.x-this.x,i=e.y-this.y;return t*t+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith(e){return this.angleWithSep(e.x,e.y)},angleWithSep(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult(e){const t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this},_add(e){return this.x+=e.x,this.y+=e.y,this},_sub(e){return this.x-=e.x,this.y-=e.y,this},_mult(e){return this.x*=e,this.y*=e,this},_div(e){return this.x/=e,this.y/=e,this},_multByPoint(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint(e){return this.x/=e.x,this.y/=e.y,this},_unit(){return this._div(this.mag()),this},_perp(){const e=this.y;return this.y=this.x,this.x=-e,this},_rotate(e){const t=Math.cos(e),i=Math.sin(e),n=i*this.x+t*this.y;return this.x=t*this.x-i*this.y,this.y=n,this},_rotateAround(e,t){const i=Math.cos(e),n=Math.sin(e),r=t.y+n*(this.x-t.x)+i*(this.y-t.y);return this.x=t.x+i*(this.x-t.x)-n*(this.y-t.y),this.y=r,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Ee},Ee.convert=function(e){if(e instanceof Ee)return e;if(Array.isArray(e))return new Ee(+e[0],+e[1]);if(void 0!==e.x&&void 0!==e.y)return new Ee(+e.x,+e.y);throw new Error("Expected [x, y] or {x, y} point format")};const Ae=Math.PI/180,Me=180/Math.PI;function Ie(e){return e*Ae}function Ce(e){return e*Me}const Pe=[[0,0],[1,0],[1,1],[0,1]];function Le(e){if(e<=0)return 0;if(e>=1)return 1;const t=e*e,i=t*e;return 4*(e<.5?i:3*(e-t)+i-.75)}function Re(e,t,i,n){const r=new we(e,t,i,n);return function(e){return r.solve(e)}}const Oe=Re(.25,.1,.25,1);function De(e,t,i){return Math.min(i,Math.max(t,e))}function Be(e,t,i){return(i=De((i-e)/(t-e),0,1))*i*(3-2*i)}function Fe(e,t,i){const n=i-t,r=((e-t)%n+n)%n+t;return r===t?i:r}function Ne(e,t,i){if(!e.length)return i(null,[]);let n=e.length;const r=new Array(e.length);let o=null;e.forEach(((e,s)=>{t(e,((e,t)=>{e&&(o=e),r[s]=t,0==--n&&i(o,r)}))}))}let ke=1;function Ue(){return ke++}function ze(e){return e<=1?1:Math.pow(2,Math.ceil(Math.log2(e)))}function Ve(e,t){e.forEach((e=>{t[e]&&(t[e]=t[e].bind(t))}))}function Ge(e,t,i){const n={};for(const i in e)n[i]=t.call(this,e[i],i,e);return n}function je(e,t,i){const n={};for(const i in e)t.call(this,e[i],i,e)&&(n[i]=e[i]);return n}function He(e){return Array.isArray(e)?e.map(He):"object"==typeof e&&e?Ge(e,He):e}function $e(e,t){for(let i=0;i<e.length;i++)if(t.indexOf(e[i])>=0)return!0;return!1}const We={};function qe(e){We[e]||(We[e]=!0)}function Xe(e,t,i){return(i.y-e.y)*(t.x-e.x)>(t.y-e.y)*(i.x-e.x)}function Ye(e){let t=0;for(let i,n,r=0,o=e.length,s=o-1;r<o;s=r++)i=e[r],n=e[s],t+=(n.x-i.x)*(i.y+n.y);return t}function Ze([e,t,i]){const n=Ie(t+90),r=Ie(i);return{x:e*Math.cos(n)*Math.sin(r),y:e*Math.sin(n)*Math.sin(r),z:e*Math.cos(r),azimuthal:t,polar:i}}function Je(e){return("undefined"!=typeof self||void 0!==e)&&"undefined"!=typeof WorkerGlobalScope&&(void 0!==e?e:self)instanceof WorkerGlobalScope}function Ke(e){const t={};if(e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((e,i,n,r)=>{const o=n||r;return t[i]=!o||o.toLowerCase(),""})),t["max-age"]){const e=parseInt(t["max-age"],10);isNaN(e)?delete t["max-age"]:t["max-age"]=e}return t}let Qe=null;function et(e,t){return[e[4*t],e[4*t+1],e[4*t+2],e[4*t+3]]}function tt(e,t,i,n){for(;t<i;){const r=t+i>>1;e[r]<n?t=r+1:i=r}return t}function it(e,t,i,n){for(;t<i;){const r=t+i>>1;e[r]<=n?t=r+1:i=r}return t}function nt(e){return e>0?1/(1.001-e):1+e}function rt(e){return e>0?1-1/(1.001-e):-e}function ot(e,t,i){return(e-t.min)*(i.max-i.min)/(t.max-t.min)+i.min}const st={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!st.API_URL)return null;try{const e=new URL(st.API_URL);return"api.mapbox.cn"===e.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===e.hostname?"https://events.mapbox.com/events/v2":null}catch(e){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.3.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function at(e){return st.API_URL_REGEX.test(e)}function lt(e){return st.API_SPRITE_REGEX.test(e)}let ct,ut,ht,dt,pt,ft;function mt(){return null==ct&&(ct=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),ct}const gt={now:()=>void 0!==dt?dt:performance.now(),setNow(e){dt=e},restoreNow(){dt=void 0},frame(e){const t=requestAnimationFrame(e);return{cancel:()=>cancelAnimationFrame(t)}},getImageData(e,t=0){const{width:i,height:n}=e;pt||(pt=document.createElement("canvas"));const r=pt.getContext("2d",{willReadFrequently:!0});if(!r)throw new Error("failed to create canvas 2d context");return(i>pt.width||n>pt.height)&&(pt.width=i,pt.height=n),r.clearRect(-t,-t,i+2*t,n+2*t),r.drawImage(e,0,0,i,n),r.getImageData(-t,-t,i+2*t,n+2*t)},resolveURL:e=>(ut||(ut=document.createElement("a")),ut.href=e,ut.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==ht&&(ht=window.matchMedia("(prefers-reduced-motion: reduce)")),ht.matches)},hasCanvasFingerprintNoise(){if(void 0!==ft)return ft;if(!mt())return ft=!1,!1;const e=new OffscreenCanvas(85,1),t=e.getContext("2d",{willReadFrequently:!0});let i=0;for(let n=0;n<e.width;++n)t.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,t.fillRect(n,0,1,1);const n=t.getImageData(0,0,e.width,e.height);i=0;for(let e=0;e<n.data.length;++e)if(e%4!=3&&i++!==n.data[e])return ft=!0,!0;return ft=!1,!1}};function _t(e,t){const i=e.indexOf("?");if(i<0)return`${e}?${new URLSearchParams(t).toString()}`;const n=new URLSearchParams(e.slice(i));for(const e in t)n.set(e,t[e]);return`${e.slice(0,i)}?${n.toString()}`}function yt(e,t={persistentParams:[]}){const i=e.indexOf("?");if(i<0)return e;const n=new URLSearchParams,r=new URLSearchParams(e.slice(i));for(const e of t.persistentParams){const t=r.get(e);t&&n.set(e,t)}const o=n.toString();return`${e.slice(0,i)}${o.length>0?`?${o}`:""}`}const vt="mapbox-tiles";let xt=500,bt=50;const Tt=["language","worldview","jobid"];let wt,Et;function St(){try{return caches}catch(e){}}function At(){const e=St();e&&null==wt&&(wt=e.open(vt))}let Mt=1/0;const It={supported:!1,testSupport:function(e){!Lt&&Pt&&(Rt?Dt(e):Ct=e)}};let Ct,Pt,Lt=!1,Rt=!1;const Ot="undefined"!=typeof self?self:{};function Dt(e){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);try{if(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,Pt),e.isContextLost())return;It.supported=!0}catch(e){}e.deleteTexture(t),Lt=!0}Ot.document&&(Pt=Ot.document.createElement("img"),Pt.onload=function(){Ct&&Dt(Ct),Ct=null,Rt=!0},Pt.onerror=function(){Lt=!0,Ct=null},Pt.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Bt={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(Bt);class Ft extends Error{constructor(e,t,i){401===t&&at(i)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=t,this.url=i}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Nt=Je()?()=>self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href,kt=function(e,t){if(!(/^file:/.test(i=e.url)||/^file:/.test(Nt())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(e,t){const i=new AbortController,n=new Request(e.url,{method:e.method||"GET",body:e.body,credentials:e.credentials,headers:e.headers,referrer:Nt(),referrerPolicy:e.referrerPolicy,signal:i.signal});let r=!1,o=!1;const s=(a=n.url).indexOf("sku=")>0&&at(a);var a;"json"===e.type&&n.headers.set("Accept","application/json");const l=(i,r,a)=>{if(o)return;if(i&&"SecurityError"!==i.message&&qe(i.toString()),r&&a)return c(r);const l=Date.now();fetch(n).then((i=>{if(i.ok){const e=s?i.clone():null;return c(i,e,l)}return t(new Ft(i.statusText,i.status,e.url))})).catch((i=>{"AbortError"!==i.name&&t(new Error(`${i.message} ${e.url}`))}))},c=(i,s,a)=>{("arrayBuffer"===e.type?i.arrayBuffer():"json"===e.type?i.json():i.text()).then((e=>{o||(s&&a&&function(e,t,i){if(At(),null==wt)return;const n=Ke(t.headers.get("Cache-Control")||"");if(n["no-store"])return;const r={status:t.status,statusText:t.statusText,headers:new Headers};t.headers.forEach(((e,t)=>r.headers.set(t,e))),n["max-age"]&&r.headers.set("Expires",new Date(i+1e3*n["max-age"]).toUTCString());const o=r.headers.get("Expires");if(!o)return;if(new Date(o).getTime()-i<42e4)return;let s=yt(e.url,{persistentParams:Tt});if(206===t.status){const t=e.headers.get("Range");if(!t)return;r.status=200,s=_t(s,{range:t})}!function(e,t){if(void 0===Et)try{new Response(new ReadableStream),Et=!0}catch(e){Et=!1}Et?t(e.body):e.blob().then(t).catch((e=>qe(e.message)))}(t,(e=>{const i=new Response(200!==(n=t.status)&&404!==n&&[101,103,204,205,304].includes(n)?null:e,r);var n;At(),null!=wt&&wt.then((e=>e.put(s,i))).catch((e=>qe(e.message)))}))}(n,s,a),r=!0,t(null,e,i.headers))})).catch((e=>{o||t(new Error(e.message))}))};return s?function(e,t){if(At(),null==wt)return t(null);wt.then((i=>{let n=yt(e.url,{persistentParams:Tt});const r=e.headers.get("Range");r&&(n=_t(n,{range:r})),i.match(n).then((e=>{const r=function(e){if(!e)return!1;const t=new Date(e.headers.get("Expires")||0),i=Ke(e.headers.get("Cache-Control")||"");return Number(t)>Date.now()&&!i["no-cache"]}(e);i.delete(n).catch(t),r&&i.put(n,e.clone()).catch(t),t(null,e,r)})).catch(t)})).catch(t)}(n,l):l(null,null),{cancel:()=>{o=!0,r||i.abort()}}}(e,t);if(Je(self)&&self.worker.actor)return self.worker.actor.send("getResource",e,t,void 0,!0)}var i;return function(e,t){const i=new XMLHttpRequest;i.open(e.method||"GET",e.url,!0),"arrayBuffer"===e.type&&(i.responseType="arraybuffer");for(const t in e.headers)i.setRequestHeader(t,e.headers[t]);return"json"===e.type&&(i.responseType="text",i.setRequestHeader("Accept","application/json")),i.withCredentials="include"===e.credentials,i.onerror=()=>{t(new Error(i.statusText))},i.onload=()=>{if((i.status>=200&&i.status<300||0===i.status)&&null!==i.response){let n=i.response;if("json"===e.type)try{n=JSON.parse(i.response)}catch(e){return t(e)}const r=new Headers;i.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((e=>{const t=e.split(": "),i=t.shift(),n=t.join(": ");r.append(i,n)})),t(null,n,r)}else t(new Ft(i.statusText,i.status,e.url))},i.send(e.body),{cancel:()=>i.abort()}}(e,t)},Ut=function(e,t){return kt(Object.assign(e,{type:"arrayBuffer"}),t)};function zt(e){const t=document.createElement("a");return t.href=e,t.protocol===location.protocol&&t.host===location.host}const Vt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Gt,jt;Gt=[],jt=0;const Ht=function(e,t){if(It.supported&&(e.headers||(e.headers={}),e.headers.accept="image/webp,*/*"),jt>=st.MAX_PARALLEL_IMAGE_REQUESTS){const i={requestParameters:e,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return Gt.push(i),i}jt++;let i=!1;const n=()=>{if(!i)for(i=!0,jt--;Gt.length&&jt<st.MAX_PARALLEL_IMAGE_REQUESTS;){const e=Gt.shift(),{requestParameters:t,callback:i,cancelled:n}=e;n||(e.cancel=Ht(t,i).cancel)}},r=Ut(e,((e,i,r)=>{n(),e?t(e):i&&(self.createImageBitmap?function(e,t){const i=new Blob([new Uint8Array(e)],{type:"image/png"});createImageBitmap(i).then((e=>{t(null,e)})).catch((e=>{t(new Error(`Could not load image because of ${e.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(i,((e,i)=>t(e,i,r))):function(e,t){const i=new Image;i.onload=()=>{t(null,i),URL.revokeObjectURL(i.src),i.onload=null,requestAnimationFrame((()=>{i.src=Vt}))},i.onerror=()=>t(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const n=new Blob([new Uint8Array(e)],{type:"image/png"});i.src=e.byteLength?URL.createObjectURL(n):Vt}(i,((e,i)=>t(e,i,r))))}));return{cancel:()=>{r.cancel(),n()}}};var $t,Wt,qt,Xt={exports:{}},Yt={exports:{}},Zt={exports:{}},Jt=function(){if(qt)return Xt.exports;qt=1;var e=($t||($t=1,Yt.exports=function(e,t){var i,n,r,o,s,a,l,c;for(n=e.length-(i=3&e.length),r=t,s=3432918353,a=461845907,c=0;c<n;)l=255&e.charCodeAt(c)|(255&e.charCodeAt(++c))<<8|(255&e.charCodeAt(++c))<<16|(255&e.charCodeAt(++c))<<24,++c,r=27492+(65535&(o=5*(65535&(r=(r^=l=(65535&(l=(l=(65535&l)*s+(((l>>>16)*s&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295)<<13|r>>>19))+((5*(r>>>16)&65535)<<16)&4294967295))+((58964+(o>>>16)&65535)<<16);switch(l=0,i){case 3:l^=(255&e.charCodeAt(c+2))<<16;case 2:l^=(255&e.charCodeAt(c+1))<<8;case 1:r^=l=(65535&(l=(l=(65535&(l^=255&e.charCodeAt(c)))*s+(((l>>>16)*s&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295}return r^=e.length,r=2246822507*(65535&(r^=r>>>16))+((2246822507*(r>>>16)&65535)<<16)&4294967295,r=3266489909*(65535&(r^=r>>>13))+((3266489909*(r>>>16)&65535)<<16)&4294967295,(r^=r>>>16)>>>0}),Yt.exports),t=(Wt||(Wt=1,Zt.exports=function(e,t){for(var i,n=e.length,r=t^n,o=0;n>=4;)i=1540483477*(65535&(i=255&e.charCodeAt(o)|(255&e.charCodeAt(++o))<<8|(255&e.charCodeAt(++o))<<16|(255&e.charCodeAt(++o))<<24))+((1540483477*(i>>>16)&65535)<<16),r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16)^(i=1540483477*(65535&(i^=i>>>24))+((1540483477*(i>>>16)&65535)<<16)),n-=4,++o;switch(n){case 3:r^=(255&e.charCodeAt(o+2))<<16;case 2:r^=(255&e.charCodeAt(o+1))<<8;case 1:r=1540483477*(65535&(r^=255&e.charCodeAt(o)))+((1540483477*(r>>>16)&65535)<<16)}return r=1540483477*(65535&(r^=r>>>13))+((1540483477*(r>>>16)&65535)<<16),(r^=r>>>15)>>>0}),Zt.exports);return Xt.exports=e,Xt.exports.murmur3=e,Xt.exports.murmur2=t,Xt.exports}(),Kt=be(Jt);class Qt{constructor(e,...t){Object.assign(this,t[0]||{}),this.type=e}}class ei extends Qt{constructor(e,t={}){super("error",Object.assign({error:e},t))}}function ti(e,t,i){i[e]&&-1!==i[e].indexOf(t)||(i[e]=i[e]||[],i[e].push(t))}function ii(e,t,i){if(i&&i[e]){const n=i[e].indexOf(t);-1!==n&&i[e].splice(n,1)}}class ni{on(e,t){return this._listeners=this._listeners||{},ti(e,t,this._listeners),this}off(e,t){return ii(e,t,this._listeners),ii(e,t,this._oneTimeListeners),this}once(e,t){return t?(this._oneTimeListeners=this._oneTimeListeners||{},ti(e,t,this._oneTimeListeners),this):new Promise((t=>{this.once(e,t)}))}fire(e,t){const i="string"==typeof e?new Qt(e,t):e,n=i.type;if(this.listens(n)){i.target=this;const e=this._listeners&&this._listeners[n]?this._listeners[n].slice():[];for(const t of e)t.call(this,i);const t=this._oneTimeListeners&&this._oneTimeListeners[n]?this._oneTimeListeners[n].slice():[];for(const e of t)ii(n,e,this._oneTimeListeners),e.call(this,i);const r=this._eventedParent;if(r){const e="function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData;Object.assign(i,e),r.fire(i)}}return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,t){return this._eventedParent=e,this._eventedParentData=t,this}}class ri{constructor(e){"string"==typeof e?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new ri(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[t,i]=e.split("");return new ri({name:t,iconsetId:i})}static isEqual(e,t){return e.name===t.name&&e.iconsetId===t.iconsetId}toString(){return ri.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var oi,si={},ai=function(){if(oi)return si;oi=1;var e={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function t(e){return(e=Math.round(e))<0?0:e>255?255:e}function i(e){return t("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e))}function n(e){return(t="%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))<0?0:t>1?1:t;var t}function r(e,t,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?e+(t-e)*i*6:2*i<1?t:3*i<2?e+(t-e)*(2/3-i)*6:e}try{si.parseCSSColor=function(o){var s,a=o.replace(/ /g,"").toLowerCase();if(a in e)return e[a].slice();if("#"===a[0])return 4===a.length?(s=parseInt(a.substr(1),16))>=0&&s<=4095?[(3840&s)>>4|(3840&s)>>8,240&s|(240&s)>>4,15&s|(15&s)<<4,1]:null:7===a.length&&(s=parseInt(a.substr(1),16))>=0&&s<=16777215?[(16711680&s)>>16,(65280&s)>>8,255&s,1]:null;var l=a.indexOf("("),c=a.indexOf(")");if(-1!==l&&c+1===a.length){var u=a.substr(0,l),h=a.substr(l+1,c-(l+1)).split(","),d=1;switch(u){case"rgba":if(4!==h.length)return null;d=n(h.pop());case"rgb":return 3!==h.length?null:[i(h[0]),i(h[1]),i(h[2]),d];case"hsla":if(4!==h.length)return null;d=n(h.pop());case"hsl":if(3!==h.length)return null;var p=(parseFloat(h[0])%360+360)%360/360,f=n(h[1]),m=n(h[2]),g=m<=.5?m*(f+1):m+f-m*f,_=2*m-g;return[t(255*r(_,g,p+1/3)),t(255*r(_,g,p)),t(255*r(_,g,p-1/3)),d];default:return null}}return null}}catch(e){}return si}();class li{constructor(e,t,i,n=1){this.r=e,this.g=t,this.b=i,this.a=n}static parse(e){if(!e)return;if(e instanceof li)return e;if("string"!=typeof e)return;const t=ai.parseCSSColor(e);return t?new li(t[0]/255,t[1]/255,t[2]/255,t[3]):void 0}toString(){const[e,t,i,n]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*t)},${Math.round(255*i)},${n})`}toNonPremultipliedRenderColor(e){const{r:t,g:i,b:n,a:r}=this;return new ui(e,t,i,n,r)}toPremultipliedRenderColor(e){const{r:t,g:i,b:n,a:r}=this;return new hi(e,t*r,i*r,n*r,r)}clone(){return new li(this.r,this.g,this.b,this.a)}}class ci{constructor(e,t,i,n,r,o=!1){if(this.premultiplied=!1,this.premultiplied=o,e){const o=e.image.height,s=o*o;this.premultiplied?(t=0===r?0:t/r*(o-1),i=0===r?0:i/r*(o-1),n=0===r?0:n/r*(o-1)):(t*=o-1,i*=o-1,n*=o-1);const a=Math.floor(t),l=Math.floor(i),c=Math.floor(n),u=Math.ceil(t),h=Math.ceil(i),d=Math.ceil(n),p=t-a,f=i-l,m=n-c,g=e.image.data,_=4*(a+l*s+c*o),y=4*(a+l*s+d*o),v=4*(a+h*s+c*o),x=4*(a+h*s+d*o),b=4*(u+l*s+c*o),T=4*(u+l*s+d*o),w=4*(u+h*s+c*o),E=4*(u+h*s+d*o);if(_<0||E>=g.length)throw new Error("out of range");this.r=di(di(di(g[_],g[y],m),di(g[v],g[x],m),f),di(di(g[b],g[T],m),di(g[w],g[E],m),f),p)/255*(this.premultiplied?r:1),this.g=di(di(di(g[_+1],g[y+1],m),di(g[v+1],g[x+1],m),f),di(di(g[b+1],g[T+1],m),di(g[w+1],g[E+1],m),f),p)/255*(this.premultiplied?r:1),this.b=di(di(di(g[_+2],g[y+2],m),di(g[v+2],g[x+2],m),f),di(di(g[b+2],g[T+2],m),di(g[w+2],g[E+2],m),f),p)/255*(this.premultiplied?r:1),this.a=r}else this.r=t,this.g=i,this.b=n,this.a=r}toArray(){const{r:e,g:t,b:i,a:n}=this;return[255*e,255*t,255*i,n]}toHslaArray(){let{r:e,g:t,b:i,a:n}=this;if(this.premultiplied){if(0===n)return[0,0,0,0];const r=1/n;e*=r,t*=r,i*=r}const r=Math.min(Math.max(e,0),1),o=Math.min(Math.max(t,0),1),s=Math.min(Math.max(i,0),1),a=Math.min(r,o,s),l=Math.max(r,o,s),c=l-a,u=.5*(a+l);if(0===c)return[0,0,100*u,n];const h=u>.5?c/(2-l-a):c/(l+a);let d;switch(l){case r:d=60*((o-s)/c+(o<s?6:0));break;case o:d=60*((s-r)/c+2);break;default:d=60*((r-o)/c+4)}return[d,100*h,100*u,n]}toArray01(){const{r:e,g:t,b:i,a:n}=this;return[e,t,i,n]}toArray01Scaled(e){const{r:t,g:i,b:n}=this;return[t*e,i*e,n*e]}toArray01Linear(){const{r:e,g:t,b:i,a:n}=this;return[Math.pow(e,2.2),Math.pow(t,2.2),Math.pow(i,2.2),n]}}class ui extends ci{constructor(e,t,i,n,r){super(e,t,i,n,r,!1)}}class hi extends ci{constructor(e,t,i,n,r){super(e,t,i,n,r,!0)}}function di(e,t,i){return e*(1-i)+t*i}function pi(e,t,i){return e.map(((e,n)=>di(e,t[n],i)))}li.black=new li(0,0,0,1),li.white=new li(1,1,1,1),li.transparent=new li(0,0,0,0),li.red=new li(1,0,0,1),li.blue=new li(0,0,1,1);var fi=Object.freeze({__proto__:null,array:pi,color:function(e,t,i){return new li(di(e.r,t.r,i),di(e.g,t.g,i),di(e.b,t.b,i),di(e.a,t.a,i))},number:di});class mi extends Error{constructor(e,t){super(t),this.message=t,this.key=e}}class gi{constructor(e,t=[]){this.parent=e,this.bindings={};for(const[e,i]of t)this.bindings[e]=i}concat(e){return new gi(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const _i={kind:"null"},yi={kind:"number"},vi={kind:"string"},xi={kind:"boolean"},bi={kind:"color"},Ti={kind:"object"},wi={kind:"value"},Ei={kind:"collator"},Si={kind:"formatted"},Ai={kind:"resolvedImage"};function Mi(e,t){return{kind:"array",itemType:e,N:t}}function Ii(e){if("array"===e.kind){const t=Ii(e.itemType);return"number"==typeof e.N?`array<${t}, ${e.N}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}const Ci=[_i,yi,vi,xi,bi,Si,Ti,Mi(wi),Ai];function Pi(e,t){if("error"===t.kind)return null;if("array"===e.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!Pi(e.itemType,t.itemType))&&("number"!=typeof e.N||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if("value"===e.kind)for(const e of Ci)if(!Pi(e,t))return null}return`Expected ${Ii(e)} but found ${Ii(t)} instead.`}function Li(e,t){return t.some((t=>t.kind===e.kind))}function Ri(e,t){return t.some((t=>"null"===t?null===e:"array"===t?Array.isArray(e):"object"===t?e&&!Array.isArray(e)&&"object"==typeof e:t===typeof e))}function Oi(e,t){return"array"===e.kind&&"array"===t.kind?e.N===t.N&&Oi(e.itemType,t.itemType):e.kind===t.kind}class Di{constructor(e,t,i){this.sensitivity=e?t?"variant":"case":t?"accent":"base",this.locale=i,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,t){return this.collator.compare(e,t)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Bi{constructor(e,t,i,n,r){this.text=e.normalize?e.normalize():e,this.image=t,this.scale=i,this.fontStack=n,this.textColor=r}}class Fi{constructor(e){this.sections=e}static fromString(e){return new Fi([new Bi(e,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((e=>0!==e.text.length||!!e.image&&e.image.hasPrimary()))}static factory(e){return e instanceof Fi?e:Fi.fromString(e)}toString(){return 0===this.sections.length?"":this.sections.map((e=>e.text)).join("")}serialize(){const e=["format"];for(const t of this.sections){if(t.image){const i=t.image.getPrimary().id.toString();e.push(["image",i]);continue}e.push(t.text);const i={};t.fontStack&&(i["text-font"]=["literal",t.fontStack.split(",")]),t.scale&&(i["font-scale"]=t.scale),t.textColor&&(i["text-color"]=["rgba"].concat(t.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(i)}return e}}class Ni{constructor(e,t={}){if(this.id=ri.from(e),this.options=Object.assign({},t),t.transform){const{a:e,b:i,c:n,d:r,e:o,f:s}=t.transform;this.options.transform=new DOMMatrix([e,i,n,r,o,s])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:t,c:i,d:n,e:r,f:o}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:t,c:i,d:n,e:r,f:o}})}static parse(e){let t,i,n,r;try{({name:t,iconsetId:i,params:n,transform:r}=JSON.parse(e)||{})}catch(e){return null}if(!t)return null;const{a:o,b:s,c:a,d:l,e:c,f:u}=r||{};return new Ni({name:t,iconsetId:i},{params:n,transform:new DOMMatrix([o,s,a,l,c,u])})}scaleSelf(e,t){return this.options.transform.scaleSelf(e,t),this}}class ki{constructor(e,t,i,n,r=!1){this.primaryId=ri.from(e),this.primaryOptions=t,i&&(this.secondaryId=ri.from(i)),this.secondaryOptions=n,this.available=r}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Ni(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Ni(this.secondaryId,this.secondaryOptions):null}static from(e){return"string"==typeof e?ki.build({name:e}):e}static build(e,t,i,n){return!e||"object"==typeof e&&!("name"in e)?null:new ki(e,i,t,n)}}function Ui(e,t,i,n){return"number"==typeof e&&e>=0&&e<=255&&"number"==typeof t&&t>=0&&t<=255&&"number"==typeof i&&i>=0&&i<=255?void 0===n||"number"==typeof n&&n>=0&&n<=1?null:`Invalid rgba value [${[e,t,i,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof n?[e,t,i,n]:[e,t,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function zi(e){if(null===e)return!0;if("string"==typeof e)return!0;if("boolean"==typeof e)return!0;if("number"==typeof e)return!0;if(e instanceof li)return!0;if(e instanceof Di)return!0;if(e instanceof Fi)return!0;if(e instanceof ki)return!0;if(Array.isArray(e)){for(const t of e)if(!zi(t))return!1;return!0}if("object"==typeof e){for(const t in e)if(!zi(e[t]))return!1;return!0}return!1}function Vi(e){if(null===e)return _i;if("string"==typeof e)return vi;if("boolean"==typeof e)return xi;if("number"==typeof e)return yi;if(e instanceof li)return bi;if(e instanceof Di)return Ei;if(e instanceof Fi)return Si;if(e instanceof ki)return Ai;if(Array.isArray(e)){const t=e.length;let i;for(const t of e){const e=Vi(t);if(i){if(i===e)continue;i=wi;break}i=e}return Mi(i||wi,t)}return Ti}function Gi(e){const t=typeof e;return null===e?"":"string"===t||"number"===t||"boolean"===t?String(e):e instanceof Fi||e instanceof ki||e instanceof li?e.toString():JSON.stringify(e)}class ji{constructor(e,t){this.type=e,this.value=t}static parse(e,t){if(2!==e.length)return t.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!zi(e[1]))return t.error("invalid value");const i=e[1];let n=Vi(i);const r=t.expectedType;return"array"!==n.kind||0!==n.N||!r||"array"!==r.kind||"number"==typeof r.N&&0!==r.N||(n=r),new ji(n,i)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof li?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Fi?this.value.serialize():this.value}}class Hi{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const $i={string:vi,number:yi,boolean:xi,object:Ti};class Wi{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let i,n=1;const r=e[0];if("array"===r){let r,o;if(e.length>2){const i=e[1];if("string"!=typeof i||!(i in $i)||"object"===i)return t.error('The item type argument of "array" must be one of string, number, boolean',1);r=$i[i],n++}else r=wi;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return t.error('The length argument to "array" must be a positive integer literal',2);o=e[2],n++}i=Mi(r,o)}else i=$i[r];const o=[];for(;n<e.length;n++){const i=t.parse(e[n],n,wi);if(!i)return null;o.push(i)}return new Wi(i,o)}evaluate(e){for(let t=0;t<this.args.length;t++){const i=this.args[t].evaluate(e);if(!Pi(this.type,Vi(i)))return i;if(t===this.args.length-1)throw new Hi(`The expression ${JSON.stringify(this.args[t].serialize())} evaluated to ${Ii(Vi(i))} but was expected to be of type ${Ii(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=this.type,t=[e.kind];if("array"===e.kind){const i=e.itemType;if("string"===i.kind||"number"===i.kind||"boolean"===i.kind){t.push(i.kind);const n=e.N;("number"==typeof n||this.args.length>1)&&t.push(n)}}return t.concat(this.args.map((e=>e.serialize())))}}class qi{constructor(e){this.type=Si,this.sections=e}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const i=e[1];if(!Array.isArray(i)&&"object"==typeof i)return t.error("First argument must be an image or text section.");const n=[];let r=!1;for(let i=1;i<=e.length-1;++i){const o=e[i];if(r&&"object"==typeof o&&!Array.isArray(o)){r=!1;let e=null;if(o["font-scale"]&&(e=t.parseObjectValue(o["font-scale"],i,"font-scale",yi),!e))return null;let s=null;if(o["text-font"]&&(s=t.parseObjectValue(o["text-font"],i,"text-font",Mi(vi)),!s))return null;let a=null;if(o["text-color"]&&(a=t.parseObjectValue(o["text-color"],i,"text-color",bi),!a))return null;const l=n[n.length-1];l.scale=e,l.font=s,l.textColor=a}else{const o=t.parse(e[i],i,wi);if(!o)return null;const s=o.type.kind;if("string"!==s&&"value"!==s&&"null"!==s&&"resolvedImage"!==s)return t.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");r=!0,n.push({content:o,scale:null,font:null,textColor:null})}}return new qi(n)}evaluate(e){return new Fi(this.sections.map((t=>{const i=t.content.evaluate(e);return Oi(Vi(i),Ai)?new Bi("",i,null,null,null):new Bi(Gi(i),null,t.scale?t.scale.evaluate(e):null,t.font?t.font.evaluate(e).join(","):null,t.textColor?t.textColor.evaluate(e):null)})))}eachChild(e){for(const t of this.sections)e(t.content),t.scale&&e(t.scale),t.font&&e(t.font),t.textColor&&e(t.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const t of this.sections){e.push(t.content.serialize());const i={};t.scale&&(i["font-scale"]=t.scale.serialize()),t.font&&(i["text-font"]=t.font.serialize()),t.textColor&&(i["text-color"]=t.textColor.serialize()),e.push(i)}return e}}class Xi{constructor(e,t,i,n){this._imageWarnHistory={},this.type=Ai,this.namePrimary=e,this.nameSecondary=t,i&&(this.paramsPrimary=i.params,this.iconsetIdPrimary=i.iconset?i.iconset.id:void 0),n&&(this.paramsSecondary=n.params,this.iconsetIdSecondary=n.iconset?n.iconset.id:void 0)}static parse(e,t){if(e.length<2)return t.error("Expected two or more arguments.");let i=1;const n=[];function r(){if(i<e.length){const r=t.parse(e[i],i++,vi);return r?(n.push({image:r,options:{}}),!0):(t.error(n.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function o(){if(i<e.length){const o=e[i];if(null===(r=o)||"object"!=typeof r||Array.isArray(r))return!0;const s=o.params,a=o.iconset,l=t.concat(i);if(!s&&!a)return i++,!0;if(s){if("object"!=typeof s||s.constructor!==Object)return l.error('Image options "params" should be an object'),!1;const e={},t=l.concat(void 0,"params");for(const i in s){if(!i)return t.error("Image parameter name should be non-empty"),!1;const n=t.concat(void 0,i).parse(s[i],void 0,bi,void 0,{typeAnnotation:"coerce"});if(!n)return!1;e[i]=n}n[n.length-1].options.params=e}if(a){if("object"!=typeof a||a.constructor!==Object)return l.error('Image options "iconset" should be an object'),!1;if(!a.id)return l.error('Image options "iconset" should have an "id" property'),!1;n[n.length-1].options.iconset=a}return i++,!0}var r;return!0}for(let e=0;e<2;e++)if(!r()||!o())return;return new Xi(n[0].image,n[1]?n[1].image:void 0,n[0].options,n[1]?n[1].options:void 0)}evaluateParams(e,t){const i={};if(t){for(const n in t)if(t[n])try{i[n]=t[n].evaluate(e)}catch(e){continue}if(0!==Object.keys(i).length)return{params:i}}}evaluate(e){const t={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},i=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,n=ki.build(t,i,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(n&&e.availableImages){const t=n.getPrimary().id;if(n.available=e.availableImages.some((e=>ri.isEqual(e,t))),n.available){const t=n.getSecondary()?n.getSecondary().id:null;t&&(n.available=e.availableImages.some((e=>ri.isEqual(e,t))))}}return n}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const t in this.paramsPrimary)this.paramsPrimary[t]&&e(this.paramsPrimary[t]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const t in this.paramsSecondary)this.paramsSecondary[t]&&e(this.paramsSecondary[t])}outputDefined(){return!1}serializeOptions(e,t){const i={};if(t&&(i.iconset={id:t}),e){i.params={};for(const t in e)e[t]&&(i.params[t]=e[t].serialize())}return Object.keys(i).length>0?i:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const t=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);t&&e.push(t)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const t=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);t&&e.push(t)}return e}}function Yi(e){return Ji(e)?"string":Ki(e)?"number":Qi(e)?"boolean":Array.isArray(e)?"array":null===e?"null":Zi(e)?"object":typeof e}function Zi(e){return null!=e&&!Array.isArray(e)&&"function"!=typeof e&&!(e instanceof String||e instanceof Number||e instanceof Boolean)&&"object"==typeof e}function Ji(e){return"string"==typeof e||e instanceof String}function Ki(e){return"number"==typeof e||e instanceof Number}function Qi(e){return"boolean"==typeof e||e instanceof Boolean}const en={"to-boolean":xi,"to-color":bi,"to-number":yi,"to-string":vi};class tn{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const i=e[0],n=[];let r=_i;if("to-array"===i){if(!Array.isArray(e[1]))return null;const i=e[1].length;if(t.expectedType){if("array"!==t.expectedType.kind)return t.error(`Expected ${t.expectedType.kind} but found array.`);r=Mi(t.expectedType.itemType,i)}else{if(!(i>0&&zi(e[1][0])))return null;r=Mi(Vi(e[1][0]),i)}for(let o=0;o<i;o++){const i=e[1][o];let s;if(Array.isArray(i))s=t.parse(i,void 0,r.itemType);else{const e=Yi(i);if(e!==r.itemType.kind)return t.error(`Expected ${r.itemType.kind} but found ${e}.`);s=t.registry.literal.parse(["literal",void 0===i?null:i],t)}if(!s)return null;n.push(s)}}else{if(("to-boolean"===i||"to-string"===i)&&2!==e.length)return t.error("Expected one argument.");r=en[i];for(let i=1;i<e.length;i++){const r=t.parse(e[i],i,wi);if(!r)return null;n.push(r)}}return new tn(r,n)}evaluate(e){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(e));if("color"===this.type.kind){let t,i;for(const n of this.args){if(t=n.evaluate(e),i=null,t instanceof li)return t;if("string"==typeof t){const i=e.parseColor(t);if(i)return i}else if(Array.isArray(t)&&(i=t.length<3||t.length>4?`Invalid rbga value ${JSON.stringify(t)}: expected an array containing either three or four numeric values.`:Ui(t[0],t[1],t[2],t[3]),!i))return new li(t[0]/255,t[1]/255,t[2]/255,t[3])}throw new Hi(i||`Could not parse color from value '${"string"==typeof t?t:String(JSON.stringify(t))}'`)}if("number"===this.type.kind){let t=null;for(const i of this.args){if(t=i.evaluate(e),null===t)return 0;const n=Number(t);if(!isNaN(n))return n}throw new Hi(`Could not convert ${JSON.stringify(t)} to number.`)}return"formatted"===this.type.kind?Fi.fromString(Gi(this.args[0].evaluate(e))):"resolvedImage"===this.type.kind?ki.build(Gi(this.args[0].evaluate(e))):"array"===this.type.kind?this.args.map((t=>t.evaluate(e))):Gi(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new qi([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Xi(this.args[0]).serialize();const e="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((t=>{e.push(t.serialize())})),e}}const nn=["Unknown","Point","LineString","Polygon"];class rn{constructor(e,t,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=t,this.iconImageUseTheme=i}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?nn[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:i,y:n}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(i*t-e[0])+this.featureDistanceData.bearing[1]*(n*t-e[1])}return 0}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=li.parse(e)),t}getConfig(e){return this.options?this.options.get(e):null}}class on{constructor(e,t,i,n,r){this.name=e,this.type=t,this._evaluate=i,this.args=n,this._overloadIndex=r}evaluate(e){if(!this._evaluate){const e=on.definitions[this.name];this._evaluate=Array.isArray(e)?e[2]:e.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((e=>e.serialize())))}static parse(e,t){const i=e[0],n=on.definitions[i];if(!n)return t.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0);const r=Array.isArray(n)?n[0]:n.type,o=Array.isArray(n)?[[n[1],n[2]]]:n.overloads,s=[];let a=null,l=-1;for(const[n,c]of o){if(Array.isArray(n)&&n.length!==e.length-1)continue;s.push(n),l++,a=new Sr(t.registry,t.path,null,t.scope,void 0,t._scope,t.options,t.iconImageUseTheme);const o=[];let u=!1;for(let t=1;t<e.length;t++){const i=e[t],r=Array.isArray(n)?n[t-1]:n.type,s=a.parse(i,1+o.length,r);if(!s){u=!0;break}o.push(s)}if(!u)if(Array.isArray(n)&&n.length!==o.length)a.error(`Expected ${n.length} arguments, but found ${o.length} instead.`);else{for(let e=0;e<o.length;e++){const t=Array.isArray(n)?n[e]:n.type,i=o[e];a.concat(e+1).checkSubtype(t,i.type)}if(0===a.errors.length)return new on(i,r,c,o,l)}}if(1===s.length)t.errors.push(...a.errors);else{const i=(s.length?s:o.map((([e])=>e))).map(sn).join(" | "),n=[];for(let i=1;i<e.length;i++){const r=t.parse(e[i],1+n.length);if(!r)return null;n.push(Ii(r.type))}t.error(`Expected arguments of type ${i}, but found (${n.join(", ")}) instead.`)}return null}static register(e,t){on.definitions=t;for(const i in t)e[i]=on}}function sn(e){return Array.isArray(e)?`(${e.map(Ii).join(", ")})`:`(${Ii(e.type)}...)`}class an{constructor(e,t,i){this.type=Ei,this.locale=i,this.caseSensitive=e,this.diacriticSensitive=t}static parse(e,t){if(2!==e.length)return t.error("Expected one argument.");const i=e[1];if("object"!=typeof i||Array.isArray(i))return t.error("Collator options argument must be an object.");const n=void 0===i["case-sensitive"]?t.parse(!1,1,xi):t.parseObjectValue(i["case-sensitive"],1,"case-sensitive",xi);if(!n)return null;const r=void 0===i["diacritic-sensitive"]?t.parse(!1,1,xi):t.parseObjectValue(i["diacritic-sensitive"],1,"diacritic-sensitive",xi);if(!r)return null;let o=null;return i.locale&&(o=t.parseObjectValue(i.locale,1,"locale",vi),!o)?null:new an(n,r,o)}evaluate(e){return new Di(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function ln(e,t,i=0,n=e.length-1,r=un){for(;n>i;){if(n-i>600){const o=n-i+1,s=t-i+1,a=Math.log(o),l=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*l*(o-l)/o)*(s-o/2<0?-1:1);ln(e,t,Math.max(i,Math.floor(t-s*l/o+c)),Math.min(n,Math.floor(t+(o-s)*l/o+c)),r)}const o=e[t];let s=i,a=n;for(cn(e,i,t),r(e[n],o)>0&&cn(e,i,n);s<a;){for(cn(e,s,a),s++,a--;r(e[s],o)<0;)s++;for(;r(e[a],o)>0;)a--}0===r(e[i],o)?cn(e,i,a):(a++,cn(e,a,n)),a<=t&&(i=a+1),t<=a&&(n=a-1)}}function cn(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}function un(e,t){return e<t?-1:e>t?1:0}function hn(e){let t=0;for(let i,n,r=0,o=e.length,s=o-1;r<o;s=r++)i=e[r],n=e[s],t+=(n.x-i.x)*(i.y+n.y);return t}function dn(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function pn(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function fn(e,t,i){const n=e[0]-t[0],r=e[1]-t[1],o=e[0]-i[0],s=e[1]-i[1];return n*s-o*r==0&&n*o<=0&&r*s<=0}function mn(e,t,i=!1){let n=!1;for(let a=0,l=t.length;a<l;a++){const l=t[a];for(let t=0,a=l.length,c=a-1;t<a;c=t++){const a=l[c],u=l[t];if(fn(e,a,u))return i;(o=a)[1]>(r=e)[1]!=(s=u)[1]>r[1]&&r[0]<(s[0]-o[0])*(r[1]-o[1])/(s[1]-o[1])+o[0]&&(n=!n)}}var r,o,s;return n}function gn(e,t,i,n){const r=n[0]-i[0],o=n[1]-i[1],s=(e[0]-i[0])*o-r*(e[1]-i[1]),a=(t[0]-i[0])*o-r*(t[1]-i[1]);return s>0&&a<0||s<0&&a>0}function _n(e,t,i,n){return 0!=(r=[n[0]-i[0],n[1]-i[1]])[0]*(o=[t[0]-e[0],t[1]-e[1]])[1]-r[1]*o[0]&&!(!gn(e,t,i,n)||!gn(i,n,e,t));var r,o}function yn(e){const t=new Ee(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new Ee(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const n of e[0])t.x>n.x&&(t.x=n.x),t.y>n.y&&(t.y=n.y),i.x<n.x&&(i.x=n.x),i.y<n.y&&(i.y=n.y);return{min:t,max:i}}const vn=8192;function xn(e,t){const i=(180+e[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360,r=Math.pow(2,t.z);return[Math.round(i*r*vn),Math.round(n*r*vn)]}function bn(e,t){for(let i=0;i<t.length;i++)if(mn(e,t[i]))return!0;return!1}function Tn(e,t,i){for(const n of i)for(let i=0,r=n.length,o=r-1;i<r;o=i++)if(_n(e,t,n[o],n[i]))return!0;return!1}function wn(e,t){for(let i=0;i<e.length;++i)if(!mn(e[i],t))return!1;for(let i=0;i<e.length-1;++i)if(Tn(e[i],e[i+1],t))return!1;return!0}function En(e,t){for(let i=0;i<t.length;i++)if(wn(e,t[i]))return!0;return!1}function Sn(e,t,i){const n=[];for(let r=0;r<e.length;r++){const o=[];for(let n=0;n<e[r].length;n++){const s=xn(e[r][n],i);dn(t,s),o.push(s)}n.push(o)}return n}function An(e,t,i){const n=[];for(let r=0;r<e.length;r++){const o=Sn(e[r],t,i);n.push(o)}return n}function Mn(e,t,i,n){if(e[0]<i[0]||e[0]>i[2]){const t=.5*n;let r=e[0]-i[0]>t?-n:i[0]-e[0]>t?n:0;0===r&&(r=e[0]-i[2]>t?-n:i[2]-e[0]>t?n:0),e[0]+=r}dn(t,e)}function In(e,t,i,n){const r=Math.pow(2,n.z)*vn,o=[n.x*vn,n.y*vn],s=[];if(!e)return s;for(const n of e)for(const e of n){const n=[e.x+o[0],e.y+o[1]];Mn(n,t,i,r),s.push(n)}return s}function Cn(e,t,i,n){const r=Math.pow(2,n.z)*vn,o=[n.x*vn,n.y*vn],s=[];if(!e)return s;for(const i of e){const e=[];for(const n of i){const i=[n.x+o[0],n.y+o[1]];dn(t,i),e.push(i)}s.push(e)}if(t[2]-t[0]<=r/2){(a=t)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const e of s)for(const n of e)Mn(n,t,i,r)}var a;return s}class Pn{constructor(e,t){this.type=xi,this.geojson=e,this.geometries=t}static parse(e,t){if(2!==e.length)return t.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(zi(e[1])){const t=e[1];if("FeatureCollection"===t.type)for(let e=0;e<t.features.length;++e){const i=t.features[e].geometry.type;if("Polygon"===i||"MultiPolygon"===i)return new Pn(t,t.features[e].geometry)}else if("Feature"===t.type){const e=t.geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new Pn(t,t.geometry)}else if("Polygon"===t.type||"MultiPolygon"===t.type)return new Pn(t,t)}return t.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryType())return function(e,t){const i=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],r=e.canonicalID();if(!r)return!1;if("Polygon"===t.type){const o=Sn(t.coordinates,n,r),s=In(e.geometry(),i,n,r);if(!pn(i,n))return!1;for(const e of s)if(!mn(e,o))return!1}if("MultiPolygon"===t.type){const o=An(t.coordinates,n,r),s=In(e.geometry(),i,n,r);if(!pn(i,n))return!1;for(const e of s)if(!bn(e,o))return!1}return!0}(e,this.geometries);if("LineString"===e.geometryType())return function(e,t){const i=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],r=e.canonicalID();if(!r)return!1;if("Polygon"===t.type){const o=Sn(t.coordinates,n,r),s=Cn(e.geometry(),i,n,r);if(!pn(i,n))return!1;for(const e of s)if(!wn(e,o))return!1}if("MultiPolygon"===t.type){const o=An(t.coordinates,n,r),s=Cn(e.geometry(),i,n,r);if(!pn(i,n))return!1;for(const e of s)if(!En(e,o))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Ln={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},Rn=1/298.257223563,On=Rn*(2-Rn),Dn=Math.PI/180;class Bn{static fromTile(e,t,i){const n=Math.PI*(1-2*(e+.5)/Math.pow(2,t)),r=Math.atan(.5*(Math.exp(n)-Math.exp(-n)))/Dn;return new Bn(r,i)}static get units(){return Ln}constructor(e,t){if(void 0===e)throw new Error("No latitude given.");if(t&&!Ln[t])throw new Error(`Unknown unit ${t}. Use one of: ${Object.keys(Ln).join(", ")}`);const i=6378.137*Dn*(t?Ln[t]:1),n=Math.cos(e*Dn),r=1/(1-On*(1-n*n)),o=Math.sqrt(r);this.kx=i*o*n,this.ky=i*o*r*(1-On)}distance(e,t){const i=kn(e[0]-t[0])*this.kx,n=(e[1]-t[1])*this.ky;return Math.sqrt(i*i+n*n)}bearing(e,t){const i=kn(t[0]-e[0])*this.kx;return Math.atan2(i,(t[1]-e[1])*this.ky)/Dn}destination(e,t,i){const n=i*Dn;return this.offset(e,Math.sin(n)*t,Math.cos(n)*t)}offset(e,t,i){return[e[0]+t/this.kx,e[1]+i/this.ky]}lineDistance(e){let t=0;for(let i=0;i<e.length-1;i++)t+=this.distance(e[i],e[i+1]);return t}area(e){let t=0;for(let i=0;i<e.length;i++){const n=e[i];for(let e=0,r=n.length,o=r-1;e<r;o=e++)t+=kn(n[e][0]-n[o][0])*(n[e][1]+n[o][1])*(i?-1:1)}return Math.abs(t)/2*this.kx*this.ky}along(e,t){let i=0;if(t<=0)return e[0];for(let n=0;n<e.length-1;n++){const r=e[n],o=e[n+1],s=this.distance(r,o);if(i+=s,i>t)return Nn(r,o,(t-(i-s))/s)}return e[e.length-1]}pointToSegmentDistance(e,t,i){let[n,r]=t,o=kn(i[0]-n)*this.kx,s=(i[1]-r)*this.ky;if(0!==o||0!==s){const t=(kn(e[0]-n)*this.kx*o+(e[1]-r)*this.ky*s)/(o*o+s*s);t>1?(n=i[0],r=i[1]):t>0&&(n+=o/this.kx*t,r+=s/this.ky*t)}return o=kn(e[0]-n)*this.kx,s=(e[1]-r)*this.ky,Math.sqrt(o*o+s*s)}pointOnLine(e,t){let i=1/0,n=e[0][0],r=e[0][1],o=0,s=0;for(let a=0;a<e.length-1;a++){let l=e[a][0],c=e[a][1],u=kn(e[a+1][0]-l)*this.kx,h=(e[a+1][1]-c)*this.ky,d=0;0===u&&0===h||(d=(kn(t[0]-l)*this.kx*u+(t[1]-c)*this.ky*h)/(u*u+h*h),d>1?(l=e[a+1][0],c=e[a+1][1]):d>0&&(l+=u/this.kx*d,c+=h/this.ky*d)),u=kn(t[0]-l)*this.kx,h=(t[1]-c)*this.ky;const p=u*u+h*h;p<i&&(i=p,n=l,r=c,o=a,s=d)}return{point:[n,r],index:o,t:Math.max(0,Math.min(1,s))}}lineSlice(e,t,i){let n=this.pointOnLine(i,e),r=this.pointOnLine(i,t);if(n.index>r.index||n.index===r.index&&n.t>r.t){const e=n;n=r,r=e}const o=[n.point],s=n.index+1,a=r.index;!Fn(i[s],o[0])&&s<=a&&o.push(i[s]);for(let e=s+1;e<=a;e++)o.push(i[e]);return Fn(i[a],r.point)||o.push(r.point),o}lineSliceAlong(e,t,i){let n=0;const r=[];for(let o=0;o<i.length-1;o++){const s=i[o],a=i[o+1],l=this.distance(s,a);if(n+=l,n>e&&0===r.length&&r.push(Nn(s,a,(e-(n-l))/l)),n>=t)return r.push(Nn(s,a,(t-(n-l))/l)),r;n>e&&r.push(a)}return r}bufferPoint(e,t){const i=t/this.ky,n=t/this.kx;return[e[0]-n,e[1]-i,e[0]+n,e[1]+i]}bufferBBox(e,t){const i=t/this.ky,n=t/this.kx;return[e[0]-n,e[1]-i,e[2]+n,e[3]+i]}insideBBox(e,t){return kn(e[0]-t[0])>=0&&kn(e[0]-t[2])<=0&&e[1]>=t[1]&&e[1]<=t[3]}}function Fn(e,t){return e[0]===t[0]&&e[1]===t[1]}function Nn(e,t,i){const n=kn(t[0]-e[0]);return[e[0]+n*i,e[1]+(t[1]-e[1])*i]}function kn(e){for(;e<-180;)e+=360;for(;e>180;)e-=360;return e}class Un{constructor(e=[],t=(e,t)=>e<t?-1:e>t?1:0){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(0===this.length)return;const e=this.data[0],t=this.data.pop();return--this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:i}=this,n=t[e];for(;e>0;){const r=e-1>>1,o=t[r];if(i(n,o)>=0)break;t[e]=o,e=r}t[e]=n}_down(e){const{data:t,compare:i}=this,n=this.length>>1,r=t[e];for(;e<n;){let n=1+(e<<1);const o=n+1;if(o<this.length&&i(t[o],t[n])<0&&(n=o),i(t[n],r)>=0)break;t[e]=t[n],e=n}t[e]=r}}var zn=8192;function Vn(e,t){return t.dist-e.dist}const Gn=100,jn=50;function Hn(e){const t=[1/0,1/0,-1/0,-1/0];if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function $n(e){return e[1]-e[0]+1}function Wn(e,t){return e[1]>=e[0]&&e[1]<t}function qn(e,t){if(e[0]>e[1])return[null,null];const i=$n(e);if(t){if(2===i)return[e,null];const t=Math.floor(i/2);return[[e[0],e[0]+t],[e[0]+t,e[1]]]}{if(1===i)return[e,null];const t=Math.floor(i/2)-1;return[[e[0],e[0]+t],[e[0]+t+1,e[1]]]}}function Xn(e,t){const i=[1/0,1/0,-1/0,-1/0];if(!Wn(t,e.length))return i;for(let n=t[0];n<=t[1];++n)dn(i,e[n]);return i}function Yn(e){const t=[1/0,1/0,-1/0,-1/0];for(let i=0;i<e.length;++i)for(let n=0;n<e[i].length;++n)dn(t,e[i][n]);return t}function Zn(e,t,i){if(Hn(e)||Hn(t))return NaN;let n=0,r=0;return e[2]<t[0]&&(n=t[0]-e[2]),e[0]>t[2]&&(n=e[0]-t[2]),e[1]>t[3]&&(r=e[1]-t[3]),e[3]<t[1]&&(r=t[1]-e[3]),i.distance([0,0],[n,r])}function Jn(e){return 360*e-180}function Kn(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}function Qn(e,t){const i=Math.pow(2,t.z),n=(e.y/zn+t.y)/i;return[Jn((e.x/zn+t.x)/i),Kn(n)]}function er(e,t){const i=[];for(let n=0;n<e.length;++n)i.push(Qn(e[n],t));return i}function tr(e,t,i){const n=i.pointOnLine(t,e).point;return i.distance(e,n)}function ir(e,t,i,n,r){const o=i.slice(n[0],n[1]+1);let s=1/0;for(let i=t[0];i<=t[1];++i)if(0===(s=Math.min(s,tr(e[i],o,r))))return 0;return s}function nr(e,t,i,n,r){const o=Math.min(r.pointToSegmentDistance(e,i,n),r.pointToSegmentDistance(t,i,n)),s=Math.min(r.pointToSegmentDistance(i,e,t),r.pointToSegmentDistance(n,e,t));return Math.min(o,s)}function rr(e,t,i,n,r){if(!Wn(t,e.length)||!Wn(n,i.length))return NaN;let o=1/0;for(let s=t[0];s<t[1];++s)for(let t=n[0];t<n[1];++t){if(_n(e[s],e[s+1],i[t],i[t+1]))return 0;o=Math.min(o,nr(e[s],e[s+1],i[t],i[t+1],r))}return o}function or(e,t,i,n,r){if(!Wn(t,e.length)||!Wn(n,i.length))return NaN;let o=1/0;for(let s=t[0];s<=t[1];++s)for(let t=n[0];t<=n[1];++t)if(0===(o=Math.min(o,r.distance(e[s],i[t]))))return o;return o}function sr(e,t,i){if(mn(e,t,!0))return 0;let n=1/0;for(const r of t){const t=r.length;if(t<2)return NaN;if(r[0]!==r[t-1]&&0===(n=Math.min(n,i.pointToSegmentDistance(e,r[t-1],r[0]))))return n;if(0===(n=Math.min(n,tr(e,r,i))))return n}return n}function ar(e,t,i,n){if(!Wn(t,e.length))return NaN;for(let n=t[0];n<=t[1];++n)if(mn(e[n],i,!0))return 0;let r=1/0;for(let o=t[0];o<t[1];++o)for(const t of i)for(let i=0,s=t.length,a=s-1;i<s;a=i++){if(_n(e[o],e[o+1],t[a],t[i]))return 0;r=Math.min(r,nr(e[o],e[o+1],t[a],t[i],n))}return r}function lr(e,t){for(const i of e)for(let e=0;e<=i.length-1;++e)if(mn(i[e],t,!0))return!0;return!1}function cr(e,t,i,n=1/0){const r=Yn(e),o=Yn(t);if(n!==1/0&&Zn(r,o,i)>=n)return n;if(pn(r,o)){if(lr(e,t))return 0}else if(lr(t,e))return 0;let s=n;for(const n of e)for(let e=0,r=n.length,o=r-1;e<r;o=e++)for(const r of t)for(let t=0,a=r.length,l=a-1;t<a;l=t++){if(_n(n[o],n[e],r[l],r[t]))return 0;s=Math.min(s,nr(n[o],n[e],r[l],r[t],i))}return s}function ur(e,t,i,n,r,o,s){if(null===o||null===s)return;const a=Zn(Xn(n,o),Xn(r,s),i);a<t&&e.push({dist:a,range1:o,range2:s})}function hr(e,t,i,n,r=1/0){let o=Math.min(n.distance(e[0],i[0][0]),r);if(0===o)return o;const s=new Un([{dist:0,range1:[0,e.length-1],range2:[0,0]}],Vn),a=t?jn:Gn,l=Yn(i);for(;s.length;){const r=s.pop();if(r.dist>=o)continue;const c=r.range1;if($n(c)<=a){if(!Wn(c,e.length))return NaN;if(t){const t=ar(e,c,i,n);if(0===(o=Math.min(o,t)))return o}else for(let t=c[0];t<=c[1];++t){const r=sr(e[t],i,n);if(0===(o=Math.min(o,r)))return o}}else{const i=qn(c,t);if(null!==i[0]){const t=Zn(Xn(e,i[0]),l,n);t<o&&s.push({dist:t,range1:i[0],range2:[0,0]})}if(null!==i[1]){const t=Zn(Xn(e,i[1]),l,n);t<o&&s.push({dist:t,range1:i[1],range2:[0,0]})}}}return o}function dr(e,t,i,n,r,o=1/0){let s=Math.min(o,r.distance(e[0],i[0]));if(0===s)return s;const a=new Un([{dist:0,range1:[0,e.length-1],range2:[0,i.length-1]}],Vn),l=t?jn:Gn,c=n?jn:Gn;for(;a.length;){const o=a.pop();if(o.dist>=s)continue;const u=o.range1,h=o.range2;if($n(u)<=l&&$n(h)<=c){if(!Wn(u,e.length)||!Wn(h,i.length))return NaN;if(t&&n?s=Math.min(s,rr(e,u,i,h,r)):t||n?t&&!n?s=Math.min(s,ir(i,h,e,u,r)):!t&&n&&(s=Math.min(s,ir(e,u,i,h,r))):s=Math.min(s,or(e,u,i,h,r)),0===s)return s}else{const o=qn(u,t),l=qn(h,n);ur(a,s,r,e,i,o[0],l[0]),ur(a,s,r,e,i,o[0],l[1]),ur(a,s,r,e,i,o[1],l[0]),ur(a,s,r,e,i,o[1],l[1])}}return s}function pr(e,t,i,n,r=1/0){let o=r;const s=Xn(e,[0,e.length-1]);for(const r of i)if(!(o!==1/0&&Zn(s,Xn(r,[0,r.length-1]),n)>=o)&&(o=Math.min(o,dr(e,t,r,!0,n,o)),0===o))return o;return o}function fr(e,t,i,n,r=1/0){let o=r;const s=Xn(e,[0,e.length-1]);for(const r of i){if(o!==1/0&&Zn(s,Yn(r),n)>=o)continue;const i=hr(e,t,r,n,o);if(isNaN(i))return i;if(0===(o=Math.min(o,i)))return o}return o}function mr(e){return"Point"===e||"MultiPoint"===e||"LineString"===e||"MultiLineString"===e||"Polygon"===e||"MultiPolygon"===e}class gr{constructor(e,t){this.type=yi,this.geojson=e,this.geometries=t}static parse(e,t){if(2!==e.length)return t.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(zi(e[1])){const t=e[1];if("FeatureCollection"===t.type){for(let e=0;e<t.features.length;++e)if(mr(t.features[e].geometry.type))return new gr(t,t.features[e].geometry)}else if("Feature"===t.type){if(mr(t.geometry.type))return new gr(t,t.geometry)}else if(mr(t.type))return new gr(t,t)}return t.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const t=e.geometry(),i=e.canonicalID();if(null!=t&&null!=i){if("Point"===e.geometryType())return function(e,t,i){const n=[];for(const i of e)for(const e of i)n.push(Qn(e,t));const r=new Bn(n[0][1],"meters");return"Point"===i.type||"MultiPoint"===i.type||"LineString"===i.type?dr(n,!1,"Point"===i.type?[i.coordinates]:i.coordinates,"LineString"===i.type,r):"MultiLineString"===i.type?pr(n,!1,i.coordinates,r):"Polygon"===i.type||"MultiPolygon"===i.type?fr(n,!1,"Polygon"===i.type?[i.coordinates]:i.coordinates,r):null}(t,i,this.geometries);if("LineString"===e.geometryType())return function(e,t,i){const n=[];for(const i of e){const e=[];for(const n of i)e.push(Qn(n,t));n.push(e)}const r=new Bn(n[0][0][1],"meters");if("Point"===i.type||"MultiPoint"===i.type||"LineString"===i.type)return pr("Point"===i.type?[i.coordinates]:i.coordinates,"LineString"===i.type,n,r);if("MultiLineString"===i.type){let e=1/0;for(let t=0;t<i.coordinates.length;t++){const o=pr(i.coordinates[t],!0,n,r,e);if(isNaN(o))return o;if(0===(e=Math.min(e,o)))return e}return e}if("Polygon"===i.type||"MultiPolygon"===i.type){let e=1/0;for(let t=0;t<n.length;t++){const o=fr(n[t],!0,"Polygon"===i.type?[i.coordinates]:i.coordinates,r,e);if(isNaN(o))return o;if(0===(e=Math.min(e,o)))return e}return e}return null}(t,i,this.geometries);if("Polygon"===e.geometryType())return function(e,t,i){const n=[];for(const i of function(e){const t=e.length;if(t<=1)return[e];const i=[];let n,r;for(let o=0;o<t;o++){const t=hn(e[o]);0!==t&&(e[o].area=Math.abs(t),void 0===r&&(r=t<0),r===t<0?(n&&i.push(n),n=[e[o]]):n.push(e[o]))}return n&&i.push(n),i}(e)){const e=[];for(let n=0;n<i.length;++n)e.push(er(i[n],t));n.push(e)}const r=new Bn(n[0][0][0][1],"meters");if("Point"===i.type||"MultiPoint"===i.type||"LineString"===i.type)return fr("Point"===i.type?[i.coordinates]:i.coordinates,"LineString"===i.type,n,r);if("MultiLineString"===i.type){let e=1/0;for(let t=0;t<i.coordinates.length;t++){const o=fr(i.coordinates[t],!0,n,r,e);if(isNaN(o))return o;if(0===(e=Math.min(e,o)))return e}return e}return"Polygon"===i.type||"MultiPolygon"===i.type?function(e,t,i){let n=1/0;for(const r of e)for(const e of t){const t=cr(r,e,i,n);if(isNaN(t))return t;if(0===(n=Math.min(n,t)))return n}return n}("Polygon"===i.type?[i.coordinates]:i.coordinates,n,r):null}(t,i,this.geometries)}return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function _r(e){if(e instanceof on){if("get"===e.name&&1===e.args.length)return!1;if("feature-state"===e.name)return!1;if("has"===e.name&&1===e.args.length)return!1;if("properties"===e.name||"geometry-type"===e.name||"id"===e.name)return!1;if(/^filter-/.test(e.name))return!1}if(e instanceof Pn)return!1;if(e instanceof gr)return!1;if(e instanceof wr)return e.featureConstant;let t=!0;return e.eachChild((e=>{t&&!_r(e)&&(t=!1)})),t}function yr(e){if(e instanceof on&&"feature-state"===e.name)return!1;let t=!0;return e.eachChild((e=>{t&&!yr(e)&&(t=!1)})),t}function vr(e,t){if(e instanceof on&&t.indexOf(e.name)>=0)return!1;let i=!0;return e.eachChild((e=>{i&&!vr(e,t)&&(i=!1)})),i}function xr(e,t,i){return[e,t,i].filter(Boolean).join("")}function br(e,t){switch(e){case"string":return Gi(t);case"number":return+t;case"boolean":return!!t;case"color":return li.parse(t);case"formatted":return Fi.fromString(Gi(t));case"resolvedImage":return ki.build(Gi(t))}return t}function Tr(e,t,i,n){return void 0!==n&&(e=n*Math.round(e/n)),void 0!==t&&e<t&&(e=t),void 0!==i&&e>i&&(e=i),e}class wr{constructor(e,t,i,n=!1){this.type=e,this.key=t,this.scope=i,this.featureConstant=n}static parse(e,t){let i=t.expectedType;if(null==i&&(i=wi),e.length<2||e.length>3)return t.error("Invalid number of arguments for 'config' expression.");const n=t.parse(e[1],1);if(!(n instanceof ji))return t.error("Key name of 'config' expression must be a string literal.");let r,o=!0;const s=Gi(n.value);if(e.length>=3){const i=t.parse(e[2],2);if(!(i instanceof ji))return t.error("Scope of 'config' expression must be a string literal.");r=Gi(i.value)}if(t.options){const e=xr(s,r,t._scope),i=t.options.get(e);i&&(o=_r(i.value||i.default))}return new wr(i,s,r,o)}evaluate(e){const t=xr(this.key,this.scope,e.scope),i=e.getConfig(t);if(!i)return null;const{type:n,value:r,values:o,minValue:s,maxValue:a,stepValue:l}=i,c=i.default.evaluate(e);let u=c;if(r){const t=e.scope;e.scope=(t||"").split("").slice(1).join(""),u=r.evaluate(e),e.scope=t}return n&&(u=br(n,u)),void 0===u||void 0===s&&void 0===a&&void 0===l||("number"==typeof u?u=Tr(u,s,a,l):Array.isArray(u)&&(u=u.map((e=>"number"==typeof e?Tr(e,s,a,l):e)))),void 0!==r&&void 0!==u&&o&&!o.includes(u)&&(u=c,n&&(u=br(n,u))),(n&&n!==this.type||void 0!==u&&!Oi(Vi(u),this.type))&&(u=br(this.type.kind,u)),u}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Er{constructor(e,t){this.type=t.type,this.name=e,this.boundExpression=t}static parse(e,t){if(2!==e.length||"string"!=typeof e[1])return t.error("'var' expression requires exactly one string literal argument.");const i=e[1];return t.scope.has(i)?new Er(i,t.scope.get(i)):t.error(`Unknown variable "${i}". Make sure "${i}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Sr{constructor(e,t=[],i,n=new gi,r=[],o,s,a){this.registry=e,this.path=t,this.key=t.map((e=>"string"==typeof e?`['${e}']`:`[${e}]`)).join(""),this.scope=n,this.errors=r,this.expectedType=i,this._scope=o,this.options=s,this.iconImageUseTheme=a}parse(e,t,i,n,r={}){return t||i?this.concat(t,null,i,n)._parse(e,r):this._parse(e,r)}parseObjectValue(e,t,i,n,r,o={}){return this.concat(t,i,n,r)._parse(e,o)}_parse(e,t){function i(e,t,i){return"assert"===i?new Wi(t,[e]):"coerce"===i?new tn(t,[e]):e}if(null!==e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e||(e=["literal",e]),Array.isArray(e)){if(0===e.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const n="string"==typeof e[0]?this.registry[e[0]]:void 0;if(n){let r=n.parse(e,this);if(!r)return null;if(this.expectedType){const e=this.expectedType,n=r.type;if("string"!==e.kind&&"number"!==e.kind&&"boolean"!==e.kind&&"object"!==e.kind&&"array"!==e.kind||"value"!==n.kind)if("color"!==e.kind&&"formatted"!==e.kind&&"resolvedImage"!==e.kind||"value"!==n.kind&&"string"!==n.kind){if(this.checkSubtype(e,n))return null}else r=i(r,e,t.typeAnnotation||"coerce");else r=i(r,e,t.typeAnnotation||"assert")}if(!(r instanceof ji)&&"resolvedImage"!==r.type.kind&&Ar(r)){const t=new rn(this._scope,this.options,this.iconImageUseTheme);try{r=new ji(r.type,r.evaluate(t))}catch(e){return this.error(e.message),null}}return r}return tn.parse(["to-array",e],this)}return this.error(void 0===e?"'undefined' value invalid. Use null instead.":"object"==typeof e?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,t,i,n){let r="number"==typeof e?this.path.concat(e):this.path;r="string"==typeof t?r.concat(t):r;const o=n?this.scope.concat(n):this.scope;return new Sr(this.registry,r,i||null,o,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(e,...t){const i=`${this.key}${t.map((e=>`[${e}]`)).join("")}`;this.errors.push(new mi(i,e))}checkSubtype(e,t){const i=Pi(e,t);return i&&this.error(i),i}}function Ar(e){if(e instanceof Er)return Ar(e.boundExpression);if(e instanceof on&&"error"===e.name)return!1;if(e instanceof an)return!1;if(e instanceof Pn)return!1;if(e instanceof gr)return!1;if(e instanceof wr)return!1;const t=e instanceof tn||e instanceof Wi;let i=!0;return e.eachChild((e=>{i=t?i&&Ar(e):i&&e instanceof ji})),!!i&&_r(e)&&vr(e,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Mr(e,t){const i=e.length-1;let n,r,o=0,s=i,a=0;for(;o<=s;)if(a=Math.floor((o+s)/2),n=e[a],r=e[a+1],n<=t){if(a===i||t<r)return a;o=a+1}else{if(!(n>t))throw new Hi("Input is not a number.");s=a-1}return 0}class Ir{constructor(e,t,i){this.type=e,this.input=t,this.labels=[],this.outputs=[];for(const[e,t]of i)this.labels.push(e),this.outputs.push(t)}static parse(e,t){if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");const i=t.parse(e[1],1,yi);if(!i)return null;const n=[];let r=null;t.expectedType&&"value"!==t.expectedType.kind&&(r=t.expectedType);for(let i=1;i<e.length;i+=2){const o=1===i?-1/0:e[i],s=e[i+1],a=i,l=i+1;if("number"!=typeof o)return t.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',a);if(n.length&&n[n.length-1][0]>=o)return t.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',a);const c=t.parse(s,l,r);if(!c)return null;r=r||c.type,n.push([o,c])}return new Ir(r,i,n)}evaluate(e){const t=this.labels,i=this.outputs;if(1===t.length)return i[0].evaluate(e);const n=this.input.evaluate(e);if(n<=t[0])return i[0].evaluate(e);const r=t.length;return n>=t[r-1]?i[r-1].evaluate(e):i[Mr(t,n)].evaluate(e)}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){const e=["step",this.input.serialize()];for(let t=0;t<this.labels.length;t++)t>0&&e.push(this.labels[t]),e.push(this.outputs[t].serialize());return e}}const Cr=.95047,Pr=1.08883,Lr=4/29,Rr=6/29,Or=3*Rr*Rr,Dr=Rr*Rr*Rr,Br=Math.PI/180,Fr=180/Math.PI;function Nr(e){return e>Dr?Math.pow(e,1/3):e/Or+Lr}function kr(e){return e>Rr?e*e*e:Or*(e-Lr)}function Ur(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function zr(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function Vr(e){const t=zr(e.r),i=zr(e.g),n=zr(e.b),r=Nr((.4124564*t+.3575761*i+.1804375*n)/Cr),o=Nr((.2126729*t+.7151522*i+.072175*n)/1);return{l:116*o-16,a:500*(r-o),b:200*(o-Nr((.0193339*t+.119192*i+.9503041*n)/Pr)),alpha:e.a}}function Gr(e){let t=(e.l+16)/116,i=isNaN(e.a)?t:t+e.a/500,n=isNaN(e.b)?t:t-e.b/200;return t=1*kr(t),i=Cr*kr(i),n=Pr*kr(n),new li(Ur(3.2404542*i-1.5371385*t-.4985314*n),Ur(-.969266*i+1.8760108*t+.041556*n),Ur(.0556434*i-.2040259*t+1.0572252*n),e.alpha)}function jr(e,t,i){const n=t-e;return e+i*(n>180||n<-180?n-360*Math.round(n/360):n)}const Hr={forward:Vr,reverse:Gr,interpolate:function(e,t,i){return{l:di(e.l,t.l,i),a:di(e.a,t.a,i),b:di(e.b,t.b,i),alpha:di(e.alpha,t.alpha,i)}}},$r={forward:function(e){const{l:t,a:i,b:n}=Vr(e),r=Math.atan2(n,i)*Fr;return{h:r<0?r+360:r,c:Math.sqrt(i*i+n*n),l:t,alpha:e.a}},reverse:function(e){const t=e.h*Br,i=e.c;return Gr({l:e.l,a:Math.cos(t)*i,b:Math.sin(t)*i,alpha:e.alpha})},interpolate:function(e,t,i){return{h:jr(e.h,t.h,i),c:di(e.c,t.c,i),l:di(e.l,t.l,i),alpha:di(e.alpha,t.alpha,i)}}};var Wr=Object.freeze({__proto__:null,hcl:$r,lab:Hr});class qr{constructor(e,t,i,n,r){this.type=e,this.operator=t,this.interpolation=i,this.input=n,this.labels=[],this.outputs=[];for(const[e,t]of r)this.labels.push(e),this.outputs.push(t)}static interpolationFactor(e,t,i,n){let r=0;if("exponential"===e.name)r=Xr(t,e.base,i,n);else if("linear"===e.name)r=Xr(t,1,i,n);else if("cubic-bezier"===e.name){const o=e.controlPoints;r=new we(o[0],o[1],o[2],o[3]).solve(Xr(t,1,i,n))}return r}static parse(e,t){let[i,n,r,...o]=e;if(!Array.isArray(n)||0===n.length)return t.error("Expected an interpolation type expression.",1);if("linear"===n[0])n={name:"linear"};else if("exponential"===n[0]){const e=n[1];if("number"!=typeof e)return t.error("Exponential interpolation requires a numeric base.",1,1);n={name:"exponential",base:e}}else{if("cubic-bezier"!==n[0])return t.error(`Unknown interpolation type ${String(n[0])}`,1,0);{const e=n.slice(1);if(4!==e.length||e.some((e=>"number"!=typeof e||e<0||e>1)))return t.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);n={name:"cubic-bezier",controlPoints:e}}}if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return t.error("Expected an even number of arguments.");if(r=t.parse(r,2,yi),!r)return null;const s=[];let a=null;"interpolate-hcl"===i||"interpolate-lab"===i?a=bi:t.expectedType&&"value"!==t.expectedType.kind&&(a=t.expectedType);for(let e=0;e<o.length;e+=2){const i=o[e],n=o[e+1],r=e+3,l=e+4;if("number"!=typeof i)return t.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',r);if(s.length&&s[s.length-1][0]>=i)return t.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',r);const c=t.parse(n,l,a);if(!c)return null;a=a||c.type,s.push([i,c])}return"number"===a.kind||"color"===a.kind||"array"===a.kind&&"number"===a.itemType.kind&&"number"==typeof a.N?new qr(a,i,n,r,s):t.error(`Type ${Ii(a)} is not interpolatable.`)}evaluate(e){const t=this.labels,i=this.outputs;if(1===t.length)return i[0].evaluate(e);const n=this.input.evaluate(e);if(n<=t[0])return i[0].evaluate(e);const r=t.length;if(n>=t[r-1])return i[r-1].evaluate(e);const o=Mr(t,n),s=qr.interpolationFactor(this.interpolation,n,t[o],t[o+1]),a=i[o].evaluate(e),l=i[o+1].evaluate(e);return"interpolate"===this.operator?fi[this.type.kind.toLowerCase()](a,l,s):"interpolate-hcl"===this.operator?$r.reverse($r.interpolate($r.forward(a),$r.forward(l),s)):Hr.reverse(Hr.interpolate(Hr.forward(a),Hr.forward(l),s))}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){let e;e="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const t=[this.operator,e,this.input.serialize()];for(let e=0;e<this.labels.length;e++)t.push(this.labels[e],this.outputs[e].serialize());return t}}function Xr(e,t,i,n){const r=n-i,o=e-i;return 0===r?0:1===t?o/r:(Math.pow(t,o)-1)/(Math.pow(t,r)-1)}class Yr{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expectected at least one argument.");let i=null;const n=t.expectedType;n&&"value"!==n.kind&&(i=n);const r=[];for(const n of e.slice(1)){const e=t.parse(n,1+r.length,i,void 0,{typeAnnotation:"omit"});if(!e)return null;i=i||e.type,r.push(e)}const o=n&&r.some((e=>Pi(n,e.type)));return new Yr(o?wi:i,r)}evaluate(e){let t,i=null,n=0;for(const r of this.args){if(n++,i=r.evaluate(e),i&&i instanceof ki&&!i.available&&(t||(t=i),i=null,n===this.args.length))return t;if(null!==i)break}return i}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=["coalesce"];return this.eachChild((t=>{e.push(t.serialize())})),e}}class Zr{constructor(e,t){this.type=t.type,this.bindings=[].concat(e),this.result=t}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const t of this.bindings)e(t[1]);e(this.result)}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const i=[];for(let n=1;n<e.length-1;n+=2){const r=e[n];if("string"!=typeof r)return t.error(`Expected string, but found ${typeof r} instead.`,n);if(/[^a-zA-Z0-9_]/.test(r))return t.error("Variable names must contain only alphanumeric characters or '_'.",n);const o=t.parse(e[n+1],n+1);if(!o)return null;i.push([r,o])}const n=t.parse(e[e.length-1],e.length-1,t.expectedType,i);return n?new Zr(i,n):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[t,i]of this.bindings)e.push(t,i.serialize());return e.push(this.result.serialize()),e}}class Jr{constructor(e,t,i){this.type=e,this.index=t,this.input=i}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,yi),n=t.parse(e[2],2,Mi(t.expectedType||wi));return i&&n?new Jr(n.type.itemType,i,n):null}evaluate(e){const t=this.index.evaluate(e),i=this.input.evaluate(e);if(t<0)throw new Hi("Array index out of bounds: negative index");if(t>=i.length)throw new Hi("Array index out of bounds: index exceeds array size");if(t!==Math.floor(t))throw new Hi("Array index must be an integer. Use at-interpolated for fractional indices");return i[t]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Kr{constructor(e,t,i){this.type=e,this.index=t,this.input=i}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,yi),n=t.parse(e[2],2,Mi(t.expectedType||wi));return i&&n?new Kr(n.type.itemType,i,n):null}evaluate(e){const t=this.index.evaluate(e),i=this.input.evaluate(e);if(t<0)throw new Hi(`Array index out of bounds: ${t} < 0.`);if(t>i.length-1)throw new Hi(`Array index out of bounds: ${t} > ${i.length-1}.`);if(t===Math.floor(t))return i[t];const n=Math.floor(t),r=Math.ceil(t),o=i[n],s=i[r];if("number"!=typeof o||"number"!=typeof s)throw new Hi(`Cannot interpolate between non-number values at index ${t}.`);const a=t-n;return o*(1-a)+s*a}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class Qr{constructor(e,t){this.type=xi,this.needle=e,this.haystack=t}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,wi),n=t.parse(e[2],2,wi);return i&&n?Li(i.type,[xi,vi,yi,_i,wi])?new Qr(i,n):t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ii(i.type)} instead`):null}evaluate(e){const t=this.needle.evaluate(e),i=this.haystack.evaluate(e);if(null==i)return!1;if(!Ri(t,["boolean","string","number","null"]))throw new Hi(`Expected first argument to be of type boolean, string, number or null, but found ${Ii(Vi(t))} instead.`);if(!Ri(i,["string","array"]))throw new Hi(`Expected second argument to be of type array or string, but found ${Ii(Vi(i))} instead.`);return i.indexOf(t)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class eo{constructor(e,t,i){this.type=yi,this.needle=e,this.haystack=t,this.fromIndex=i}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,wi),n=t.parse(e[2],2,wi);if(!i||!n)return null;if(!Li(i.type,[xi,vi,yi,_i,wi]))return t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ii(i.type)} instead`);if(4===e.length){const r=t.parse(e[3],3,yi);return r?new eo(i,n,r):null}return new eo(i,n)}evaluate(e){const t=this.needle.evaluate(e),i=this.haystack.evaluate(e);if(!Ri(t,["boolean","string","number","null"]))throw new Hi(`Expected first argument to be of type boolean, string, number or null, but found ${Ii(Vi(t))} instead.`);if(!Ri(i,["string","array"]))throw new Hi(`Expected second argument to be of type array or string, but found ${Ii(Vi(i))} instead.`);if(this.fromIndex){const n=this.fromIndex.evaluate(e);return i.indexOf(t,n)}return i.indexOf(t)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class to{constructor(e,t,i,n,r,o){this.inputType=e,this.type=t,this.input=i,this.cases=n,this.outputs=r,this.otherwise=o}static parse(e,t){if(e.length<5)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return t.error("Expected an even number of arguments.");let i,n;t.expectedType&&"value"!==t.expectedType.kind&&(n=t.expectedType);const r={},o=[];for(let s=2;s<e.length-1;s+=2){let a=e[s];const l=e[s+1];Array.isArray(a)||(a=[a]);const c=t.concat(s);if(0===a.length)return c.error("Expected at least one branch label.");for(const e of a){if("number"!=typeof e&&"string"!=typeof e)return c.error("Branch labels must be numbers or strings.");if("number"==typeof e&&Math.abs(e)>Number.MAX_SAFE_INTEGER)return c.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof e&&Math.floor(e)!==e)return c.error("Numeric branch labels must be integer values.");if(i){if(c.checkSubtype(i,Vi(e)))return null}else i=Vi(e);if(void 0!==r[String(e)])return c.error("Branch labels must be unique.");r[String(e)]=o.length}const u=t.parse(l,s,n);if(!u)return null;n=n||u.type,o.push(u)}const s=t.parse(e[1],1,wi);if(!s)return null;const a=t.parse(e[e.length-1],e.length-1,n);return a?"value"!==s.type.kind&&t.concat(1).checkSubtype(i,s.type)?null:new to(i,n,s,r,o,a):null}evaluate(e){const t=this.input.evaluate(e);return(Oi(Vi(t),this.inputType)&&this.outputs[this.cases[t]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],t=Object.keys(this.cases).sort(),i=[],n={};for(const e of t){const t=n[this.cases[e]];void 0===t?(n[this.cases[e]]=i.length,i.push([this.cases[e],[e]])):i[t][1].push(e)}const r=e=>"number"===this.inputType.kind?Number(e):e;for(const[t,n]of i)e.push(1===n.length?r(n[0]):n.map(r)),e.push(this.outputs[t].serialize());return e.push(this.otherwise.serialize()),e}}class io{constructor(e,t,i){this.type=e,this.branches=t,this.otherwise=i}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return t.error("Expected an odd number of arguments.");let i;t.expectedType&&"value"!==t.expectedType.kind&&(i=t.expectedType);const n=[];for(let r=1;r<e.length-1;r+=2){const o=t.parse(e[r],r,xi);if(!o)return null;const s=t.parse(e[r+1],r+1,i);if(!s)return null;n.push([o,s]),i=i||s.type}const r=t.parse(e[e.length-1],e.length-1,i);return r?new io(i,n,r):null}evaluate(e){for(const[t,i]of this.branches)if(t.evaluate(e))return i.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[t,i]of this.branches)e(t),e(i);e(this.otherwise)}outputDefined(){return this.branches.every((([e,t])=>t.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild((t=>{e.push(t.serialize())})),e}}class no{constructor(e,t,i,n){this.type=e,this.input=t,this.beginIndex=i,this.endIndex=n}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,wi),n=t.parse(e[2],2,yi);if(!i||!n)return null;if(!Li(i.type,[Mi(wi),vi,wi]))return t.error(`Expected first argument to be of type array or string, but found ${Ii(i.type)} instead`);if(4===e.length){const r=t.parse(e[3],3,yi);return r?new no(i.type,i,n,r):null}return new no(i.type,i,n)}evaluate(e){const t=this.input.evaluate(e),i=this.beginIndex.evaluate(e);if(!Ri(t,["string","array"]))throw new Hi(`Expected first argument to be of type array or string, but found ${Ii(Vi(t))} instead.`);if(this.endIndex){const n=this.endIndex.evaluate(e);return t.slice(i,n)}return t.slice(i)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class ro{constructor(e,t){this.type=Mi(vi),this.str=e,this.delimiter=t}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,vi),n=t.parse(e[2],2,vi);return i&&n?new ro(i,n):void 0}evaluate(e){const t=this.str.evaluate(e),i=this.delimiter.evaluate(e);return t.split(i)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function oo(e,t){return"=="===e||"!="===e?"boolean"===t.kind||"string"===t.kind||"number"===t.kind||"null"===t.kind||"value"===t.kind:"string"===t.kind||"number"===t.kind||"value"===t.kind}function so(e,t,i,n){return 0===n.compare(t,i)}function ao(e,t,i){const n="=="!==e&&"!="!==e;return class r{constructor(e,t,i){this.type=xi,this.lhs=e,this.rhs=t,this.collator=i,this.hasUntypedArgument="value"===e.type.kind||"value"===t.type.kind}static parse(e,t){if(3!==e.length&&4!==e.length)return t.error("Expected two or three arguments.");const i=e[0];let o=t.parse(e[1],1,wi);if(!o)return null;if(!oo(i,o.type))return t.concat(1).error(`"${i}" comparisons are not supported for type '${Ii(o.type)}'.`);let s=t.parse(e[2],2,wi);if(!s)return null;if(!oo(i,s.type))return t.concat(2).error(`"${i}" comparisons are not supported for type '${Ii(s.type)}'.`);if(o.type.kind!==s.type.kind&&"value"!==o.type.kind&&"value"!==s.type.kind)return t.error(`Cannot compare types '${Ii(o.type)}' and '${Ii(s.type)}'.`);n&&("value"===o.type.kind&&"value"!==s.type.kind?o=new Wi(s.type,[o]):"value"!==o.type.kind&&"value"===s.type.kind&&(s=new Wi(o.type,[s])));let a=null;if(4===e.length){if("string"!==o.type.kind&&"string"!==s.type.kind&&"value"!==o.type.kind&&"value"!==s.type.kind)return t.error("Cannot use collator to compare non-string types.");if(a=t.parse(e[3],3,Ei),!a)return null}return new r(o,s,a)}evaluate(r){const o=this.lhs.evaluate(r),s=this.rhs.evaluate(r);if(n&&this.hasUntypedArgument){const t=Vi(o),i=Vi(s);if(t.kind!==i.kind||"string"!==t.kind&&"number"!==t.kind)throw new Hi(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${t.kind}, ${i.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const e=Vi(o),i=Vi(s);if("string"!==e.kind||"string"!==i.kind)return t(r,o,s)}return this.collator?i(r,o,s,this.collator.evaluate(r)):t(r,o,s)}eachChild(e){e(this.lhs),e(this.rhs),this.collator&&e(this.collator)}outputDefined(){return!0}serialize(){const t=[e];return this.eachChild((e=>{t.push(e.serialize())})),t}}}const lo=ao("==",(function(e,t,i){return t===i}),so),co=ao("!=",(function(e,t,i){return t!==i}),(function(e,t,i,n){return!so(0,t,i,n)})),uo=ao("<",(function(e,t,i){return t<i}),(function(e,t,i,n){return n.compare(t,i)<0})),ho=ao(">",(function(e,t,i){return t>i}),(function(e,t,i,n){return n.compare(t,i)>0})),po=ao("<=",(function(e,t,i){return t<=i}),(function(e,t,i,n){return n.compare(t,i)<=0})),fo=ao(">=",(function(e,t,i){return t>=i}),(function(e,t,i,n){return n.compare(t,i)>=0}));class mo{constructor(e,t,i,n,r,o){this.type=vi,this.number=e,this.locale=t,this.currency=i,this.unit=n,this.minFractionDigits=r,this.maxFractionDigits=o}static parse(e,t){if(3!==e.length)return t.error("Expected two arguments.");const i=t.parse(e[1],1,yi);if(!i)return null;const n=e[2];if("object"!=typeof n||Array.isArray(n))return t.error("NumberFormat options argument must be an object.");let r=null;if(n.locale&&(r=t.parseObjectValue(n.locale,2,"locale",vi),!r))return null;let o=null;if(n.currency&&(o=t.parseObjectValue(n.currency,2,"currency",vi),!o))return null;let s=null;if(n.unit&&(s=t.parseObjectValue(n.unit,2,"unit",vi),!s))return null;let a=null;if(n["min-fraction-digits"]&&(a=t.parseObjectValue(n["min-fraction-digits"],2,"min-fraction-digits",yi),!a))return null;let l=null;return n["max-fraction-digits"]&&(l=t.parseObjectValue(n["max-fraction-digits"],2,"max-fraction-digits",yi),!l)?null:new mo(i,r,o,s,a,l)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class go{constructor(e){this.type=yi,this.input=e}static parse(e,t){if(2!==e.length)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const i=t.parse(e[1],1);return i?"array"!==i.type.kind&&"string"!==i.type.kind&&"value"!==i.type.kind?t.error(`Expected argument of type string or array, but found ${Ii(i.type)} instead.`):new go(i):null}evaluate(e){const t=this.input.evaluate(e);if("string"==typeof t)return t.length;if(Array.isArray(t))return t.length;throw new Hi(`Expected value to be of type string or array, but found ${Ii(Vi(t))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild((t=>{e.push(t.serialize())})),e}}function _o(e){return function(){e=1831565813+(e|=0)|0;let t=Math.imul(e^e>>>15,1|e);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}const yo={"==":lo,"!=":co,">":ho,"<":uo,">=":fo,"<=":po,array:Wi,at:Jr,"at-interpolated":Kr,boolean:Wi,case:io,coalesce:Yr,collator:an,format:qi,image:Xi,in:Qr,"index-of":eo,interpolate:qr,"interpolate-hcl":qr,"interpolate-lab":qr,length:go,let:Zr,literal:ji,match:to,number:Wi,"number-format":mo,object:Wi,slice:no,step:Ir,string:Wi,"to-boolean":tn,"to-color":tn,"to-number":tn,"to-string":tn,var:Er,within:Pn,distance:gr,config:wr,split:ro};function vo(e,[t,i,n,r]){t=t.evaluate(e),i=i.evaluate(e),n=n.evaluate(e);const o=r?r.evaluate(e):1,s=Ui(t,i,n,o);if(s)throw new Hi(s);return new li(t/255,i/255,n/255,o)}function xo(e,[t,i,n,r]){t=t.evaluate(e),i=i.evaluate(e),n=n.evaluate(e);const o=r?r.evaluate(e):1,s=function(e,t,i,n){return"number"==typeof e&&e>=0&&e<=360?"number"==typeof t&&t>=0&&t<=100&&"number"==typeof i&&i>=0&&i<=100?void 0===n||"number"==typeof n&&n>=0&&n<=1?null:`Invalid hsla value [${[e,t,i,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof n?[e,t,i,n]:[e,t,i]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof n?[e,t,i,n]:[e,t,i]).join(", ")}]: 'h' must be between 0 and 360.`}(t,i,n,o);if(s)throw new Hi(s);const a=`hsla(${t}, ${i}%, ${n}%, ${o})`,l=li.parse(a);if(!l)throw new Hi(`Failed to parse HSLA color: ${a}`);return l}function bo(e,t){return e in t}function To(e,t){const i=t[e];return void 0===i?null:i}function wo(e){return{type:e}}function Eo(e){if(e instanceof wr)return new Set([e.key]);let t=new Set;return e.eachChild((e=>{t=new Set([...t,...Eo(e)])})),t}function So(e){if(e instanceof on&&"is-active-floor"===e.name)return!0;let t=!1;return e.eachChild((e=>{!t&&So(e)&&(t=!0)})),t}function Ao(e){return{result:"success",value:e}}function Mo(e){return{result:"error",value:e}}function Io(e,t){return!!e&&!!e.parameters&&e.parameters.indexOf(t)>-1}function Co(e){return"data-driven"===e["property-type"]}function Po(e){return Io(e.expression,"measure-light")}function Lo(e){return Io(e.expression,"zoom")}function Ro(e){return!!e.expression&&e.expression.interpolated}function Oo(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function Do(e){return e}function Bo(e,t){const i="color"===t.type,n=e.stops&&"object"==typeof e.stops[0][0],r=n||!(n||void 0!==e.property),o=e.type||(Ro(t)?"exponential":"interval");if(i&&((e=Object.assign({},e)).stops&&(e.stops=e.stops.map((e=>[e[0],li.parse(e[1])]))),e.default=li.parse(e.default?e.default:t.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!Wr[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let s,a,l;if("exponential"===o)s=Uo;else if("interval"===o)s=ko;else if("categorical"===o){s=No,a=Object.create(null);for(const t of e.stops)a[t[0]]=t[1];l=typeof e.stops[0][0]}else{if("identity"!==o)throw new Error(`Unknown function type "${o}"`);s=zo}if(n){const i={},n=[];for(let t=0;t<e.stops.length;t++){const r=e.stops[t],o=r[0].zoom;void 0===i[o]&&(i[o]={zoom:o,type:e.type,property:e.property,default:e.default,stops:[]},n.push(o)),i[o].stops.push([r[0].value,r[1]])}const r=[];for(const e of n)r.push([i[e].zoom,Bo(i[e],t)]);const o={name:"linear"};return{kind:"composite",interpolationType:o,interpolationFactor:qr.interpolationFactor.bind(void 0,o),zoomStops:r.map((e=>e[0])),evaluate:({zoom:i},n)=>Uo({stops:r,base:e.base},t,i).evaluate(i,n)}}if(r){const i="exponential"===o?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return{kind:"camera",interpolationType:i,interpolationFactor:qr.interpolationFactor.bind(void 0,i),zoomStops:e.stops.map((e=>e[0])),evaluate:({zoom:i})=>s(e,t,i,a,l)}}return{kind:"source",evaluate(i,n){const r=n&&n.properties?n.properties[e.property]:void 0;return void 0===r?Fo(e.default,t.default):s(e,t,r,a,l)}}}function Fo(e,t,i){return void 0!==e?e:void 0!==t?t:void 0!==i?i:void 0}function No(e,t,i,n,r){return Fo(typeof i===r?n[i]:void 0,e.default,t.default)}function ko(e,t,i){if(!Ki(i))return Fo(e.default,t.default);const n=e.stops.length;if(1===n)return e.stops[0][1];if(i<=e.stops[0][0])return e.stops[0][1];if(i>=e.stops[n-1][0])return e.stops[n-1][1];const r=Mr(e.stops.map((e=>e[0])),i);return e.stops[r][1]}function Uo(e,t,i){const n=void 0!==e.base?e.base:1;if(!Ki(i))return Fo(e.default,t.default);const r=e.stops.length;if(1===r)return e.stops[0][1];if(i<=e.stops[0][0])return e.stops[0][1];if(i>=e.stops[r-1][0])return e.stops[r-1][1];const o=Mr(e.stops.map((e=>e[0])),i),s=function(e,t,i,n){const r=n-i,o=e-i;return 0===r?0:1===t?o/r:(Math.pow(t,o)-1)/(Math.pow(t,r)-1)}(i,n,e.stops[o][0],e.stops[o+1][0]),a=e.stops[o][1],l=e.stops[o+1][1];let c=fi[t.type]||Do;if(e.colorSpace&&"rgb"!==e.colorSpace){const t=Wr[e.colorSpace];c=(e,i)=>t.reverse(t.interpolate(t.forward(e),t.forward(i),s))}return"function"==typeof a.evaluate?{evaluate(...e){const t=a.evaluate.apply(void 0,e),i=l.evaluate.apply(void 0,e);if(void 0!==t&&void 0!==i)return c(t,i,s)}}:c(a,l,s)}function zo(e,t,i){return"color"===t.type?i=li.parse(i):"formatted"===t.type?i=Fi.fromString(i.toString()):"resolvedImage"===t.type?i=ki.build(i.toString()):Yi(i)===t.type||"enum"===t.type&&t.values[i]||(i=void 0),Fo(i,e.default,t.default)}on.register(yo,{error:[{kind:"error"},[vi],(e,[t])=>{throw new Hi(t.evaluate(e))}],typeof:[vi,[wi],(e,[t])=>Ii(Vi(t.evaluate(e)))],"to-rgba":[Mi(yi,4),[bi],(e,[t])=>t.evaluate(e).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Mi(yi,4),[bi],(e,[t])=>t.evaluate(e).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[bi,[yi,yi,yi],vo],rgba:[bi,[yi,yi,yi,yi],vo],hsl:[bi,[yi,yi,yi],xo],hsla:[bi,[yi,yi,yi,yi],xo],has:{type:xi,overloads:[[[vi],(e,[t])=>bo(t.evaluate(e),e.properties())],[[vi,Ti],(e,[t,i])=>bo(t.evaluate(e),i.evaluate(e))]]},get:{type:wi,overloads:[[[vi],(e,[t])=>To(t.evaluate(e),e.properties())],[[vi,Ti],(e,[t,i])=>To(t.evaluate(e),i.evaluate(e))]]},"feature-state":[wi,[vi],(e,[t])=>To(t.evaluate(e),e.featureState||{})],properties:[Ti,[],e=>e.properties()],"geometry-type":[vi,[],e=>e.geometryType()],worldview:[vi,[],e=>e.globals.worldview||""],"is-active-floor":[xi,wo(vi),(e,t)=>{if(!(e.globals.activeFloors&&e.globals.activeFloors.size>0))return!1;const i=e.globals.activeFloors;return t.some((t=>{const n=t.evaluate(e);return i.has(n)}))}],id:[wi,[],e=>e.id()],zoom:[yi,[],e=>e.globals.zoom],pitch:[yi,[],e=>e.globals.pitch||0],"distance-from-center":[yi,[],e=>e.distanceFromCenter()],"measure-light":[yi,[vi],(e,[t])=>e.measureLight(t.evaluate(e))],"heatmap-density":[yi,[],e=>e.globals.heatmapDensity||0],"line-progress":[yi,[],e=>e.globals.lineProgress||0],"raster-value":[yi,[],e=>e.globals.rasterValue||0],"raster-particle-speed":[yi,[],e=>e.globals.rasterParticleSpeed||0],"sky-radial-progress":[yi,[],e=>e.globals.skyRadialProgress||0],accumulated:[wi,[],e=>void 0===e.globals.accumulated?null:e.globals.accumulated],"+":[yi,wo(yi),(e,t)=>{let i=0;for(const n of t)i+=n.evaluate(e);return i}],"*":[yi,wo(yi),(e,t)=>{let i=1;for(const n of t)i*=n.evaluate(e);return i}],"-":{type:yi,overloads:[[[yi,yi],(e,[t,i])=>t.evaluate(e)-i.evaluate(e)],[[yi],(e,[t])=>-t.evaluate(e)]]},"/":[yi,[yi,yi],(e,[t,i])=>t.evaluate(e)/i.evaluate(e)],"%":[yi,[yi,yi],(e,[t,i])=>t.evaluate(e)%i.evaluate(e)],ln2:[yi,[],()=>Math.LN2],pi:[yi,[],()=>Math.PI],e:[yi,[],()=>Math.E],"^":[yi,[yi,yi],(e,[t,i])=>Math.pow(t.evaluate(e),i.evaluate(e))],sqrt:[yi,[yi],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[yi,[yi],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[yi,[yi],(e,[t])=>Math.log(t.evaluate(e))],log2:[yi,[yi],(e,[t])=>Math.log2(t.evaluate(e))],sin:[yi,[yi],(e,[t])=>Math.sin(t.evaluate(e))],cos:[yi,[yi],(e,[t])=>Math.cos(t.evaluate(e))],tan:[yi,[yi],(e,[t])=>Math.tan(t.evaluate(e))],asin:[yi,[yi],(e,[t])=>Math.asin(t.evaluate(e))],acos:[yi,[yi],(e,[t])=>Math.acos(t.evaluate(e))],atan:[yi,[yi],(e,[t])=>Math.atan(t.evaluate(e))],min:[yi,wo(yi),(e,t)=>Math.min(...t.map((t=>t.evaluate(e))))],max:[yi,wo(yi),(e,t)=>Math.max(...t.map((t=>t.evaluate(e))))],abs:[yi,[yi],(e,[t])=>Math.abs(t.evaluate(e))],round:[yi,[yi],(e,[t])=>{const i=t.evaluate(e);return i<0?-Math.round(-i):Math.round(i)}],floor:[yi,[yi],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[yi,[yi],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[xi,[vi,wi],(e,[t,i])=>e.properties()[t.value]===i.value],"filter-id-==":[xi,[wi],(e,[t])=>e.id()===t.value],"filter-type-==":[xi,[vi],(e,[t])=>e.geometryType()===t.value],"filter-<":[xi,[vi,wi],(e,[t,i])=>{const n=e.properties()[t.value],r=i.value;return typeof n==typeof r&&n<r}],"filter-id-<":[xi,[wi],(e,[t])=>{const i=e.id(),n=t.value;return typeof i==typeof n&&i<n}],"filter->":[xi,[vi,wi],(e,[t,i])=>{const n=e.properties()[t.value],r=i.value;return typeof n==typeof r&&n>r}],"filter-id->":[xi,[wi],(e,[t])=>{const i=e.id(),n=t.value;return typeof i==typeof n&&i>n}],"filter-<=":[xi,[vi,wi],(e,[t,i])=>{const n=e.properties()[t.value],r=i.value;return typeof n==typeof r&&n<=r}],"filter-id-<=":[xi,[wi],(e,[t])=>{const i=e.id(),n=t.value;return typeof i==typeof n&&i<=n}],"filter->=":[xi,[vi,wi],(e,[t,i])=>{const n=e.properties()[t.value],r=i.value;return typeof n==typeof r&&n>=r}],"filter-id->=":[xi,[wi],(e,[t])=>{const i=e.id(),n=t.value;return typeof i==typeof n&&i>=n}],"filter-has":[xi,[wi],(e,[t])=>t.value in e.properties()],"filter-has-id":[xi,[],e=>null!==e.id()&&void 0!==e.id()],"filter-type-in":[xi,[Mi(vi)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[xi,[Mi(wi)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[xi,[vi,Mi(wi)],(e,[t,i])=>i.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[xi,[vi,Mi(wi)],(e,[t,i])=>function(e,t,i,n){for(;i<=n;){const r=i+n>>1;if(t[r]===e)return!0;t[r]>e?n=r-1:i=r+1}return!1}(e.properties()[t.value],i.value,0,i.value.length-1)],all:{type:xi,overloads:[[[xi,xi],(e,[t,i])=>t.evaluate(e)&&i.evaluate(e)],[wo(xi),(e,t)=>{for(const i of t)if(!i.evaluate(e))return!1;return!0}]]},any:{type:xi,overloads:[[[xi,xi],(e,[t,i])=>t.evaluate(e)||i.evaluate(e)],[wo(xi),(e,t)=>{for(const i of t)if(i.evaluate(e))return!0;return!1}]]},"!":[xi,[xi],(e,[t])=>!t.evaluate(e)],"is-supported-script":[xi,[vi],(e,[t])=>{const i=e.globals&&e.globals.isSupportedScript;return!i||i(t.evaluate(e))}],upcase:[vi,[vi],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[vi,[vi],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[vi,wo(wi),(e,t)=>t.map((t=>Gi(t.evaluate(e)))).join("")],"resolved-locale":[vi,[Ei],(e,[t])=>t.evaluate(e).resolvedLocale()],random:[yi,[yi,yi,wi],(e,t)=>{const[i,n,r]=t.map((t=>t.evaluate(e)));if(i>n)return i;if(i===n)return i;let o;if("string"==typeof r)o=function(e){let t=0;if(0===e.length)return t;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}(r);else{if("number"!=typeof r)throw new Hi(`Invalid seed input: ${r}`);o=r}return i+_o(o)()*(n-i)}]});class Vo{constructor(e,t,i,n,r){this.expression=e,this._warningHistory={},this._scope=i,this._options=n,this._iconImageUseTheme=r,this._evaluator=new rn(i,n,r),this._defaultValue=t?function(e){return"color"===e.type&&(Oo(e.default)||Array.isArray(e.default))?new li(0,0,0,0):"color"===e.type?li.parse(e.default)||null:void 0===e.default?null:e.default}(t):null,this._enumValues=t&&"enum"===t.type?t.values:null,this.configDependencies=Eo(e),this.isIndoorDependent=So(e)}evaluateWithoutErrorHandling(e,t,i,n,r,o,s,a){return this._evaluator.globals=e,this._evaluator.feature=t,this._evaluator.featureState=i,this._evaluator.canonical=n||null,this._evaluator.availableImages=r||null,this._evaluator.formattedSection=o,this._evaluator.featureTileCoord=s||null,this._evaluator.featureDistanceData=a||null,this.expression.evaluate(this._evaluator)}evaluate(e,t,i,n,r,o,s,a,l){this._evaluator||(this._evaluator=new rn(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=e,this._evaluator.feature=t||null,this._evaluator.featureState=i||null,this._evaluator.canonical=n||null,this._evaluator.availableImages=r||null,this._evaluator.formattedSection=o||null,this._evaluator.featureTileCoord=s||null,this._evaluator.featureDistanceData=a||null,this._evaluator.iconImageUseTheme=l||null;try{const e=this.expression.evaluate(this._evaluator);if(null==e||"number"==typeof e&&e!=e)return this._defaultValue;if(this._enumValues&&!(e in this._enumValues))throw new Hi(`Expected value to be one of ${Object.keys(this._enumValues).map((e=>JSON.stringify(e))).join(", ")}, but found ${JSON.stringify(e)} instead.`);return e}catch(e){return this._warningHistory[e.message]||(this._warningHistory[e.message]=!0),this._defaultValue}}}function Go(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]&&e[0]in yo}function jo(e,t,i,n,r){const o=new Sr(yo,[],t?function(e){const t={color:bi,string:vi,number:yi,enum:vi,boolean:xi,formatted:Si,resolvedImage:Ai};return"array"===e.type?Mi(t[e.value]||wi,e.length):t[e.type]}(t):void 0,void 0,void 0,i,n,r),s=o.parse(e,void 0,void 0,void 0,t&&"string"===t.type?{typeAnnotation:"coerce"}:void 0);return s?Ao(new Vo(s,t,i,n,r)):Mo(o.errors)}class Ho{constructor(e,t,i,n){this.kind=e,this._styleExpression=t,this.isLightConstant=i,this.isLineProgressConstant=n,this.isStateDependent="constant"!==e&&!yr(t.expression),this.configDependencies=Eo(t.expression),this.isIndoorDependent=So(t.expression)}evaluateWithoutErrorHandling(e,t,i,n,r,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,i,n,r,o)}evaluate(e,t,i,n,r,o,s){return this._styleExpression.evaluate(e,t,i,n,r,o,void 0,void 0,s)}}class $o{constructor(e,t,i,n,r,o){this.kind=e,this.zoomStops=i,this._styleExpression=t,this.isStateDependent="camera"!==e&&!yr(t.expression),this.isIndoorDependent=So(t.expression),this.isLightConstant=r,this.isLineProgressConstant=o,this.configDependencies=Eo(t.expression),this.interpolationType=n}evaluateWithoutErrorHandling(e,t,i,n,r,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,i,n,r,o)}evaluate(e,t,i,n,r,o){return this._styleExpression.evaluate(e,t,i,n,r,o)}interpolationFactor(e,t,i){return this.interpolationType?qr.interpolationFactor(this.interpolationType,e,t,i):0}}function Wo(e,t,i,n,r){if("error"===(e=jo(e,t,i,n,r)).result)return e;const o=e.value.expression,s=_r(o);if(!s&&!Co(t))return Mo([new mi("","data expressions not supported")]);const a=vr(o,["zoom","pitch","distance-from-center"]);if(!a&&!Lo(t))return Mo([new mi("","zoom expressions not supported")]);const l=vr(o,["measure-light"]);if(!l&&!Po(t))return Mo([new mi("","measure-light expression not supported")]);const c=vr(o,["line-progress"]);if(!c&&!function(e){return Io(e.expression,"line-progress")}(t))return Mo([new mi("","line-progress expression not supported")]);const u=t.expression&&t.expression.relaxZoomRestriction,h=Xo(o);return h||a||u?h instanceof mi?Mo([h]):h instanceof qr&&!Ro(t)?Mo([new mi("",'"interpolate" expressions cannot be used with this property')]):Ao(h?new $o(s&&c?"camera":"composite",e.value,h.labels,h instanceof qr?h.interpolation:void 0,l,c):new Ho(s&&c?"constant":"source",e.value,l,c)):Mo([new mi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class qo{constructor(e,t){this._parameters=e,this._specification=t,Object.assign(this,Bo(this._parameters,this._specification))}static deserialize(e){return new qo(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Xo(e){let t=null;if(e instanceof Zr)t=Xo(e.result);else if(e instanceof Yr){for(const i of e.args)if(t=Xo(i),t)break}else(e instanceof Ir||e instanceof qr)&&e.input instanceof on&&"zoom"===e.input.name&&(t=e);return t instanceof mi||e.eachChild((e=>{const i=Xo(e);i instanceof mi?t=i:t&&i&&t!==i&&(t=new mi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),t}var Yo,Zo,Jo=function(){if(Zo)return Yo;Zo=1,Yo=t;var e=3;function t(t,i,n){var r=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;var o=new Int32Array(this.arrayBuffer);t=o[0],this.d=(i=o[1])+2*(n=o[2]);for(var s=0;s<this.d*this.d;s++){var a=o[e+s],l=o[e+s+1];r.push(a===l?null:o.subarray(a,l))}var c=o[e+r.length+1];this.keys=o.subarray(o[e+r.length],c),this.bboxes=o.subarray(c),this.insert=this._insertReadonly}else{this.d=i+2*n;for(var u=0;u<this.d*this.d;u++)r.push([]);this.keys=[],this.bboxes=[]}this.n=i,this.extent=t,this.padding=n,this.scale=i/t,this.uid=0;var h=n/i*t;this.min=-h,this.max=t+h}return t.prototype.insert=function(e,t,i,n,r){this._forEachCell(t,i,n,r,this._insertCell,this.uid++),this.keys.push(e),this.bboxes.push(t),this.bboxes.push(i),this.bboxes.push(n),this.bboxes.push(r)},t.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},t.prototype._insertCell=function(e,t,i,n,r,o){this.cells[r].push(o)},t.prototype.query=function(e,t,i,n,r){var o=this.min,s=this.max;if(e<=o&&t<=o&&s<=i&&s<=n&&!r)return Array.prototype.slice.call(this.keys);var a=[];return this._forEachCell(e,t,i,n,this._queryCell,a,{},r),a},t.prototype._queryCell=function(e,t,i,n,r,o,s,a){var l=this.cells[r];if(null!==l)for(var c=this.keys,u=this.bboxes,h=0;h<l.length;h++){var d=l[h];if(void 0===s[d]){var p=4*d;(a?a(u[p+0],u[p+1],u[p+2],u[p+3]):e<=u[p+2]&&t<=u[p+3]&&i>=u[p+0]&&n>=u[p+1])?(s[d]=!0,o.push(c[d])):s[d]=!1}}},t.prototype._forEachCell=function(e,t,i,n,r,o,s,a){for(var l=this._convertToCellCoord(e),c=this._convertToCellCoord(t),u=this._convertToCellCoord(i),h=this._convertToCellCoord(n),d=l;d<=u;d++)for(var p=c;p<=h;p++){var f=this.d*p+d;if((!a||a(this._convertFromCellCoord(d),this._convertFromCellCoord(p),this._convertFromCellCoord(d+1),this._convertFromCellCoord(p+1)))&&r.call(this,e,t,i,n,f,o,s,a))return}},t.prototype._convertFromCellCoord=function(e){return(e-this.padding)/this.scale},t.prototype._convertToCellCoord=function(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))},t.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var t=this.cells,i=e+this.cells.length+1+1,n=0,r=0;r<this.cells.length;r++)n+=this.cells[r].length;var o=new Int32Array(i+n+this.keys.length+this.bboxes.length);o[0]=this.extent,o[1]=this.n,o[2]=this.padding;for(var s=i,a=0;a<t.length;a++){var l=t[a];o[e+a]=s,o.set(l,s),s+=l.length}return o[e+t.length]=s,o.set(this.keys,s),o[e+t.length+1]=s+=this.keys.length,o.set(this.bboxes,s),s+=this.bboxes.length,o.buffer},Yo}(),Ko=be(Jo);const Qo={};function es(e,t,i={}){Object.defineProperty(e,"_classRegistryKey",{value:t,writable:!1}),Qo[t]={klass:e,omit:i.omit||[]}}es(Object,"Object"),Ko.serialize=function(e,t){const i=e.toArrayBuffer();return t&&t.add(i),{buffer:i}},Ko.deserialize=function(e){return new Ko(e.buffer)},Object.defineProperty(Ko,"name",{value:"Grid"}),es(Ko,"Grid"),delete Ee.prototype.constructor,"undefined"!=typeof DOMMatrix&&es(DOMMatrix,"DOMMatrix"),es(li,"Color"),es(Error,"Error"),es(Fi,"Formatted"),es(Bi,"FormattedSection"),es(Ft,"AJAXError"),es(ki,"ResolvedImage"),es(qo,"StylePropertyFunction"),es(Vo,"StyleExpression",{omit:["_evaluator"]}),es(ri,"ImageId"),es(Ni,"ImageVariant"),es($o,"ZoomDependentExpression"),es(Ho,"ZoomConstantExpression"),es(on,"CompoundExpression",{omit:["_evaluate"]});for(const e in yo)Qo[yo[e]._classRegistryKey]||es(yo[e],`Expression${e}`);function ts(e){return e&&"undefined"!=typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}function is(e){return self.ImageBitmap&&e instanceof ImageBitmap}function ns(e,t){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp)return e;if(ts(e)||is(e))return t&&t.add(e),e;if(ArrayBuffer.isView(e))return t&&t.add(e.buffer),e;if(e instanceof ImageData)return t&&t.add(e.data.buffer),e;if(Array.isArray(e)){const i=[];for(const n of e)i.push(ns(n,t));return i}if(e instanceof Map){const i={$name:"Map",entries:[]};for(const[n,r]of e.entries())i.entries.push(ns(n),ns(r,t));return i}if(e instanceof Set){const t={$name:"Set"};let i=0;for(const n of e.values())t[++i]=ns(n);return t}if(e instanceof DOMMatrix){const t={$name:"DOMMatrix"},i=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const n of i)t[n]=e[n];return t}if("bigint"==typeof e)return{$name:"BigInt",value:e.toString()};if("object"==typeof e){const i=e.constructor,n=i._classRegistryKey;if(!n)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);const r=i.serialize?i.serialize(e,t):{};if(!i.serialize){for(const i in e)e.hasOwnProperty(i)&&(Qo[n].omit.indexOf(i)>=0||(r[i]=ns(e[i],t)));e instanceof Error&&(r.message=e.message)}if(r.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==n&&(r.$name=n),r}throw new Error("can't serialize object of type "+typeof e)}function rs(e){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||ts(e)||is(e)||ArrayBuffer.isView(e)||e instanceof ImageData)return e;if(Array.isArray(e))return e.map(rs);if("object"==typeof e){const t=e.$name||"Object";if("Map"===t){const t=e.entries||[],i=new Map;for(let e=0;e<t.length;e+=2)i.set(rs(t[e]),rs(t[e+1]));return i}if("Set"===t){const t=new Set;for(const i of Object.keys(e))"$name"!==i&&t.add(rs(e[i]));return t}if("DOMMatrix"===t){let t;return t=e.is2D?[e.a,e.b,e.c,e.d,e.e,e.f]:[e.m11,e.m12,e.m13,e.m14,e.m21,e.m22,e.m23,e.m24,e.m31,e.m32,e.m33,e.m34,e.m41,e.m42,e.m43,e.m44],new DOMMatrix(t)}if("BigInt"===t)return BigInt(e.value);const{klass:i}=Qo[t];if(!i)throw new Error(`Can't deserialize unregistered class "${t}".`);if(i.deserialize)return i.deserialize(e);const n=Object.create(i.prototype);for(const t of Object.keys(e))"$name"!==t&&(n[t]=rs(e[t]));return n}throw new Error("can't deserialize object of type "+typeof e)}const os={"Latin-1 Supplement":e=>e>=128&&e<=255,Arabic:e=>e>=1536&&e<=1791,"Arabic Supplement":e=>e>=1872&&e<=1919,"Arabic Extended-A":e=>e>=2208&&e<=2303,"Hangul Jamo":e=>e>=4352&&e<=4607,"Unified Canadian Aboriginal Syllabics":e=>e>=5120&&e<=5759,Khmer:e=>e>=6016&&e<=6143,"Unified Canadian Aboriginal Syllabics Extended":e=>e>=6320&&e<=6399,"General Punctuation":e=>e>=8192&&e<=8303,"Letterlike Symbols":e=>e>=8448&&e<=8527,"Number Forms":e=>e>=8528&&e<=8591,"Miscellaneous Technical":e=>e>=8960&&e<=9215,"Control Pictures":e=>e>=9216&&e<=9279,"Optical Character Recognition":e=>e>=9280&&e<=9311,"Enclosed Alphanumerics":e=>e>=9312&&e<=9471,"Geometric Shapes":e=>e>=9632&&e<=9727,"Miscellaneous Symbols":e=>e>=9728&&e<=9983,"Miscellaneous Symbols and Arrows":e=>e>=11008&&e<=11263,"CJK Radicals Supplement":e=>e>=11904&&e<=12031,"Kangxi Radicals":e=>e>=12032&&e<=12255,"Ideographic Description Characters":e=>e>=12272&&e<=12287,"CJK Symbols and Punctuation":e=>e>=12288&&e<=12351,Hiragana:e=>e>=12352&&e<=12447,Katakana:e=>e>=12448&&e<=12543,Bopomofo:e=>e>=12544&&e<=12591,"Hangul Compatibility Jamo":e=>e>=12592&&e<=12687,Kanbun:e=>e>=12688&&e<=12703,"Bopomofo Extended":e=>e>=12704&&e<=12735,"CJK Strokes":e=>e>=12736&&e<=12783,"Katakana Phonetic Extensions":e=>e>=12784&&e<=12799,"Enclosed CJK Letters and Months":e=>e>=12800&&e<=13055,"CJK Compatibility":e=>e>=13056&&e<=13311,"CJK Unified Ideographs Extension A":e=>e>=13312&&e<=19903,"Yijing Hexagram Symbols":e=>e>=19904&&e<=19967,"CJK Unified Ideographs":e=>e>=19968&&e<=40959,"Yi Syllables":e=>e>=40960&&e<=42127,"Yi Radicals":e=>e>=42128&&e<=42191,"Hangul Jamo Extended-A":e=>e>=43360&&e<=43391,"Hangul Syllables":e=>e>=44032&&e<=55215,"Hangul Jamo Extended-B":e=>e>=55216&&e<=55295,"Private Use Area":e=>e>=57344&&e<=63743,"CJK Compatibility Ideographs":e=>e>=63744&&e<=64255,"Arabic Presentation Forms-A":e=>e>=64336&&e<=65023,"Vertical Forms":e=>e>=65040&&e<=65055,"CJK Compatibility Forms":e=>e>=65072&&e<=65103,"Small Form Variants":e=>e>=65104&&e<=65135,"Arabic Presentation Forms-B":e=>e>=65136&&e<=65279,"Halfwidth and Fullwidth Forms":e=>e>=65280&&e<=65519,Osage:e=>e>=66736&&e<=66815,"CJK Unified Ideographs Extension B":e=>e>=131072&&e<=173791};function ss(e){for(const t of e)if(cs(t.charCodeAt(0)))return!0;return!1}function as(e){for(const t of e)if(!ls(t.charCodeAt(0)))return!1;return!0}function ls(e){return!(os.Arabic(e)||os["Arabic Supplement"](e)||os["Arabic Extended-A"](e)||os["Arabic Presentation Forms-A"](e)||os["Arabic Presentation Forms-B"](e))}function cs(e){return!(746!==e&&747!==e&&(e<4352||!(os["Bopomofo Extended"](e)||os.Bopomofo(e)||os["CJK Compatibility Forms"](e)&&!(e>=65097&&e<=65103)||os["CJK Compatibility Ideographs"](e)||os["CJK Compatibility"](e)||os["CJK Radicals Supplement"](e)||os["CJK Strokes"](e)||!(!os["CJK Symbols and Punctuation"](e)||e>=12296&&e<=12305||e>=12308&&e<=12319||12336===e)||os["CJK Unified Ideographs Extension A"](e)||os["CJK Unified Ideographs"](e)||os["Enclosed CJK Letters and Months"](e)||os["Hangul Compatibility Jamo"](e)||os["Hangul Jamo Extended-A"](e)||os["Hangul Jamo Extended-B"](e)||os["Hangul Jamo"](e)||os["Hangul Syllables"](e)||os.Hiragana(e)||os["Ideographic Description Characters"](e)||os.Kanbun(e)||os["Kangxi Radicals"](e)||os["Katakana Phonetic Extensions"](e)||os.Katakana(e)&&12540!==e||!(!os["Halfwidth and Fullwidth Forms"](e)||65288===e||65289===e||65293===e||e>=65306&&e<=65310||65339===e||65341===e||65343===e||e>=65371&&e<=65503||65507===e||e>=65512&&e<=65519)||!(!os["Small Form Variants"](e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||os["Unified Canadian Aboriginal Syllabics"](e)||os["Unified Canadian Aboriginal Syllabics Extended"](e)||os["Vertical Forms"](e)||os["Yijing Hexagram Symbols"](e)||os["Yi Syllables"](e)||os["Yi Radicals"](e))))}function us(e){return!(cs(e)||function(e){return!!(os["Latin-1 Supplement"](e)&&(167===e||169===e||174===e||177===e||188===e||189===e||190===e||215===e||247===e)||os["General Punctuation"](e)&&(8214===e||8224===e||8225===e||8240===e||8241===e||8251===e||8252===e||8258===e||8263===e||8264===e||8265===e||8273===e)||os["Letterlike Symbols"](e)||os["Number Forms"](e)||os["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||9003===e||e>=9085&&e<=9114||e>=9150&&e<=9165||9167===e||e>=9169&&e<=9179||e>=9186&&e<=9215)||os["Control Pictures"](e)&&9251!==e||os["Optical Character Recognition"](e)||os["Enclosed Alphanumerics"](e)||os["Geometric Shapes"](e)||os["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||os["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||os["CJK Symbols and Punctuation"](e)||os.Katakana(e)||os["Private Use Area"](e)||os["CJK Compatibility Forms"](e)||os["Small Form Variants"](e)||os["Halfwidth and Fullwidth Forms"](e)||8734===e||8756===e||8757===e||e>=9984&&e<=10087||e>=10102&&e<=10131||65532===e||65533===e)}(e))}function hs(e){return os.Arabic(e)||os["Arabic Supplement"](e)||os["Arabic Extended-A"](e)||os["Arabic Presentation Forms-A"](e)||os["Arabic Presentation Forms-B"](e)}function ds(e){return e>=1424&&e<=2303||os["Arabic Presentation Forms-A"](e)||os["Arabic Presentation Forms-B"](e)}function ps(e,t){return!(!t&&ds(e)||e>=2304&&e<=3583||e>=3840&&e<=4255||os.Khmer(e))}function fs(e){for(const t of e)if(ds(t.charCodeAt(0)))return!0;return!1}const ms={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let gs=null,_s=ms.unavailable,ys=null;const vs=function(e){e&&"string"==typeof e&&e.indexOf("NetworkError")>-1&&(_s=ms.error),gs&&gs(e)};function xs(){bs.fire(new Qt("pluginStateChange",{pluginStatus:_s,pluginURL:ys}))}const bs=new ni,Ts=function(){return _s},ws=function(){if(_s!==ms.deferred||!ys)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");_s=ms.loading,xs(),ys&&Ut({url:ys},(e=>{e?vs(e):(_s=ms.loaded,xs())}))},Es={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>_s===ms.loaded||null!=Es.applyArabicShaping,isLoading:()=>_s===ms.loading,setState(e){_s=e.pluginStatus,ys=e.pluginURL},isParsing:()=>_s===ms.parsing,isParsed:()=>_s===ms.parsed,getPluginURL:()=>ys};class Ss{constructor(e,t){this.zoom=e,t?(this.now=t.now,this.fadeDuration=t.fadeDuration,this.transition=t.transition,this.pitch=t.pitch,this.brightness=t.brightness,this.worldview=t.worldview,this.activeFloors=t.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(e,t){for(const i of e)if(!ps(i.charCodeAt(0),t))return!1;return!0}(e,Es.isLoaded())}}class As{constructor(e,t,i,n,r){this.property=e,this.value=t,this.expression=function(e,t,i,n,r){if(Oo(e))return new qo(e,t);if(Go(e)||Array.isArray(e)&&e.length>0){const o=Wo(e,t,i,n,r);if("error"===o.result)throw new Error(o.value.map((e=>`${e.key}: ${e.message}`)).join(", "));return o.value}{let i=e;return"string"==typeof e&&"color"===t.type&&(i=li.parse(e)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>i}}}(void 0===t?e.specification.default:t,e.specification,i,n,r)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(e,t,i,n){return this.property.possiblyEvaluate(this,e,t,i,n)}}class Ms{constructor(e,t,i,n){this.property=e,this.value=new As(e,void 0,t,i,n)}transitioned(e,t){return new Cs(this.property,this.value,t,Object.assign({},e.transition,this.transition),e.now)}untransitioned(){return new Cs(this.property,this.value,null,{},0)}}class Is{constructor(e,t,i,n){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=t,this._options=i,this._iconImageUseTheme=n,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return He(this._values[e].value.value)}setValue(e,t){this._values.hasOwnProperty(e)||(this._values[e]=new Ms(this._values[e].property,this._scope,this._options,this._iconImageUseTheme)),this._values[e].value=new As(this._values[e].property,null===t?void 0:He(t),this._scope,this._options,this._iconImageUseTheme),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].value.isIndoorDependent())}setTransitionOrValue(e,t){t&&(this._options=t);const i=this._properties.properties;if(e)for(const t in e){const n=e[t];if(t.endsWith("-transition")){const e=t.slice(0,-11);i[e]&&this.setTransition(e,n)}else i.hasOwnProperty(t)&&this.setValue(t,n)}}getTransition(e){return He(this._values[e].transition)}setTransition(e,t){this._values.hasOwnProperty(e)||(this._values[e]=new Ms(this._values[e].property)),this._values[e].transition=He(t)||void 0}serialize(){const e={};for(const t of Object.keys(this._values)){const i=this.getValue(t);void 0!==i&&(e[t]=i);const n=this.getTransition(t);void 0!==n&&(e[`${t}-transition`]=n)}return e}transitioned(e,t){const i=new Ps(this._properties);for(const n of Object.keys(this._values))i._values[n]=this._values[n].transitioned(e,t._values[n]);return i}untransitioned(){const e=new Ps(this._properties);for(const t of Object.keys(this._values))e._values[t]=this._values[t].untransitioned();return e}isIndoorDependent(){return this._isIndoorDependent}}class Cs{constructor(e,t,i,n,r){const o=n.delay||0,s=n.duration||0;r=r||0,this.property=e,this.value=t,this.begin=r+o,this.end=this.begin+s,e.specification.transition&&(n.delay||n.duration)&&(this.prior=i)}possiblyEvaluate(e,t,i){const n=e.now||0,r=this.value.possiblyEvaluate(e,t,i),o=this.prior;if(o){if(n>this.end)return this.prior=null,r;if(this.value.isDataDriven())return this.prior=null,r;if(n<this.begin)return o.possiblyEvaluate(e,t,i);{const s=(n-this.begin)/(this.end-this.begin);return this.property.interpolate(o.possiblyEvaluate(e,t,i),r,Le(s))}}return r}}class Ps{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,t,i){const n=new Os(this._properties);for(const r of Object.keys(this._values))n._values[r]=this._values[r].possiblyEvaluate(e,t,i);return n}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Ls{constructor(e,t,i,n){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=t,this._options=i,this._iconImageUseTheme=n,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return He(this._values[e].value)}setValue(e,t){this._values[e]=new As(this._values[e].property,null===t?void 0:He(t),this._scope,this._options,this._iconImageUseTheme),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].isIndoorDependent())}serialize(){const e={};for(const t of Object.keys(this._values)){const i=this.getValue(t);void 0!==i&&(e[t]=i)}return e}possiblyEvaluate(e,t,i,n){const r=new Os(this._properties);for(const o of Object.keys(this._values))r._values[o]=this._values[o].possiblyEvaluate(e,t,i,n);return r}isIndoorDependent(){return this._isIndoorDependent}}class Rs{constructor(e,t,i,n){this.property=e,this.value=t,this.parameters=i,this.iconImageUseTheme=n}isConstant(){return"constant"===this.value.kind}constantOr(e){return"constant"===this.value.kind?this.value.value:e}evaluate(e,t,i,n){return this.property.evaluate(this.value,this.parameters,e,t,i,n,this.iconImageUseTheme)}}class Os{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class Ds{constructor(e){this.specification=e}possiblyEvaluate(e,t){return e.expression.evaluate(t)}interpolate(e,t,i){const n=fi[this.specification.type];return n?n(e,t,i):e}}class Bs{constructor(e,t){this.specification=e,this.overrides=t}possiblyEvaluate(e,t,i,n,r){return"constant"===e.expression.kind||"camera"===e.expression.kind?new Rs(this,{kind:"constant",value:e.expression.evaluate(t,null,{},i,n,void 0,r)},t):new Rs(this,e.expression,t,r)}interpolate(e,t,i){if("constant"!==e.value.kind||"constant"!==t.value.kind)return e;if(void 0===e.value.value||void 0===t.value.value)return new Rs(this,{kind:"constant",value:void 0},e.parameters);const n=fi[this.specification.type];return n?new Rs(this,{kind:"constant",value:n(e.value.value,t.value.value,i)},e.parameters):e}evaluate(e,t,i,n,r,o,s){return"constant"===e.kind?e.value:e.evaluate(t,i,n,r,o,void 0,s)}}class Fs{constructor(e){this.specification=e}possiblyEvaluate(e,t,i,n){return!!e.expression.evaluate(t,null,{},i,n)}interpolate(){return!1}}class Ns{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const t=new Ss(0,{});for(const i in e){const n=e[i];n.specification.overridable&&this.overridableProperties.push(i);const r=this.defaultPropertyValues[i]=new As(n,void 0),o=this.defaultTransitionablePropertyValues[i]=new Ms(n);this.defaultTransitioningPropertyValues[i]=o.untransitioned(),this.defaultPossiblyEvaluatedValues[i]=r.possiblyEvaluate(t)}}}es(Bs,"DataDrivenProperty"),es(Ds,"DataConstantProperty"),es(Fs,"ColorRampProperty");var ks=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function Us(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}function zs(e){if(Array.isArray(e))return e.map(zs);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const i in e)t[i]=zs(e[i]);return t}return Us(e)}function Vs(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!Vs(t)&&"boolean"!=typeof t)return!1;return!0;default:return!0}}function Gs(e,t="",i=null,n="fill"){if(null==e)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Vs(e)||(e=Ys(e));const r=e;let o=!0;try{o=function(e){if(!$s(e))return e;let t=zs(e);return Hs(t),t=js(t),t}(r)}catch(e){}let s=null,a=null;if("background"!==n&&"sky"!==n&&"slot"!==n){a=ks[`filter_${n}`];const e=jo(o,a,t,i);if("error"===e.result)throw new Error(e.value.map((e=>`${e.key}: ${e.message}`)).join(", "));s=(t,i,n)=>e.value.evaluate(t,i,{},n)}let l=null,c=null;if(o!==r){const e=jo(r,a,t,i);if("error"===e.result)throw new Error(e.value.map((e=>`${e.key}: ${e.message}`)).join(", "));l=(t,i,n,r,o)=>e.value.evaluate(t,i,{},n,void 0,void 0,r,o),c=!_r(e.value.expression)}return{filter:s,dynamicFilter:l||void 0,needGeometry:Xs(o),needFeature:!!c}}function js(e){if(!Array.isArray(e))return e;const t=function(e){if(Ws.has(e[0]))for(let t=1;t<e.length;t++)if($s(e[t]))return!0;return e}(e);return!0===t?t:t.map((e=>js(e)))}function Hs(e){let t=!1;const i=[];if("case"===e[0]){for(let n=1;n<e.length-1;n+=2)t=t||$s(e[n]),i.push(e[n+1]);i.push(e[e.length-1])}else if("match"===e[0]){t=t||$s(e[1]);for(let t=2;t<e.length-1;t+=2)i.push(e[t+1]);i.push(e[e.length-1])}else if("step"===e[0]){t=t||$s(e[1]);for(let t=1;t<e.length-1;t+=2)i.push(e[t+1])}t&&(e.length=0,e.push("any",...i));for(let t=1;t<e.length;t++)Hs(e[t])}function $s(e){if(!Array.isArray(e))return!1;if("pitch"===(t=e[0])||"distance-from-center"===t)return!0;var t;for(let t=1;t<e.length;t++)if($s(e[t]))return!0;return!1}const Ws=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function qs(e,t){return e<t?-1:e>t?1:0}function Xs(e){if(!Array.isArray(e))return!1;if("within"===e[0]||"distance"===e[0])return!0;for(let t=1;t<e.length;t++)if(Xs(e[t]))return!0;return!1}function Ys(e){if(!e)return!0;const t=e[0];return e.length<=1?"any"!==t:"=="===t?Zs(e[1],e[2],"=="):"!="===t?Qs(Zs(e[1],e[2],"==")):"<"===t||">"===t||"<="===t||">="===t?Zs(e[1],e[2],t):"any"===t?(i=e.slice(1),["any"].concat(i.map(Ys))):"all"===t?["all"].concat(e.slice(1).map(Ys)):"none"===t?["all"].concat(e.slice(1).map(Ys).map(Qs)):"in"===t?Js(e[1],e.slice(2)):"!in"===t?Qs(Js(e[1],e.slice(2))):"has"===t?Ks(e[1]):"!has"!==t||Qs(Ks(e[1]));var i}function Zs(e,t,i){switch(e){case"$type":return[`filter-type-${i}`,t];case"$id":return[`filter-id-${i}`,t];default:return[`filter-${i}`,e,t]}}function Js(e,t){if(0===t.length)return!1;switch(e){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some((e=>typeof e!=typeof t[0]))?["filter-in-large",e,["literal",t.sort(qs)]]:["filter-in-small",e,["literal",t]]}}function Ks(e){switch(e){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",e]}}function Qs(e){return["!",e]}const ea="";function ta(e,t){return t?`${e}${ea}${t}`:e}let ia;const na=()=>ia||(ia=new Ns({"icon-size":new Bs(ks.layout_symbol["icon-size"]),"icon-image":new Bs(ks.layout_symbol["icon-image"]),"icon-rotate":new Bs(ks.layout_symbol["icon-rotate"]),"icon-offset":new Bs(ks.layout_symbol["icon-offset"])}));class ra{constructor(e,t,i,n,r,o){this.cachedIconPrimary=null;const s=jo(e,ks.appearance.condition);if("success"===s.result&&(this.condition=s.value),this.name=t,i){this.properties=new Os(na()),this.unevaluatedLayout=new Ls(na(),n,r,o);for(const e in i)this.unevaluatedLayout.setValue(e,i[e])}}hasCachedIconPrimary(){return null!==this.cachedIconPrimary}setCachedIconPrimary(e){this.cachedIconPrimary=e}getCachedIconPrimary(){return this.cachedIconPrimary}isActive(e){return!(this.condition||!e.isHidden||"hidden"!==this.name)||this.condition.evaluate(e.globals,e.feature,e.featureState,e.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(e){return this.properties.get(e)}getUnevaluatedProperties(){return this.unevaluatedLayout}recalculate(e,t,i){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(e,void 0,t,i))}serialize(){const e={};return e.condition=this.condition.expression.serialize(),this.name&&(e.name=this.name),this.unevaluatedLayout&&(e.properties=this.unevaluatedLayout.serialize()),e}}const oa="-transition",sa=new Set(["fill","line","background","hillshade","raster"]);class aa extends ni{constructor(e,t,i,n,r,o){if(super(),this.id=e.id,this.fqid=ta(this.id,i),this.type=e.type,this.scope=i,this.lut=n,this.options=r,this.iconImageUseTheme=o,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},"custom"!==e.type){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&"background"!==e.type&&"sky"!==e.type&&"slot"!==e.type){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const t=jo(this.filter,ks[`filter_${e.type}`]);"error"!==t.result&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...t.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||t.value.isIndoorDependent)}if(e.slot&&(this.slot=e.slot),e.appearances&&this.setAppearances(e.appearances),t.layout&&(this._unevaluatedLayout=new Ls(t.layout,this.scope,r,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),t.paint){this._transitionablePaint=new Is(t.paint,this.scope,r);for(const t in e.paint)this.setPaintProperty(t,e.paint[t]);for(const t in e.layout)this.setLayoutProperty(t,e.layout[t]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Os(t.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&sa.has(this.type)}getLayoutProperty(e){return"visibility"===e?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,t){if("custom"===this.type&&"visibility"===e)return void(this.visibility=t);const i=this._unevaluatedLayout;i._properties.properties[e]&&(i.setValue(e,t),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...i.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||i.isIndoorDependent(),"visibility"===e&&this.possiblyEvaluateVisibility())}setAppearances(e){this.appearances=[],e.forEach((e=>{this.appearances.push(new ra(e.condition,e.name,e.properties,this.scope,this.options,this.iconImageUseTheme))}))}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(oa)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}isPaintProperty(e){return!!this._transitionablePaint._properties.properties[e]}setPaintProperty(e,t){const i=this._transitionablePaint,n=i._properties.properties;if(e.endsWith(oa)){const r=e.slice(0,-11);return n[r]&&i.setTransition(r,t||void 0),!1}if(!n[e])return!1;const r=i._values[e],o=r.value.isDataDriven(),s=r.value;i.setValue(e,t),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...i.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||i.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(e);const a=i._values[e].value,l=a.isDataDriven(),c=e.endsWith("pattern")||"line-dasharray"===e;return l||o||c||this._handleOverridablePaintPropertyUpdate(e,s,a)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,t,i){return null}_handleOverridablePaintPropertyUpdate(e,t,i){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||"none"===this.visibility}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,t){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,t,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,t)}serialize(){const e={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return 0!==this.appearances.length&&(e.appearances=this.appearances.map((e=>e.serialize()))),je(e,((e,t)=>!(void 0===e||"layout"===t&&!Object.keys(e).length||"paint"===t&&!Object.keys(e).length)))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const t=this.paint.get(e);if(t instanceof Rs&&Co(t.property.specification)&&("source"===t.value.kind||"composite"===t.value.kind)&&t.value.isStateDependent)return!0}for(const e of this.appearances)if(!yr(e.condition.expression))return!0;return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=Gs(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&("shadow"===e.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(e,t,i){return{}}queryRadius(e){}queryIntersectsFeature(e,t,i,n,r,o,s,a,l){}}const la={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ca{constructor(e,t){this._structArray=e,this._pos1=t*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class ua{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,t){return e._trim(),t&&t.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const t=Object.create(this.prototype);return t.arrayBuffer=e.arrayBuffer,t.length=e.length,t.capacity=e.arrayBuffer.byteLength/t.bytesPerElement,t._refreshViews(),t}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const t=this.uint8;this._refreshViews(),t&&this.uint8.set(t)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function ha(e,t=1){let i=0,n=0;return{members:e.map((e=>{const r=la[e.type].BYTES_PER_ELEMENT,o=i=da(i,Math.max(t,r)),s=e.components||1;return n=Math.max(n,r),i+=r*s,{name:e.name,type:e.type,components:s,offset:o}})),size:da(i,Math.max(n,t)),alignment:t}}function da(e,t){return Math.ceil(e/t)*t}class pa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t){const i=this.length;return this.resize(i+1),this.emplace(i,e,t)}emplace(e,t,i){const n=2*e;return this.int16[n+0]=t,this.int16[n+1]=i,e}}pa.prototype.bytesPerElement=4,es(pa,"StructArrayLayout2i4");class fa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,i){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i)}emplace(e,t,i,n){const r=3*e;return this.int16[r+0]=t,this.int16[r+1]=i,this.int16[r+2]=n,e}}fa.prototype.bytesPerElement=6,es(fa,"StructArrayLayout3i6");class ma extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,e,t,i,n)}emplace(e,t,i,n,r){const o=4*e;return this.int16[o+0]=t,this.int16[o+1]=i,this.int16[o+2]=n,this.int16[o+3]=r,e}}ma.prototype.bytesPerElement=8,es(ma,"StructArrayLayout4i8");class ga extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.float32[1*e+0]=t,e}}ga.prototype.bytesPerElement=4,es(ga,"StructArrayLayout1f4");class _a extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i)}emplace(e,t,i,n){const r=4*e,o=2*e;return this.int16[r+0]=t,this.int16[r+1]=i,this.float32[o+1]=n,e}}_a.prototype.bytesPerElement=8,es(_a,"StructArrayLayout2i1f8");class ya extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,i){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i)}emplace(e,t,i,n){const r=4*e;return this.int16[r+0]=t,this.int16[r+1]=i,this.int16[r+2]=n,e}}ya.prototype.bytesPerElement=8,es(ya,"StructArrayLayout3i8");class va extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,i,n,r)}emplace(e,t,i,n,r,o){const s=5*e;return this.int16[s+0]=t,this.int16[s+1]=i,this.int16[s+2]=n,this.int16[s+3]=r,this.int16[s+4]=o,e}}va.prototype.bytesPerElement=10,es(va,"StructArrayLayout5i10");class xa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,t,i,n,r,o,s)}emplace(e,t,i,n,r,o,s,a){const l=6*e,c=12*e,u=3*e;return this.int16[l+0]=t,this.int16[l+1]=i,this.uint8[c+4]=n,this.uint8[c+5]=r,this.uint8[c+6]=o,this.uint8[c+7]=s,this.float32[u+2]=a,e}}xa.prototype.bytesPerElement=12,es(xa,"StructArrayLayout2i4ub1f12");class ba extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i)}emplace(e,t,i,n){const r=3*e;return this.float32[r+0]=t,this.float32[r+1]=i,this.float32[r+2]=n,e}}ba.prototype.bytesPerElement=12,es(ba,"StructArrayLayout3f12");class Ta extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,i,n,r)}emplace(e,t,i,n,r,o){const s=6*e,a=3*e;return this.uint16[s+0]=t,this.uint16[s+1]=i,this.uint16[s+2]=n,this.uint16[s+3]=r,this.float32[a+2]=o,e}}Ta.prototype.bytesPerElement=12,es(Ta,"StructArrayLayout4ui1f12");class wa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,e,t,i,n)}emplace(e,t,i,n,r){const o=4*e;return this.uint16[o+0]=t,this.uint16[o+1]=i,this.uint16[o+2]=n,this.uint16[o+3]=r,e}}wa.prototype.bytesPerElement=8,es(wa,"StructArrayLayout4ui8");class Ea extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,e,t,i,n,r,o)}emplace(e,t,i,n,r,o,s){const a=6*e;return this.int16[a+0]=t,this.int16[a+1]=i,this.int16[a+2]=n,this.int16[a+3]=r,this.int16[a+4]=o,this.int16[a+5]=s,e}}Ea.prototype.bytesPerElement=12,es(Ea,"StructArrayLayout6i12");class Sa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s,a,l,c,u,h){const d=this.length;return this.resize(d+1),this.emplace(d,e,t,i,n,r,o,s,a,l,c,u,h)}emplace(e,t,i,n,r,o,s,a,l,c,u,h,d){const p=12*e;return this.int16[p+0]=t,this.int16[p+1]=i,this.int16[p+2]=n,this.int16[p+3]=r,this.uint16[p+4]=o,this.uint16[p+5]=s,this.uint16[p+6]=a,this.uint16[p+7]=l,this.int16[p+8]=c,this.int16[p+9]=u,this.int16[p+10]=h,this.int16[p+11]=d,e}}Sa.prototype.bytesPerElement=24,es(Sa,"StructArrayLayout4i4ui4i24");class Aa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,e,t,i,n,r,o)}emplace(e,t,i,n,r,o,s){const a=10*e,l=5*e;return this.int16[a+0]=t,this.int16[a+1]=i,this.int16[a+2]=n,this.float32[l+2]=r,this.float32[l+3]=o,this.float32[l+4]=s,e}}Aa.prototype.bytesPerElement=20,es(Aa,"StructArrayLayout3i3f20");class Ma extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,e,t,i,n)}emplace(e,t,i,n,r){const o=4*e;return this.float32[o+0]=t,this.float32[o+1]=i,this.float32[o+2]=n,this.float32[o+3]=r,e}}Ma.prototype.bytesPerElement=16,es(Ma,"StructArrayLayout4f16");class Ia extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.uint32[1*e+0]=t,e}}Ia.prototype.bytesPerElement=4,es(Ia,"StructArrayLayout1ul4");class Ca extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t){const i=this.length;return this.resize(i+1),this.emplace(i,e,t)}emplace(e,t,i){const n=2*e;return this.uint16[n+0]=t,this.uint16[n+1]=i,e}}Ca.prototype.bytesPerElement=4,es(Ca,"StructArrayLayout2ui4");class Pa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s,a,l,c,u,h,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,t,i,n,r,o,s,a,l,c,u,h,d)}emplace(e,t,i,n,r,o,s,a,l,c,u,h,d,p){const f=20*e,m=10*e;return this.int16[f+0]=t,this.int16[f+1]=i,this.int16[f+2]=n,this.int16[f+3]=r,this.int16[f+4]=o,this.float32[m+3]=s,this.float32[m+4]=a,this.float32[m+5]=l,this.float32[m+6]=c,this.int16[f+14]=u,this.uint32[m+8]=h,this.uint16[f+18]=d,this.uint16[f+19]=p,e}}Pa.prototype.bytesPerElement=40,es(Pa,"StructArrayLayout5i4f1i1ul2ui40");class La extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,t,i,n,r,o,s)}emplace(e,t,i,n,r,o,s,a){const l=8*e;return this.int16[l+0]=t,this.int16[l+1]=i,this.int16[l+2]=n,this.int16[l+4]=r,this.int16[l+5]=o,this.int16[l+6]=s,this.int16[l+7]=a,e}}La.prototype.bytesPerElement=16,es(La,"StructArrayLayout3i2i2i16");class Ra extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,i,n,r)}emplace(e,t,i,n,r,o){const s=4*e,a=8*e;return this.float32[s+0]=t,this.float32[s+1]=i,this.float32[s+2]=n,this.int16[a+6]=r,this.int16[a+7]=o,e}}Ra.prototype.bytesPerElement=16,es(Ra,"StructArrayLayout2f1f2i16");class Oa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,e,t,i,n,r,o)}emplace(e,t,i,n,r,o,s){const a=20*e,l=5*e;return this.uint8[a+0]=t,this.uint8[a+1]=i,this.float32[l+1]=n,this.float32[l+2]=r,this.float32[l+3]=o,this.float32[l+4]=s,e}}Oa.prototype.bytesPerElement=20,es(Oa,"StructArrayLayout2ub4f20");class Da extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,i){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i)}emplace(e,t,i,n){const r=3*e;return this.uint16[r+0]=t,this.uint16[r+1]=i,this.uint16[r+2]=n,e}}Da.prototype.bytesPerElement=6,es(Da,"StructArrayLayout3ui6");class Ba extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x){const b=this.length;return this.resize(b+1),this.emplace(b,e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x)}emplace(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b){const T=30*e,w=15*e,E=60*e;return this.int16[T+0]=t,this.int16[T+1]=i,this.int16[T+2]=n,this.float32[w+2]=r,this.float32[w+3]=o,this.uint16[T+8]=s,this.uint16[T+9]=a,this.uint32[w+5]=l,this.uint32[w+6]=c,this.uint32[w+7]=u,this.uint16[T+16]=h,this.uint16[T+17]=d,this.uint16[T+18]=p,this.float32[w+10]=f,this.float32[w+11]=m,this.uint8[E+48]=g,this.uint8[E+49]=_,this.uint8[E+50]=y,this.uint32[w+13]=v,this.int16[T+28]=x,this.uint8[E+58]=b,e}}Ba.prototype.bytesPerElement=60,es(Ba,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Fa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b,T,w,E,S,A,M,I,C,P,L,R){const O=this.length;return this.resize(O+1),this.emplace(O,e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b,T,w,E,S,A,M,I,C,P,L,R)}emplace(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b,T,w,E,S,A,M,I,C,P,L,R,O){const D=20*e,B=40*e,F=80*e;return this.float32[D+0]=t,this.float32[D+1]=i,this.int16[B+4]=n,this.int16[B+5]=r,this.int16[B+6]=o,this.int16[B+7]=s,this.int16[B+8]=a,this.int16[B+9]=l,this.int16[B+10]=c,this.int16[B+11]=u,this.int16[B+12]=h,this.uint16[B+13]=d,this.uint16[B+14]=p,this.uint16[B+15]=f,this.uint16[B+16]=m,this.uint16[B+17]=g,this.uint16[B+18]=_,this.uint16[B+19]=y,this.uint16[B+20]=v,this.uint16[B+21]=x,this.uint16[B+22]=b,this.uint16[B+23]=T,this.uint16[B+24]=w,this.uint16[B+25]=E,this.uint16[B+26]=S,this.uint16[B+27]=A,this.uint32[D+14]=M,this.float32[D+15]=I,this.float32[D+16]=C,this.float32[D+17]=P,this.float32[D+18]=L,this.uint8[F+76]=R,this.uint16[B+39]=O,e}}Fa.prototype.bytesPerElement=80,es(Fa,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Na extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,e,t,i,n,r,o)}emplace(e,t,i,n,r,o,s){const a=6*e;return this.float32[a+0]=t,this.float32[a+1]=i,this.float32[a+2]=n,this.float32[a+3]=r,this.float32[a+4]=o,this.float32[a+5]=s,e}}Na.prototype.bytesPerElement=24,es(Na,"StructArrayLayout6f24");class ka extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,i,n,r)}emplace(e,t,i,n,r,o){const s=5*e;return this.float32[s+0]=t,this.float32[s+1]=i,this.float32[s+2]=n,this.float32[s+3]=r,this.float32[s+4]=o,e}}ka.prototype.bytesPerElement=20,es(ka,"StructArrayLayout5f20");class Ua extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,t,i,n,r,o,s)}emplace(e,t,i,n,r,o,s,a){const l=7*e;return this.float32[l+0]=t,this.float32[l+1]=i,this.float32[l+2]=n,this.float32[l+3]=r,this.float32[l+4]=o,this.float32[l+5]=s,this.float32[l+6]=a,e}}Ua.prototype.bytesPerElement=28,es(Ua,"StructArrayLayout7f28");class za extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s,a,l,c,u){const h=this.length;return this.resize(h+1),this.emplace(h,e,t,i,n,r,o,s,a,l,c,u)}emplace(e,t,i,n,r,o,s,a,l,c,u,h){const d=11*e;return this.float32[d+0]=t,this.float32[d+1]=i,this.float32[d+2]=n,this.float32[d+3]=r,this.float32[d+4]=o,this.float32[d+5]=s,this.float32[d+6]=a,this.float32[d+7]=l,this.float32[d+8]=c,this.float32[d+9]=u,this.float32[d+10]=h,e}}za.prototype.bytesPerElement=44,es(za,"StructArrayLayout11f44");class Va extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s,a,l){const c=this.length;return this.resize(c+1),this.emplace(c,e,t,i,n,r,o,s,a,l)}emplace(e,t,i,n,r,o,s,a,l,c){const u=9*e;return this.float32[u+0]=t,this.float32[u+1]=i,this.float32[u+2]=n,this.float32[u+3]=r,this.float32[u+4]=o,this.float32[u+5]=s,this.float32[u+6]=a,this.float32[u+7]=l,this.float32[u+8]=c,e}}Va.prototype.bytesPerElement=36,es(Va,"StructArrayLayout9f36");class Ga extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t){const i=this.length;return this.resize(i+1),this.emplace(i,e,t)}emplace(e,t,i){const n=2*e;return this.float32[n+0]=t,this.float32[n+1]=i,e}}Ga.prototype.bytesPerElement=8,es(Ga,"StructArrayLayout2f8");class ja extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,t,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,e,t,i,n)}emplace(e,t,i,n,r){const o=6*e;return this.uint32[3*e+0]=t,this.uint16[o+2]=i,this.uint16[o+3]=n,this.uint16[o+4]=r,e}}ja.prototype.bytesPerElement=12,es(ja,"StructArrayLayout1ul3ui12");class Ha extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.uint16[1*e+0]=t,e}}Ha.prototype.bytesPerElement=2,es(Ha,"StructArrayLayout1ui2");class $a extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m){const g=this.length;return this.resize(g+1),this.emplace(g,e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m)}emplace(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g){const _=16*e;return this.float32[_+0]=t,this.float32[_+1]=i,this.float32[_+2]=n,this.float32[_+3]=r,this.float32[_+4]=o,this.float32[_+5]=s,this.float32[_+6]=a,this.float32[_+7]=l,this.float32[_+8]=c,this.float32[_+9]=u,this.float32[_+10]=h,this.float32[_+11]=d,this.float32[_+12]=p,this.float32[_+13]=f,this.float32[_+14]=m,this.float32[_+15]=g,e}}$a.prototype.bytesPerElement=64,es($a,"StructArrayLayout16f64");class Wa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,t,i,n,r,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,t,i,n,r,o,s)}emplace(e,t,i,n,r,o,s,a){const l=10*e,c=5*e;return this.uint16[l+0]=t,this.uint16[l+1]=i,this.uint16[l+2]=n,this.uint16[l+3]=r,this.float32[c+2]=o,this.float32[c+3]=s,this.float32[c+4]=a,e}}Wa.prototype.bytesPerElement=20,es(Wa,"StructArrayLayout4ui3f20");class qa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.int16[1*e+0]=t,e}}qa.prototype.bytesPerElement=2,es(qa,"StructArrayLayout1i2");class Xa extends ua{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e)}emplace(e,t){return this.uint8[1*e+0]=t,e}}Xa.prototype.bytesPerElement=1,es(Xa,"StructArrayLayout1ub1");class Ya extends ca{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Ya.prototype.size=40;class Za extends Pa{get(e){return new Ya(this,e)}}es(Za,"CollisionBoxArray");class Ja extends ca{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Ja.prototype.size=60;class Ka extends Ba{get(e){return new Ja(this,e)}}es(Ka,"PlacedSymbolArray");class Qa extends ca{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}Qa.prototype.size=80;class el extends Fa{get(e){return new Qa(this,e)}}es(el,"SymbolInstanceArray");class tl extends ga{getoffsetX(e){return this.float32[1*e+0]}}es(tl,"GlyphOffsetArray");class il extends pa{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}es(il,"SymbolLineVertexArray");class nl extends ca{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}nl.prototype.size=12;class rl extends ja{get(e){return new nl(this,e)}}es(rl,"FeatureIndexArray");class ol extends Ca{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}es(ol,"FillExtrusionCentroidArray");class sl extends ca{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}sl.prototype.size=6;class al extends fa{get(e){return new sl(this,e)}}es(al,"FillExtrusionWallArray");const ll=ha([{name:"a_pos",components:2,type:"Int16"}],4),cl=ha([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),ul=ha([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class hl{constructor(e=[]){this.segments=e}_prepareSegment(e,t,i,n){let r=this.segments[this.segments.length-1];return e>hl.MAX_VERTEX_ARRAY_LENGTH&&qe(`Max vertices per segment is ${hl.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!r||r.vertexLength+e>hl.MAX_VERTEX_ARRAY_LENGTH||r.sortKey!==n)&&(r={vertexOffset:t,primitiveOffset:i,vertexLength:0,primitiveLength:0},void 0!==n&&(r.sortKey=n),this.segments.push(r)),r}prepareSegment(e,t,i,n){return this._prepareSegment(e,t.length,i.length,n)}get(){return this.segments}destroy(){for(const e of this.segments)for(const t in e.vaos)e.vaos[t].destroy()}static simpleSegment(e,t,i,n){return new hl([{vertexOffset:e,primitiveOffset:t,vertexLength:i,primitiveLength:n,vaos:{},sortKey:0}])}}function dl(e,t){return 256*(e=De(Math.floor(e),0,255))+De(Math.floor(t),0,255)}hl.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,es(hl,"SegmentVector");const pl=ha([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),fl=ha([{name:"a_pattern_b",components:4,type:"Uint16"}]),ml=ha([{name:"a_dash",components:4,type:"Uint16"}]);class gl{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,t,i,n){this.ids.push(_l(e)),this.positions.push(t,i,n)}eachPosition(e,t){const i=_l(e);let n=0,r=this.ids.length-1;for(;n<r;){const e=n+r>>1;this.ids[e]>=i?r=e:n=e+1}for(;this.ids[n]===i;)t(this.positions[3*n],this.positions[3*n+1],this.positions[3*n+2]),n++}static serialize(e,t){const i=new Float64Array(e.ids),n=new Uint32Array(e.positions);return yl(i,n,0,i.length-1),t&&(t.add(i.buffer),t.add(n.buffer)),{ids:i,positions:n}}static deserialize(e){const t=new gl;let i;t.ids=e.ids,t.positions=e.positions;for(const e of t.ids)e!==i&&t.uniqueIds.push(e),i=e;return t.indexed=!0,t}}function _l(e){const t=+e;return Number.isSafeInteger(t)?t:Kt(String(e))}function yl(e,t,i,n){for(;i<n;){const r=e[i+n>>1];let o=i-1,s=n+1;for(;;){do{o++}while(e[o]<r);do{s--}while(e[s]>r);if(o>=s)break;vl(e,o,s),vl(t,3*o,3*s),vl(t,3*o+1,3*s+1),vl(t,3*o+2,3*s+2)}s-i<n-s?(yl(e,t,i,s),i=s+1):(yl(e,t,s+1,n),n=s)}}function vl(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}es(gl,"FeaturePositionMap");class xl{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,t){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,t),this.initialized=!0),!!this.location}set(e,t,i){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class bl extends xl{constructor(e){super(e),this.current=0}set(e,t,i){this.fetchUniformLocation(e,t)&&this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}}class Tl extends xl{constructor(e){super(e),this.current=0}set(e,t,i){this.fetchUniformLocation(e,t)&&this.current!==i&&(this.current=i,this.gl.uniform1f(this.location,i))}}class wl extends xl{constructor(e){super(e),this.current=[0,0]}set(e,t,i){this.fetchUniformLocation(e,t)&&(i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1])))}}class El extends xl{constructor(e){super(e),this.current=[0,0,0]}set(e,t,i){this.fetchUniformLocation(e,t)&&(i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2])))}}class Sl extends xl{constructor(e){super(e),this.current=[0,0,0,0]}set(e,t,i){this.fetchUniformLocation(e,t)&&(i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]&&i[3]===this.current[3]||(this.current=i,this.gl.uniform4f(this.location,i[0],i[1],i[2],i[3])))}}class Al extends xl{constructor(e){super(e),this.current=li.transparent.toPremultipliedRenderColor(null)}set(e,t,i){this.fetchUniformLocation(e,t)&&(i.r===this.current.r&&i.g===this.current.g&&i.b===this.current.b&&i.a===this.current.a||(this.current=i,this.gl.uniform4f(this.location,i.r,i.g,i.b,i.a)))}}const Ml=new Float32Array(16);class Il extends xl{constructor(e){super(e),this.current=Ml}set(e,t,i){if(this.fetchUniformLocation(e,t)){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let e=1;e<16;e++)if(i[e]!==this.current[e]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}}}const Cl=new Float32Array(9),Pl=new Float32Array(4);class Ll extends xl{constructor(e){super(e),this.current=Pl}set(e,t,i){if(this.fetchUniformLocation(e,t))for(let e=0;e<4;e++)if(i[e]!==this.current[e]){this.current=i,this.gl.uniformMatrix2fv(this.location,!1,i);break}}}function Rl(e){return[dl(255*e.r,255*e.g),dl(255*e.b,255*e.a)]}function Ol(e,t,i,n,r,o,s,a){return!!e&&("composite"===e.kind||"source"===e.kind?"none"===e.evaluate(new Ss(0,{brightness:o,worldview:a}),t,i,r,n,s):"none"===e.value)}class Dl{constructor(e,t,i,n){this.value=e,this.uniformNames=t.map((e=>`u_${e}`)),this.type=i,this.context=n}setUniform(e,t,i,n,r){const o=n.constantOr(this.value);t.set(e,r,o instanceof li?o.toPremultipliedRenderColor(this.lutExpression&&"constant"===this.lutExpression.kind&&"none"===this.lutExpression.value?null:this.context.lut):o)}getBinding(e,t){return"color"===this.type?new Al(e):new Tl(e)}}class Bl{constructor(e,t){this.uniformNames=t.map((e=>`u_${e}`)),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,t){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=t?t.tl.concat(t.br):this.pattern}setUniform(e,t,i,n,r){let o=null;"u_pattern"!==r&&"u_dash"!==r||(o=this.pattern),"u_pattern_b"===r&&(o=this.patternTransition),"u_pixel_ratio"===r&&(o=this.pixelRatio),o&&t.set(e,r,o)}getBinding(e,t){return"u_pattern"===t||"u_pattern_b"===t||"u_dash"===t?new Sl(e):new Tl(e)}}class Fl{constructor(e,t,i,n){this.expression=e,this.type=i,this.maxValue=0,this.paintVertexAttributes=t.map((e=>({name:`a_${e}`,type:"Float32",components:"color"===i?2:1,offset:0}))),this.paintVertexArray=new n}populatePaintArray(e,t,i,n,r,o,s,a){const l=this.paintVertexArray.length,c="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Ss(0,{brightness:o,worldview:a}),t,{},r,n,s):"constant"===this.expression.kind&&this.expression.value,u=Ol(this.lutExpression,t,{},n,r,o,s,a);this.paintVertexArray.resize(e),this._setPaintValue(l,e,c,u?null:this.context.lut)}updatePaintArray(e,t,i,n,r,o,s,a){const l="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:s,worldview:a},i,n,void 0,r):"constant"===this.expression.kind&&this.expression.value,c=Ol(this.lutExpression,i,n,r,void 0,s,void 0,a);this._setPaintValue(e,t,l,c?null:this.context.lut)}_setPaintValue(e,t,i,n){if("color"===this.type){const r=Rl(i.toPremultipliedRenderColor(n));for(let i=e;i<t;i++)this.paintVertexArray.emplace(i,r[0],r[1])}else{for(let n=e;n<t;n++)this.paintVertexArray.emplace(n,i);this.maxValue=Math.max(this.maxValue,Math.abs(i))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Nl{constructor(e,t,i,n,r,o){this.expression=e,this.uniformNames=t.map((e=>`u_${e}_t`)),this.type=i,this.useIntegerZoom=n,this.context=r,this.maxValue=0,this.paintVertexAttributes=t.map((e=>({name:`a_${e}`,type:"Float32",components:"color"===i?4:2,offset:0}))),this.paintVertexArray=new o}populatePaintArray(e,t,i,n,r,o,s,a){const l=this.expression.evaluate(new Ss(this.context.zoom,{brightness:o,worldview:a}),t,{},r,n,s),c=this.expression.evaluate(new Ss(this.context.zoom+1,{brightness:o,worldview:a}),t,{},r,n,s),u=Ol(this.lutExpression,t,{},n,r,o,s,a),h=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(h,e,l,c,u?null:this.context.lut)}updatePaintArray(e,t,i,n,r,o,s,a){const l=this.expression.evaluate({zoom:this.context.zoom,brightness:s,worldview:a},i,n,void 0,r),c=this.expression.evaluate({zoom:this.context.zoom+1,brightness:s,worldview:a},i,n,void 0,r),u=Ol(this.lutExpression,i,n,r,void 0,s,void 0,a);this._setPaintValue(e,t,l,c,u?null:this.context.lut)}_setPaintValue(e,t,i,n,r){if("color"===this.type){const n=Rl(i.toPremultipliedRenderColor(r)),o=Rl(i.toPremultipliedRenderColor(r));for(let i=e;i<t;i++)this.paintVertexArray.emplace(i,n[0],n[1],o[0],o[1])}else{for(let r=e;r<t;r++)this.paintVertexArray.emplace(r,i,n);this.maxValue=Math.max(this.maxValue,Math.abs(i),Math.abs(n))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,t,i,n,r){const o=this.useIntegerZoom?Math.floor(i.zoom):i.zoom,s=De(this.expression.interpolationFactor(o,this.context.zoom,this.context.zoom+1),0,1);t.set(e,r,s)}getBinding(e,t){return new Tl(e)}}class kl{constructor(e,t,i,n,r){this.expression=e,this.layerId=r,this.paintVertexAttributes=("array"===i?ml:pl).members;for(let e=0;e<t.length;++e);this.paintVertexArray=new n,this.paintTransitionVertexArray=new wa}populatePaintArray(e,t,i,n){const r=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(r,e,t.patterns&&t.patterns[this.layerId],i)}updatePaintArray(e,t,i,n,r,o,s){this._setPaintValues(e,t,i.patterns&&i.patterns[this.layerId],o)}_setPaintValues(e,t,i,n){if(!n||!i)return;const r=n[i[0]],o=n[i[1]];if(r){if(r){const{tl:i,br:n,pixelRatio:o}=r;for(let r=e;r<t;r++)this.paintVertexArray.emplace(r,i[0],i[1],n[0],n[1],o)}if(o){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:i,br:n}=o;for(let r=e;r<t;r++)this.paintTransitionVertexArray.emplace(r,i[0],i[1],n[0],n[1])}}}upload(e){const t=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,t)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,fl.members,t))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Ul{constructor(e,t,i=()=>!0){this.binders={},this._buffers=[],this.context=t;const n=[];for(const r in e.paint._values){const o=e.paint.get(r);if(r.endsWith("-use-theme"))continue;if(!i(r))continue;if(!(o instanceof Rs&&Co(o.property.specification)))continue;const s=Gl(r,e.type),a=o.value,l=o.property.specification.type,c=!!o.property.useIntegerZoom,u="line-dasharray"===r||r.endsWith("pattern"),h=e.paint.get(`${r}-use-theme`),d="line-dasharray"===r&&"constant"!==e.layout.get("line-cap").value.kind||h&&"constant"!==h.value.kind;if("constant"!==a.kind||d)if("source"===a.kind||d||u){const t=$l(r,l,"source");this.binders[r]=u?new kl(a,s,l,t,e.id):new Fl(a,s,l,t),n.push(`/a_${r}`)}else{const e=$l(r,l,"composite");this.binders[r]=new Nl(a,s,l,c,t,e),n.push(`/z_${r}`)}else this.binders[r]=u?new Bl(a.value,s):new Dl(a.value,s,l,t),n.push(`/u_${r}`);h&&(this.binders[r].lutExpression=h.value)}this.cacheKey=n.sort().join("")}getMaxValue(e){const t=this.binders[e];return t instanceof Fl||t instanceof Nl?t.maxValue:0}populatePaintArrays(e,t,i,n,r,o,s,a){for(const l in this.binders){const c=this.binders[l];c.context=this.context,(c instanceof Fl||c instanceof Nl||c instanceof kl)&&c.populatePaintArray(e,t,i,n,r,o,s,a)}}setConstantPatternPositions(e,t){for(const i in this.binders){const n=this.binders[i];n instanceof Bl&&n.setConstantPatternPositions(e,t)}}getPatternTransitionVertexBuffer(e){const t=this.binders[e];return t instanceof kl?t.paintTransitionVertexBuffer:null}updatePaintArrays(e,t,i,n,r,o,s,a,l,c){let u=!1;const h=Object.keys(e),d=0!==h.length&&!a,p=d?h:t.uniqueIds;this.context.lut=r.lut;for(const a in this.binders){const h=this.binders[a];if(h.context=this.context,(h instanceof Fl||h instanceof Nl||h instanceof kl)&&h.expression&&h.expression.kind&&"constant"!==h.expression.kind&&(!0===h.expression.isStateDependent||!1===h.expression.isLightConstant)){const f=r.paint.get(a);h.expression=f.value;for(const i of p){const r=e[i.toString()];t.eachPosition(i,((e,t,i)=>{const a=n.feature(e);h.updatePaintArray(t,i,a,r,o,s,l,c)}))}if(!d)for(const t of i.uniqueIds){const r=e[t.toString()];i.eachPosition(t,((e,t,i)=>{const a=n.feature(e);h.updatePaintArray(t,i,a,r,o,s,l,c)}))}u=!0}}return u}defines(){const e=[];for(const t in this.binders){const i=this.binders[t];(i instanceof Dl||i instanceof Bl)&&e.push(...i.uniformNames.map((e=>`#define HAS_UNIFORM_${e}`)))}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const t=[];for(const i in this.binders){const n=this.binders[i];if(n instanceof Dl||n instanceof Bl||n instanceof Nl)for(const r of n.uniformNames)t.push({name:r,property:i,binding:n.getBinding(e,r)})}return t}setUniforms(e,t,i,n,r){for(const{name:t,property:o,binding:s}of i)this.binders[o].setUniform(e,s,r,n.get(o),t)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const t=this.binders[e];(t instanceof Fl||t instanceof Nl||t instanceof kl)&&t.paintVertexBuffer&&this._buffers.push(t.paintVertexBuffer),t instanceof kl&&t.paintTransitionVertexBuffer&&this._buffers.push(t.paintTransitionVertexBuffer)}}upload(e){for(const t in this.binders){const i=this.binders[t];(i instanceof Fl||i instanceof Nl||i instanceof kl)&&i.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const t=this.binders[e];(t instanceof Fl||t instanceof Nl||t instanceof kl)&&t.destroy()}}}class zl{constructor(e,t,i=()=>!0){this.programConfigurations={};for(const n of e)this.programConfigurations[n.id]=new Ul(n,t,i);this.needsUpload=!1,this._featureMap=new gl,this._featureMapWithoutIds=new gl,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,t,i,n,r,o,s,a,l){for(const i in this.programConfigurations)this.programConfigurations[i].populatePaintArrays(e,t,n,r,o,s,a,l);void 0!==t.id?this._featureMap.add(t.id,i,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,i,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,t,i,n,r,o,s,a){for(const l of i)this.needsUpload=this.programConfigurations[l.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,t,l,n,r,o,s||0,a)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const t in this.programConfigurations)this.programConfigurations[t].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const Vl={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function Gl(e,t){return Vl[e]||[e.replace(`${t}-`,"").replace(/-/g,"_")]}const jl={"line-pattern":{source:Ta,composite:Ta},"fill-pattern":{source:Ta,composite:Ta},"fill-extrusion-pattern":{source:Ta,composite:Ta},"line-dasharray":{source:wa,composite:wa}},Hl={color:{source:Ga,composite:Ma},number:{source:ga,composite:Ga}};function $l(e,t,i){const n=jl[e];return n&&n[i]||Hl[t][i]}es(Dl,"ConstantBinder"),es(Bl,"PatternConstantBinder"),es(Fl,"SourceExpressionBinder"),es(kl,"PatternCompositeBinder"),es(Nl,"CompositeExpressionBinder"),es(Ul,"ProgramConfiguration",{omit:["_buffers"]}),es(zl,"ProgramConfigurationSet");const Wl=zn/Math.PI/2,ql=5,Xl=6,Yl=16383,Zl=64,Jl=[Zl,32,16],Kl=-Wl,Ql=Wl;function ec(e,t,i,n=Wl){return i=Ie(i),[e*Math.sin(i)*n,-t*n,e*Math.cos(i)*n]}function tc(e,t,i){return ec(Math.cos(Ie(e)),Math.sin(Ie(e)),t,i)}const ic=6371008.8,nc=2*Math.PI*ic;class rc{constructor(e,t){if(isNaN(e)||isNaN(t))throw new Error(`Invalid LngLat object: (${e}, ${t})`);if(this.lng=+e,this.lat=+t,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new rc(Fe(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const t=Math.PI/180,i=this.lat*t,n=e.lat*t,r=Math.sin(i)*Math.sin(n)+Math.cos(i)*Math.cos(n)*Math.cos((e.lng-this.lng)*t);return ic*Math.acos(Math.min(r,1))}toBounds(e=0){const t=360*e/40075017,i=t/Math.cos(Math.PI/180*this.lat);return new oc({lng:this.lng-i,lat:this.lat-t},{lng:this.lng+i,lat:this.lat+t})}toEcef(e){return tc(this.lat,this.lng,Wl+e*Wl/ic)}static convert(e){if(e instanceof rc)return e;if(Array.isArray(e)&&(2===e.length||3===e.length))return new rc(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&"object"==typeof e&&null!==e)return new rc(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class oc{constructor(e,t){e&&(t?this.setSouthWest(e).setNorthEast(t):Array.isArray(e)&&4===e.length?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof rc?new rc(e.lng,e.lat):rc.convert(e),this}setSouthWest(e){return this._sw=e instanceof rc?new rc(e.lng,e.lat):rc.convert(e),this}extend(e){const t=this._sw,i=this._ne;let n,r;if(e instanceof rc)n=e,r=e;else{if(!(e instanceof oc))return Array.isArray(e)?4===e.length||e.every(Array.isArray)?this.extend(oc.convert(e)):this.extend(rc.convert(e)):"object"==typeof e&&null!==e&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(rc.convert(e)):this;if(n=e._sw,r=e._ne,!n||!r)return this}return t||i?(t.lng=Math.min(n.lng,t.lng),t.lat=Math.min(n.lat,t.lat),i.lng=Math.max(r.lng,i.lng),i.lat=Math.max(r.lat,i.lat)):(this._sw=new rc(n.lng,n.lat),this._ne=new rc(r.lng,r.lat)),this}getCenter(){return new rc((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new rc(this.getWest(),this.getNorth())}getSouthEast(){return new rc(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:t,lat:i}=rc.convert(e);let n=this._sw.lng<=t&&t<=this._ne.lng;return this._sw.lng>this._ne.lng&&(n=this._sw.lng>=t&&t>=this._ne.lng),this._sw.lat<=i&&i<=this._ne.lat&&n}static convert(e){if(e)return e instanceof oc?e:new oc(e)}}const sc=0,ac=25.5;function lc(e){return nc*Math.cos(e*Math.PI/180)}function cc(e){return(180+e)/360}function uc(e){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360}function hc(e,t){return e/lc(t)}function dc(e){return 360*e-180}function pc(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}function fc(e,t){return e*lc(pc(t))}const mc=85.051129;function gc(e){return Math.cos(Ie(De(e,-mc,mc)))}function _c(e,t){const i=De(t,sc,ac),n=Math.pow(2,i);return gc(e)*nc/(512*n)}function yc(e){return 1/Math.cos(e*Math.PI/180)}function vc(e,t=0){const i=Math.exp(Math.PI*(1-(e.y+t/zn)/(1<<e.z)*2));return 80150034*i/(i*i+1)/zn/(1<<e.z)}class xc{constructor(e,t,i=0){this.x=+e,this.y=+t,this.z=+i}static fromLngLat(e,t=0){const i=rc.convert(e);return new xc(cc(i.lng),uc(i.lat),hc(t,i.lat))}toLngLat(){return new rc(dc(this.x),pc(this.y))}toAltitude(){return fc(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/nc*yc(pc(this.y))}}function bc(e,t,i,n,r,o,s,a,l){const c=(t+n)/2,u=(i+r)/2,h=new Ee(c,u);a(h),function(e,t,i,n,r,o){const s=i-r,a=n-o;return Math.abs((n-t)*s-(i-e)*a)/Math.hypot(s,a)}(h.x,h.y,o.x,o.y,s.x,s.y)>=l?(bc(e,t,i,c,u,o,h,a,l),bc(e,c,u,n,r,h,s,a,l)):e.push(s)}function Tc(e,t,i){let n=e[0],r=n.x,o=n.y;t(n);const s=[n];for(let a=1;a<e.length;a++){const l=e[a],{x:c,y:u}=l;t(l),bc(s,r,o,c,u,n,l,t,i),r=c,o=u,n=l}return s}function wc(e,t,i,n){if(n(t,i)){const r=t.add(i)._mult(.5);wc(e,t,r,n),wc(e,r,i,n)}else e.push(i)}function Ec(e,t){let i=e[0];const n=[i];for(let r=1;r<e.length;r++){const o=e[r];wc(n,i,o,t),i=o}return n}const Sc=Math.pow(2,14)-1,Ac=-Sc-1;function Mc(e,t){const i=Math.round(e.x*t),n=Math.round(e.y*t);return e.x=De(i,Ac,Sc),e.y=De(n,Ac,Sc),(i<e.x||i>e.x+1||n<e.y||n>e.y+1)&&qe("Geometry exceeds allowed extent, reduce your vector tile buffer size"),e}function Ic(e,t,i){const n=e.loadGeometry(),r=e.extent,o=zn/r;if(t&&i&&i.projection.isReprojectedInTileSpace){const o=1<<t.z,{scale:s,x:a,y:l,projection:c}=i,u=e=>{const i=dc((t.x+e.x/r)/o),n=pc((t.y+e.y/r)/o),u=c.project(i,n);e.x=(u.x*s-a)*r,e.y=(u.y*s-l)*r};for(let t=0;t<n.length;t++)if(1!==e.type)n[t]=Tc(n[t],u,1);else{const e=[];for(const i of n[t])i.x<0||i.x>=r||i.y<0||i.y>=r||(u(i),e.push(i));n[t]=e}}for(const e of n)for(const t of e)Mc(t,o);return n}function Cc(e,t){return{type:e.type,id:e.id,properties:e.properties,geometry:t?Ic(e):[]}}class Pc{constructor(e,t,i,n,r){this.properties={},this.extent=i,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=n,this._values=r,e.readFields(Lc,this,t)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos,i=[];let n,r=1,o=0,s=0,a=0;for(;e.pos<t;){if(o<=0){const t=e.readVarint();r=7&t,o=t>>3}if(o--,1===r||2===r)s+=e.readSVarint(),a+=e.readSVarint(),1===r&&(n&&i.push(n),n=[]),n&&n.push(new Ee(s,a));else{if(7!==r)throw new Error(`unknown command ${r}`);n&&n.push(n[0].clone())}}return n&&i.push(n),i}bbox(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos;let i=1,n=0,r=0,o=0,s=1/0,a=-1/0,l=1/0,c=-1/0;for(;e.pos<t;){if(n<=0){const t=e.readVarint();i=7&t,n=t>>3}if(n--,1===i||2===i)r+=e.readSVarint(),o+=e.readSVarint(),r<s&&(s=r),r>a&&(a=r),o<l&&(l=o),o>c&&(c=o);else if(7!==i)throw new Error(`unknown command ${i}`)}return[s,l,a,c]}toGeoJSON(e,t,i){const n=this.extent*Math.pow(2,i),r=this.extent*e,o=this.extent*t,s=this.loadGeometry();function a(e){return[360*(e.x+r)/n-180,360/Math.PI*Math.atan(Math.exp((1-2*(e.y+o)/n)*Math.PI))-90]}function l(e){return e.map(a)}let c;if(1===this.type){const e=[];for(const t of s)e.push(t[0]);const t=l(e);c=1===e.length?{type:"Point",coordinates:t[0]}:{type:"MultiPoint",coordinates:t}}else if(2===this.type){const e=s.map(l);c=1===e.length?{type:"LineString",coordinates:e[0]}:{type:"MultiLineString",coordinates:e}}else{if(3!==this.type)throw new Error("unknown feature type");{const e=function(e){const t=e.length;if(t<=1)return[e];const i=[];let n,r;for(let o=0;o<t;o++){const t=Rc(e[o]);0!==t&&(void 0===r&&(r=t<0),r===t<0?(n&&i.push(n),n=[e[o]]):n&&n.push(e[o]))}return n&&i.push(n),i}(s),t=[];for(const i of e)t.push(i.map(l));c=1===t.length?{type:"Polygon",coordinates:t[0]}:{type:"MultiPolygon",coordinates:t}}}const u={type:"Feature",geometry:c,properties:this.properties};return null!=this.id&&(u.id=this.id),u}}function Lc(e,t,i){1===e?t.id=i.readVarint():2===e?function(e,t){const i=e.readVarint()+e.pos;for(;e.pos<i;){const i=t._keys[e.readVarint()],n=t._values[e.readVarint()];t.properties[i]=n}}(i,t):3===e?t.type=i.readVarint():4===e&&(t._geometry=i.pos)}function Rc(e){let t=0;for(let i,n,r=0,o=e.length,s=o-1;r<o;s=r++)i=e[r],n=e[s],t+=(n.x-i.x)*(i.y+n.y);return t}Pc.types=["Unknown","Point","LineString","Polygon"];class Oc{constructor(e,t){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Dc,this,t),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const t=this._pbf.readVarint()+this._pbf.pos;return new Pc(this._pbf,t,this.extent,this._keys,this._values)}}function Dc(e,t,i){15===e?t.version=i.readVarint():1===e?t.name=i.readString():5===e?t.extent=i.readVarint():2===e?t._features.push(i.pos):3===e?t._keys.push(i.readString()):4===e&&t._values.push(function(e){let t=null;const i=e.readVarint()+e.pos;for(;e.pos<i;){const i=e.readVarint()>>3;t=1===i?e.readString():2===i?e.readFloat():3===i?e.readDouble():4===i?e.readVarint64():5===i?e.readVarint():6===i?e.readSVarint():7===i?e.readBoolean():null}if(null==t)throw new Error("unknown feature value");return t}(i))}class Bc{constructor(e,t){this.layers=e.readFields(Fc,{},t)}}function Fc(e,t,i){if(3===e){const e=new Oc(i,i.readVarint()+i.pos);e.length&&(t[e.name]=e)}}const Nc="3d_elevation_id",kc="level";class Uc{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry(e,t){return this._valid&&e(t(this._geometry)),this}require(e,t,i){return this.get(e,!0,t,i)}optional(e,t,i){return this.get(e,!1,t,i)}success(){return this._valid}get(e,t,i,n){const r=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&void 0!==r&&!Number.isNaN(r)?i(n?n(r):r):t&&(this._valid=!1),this}}class zc{constructor(e,t){this.featureFunc=e,this.vertexFunc=t}parseFeature(e,t,i){return this.featureFunc(e,t,i)}parseVertex(e,t,i){return this.vertexFunc(e,t,i)}}const Vc=new zc(((e,t,i)=>e.reset(t).require(Nc,(e=>{i.id=e})).optional("fixed_height_relative",(e=>{i.constantHeight=e}),jc.decodeRelativeHeight).geometry((e=>{i.bounds=e}),yn).success()),((e,t,i)=>e.reset(t).require(Nc,(e=>{i.id=e})).require("elevation_idx",(e=>{i.idx=e})).require("extent",(e=>{i.extent=e})).require("height_relative",(e=>{i.height=e}),jc.decodeRelativeHeight).geometry((e=>{i.position=e}),jc.getPoint).success())),Gc=new zc(((e,t,i)=>e.reset(t).require(Nc,(e=>{i.id=e})).optional("fixed_height",(e=>{i.constantHeight=e}),jc.decodeMetricHeight).geometry((e=>{i.bounds=e}),yn).success()),((e,t,i)=>e.reset(t).require(Nc,(e=>{i.id=e})).require("elevation_idx",(e=>{i.idx=e})).require("extent",(e=>{i.extent=e})).require("height",(e=>{i.height=e}),jc.decodeMetricHeight).geometry((e=>{i.position=e}),jc.getPoint).success()));class jc{static getPoint(e){return ue(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static getVersionSchema(e){return e?"1.0.1"===e?Gc:void 0:Vc}static parse(e){const t=[],i=[],n=e.length,r=new Uc;for(let o=0;o<n;o++){const n=e.feature(o),s=n.properties.version,a=jc.getVersionSchema(s);if(void 0===a){qe(`Unknown elevation feature version number ${s||"(unknown)"}`);continue}const l=n.properties.type;if(!l)continue;const c=Pc.types[n.type];if("Point"===c&&"curve_point"===l){const e={};a.parseVertex(r,n,e)&&t.push(e)}else if("Polygon"===c&&"curve_meta"===l){const e={};a.parseFeature(r,n,e)&&i.push(e)}}return{vertices:t,features:i}}}class Hc{constructor(e,t){this.pos=e,this.dir=t}intersectsPlane(e,t,i){const n=_e(t,this.dir);if(Math.abs(n)<1e-6)return!1;const r=((e[0]-this.pos[0])*t[0]+(e[1]-this.pos[1])*t[1])/n;return i[0]=this.pos[0]+this.dir[0]*r,i[1]=this.pos[1]+this.dir[1]*r,!0}}class $c{constructor(e,t){this.pos=e,this.dir=t}intersectsPlane(e,t,i){const n=U(t,this.dir);if(Math.abs(n)<1e-6)return!1;const r=((e[0]-this.pos[0])*t[0]+(e[1]-this.pos[1])*t[1]+(e[2]-this.pos[2])*t[2])/n;return i[0]=this.pos[0]+this.dir[0]*r,i[1]=this.pos[1]+this.dir[1]*r,i[2]=this.pos[2]+this.dir[2]*r,!0}closestPointOnSphere(e,i,n){if(function(e,i){var n=e[0],r=e[1],o=e[2],s=i[0],a=i[1],l=i[2];return Math.abs(n-s)<=t*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-a)<=t*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(o-l)<=t*Math.max(1,Math.abs(o),Math.abs(l))}(this.pos,e)||0===i)return n[0]=n[1]=n[2]=0,!1;const[r,o,s]=this.dir,a=this.pos[0]-e[0],l=this.pos[1]-e[1],c=this.pos[2]-e[2],u=r*r+o*o+s*s,h=2*(a*r+l*o+c*s),d=h*h-4*u*(a*a+l*l+c*c-i*i);if(d<0){const e=Math.max(-h/2,0),t=a+r*e,u=l+o*e,d=c+s*e,p=Math.hypot(t,u,d);return n[0]=t*i/p,n[1]=u*i/p,n[2]=d*i/p,!1}{const e=(-h-Math.sqrt(d))/(2*u);if(e<0){const e=Math.hypot(a,l,c);return n[0]=a*i/e,n[1]=l*i/e,n[2]=c*i/e,!1}return n[0]=a+r*e,n[1]=l+o*e,n[2]=c+s*e,!0}}}class Wc{constructor(e,t,i,n,r){this.TL=e,this.TR=t,this.BR=i,this.BL=n,this.horizon=r}static fromInvProjectionMatrix(e,t,i){const n=[-1,1,1],r=[1,1,1],o=[1,-1,1],s=[-1,-1,1],a=G(n,n,e),l=G(r,r,e),c=G(o,o,e),u=G(s,s,e);return new Wc(a,l,c,u,t/i)}}function qc(e,t,i){let n=1/0,r=-1/0;const o=[];for(const s of e){q(o,s,t);const e=U(o,i);n=Math.min(n,e),r=Math.max(r,e)}return[n,r]}function Xc(e,t){let i=!0;for(let n=0;n<e.planes.length;n++){const r=e.planes[n];let o=0;for(let e=0;e<t.length;e++)o+=+(U(r,t[e])+r[3]>=0);if(0===o)return 0;o!==t.length&&(i=!1)}return i?2:1}function Yc(e,t){for(const i of e.projections){const n=qc(t,e.points[0],i.axis);if(i.projection[1]<n[0]||i.projection[0]>n[1])return 0}return 1}function Zc(e,t){let i=0;const n=[0,0,0,0];for(let s=0;s<e.length;s++)n[0]=e[s][0],n[1]=e[s][1],n[2]=e[s][2],n[3]=1,(r=n)[0]*(o=t)[0]+r[1]*o[1]+r[2]*o[2]+r[3]*o[3]>=0&&i++;var r,o;return i}class Jc{constructor(e,t){this.points=e||new Array(8).fill([0,0,0]),this.planes=t||new Array(6).fill([0,0,0,0]),this.bounds=Kc.fromPoints(this.points),this.projections=[],this.frustumEdges=[q([],this.points[2],this.points[3]),q([],this.points[0],this.points[3]),q([],this.points[4],this.points[0]),q([],this.points[5],this.points[1]),q([],this.points[6],this.points[2]),q([],this.points[7],this.points[3])];for(const e of this.frustumEdges){const t=[0,-e[2],e[1]],i=[e[2],0,-e[0]];this.projections.push({axis:t,projection:qc(this.points,this.points[0],t)}),this.projections.push({axis:i,projection:qc(this.points,this.points[0],i)})}}static fromInvProjectionMatrix(e,t,i,n){const r=Math.pow(2,i),o=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((i=>{const o=Q([],i,e),s=1/o[3]/t*r;return(a=o)[0]=(l=o)[0]*(c=[s,s,n?1/o[3]:s,s])[0],a[1]=l[1]*c[1],a[2]=l[2]*c[2],a[3]=l[3]*c[3],a;var a,l,c})),s=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((e=>{const t=k([],z([],q([],o[e[0]],o[e[1]]),q([],o[e[2]],o[e[1]]))),i=-U(t,o[e[1]]);return t.concat(i)})),a=[];for(let e=0;e<o.length;e++)a.push([o[e][0],o[e][1],o[e][2]]);return new Jc(a,s)}intersectsPrecise(e,t,i){for(let i=0;i<t.length;i++)if(!Zc(e,t[i]))return 0;for(let t=0;t<this.planes.length;t++)if(!Zc(e,this.planes[t]))return 0;for(const t of i)for(const i of this.frustumEdges){const n=z([],t,i),r=E(n);if(0===r)continue;R(n,n,1/r);const o=qc(this.points,this.points[0],n),s=qc(e,this.points[0],n);if(o[0]>s[1]||s[0]>o[1])return 0}return 1}containsPoint(e){for(const t of this.planes){const i=t[3];if(U([t[0],t[1],t[2]],e)+i<0)return!1}return!0}}class Kc{static fromPoints(e){const t=[1/0,1/0,1/0],i=[-1/0,-1/0,-1/0];for(const n of e)P(t,t,n),L(i,i,n);return new Kc(t,i)}static fromTileIdAndHeight(e,t,i){const n=1<<e.canonical.z,r=e.canonical.x,o=e.canonical.y;return new Kc([r/n,o/n,t],[(r+1)/n,(o+1)/n,i])}static applyTransform(e,t){const i=e.getCorners();for(let e=0;e<i.length;++e)G(i[e],i[e],t);return Kc.fromPoints(i)}static applyTransformFast(e,t){const i=[t[12],t[13],t[14]],n=[...i];for(let r=0;r<3;r++)for(let o=0;o<3;o++){const s=t[4*o+r],a=s*e.min[o],l=s*e.max[o];i[r]+=Math.min(a,l),n[r]+=Math.max(a,l)}return new Kc(i,n)}static projectAabbCorners(e,t){const i=e.getCorners();for(let e=0;e<i.length;++e)G(i[e],i[e],t);return i}constructor(e,t){this.min=e,this.max=t,this.center=R([],M([],this.min,this.max),.5)}quadrant(e){const t=[e%2==0,e<2],i=w(this.min),n=w(this.max);for(let e=0;e<t.length;e++)i[e]=t[e]?this.min[e]:this.center[e],n[e]=t[e]?this.center[e]:this.max[e];return n[2]=this.max[2],new Kc(i,n)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,t=this.max;return[[e[0],e[1],e[2]],[t[0],e[1],e[2]],[t[0],t[1],e[2]],[e[0],t[1],e[2]],[e[0],e[1],t[2]],[t[0],e[1],t[2]],[t[0],t[1],t[2]],[e[0],t[1],t[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Xc(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Xc(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,t){return t||this.intersects(e)?Yc(e,this.getCorners()):0}intersectsPreciseFlat(e,t){return t||this.intersectsFlat(e)?Yc(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let t=0;t<3;++t)if(this.min[t]>e.max[t]||e.min[t]>this.max[t])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let t=0;t<3;t++)this.min[t]=Math.min(this.min[t],e.min[t]),this.max[t]=Math.max(this.max[t],e.max[t])}encapsulatePoint(e){for(let t=0;t<3;t++)this.min[t]=Math.min(this.min[t],e[t]),this.max[t]=Math.max(this.max[t],e[t])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}es(Kc,"Aabb");class Qc{constructor(e,t){this.feature=e,this.metersToTile=t,this.index=0}get(){const e=this.feature.vertices[this.index],t=this.feature.vertexProps[this.index].dir,i=t[1],n=-t[0],r=(e.extent+1)*this.metersToTile;return[new Ee(Math.trunc(e.position[0]+i*r),Math.trunc(e.position[1]+n*r)),new Ee(Math.trunc(e.position[0]-i*r),Math.trunc(e.position[1]-n*r))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class eu{constructor(e,t,i,n,r,o){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[ce(),ce(),ce(),ce(),ce(),ce(),ce()],this.id=e,this.heightRange={min:i,max:i},this.safeArea=t,this.constantHeight=i,null==this.constantHeight&&(null!=this.constantHeight||0!==n.length)){this.vertices=n,this.edges=r,this.edges=this.edges.filter((e=>{return e.a<this.vertices.length&&e.b<this.vertices.length&&!((t=this.vertices[e.a].position)[0]===(i=this.vertices[e.b].position)[0]&&t[1]===i[1]);var t,i})),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const e of this.vertices)this.vertexProps.push({dir:ue(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,e.height),this.heightRange.max=Math.max(this.heightRange.max,e.height);for(const e of this.edges){const t=this.vertices[e.a].position,i=this.vertices[e.b].position,n=pe(ce(),i,t),r=me(n),o=fe(ce(),n,1/r);this.edgeProps.push({vec:n,dir:o,len:r});const s=this.vertexProps[e.a].dir,a=this.vertexProps[e.b].dir;de(s,s,o),de(a,a,o)}for(const e of this.vertexProps)0===e.dir[0]&&0===e.dir[1]||ge(e.dir,e.dir);this.tessellate(o)}}pointElevation(e){if(null!=this.constantHeight)return this.constantHeight;const t=this.getClosestEdge(e);if(null==t)return 0;const[i,n]=t;return di(this.vertices[this.edges[i].a].height,this.vertices[this.edges[i].b].height,n)}computeSlopeNormal(e,t){const i=this.getClosestEdge(e);if(!i)return S(0,0,1);const n=i[0],r=this.edges[n],o=this.edgeProps[n].vec,s=S(o[0],o[1],(this.vertices[r.b].height-this.vertices[r.a].height)*t),a=S(s[1],-s[0],0);z(a,a,s);const l=E(a);return l>0?R(a,a,1/l):A(a,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(0===this.edges.length)return;let t=0,i=Number.POSITIVE_INFINITY,n=0;const[r,o,s,a,l,c,u]=this._tmpVec2;he(u,e.x,e.y);const h=new Hc(u,null);for(let e=0;e<this.edges.length;e++){const d=this.edges[e],p=this.edgeProps[e].dir;h.dir=p;const f=this.vertices[d.a].position,m=this.vertices[d.b].position,g=h.intersectsPlane(f,this.vertexProps[d.a].dir,r),_=h.intersectsPlane(m,this.vertexProps[d.b].dir,o);if(!g||!_)continue;pe(s,o,r),pe(a,u,r);const y=_e(s,s),v=y>0?_e(a,s)/y:0,x=De(v,0,1),b=Math.abs((v-x)*this.edgeProps[e].len);pe(l,u,f),he(c,p[1],-p[0]);const T=b+Math.abs(_e(l,c));T<i&&(t=e,i=T,n=x)}return[t,n]}tessellate(e){const t=T(),i=T(),n=T(),r=T();for(let o=this.edges.length-1;o>=0;--o){const s=this.edges[o].a,a=this.edges[o].b,{position:l,height:c,extent:u}=this.vertices[s],{position:h,height:d,extent:p}=this.vertices[a],f=this.vertexProps[s].dir,m=this.vertexProps[a].dir;if(A(t,l[0]/e,l[1]/e,c),A(i,h[0]/e,h[1]/e,d),A(n,f[1],-f[0],0),R(n,n,u),A(r,m[1],-m[0],0),R(r,r,p),this.distSqLines(S(t[0]+.5*n[0],t[1]+.5*n[1],t[2]+.5*n[2]),S(i[0]-.5*r[0],i[1]-.5*r[1],i[2]-.5*r[2]),S(t[0]-.5*n[0],t[1]-.5*n[1],t[2]-.5*n[2]),S(i[0]+.5*r[0],i[1]+.5*r[1],i[2]+.5*r[2]))<=.0025000000000000005)continue;const g=this.vertices.length,_=de(ce(),l,h);this.vertices.push({position:fe(_,_,.5),height:.5*(c+d),extent:.5*(u+p)});const y=de(ce(),f,m);this.vertexProps.push({dir:ge(y,y)}),this.edges.splice(o,1),this.edgeProps.splice(o,1),this.edges.push({a:s,b:g}),this.edges.push({a:g,b:a});const v=pe(ce(),this.vertices[g].position,l),x=me(v),b={vec:v,dir:fe(ce(),v,1/x),len:x};this.edgeProps.push(b),this.edgeProps.push(b)}}distSqLines(e,t,i,n){const r=I(T(),t,e),o=I(T(),n,i),s=I(T(),e,i),a=U(r,r),l=U(r,o),c=U(r,s),u=U(o,o),h=U(o,s),d=a*u-l*l;if(0===d)return B(V(r,i,n,U(s,o)/U(o,o)),e);const p=(a*h-l*c)/d;return B(V(r,e,t,(l*h-c*u)/d),V(o,i,n,p))}}class tu{static parseFrom(e,t){const i=jc.parse(e);if(!i)return[];let{vertices:n,features:r}=i;const o=1/vc(t);r.sort(((e,t)=>e.id-t.id)),n.sort(((e,t)=>e.id-t.id||e.idx-t.idx)),n=n.filter(((e,t,i)=>t===i.findIndex((t=>t.id===e.id&&t.idx===e.idx))));const s=new Array;let a=0;const l=n.length;for(const e of r){if(e.constantHeight){s.push(new eu(e.id,e.bounds,e.constantHeight));continue}for(;a!==l&&n[a].id<e.id;)a++;if(a===l||n[a].id!==e.id)continue;const t=new Array,i=new Array,r=a;for(;a!==l&&n[a].id===e.id;){const e=n[a];if(t.push({position:e.position,height:e.height,extent:e.extent}),a!==r&&n[a-1].idx===e.idx-1){const e=a-r;i.push({a:e-1,b:e})}a++}s.push(new eu(e.id,e.bounds,void 0,t,i,o))}return s}static getElevationFeature(e,t){if(!t)return;const i=+e.properties[Nc];return Number.isNaN(i)?void 0:t.find((e=>e.id===i))}}class iu{constructor(e,t){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(t)||(this.zScale=Math.pow(2,t.z-e.z),this.xOffset=(e.x*this.zScale-t.x)*zn,this.yOffset=(e.y*this.zScale-t.y)*zn)}constantElevation(e,t){if(null!=e.constantHeight)return this.computeBiasedHeight(e.constantHeight,t)}pointElevation(e,t,i){const n=this.constantElevation(t,i);return null!=n?n:(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(t.pointElevation(e),i))}computeBiasedHeight(e,t){return t<=0?e:e+t*Be(0,t,e>=0?e:Math.abs(.5*e))}}es(eu,"ElevationFeature");class nu{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new pa,this.indexArray=new Da,this.segments=new hl,this.programConfigurations=new zl(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,"none"!==this.elevationMode&&(this.elevatedLayoutVertexArray=new ga),this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,i,n){}populate(e,t,i,n){const r=this.layers[0],o=[];let s=null;"circle"===r.type&&(s=r.layout.get("circle-sort-key"));for(const{feature:r,id:a,index:l,sourceLayerIndex:c}of e){const e=this.layers[0]._featureFilter.needGeometry,u=Cc(r,e);if(!this.layers[0]._featureFilter.filter(new Ss(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),u,i))continue;const h=s?s.evaluate(u,{},i):void 0,d={id:a,properties:r.properties,type:r.type,sourceLayerIndex:c,index:l,geometry:e?u.geometry:Ic(r,i,n),patterns:{},sortKey:h};o.push(d)}s&&o.sort(((e,t)=>e.sortKey-t.sortKey));let a=null;"globe"===n.projection.name&&(this.globeExtVertexArray=new Ea,a=n.projection);for(const n of o){const{geometry:r,index:o,sourceLayerIndex:s}=n,l=e[o].feature;this.addFeature(n,r,o,t.availableImages,i,a,t.brightness,t.elevationFeatures),t.featureIndex.insert(l,r,o,s,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,t,i,n,r,o,s){this.programConfigurations.updatePaintArrays(e,t,r,i,n,o,s,this.worldview)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,ll.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,ul.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,cl.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,t,i,n,r,o,s,a){let l;"none"!==this.elevationMode&&(l=tu.getElevationFeature(e,a));for(const i of t)for(const t of i){const i=t.x,n=t.y;if(i<0||i>=zn||n<0||n>=zn)continue;if(o){const e=o.projectTilePoint(i,n,r),t=o.upVector(r,i,n);this.addGlobeExtVertex(e,t),this.addGlobeExtVertex(e,t),this.addGlobeExtVertex(e,t),this.addGlobeExtVertex(e,t)}const s=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),a=s.vertexLength;if(this.addCircleVertex(i,n,-1,-1),this.addCircleVertex(i,n,1,-1),this.addCircleVertex(i,n,1,1),this.addCircleVertex(i,n,-1,1),"none"!==this.elevationMode){const e=l?l.pointElevation(new Ee(i,n)):0;this.hasElevation=this.hasElevation||0!==e;for(let t=0;t<4;t++)this.elevatedLayoutVertexArray.emplaceBack(e)}this.indexArray.emplaceBack(a,a+1,a+2),this.indexArray.emplaceBack(a,a+2,a+3),s.vertexLength+=4,s.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,{},n,r,s,void 0,this.worldview)}addCircleVertex(e,t,i,n){this.layoutVertexArray.emplaceBack(2*e+(i+1)/2,2*t+(n+1)/2)}addGlobeExtVertex(e,t){const i=16384;this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,t[0]*i,t[1]*i,t[2]*i)}}function ru(e,t){for(let i=0;i<e.length;i++)if(mu(t,e[i]))return!0;for(let i=0;i<t.length;i++)if(mu(e,t[i]))return!0;return!!lu(e,t)}function ou(e,t,i){return!!mu(e,t)||!!du(t,e,i)}function su(e,t){if(1===e.length)return fu(t,e[0]);for(let i=0;i<t.length;i++){const n=t[i];for(let t=0;t<n.length;t++)if(mu(e,n[t]))return!0}for(let i=0;i<e.length;i++)if(fu(t,e[i]))return!0;for(let i=0;i<t.length;i++)if(lu(e,t[i]))return!0;return!1}function au(e,t,i){if(e.length>1){if(lu(e,t))return!0;for(let n=0;n<t.length;n++)if(du(t[n],e,i))return!0}for(let n=0;n<e.length;n++)if(du(e[n],t,i))return!0;return!1}function lu(e,t){if(0===e.length||0===t.length)return!1;for(let i=0;i<e.length-1;i++){const n=e[i],r=e[i+1];for(let e=0;e<t.length-1;e++)if(cu(n,r,t[e],t[e+1]))return!0}return!1}function cu(e,t,i,n){return Xe(e,i,n)!==Xe(t,i,n)&&Xe(e,t,i)!==Xe(e,t,n)}function uu(e,t,i){return(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x)}function hu(e,t,i,n){const r=uu(e,t,n),o=uu(e,t,i);if(Math.sign(r)===Math.sign(o))return;const s=uu(i,n,e),a=s+o-r;return Math.sign(s)!==Math.sign(a)?[s/(s-a),o/(o-r)]:void 0}function du(e,t,i){const n=i*i;if(1===t.length)return e.distSqr(t[0])<n;for(let i=1;i<t.length;i++)if(pu(e,t[i-1],t[i])<n)return!0;return!1}function pu(e,t,i){const n=t.distSqr(i);if(0===n)return e.distSqr(t);const r=((e.x-t.x)*(i.x-t.x)+(e.y-t.y)*(i.y-t.y))/n;return e.distSqr(r<0?t:r>1?i:i.sub(t)._mult(r)._add(t))}function fu(e,t){let i,n,r,o=!1;for(let s=0;s<e.length;s++){i=e[s];for(let e=0,s=i.length-1;e<i.length;s=e++)n=i[e],r=i[s],n.y>t.y!=r.y>t.y&&t.x<(r.x-n.x)*(t.y-n.y)/(r.y-n.y)+n.x&&(o=!o)}return o}function mu(e,t){let i=!1;for(let n=0,r=e.length-1;n<e.length;r=n++){const o=e[n],s=e[r];o.y>t.y!=s.y>t.y&&t.x<(s.x-o.x)*(t.y-o.y)/(s.y-o.y)+o.x&&(i=!i)}return i}function gu(e,t,i,n,r){for(const o of e)if(t<=o.x&&i<=o.y&&n>=o.x&&r>=o.y)return!0;const o=[new Ee(t,i),new Ee(t,r),new Ee(n,r),new Ee(n,i)];if(e.length>2)for(const t of o)if(mu(e,t))return!0;for(let t=0;t<e.length-1;t++)if(_u(e[t],e[t+1],o))return!0;return!1}function _u(e,t,i){const n=i[0],r=i[2];if(e.x<n.x&&t.x<n.x||e.x>r.x&&t.x>r.x||e.y<n.y&&t.y<n.y||e.y>r.y&&t.y>r.y)return!1;const o=Xe(e,t,i[0]);return o!==Xe(e,t,i[1])||o!==Xe(e,t,i[2])||o!==Xe(e,t,i[3])}function yu(e,t,i,n,r,o){let s=t.y-e.y,a=e.x-t.x;if(o=o||0){const e=s*s+a*a;if(0===e)return!0;const t=Math.sqrt(e);s/=t,a/=t}return!((i.x-e.x)*s+(i.y-e.y)*a-o<0||(n.x-e.x)*s+(n.y-e.y)*a-o<0||(r.x-e.x)*s+(r.y-e.y)*a-o<0)}function vu(e,t,i,n,r,o,s){return!(yu(e,t,n,r,o,s)||yu(t,i,n,r,o,s)||yu(i,e,n,r,o,s)||yu(n,r,e,t,i,s)||yu(r,o,e,t,i,s)||yu(o,n,e,t,i,s))}function xu(e,t,i){const n=t.paint.get(e).value;return"constant"===n.kind?n.value:i.programConfigurations.get(t.id).getMaxValue(e)}function bu(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function Tu(e,t,i,n,r){if(!t[0]&&!t[1])return e;const o=Ee.convert(t)._mult(r);"viewport"===i&&o._rotate(-n);const s=[];for(let t=0;t<e.length;t++)s.push(e[t].sub(o));return s}function wu(e,t,i,n){const r=Ee.convert(e)._mult(n);return"viewport"===t&&r._rotate(-i),r}let Eu,Su;function Au(e,t,i){var n=2*Math.PI*6378137/256/Math.pow(2,i);return[e*n-2*Math.PI*6378137/2,t*n-2*Math.PI*6378137/2]}es(nu,"CircleBucket",{omit:["layers"]});class Mu{constructor(e,t,i){this.z=e,this.x=t,this.y=i,this.key=Pu(0,e,e,t,i)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const t=this.z-e.z;return 0===e.z||e.z<this.z&&e.x===this.x>>t&&e.y===this.y>>t}url(e,t){const i=function(e,t,i){var n=Au(256*e,256*(t=Math.pow(2,i)-t-1),i),r=Au(256*(e+1),256*(t+1),i);return n[0]+","+n[1]+","+r[0]+","+r[1]}(this.x,this.y,this.z),n=function(e,t,i){let n,r="";for(let o=e;o>0;o--)n=1<<o-1,r+=(t&n?1:0)+(i&n?2:0);return r}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===t?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",n).replace("{bbox-epsg-3857}",i)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Iu{constructor(e,t){this.wrap=e,this.canonical=t,this.key=Pu(e,t.z,t.z,t.x,t.y)}}class Cu{constructor(e,t,i,n,r){this.overscaledZ=e,this.wrap=t,this.canonical=new Mu(i,+n,+r),this.key=0===t&&e===i?this.canonical.key:Pu(t,e,i,n,r)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const t=this.canonical.z-e;return e>this.canonical.z?new Cu(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Cu(e,this.wrap,e,this.canonical.x>>t,this.canonical.y>>t)}calculateScaledKey(e,t=!0){if(this.overscaledZ===e&&t)return this.key;if(e>this.canonical.z)return Pu(this.wrap*+t,e,this.canonical.z,this.canonical.x,this.canonical.y);{const i=this.canonical.z-e;return Pu(this.wrap*+t,e,e,this.canonical.x>>i,this.canonical.y>>i)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const t=this.canonical.z-e.canonical.z;return 0===e.overscaledZ||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>t&&e.canonical.y===this.canonical.y>>t}children(e){if(this.overscaledZ>=e)return[new Cu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const t=this.canonical.z+1,i=2*this.canonical.x,n=2*this.canonical.y;return[new Cu(t,this.wrap,t,i,n),new Cu(t,this.wrap,t,i+1,n),new Cu(t,this.wrap,t,i,n+1),new Cu(t,this.wrap,t,i+1,n+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Cu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Cu(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Iu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Pu(e,t,i,n,r){const o=1<<Math.min(i,22);let s=o*(r%o)+n%o;return e&&i<22&&(s+=o*o*((e<0?-2*e-1:2*e)%(1<<2*(22-i)))),16*(32*s+i)+(t-i)}const Lu=[e=>{let t=e.canonical.x-1,i=e.wrap;return t<0&&(t=(1<<e.canonical.z)-1,i--),new Cu(e.overscaledZ,i,e.canonical.z,t,e.canonical.y)},e=>{let t=e.canonical.x+1,i=e.wrap;return t===1<<e.canonical.z&&(t=0,i++),new Cu(e.overscaledZ,i,e.canonical.z,t,e.canonical.y)},e=>new Cu(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,(0===e.canonical.y?1<<e.canonical.z:e.canonical.y)-1),e=>new Cu(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y===(1<<e.canonical.z)-1?0:e.canonical.y+1)];es(Mu,"CanonicalTileID"),es(Cu,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Ru=ha([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Ou}=Ru,Du=ha([{name:"a_pos_3",components:3,type:"Int16"}]);var Bu=ha([{name:"a_pos",type:"Int16",components:2}]);function Fu(e){return e*Wl/ic}const Nu=[new Kc([Kl,Kl,Kl],[Ql,Ql,Ql]),new Kc([Kl,Kl,Kl],[0,0,Ql]),new Kc([0,Kl,Kl],[Ql,0,Ql]),new Kc([Kl,0,Kl],[0,Ql,Ql]),new Kc([0,0,Kl],[Ql,Ql,Ql])];function ku(e,t,i,n=!0){const r=R([],e._camera.position,e.worldSize),o=[t,i,1,1];Q(o,o,e.pixelMatrixInverse),J(o,o,1/o[3]);const s=k([],q([],o,r)),a=e.globeMatrix,l=[a[12],a[13],a[14]],c=q([],l,r),u=E(c),h=k([],c),d=e.worldSize/(2*Math.PI),p=U(h,s),f=Math.asin(d/u);if(f<Math.acos(p)){if(!n)return null;const e=[],t=[];R(e,s,u/p),k(t,q(t,e,c)),k(s,M(s,c,R(s,t,Math.tan(f)*u)))}const m=[];new $c(r,s).closestPointOnSphere(l,d,m);const g=k([],et(a,0)),_=k([],et(a,1)),y=k([],et(a,2)),v=U(g,m),x=U(_,m),b=U(y,m),T=Ce(Math.asin(-x/d));let w=Ce(Math.atan2(v,b));w=e.center.lng+function(e,t){const i=(t-e+180)%360-180;return i<-180?i+360:i}(e.center.lng,w);const S=cc(w),A=De(uc(T),0,1);return new xc(S,A)}class Uu{constructor(e,t,i){this.a=q([],e,i),this.b=q([],t,i),this.center=i;const n=k([],this.a),r=k([],this.b);this.angle=Math.acos(U(n,r))}}function zu(e,t){if(0===e.angle)return null;let i;return i=0===e.a[t]?1/e.angle*.5*Math.PI:1/e.angle*Math.atan(e.b[t]/e.a[t]/Math.sin(e.angle)-1/Math.tan(e.angle)),i<0||i>1?null:function(e,t,i,n){const r=Math.sin(i);return e*(Math.sin((1-n)*i)/r)+t*(Math.sin(n*i)/r)}(e.a[t],e.b[t],e.angle,De(i,0,1))+e.center[t]}function Vu(e){if(e.z<=1)return Nu[e.z+2*e.y+e.x];const t=Wu($u(e));return Kc.fromPoints(t)}function Gu(e,t,i){return R(e,e,1-i),O(e,e,t,i)}function ju(e,t,i){for(const n of e)G(n,n,t),R(n,n,i)}function Hu(e,t,i,n){const r=t/e.worldSize,o=e.globeMatrix;if(i.z<=1){const e=Vu(i).getCorners();return ju(e,o,r),Kc.fromPoints(e)}const s=$u(i,n),a=Wu(s,Wl+Fu(e._tileCoverLift));ju(a,o,r);const l=Number.MAX_VALUE,c=[-l,-l,-l],u=[l,l,l];if(s.contains(e.center)){for(const e of a)P(u,u,e),L(c,c,e);c[2]=0;const t=e.point,i=[t.x*r,t.y*r,0];return P(u,u,i),L(c,c,i),new Kc(u,c)}if(e._tileCoverLift>0){for(const e of a)P(u,u,e),L(c,c,e);return new Kc(u,c)}const h=[o[12]*r,o[13]*r,o[14]*r],d=s.getCenter(),p=De(e.center.lat,-mc,mc),f=De(d.lat,-mc,mc),m=cc(e.center.lng),g=uc(p);let _=m-cc(d.lng);const y=g-uc(f);_>.5?_-=1:_<-.5&&(_+=1);let v=0;Math.abs(_)>Math.abs(y)?v=_>=0?1:3:(v=y>=0?0:2,O(h,h,[o[4]*r,o[5]*r,o[6]*r],-Math.sin(Ie(y>=0?s.getSouth():s.getNorth()))*Wl));const x=a[v],b=a[(v+1)%4],T=new Uu(x,b,h),w=[zu(T,0)||x[0],zu(T,1)||x[1],zu(T,2)||x[2]],E=th(e.zoom);if(E>0){const n=function({x:e,y:t,z:i},n,r,o,s){const a=1/(1<<i);let l=e*a,c=l+a,u=t*a,h=u+a,d=0;const p=(l+c)/2-o;return p>.5?d=-1:p<-.5&&(d=1),l=((l+d)*n-(o*=n))*r+o,c=((c+d)*n-o)*r+o,u=(u*n-(s*=n))*r+s,h=(h*n-s)*r+s,[[l,h,0],[c,h,0],[c,u,0],[l,u,0]]}(i,t,e._pixelsPerMercatorPixel,m,g);for(let e=0;e<a.length;e++)Gu(a[e],n[e],E);const r=M([],n[v],n[(v+1)%4]);R(r,r,.5),Gu(w,r,E)}for(const e of a)P(u,u,e),L(c,c,e);return u[2]=Math.min(x[2],b[2]),P(u,u,w),L(c,c,w),new Kc(u,c)}function $u({x:e,y:t,z:i},n=!1){const r=1/(1<<i),o=new rc(dc(e*r),t===(1<<i)-1&&n?-90:pc((t+1)*r)),s=new rc(dc((e+1)*r),0===t&&n?90:pc(t*r));return new oc(o,s)}function Wu(e,t=Wl){const i=Ie(e.getNorth()),n=Ie(e.getSouth()),r=Math.cos(i),o=Math.cos(n),s=Math.sin(i),a=Math.sin(n),l=e.getWest(),c=e.getEast();return[ec(o,a,l,t),ec(o,a,c,t),ec(r,s,c,t),ec(r,s,l,t)]}function qu(e,t,i,n){const r=1<<i.z,o=(e/zn+i.x)/r;return tc(pc((t/zn+i.y)/r),dc(o),n)}function Xu({min:e,max:t}){return Yl/Math.max(t[0]-e[0],t[1]-e[1],t[2]-e[2])}const Yu=new Float64Array(16);function Zu(e){const t=Xu(e),i=_(Yu,[t,t,t]);return d(i,i,N([],e.min))}function Ju(e){const t=(n=e.min,(i=Yu)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=n[0],i[13]=n[1],i[14]=n[2],i[15]=1,i);var i,n;const r=1/Xu(e);return p(t,t,[r,r,r])}function Ku(e){const t=zn/(2*Math.PI);return e/(2*Math.PI)/t}function Qu(e,t){return zn/(512*Math.pow(2,e))*Xu(Vu(t))}function eh(e,t,i,n,r){const o=Ku(i),s=[e,t,-i/(2*Math.PI)],a=c(new Float64Array(16));return d(a,a,s),p(a,a,[o,o,o]),f(a,a,Ie(-r)),m(a,a,Ie(-n)),a}function th(e){return Be(ql,Xl,e)}function ih(e,t){const i=tc(t.lat,t.lng),n=function(e){const t=tc(e._center.lat,e._center.lng);let i=z([],S(0,1,0),t);const n=y([],-e.angle,t);i=G(i,i,n),y(n,-e._pitch,i);const r=k([],t);return R(r,r,Fu(e.cameraToCenterDistance/e.pixelsPerMeter)),G(r,r,n),M([],t,r)}(e);return s=(r=I([],n,i))[0],a=r[1],l=r[2],c=(o=i)[0],u=o[1],h=o[2],p=(d=Math.sqrt((s*s+a*a+l*l)*(c*c+u*u+h*h)))&&U(r,o)/d,Math.acos(Math.min(Math.max(p,-1),1));var r,o,s,a,l,c,u,h,d,p}function nh(e,t){return ih(e,t)>Math.PI/2*1.01}const rh=Ie(85),oh=Math.cos(rh),sh=Math.sin(rh),ah=a(),lh=e=>{const t=[];return"map"===e.paint.get("circle-pitch-alignment")&&t.push("PITCH_WITH_MAP"),"map"===e.paint.get("circle-pitch-scale")&&t.push("SCALE_WITH_MAP"),t};function ch(e,t,i,n,r,o,s,a,l){if(o&&e.queryGeometry.isAboveHorizon)return!1;o&&(l*=e.pixelToTileUnitsFactor);const c=e.tileID.canonical,u=i.projection.upVectorScale(c,i.center.lat,i.worldSize).metersToTile;for(const h of t)for(const t of h){const h=t.add(a),d=r&&i.elevation?i.elevation.exaggeration()*r.getElevationAt(h.x,h.y,!0):0,p=i.projection.projectTilePoint(h.x,h.y,c);if(d>0){const e=i.projection.upVector(c,h.x,h.y);p.x+=e[0]*u*d,p.y+=e[1]*u*d,p.z+=e[2]*u*d}const f=o?h:uh(p.x,p.y,p.z,n),m=o?e.tilespaceRays.map((e=>ph(e,d))):e.queryGeometry.screenGeometry,g=Q([],[p.x,p.y,p.z,1],n);if(!s&&o?l*=g[3]/i.cameraToCenterDistance:s&&!o&&(l*=i.cameraToCenterDistance/g[3]),o){const e=pc((t.y/zn+c.y)/(1<<c.z));l/=i.projection.pixelsPerMeter(e,1)/hc(1,e)}if(ou(m,f,l))return!0}return!1}function uh(e,t,i,n){const r=Q([],[e,t,i,1],n);return new Ee(r[0]/r[3],r[1]/r[3])}const hh=S(0,0,0),dh=S(0,0,1);function ph(e,t){const i=T();return hh[2]=t,e.intersectsPlane(hh,dh,i),new Ee(i[0],i[1])}class fh extends nu{}let mh,gh,_h,yh;function vh(e,{width:t,height:i},n,r){if(r){if(r instanceof Uint8ClampedArray)r=new Uint8Array(r.buffer);else if(r.length!==t*i*n)throw new RangeError("mismatched image size")}else r=new Uint8Array(t*i*n);return e.width=t,e.height=i,e.data=r,e}function xh(e,t,i){const{width:n,height:r}=t;n===e.width&&r===e.height||(bh(e,t,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,n),height:Math.min(e.height,r)},i,null),e.width=n,e.height=r,e.data=t.data)}function bh(e,t,i,n,r,o,s,a){if(0===r.width||0===r.height)return t;if(r.width>e.width||r.height>e.height||i.x>e.width-r.width||i.y>e.height-r.height)throw new RangeError("out of range source coordinates for image copy");if(r.width>t.width||r.height>t.height||n.x>t.width-r.width||n.y>t.height-r.height)throw new RangeError("out of range destination coordinates for image copy");const l=e.data,c=t.data,u=4===o&&a;for(let a=0;a<r.height;a++){const h=((i.y+a)*e.width+i.x)*o,d=((n.y+a)*t.width+n.x)*o;if(u)for(let e=0;e<r.width;e++){const t=h+e*o+3,i=d+e*o;c[i+0]=255,c[i+1]=255,c[i+2]=255,c[i+3]=l[t]}else if(s)for(let e=0;e<r.width;e++){const t=h+e*o,i=d+e*o,n=new li(l[t+0]/255,l[t+1]/255,l[t+2]/255,l[t+3]).toNonPremultipliedRenderColor(s).toArray();c[i+0]=n[0],c[i+1]=n[1],c[i+2]=n[2],c[i+3]=n[3]}else for(let e=0;e<r.width*o;e++)c[d+e]=l[h+e]}return t}es(fh,"HeatmapBucket",{omit:["layers"]});class Th{constructor(e,t){vh(this,e,1,t)}resize(e){xh(this,new Th(e),1)}clone(){return new Th({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,i,n,r){bh(e,t,i,n,r,1,null)}}class wh{constructor(e,t){vh(this,e,4,t)}resize(e){xh(this,new wh(e),4)}replace(e,t){t?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new wh({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,t,i,n,r,o,s){bh(e,t,i,n,r,4,o,s)}}class Eh{constructor(e,t){this.width=e.width,this.height=e.height,this.data=t instanceof Uint8Array?new Float32Array(t.buffer):t}}function Sh(e){const t={},i=e.resolution||256,n=e.clips?e.clips.length:1,r=e.image||new wh({width:i,height:n}),o=(i,n,o)=>{t[e.evaluationKey]=o;const s=e.expression.evaluate(t),a=s?s.toNonPremultipliedRenderColor(null):null;a&&(r.data[i+n+0]=Math.floor(255*a.r),r.data[i+n+1]=Math.floor(255*a.g),r.data[i+n+2]=Math.floor(255*a.b),r.data[i+n+3]=Math.floor(255*a.a))};if(e.clips)for(let t=0,r=0;t<n;++t,r+=4*i)for(let n=0,s=0;n<i;n++,s+=4){const a=n/(i-1),{start:l,end:c}=e.clips[t];o(r,s,l*(1-a)+c*a)}else for(let e=0,t=0;e<i;e++,t+=4)o(0,t,e/(i-1));return r}es(Th,"AlphaImage"),es(wh,"RGBAImage");const Ah=ha([{name:"a_pos",components:2,type:"Int16"}],4),Mh=ha([{name:"a_road_z_offset",components:1,type:"Float32"}],4),Ih=ha([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),Ch=ha([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Ph(e,t,i=2){const n=t&&t.length,r=n?t[0]*i:e.length;let o=Lh(e,0,r,i,!0);const s=[];if(!o||o.next===o.prev)return s;let a,l,c;if(n&&(o=function(e,t,i,n){const r=[];for(let i=0,o=t.length;i<o;i++){const s=Lh(e,t[i]*n,i<o-1?t[i+1]*n:e.length,n,!1);s===s.next&&(s.steiner=!0),r.push(Gh(s))}r.sort(kh);for(let e=0;e<r.length;e++)i=Uh(r[e],i);return i}(e,t,o,i)),e.length>80*i){a=e[0],l=e[1];let t=a,n=l;for(let o=i;o<r;o+=i){const i=e[o],r=e[o+1];i<a&&(a=i),r<l&&(l=r),i>t&&(t=i),r>n&&(n=r)}c=Math.max(t-a,n-l),c=0!==c?32767/c:0}return Oh(o,s,i,a,l,c,0),s}function Lh(e,t,i,n,r){let o;if(r===function(e,t,i,n){let r=0;for(let o=t,s=i-n;o<i;o+=n)r+=(e[s]-e[o])*(e[o+1]+e[s+1]),s=o;return r}(e,t,i,n)>0)for(let r=t;r<i;r+=n)o=Qh(r/n|0,e[r],e[r+1],o);else for(let r=i-n;r>=t;r-=n)o=Qh(r/n|0,e[r],e[r+1],o);return o&&qh(o,o.next)&&(ed(o),o=o.next),o}function Rh(e,t){if(!e)return e;t||(t=e);let i,n=e;do{if(i=!1,n.steiner||!qh(n,n.next)&&0!==Wh(n.prev,n,n.next))n=n.next;else{if(ed(n),n=t=n.prev,n===n.next)break;i=!0}}while(i||n!==t);return t}function Oh(e,t,i,n,r,o,s){if(!e)return;!s&&o&&function(e,t,i,n){let r=e;do{0===r.z&&(r.z=Vh(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){let t,i=1;do{let n,r=e;e=null;let o=null;for(t=0;r;){t++;let s=r,a=0;for(let e=0;e<i&&(a++,s=s.nextZ,s);e++);let l=i;for(;a>0||l>0&&s;)0!==a&&(0===l||!s||r.z<=s.z)?(n=r,r=r.nextZ,a--):(n=s,s=s.nextZ,l--),o?o.nextZ=n:e=n,n.prevZ=o,o=n;r=s}o.nextZ=null,i*=2}while(t>1)}(r)}(e,n,r,o);let a=e;for(;e.prev!==e.next;){const l=e.prev,c=e.next;if(o?Bh(e,n,r,o):Dh(e))t.push(l.i,e.i,c.i),ed(e),e=c.next,a=c.next;else if((e=c)===a){s?1===s?Oh(e=Fh(Rh(e),t),t,i,n,r,o,2):2===s&&Nh(e,t,i,n,r,o):Oh(Rh(e),t,i,n,r,o,1);break}}}function Dh(e){const t=e.prev,i=e,n=e.next;if(Wh(t,i,n)>=0)return!1;const r=t.x,o=i.x,s=n.x,a=t.y,l=i.y,c=n.y,u=Math.min(r,o,s),h=Math.min(a,l,c),d=Math.max(r,o,s),p=Math.max(a,l,c);let f=n.next;for(;f!==t;){if(f.x>=u&&f.x<=d&&f.y>=h&&f.y<=p&&Hh(r,a,o,l,s,c,f.x,f.y)&&Wh(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function Bh(e,t,i,n){const r=e.prev,o=e,s=e.next;if(Wh(r,o,s)>=0)return!1;const a=r.x,l=o.x,c=s.x,u=r.y,h=o.y,d=s.y,p=Math.min(a,l,c),f=Math.min(u,h,d),m=Math.max(a,l,c),g=Math.max(u,h,d),_=Vh(p,f,t,i,n),y=Vh(m,g,t,i,n);let v=e.prevZ,x=e.nextZ;for(;v&&v.z>=_&&x&&x.z<=y;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==s&&Hh(a,u,l,h,c,d,v.x,v.y)&&Wh(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==s&&Hh(a,u,l,h,c,d,x.x,x.y)&&Wh(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=_;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==s&&Hh(a,u,l,h,c,d,v.x,v.y)&&Wh(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==s&&Hh(a,u,l,h,c,d,x.x,x.y)&&Wh(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function Fh(e,t){let i=e;do{const n=i.prev,r=i.next.next;!qh(n,r)&&Xh(n,i,i.next,r)&&Jh(n,r)&&Jh(r,n)&&(t.push(n.i,i.i,r.i),ed(i),ed(i.next),i=e=r),i=i.next}while(i!==e);return Rh(i)}function Nh(e,t,i,n,r,o){let s=e;do{let e=s.next.next;for(;e!==s.prev;){if(s.i!==e.i&&$h(s,e)){let a=Kh(s,e);return s=Rh(s,s.next),a=Rh(a,a.next),Oh(s,t,i,n,r,o,0),void Oh(a,t,i,n,r,o,0)}e=e.next}s=s.next}while(s!==e)}function kh(e,t){let i=e.x-t.x;return 0===i&&(i=e.y-t.y,0===i)&&(i=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)),i}function Uh(e,t){const i=function(e,t){let i=t;const n=e.x,r=e.y;let o,s=-1/0;if(qh(e,i))return i;do{if(qh(e,i.next))return i.next;if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const e=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=n&&e>s&&(s=e,o=i.x<i.next.x?i:i.next,e===n))return o}i=i.next}while(i!==t);if(!o)return null;const a=o,l=o.x,c=o.y;let u=1/0;i=o;do{if(n>=i.x&&i.x>=l&&n!==i.x&&jh(r<c?n:s,r,l,c,r<c?s:n,r,i.x,i.y)){const t=Math.abs(r-i.y)/(n-i.x);Jh(i,e)&&(t<u||t===u&&(i.x>o.x||i.x===o.x&&zh(o,i)))&&(o=i,u=t)}i=i.next}while(i!==a);return o}(e,t);if(!i)return t;const n=Kh(i,e);return Rh(n,n.next),Rh(i,i.next)}function zh(e,t){return Wh(e.prev,e,t.prev)<0&&Wh(t.next,e,e.next)<0}function Vh(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Gh(e){let t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function jh(e,t,i,n,r,o,s,a){return(r-s)*(t-a)>=(e-s)*(o-a)&&(e-s)*(n-a)>=(i-s)*(t-a)&&(i-s)*(o-a)>=(r-s)*(n-a)}function Hh(e,t,i,n,r,o,s,a){return!(e===s&&t===a)&&jh(e,t,i,n,r,o,s,a)}function $h(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&Xh(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(Jh(e,t)&&Jh(t,e)&&function(e,t){let i=e,n=!1;const r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)&&(Wh(e.prev,e,t.prev)||Wh(e,t.prev,t))||qh(e,t)&&Wh(e.prev,e,e.next)>0&&Wh(t.prev,t,t.next)>0)}function Wh(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function qh(e,t){return e.x===t.x&&e.y===t.y}function Xh(e,t,i,n){const r=Zh(Wh(e,t,i)),o=Zh(Wh(e,t,n)),s=Zh(Wh(i,n,e)),a=Zh(Wh(i,n,t));return r!==o&&s!==a||!(0!==r||!Yh(e,i,t))||!(0!==o||!Yh(e,n,t))||!(0!==s||!Yh(i,e,n))||!(0!==a||!Yh(i,t,n))}function Yh(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function Zh(e){return e>0?1:e<0?-1:0}function Jh(e,t){return Wh(e.prev,e,e.next)<0?Wh(e,t,e.next)>=0&&Wh(e,e.prev,t)>=0:Wh(e,t,e.prev)<0||Wh(e,e.next,t)<0}function Kh(e,t){const i=td(e.i,e.x,e.y),n=td(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function Qh(e,t,i,n){const r=td(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function ed(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function td(e,t,i){return{i:e,x:t,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function id(e,t){const i=e.length;if(i<=1)return[e];const n=[];let r,o;for(let t=0;t<i;t++){const i=Ye(e[t]);0!==i&&(e[t].area=Math.abs(i),void 0===o&&(o=i<0),o===i<0?(r&&n.push(r),r=[e[t]]):r.push(e[t]))}if(r&&n.push(r),t>1)for(let e=0;e<n.length;e++)n[e].length<=t||(ln(n[e],t,1,n[e].length-1,nd),n[e]=n[e].slice(0,t));return n}function nd(e,t){return t.area-e.area}function rd(e,t,i=1){if(!e)return null;const n="string"==typeof e?ki.from(e).getPrimary():e.getPrimary(),r="string"==typeof e?null:e.getSecondary();for(const e of[n,r]){if(!e)continue;const n=e.id.toString();t.has(n)||t.set(n,[]),e.scaleSelf(i),t.get(n).push(e)}return{primary:n.toString(),secondary:r?r.toString():null}}function od(e,t,i,n){const r=n.patternDependencies;let o=!1;for(const n of t){const t=n.paint.get(`${e}-pattern`);t.isConstant()||(o=!0),rd(t.constantOr(null),r,i)&&(o=!0)}return o}function sd(e,t,i,n,r,o){const s=o.patternDependencies;for(const a of t){const t=a.paint.get(`${e}-pattern`).value;if("constant"!==t.kind){let e=t.evaluate({zoom:n},i,{},o.availableImages);e=e&&e.name?e.name:e;const l=rd(e,s,r);if(!l)continue;const{primary:c,secondary:u}=l;c&&(i.patterns[a.id]=[c,u].filter(Boolean))}}return i}class ad{constructor(){this.polygons=new Map}add(e,...t){const i=this.polygons.get(e);i?i.push(...t):this.polygons.set(e,t)}merge(e){for(const[t,i]of e.polygons)this.add(t,...i)}}class ld{constructor(){this.portals=[]}static isOnBorder(e,t){return e<=0&&t<=0||e>=zn&&t>=zn}static evaluate(e){if(0===e.length)return new ld;let t=[];for(const i of e)t.push(...i.portals);if(0===t.length)return new ld;for(const e of t){const t=e.va,i=e.vb;(ld.isOnBorder(t.x,i.x)||ld.isOnBorder(t.y,i.y))&&(e.type="border")}const i=t.filter((e=>"unevaluated"!==e.type)),n=t.filter((e=>"unevaluated"===e.type));if(0===n.length)return new ld;n.sort(((e,t)=>e.hash===t.hash?e.isTunnel===t.isTunnel?0:e.isTunnel?-1:1:e.hash<t.hash?1:-1)),t=i.concat(n);let r=i.length,o=r,s=r;do{if(o++,o===t.length||t[r].hash!==t[o].hash){if(o-r==2){s<r&&(t[s]=t[r],t[r]=null);const e=t[s],i=t[o-1];e.type=e.isTunnel!==i.isTunnel?"tunnel":"polygon",e.connection={a:e.connection.a,b:i.connection.a},s++}r=o}}while(r!==t.length);return t.splice(s),t.sort(((e,t)=>e.hash<t.hash?1:-1)),{portals:t}}}es(ld,"ElevationPortalGraph"),es(ad,"ElevationPolygons");class cd{constructor(e,t,i){this.outPositions=e,this.outNormals=t,this.outIndices=i,this.vertexLookup=new Map}addVertex(e,t,i){let n=e[2];null!=i&&(n*=i);const r=`${e[0]},${e[1]},${e[2]},${t[0]},${t[1]},${t[2]}`,o=this.vertexLookup.get(r);if(null!=o)return o;const s=this.outPositions.length;this.vertexLookup.set(r,s);const a=Math.trunc(16384*t[0]),l=Math.trunc(16384*t[1]),c=Math.trunc(16384*t[2]);return this.outPositions.emplaceBack(e[0],e[1],n),this.outNormals.emplaceBack(a,l,c),s}addTriangle(e,t,i){this.outIndices.emplaceBack(e,t,i)}addTriangles(e,t,i){if(0===e.length)return;const n=1===i.length,r=T(),o=T();for(let s=0;s<e.length;s+=3){const a=t[e[s+0]],l=t[e[s+1]],c=t[e[s+2]],u=n?i[0]:i[e[s+1]],h=n?i[0]:i[e[s+2]];A(r,a.x,a.y,n?i[0]:i[e[s+0]]);const d=this.addVertex(r,o);A(r,l.x,l.y,u);const p=this.addVertex(r,o);A(r,c.x,c.y,h);const f=this.addVertex(r,o);this.outIndices.emplaceBack(d,p,f)}}addQuad(e,t,i,n,r,o){const s=this.addVertex(e,r,o),a=this.addVertex(t,r,o),l=this.addVertex(i,r,o),c=this.addVertex(n,r,o);this.addTriangle(s,a,l),this.addTriangle(l,c,s)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class ud{constructor(e,t,i,n){this.unevaluatedPortals=new ld,this.portalPolygons=new ad,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new _a,this.vertexNormals=new ya,this.indexArray=new Da,this.tileToMeters=vc(e),this.bridgeProgramConfigurations=new zl(t,{zoom:i,lut:n},(e=>"fill-tunnel-structure-color"!==e)),this.tunnelProgramConfigurations=new zl(t,{zoom:i,lut:n},(e=>"fill-bridge-guard-rail-color"!==e))}addVertices(e,t){const i=this.unevalVertices.length;for(let i=0;i<e.length;i++)this.unevalVertices.push(e[i]),this.unevalHeights.push(t[i]);return i}addTriangles(e,t,i){const n=i?this.unevalTunnelTriangles:this.unevalTriangles;for(const i of e)n.push(i+t)}addRenderableRing(e,t,i,n,r,o){const s=[new Ee(r.min.x,r.min.y),new Ee(r.max.x,r.min.y),new Ee(r.max.x,r.max.y),new Ee(r.min.x,r.max.y)];for(let a=0;a<i-1;a++){const i=t+a,l=i+1,c=this.unevalVertices[i],u=this.unevalVertices[l];if(!(c.x>=r.min.x&&c.x<=r.max.x&&c.y>=r.min.y&&c.y<=r.max.y||u.x>=r.min.x&&u.x<=r.max.x&&u.y>=r.min.y&&u.y<=r.max.y||_u(c,u,s)))continue;if(this.isOnBorder(c.x,u.x)||this.isOnBorder(c.y,u.y))continue;const h=ud.computeEdgeHash(this.unevalVertices[i],this.unevalVertices[l]);let d,p=this.vertexHashLookup.get(ud.computePosHash(c));null!=p?d=p.next:(p=this.vertexHashLookup.get(ud.computePosHash(u)),d=null!=p?p.prev:h),this.unevalEdges.push({polygonIdx:e,a:i,b:l,hash:h,portalHash:d,isTunnel:n,type:"unevaluated",featureInfo:o})}}addPortalCandidates(e,t,i,n,r){if(0===t.length)return;this.portalPolygons.add(e,{geometry:t,zLevel:r});const o=t[0];this.vertexHashLookup.clear();let s=ud.computeEdgeHash(o[o.length-2],o[o.length-1]);for(let t=0;t<o.length-1;t++){const r=o[t+0],a=o[t+1],l=ue(a.x-r.x,a.y-r.y),c=me(l);if(0===c)continue;let u="unevaluated";const h=n.pointElevation(r),d=n.pointElevation(a);Math.abs(h)<.01&&Math.abs(d)<.01?u="entrance":(this.isOnBorder(r.x,a.x)||this.isOnBorder(r.y,a.y))&&(u="border");const p=ud.computeEdgeHash(r,a);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:r,vb:a,vab:l,length:c,hash:p,isTunnel:i,type:u});const f=ud.computePosHash(r);this.vertexHashLookup.set(f,{prev:s,next:p}),s=p}}construct(e){if(0===this.unevalVertices.length)return;const t=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),i=e=>{e.primitiveLength=this.indexArray.length-e.primitiveOffset},n=new cd(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const r=t(),o=t(),s=t(),a=(e,t)=>{e.sort(((e,i)=>e.type===t&&i.type!==t?-1:e.type!==t&&i.type===t?1:0));const i=e.findIndex((e=>e.type!==t));return i>=0?i:e.length};let l=0;this.unevalEdges.length>0&&(l=a(this.unevalEdges,"none"),this.constructBridgeStructures(n,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:l},this.tileToMeters)),i(s);const c=t(),u=t();if(this.unevalEdges.length>0){const e=this.unevalEdges.splice(l),t=a(e,"tunnel")+l;this.unevalEdges.push(...e),this.constructTunnelStructures(n,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:l},{min:l,max:t})}i(c),n.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),i(u),n.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),i(o),n.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),i(r),this.maskSegments=hl.simpleSegment(0,u.primitiveOffset,0,u.primitiveLength),this.depthSegments=hl.simpleSegment(0,o.primitiveOffset,0,o.primitiveLength),this.renderableBridgeSegments=hl.simpleSegment(0,s.primitiveOffset,0,s.primitiveLength),this.renderableTunnelSegments=hl.simpleSegment(0,c.primitiveOffset,0,c.primitiveLength),this.shadowCasterSegments=hl.simpleSegment(0,r.primitiveOffset,0,r.primitiveLength)}update(e,t,i,n,r,o,s,a){this.bridgeProgramConfigurations.updatePaintArrays(e,t,r,i,n,o,s,a),this.tunnelProgramConfigurations.updatePaintArrays(e,t,r,i,n,o,s,a)}upload(e){this.vertexBuffer||0===this.vertexPositions.length||0===this.vertexNormals.length||0===this.indexArray.length||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,Ih.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,Ch.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,t,i,n,r){const o=(o,s)=>{for(let a=0;a<s.length-1;a++){const l=s[a].featureIndex,c=s[a+1].vertexStart,u=e.feature(l);o.populatePaintArrays(c,u,l,{},i,t,n,void 0,r)}};o(this.bridgeProgramConfigurations,this.bridgeFeatureSections),o(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,t,i,n,r){const o=new Map;for(let s=n;s<r;s++){const n=i[s],r=n.a,a=n.b,l=ud.computePosHash(e[r]),c=ud.computePosHash(e[a]);let u=o.get(l);u||(u={},o.set(l,u));let h=o.get(c);h||(h={},o.set(c,h)),t[r]<=0&&t[a]<=0||(u.to=a,h.from=r)}return o}isTerminalVertex(e,t){const i=ud.computePosHash(this.unevalVertices[e]),n=t.get(i);return!n||!n.from||!n.to}constructBridgeStructures(e,t,i,n,r,o){e.clearVertexLookup();const s=this.computeVertexConnections(t,i,n,r.min,r.max),a=1/o,l=.5*a,c=(e,n)=>A(e,t[n].x,t[n].y,i[n]*a),u=T(),h=T(),d=T(),p=T(),f=T(),m=(e,i)=>{const n=s.get(ud.computePosHash(t[i])),r=n.from,o=n.to;if(!r||!o)return;c(u,r),c(h,i),c(d,o),$(p),W(u,h)||(q(f,h,u),k(p,f)),W(d,h)||(q(f,d,h),M(p,p,k(f,f)));const a=Y(p);return a>0?R(e,p,1/a):void 0};let g=Number.POSITIVE_INFINITY;this.sortSubarray(n,r.min,r.max,((e,t)=>e.featureInfo.featureIndex-t.featureInfo.featureIndex));const _=T(),y=T(),v=T(),x=T(),b=T(),w=T(),E=T(),S=T(),I=T(),C=[T(),T(),T(),T()],P=[T(),T(),T(),T()],L=[{coord:new Ee(0,0),height:0},{coord:new Ee(0,0),height:0}],O=(e,t)=>e>t;for(let c=r.min;c<r.max;c++){const r=n[c];if(!r.featureInfo.guardRailEnabled)continue;if(!this.prepareEdgePoints(L,t,i,r,O))continue;const[u,h]=L;if(A(_,u.coord.x,u.coord.y,a*u.height),A(y,h.coord.x,h.coord.y,a*h.height),W(_,y))continue;q(v,y,_),k(v,v);const d=m(S,r.a)||v,p=m(I,r.b)||v;A(x,d[1],-d[0],0),k(x,x),A(b,p[1],-p[0],0),k(b,b),z(S,x,d),k(w,S),z(S,b,p),k(E,S),M(C[0],_,R(S,q(S,x,w),l)),M(C[1],_,R(S,M(S,x,w),l)),M(C[2],_,R(S,w,l)),C[3]=_,M(P[0],y,R(S,q(S,b,E),l)),M(P[1],y,R(S,M(S,b,E),l)),M(P[2],y,R(S,E,l)),P[3]=y,g=this.addFeatureSection(r.featureInfo.featureIndex,g,this.bridgeFeatureSections,e);const f=e.addVertex(C[0],x,o),T=e.addVertex(C[1],x,o),D=e.addVertex(P[0],b,o),B=e.addVertex(P[1],b,o);e.addTriangle(f,T,D),e.addTriangle(T,B,D);const F=e.addVertex(C[1],w,o),U=e.addVertex(C[2],w,o),V=e.addVertex(P[1],E,o),G=e.addVertex(P[2],E,o);e.addTriangle(F,U,V),e.addTriangle(U,G,V),N(x,x),N(b,b);const j=e.addVertex(C[2],x,o),H=e.addVertex(C[3],x,o),$=e.addVertex(P[2],b,o),X=e.addVertex(P[3],b,o);e.addTriangle(j,H,$),e.addTriangle(H,X,$);const Y=this.isTerminalVertex(r.a,s),Z=this.isTerminalVertex(r.b,s);u.height<.01&&Y&&e.addQuad(C[3],C[2],C[1],C[0],N(d,d),o),h.height<.01&&Z&&e.addQuad(P[0],P[1],P[2],P[3],p,o)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,t,i,n,r,o){e.clearVertexLookup();let s=Number.POSITIVE_INFINITY;const a=(e,t)=>e.featureInfo.featureIndex-t.featureInfo.featureIndex;this.sortSubarray(n,r.min,r.max,a),this.sortSubarray(n,o.min,o.max,a);const l=e=>k(e,e),c=[{coord:new Ee(0,0),height:0},{coord:new Ee(0,0),height:0}],u=(e,t)=>e<t,h=T(),d=T(),p=T(),f=T(),m=T();for(let o=r.min;o<r.max;o++){if(!this.prepareEdgePoints(c,t,i,n[o],u))continue;const[r,a]=c,g=l(A(m,-(a.coord.y-r.coord.y),a.coord.x-r.coord.x,0));s=this.addFeatureSection(n[o].featureInfo.featureIndex,s,this.tunnelFeatureSections,e),e.addQuad(A(h,r.coord.x,r.coord.y,r.height),A(d,a.coord.x,a.coord.y,a.height),A(p,a.coord.x,a.coord.y,n[o].isTunnel?-.1:0),A(f,r.coord.x,r.coord.y,n[o].isTunnel?-.1:0),g)}for(let r=o.min;r<o.max;r++){const o=n[r];o.isTunnel&&([o.a,o.b]=[o.b,o.a]);const a=t[o.a],c=t[o.b],u=l(A(m,-(c.y-a.y),c.x-a.x,0));s=this.addFeatureSection(o.featureInfo.featureIndex,s,this.tunnelFeatureSections,e),e.addQuad(A(h,c.x,c.y,0),A(d,a.x,a.y,0),A(p,a.x,a.y,i[o.a]+4),A(f,c.x,c.y,i[o.b]+4),u),e.addQuad(A(h,a.x,a.y,0),A(d,c.x,c.y,0),A(p,c.x,c.y,i[o.b]+4),A(f,a.x,a.y,i[o.a]+4),u)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,t,i,n){e.coord.x=t,e.coord.y=i,e.height=n}prepareEdgePoints(e,t,i,n,r){let o=t[n.a].x,s=t[n.a].y,a=t[n.b].x,l=t[n.b].y,c=i[n.a],u=i[n.b];const h=r(c,0),d=r(u,0);if(h&&d)return this.setElevatedPoint(e[0],o,s,c),this.setElevatedPoint(e[1],a,l,u),!0;if(!h&&!d)return!1;if(h){if(!d){const e=u/(u-c);a=di(a,o,e),l=di(l,s,e),u=di(u,c,e)}}else{const e=c/(c-u);o=di(o,a,e),s=di(s,l,e),c=di(c,u,e)}return this.setElevatedPoint(e[0],o,s,c),this.setElevatedPoint(e[1],a,l,u),!0}prepareEdges(e,t){if(0===t.length)return;t.sort(((e,t)=>e.hash===t.hash?t.polygonIdx-e.polygonIdx:t.hash>e.hash?1:-1));let i=0,n=0,r=0,o=t[i].polygonIdx;do{n++,(n===t.length||t[i].hash!==t[n].hash)&&((1==n-i||t[n-1].polygonIdx!==o)&&(r<i&&(t[r]=t[i],t[i]=null),t[r].type="none",r++),i=n,i!==t.length&&(o=t[i].polygonIdx))}while(i!==t.length);if(t.splice(r),0!==t.length&&0!==e.length){t.sort(((e,t)=>e.portalHash<t.portalHash?1:-1));let i=0,n=0;for(;i!==t.length&&n!==e.length;){const r=t[i],o=e[n];r.portalHash>o.hash?i++:o.hash>r.portalHash?n++:(r.type=o.type,i++)}}}isOnBorder(e,t){return e<=0&&t<=0||e>=zn&&t>=zn}addFeatureSection(e,t,i,n){return e!==t&&(t=e,i.push({featureIndex:e,vertexStart:n.getVertexCount()}),n.clearVertexLookup()),t}sortSubarray(e,t,i,n){const r=e.slice(t,i);r.sort(n),e.splice(t,r.length,...r)}static computeEdgeHash(e,t){return(e.y===t.y&&e.x>t.x||e.y>t.y)&&([e,t]=[t,e]),BigInt(ud.computePosHash(e))<<32n|BigInt(ud.computePosHash(t))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var hd,dd={exports:{}},pd=(hd||(hd=1,function(e,t){!function(e){function t(e,t){return e>t?1:e<t?-1:0}var i=function(e,i){void 0===e&&(e=t),void 0===i&&(i=!1),this._compare=e,this._root=null,this._size=0,this._noDuplicates=!!i},n={size:{configurable:!0}};function r(e,t,i,n,o){var s=o-n;if(s>0){var a=n+Math.floor(s/2),l={key:t[a],data:i[a],parent:e};return l.left=r(l,t,i,n,a),l.right=r(l,t,i,a+1,o),l}return null}function o(e,t,i,n,r){if(!(i>=n)){for(var s=e[i+n>>1],a=i-1,l=n+1;;){do{a++}while(r(e[a],s)<0);do{l--}while(r(e[l],s)>0);if(a>=l)break;var c=e[a];e[a]=e[l],e[l]=c,c=t[a],t[a]=t[l],t[l]=c}o(e,t,i,l,r),o(e,t,l+1,n,r)}}i.prototype.rotateLeft=function(e){var t=e.right;t&&(e.right=t.left,t.left&&(t.left.parent=e),t.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.left=e),e.parent=t},i.prototype.rotateRight=function(e){var t=e.left;t&&(e.left=t.right,t.right&&(t.right.parent=e),t.parent=e.parent),e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.right=e),e.parent=t},i.prototype._splay=function(e){for(;e.parent;){var t=e.parent;t.parent?t.left===e&&t.parent.left===t?(this.rotateRight(t.parent),this.rotateRight(t)):t.right===e&&t.parent.right===t?(this.rotateLeft(t.parent),this.rotateLeft(t)):t.left===e&&t.parent.right===t?(this.rotateRight(t),this.rotateLeft(t)):(this.rotateLeft(t),this.rotateRight(t)):t.left===e?this.rotateRight(t):this.rotateLeft(t)}},i.prototype.splay=function(e){for(var t,i,n,r,o;e.parent;)(i=(t=e.parent).parent)&&i.parent?((n=i.parent).left===i?n.left=e:n.right=e,e.parent=n):(e.parent=null,this._root=e),r=e.left,o=e.right,e===t.left?(i&&(i.left===t?(t.right?(i.left=t.right,i.left.parent=i):i.left=null,t.right=i,i.parent=t):(r?(i.right=r,r.parent=i):i.right=null,e.left=i,i.parent=e)),o?(t.left=o,o.parent=t):t.left=null,e.right=t,t.parent=e):(i&&(i.right===t?(t.left?(i.right=t.left,i.right.parent=i):i.right=null,t.left=i,i.parent=t):(o?(i.left=o,o.parent=i):i.left=null,e.right=i,i.parent=e)),r?(t.right=r,r.parent=t):t.right=null,e.left=t,t.parent=e)},i.prototype.replace=function(e,t){e.parent?e===e.parent.left?e.parent.left=t:e.parent.right=t:this._root=t,t&&(t.parent=e.parent)},i.prototype.minNode=function(e){if(void 0===e&&(e=this._root),e)for(;e.left;)e=e.left;return e},i.prototype.maxNode=function(e){if(void 0===e&&(e=this._root),e)for(;e.right;)e=e.right;return e},i.prototype.insert=function(e,t){var i=this._root,n=null,r=this._compare;if(this._noDuplicates)for(;i;){if(n=i,0===r(i.key,e))return;i=r(i.key,e)<0?i.right:i.left}else for(;i;)n=i,i=r(i.key,e)<0?i.right:i.left;return i={key:e,data:t,left:null,right:null,parent:n},n?r(n.key,i.key)<0?n.right=i:n.left=i:this._root=i,this.splay(i),this._size++,i},i.prototype.find=function(e){for(var t=this._root,i=this._compare;t;){var n=i(t.key,e);if(n<0)t=t.right;else{if(!(n>0))return t;t=t.left}}return null},i.prototype.contains=function(e){for(var t=this._root,i=this._compare;t;){var n=i(e,t.key);if(0===n)return!0;t=n<0?t.left:t.right}return!1},i.prototype.remove=function(e){var t=this.find(e);if(!t)return!1;if(this.splay(t),t.left)if(t.right){var i=this.minNode(t.right);i.parent!==t&&(this.replace(i,i.right),i.right=t.right,i.right.parent=i),this.replace(t,i),i.left=t.left,i.left.parent=i}else this.replace(t,t.left);else this.replace(t,t.right);return this._size--,!0},i.prototype.removeNode=function(e){if(!e)return!1;if(this.splay(e),e.left)if(e.right){var t=this.minNode(e.right);t.parent!==e&&(this.replace(t,t.right),t.right=e.right,t.right.parent=t),this.replace(e,t),t.left=e.left,t.left.parent=t}else this.replace(e,e.left);else this.replace(e,e.right);return this._size--,!0},i.prototype.erase=function(e){var t=this.find(e);if(t){this.splay(t);var i=t.left,n=t.right,r=null;i&&(i.parent=null,r=this.maxNode(i),this.splay(r),this._root=r),n&&(i?r.right=n:this._root=n,n.parent=r),this._size--}},i.prototype.pop=function(){var e=this._root,t=null;if(e){for(;e.left;)e=e.left;t={key:e.key,data:e.data},this.remove(e.key)}return t},i.prototype.next=function(e){var t=e;if(t)if(t.right)for(t=t.right;t&&t.left;)t=t.left;else for(t=e.parent;t&&t.right===e;)e=t,t=t.parent;return t},i.prototype.prev=function(e){var t=e;if(t)if(t.left)for(t=t.left;t&&t.right;)t=t.right;else for(t=e.parent;t&&t.left===e;)e=t,t=t.parent;return t},i.prototype.forEach=function(e){for(var t=this._root,i=[],n=!1,r=0;!n;)t?(i.push(t),t=t.left):i.length>0?(e(t=i.pop(),r++),t=t.right):n=!0;return this},i.prototype.range=function(e,t,i,n){for(var r=[],o=this._compare,s=this._root;0!==r.length||s;)if(s)r.push(s),s=s.left;else{if(o((s=r.pop()).key,t)>0)break;if(o(s.key,e)>=0&&i.call(n,s))return this;s=s.right}return this},i.prototype.keys=function(){for(var e=this._root,t=[],i=[],n=!1;!n;)e?(t.push(e),e=e.left):t.length>0?(e=t.pop(),i.push(e.key),e=e.right):n=!0;return i},i.prototype.values=function(){for(var e=this._root,t=[],i=[],n=!1;!n;)e?(t.push(e),e=e.left):t.length>0?(e=t.pop(),i.push(e.data),e=e.right):n=!0;return i},i.prototype.at=function(e){for(var t=this._root,i=[],n=!1,r=0;!n;)if(t)i.push(t),t=t.left;else if(i.length>0){if(t=i.pop(),r===e)return t;r++,t=t.right}else n=!0;return null},i.prototype.load=function(e,t,i){if(void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===i&&(i=!1),0!==this._size)throw new Error("bulk-load: tree is not empty");var n=e.length;return i&&o(e,t,0,n-1,this._compare),this._root=r(null,e,t,0,n),this._size=n,this},i.prototype.min=function(){var e=this.minNode(this._root);return e?e.key:null},i.prototype.max=function(){var e=this.maxNode(this._root);return e?e.key:null},i.prototype.isEmpty=function(){return null===this._root},n.size.get=function(){return this._size},i.createTree=function(e,t,n,r,o){return new i(n,o).load(e,t,r)},Object.defineProperties(i.prototype,n);var s=0,a=1,l=2,c=3,u=0,h=1,d=2,p=3;function f(e,t,i){null===t?(e.inOut=!1,e.otherInOut=!0):(e.isSubject===t.isSubject?(e.inOut=!t.inOut,e.otherInOut=t.otherInOut):(e.inOut=!t.otherInOut,e.otherInOut=t.isVertical()?!t.inOut:t.inOut),t&&(e.prevInResult=!m(t,i)||t.isVertical()?t.prevInResult:t));var n=m(e,i);e.resultTransition=n?function(e,t){var i,n=!e.inOut,r=!e.otherInOut;switch(t){case u:i=n&&r;break;case h:i=n||r;break;case p:i=n^r;break;case d:i=e.isSubject?n&&!r:r&&!n}return i?1:-1}(e,i):0}function m(e,t){switch(e.type){case s:switch(t){case u:return!e.otherInOut;case h:return e.otherInOut;case d:return e.isSubject&&e.otherInOut||!e.isSubject&&!e.otherInOut;case p:return!0}break;case l:return t===u||t===h;case c:return t===d;case a:return!1}return!1}var g=function(e,t,i,n,r){this.left=t,this.point=e,this.otherEvent=i,this.isSubject=n,this.type=r||s,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},_={inResult:{configurable:!0}};function y(e,t){return e[0]===t[0]&&e[1]===t[1]}g.prototype.isBelow=function(e){var t=this.point,i=this.otherEvent.point;return this.left?(t[0]-e[0])*(i[1]-e[1])-(i[0]-e[0])*(t[1]-e[1])>0:(i[0]-e[0])*(t[1]-e[1])-(t[0]-e[0])*(i[1]-e[1])>0},g.prototype.isAbove=function(e){return!this.isBelow(e)},g.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},_.inResult.get=function(){return 0!==this.resultTransition},g.prototype.clone=function(){var e=new g(this.point,this.left,this.otherEvent,this.isSubject,this.type);return e.contourId=this.contourId,e.resultTransition=this.resultTransition,e.prevInResult=this.prevInResult,e.isExteriorRing=this.isExteriorRing,e.inOut=this.inOut,e.otherInOut=this.otherInOut,e},Object.defineProperties(g.prototype,_);var v=11102230246251565e-32,x=134217729,b=(3+8*v)*v;function T(e,t,i,n,r){var o,s,a,l,c=t[0],u=n[0],h=0,d=0;u>c==u>-c?(o=c,c=t[++h]):(o=u,u=n[++d]);var p=0;if(h<e&&d<i)for(u>c==u>-c?(a=o-((s=c+o)-c),c=t[++h]):(a=o-((s=u+o)-u),u=n[++d]),o=s,0!==a&&(r[p++]=a);h<e&&d<i;)u>c==u>-c?(a=o-((s=o+c)-(l=s-o))+(c-l),c=t[++h]):(a=o-((s=o+u)-(l=s-o))+(u-l),u=n[++d]),o=s,0!==a&&(r[p++]=a);for(;h<e;)a=o-((s=o+c)-(l=s-o))+(c-l),c=t[++h],o=s,0!==a&&(r[p++]=a);for(;d<i;)a=o-((s=o+u)-(l=s-o))+(u-l),u=n[++d],o=s,0!==a&&(r[p++]=a);return 0===o&&0!==p||(r[p++]=o),p}function w(e){return new Float64Array(e)}var E=33306690738754716e-32,S=22204460492503146e-32,A=11093356479670487e-47,M=w(4),I=w(8),C=w(12),P=w(16),L=w(4);function R(e,t,i){var n=function(e,t,i,n,r,o){var s=(t-o)*(i-r),a=(e-r)*(n-o),l=s-a;if(0===s||0===a||s>0!=a>0)return l;var c=Math.abs(s+a);return Math.abs(l)>=E*c?l:-function(e,t,i,n,r,o,s){var a,l,c,u,h,d,p,f,m,g,_,y,v,w,E,R,O,D,B=e-r,F=i-r,N=t-o,k=n-o;M[0]=(E=(f=B-(p=(d=x*B)-(d-B)))*(g=k-(m=(d=x*k)-(d-k)))-((w=B*k)-p*m-f*m-p*g))-((_=E-(O=(f=N-(p=(d=x*N)-(d-N)))*(g=F-(m=(d=x*F)-(d-F)))-((R=N*F)-p*m-f*m-p*g)))+(h=E-_))+(h-O),M[1]=(v=w-((y=w+_)-(h=y-w))+(_-h))-((_=v-R)+(h=v-_))+(h-R),M[2]=y-((D=y+_)-(h=D-y))+(_-h),M[3]=D;var U=function(e,t){for(var i=t[0],n=1;n<4;n++)i+=t[n];return i}(0,M),z=S*s;if(U>=z||-U>=z)return U;if(a=e-(B+(h=e-B))+(h-r),c=i-(F+(h=i-F))+(h-r),l=t-(N+(h=t-N))+(h-o),u=n-(k+(h=n-k))+(h-o),0===a&&0===l&&0===c&&0===u)return U;if(z=A*s+b*Math.abs(U),(U+=B*u+k*a-(N*c+F*l))>=z||-U>=z)return U;L[0]=(E=(f=a-(p=(d=x*a)-(d-a)))*(g=k-(m=(d=x*k)-(d-k)))-((w=a*k)-p*m-f*m-p*g))-((_=E-(O=(f=l-(p=(d=x*l)-(d-l)))*(g=F-(m=(d=x*F)-(d-F)))-((R=l*F)-p*m-f*m-p*g)))+(h=E-_))+(h-O),L[1]=(v=w-((y=w+_)-(h=y-w))+(_-h))-((_=v-R)+(h=v-_))+(h-R),L[2]=y-((D=y+_)-(h=D-y))+(_-h),L[3]=D;var V=T(4,M,4,L,I);L[0]=(E=(f=B-(p=(d=x*B)-(d-B)))*(g=u-(m=(d=x*u)-(d-u)))-((w=B*u)-p*m-f*m-p*g))-((_=E-(O=(f=N-(p=(d=x*N)-(d-N)))*(g=c-(m=(d=x*c)-(d-c)))-((R=N*c)-p*m-f*m-p*g)))+(h=E-_))+(h-O),L[1]=(v=w-((y=w+_)-(h=y-w))+(_-h))-((_=v-R)+(h=v-_))+(h-R),L[2]=y-((D=y+_)-(h=D-y))+(_-h),L[3]=D;var G=T(V,I,4,L,C);L[0]=(E=(f=a-(p=(d=x*a)-(d-a)))*(g=u-(m=(d=x*u)-(d-u)))-((w=a*u)-p*m-f*m-p*g))-((_=E-(O=(f=l-(p=(d=x*l)-(d-l)))*(g=c-(m=(d=x*c)-(d-c)))-((R=l*c)-p*m-f*m-p*g)))+(h=E-_))+(h-O),L[1]=(v=w-((y=w+_)-(h=y-w))+(_-h))-((_=v-R)+(h=v-_))+(h-R),L[2]=y-((D=y+_)-(h=D-y))+(_-h),L[3]=D;var j=T(G,C,4,L,P);return P[j-1]}(e,t,i,n,r,o,c)}(e[0],e[1],t[0],t[1],i[0],i[1]);return n>0?-1:n<0?1:0}function O(e,t){var i=e.point,n=t.point;return i[0]>n[0]?1:i[0]<n[0]?-1:i[1]!==n[1]?i[1]>n[1]?1:-1:function(e,t,i){return e.left!==t.left?e.left?1:-1:0!==R(i,e.otherEvent.point,t.otherEvent.point)?e.isBelow(t.otherEvent.point)?-1:1:!e.isSubject&&t.isSubject?1:-1}(e,t,i)}function D(e,t,i){var n=new g(t,!1,e,e.isSubject),r=new g(t,!0,e.otherEvent,e.isSubject);return y(e.point,e.otherEvent.point),n.contourId=r.contourId=e.contourId,O(r,e.otherEvent)>0&&(e.otherEvent.left=!0,r.left=!1),e.otherEvent.otherEvent=r,e.otherEvent=n,i.push(r),i.push(n),i}function B(e,t){return e[0]*t[1]-e[1]*t[0]}function F(e,t){return e[0]*t[0]+e[1]*t[1]}function N(e,t,i){var n=function(e,t,i,n){var r=[t[0]-e[0],t[1]-e[1]],o=[n[0]-i[0],n[1]-i[1]];function s(e,t,i){return[e[0]+t*i[0],e[1]+t*i[1]]}var a=[i[0]-e[0],i[1]-e[1]],l=B(r,o),c=l*l,u=F(r,r);if(c>0){var h=B(a,o)/l;if(h<0||h>1)return null;var d=B(a,r)/l;return d<0||d>1?null:0===h||1===h?[s(e,h,r)]:0===d||1===d?[s(i,d,o)]:[s(e,h,r)]}if((c=(l=B(a,r))*l)>0)return null;var p=F(r,a)/u,f=p+F(r,o)/u,m=Math.min(p,f),g=Math.max(p,f);return m<=1&&g>=0?1===m?[s(e,m>0?m:0,r)]:0===g?[s(e,g<1?g:1,r)]:[s(e,m>0?m:0,r),s(e,g<1?g:1,r)]:null}(e.point,e.otherEvent.point,t.point,t.otherEvent.point),r=n?n.length:0;if(0===r)return 0;if(1===r&&(y(e.point,t.point)||y(e.otherEvent.point,t.otherEvent.point)))return 0;if(2===r&&e.isSubject===t.isSubject)return 0;if(1===r)return y(e.point,n[0])||y(e.otherEvent.point,n[0])||D(e,n[0],i),y(t.point,n[0])||y(t.otherEvent.point,n[0])||D(t,n[0],i),1;var o=[],s=!1,u=!1;return y(e.point,t.point)?s=!0:1===O(e,t)?o.push(t,e):o.push(e,t),y(e.otherEvent.point,t.otherEvent.point)?u=!0:1===O(e.otherEvent,t.otherEvent)?o.push(t.otherEvent,e.otherEvent):o.push(e.otherEvent,t.otherEvent),s&&u||s?(t.type=a,e.type=t.inOut===e.inOut?l:c,s&&!u&&D(o[1].otherEvent,o[0].point,i),2):u?(D(o[0],o[1].point,i),3):o[0]!==o[3].otherEvent?(D(o[0],o[1].point,i),D(o[1],o[2].point,i),3):(D(o[0],o[1].point,i),D(o[3].otherEvent,o[2].point,i),3)}function k(e,t){if(e===t)return 0;if(0!==R(e.point,e.otherEvent.point,t.point)||0!==R(e.point,e.otherEvent.point,t.otherEvent.point))return y(e.point,t.point)?e.isBelow(t.otherEvent.point)?-1:1:e.point[0]===t.point[0]?e.point[1]<t.point[1]?-1:1:1===O(e,t)?t.isAbove(e.point)?-1:1:e.isBelow(t.point)?-1:1;if(e.isSubject!==t.isSubject)return e.isSubject?-1:1;var i=e.point,n=t.point;return i[0]===n[0]&&i[1]===n[1]?(i=e.otherEvent.point)[0]===(n=t.otherEvent.point)[0]&&i[1]===n[1]?0:e.contourId>t.contourId?1:-1:1===O(e,t)?1:-1}var U=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function z(e,t,i,n){var r,o=e+1,s=t[e].point,a=t.length;for(o<a&&(r=t[o].point);o<a&&r[0]===s[0]&&r[1]===s[1];){if(!i[o])return o;++o<a&&(r=t[o].point)}for(o=e-1;i[o]&&o>n;)o--;return o}U.prototype.isExterior=function(){return null==this.holeOf};var V=j,G=j;function j(e,t){if(!(this instanceof j))return new j(e,t);if(this.data=e||[],this.length=this.data.length,this.compare=t||H,this.length>0)for(var i=(this.length>>1)-1;i>=0;i--)this._down(i)}function H(e,t){return e<t?-1:e>t?1:0}j.prototype={push:function(e){this.data.push(e),this.length++,this._up(this.length-1)},pop:function(){if(0!==this.length){var e=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),e}},peek:function(){return this.data[0]},_up:function(e){for(var t=this.data,i=this.compare,n=t[e];e>0;){var r=e-1>>1,o=t[r];if(i(n,o)>=0)break;t[e]=o,e=r}t[e]=n},_down:function(e){for(var t=this.data,i=this.compare,n=this.length>>1,r=t[e];e<n;){var o=1+(e<<1),s=o+1,a=t[o];if(s<this.length&&i(t[s],a)<0&&(o=s,a=t[s]),i(a,r)>=0)break;t[e]=a,e=o}t[e]=r}},V.default=G;var $=Math.max,W=Math.min,q=0;function X(e,t,i,n,r,o){var s,a,l,c,u,h;for(s=0,a=e.length-1;s<a;s++)if(c=e[s+1],u=new g(l=e[s],!1,void 0,t),h=new g(c,!1,u,t),u.otherEvent=h,l[0]!==c[0]||l[1]!==c[1]){u.contourId=h.contourId=i,o||(u.isExteriorRing=!1,h.isExteriorRing=!1),O(u,h)>0?h.left=!0:u.left=!0;var d=l[0],p=l[1];r[0]=W(r[0],d),r[1]=W(r[1],p),r[2]=$(r[2],d),r[3]=$(r[3],p),n.push(u),n.push(h)}}var Y=[];function Z(e,t,n){"number"==typeof e[0][0][0]&&(e=[e]),"number"==typeof t[0][0][0]&&(t=[t]);var r=function(e,t,i){var n=null;return e.length*t.length==0&&(i===u?n=Y:i===d?n=e:i!==h&&i!==p||(n=0===e.length?t:e)),n}(e,t,n);if(r)return r===Y?null:r;var o=[1/0,1/0,-1/0,-1/0],s=[1/0,1/0,-1/0,-1/0],a=function(e,t,i,n,r){var o,s,a,l,c,u,h=new V(null,O);for(a=0,l=e.length;a<l;a++)for(c=0,u=(o=e[a]).length;c<u;c++)(s=0===c)&&q++,X(o[c],!0,q,h,i,s);for(a=0,l=t.length;a<l;a++)for(c=0,u=(o=t[a]).length;c<u;c++)s=0===c,r===d&&(s=!1),s&&q++,X(o[c],!1,q,h,n,s);return h}(e,t,o,s,n);if(r=function(e,t,i,n,r){var o=null;return(i[0]>n[2]||n[0]>i[2]||i[1]>n[3]||n[1]>i[3])&&(r===u?o=Y:r===d?o=e:r!==h&&r!==p||(o=e.concat(t))),o}(e,t,o,s,n))return r===Y?null:r;for(var l=function(e){var t,i,n=function(e){var t,i,n,r,o=[];for(i=0,n=e.length;i<n;i++)((t=e[i]).left&&t.inResult||!t.left&&t.otherEvent.inResult)&&o.push(t);for(var s=!1;!s;)for(s=!0,i=0,n=o.length;i<n;i++)i+1<n&&1===O(o[i],o[i+1])&&(r=o[i],o[i]=o[i+1],o[i+1]=r,s=!1);for(i=0,n=o.length;i<n;i++)(t=o[i]).otherPos=i;for(i=0,n=o.length;i<n;i++)(t=o[i]).left||(r=t.otherPos,t.otherPos=t.otherEvent.otherPos,t.otherEvent.otherPos=r);return o}(e),r={},o=[],s=function(){if(!r[t]){var e=o.length,i=function(e,t,i){var n=new U;if(null!=e.prevInResult){var r=e.prevInResult,o=r.outputContourId;if(r.resultTransition>0){var s=t[o];if(null!=s.holeOf){var a=s.holeOf;t[a].holeIds.push(i),n.holeOf=a,n.depth=t[o].depth}else t[o].holeIds.push(i),n.holeOf=o,n.depth=t[o].depth+1}else n.holeOf=null,n.depth=t[o].depth}else n.holeOf=null,n.depth=0;return n}(n[t],o,e),s=function(t){r[t]=!0,t<n.length&&n[t]&&(n[t].outputContourId=e)},a=t,l=t;for(i.points.push(n[t].point);s(a),s(a=n[a].otherPos),i.points.push(n[a].point),!((a=z(a,n,r,l))==l||a>=n.length)&&n[a];);o.push(i)}};for(t=0,i=n.length;t<i;t++)s();return o}(function(e,t,n,r,o,s){for(var a,l,c,h=new i(k),p=[],m=Math.min(r[2],o[2]);0!==e.length;){var g=e.pop();if(p.push(g),s===u&&g.point[0]>m||s===d&&g.point[0]>r[2])break;if(g.left){l=a=h.insert(g),a=a!==(c=h.minNode())?h.prev(a):null,l=h.next(l);var _=a?a.key:null;if(f(g,_,s),l&&2===N(g,l.key,e)&&(f(g,_,s),f(l.key,g,s)),a&&2===N(a.key,g,e)){var y=a;f(_,(y=y!==c?h.prev(y):null)?y.key:null,s),f(g,_,s)}}else l=a=h.find(g=g.otherEvent),a&&l&&(a=a!==c?h.prev(a):null,l=h.next(l),h.remove(g),l&&a&&N(a.key,l.key,e))}return p}(a,0,0,o,s,n)),c=[],m=0;m<l.length;m++){var g=l[m];if(g.isExterior()){for(var _=[g.points],y=0;y<g.holeIds.length;y++)_.push(l[g.holeIds[y]].points);c.push(_)}}return c}var J={UNION:h,DIFFERENCE:d,INTERSECTION:u,XOR:p};e.diff=function(e,t){return Z(e,t,d)},e.intersection=function(e,t){return Z(e,t,u)},e.operations=J,e.union=function(e,t){return Z(e,t,h)},e.xor=function(e,t){return Z(e,t,p)},Object.defineProperty(e,"__esModule",{value:!0})}(t)}(0,dd.exports)),dd.exports);
/**
		 * martinez v0.7.4
		 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
		 *
		 * @author Alex Milevski <info@w8r.name>
		 * @license MIT
		 * @preserve
		 */function fd(e,t,i,n){const r=[],o=0===n?(e,t,i,n,r,o)=>{e.push(new Ee(o,i+(o-t)/(n-t)*(r-i)))}:(e,t,i,n,r,o)=>{e.push(new Ee(t+(o-i)/(r-i)*(n-t),o))};for(const s of e){const e=[];for(const r of s){if(r.length<=2)continue;const s=[];for(let e=0;e<r.length-1;e++){const a=r[e].x,l=r[e].y,c=r[e+1].x,u=r[e+1].y,h=0===n?a:l,d=0===n?c:u;h<t?d>t&&o(s,a,l,c,u,t):h>i?d<i&&o(s,a,l,c,u,i):s.push(r[e]),d<t&&h>=t&&o(s,a,l,c,u,t),d>i&&h<=i&&o(s,a,l,c,u,i)}let a=r[r.length-1];const l=0===n?a.x:a.y;l>=t&&l<=i&&s.push(a),s.length&&(a=s[s.length-1],s[0].x===a.x&&s[0].y===a.y||s.push(s[0]),e.push(s))}e.length&&r.push(e)}return r}function md(e,t){const i=_d(e),n=_d([t]),r=pd.intersection(i,n);return null==r?[]:yd(r)}function gd(e,t){const i=65536;let n=_d(e,i);const r=[];for(;t.valid();t.next()){const[e,n]=t.get(),o=e.x*i,s=e.y*i,a=n.x*i,l=n.y*i,c=a-o,u=l-s,h=Math.hypot(c,u);if(0===h)continue;const d=Math.trunc(u/h*3),p=-Math.trunc(c/h*3);r.push([[[o,s],[a,l],[a+d,l+p],[o+d,s+p],[o,s]]])}return r.length>0&&(n=pd.diff(n,r)),yd(n,1/i)}function _d(e,t=1){return[e.map((e=>e.map((e=>[e.x*t,e.y*t]))))]}function yd(e,t=1){return e.map((e=>e.map(((e,i)=>{const n=e.map((e=>new Ee(e[0]*t,e[1]*t).round()));return i>0&&n.reverse(),n}))))}class vd{constructor(e,t){this.layoutVertexArray=new pa,this.indexArray=new Da,this.lineIndexArray=new Ca,this.triangleSegments=new hl,this.lineSegments=new hl,this.programConfigurations=new zl(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,t&&(this.elevatedLayoutVertexArray=new ga)}update(e,t,i,n,r,o,s,a){this.programConfigurations.updatePaintArrays(e,t,r,i,n,o,s,a)}isEmpty(){return 0===this.layoutVertexArray.length}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Ah.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Mh.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,t,i,n,r,o,s){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,t,i,n,r,o,void 0,s)}}class xd{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new vd(e,!1),this.elevationBufferData=new vd(e,!0),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,i,n){}populate(e,t,i,n){this.hasPattern=od("fill",this.layers,this.pixelRatio,t);const r=this.layers[0].layout.get("fill-sort-key"),o=[];for(const{feature:s,id:a,index:l,sourceLayerIndex:c}of e){const e=this.layers[0]._featureFilter.needGeometry,u=Cc(s,e);if(!this.layers[0]._featureFilter.filter(new Ss(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),u,i))continue;const h=r?r.evaluate(u,{},i,t.availableImages):void 0,d={id:a,properties:s.properties,type:s.type,sourceLayerIndex:c,index:l,geometry:e?u.geometry:Ic(s,i,n),patterns:{},sortKey:h};o.push(d)}r&&o.sort(((e,t)=>e.sortKey-t.sortKey));for(const n of o){const{geometry:r,index:o,sourceLayerIndex:s}=n;if(this.hasPattern){const e=sd("fill",this.layers,n,this.zoom,this.pixelRatio,t);this.patternFeatures.push(e)}else this.addFeature(n,r,o,i,{},t.availableImages,t.brightness,t.elevationFeatures);t.featureIndex.insert(e[o].feature,r,o,s,this.index)}}update(e,t,i,n,r,o,s){this.bufferData.update(e,t,i,n,r,o,s,this.worldview),this.elevationBufferData.update(e,t,i,n,r,o,s,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,t,i,n,r,o,s,this.worldview)}addFeatures(e,t,i,n,r,o){for(const r of this.patternFeatures)this.addFeature(r,r.geometry,r.index,t,i,n,o,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,t,i,n,r,o=[],s,a){const l=id(t,500);"none"!==this.elevationMode?this.addElevatedRoadFeature(e,l,n,i,a):this.addGeometry(l,this.bufferData),this.bufferData.populatePaintArrays(e,i,r,o,n,s,this.worldview),this.elevationBufferData.populatePaintArrays(e,i,r,o,n,s,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,t,i,n,r){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(t,i,n,r,this.worldview))}addElevatedRoadFeature(e,t,i,n,r){const o=new Array,s=tu.getElevationFeature(e,r);if(!s)return void this.addGeometry(t,this.bufferData);{const e=this.clipPolygonsToTile(t,1);e.length>0&&o.push({polygons:e,elevationFeature:s,elevationTileID:i})}const a={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},i),featureIndex:n};for(const t of o)if(t.elevationFeature){if("hd-road-base"===this.elevationMode){this.elevatedStructures||(this.elevatedStructures=new ud(t.elevationTileID,this.layers,this.zoom,this.lut));const i=t.elevationFeature.isTunnel();let n=0;e.properties.hasOwnProperty(kc)&&(n=+e.properties[kc]);for(const e of t.polygons)this.elevatedStructures.addPortalCandidates(t.elevationFeature.id,e,i,t.elevationFeature,n)}null==t.elevationFeature.constantHeight&&(t.polygons=this.prepareElevatedPolygons(t.polygons,t.elevationFeature,t.elevationTileID));const r=new iu(i,t.elevationTileID);this.addElevatedGeometry(t.polygons,r,t.elevationFeature,"hd-road-base"===this.elevationMode?0:.05,n,a)}}addElevatedGeometry(e,t,i,n,r,o){const s={elevation:i,elevationSampler:t,bias:n,index:r,featureInfo:o},[a,l]=this.addGeometry(e,this.elevationBufferData,s);null==this.elevationBufferData.heightRange?this.elevationBufferData.heightRange={min:a,max:l}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,a),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,l))}addGeometry(e,t,i){let n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,o=null;i&&(o=i.elevationSampler.constantElevation(i.elevation,i.bias),null!=o&&(n=o,r=o));const s=(e,s,a)=>{if(null!=i)if(s.push(e),null!=o)t.elevatedLayoutVertexArray.emplaceBack(o),a.push(o);else{const o=i.elevationSampler.pointElevation(e,i.elevation,i.bias);t.elevatedLayoutVertexArray.emplaceBack(o),a.push(o),n=Math.min(n,o),r=Math.max(r,o)}};for(const n of e){let e=0;for(const t of n)e+=t.length;const r=t.triangleSegments.prepareSegment(e,t.layoutVertexArray,t.indexArray),o=r.vertexLength,a=[],l=[],c=[],u=[],h=[],d=t.layoutVertexArray.length;for(const e of n){if(0===e.length)continue;e!==n[0]&&l.push(a.length/2);const r=t.lineSegments.prepareSegment(e.length,t.layoutVertexArray,t.lineIndexArray),o=r.vertexLength;i&&h.push(t.layoutVertexArray.length-d),s(e[0],c,u),t.layoutVertexArray.emplaceBack(e[0].x,e[0].y),t.lineIndexArray.emplaceBack(o+e.length-1,o),a.push(e[0].x),a.push(e[0].y);for(let i=1;i<e.length;i++)s(e[i],c,u),t.layoutVertexArray.emplaceBack(e[i].x,e[i].y),t.lineIndexArray.emplaceBack(o+i-1,o+i),a.push(e[i].x),a.push(e[i].y);r.vertexLength+=e.length,r.primitiveLength+=e.length}const p=Ph(a,l);for(let e=0;e<p.length;e+=3)t.indexArray.emplaceBack(o+p[e],o+p[e+1],o+p[e+2]);if(p.length>0&&i&&"hd-road-base"===this.elevationMode){const e=i.elevation.isTunnel(),t=i.elevation.safeArea,n=this.elevatedStructures.addVertices(c,u);this.elevatedStructures.addTriangles(p,n,e);const r=h.length;if(r>0){for(let o=0;o<r-1;o++)this.elevatedStructures.addRenderableRing(i.index,h[o]+n,h[o+1]-h[o],e,t,i.featureInfo);this.elevatedStructures.addRenderableRing(i.index,h[r-1]+n,c.length-h[r-1],e,t,i.featureInfo)}}r.vertexLength+=e,r.primitiveLength+=p.length/3}return[n,r]}prepareElevatedPolygons(e,t,i){const n=1/vc(i),r=[];for(const i of e){const e=gd(i,new Qc(t,n));r.push(...e)}return r}clipPolygonsToTile(e,t){const i=-t,n=-t,r=zn+t,o=zn+t;let s=0;const a=[],l=[];for(;s<e.length;s++){const t=e[s],c=yn(t);(c.min.x>=i&&c.max.x<=r&&c.min.y>=n&&c.max.y<=o?a:l).push(t)}if(a.length===e.length)return e;const c=[new Ee(i,n),new Ee(r,n),new Ee(r,o),new Ee(i,o),new Ee(i,n)],u=a;for(const e of l)u.push(...md(e,c));return u}}let bd,Td,wd,Ed;es(xd,"FillBucket",{omit:["layers","patternFeatures"]}),es(vd,"FillBufferData"),es(ud,"ElevatedStructures");class Sd{constructor(e,t,i,n){if(this.triangleCount=t.length/3,this.min=new Ee(0,0),this.max=new Ee(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===e.length)return;const[r,o]=[e[0].clone(),e[0].clone()];for(let t=1;t<e.length;++t){const i=e[t];r.x=Math.min(r.x,i.x),r.y=Math.min(r.y,i.y),o.x=Math.max(o.x,i.x),o.y=Math.max(o.y,i.y)}if(n){const e=Math.ceil(Math.max(o.x-r.x,o.y-r.y)/n);i=Math.max(i,e)}if(0===i)return;this.min=r,this.max=o;const s=this.max.sub(this.min);s.x=Math.max(s.x,1),s.y=Math.max(s.y,1);const a=Math.max(s.x,s.y)/i;this.cellsX=Math.max(1,Math.ceil(s.x/a)),this.cellsY=Math.max(1,Math.ceil(s.y/a)),this.xScale=1/a,this.yScale=1/a;const l=[];for(let i=0;i<this.triangleCount;i++){const n=e[t[3*i+0]].sub(this.min),r=e[t[3*i+1]].sub(this.min),o=e[t[3*i+2]].sub(this.min),s=Ad(Math.floor(Math.min(n.x,r.x,o.x)),this.xScale,this.cellsX),c=Ad(Math.floor(Math.max(n.x,r.x,o.x)),this.xScale,this.cellsX),u=Ad(Math.floor(Math.min(n.y,r.y,o.y)),this.yScale,this.cellsY),h=Ad(Math.floor(Math.max(n.y,r.y,o.y)),this.yScale,this.cellsY),d=new Ee(0,0),p=new Ee(0,0),f=new Ee(0,0),m=new Ee(0,0);for(let e=u;e<=h;++e){d.y=p.y=e*a,f.y=m.y=(e+1)*a;for(let t=s;t<=c;++t)d.x=f.x=t*a,p.x=m.x=(t+1)*a,(vu(n,r,o,d,p,m)||vu(n,r,o,d,m,f))&&l.push({cellIdx:e*this.cellsX+t,triIdx:i})}}if(0===l.length)return;l.sort(((e,t)=>e.cellIdx-t.cellIdx||e.triIdx-t.triIdx));let c=0;for(;c<l.length;){const e=l[c].cellIdx,t={start:this.payload.length,len:0};for(;c<l.length&&l[c].cellIdx===e;)++t.len,this.payload.push(l[c++].triIdx);this.cells[e]=t}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,t){if(0===this.triangleCount||0===this.cells.length)return;if(e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const i=Ad(e.x-this.min.x,this.xScale,this.cellsX),n=Ad(e.y-this.min.y,this.yScale,this.cellsY),r=this.cells[n*this.cellsX+i];if(r){this._lazyInitLookup();for(let e=0;e<r.len;e++){const i=this.payload[r.start+e],n=Math.floor(i/8),o=1<<i%8;if(!(this.lookup[n]&o)&&(this.lookup[n]|=o,t.push(i),t.length===this.triangleCount))return}}}query(e,t,i){if(0===this.triangleCount||0===this.cells.length)return;if(e.x>this.max.x||this.min.x>t.x)return;if(e.y>this.max.y||this.min.y>t.y)return;this._lazyInitLookup();const n=Ad(e.x-this.min.x,this.xScale,this.cellsX),r=Ad(t.x-this.min.x,this.xScale,this.cellsX),o=Ad(e.y-this.min.y,this.yScale,this.cellsY),s=Ad(t.y-this.min.y,this.yScale,this.cellsY);for(let e=o;e<=s;e++)for(let t=n;t<=r;t++){const n=this.cells[e*this.cellsX+t];if(n)for(let e=0;e<n.len;e++){const t=this.payload[n.start+e],r=Math.floor(t/8),o=1<<t%8;if(!(this.lookup[r]&o)&&(this.lookup[r]|=o,i.push(t),i.length===this.triangleCount))return}}}}function Ad(e,t,i){return Math.max(0,Math.min(i-1,Math.floor(e*t)))}es(Sd,"TriangleGridIndex");class Md{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.footprints=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){for(const i of this.footprints)t.push({footprint:i,id:e})}updateAppearances(e,t,i,n){}populate(e,t,i,n){const r=[];for(const{feature:o,id:s,index:a,sourceLayerIndex:l}of e){const e=this.layers[0]._featureFilter.needGeometry,c=Cc(o,e);if(!this.layers[0]._featureFilter.filter(new Ss(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),c,i))continue;const u={id:s,properties:o.properties,type:o.type,sourceLayerIndex:l,index:a,geometry:e?c.geometry:Ic(o,i,n),patterns:{}};r.push(u)}for(const n of r){const{geometry:r,index:o,sourceLayerIndex:s}=n;this.addFeature(n,r,o,i,{},t.availableImages,t.brightness),t.featureIndex.insert(e[o].feature,r,o,s,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(e){}update(e,t,i,n,r,o,s){}destroy(){}addFeature(e,t,i,n,r,o=[],s){for(const e of id(t,2)){const t=[],i=[],n=[],r=new Ee(1/0,1/0),o=new Ee(-1/0,-1/0);for(const s of e)if(0!==s.length){s!==e[0]&&n.push(i.length/2);for(let e=0;e<s.length;e++)i.push(s[e].x),i.push(s[e].y),t.push(s[e]),r.x=Math.min(r.x,s[e].x),r.y=Math.min(r.y,s[e].y),o.x=Math.max(o.x,s[e].x),o.y=Math.max(o.y,s[e].y)}const s=Ph(i,n),a=new Sd(t,s,8,256);this.footprints.push({vertices:t,indices:s,grid:a,min:r,max:o})}}}es(Md,"ClipBucket",{omit:["layers"]});const Id=ha([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Cd=ha([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Pd=ha([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),Ld=ha([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Rd=ha([{name:"a_join_normal_inside",components:3,type:"Int16"}]),Od=ha([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Dd=ha([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Bd}=Id,Fd=Number.MAX_SAFE_INTEGER,Nd=Fd-1;function kd(e,t,i,n){return e.order<t||e.order===Fd||!(e.clipMask&i)||function(e,t){return 0!==t.length&&void 0===t.find((t=>t===e))}(n,e.clipScope)}function Ud(e,t){return e.x-t.x||e.y-t.y}function zd(e,t){return 0===Ud(e.min,t.min)&&0===Ud(e.max,t.max)}function Vd(e,t){return!(e.min.x>t.max.x||e.max.x<t.min.x||e.min.y>t.max.y||e.max.y<t.min.y)}function Gd(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i].sourceId!==t[i].sourceId||!zd(e[i],t[i])||e[i].order!==t[i].order||e[i].clipMask!==t[i].clipMask||!Se(e[i].clipScope,t[i].clipScope))return!1;return!0}function jd(e,t,i){const n=1/zn,r=1/(1<<i.canonical.z),o=(t.x*n+i.canonical.x)*r+i.wrap,s=(t.y*n+i.canonical.y)*r;return{min:new Ee((e.x*n+i.canonical.x)*r+i.wrap,(e.y*n+i.canonical.y)*r),max:new Ee(o,s)}}function Hd(e,t,i){const n=1<<i.canonical.z,r=((t.x-i.wrap)*n-i.canonical.x)*zn,o=(t.y*n-i.canonical.y)*zn;return{min:new Ee(((e.x-i.wrap)*n-i.canonical.x)*zn,(e.y*n-i.canonical.y)*zn),max:new Ee(r,o)}}function $d(e,t,i,n,r,o,s){const a=e.indices,l=e.vertices,c=[];for(let u=n;u<n+r;u+=3){const n=t[i[u+0]+o],r=t[i[u+1]+o],h=t[i[u+2]+o],d=Math.min(n.x,r.x,h.x),p=Math.max(n.x,r.x,h.x),f=Math.min(n.y,r.y,h.y),m=Math.max(n.y,r.y,h.y);c.length=0,e.grid.query(new Ee(d,f),new Ee(p,m),c);for(let e=0;e<c.length;e++){const t=c[e];if(vu(l[a[3*t+0]],l[a[3*t+1]],l[a[3*t+2]],n,r,h,s))return!0}}return!1}function Wd(e,t,i,n){if(!e||!i)return!1;let r=e.vertices;if(!t.canonical.equals(n.canonical)||t.wrap!==n.wrap){if(i.vertices.length<e.vertices.length)return Wd(i,n,e,t);const o=t.canonical,s=n.canonical,a=Math.pow(2,s.z-o.z);r=e.vertices.map((e=>new Ee((e.x+o.x*zn)*a-s.x*zn,(e.y+o.y*zn)*a-s.y*zn)))}return $d(i,r,e.indices,0,e.indices.length,0,0)}function qd(e,t,i,n){const r=Math.pow(2,n.z-i.z);return new Ee((e+i.x*zn)*r-n.x*zn,(t+i.y*zn)*r-n.y*zn)}function Xd(e,t){const i=[];t.grid.queryPoint(e,i);const n=t.indices,r=t.vertices;for(let t=0;t<i.length;t++){const o=i[t];if(mu([r[n[3*o+0]],r[n[3*o+1]],r[n[3*o+2]]],e))return!0}return!1}const Yd=[new Ee(0,0),new Ee(zn,0),new Ee(zn,zn),new Ee(0,zn)];function Zd(e,t){const i=[];let n=[];if(!t||e.length<2)return[e];if(2===e.length)return _u(e[0],e[1],Yd)?[e]:[];for(let t=0;t<e.length+2;t++){const r=e[t%e.length],o=e[(t+1)%e.length],s=_u(0===t?e[e.length-1]:e[(t-1)%e.length],r,Yd),a=_u(r,o,Yd),l=s||a;l&&n.push(r),l&&a||n.length>0&&(n.length>1&&i.push(n),n=[])}return n.length>1&&i.push(n),i}const Jd=Pc.types,Kd=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],Qd=["fill-extrusion-flood-light-ground-radius"],ep=Math.pow(2,13),tp=Math.pow(2,15)-1,ip=new Ee(0,1),np=2147483648,rp=7,op=450;function sp(e,t,i,n,r,o,s,a){e.emplaceBack((t<<1)+s,(i<<1)+o,(Math.floor(n*ep)<<1)+r,Math.round(a))}function ap(e,t,i){e.emplaceBack(t.x*zn,t.y*zn,i?1:0)}function lp(e,t,i,n,r,o){e.emplaceBack(t.x,t.y,(i.x<<1)+n,(i.y<<1)+r,o)}function cp(e,t,i){const n=16384;e.emplaceBack(t.x,t.y,t.z,i[0]*n,i[1]*n,i[2]*n)}class up{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class hp{constructor(){this.centroidXY=new Ee(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Ee(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Ee(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Ee(this.max.x-this.min.x,this.max.y-this.min.y)}}class dp{constructor(){this.acc=new Ee(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,t){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=t.x,e.min.y=e.max.y=t.y)}appendEdge(e,t,i){this.accCount++,this.acc._add(t);let n=!!this.borders;t.x<e.min.x?(e.min.x=t.x,n=!0):t.x>e.max.x&&(e.max.x=t.x,n=!0),t.y<e.min.y?(e.min.y=t.y,n=!0):t.y>e.max.y&&(e.max.y=t.y,n=!0),((0===t.x||t.x===zn)&&t.x===i.x)!=((0===t.y||t.y===zn)&&t.y===i.y)&&this.processBorderOverlap(t,i),n&&this.checkBorderIntersection(t,i)}checkBorderIntersection(e,t){t.x<0!=e.x<0&&this.addBorderIntersection(0,di(t.y,e.y,(0-t.x)/(e.x-t.x))),t.x>zn!=e.x>zn&&this.addBorderIntersection(1,di(t.y,e.y,(zn-t.x)/(e.x-t.x))),t.y<0!=e.y<0&&this.addBorderIntersection(2,di(t.x,e.x,(0-t.y)/(e.y-t.y))),t.y>zn!=e.y>zn&&this.addBorderIntersection(3,di(t.x,e.x,(zn-t.y)/(e.y-t.y)))}addBorderIntersection(e,t){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const i=this.borders[e];t<i[0]&&(i[0]=t),t>i[1]&&(i[1]=t)}processBorderOverlap(e,t){if(e.x===t.x){if(e.y===t.y)return;const i=0===e.x?0:1;this.addBorderIntersection(i,t.y),this.addBorderIntersection(i,e.y)}else{const i=0===e.y?2:3;this.addBorderIntersection(i,t.x),this.addBorderIntersection(i,e.x)}}centroid(){return 0===this.accCount?new Ee(0,0):new Ee(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((e,t)=>e+ +(t[0]!==Number.MAX_VALUE)),0):0}}function pp(e,t){const i=e.add(t)._unit(),n=De(e.x*i.x+e.y*i.y,-1,1);var r,o,s;return r=Math.acos(n),Math.min(4,Math.max(-4,Math.tan(r)))/4*tp*((o=e).x*(s=t).y-o.y*s.x<0?-1:1)}const fp=[e=>e.x<0,e=>e.x>zn,e=>e.y<0,e=>e.y>zn];function mp(e,t,i,n){const r=[4];if(0===n)return r;i._mult(n);const o=e.sub(i),s=t.sub(i),a=[e,t,o,s];for(let e=0;e<4;e++)for(const t of a)if(fp[e](t)){r.push(e);break}return r}class gp{constructor(e){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new va,this.indexArray=new Da,this.programConfigurations=new zl(e.layers,{zoom:e.zoom,lut:e.lut},(e=>Qd.includes(e))),this._segments=new hl,this.hiddenByLandmarkVertexArray=new Xa,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new hl}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(e,t,i,n=!1){const r=e.length;if(r>2){let o=Math.max(0,this._segments.get().length-1);const s=this._segments._prepareSegment(4*r,this.vertexArray.length,2*this._segmentToGroundQuads[o].length);let a;o!==this._segments.get().length-1&&(o++,this._segmentToGroundQuads[o]=[],this._segmentToRegionTriCounts[o]=[0,0,0,0,0]);{const t=e[0],i=e[1];a=pp(t.sub(e[r-1])._perp()._unit(),i.sub(t)._perp()._unit())}for(let l=0;l<r;l++){const c=l===r-1?0:l+1,u=e[l],h=e[c],d=e[c===r-1?0:c+1],p=h.sub(u)._perp()._unit(),f=pp(p,d.sub(h)._perp()._unit()),m=a,g=f;if(bp(u,h,t)||n&&Tp(u,t)&&Tp(h,t)){a=f;continue}const _=s.vertexLength;lp(this.vertexArray,u,h,1,1,m),lp(this.vertexArray,u,h,1,0,m),lp(this.vertexArray,u,h,0,1,g),lp(this.vertexArray,u,h,0,0,g),s.vertexLength+=4;const y=mp(u,h,p,i);for(const e of y)this._segmentToGroundQuads[o].push({id:_,region:e}),this._segmentToRegionTriCounts[o][e]+=2,s.primitiveLength+=2;a=f}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),t=e.length;for(let e=0;e<t;e++)this._segmentToGroundQuads[e].sort(((e,t)=>e.region-t.region));for(let i=0;i<t;i++){const t=this._segmentToGroundQuads[i],n=e[i],r=this._segmentToRegionTriCounts[i];r.reduce(((e,t)=>e+t),0);let o=0;for(let e=0;e<=4;e++){const t=r[e];if(0!==t){let i=this.regionSegments[e];i||(i=this.regionSegments[e]=new hl);const r={vertexOffset:n.vertexOffset,primitiveOffset:n.primitiveOffset+o,vertexLength:n.vertexLength,primitiveLength:t};i.get().push(r)}o+=t}for(let e=0;e<t.length;e++){const i=t[e].id;this.indexArray.emplaceBack(i,i+1,i+3),this.indexArray.emplaceBack(i,i+3,i+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,t,i,n,r,o,s){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,t,i,n,r,o,void 0,s)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,Cd.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),null!=this.groundRadiusArray&&(this.groundRadiusBuffer=e.createVertexBuffer(this.groundRadiusArray,Pd.members)))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,t,i,n,r,o,s,a){this.hasData()&&this.programConfigurations.updatePaintArrays(e,t,i,n,r,o,s,a)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&np))}updateHiddenByLandmarkRange(e,t,i){if(!this.hasData())return;const n=t+e;if(0!==t){for(let t=e;t<n;++t)this.hiddenByLandmarkVertexArray.emplace(t,i?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,Od.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const t=this.regionSegments[e];t&&t.destroy()}}}}class _p{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Da,this.footprintVertices=new pa,this.footprintSegments=[],this.layoutVertexArray=new ma,this.centroidVertexArray=new ol,this.wallVertexArray=new al,this.indexArray=new Da,this.programConfigurations=new zl(e.layers,{zoom:e.zoom,lut:e.lut},(e=>Kd.includes(e))),this.segments=new hl,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.groundEffect=new gp(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,i,n){}populate(e,t,i,n){this.features=[],this.hasPattern=od("fill-extrusion",this.layers,this.pixelRatio,t),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=vc(i),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:r,id:o,index:s,sourceLayerIndex:a}of e){const e=this.layers[0]._featureFilter.needGeometry,l=Cc(r,e);if(!this.layers[0]._featureFilter.filter(new Ss(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),l,i))continue;const c={id:o,sourceLayerIndex:a,index:s,geometry:e?l.geometry:Ic(r,i,n),properties:r.properties,type:r.type,patterns:{}},u=this.layoutVertexArray.length,h="Polygon"===Jd[c.type];if(this.hasPattern)this.features.push({featureId:r.id,feature:sd("fill-extrusion",this.layers,c,this.zoom,this.pixelRatio,t)});else if(this.wallMode)for(const e of c.geometry)for(const o of Zd(e,h))this.addFeature(r.id,c,[o],s,i,{},t.availableImages,n,t.brightness);else this.addFeature(r.id,c,c.geometry,s,i,{},t.availableImages,n,t.brightness);t.featureIndex.insert(r,c.geometry,s,a,this.index,u)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,t,i,n,r,o){for(const{featureId:e,feature:s}of this.features){const a="Polygon"===Jd[s.type],{geometry:l}=s;if(this.wallMode)for(const c of l)for(const l of Zd(c,a))this.addFeature(e,s,[l],s.index,t,i,n,r,o);else this.addFeature(e,s,l,s.index,t,i,n,r,o)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(e,t,i,n,r,o,s){this.programConfigurations.updatePaintArrays(e,t,r,i,n,o,s,this.worldview),this.groundEffect.update(e,t,r,i,n,o,s,this.worldview)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Bd),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,Rd.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,Dd.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,Ld.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,t,i,n,r,o,s,a,l){const c=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(t,{})/this.tileToMeter,u=[new Ee(0,0),new Ee(zn,zn)],h=a.projection,d="globe"===h.name,p=this.wallMode||"Polygon"===Jd[t.type],f=new dp;f.centroidDataIndex=this.centroidData.length;const m=new hp;m.buildingId=e,t.properties&&t.properties.hasOwnProperty("building_id")&&(m.buildingId=t.properties.building_id);const g=this.layers[0].paint.get("fill-extrusion-base").evaluate(t,{},r)<=0,_=this.layers[0].paint.get("fill-extrusion-height").evaluate(t,{},r);let y;if(m.height=_,m.vertexArrayOffset=this.layoutVertexArray.length,m.groundVertexArrayOffset=this.groundEffect.vertexArray.length,d&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ea),this.wallMode){if(d)return void qe("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==i.length)return;y=function(e){const t=e[0].x===e[e.length-1].x&&e[0].y===e[e.length-1].y,i=function(e){let t=0;const i=e.length;for(let n=0;n<i;n++)t+=(e[(n+1)%i].x-e[n].x)*(e[(n+1)%i].y+e[n].y);return t>=0}(e);i||(e=e.reverse());const n={geometry:[],joinNormals:[],indices:[]},r=[],o=[],s=[];let a=e.length;for(;a>=2&&e[a-1].equals(e[a-2]);)a--;if(a<(t?3:2))return n;let l,c,u,h,d,p=0;for(;p<a-1&&e[p].equals(e[p+1]);)p++;t&&(l=e[a-2],d=e[p].sub(l)._unit()._perp());for(let i=p;i<a;i++){if(u=i===a-1?t?e[p+1]:void 0:e[i+1],u&&e[i].equals(u))continue;d&&(h=d),l&&(c=l),l=e[i],d=u?u.sub(l)._unit()._perp():h,h=h||d;let n=h.add(d);0===n.x&&0===n.y||n._unit();const f=n.x*d.x+n.y*d.y,m=0!==f?1/f:1/0,g=h.x*d.y-h.y*d.x>0;let _="miter";const y=2;"miter"===_&&m>y&&(_="bevel"),"bevel"===_&&(m>100&&(_="flipbevel"),m<y&&(_="miter"));const v=(e,t,i,n)=>{const a=new Ee(e.x,e.y),l=new Ee(e.x,e.y);a.x+=t.x*n,a.y+=t.y*n,l.x-=t.x*Math.max(i,1),l.y-=t.y*Math.max(i,1),s.push(t),r.push(a),o.push(l)};if("miter"===_)n._mult(m),v(l,n,0,0);else if("flipbevel"===_)n=d.mult(-1),v(l,n,0,0),v(l,n.mult(-1),0,0);else{const e=-Math.sqrt(m*m-1),t=g?e:0,i=g?0:e;c&&v(l,h,t,i),u&&v(l,d,t,i)}}n.geometry=[...r,...o.reverse(),r[0]],n.joinNormals=[...s,...s.reverse(),s[s.length-1]];const f=n.geometry.length-1;for(let e=0;e<f/2;e++)if(e+1<f/2){let t=e,i=e+1,r=f-1-e,o=f-2-e;t=0===t?f-1:t-1,i=0===i?f-1:i-1,r=0===r?f-1:r-1,o=0===o?f-1:o-1,n.indices.push(r),n.indices.push(i),n.indices.push(t),n.indices.push(r),n.indices.push(o),n.indices.push(i)}return n}(i[0]),i=[y.geometry]}const v=(e,t)=>e<(t.length-1)/2||e===t.length-1,x=this.wallMode?[i]:id(i,500);for(let e=x.length-1;e>=0;e--){const t=x[e];(0===t.length||(b=t[0]).every((e=>e.x<=0))||b.every((e=>e.x>=zn))||b.every((e=>e.y<=0))||b.every((e=>e.y>=zn)))&&x.splice(e,1)}var b;let T;if(d)T=Ap(x,u,r);else{T=[];for(const e of x)T.push({polygon:e,bounds:u})}const w=p?this.edgeRadius:0,E=w>0&&this.zoom<17,S=(e,t)=>{if(0===e.length)return!1;const i=e[e.length-1];return t.x===i.x&&t.y===i.y};for(const{polygon:e,bounds:t}of T){let i=0,n=0;for(const t of e)p&&!t[0].equals(t[t.length-1])&&t.push(t[0]),n+=p?t.length-1:t.length;const o=this.segments.prepareSegment((p?5:4)*n,this.layoutVertexArray,this.indexArray);m.footprintSegIdx<0&&(m.footprintSegIdx=this.footprintSegments.length),m.polygonSegIdx<0&&(m.polygonSegIdx=this.polygonSegments.length);const s={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},a=new up;if(a.vertexOffset=this.footprintVertices.length,a.indexOffset=3*this.footprintIndices.length,a.ringIndices=[],p){const n=[],s=[];i=o.vertexLength;for(let i=0;i<e.length;i++){const l=e[i];l.length&&0!==i&&s.push(n.length/2);const u=[];let p,f;p=l[1].sub(l[0])._perp()._unit(),a.ringIndices.push(l.length-1);for(let e=1;e<l.length;e++){const t=l[e],i=l[e===l.length-1?1:e+1],s=t.clone();if(w){f=i.sub(t)._perp()._unit();const e=p.add(f)._unit(),n=w*Math.min(4,1/(p.x*e.x+p.y*e.y));s.x+=n*e.x,s.y+=n*e.y,s.x=Math.round(s.x),s.y=Math.round(s.y),p=f}if(!g||0!==w&&!E||S(u,s)||u.push(s),sp(this.layoutVertexArray,s.x,s.y,0,0,1,1,0),this.wallMode){const t=v(e,l);ap(this.wallVertexArray,y.joinNormals[e],!t)}o.vertexLength++,this.footprintVertices.emplaceBack(t.x,t.y),n.push(t.x,t.y),d&&cp(this.layoutVertexExtArray,h.projectTilePoint(s.x,s.y,r),h.upVector(r,s.x,s.y))}g&&(0===w||E)&&(0!==u.length&&S(u,u[0])&&u.pop(),this.groundEffect.addData(u,t,c))}const l=this.wallMode?y.indices:Ph(n,s);for(let e=0;e<l.length;e+=3)this.footprintIndices.emplaceBack(a.vertexOffset+l[e+0],a.vertexOffset+l[e+1],a.vertexOffset+l[e+2]),this.indexArray.emplaceBack(i+l[e],i+l[e+2],i+l[e+1]),o.primitiveLength++;a.indexCount+=l.length,a.vertexCount+=this.footprintVertices.length-a.vertexOffset}for(let n=0;n<e.length;n++){const s=e[n];f.startRing(m,s[0]);let a=s.length>4&&wp(s[s.length-2],s[0],s[1]),l=w?vp(s[s.length-2],s[0],s[1],w):0;const u=[];let _,x,b;x=s[1].sub(s[0])._perp()._unit();let T=!0;for(let e=1,n=0;e<s.length;e++){let c=s[e-1],p=s[e];const E=s[e===s.length-1?1:e+1];if(f.appendEdge(m,p,c),bp(p,c,t)){w&&(x=E.sub(p)._perp()._unit(),T=!T);continue}const A=p.sub(c)._perp(),M=A.x/(Math.abs(A.x)+Math.abs(A.y)),I=A.y>0?1:0,C=c.dist(p);if(n+C>32768&&(n=0),w){b=E.sub(p)._perp()._unit();let e=xp(c,p,E,yp(x,b),w);isNaN(e)&&(e=0);const t=p.sub(c)._unit();c=c.add(t.mult(l))._round(),p=p.add(t.mult(-e))._round(),l=e,x=b,g&&this.zoom>=17&&(S(u,c)||u.push(c),S(u,p)||u.push(p))}const P=o.vertexLength,L=s.length>4&&wp(c,p,E);let R=Ep(n,a,T);if(sp(this.layoutVertexArray,c.x,c.y,M,I,0,0,R),sp(this.layoutVertexArray,c.x,c.y,M,I,0,1,R),this.wallMode){const t=v(e-1,s),i=y.joinNormals[e-1];ap(this.wallVertexArray,i,t),ap(this.wallVertexArray,i,t)}if(n+=C,R=Ep(n,L,!T),a=L,sp(this.layoutVertexArray,p.x,p.y,M,I,0,0,R),sp(this.layoutVertexArray,p.x,p.y,M,I,0,1,R),this.wallMode){const t=v(e,s),i=y.joinNormals[e];ap(this.wallVertexArray,i,t),ap(this.wallVertexArray,i,t)}if(o.vertexLength+=4,this.indexArray.emplaceBack(P+0,P+1,P+2),this.indexArray.emplaceBack(P+1,P+3,P+2),o.primitiveLength+=2,w){const n=i+(1===e?s.length-2:e-2),r=1===e?i:n+1;if(this.indexArray.emplaceBack(P+1,n,P+3),this.indexArray.emplaceBack(n,r,P+3),o.primitiveLength+=2,void 0===_&&(_=P),!bp(E,s[e],t)){const t=e===s.length-1?_:o.vertexLength;this.indexArray.emplaceBack(P+2,P+3,t),this.indexArray.emplaceBack(P+3,t+1,t),this.indexArray.emplaceBack(P+3,r,t+1),o.primitiveLength+=3}T=!T}if(d){const e=this.layoutVertexExtArray,t=h.projectTilePoint(c.x,c.y,r),i=h.projectTilePoint(p.x,p.y,r),n=h.upVector(r,c.x,c.y),o=h.upVector(r,p.x,p.y);cp(e,t,n),cp(e,t,n),cp(e,i,o),cp(e,i,o)}}p&&(i+=s.length-1),g&&w&&this.zoom>=17&&(0!==u.length&&S(u,u[0])&&u.pop(),this.groundEffect.addData(u,t,c,w>0))}this.footprintSegments.push(a),s.triangleCount=this.indexArray.length-s.triangleArrayOffset,this.polygonSegments.push(s),++m.footprintSegLen,++m.polygonSegLen}if(m.vertexCount=this.layoutVertexArray.length-m.vertexArrayOffset,m.groundVertexCount=this.groundEffect.vertexArray.length-m.groundVertexArrayOffset,0!==m.vertexCount){if(m.centroidXY=f.borders?ip:this.encodeCentroid(f,m),this.centroidData.push(m),f.borders){this.featuresOnBorder.push(f);const e=this.featuresOnBorder.length-1;for(let t=0;t<f.borders.length;t++)f.borders[t][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[t].push(e)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,o,s,r,l,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(t,n,o,s,r,l,this.worldview),this.maxHeight=Math.max(this.maxHeight,_)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort(((t,i)=>this.featuresOnBorder[t].borders[e][0]-this.featuresOnBorder[i].borders[e][0]))}splitToSubtiles(){const e=[];for(let t=0;t<this.centroidData.length;t++){const i=this.centroidData[t],n=+(i.min.y+i.max.y>zn),r=2*n+(+(i.min.x+i.max.x>zn)^n);for(let n=0;n<i.polygonSegLen;n++){const o=i.polygonSegIdx+n;e.push({centroidIdx:t,subtile:r,polygonSegmentIdx:o,triangleSegmentIdx:this.polygonSegments[o].triangleSegIdx})}}const t=new Da;e.sort(((e,t)=>e.triangleSegmentIdx===t.triangleSegmentIdx?e.subtile-t.subtile:e.triangleSegmentIdx-t.triangleSegmentIdx));let i=0,n=0,r=0;for(const t of e){if(t.triangleSegmentIdx!==i)break;r++}const o=e.length;for(;n!==e.length;){i=e[n].triangleSegmentIdx;let s=0,a=n,l=n;for(let t=a;t<r&&e[t].subtile===s;t++)l++;for(;a!==r;){const n=e[a];s=n.subtile;const o=this.centroidData[n.centroidIdx].min.clone(),c=this.centroidData[n.centroidIdx].max.clone(),u={vertexOffset:this.segments.segments[i].vertexOffset,primitiveOffset:t.length,vertexLength:this.segments.segments[i].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let i=a;i<l;i++){const n=e[i],r=this.polygonSegments[n.polygonSegmentIdx],s=this.centroidData[n.centroidIdx].min,a=this.centroidData[n.centroidIdx].max,l=this.indexArray.uint16;for(let e=r.triangleArrayOffset;e<r.triangleArrayOffset+r.triangleCount;e++)t.emplaceBack(l[3*e],l[3*e+1],l[3*e+2]);u.primitiveLength+=r.triangleCount,o.x=Math.min(o.x,s.x),o.y=Math.min(o.y,s.y),c.x=Math.max(c.x,a.x),c.y=Math.max(c.y,a.y)}u.primitiveLength>0&&this.triangleSubSegments.push({segment:u,min:o,max:c}),a=l;for(let t=a;t<r&&e[t].subtile===e[a].subtile;t++)l++}n=r;for(let t=n;t<o&&e[t].triangleSegmentIdx===e[n].triangleSegmentIdx;t++)r++}t._trim(),this.indexArray=t}getVisibleSegments(e,t,i){const n=new hl;if(this.wallMode){for(const e of this.triangleSubSegments)n.segments.push(e.segment);return n}let r=0,o=0;const s=1<<e.canonical.z;if(t){const i=t.getMinMaxForTile(e);i&&(r=i.min,o=i.max)}o+=this.maxHeight;const a=e.toUnwrapped();let l;const c=[a.canonical.x/s+a.wrap,a.canonical.y/s],u=[(a.canonical.x+1)/s+a.wrap,(a.canonical.y+1)/s],h=(e,t,i)=>[e[0]*(1-i[0])+t[0]*i[0],e[1]*(1-i[1])+t[1]*i[1]],d=[],p=[];for(const e of this.triangleSubSegments){d[0]=e.min.x/zn,d[1]=e.min.y/zn,p[0]=e.max.x/zn,p[1]=e.max.y/zn;const t=h(c,u,d),s=h(c,u,p);if(0===new Kc([t[0],t[1],r],[s[0],s[1],o]).intersectsPrecise(i)){l&&(n.segments.push(l),l=void 0);continue}const a=e.segment;l&&l.vertexOffset!==a.vertexOffset&&(n.segments.push(l),l=void 0),l?(l.vertexLength+=a.vertexLength,l.primitiveLength+=a.primitiveLength):l={vertexOffset:a.vertexOffset,primitiveLength:a.primitiveLength,vertexLength:a.vertexLength,primitiveOffset:a.primitiveOffset,sortKey:void 0,vaos:{}}}return l&&n.segments.push(l),n}encodeCentroid(e,t){const i=e.centroid(),n=t.span(),r=Math.min(7,Math.round(n.x*this.tileToMeter/10)),o=Math.min(7,Math.round(n.y*this.tileToMeter/10));return new Ee(De(i.x,1,zn-1)<<3|r,De(i.y,1,zn-1)<<3|o)}encodeBorderCentroid(e){if(!e.borders)return new Ee(0,0);const t=e.borders,i=Number.MAX_VALUE;if(t[0][0]!==i||t[1][0]!==i){const e=t[0][0]!==i?0:1;return new Ee(6|(t[0][0]!==i?0:65528),(t[e][0]+t[e][1])/2<<3|6)}{const e=t[2][0]!==i?2:3;return new Ee((t[e][0]+t[e][1])/2<<3|6,6|(t[2][0]!==i?0:65528))}}showCentroid(e){const t=this.centroidData[e.centroidDataIndex];t.flags&=2147483647,t.centroidXY.x=0,t.centroidXY.y=0,this.writeCentroidToBuffer(t)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const t=e.vertexArrayOffset,i=e.vertexCount+e.vertexArrayOffset,n=e.flags&np?ip:e.centroidXY,r=this.centroidVertexArray.geta_centroid_pos0(t);if(this.centroidVertexArray.geta_centroid_pos1(t)!==n.y||r!==n.x){for(let e=t;e<i;++e)this.centroidVertexArray.emplace(e,n.x,n.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,t,i){if(t.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=t.updateTime;const n=t.getReplacementRegionsForTile(e.toUnwrapped());if(Gd(this.activeReplacements,n))return;if(this.activeReplacements=n,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const e of this.centroidData)e.flags&=2147483647;const r=[];for(const t of this.activeReplacements){if(t.order<i)continue;const n=Math.max(1,Math.pow(2,t.footprintTileId.canonical.z-e.canonical.z));if(t.footprint.buildingId){const e=t.footprint.buildingId;for(const t of this.centroidData)t.buildingId===e&&(t.flags|=np)}else for(const i of this.centroidData)if(!(i.flags&np||t.min.x>i.max.x||i.min.x>t.max.x||t.min.y>i.max.y||i.min.y>t.max.y))for(let o=0;o<i.footprintSegLen;o++){const s=this.footprintSegments[i.footprintSegIdx+o];if(r.length=0,Mp(this.footprintVertices,s.vertexOffset,s.vertexCount,t.footprintTileId.canonical,e.canonical,r),$d(t.footprint,r,this.footprintIndices.uint16,s.indexOffset,s.indexCount,-s.vertexOffset,-n)){i.flags|=np;break}}}for(const e of this.centroidData)this.writeCentroidToBuffer(e);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,t,i){let n=!1;for(let r=0;r<i.footprintSegLen;r++){const o=this.footprintSegments[i.footprintSegIdx+r];let s=0;for(const i of o.ringIndices){for(let r=s,a=i+s-1;r<i+s;a=r++){const i=this.footprintVertices.int16[2*(r+o.vertexOffset)+0],s=this.footprintVertices.int16[2*(r+o.vertexOffset)+1],l=this.footprintVertices.int16[2*(a+o.vertexOffset)+1];s>t!=l>t&&e<(this.footprintVertices.int16[2*(a+o.vertexOffset)+0]-i)*(t-s)/(l-s)+i&&(n=!n)}s=i}}return n}getHeightAtTileCoord(e,t){let i=Number.NEGATIVE_INFINITY,n=!0;const r=4*(e+zn)*zn+(t+zn);if(this.partLookup.hasOwnProperty(r)){const e=this.partLookup[r];return e?{height:e.height,hidden:!!(e.flags&np)}:void 0}for(const o of this.centroidData)e>o.max.x||o.min.x>e||t>o.max.y||o.min.y>t||o.height<=i||this.footprintContainsPoint(e,t,o)&&(i=o.height,this.partLookup[r]=o,n=!!(o.flags&np));if(i!==Number.NEGATIVE_INFINITY)return{height:i,hidden:n};this.partLookup[r]=void 0}}function yp(e,t){const i=e.add(t)._unit();return e.x*i.x+e.y*i.y}function vp(e,t,i,n){const r=t.sub(e)._perp()._unit(),o=i.sub(t)._perp()._unit();return xp(e,t,i,yp(r,o),n)}function xp(e,t,i,n,r){const o=Math.sqrt(1-n*n);return Math.min(e.dist(t)/3,t.dist(i)/3,r*o/n)}function bp(e,t,i){return e.x<i[0].x&&t.x<i[0].x||e.x>i[1].x&&t.x>i[1].x||e.y<i[0].y&&t.y<i[0].y||e.y>i[1].y&&t.y>i[1].y}function Tp(e,t){return e.x<t[0].x||e.x>t[1].x||e.y<t[0].y||e.y>t[1].y}function wp(e,t,i){if(e.x<0||e.x>=zn||t.x<0||t.x>=zn||i.x<0||i.x>=zn)return!1;const n=i.sub(t),r=n.perp(),o=e.sub(t);return(n.x*o.x+n.y*o.y)/Math.sqrt((n.x*n.x+n.y*n.y)*(o.x*o.x+o.y*o.y))>-.866&&r.x*o.x+r.y*o.y<0}function Ep(e,t,i){const n=t?2|e:-3&e;return i?1|n:-2&n}function Sp(){const e=Math.PI/32,t=Math.tan(e),i=ic;return i*Math.sqrt(1+2*t*t)-i}function Ap(e,t,i){const n=1<<i.z,r=dc(i.x/n),o=dc((i.x+1)/n),s=pc(i.y/n),a=pc((i.y+1)/n);return function(e,t,i,n,r=0,o){const s=[];if(!e.length||!i||!n)return s;const a=(e,t)=>{for(const i of e)s.push({polygon:i,bounds:t})},l=Math.ceil(Math.log2(i)),c=Math.ceil(Math.log2(n)),u=l-c,h=[];for(let e=0;e<Math.abs(u);e++)h.push(u>0?0:1);for(let e=0;e<Math.min(l,c);e++)h.push(0),h.push(1);let d=e;if(d=fd(d,t[0].y-r,t[1].y+r,1),d=fd(d,t[0].x-r,t[1].x+r,0),!d.length)return s;const p=[];for(h.length?p.push({polygons:d,bounds:t,depth:0}):a(d,t);p.length;){const e=p.pop(),t=e.depth,i=h[t],n=e.bounds[0],s=e.bounds[1],l=0===i?n.x:n.y,c=0===i?s.x:s.y,u=o?o(i,l,c):.5*(l+c),d=fd(e.polygons,l-r,u+r,i),f=fd(e.polygons,u-r,c+r,i);if(d.length){const e=[n,new Ee(0===i?u:s.x,1===i?u:s.y)];h.length>t+1?p.push({polygons:d,bounds:e,depth:t+1}):a(d,e)}if(f.length){const e=[new Ee(0===i?u:n.x,1===i?u:n.y),s];h.length>t+1?p.push({polygons:f,bounds:e,depth:t+1}):a(f,e)}}return s}(e,t,Math.ceil((o-r)/11.25),Math.ceil((s-a)/11.25),1,((e,t,r)=>{if(0===e)return.5*(t+r);{const e=pc((i.y+t/zn)/n);return(uc(.5*(pc((i.y+r/zn)/n)+e))*n-i.y)*zn}}))}function Mp(e,t,i,n,r,o){const s=Math.pow(2,n.z-r.z);for(let a=0;a<i;a++){let i=e.int16[2*(a+t)+0],l=e.int16[2*(a+t)+1];i=(i+r.x*zn)*s-n.x*zn,l=(l+r.y*zn)*s-n.y*zn,o.push(new Ee(i,l))}}let Ip,Cp;es(_p,"FillExtrusionBucket",{omit:["layers","features"]}),es(hp,"PartData"),es(up,"FootprintSegment"),es(dp,"BorderCentroidData"),es(gp,"GroundEffect");class Pp extends Ee{constructor(e,t,i){super(e,t),this.z=i}}class Lp extends Pp{constructor(e,t,i,n){super(e,t,i),this.w=n}}function Rp(e,t,i,n){const r="x"===i?"y":"x",o=(n-e[i])/(t[i]-e[i]);e[r]=Math.round(e[r]+(t[r]-e[r])*o),e[i]=n,e.hasOwnProperty("z")&&(e.z=di(e.z,t.z,o)),e.hasOwnProperty("w")&&(e.w=di(e.w,t.w,o))}function Op(e,t,i,n){const r=i,o=n;for(const i of["x","y"]){let n=e,s=t;n[i]>=s[i]&&(n=t,s=e),n[i]<r&&s[i]>r&&Rp(n,s,i,r),n[i]<o&&s[i]>o&&Rp(s,n,i,o)}}function Dp(e,t,i,n,r,o){const s=[];for(let a=0;a<e.length;a++){const l=e[a];let c;const u=s.length;let h=0;for(let e=0;e<l.length-1;e++){let u=l[e],d=l[e+1],p=0;const f=h;let m,g;o&&(p=Math.hypot(d.x-u.x,d.y-u.y),h+=p,m=u,g=d),u.x<t&&d.x<t||(u.x<t?u=new Ee(t,u.y+(t-u.x)/(d.x-u.x)*(d.y-u.y))._round():d.x<t&&(d=new Ee(t,u.y+(t-u.x)/(d.x-u.x)*(d.y-u.y))._round()),u.y<i&&d.y<i||(u.y<i?u=new Ee(u.x+(i-u.y)/(d.y-u.y)*(d.x-u.x),i)._round():d.y<i&&(d=new Ee(u.x+(i-u.y)/(d.y-u.y)*(d.x-u.x),i)._round()),u.x>=n&&d.x>=n||(u.x>=n?u=new Ee(n,u.y+(n-u.x)/(d.x-u.x)*(d.y-u.y))._round():d.x>=n&&(d=new Ee(n,u.y+(n-u.x)/(d.x-u.x)*(d.y-u.y))._round()),u.y>=r&&d.y>=r||(u.y>=r?u=new Ee(u.x+(r-u.y)/(d.y-u.y)*(d.x-u.x),r)._round():d.y>=r&&(d=new Ee(u.x+(r-u.y)/(d.y-u.y)*(d.x-u.x),r)._round()),c&&u.equals(c[c.length-1])||(c=[u],s.push(c),o&&o.push({progress:{min:f+Fp(m,g,u)*p,max:1},parentIndex:a,prevPoint:m,nextPoint:g})),c.push(d),o&&(o[o.length-1].progress.max=f+Fp(m,g,d)*p,o[o.length-1].nextPoint=g)))))}if(o&&h>0)for(let e=u;e<s.length;e++)o[e].progress.min/=h,o[e].progress.max/=h}return s}function Bp(e,t,i,n,r){if(e.length<2)return void n.push(e);const o=[];for(;t.valid();){const[i,n]=t.get();for(let t=0;t<e.length-1;t++){const r=e[t],s=e[t+1],a=hu(r,s,i,n);if(a){const[e]=a,i=new Ee(di(r.x,s.x,e),di(r.y,s.y,e));o.push({t:t+e,distance:0,point:i})}}t.next()}if(0===o.length)return void n.push(e);o.sort(((e,t)=>e.t-t.t));let s=0,a=0,l=[];for(n.push(l);s!==e.length;){if(a===o.length){for(;s!==e.length;)0!==l.length&&l[l.length-1].equals(e[s])||l.push(e[s]),s++;break}o[a].t<=s?(0!==l.length&&l[l.length-1].equals(o[a].point)||l.push(o[a].point),Math.trunc(o[a].t),a++):(0!==l.length&&l[l.length-1].equals(e[s])||l.push(e[s]),s++)}}function Fp(e,t,i){return e.x!==t.x?(i.x-e.x)/(t.x-e.x):e.y!==t.y?(i.y-e.y)/(t.y-e.y):0}function Np(e,t){return e.x*t.x+e.y*t.y}function kp(e,t){if(1===e.length){let i=0;const n=t[i++];let r;for(;!r||n.equals(r);)if(r=t[i++],!r)return 1/0;for(;i<t.length;i++){const o=t[i],s=e[0],a=r.sub(n),l=o.sub(n),c=s.sub(n),u=Np(a,a),h=Np(a,l),d=Np(l,l),p=Np(c,a),f=Np(c,l),m=u*d-h*h,g=(d*p-h*f)/m,_=(u*f-h*p)/m,y=n.z*(1-g-_)+r.z*g+o.z*_;if(isFinite(y))return y}return 1/0}{let e=1/0;for(const i of t)e=Math.min(e,i.z);return e}}function Up(e,t,i){let n=1/0;su(i,t)&&(n=kp(i,t[0]));for(let r=0;r<t.length;r++){const o=t[r],s=e[r];for(let e=0;e<o.length-1;e++){const t=o[e],r=[t,o[e+1],s[e+1],s[e],t];ru(i,r)&&(n=Math.min(n,kp(i,r)))}}return n!==1/0&&n}function zp(e,t,i,n,r,o,s,a,l,c,u){return"globe"===e.projection.name?function(e,t,i,n,r,o,s,a,l,c,u){const h=[],d=[],p=e.projection.upVectorScale(u,e.center.lat,e.worldSize).metersToTile,f=[0,0,0,1],m=[0,0,0,1],g=(e,t,i,n)=>{e[0]=t,e[1]=i,e[2]=n,e[3]=1},_=Sp();i>0&&(i+=_),n+=_;for(const _ of t){const t=[],y=[];for(const h of _){const d=h.x+r.x,_=h.y+r.y,v=e.projection.projectTilePoint(d,_,u),x=e.projection.upVector(u,h.x,h.y);let b=i,T=n;if(s){const e=Vp(d,_,i,n,s,a,l,c);b+=e.base,T+=e.top}0!==i?g(f,v.x+x[0]*p*b,v.y+x[1]*p*b,v.z+x[2]*p*b):g(f,v.x,v.y,v.z),g(m,v.x+x[0]*p*T,v.y+x[1]*p*T,v.z+x[2]*p*T),G(f,f,o),G(m,m,o),t.push(new Pp(f[0],f[1],f[2])),y.push(new Pp(m[0],m[1],m[2]))}h.push(t),d.push(y)}return[h,d]}(e,t,i,n,r,o,s,a,l,c,u):s?function(e,t,i,n,r,o,s,a,l){const c=[],u=[],h=[0,0,0,1];for(const d of e){const e=[],p=[];for(const c of d){const u=c.x+n.x,d=c.y+n.y,f=Vp(u,d,t,i,o,s,a,l);h[0]=u,h[1]=d,h[2]=f.base,h[3]=1,Q(h,h,r),h[3]=Math.max(h[3],1e-5);const m=new Pp(h[0]/h[3],h[1]/h[3],h[2]/h[3]);h[0]=u,h[1]=d,h[2]=f.top,h[3]=1,Q(h,h,r),h[3]=Math.max(h[3],1e-5);const g=new Pp(h[0]/h[3],h[1]/h[3],h[2]/h[3]);e.push(m),p.push(g)}c.push(e),u.push(p)}return[c,u]}(t,i,n,r,o,s,a,l,c):function(e,t,i,n,r){const o=[],s=[],a=r[8]*t,l=r[9]*t,c=r[10]*t,u=r[11]*t,h=r[8]*i,d=r[9]*i,p=r[10]*i,f=r[11]*i;for(const t of e){const e=[],i=[];for(const o of t){const t=o.x+n.x,s=o.y+n.y,m=r[0]*t+r[4]*s+r[12],g=r[1]*t+r[5]*s+r[13],_=r[2]*t+r[6]*s+r[14],y=r[3]*t+r[7]*s+r[15],v=m+a,x=g+l,b=_+c,T=Math.max(y+u,1e-5),w=m+h,E=g+d,S=_+p,A=Math.max(y+f,1e-5);e.push(new Pp(v/T,x/T,b/T)),i.push(new Pp(w/A,E/A,S/A))}o.push(e),s.push(i)}return[o,s]}(t,i,n,r,o)}function Vp(e,t,i,n,r,o,s,a){const l=s*r.getElevationAt(e,t,!0,!0),c=0!==o[0],u=c?0===o[1]?s*(o[0]/rp-op):s*function(e,t,i){const n=Math.floor(t[0]/8),r=Math.floor(t[1]/8),o=10*(t[0]-8*n),s=10*(t[1]-8*r),a=e.getElevationAt(n,r,!0,!0),l=e.getMeterToDEM(i),c=Math.floor(.5*(o*l-1)),u=Math.floor(.5*(s*l-1)),h=e.tileCoordToPixel(n,r),d=2*c+1,p=2*u+1,f=function(e,t,i,n,r){return[e.getElevationAtPixel(t,i,!0),e.getElevationAtPixel(t+r,i,!0),e.getElevationAtPixel(t,i+r,!0),e.getElevationAtPixel(t+n,i+r,!0)]}(e,h.x-c,h.y-u,d,p),m=Math.abs(f[0]-f[1]),g=Math.abs(f[2]-f[3]),_=Math.abs(f[0]-f[2])+Math.abs(f[1]-f[3]),y=Math.min(.25,.5*l*(m+g)/d),v=Math.min(.25,.5*l*_/p);return a+Math.max(y*o,v*s)}(r,o,a):l;return{base:l+(0===i?-1:i),top:c?Math.max(u+n,l+i+2):l+n}}class Gp{constructor(e){this._callback=e,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class jp{constructor(){this.tasks={},this.taskQueue=[],Ve(["process"],this),this.invoker=new Gp(this.process),this.nextId=0}add(e,t){const i=this.nextId++,n=function({type:e,isSymbolTile:t,zoom:i}){return i=i||0,"message"===e?0:"maybePrepare"!==e||t?"parseTile"!==e||t?"parseTile"===e&&t?300-i:"maybePrepare"===e&&t?400-i:500:200-i:100-i}(t);if(0===n){try{e()}finally{}return null}return this.tasks[i]={fn:e,metadata:t,priority:n,id:i},this.taskQueue.push(i),this.invoker.trigger(),{cancel:()=>{delete this.tasks[i]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((e=>!!this.tasks[e])),!this.taskQueue.length)return;const e=this.pick();if(null===e)return;const t=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!t)return;t.fn()}finally{}}pick(){let e=null,t=1/0;for(let i=0;i<this.taskQueue.length;i++){const n=this.tasks[this.taskQueue[i]];n.priority<t&&(t=n.priority,e=i)}if(null===e)return null;const i=this.taskQueue[e];return this.taskQueue.splice(e,1),i}remove(){this.invoker.remove()}}class Hp{constructor(e,t,i){this.target=e,this.parent=t,this.mapId=i,this.callbacks={},this.cancelCallbacks={},Ve(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new jp}send(e,t,i,n,r=!1,o){const s=Math.round(1e18*Math.random()).toString(36).substring(0,10);i&&(i.metadata=o,this.callbacks[s]=i);const a=new Set;return this.target.postMessage({id:s,type:e,hasCallback:!!i,targetMapId:n,mustQueue:r,sourceMapId:this.mapId,data:ns(t,a)},a),{cancel:()=>{i&&delete this.callbacks[s],this.target.postMessage({id:s,type:"<cancel>",targetMapId:n,sourceMapId:this.mapId})}}}receive(e){const t=e.data;if(!t)return;const i=t.id;if(i&&(!t.targetMapId||this.mapId===t.targetMapId))if("<cancel>"===t.type){const e=this.cancelCallbacks[i];delete this.cancelCallbacks[i],e&&e.cancel()}else if(t.mustQueue||Je(self)){const e=this.callbacks[i],n=this.scheduler.add((()=>this.processTask(i,t)),e&&e.metadata||{type:"message"});n&&(this.cancelCallbacks[i]=n)}else this.processTask(i,t)}processTask(e,t){if(delete this.cancelCallbacks[e],"<response>"===t.type){const i=this.callbacks[e];delete this.callbacks[e],i&&(t.error?i(rs(t.error)):i(null,rs(t.data)))}else{const i=new Set,n=t.hasCallback?(t,n)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:t?ns(t):null,data:ns(n,i)},i)}:()=>{},r=rs(t.data);if(this.parent[t.type])this.parent[t.type](t.sourceMapId,r,n);else if(this.parent.getWorkerSource){const e=t.type.split("."),{source:i,scope:o}=r;this.parent.getWorkerSource(t.sourceMapId,e[0],i,o)[e[1]](r,n)}else n(new Error(`Could not find function ${t.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var $p={workerUrl:"",workerClass:null,workerParams:void 0};const Wp="mapboxgl_preloaded_worker_pool";class qp{constructor(){this.active={}}acquire(e,t=qp.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<t;)this.workers.push(null!=$p.workerClass?new $p.workerClass:new self.Worker($p.workerUrl,$p.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&0===this.numActive()&&(this.workers.forEach((e=>{e.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Wp]}numActive(){return Object.keys(this.active).length}}qp.workerCount=2;class Xp{constructor(e,t,i="Worker",n=qp.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Ue();const r=this.workerPool.acquire(this.id,n);for(let e=0;e<r.length;e++){const n=new Xp.Actor(r[e],t,this.id);n.name=`${i} ${e}`,this.actors.push(n)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(e,t,i){Ne(this.actors,((i,n)=>{i.send(e,t,n)}),i=i||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((e=>{e.remove()})),this.actors=[],this.workerPool.release(this.id)}}let Yp,Zp;function Jp(){return Yp||(Yp=new qp),Yp}Xp.Actor=Hp;class Kp{constructor(e){this.module=e}createIntArray(e){const t=new Int32Array(e),i=this.module.malloc(t.length*t.BYTES_PER_ELEMENT);return this.module.heap32.set(t,i/t.BYTES_PER_ELEMENT),i}createFloatArray(e){const t=new Float32Array(e),i=this.module.malloc(t.length*t.BYTES_PER_ELEMENT);return this.module.heapF32.set(t,i/t.BYTES_PER_ELEMENT),i}createStringBuffer(e){const t=this.module.malloc(e.length+1);for(let i=0;i<e.length;++i)this.module.heapU8[t+i]=e.charCodeAt(i);return this.module.heapU8[t+e.length]=0,t}readStringBuffer(e){let t="";for(;0!==this.module.heapU8[e];)t+=String.fromCharCode(this.module.heapU8[e]),++e;return t}setStyle(e){const t=e.entranceColorRgb,i=e.facadeGlazingColorRgb,n=e.roofColorRgb,r=e.wallColorRgb,o=e.normalScale;this.module.setStyle(t[0],t[1],t[2],i[0],i[1],i[2],n[0],n[1],n[2],r[0],r[1],r[2],o[0],o[1],o[2],e.tileToMeters)}setAOOptions(e,t){this.module.setAOOptions(e?1:0,t)}setMetricOptions(e,t){this.module.setMetricOptions(e?1:0,t)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,t){this.module.setFacadeOptions(e,t?1:0)}setFauxFacadeOptions(e,t,i){this.module.setFauxFacadeOptions(e?1:0,t?1:0,i)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,t){for(const t of e){const e=this.createStringBuffer(t.roofType),i=[0],n=[];for(const e of t.coordinates)if(Array.isArray(e)){for(const t of e)n.push(t.x),n.push(t.y);i.push(n.length)}const r=this.createIntArray(i),o=this.createFloatArray(n);this.module.addFeature(t.id,t.sourceId,t.minHeight,t.height,e,t.roofType.length,o,r,i.length-1),this.module.free(e),this.module.free(r),this.module.free(o)}for(const e of t){let t;t=e.entrances?JSON.parse(e.entrances):[];const i=this.createFloatArray(t),n=[];for(const t of e.coordinates)n.push(t.x),n.push(t.y);const r=this.createFloatArray(n);this.module.addFacade(e.sourceId,e.crossPerc,e.distanceToRoad,i,t.length,r,n.length),this.module.free(i),this.module.free(r)}if(!this.module.generateMesh()){const e=this.module.getLastError();return this.readStringBuffer(e)}const i=this.module.getMeshCount(),n=new Array(i);for(let e=0;e<i;e++){const t=this.module.getPositionsPtr(e),i=this.module.getPositionsLength(e),r=new Float32Array(this.module.heapF32.buffer,t,i),o=this.module.getNormalsPtr(e),s=this.module.getNormalsLength(e),a=new Float32Array(this.module.heapF32.buffer,o,s),l=this.module.getColorsPtr(e),c=this.module.getColorsLength(e),u=new Uint8Array(this.module.heapU8.buffer,l,c),h=this.module.getAOPtr(e),d=this.module.getAOLength(e),p=new Float32Array(this.module.heapF32.buffer,h,d),f=this.module.getUVPtr(e),m=this.module.getUVLength(e),g=new Float32Array(this.module.heapF32.buffer,f,m),_=this.module.getFauxFacadePtr(e),y=this.module.getFauxFacadeLength(e),v=new Uint8Array(this.module.heapU8.buffer,_,y),x=this.module.getIndicesPtr(e),b=this.module.getIndicesLength(e),T=new Int32Array(this.module.heap32.buffer,x,b),w=this.module.getBuildingPart(e),E=this.readStringBuffer(w);n[e]={positions:r,normals:a,colors:u,ao:p,uv:g,isFauxFacade:v,indices:T,buildingPart:E}}const r=this.module.getRingCount(),o=[];for(let e=0;e<r;e++){const t=this.module.getRingPtr(e),i=this.module.getRingLength(e),n=new Float32Array(this.module.heapF32.buffer,t,i);o.push(n)}return{meshes:n,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:o}}}let Qp,ef,tf,nf,rf,of=null,sf=null,af=null,lf=null;function cf(){return Je(self)&&self.worker.dracoUrl?self.worker.dracoUrl:ef||st.DRACO_URL}function uf(){if(Je(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(nf)return nf;const e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return nf=WebAssembly.validate(e)?st.MESHOPT_SIMD_URL:st.MESHOPT_URL,nf}function hf(){return lf}const df={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},pf={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},ff={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function mf(e,t,i){const n=i.json.bufferViews.length,r=i.buffers.length;t.bufferView=n,i.json.bufferViews[n]={buffer:r,byteLength:e.byteLength},i.buffers[r]=e}const gf="KHR_draco_mesh_compression";function _f(e,t){const i=e.extensions&&e.extensions[gf];if(!i)return;const n=new tf.Decoder,r=Ef(t,i.bufferView),o=new tf.Mesh;if(!n.DecodeArrayToMesh(r,r.byteLength,o))throw new Error("Failed to decode Draco mesh");const s=t.json.accessors[e.indices],a=df[s.componentType],l=s.count*a.BYTES_PER_ELEMENT,c=tf._malloc(l);a===Uint16Array?n.GetTrianglesUInt16Array(o,l,c):n.GetTrianglesUInt32Array(o,l,c),mf(tf.memory.buffer.slice(c,c+l),s,t),tf._free(c);for(const r of Object.keys(i.attributes)){const s=n.GetAttributeByUniqueId(o,i.attributes[r]),a=t.json.accessors[e.attributes[r]],l=pf[a.componentType],c=a.count*ff[a.type]*df[a.componentType].BYTES_PER_ELEMENT,u=tf._malloc(c);n.GetAttributeDataArrayForAllPoints(o,s,tf[l],c,u),mf(tf.memory.buffer.slice(u,u+c),a,t),tf._free(u)}n.destroy(),o.destroy(),delete e.extensions[gf]}const yf="EXT_meshopt_compression";function vf(e,t){if(!e.extensions||!e.extensions[yf])return;const i=e.extensions[yf],n=new Uint8Array(t.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),r=new Uint8Array(i.count*i.byteStride);rf.decodeGltfBuffer(r,i.count,i.byteStride,n,i.mode,i.filter),e.buffer=t.buffers.length,e.byteOffset=0,t.buffers[e.buffer]=r.buffer,delete e.extensions[yf]}const xf=1179937895,bf=new TextDecoder("utf8");function Tf(e,t){return new URL(e,t).href}function wf(e,t,i,n){return fetch(Tf(e.uri,n)).then((e=>e.arrayBuffer())).then((e=>{t.buffers[i]=e}))}function Ef(e,t){const i=e.json.bufferViews[t];return new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function Sf(e,t,i,n){if(e.uri){const r=Tf(e.uri,n);return fetch(r).then((e=>e.blob())).then((e=>createImageBitmap(e))).then((e=>{t.images[i]=e}))}if(void 0!==e.bufferView){const n=Ef(t,e.bufferView),r=new Blob([n],{type:e.mimeType});return createImageBitmap(r).then((e=>{t.images[i]=e}))}}function Af(e,t=0,i){const n={json:null,images:[],buffers:[]};if(new Uint32Array(e,t,1)[0]===xf){const i=new Uint32Array(e,t);let r=2;const o=(i[r++]>>2)-3,s=i[r++]>>2;if(r++,n.json=JSON.parse(bf.decode(i.subarray(r,r+s))),r+=s,r<o){const o=i[r++];r++;const s=t+(r<<2);n.buffers[0]=e.slice(s,s+o)}}else n.json=JSON.parse(bf.decode(new Uint8Array(e,t)));const{buffers:r,images:o,meshes:s,extensionsUsed:a,bufferViews:l}=n.json;let c=Promise.resolve();if(r){const e=[];for(let t=0;t<r.length;t++){const o=r[t];o.uri?e.push(wf(o,n,t,i)):n.buffers[t]||(n.buffers[t]=null)}c=Promise.all(e)}return c.then((()=>{const e=[],t=a&&a.includes(gf),r=a&&a.includes(yf);if(t&&e.push(function(){if(!tf)return null!=Qp?Qp:(Qp=function(e){let t,i=null;function n(){t=new Uint8Array(i.buffer)}function r(){throw new Error("Unexpected Draco error.")}const o={a:{a:r,d:function(e,i,n){return t.copyWithin(e,i,i+n)},c:function(e){const r=t.length,o=Math.max(e>>>0,Math.ceil(1.2*r)),s=Math.ceil((o-r)/65536);try{return i.grow(s),n(),!0}catch(e){return!1}},b:r}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(e,o):e.then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,o)))).then((e=>{const{Rb:r,Qb:o,P:s,T:a,X:l,Ja:c,La:u,Qa:h,Va:d,Wa:p,eb:f,jb:m,f:g,e:_,yb:y,zb:v,Ab:x,Bb:b,Db:T,Gb:w}=e.instance.exports;i=_;const E=(()=>{let e=0,i=0,n=0,s=0;return a=>{n&&(r(s),r(e),i+=n,n=e=0),e||(i+=128,e=o(i));const l=a.length+7&-8;let c=e;l>=i&&(n=l,c=s=o(l));for(let e=0;e<a.length;e++)t[c+e]=a[e];return c}})();return n(),g(),{memory:_,_free:r,_malloc:o,Mesh:class{constructor(){this.ptr=s()}destroy(){a(this.ptr)}},Decoder:class{constructor(){this.ptr=c()}destroy(){m(this.ptr)}DecodeArrayToMesh(e,t,i){const n=E(e),r=u(this.ptr,n,t,i.ptr);return!!l(r)}GetAttributeByUniqueId(e,t){return{ptr:h(this.ptr,e.ptr,t)}}GetTrianglesUInt16Array(e,t,i){d(this.ptr,e.ptr,t,i)}GetTrianglesUInt32Array(e,t,i){p(this.ptr,e.ptr,t,i)}GetAttributeDataArrayForAllPoints(e,t,i,n,r){f(this.ptr,e.ptr,t.ptr,i,n,r)}},DT_INT8:y(),DT_UINT8:v(),DT_INT16:x(),DT_UINT16:b(),DT_UINT32:T(),DT_FLOAT32:w()}}))}(fetch(cf())),Qp.then((e=>{tf=e,Qp=void 0})))}()),r&&e.push(function(){if(rf)return;const e=function(e){let t;const i=WebAssembly.instantiateStreaming(e,{}).then((e=>{t=e.instance,t.exports.__wasm_call_ctors()})),n={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},r={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:i,supported:!0,decodeGltfBuffer(e,i,o,s,a,l){!function(e,t,i,n,r,o,s){const a=e.exports.sbrk,l=n+3&-4,c=a(l*r),u=a(o.length),h=new Uint8Array(e.exports.memory.buffer);h.set(o,u);const d=t(c,n,r,u,o.length);if(0===d&&s&&s(c,l,r),i.set(h.subarray(c,c+n*r)),a(c-a(0)),0!==d)throw new Error(`Malformed buffer data: ${d}`)}(t,t.exports[r[a]],e,i,o,s,t.exports[n[l]])}}}(fetch(uf()));return e.ready.then((()=>{rf=e}))}()),o)for(let t=0;t<o.length;t++)e.push(Sf(o[t],n,t,i));return(e.length?Promise.all(e):Promise.resolve()).then((()=>{if(t&&s)for(const{primitives:e}of s)for(const t of e)_f(t,n);if(r&&s&&l)for(const e of l)vf(e,n);return n}))}))}function Mf(e){return fetch(e).then((e=>e.arrayBuffer())).then((t=>Af(t,0,e)))}function If(e){switch(e){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function Cf(e){switch(e){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Pf{constructor(e,t,i,n){this.context=e,this.format=i,this.useMipmap=n&&n.useMipmap,this.texture=e.gl.createTexture(),this.update(t,{premultiply:n&&n.premultiply})}update(e,t){const i=e&&e instanceof HTMLVideoElement&&0===e.width?e.videoWidth:e.width,n=e&&e instanceof HTMLVideoElement&&0===e.height?e.videoHeight:e.height,{context:r}=this,{gl:o}=r,{x:s,y:a}=t&&t.position?t.position:{x:0,y:0},l=s+i,c=a+n;!this.size||this.size[0]===l&&this.size[1]===c||(o.bindTexture(o.TEXTURE_2D,null),o.deleteTexture(this.texture),this.texture=o.createTexture(),this.size=null),o.bindTexture(o.TEXTURE_2D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(this.format===o.RGBA8&&(!t||!1!==t.premultiply));const u=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&l>0&&c>0){const e=this.useMipmap?Math.floor(Math.log2(Math.max(l,c)))+1:1;o.texStorage2D(o.TEXTURE_2D,e,this.format,l,c),this.size=[l,c]}this.size&&(u?o.texSubImage2D(o.TEXTURE_2D,0,s,a,If(this.format),Cf(this.format),e):"data"in e&&e.data&&o.texSubImage2D(o.TEXTURE_2D,0,s,a,i,n,If(this.format),Cf(this.format),e.data)),this.useMipmap&&o.generateMipmap(o.TEXTURE_2D)}bind(e,t,i=!1){const{context:n}=this,{gl:r}=n;r.bindTexture(r.TEXTURE_2D,this.texture),e!==this.minFilter&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this.useMipmap&&!i?e===r.NEAREST?r.NEAREST_MIPMAP_NEAREST:r.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),t!==this.wrapS&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,t),this.wrapS=t)}bindExtraParam(e,t,i,n,r){const{context:o}=this,{gl:s}=o;s.bindTexture(s.TEXTURE_2D,this.texture),t!==this.magFilter&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,t),this.magFilter=t),e!==this.minFilter&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,this.useMipmap?e===s.NEAREST?s.NEAREST_MIPMAP_NEAREST:s.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,i),this.wrapS=i),n!==this.wrapT&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,n),this.wrapT=n),r!==this.compareMode&&(r?(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_FUNC,r)):s.texParameteri(s.TEXTURE_2D,s.TEXTURE_COMPARE_MODE,s.NONE),this.compareMode=r)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Lf{constructor(e,t){this.context=e,this.texture=t}bind(e,t){const{context:i}=this,{gl:n}=i;n.bindTexture(n.TEXTURE_2D,this.texture),e!==this.minFilter&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,e),this.minFilter=e),t!==this.wrapS&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,t),this.wrapS=t)}}const Rf=ha([{name:"a_pos_3f",components:3,type:"Float32"}]),Of=ha([{name:"a_color_3f",components:3,type:"Float32"}]),Df=ha([{name:"a_color_4f",components:4,type:"Float32"}]),Bf=ha([{name:"a_uv_2f",components:2,type:"Float32"}]),Ff=ha([{name:"a_normal_3f",components:3,type:"Float32"}]),Nf=ha([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),kf=ha([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function Uf(e,t){const i=Vf(e.projection,e.zoom,e.width,e.height),n=function(e,t,i,n,r){const o=new rc(i.lng-180*Gf,i.lat),s=new rc(i.lng+180*Gf,i.lat),a=e.project(o.lng,o.lat),l=e.project(s.lng,s.lat),u=-Math.atan2(l.y-a.y,l.x-a.x),d=xc.fromLngLat(i);d.y=De(d.y,-1+Gf,1-Gf);const f=d.toLngLat(),m=e.project(f.lng,f.lat),_=xc.fromLngLat(f);_.x+=Gf;const y=_.toLngLat(),v=e.project(y.lng,y.lat),x=Hf(v.x-m.x,v.y-m.y,u),b=xc.fromLngLat(f);b.y+=Gf;const T=b.toLngLat(),w=e.project(T.lng,T.lat),E=Hf(w.x-m.x,w.y-m.y,u),S=Math.abs(x.x)/Math.abs(E.y),A=c([]);g(A,A,-u*(1-(r?0:n)));const M=c([]);return p(M,M,[1,1-(1-S)*n,1]),M[4]=-E.x/E.y*n,g(M,M,u),h(M,A,M),M}(e.projection,0,e.center,i,t),r=zf(e);return p(n,n,[r,r,1]),n}function zf(e){const t=e.projection,i=Vf(e.projection,e.zoom,e.width,e.height),n=jf(t,e.center),r=jf(t,rc.convert(t.center));return Math.pow(2,n*i+(1-i)*r)}function Vf(e,t,i,n,r=1/0){const o=e.range;if(!o)return 0;const s=Math.min(r,Math.max(i,n)),a=Math.log2(s/1024);return Be(o[0]+a,o[1]+a,t)}const Gf=1/4e4;function jf(e,t){const i=De(t.lat,-mc,mc),n=new rc(t.lng-180*Gf,i),r=new rc(t.lng+180*Gf,i),o=e.project(n.lng,i),s=e.project(r.lng,i),a=xc.fromLngLat(n),l=xc.fromLngLat(r),c=s.x-o.x,u=s.y-o.y,h=l.x-a.x,d=l.y-a.y,p=Math.sqrt((h*h+d*d)/(c*c+u*u));return Math.log2(p)}function Hf(e,t,i){const n=Math.cos(i),r=Math.sin(i);return{x:e*n-t*r,y:e*r+t*n}}function $f(e,t,i){c(e),g(e,e,Ie(t[2])),f(e,e,Ie(t[0])),m(e,e,Ie(t[1])),p(e,e,i),h(e,e,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Wf(e,t,i,n,r,o,s,a){const l=[i[0]-t[0],i[1]-t[1],0],c=[n[0]-t[0],n[1]-t[1],0];if(E(l)<1e-12||E(c)<1e-12)return te(e);const u=z([],l,c);k(u,u),I(c,n,t),l[2]=(o-r)*a,c[2]=(s-r)*a;const h=l;return z(h,l,c),k(h,h),le(e,u,h)}function qf(e,t,i=!1){const n=th(t.zoom),r=function(e,t,i){const n=t.worldSize,r=[e[12],e[13],e[14]],o=pc(r[1]/n),s=dc(r[0]/n),a=c([]),l=hc(1,o)*n,u=hc(1,0)*n*_c(o,t.zoom),f=1/Ku(n);let m=u*f;if(i){const e=Vf(t.projection,t.zoom,t.width,t.height,1024);m=f*t.projection.pixelSpaceConversion(t.center.lat,n,e)}const g=tc(o,s);M(g,g,R([],k([],g),l*m*r[2]));const _=function(e){const t=[e[0],e[1],e[2]];let i=[0,1,0];const n=z([],i,t);return z(i,t,n),0===F(i)&&(i=[0,1,0],z(n,t,i)),k(n,n),k(i,i),k(t,t),[n[0],n[1],n[2],0,i[0],i[1],i[2],0,t[0],t[1],t[2],0,e[0],e[1],e[2],1]}(g);p(a,a,[m,m,m*l]),d(a,a,[-r[0],-r[1],-r[2]]);const y=h([],t.globeMatrix,_);return h(y,y,a),h(y,y,e),y}(e,t,i);if(n>0){const i=function(e,t){const i=t.worldSize,n=hc(1,0)*i*_c(t.center.lat,t.zoom)/Ku(i),r=hc(1,t.center.lat)*i,o=c([]);m(o,o,Ie(t.center.lng)),f(o,o,Ie(t.center.lat)),d(o,o,[0,0,Wl]),p(o,o,[n,n,n*r]);const s=t.point;return d(o,o,[-s.x,-s.y,0]),h(o,o,e),h(o,t.globeMatrix,o)}(e,t);return function(e,t,i){const n=(e,t,i)=>{const n=E(e),r=E(t),o=Gu(e,t,i);return R(o,o,1/E(o)*di(n,r,i))},r=n([e[0],e[1],e[2]],[t[0],t[1],t[2]],i),o=n([e[4],e[5],e[6]],[t[4],t[5],t[6]],i),s=n([e[8],e[9],e[10]],[t[8],t[9],t[10]],i),a=Gu([e[12],e[13],e[14]],[t[12],t[13],t[14]],i);return[r[0],r[1],r[2],0,o[0],o[1],o[2],0,s[0],s[1],s[2],0,a[0],a[1],a[2],1]}(r,i,n)}return r}function Xf(e,t,i,n){const r=Kc.projectAabbCorners(n,i);let o=Number.MAX_VALUE;for(let e=0;e<r.length;++e){const i=r[e];i[0]=(.5*i[0]+.5)*t.width,i[1]=(.5-.5*i[1])*t.height,i[2]<o&&(o=i[2])}const s=function(e){const t=[];let i=0;for(let t=1;t<e.length;t++)(e[t][0]<e[i][0]||e[t][0]===e[i][0]&&e[t][1]<e[i][1])&&(i=t);let n,r=i;const o=new Uint8Array(e.length);do{if(o[r])break;t.push(new Ee(e[r][0],e[r][1])),o[r]=1,n=(r+1)%e.length;for(let t=0;t<e.length;t++){if(e[t][0]===e[n][0]&&e[t][1]===e[n][1]||e[t][0]===e[r][0]&&e[t][1]===e[r][1])continue;const i=[e[t][0]-e[r][0],e[t][1]-e[r][1]],o=[e[n][0]-e[r][0],e[n][1]-e[r][1]],s=i[0]*o[1]-i[1]*o[0];(s>0||0===s&&i[0]*o[0]+i[1]*o[1]>=0&&i[0]*i[0]+i[1]*i[1]>o[0]*o[0]+o[1]*o[1])&&(n=t)}r=n}while(r!==i);return t.length>0&&t.push(t[0]),t}(r);if(ru(e,s))return o}const Yf=64,Zf={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Jf(e,t,i,n,r,o,s,a,l,u=!1){const f=i.zoom,m=i.project(n),g=_c(n.lat,f),_=1/g;c(e),d(e,e,[m.x+s[0]*_,m.y+s[1]*_,s[2]]);let y=1,v=1;const b=i.worldSize;if(u){if("mercator"===i.projection.name){let e=0;i.elevation&&(e=i.elevation.getAtPointOrZero(new xc(m.x/b,m.y/b),0));const t=Q([],[m.x,m.y,e,1],i.projMatrix)[3]/i.cameraToCenterDistance;y=t,v=t*_c(i.center.lat,f)}else if("globe"===i.projection.name){const t=qf(e,i),r=[0,0,0,1];Q(r,r,h([],i.projMatrix,t));const o=r[3]/i.cameraToCenterDistance,s=th(f),a=i.projection.pixelsPerMeter(n.lat,b)*_c(n.lat,f),l=i.projection.pixelsPerMeter(i.center.lat,b)*_c(i.center.lat,f);y=o/di(a,gc(i.center.lat),s),v=o*g/a,y*=l,v*=l}}else y=_;p(e,e,[y,y,v]);const T=[...e],w=t.orientation,E=[];if($f(E,[w[0]+(r?r[0]:0),w[1]+(r?r[1]:0),w[2]+(r?r[2]:0)],o),h(e,T,E),a&&i.elevation){let r=0;const o=[];if(l&&i.elevation){r=function(e,t,i,n,r){const o=t.elevation;if(!o)return 0;const s=Kc.projectAabbCorners(i,n),a=hc(1,r.lat)*t.worldSize,l=function(e,t){const i=[0,0,1],n=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const r of n){const n=e[r.corners[0]],o=e[r.corners[1]],s=e[r.corners[2]],a=[o[0]-n[0],o[1]-n[1],t*(o[2]-n[2])],l=z(a,a,[s[0]-n[0],s[1]-n[1],t*(s[2]-n[2])]);k(l,l),r.dotProductWithUp=U(l,i)}return n.sort(((e,t)=>e.dotProductWithUp-t.dotProductWithUp)),n[0].corners}(s,a),c=s[l[0]],u=s[l[1]],h=s[l[2]],d=s[l[3]],p=o.getAtPointOrZero(new xc(c[0]/t.worldSize,c[1]/t.worldSize),0),f=o.getAtPointOrZero(new xc(u[0]/t.worldSize,u[1]/t.worldSize),0),m=o.getAtPointOrZero(new xc(h[0]/t.worldSize,h[1]/t.worldSize),0),g=o.getAtPointOrZero(new xc(d[0]/t.worldSize,d[1]/t.worldSize),0),_=(p+g)/2,y=(f+m)/2;return _>y?f<m?Wf(e,u,d,c,f,g,p,a):Wf(e,h,c,d,m,p,g,a):p<g?Wf(e,c,u,h,p,f,m,a):Wf(e,d,h,u,g,m,f,a),Math.max(_,y)}(o,i,t.aabb,e,n);const s=h([],x([],o),E);h(e,T,s)}else r=i.elevation.getAtPointOrZero(new xc(m.x/b,m.y/b),0);0!==r&&(e[14]+=r)}}class Kf{constructor(e,t,i,n,r){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=e,this.uri=t,this.position=null!=i?new rc(i[0],i[1]):new rc(0,0),this.orientation=null!=n?n:[0,0,0],this.nodes=r,this.uploaded=!1,this.aabb=new Kc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(e,t){h(e.globalMatrix,t,e.localMatrix);const i=this.nodeOverrides.get(e.name);if(void 0!==i){const t=[];r=i.orientation,c(n=t),m(n,n,Ie(r[1])),g(n,n,Ie(r[2])),f(n,n,Ie(r[0])),h(e.globalMatrix,e.globalMatrix,t)}var n,r;if(e.meshes)for(const t of e.meshes){const i=Kc.applyTransformFast(t.aabb,e.globalMatrix);this.aabb.encapsulate(i)}if(e.children)for(const t of e.children)this._applyTransformations(t,e.globalMatrix)}computeBoundsAndApplyParent(){const e=c([]);this.aabb=new Kc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const t of this.nodes)this._applyTransformations(t,e)}computeModelMatrix(e,t,i,n,r,o,s=!1){Jf(this.matrix,this,e.transform,this.position,t,i,n,r,o,s)}upload(e){if(!this.uploaded){for(const t of this.nodes)tm(t,e);for(const e of this.nodes)im(e);this.uploaded=!0}}destroy(){for(const e of this.nodes)nm(e)}}function Qf(e,t,i=!1){e.uploaded||(e.gfxTexture=new Pf(t,e.image,i?t.gl.R8:t.gl.RGBA8,{useMipmap:e.sampler.minFilter>=t.gl.NEAREST_MIPMAP_NEAREST}),e.uploaded=!0,e.image=null)}function em(e,t,i){e.indexBuffer=t.createIndexBuffer(e.indexArray,!1,!0),e.vertexBuffer=t.createVertexBuffer(e.vertexArray,Rf.members,!1,!0),e.normalArray&&(e.normalBuffer=t.createVertexBuffer(e.normalArray,Ff.members,!1,!0)),e.texcoordArray&&(e.texcoordBuffer=t.createVertexBuffer(e.texcoordArray,Bf.members,!1,!0)),e.colorArray&&(e.colorBuffer=t.createVertexBuffer(e.colorArray,(12===e.colorArray.bytesPerElement?Of:Df).members,!1,!0)),e.featureArray&&(e.pbrBuffer=t.createVertexBuffer(e.featureArray,kf.members,!0)),e.segments=hl.simpleSegment(0,0,e.vertexArray.length,e.indexArray.length);const n=e.material;n.pbrMetallicRoughness.baseColorTexture&&Qf(n.pbrMetallicRoughness.baseColorTexture,t),n.pbrMetallicRoughness.metallicRoughnessTexture&&Qf(n.pbrMetallicRoughness.metallicRoughnessTexture,t),n.normalTexture&&Qf(n.normalTexture,t),n.occlusionTexture&&Qf(n.occlusionTexture,t,i),n.emissionTexture&&Qf(n.emissionTexture,t)}function tm(e,t,i){if(e.meshes)for(const n of e.meshes)em(n,t,i);if(e.children)for(const n of e.children)tm(n,t,i)}function im(e){if(e.meshes)for(const t of e.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(e.children)for(const t of e.children)im(t)}function nm(e){if(e.meshes)for(const i of e.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((t=i.material).pbrMetallicRoughness.baseColorTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),t.pbrMetallicRoughness.metallicRoughnessTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),t.normalTexture&&t.normalTexture.gfxTexture&&t.normalTexture.gfxTexture.destroy(),t.emissionTexture&&t.emissionTexture.gfxTexture&&t.emissionTexture.gfxTexture.destroy(),t.occlusionTexture&&t.occlusionTexture.gfxTexture&&t.occlusionTexture.gfxTexture.destroy()));var t;if(e.children)for(const t of e.children)nm(t)}function rm(e,t){const i=e.json.bufferViews[t.bufferView],n=df[t.componentType];return new n(e.buffers[i.buffer],(t.byteOffset||0)+(i.byteOffset||0),t.count*(i.byteStride&&i.byteStride!==ff[t.type]*n.BYTES_PER_ELEMENT?i.byteStride/n.BYTES_PER_ELEMENT:ff[t.type]))}function om(e,t,i,n){const r=df[t.componentType],o=function(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(r),s=e.json.bufferViews[t.bufferView],a=s.byteStride?s.byteStride/r.BYTES_PER_ELEMENT:ff[t.type],l=i.float32,c=l.length/i.capacity;for(let e=0,i=0;e<t.count*a;e+=a,i+=c)for(let t=0;t<c;t++)l[i+t]=n[e+t]*o;i._trim()}function sm(e,t,i){const n=e.indices,r=e.attributes,o={};o.indexArray=new Da;const s=t.json.accessors[n],a=s.count/3;o.indexArray.reserve(a);const l=rm(t,s);for(let e=0;e<a;e++)o.indexArray.emplaceBack(l[3*e],l[3*e+1],l[3*e+2]);o.indexArray._trim(),o.vertexArray=new ba;const c=t.json.accessors[r.POSITION];o.vertexArray.reserve(c.count);const u=rm(t,c);for(let e=0;e<c.count;e++)o.vertexArray.emplaceBack(u[3*e],u[3*e+1],u[3*e+2]);if(o.vertexArray._trim(),o.aabb=new Kc(c.min,c.max),o.centroid=function(e,t){const i=[0,0,0],n=e.length;if(n>0){for(let r=0;r<n;r++){const n=3*e[r];i[0]+=t[n],i[1]+=t[n+1],i[2]+=t[n+2]}i[0]/=n,i[1]/=n,i[2]/=n}return i}(l,u),void 0!==r.COLOR_0){const e=t.json.accessors[r.COLOR_0],i=ff[e.type],n=rm(t,e);o.colorArray=3===i?new ba:new Ma,o.colorArray.resize(e.count),om(t,e,o.colorArray,n)}if(void 0!==r.NORMAL){o.normalArray=new ba;const e=t.json.accessors[r.NORMAL];o.normalArray.resize(e.count);const i=rm(t,e);om(t,e,o.normalArray,i)}if(void 0!==r.TEXCOORD_0&&i.length>0){o.texcoordArray=new Ga;const e=t.json.accessors[r.TEXCOORD_0];o.texcoordArray.resize(e.count);const i=rm(t,e);om(t,e,o.texcoordArray,i)}if(void 0!==r._FEATURE_ID_RGBA4444){const e=t.json.accessors[r._FEATURE_ID_RGBA4444];t.json.extensionsUsed&&t.json.extensionsUsed.includes("EXT_meshopt_compression")&&(o.featureData=rm(t,e))}void 0!==r._FEATURE_RGBA4444&&(o.featureData=new Uint32Array(rm(t,t.json.accessors[r._FEATURE_RGBA4444]).buffer));const h=e.material;return o.material=function(e,t){const{emissiveFactor:i=[0,0,0],alphaMode:n="OPAQUE",alphaCutoff:r=.5,normalTexture:o,occlusionTexture:s,emissiveTexture:a,doubleSided:l,name:c}=e,{baseColorFactor:u=[1,1,1,1],metallicFactor:h=1,roughnessFactor:d=1,baseColorTexture:p,metallicRoughnessTexture:f}=e.pbrMetallicRoughness||{},m=s?t[s.index]:void 0;if(s&&s.extensions&&s.extensions.KHR_texture_transform&&m){const e=s.extensions.KHR_texture_transform;m.offsetScale=[e.offset[0],e.offset[1],e.scale[0],e.scale[1]]}return{name:c,pbrMetallicRoughness:{baseColorFactor:new li(...u),metallicFactor:h,roughnessFactor:d,baseColorTexture:p?t[p.index]:void 0,metallicRoughnessTexture:f?t[f.index]:void 0},doubleSided:l,emissiveFactor:new li(...i),alphaMode:n,alphaCutoff:r,normalTexture:o?t[o.index]:void 0,occlusionTexture:m,emissionTexture:a?t[a.index]:void 0,defined:void 0===e.defined}}(void 0!==h?t.json.materials[h]:{defined:!1},i),o}function am(e,t,i){const{matrix:n,rotation:r,translation:o,scale:s,mesh:a,extras:c,children:u,name:h}=e,d={};if(d.name=h,d.localMatrix=n||function(e,t,i,n){var r=t[0],o=t[1],s=t[2],a=t[3],l=r+r,c=o+o,u=s+s,h=r*l,d=r*c,p=r*u,f=o*c,m=o*u,g=s*u,_=a*l,y=a*c,v=a*u,x=n[0],b=n[1],T=n[2];return e[0]=(1-(f+g))*x,e[1]=(d+v)*x,e[2]=(p-y)*x,e[3]=0,e[4]=(d-v)*b,e[5]=(1-(h+g))*b,e[6]=(m+_)*b,e[7]=0,e[8]=(p+y)*T,e[9]=(m-_)*T,e[10]=(1-(h+f))*T,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}([],r||[0,0,0,1],o||[0,0,0],s||[1,1,1]),d.globalMatrix=l(d.localMatrix),void 0!==a){d.meshes=i[a];const e=d.anchor=[0,0];for(const t of d.meshes){const{min:i,max:n}=t.aabb;e[0]+=i[0]+n[0],e[1]+=i[1]+n[1]}e[0]=Math.floor(e[0]/d.meshes.length/2),e[1]=Math.floor(e[1]/d.meshes.length/2)}if(c&&(c.id&&(d.id=c.id),c.lights&&(d.lights=function(e){if(!e.length)return[];const t=function(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.codePointAt(e);return i}(e),i=[],n=t.length/24,r=new Uint16Array(t.buffer),o=new Float32Array(t.buffer);for(let e=0;e<n;e++){const t=r[2*e*6]/30,n=r[2*e*6+1]/30,s=r[2*e*6+10]/100,a=o[6*e+1],l=o[6*e+2],c=o[6*e+3],u=o[6*e+4],h=c-a,d=u-l,p=Math.hypot(h,d);i.push({pos:[a+.5*h,l+.5*d,n],normal:[d/p,-h/p,0],width:p,height:t,depth:s,points:[a,l,c,u]})}return i}(c.lights)),c.MAPBOX_geometry_bloom&&(d.isGeometryBloom=c.MAPBOX_geometry_bloom)),u){const e=[];for(const n of u)e.push(am(t.json.nodes[n],t,i));d.children=e}return d}function lm(e){if(0===e.vertices.length||0===e.indices.length)return null;const t=new Sd(e.vertices,e.indices,8,256),[i,n]=[t.min.clone(),t.max.clone()];return{vertices:e.vertices,indices:e.indices,grid:t,min:i,max:n}}function cm(e){if(!e.extras||!e.extras.ground)return null;const t=e.extras.ground;if(!t||!Array.isArray(t)||0===t.length)return null;const i=t[0];if(!i||!Array.isArray(i)||0===i.length)return null;const n=[];for(const e of i){if(!Array.isArray(e)||2!==e.length)continue;const t=e[0],i=e[1];"number"==typeof t&&"number"==typeof i&&n.push(new Ee(t,i))}if(n.length<3)return null;n.length>1&&n[n.length-1].equals(n[0])&&n.pop();let r=0;for(let e=0;e<n.length;e++){const t=n[e],i=n[(e+1)%n.length],o=n[(e+2)%n.length];r+=(t.x-i.x)*(o.y-i.y)-(o.x-i.x)*(t.y-i.y)}r>0&&n.reverse();const o=Ph(n.flatMap((e=>[e.x,e.y])),[]);return 0===o.length?null:{vertices:n,indices:o}}function um(e,t){const i=[],n=[];let r=0;const o=[];for(const s of e){r=i.length;const e=s.vertexArray.float32,a=s.indexArray.uint16;for(let n=0;n<s.vertexArray.length;n++)o[0]=e[3*n+0],o[1]=e[3*n+1],o[2]=e[3*n+2],G(o,o,t),i.push(new Ee(o[0],o[1]));for(let e=0;e<3*s.indexArray.length;e++)n.push(a[e]+r)}if(n.length%3!=0)return null;for(let e=0;e<n.length;e+=3){const t=i[n[e+0]],r=i[n[e+1]],o=i[n[e+2]];(t.x-r.x)*(o.y-r.y)-(o.x-r.x)*(t.y-r.y)>0&&([n[e+1],n[e+2]]=[n[e+2],n[e+1]])}return{vertices:i,indices:n}}function hm(e){const t=function(e,t){const i=[],n=WebGL2RenderingContext;if(e.json.textures)for(const r of e.json.textures){const o={magFilter:n.LINEAR,minFilter:n.NEAREST,wrapS:n.REPEAT,wrapT:n.REPEAT};void 0!==r.sampler&&Object.assign(o,e.json.samplers[r.sampler]),i.push({image:t[r.source],sampler:o,uploaded:!1})}return i}(e,e.images),i=function(e,t){const i=[];for(const n of e.json.meshes){const r=[];for(const i of n.primitives)r.push(sm(i,e,t));i.push(r)}return i}(e,t),{scenes:n,scene:r,nodes:o}=e.json,s=n?n[r||0].nodes:[...o.keys()],a=[];for(const t of s)a.push(am(o[t],e,i));return function(e,t,i){const n={},r=new Set;for(let o=0;o<e.length;o++){const e=i[t[o]];if(!e.extras)continue;const s=e.extras["mapbox:footprint:version"],a=e.extras["mapbox:footprint:id"];(s||a)&&r.add(o),"1.0.0"===s&&a&&(n[a]=o)}for(let o=0;o<e.length;o++){if(r.has(o))continue;const s=e[o],a=i[t[o]];if(!a.extras)continue;let l=null;s.id in n&&(l=um(e[n[s.id]].meshes,s.localMatrix)),l||(l=cm(a)),l&&(s.footprint=lm(l))}if(r.size>0){const t=Array.from(r.values()).sort(((e,t)=>e-t));for(let i=t.length-1;i>=0;i--)e.splice(t[i],1)}}(a,s,e.json.nodes),a}function dm(e){e.heightmap=new Float32Array(4096),e.heightmap.fill(-1);const t=e.vertexArray.float32,i=e.aabb.min[0]-1,n=e.aabb.min[1]-1,r=Yf/(e.aabb.max[0]-i+2),o=Yf/(e.aabb.max[1]-n+2);for(let s=0;s<t.length;s+=3){const a=t[s+2],l=(t[s+0]-i)*r|0,c=(t[s+1]-n)*o|0;a>e.heightmap[c*Yf+l]&&(e.heightmap[c*Yf+l]=a)}}function pm(e,t,i,n,r){i.reserve(i.length+4*e.length),n.reserve(n.length+10*e.length),r.reserve(r.length+10*e.length);let o=n.length;for(const s of e){const e=Math.min(10,Math.max(4,1.3*s.height))*t,a=[-s.normal[1],s.normal[0],0],l=Math.min(.29,.1*s.width/s.depth),c=s.width-2*s.depth*t*(l+.01),u=O([],s.pos,a,c/2),h=O([],s.pos,a,-c/2),d=[u[0],u[1],u[2]+s.height],p=[h[0],h[1],h[2]+s.height],f=O([],s.normal,a,l);R(f,f,e);const m=O([],s.normal,a,-l);R(m,m,e),M(f,u,f),M(m,h,m),u[2]+=.1,h[2]+=.1,n.emplaceBack(f[0],f[1],f[2]),n.emplaceBack(m[0],m[1],m[2]),n.emplaceBack(u[0],u[1],u[2]),n.emplaceBack(h[0],h[1],h[2]),n.emplaceBack(d[0],d[1],d[2]),n.emplaceBack(p[0],p[1],p[2]),n.emplaceBack(u[0],u[1],u[2]),n.emplaceBack(h[0],h[1],h[2]),n.emplaceBack(f[0],f[1],f[2]),n.emplaceBack(m[0],m[1],m[2]);const g=c/e/2;r.emplaceBack(-g-l,-1,g,.8),r.emplaceBack(g+l,-1,g,.8),r.emplaceBack(-g,0,g,1.3),r.emplaceBack(g,0,g,1.3),r.emplaceBack(g+l,-.8,g,.7),r.emplaceBack(g+l,-.8,g,.7),r.emplaceBack(0,0,g,1.3),r.emplaceBack(0,0,g,1.3),r.emplaceBack(g+l,-1.2,g,.8),r.emplaceBack(g+l,-1.2,g,.8),i.emplaceBack(6+o,4+o,8+o),i.emplaceBack(7+o,9+o,5+o),i.emplaceBack(0+o,1+o,2+o),i.emplaceBack(1+o,3+o,2+o),o+=10}}function fm(e,t){const i={};i.indexArray=new Da,i.vertexArray=new ba,i.colorArray=new Ma,pm(e,t,i.indexArray,i.vertexArray,i.colorArray);const n={defined:!0};n.emissiveFactor=li.black;const r={};return r.baseColorFactor=li.white,n.pbrMetallicRoughness=r,i.material=n,i.aabb=new Kc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}const mm=ha([{name:"a_pos_3f",components:3,type:"Float32"}]),gm=ha([{name:"a_normal_3",components:3,type:"Int16"}]),_m=ha([{name:"a_centroid_3",components:3,type:"Int16"}]),ym=ha([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),vm=ha([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),xm=ha([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),bm=ha([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),Tm=ha([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),wm=ha([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),Em=Pc.types,Sm=32767;function Am(e,t){const i=zn+t;for(const n of e)for(const e of n)if(e.x<-t||e.x>i||e.y<-t||e.y>i)return!1;return!0}class Mm{constructor(){this.layoutVertexArray=new ba,this.layoutAttenuationArray=new Ma,this.layoutColorArray=new Ca,this.indexArray=new Da,this.indexArrayForConflation=new Da,this.segmentsBucket=new hl}}class Im{constructor(){this.layoutVertexArray=new ba,this.layoutNormalArray=new fa,this.layoutCentroidArray=new fa,this.layoutColorArray=new Ca,this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.layoutFloodLightDataArray=new Ha,this.layoutAOArray=new ga,this.indexArray=new Da,this.indexArrayForConflation=new Da,this.segmentsBucket=new hl,this.entranceBloom=new Mm}}class Cm{constructor(e){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.buildingWithoutFacade=new Im,this.buildingWithFacade=new Im,this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.lut=e.lut,this.buildingWithFacade.layoutFacadePaintArray=new Ca,this.buildingWithFacade.layoutFacadeDataArray=new wa,this.buildingWithFacade.layoutFacadeVerticalRangeArray=new Ca,this.programConfigurations=new zl(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.projection=e.projection,this.groundEffect=new gp(e),this.groundEffect.groundRadiusArray=new ga,this.hasAppearances=null}updateFootprints(e,t){for(const i of this.footprints)t.push({footprint:i,id:e})}updateAppearances(e,t,i,n){}prepare(){return function(){if(null!=lf||null!=af)return null;if(null!=sf)return sf;const e=fetch(st.BUILDING_GEN_URL);return sf=function(e){let t,i,n,r;function o(){t=new Uint8Array(r.buffer),i=new Int32Array(r.buffer),n=new Float32Array(r.buffer)}function s(){throw new Error("Unexpected BuildingGen error.")}const a=()=>{},l={a:{a:s,f:function(e){const i=t.length,n=Math.max(e>>>0,Math.ceil(1.2*i)),s=Math.ceil((n-i)/65536);try{return r.grow(s),o(),!0}catch(e){return!1}},g:s,b:a,c:a,d:a,e:a}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(e,l):e.then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,l)))).then((e=>{const s=e.instance.exports;return(0,s.g)(),r=s.f,o(),new Kp({setStyle:s.h,setAOOptions:s.i,setMetricOptions:s.j,setStructuralOptions:s.k,setFacadeOptions:s.l,setFauxFacadeOptions:s.m,setFacadeClassifierOptions:s.n,addFeature:s.o,addFacade:s.p,generateMesh:s.q,getLastError:s.r,getOuterRingLength:s.s,getMeshCount:s.t,getPositionsPtr:s.u,getPositionsLength:s.v,getNormalsPtr:s.w,getNormalsLength:s.x,getColorsPtr:s.y,getColorsLength:s.z,getAOPtr:s.A,getAOLength:s.B,getUVPtr:s.C,getUVLength:s.D,getFauxFacadePtr:s.E,getFauxFacadeLength:s.F,getIndicesPtr:s.G,getIndicesLength:s.H,getBuildingPart:s.I,getRingCount:s.J,getRingPtr:s.K,getRingLength:s.L,free:s.M,malloc:s.N,heapU8:t,heap32:i,heapF32:n})}))}(e).then((e=>(sf=null,lf=e,lf))).catch((e=>{qe("Could not load building-gen"),sf=null,af=e})),sf}()}populate(e,t,i,n){const r=hf();if(!r)return;const o=vc(i);this.tileToMeter=o,this.brightness=t.brightness,r.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,o],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:o,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),r.setAOOptions(!1,.3),r.setMetricOptions(!1,16),r.setStructuralOptions(!0),r.setFacadeClassifierOptions(3);const s=new Map,a=new Map;for(const{feature:t}of e){if("LineString"!==Em[t.type]){s.set(t.id,t.properties.source_id);continue}const e=this.layers[0]._featureFilter.needGeometry,r=Cc(t,e);if(!this.layers[0]._featureFilter.filter(new Ss(this.zoom),r,i))continue;const o=e?r.geometry:Ic(t,i,n),l=[];for(const e of o)for(const t of e)l.push({x:t.x,y:t.y});const c={coordinates:l,crossPerc:t.properties.cross_perc,distanceToRoad:t.properties.distance_to_road,entrances:t.properties.entrances,sourceId:0},u=t.properties.source_id;let h=a.get(u);h||(h=[],a.set(u,h)),h.push(c)}this.maxHeight=0;for(const{feature:l,id:c,index:u,sourceLayerIndex:h}of e){if("LineString"===Em[l.type])continue;const e=this.layers[0]._featureFilter.needGeometry,d=Cc(l,e);if(!this.layers[0]._featureFilter.filter(new Ss(this.zoom),d,i))continue;const p=e?d.geometry:Ic(l,i,n),f=id(p,500);if(!Am(p,163))continue;const m=this.layers[0],g=m.layout.get("building-roof-shape").evaluate(l,{},i);if("flat"===g)continue;const _=m.layout.get("building-base").evaluate(l,{},i),y=m.layout.get("building-height").evaluate(l,{},i),v=m.layout.get("building-flood-light-ground-radius").evaluate(l,{},i),x=m.paint.get("building-ambient-occlusion-intensity"),b=v/this.tileToMeter;let T=m.layout.get("building-flood-light-wall-radius").evaluate(l,{},i);T=De(T,0,2048);const w=T/2048*Sm,E=s.get(c);let S;S=a.has(E)?a.get(E):[];const A=0!==S.length&&m.layout.get("building-facade").evaluate(l,{},i);r.setFacadeOptions(4,!0),r.setFauxFacadeOptions(A,!1,1);let M=0,I=0,C=0,P=0,L=0,R=0;if(A){let e=Math.round(m.layout.get("building-facade-floors").evaluate(l,{},i));if(0===_){e=Math.max(1,e-(S.length>0?1:0));let t=4;if(y>100){const e=[10,13,15];t=e[l.id?l.id%e.length:0],r.setFacadeOptions(t,!0)}L=1.6803*t/o}else L=_/o;R=y/o,L=Math.min(L,R),C=m.layout.get("building-facade-unit-width").evaluate(l,{},i)/o,P=(R-L)/e,r.setFauxFacadeOptions(!0,!0,C);const t=m.layout.get("building-facade-window").evaluate(l,{},i);M=t[0],I=t[1]}const O=[],D=new Ee(1/0,1/0),B=new Ee(-1/0,-1/0),F=new Ee(0,0);let N=0;for(const e of f)if(e.length>0){const t=[];for(const i of e){const e=[];for(let t=i.length-1;t>=0;t--){const n=i[t];e.push({x:n.x,y:n.y}),D.x=Math.min(D.x,n.x),D.y=Math.min(D.y,n.y),B.x=Math.max(B.x,n.x),B.y=Math.max(B.y,n.y),F.x+=n.x,F.y+=n.y,N++}t.push(e)}O.push({id:l.id?l.id:0,height:y,minHeight:_,sourceId:0,roofType:g,coordinates:t})}F.x/=N||1,F.y/=N||1;const k=r.generateMesh(O,S);if("string"==typeof k){qe(`Unable to generate building ${l.id}: ${k}`);continue}if(0===k.meshes.length||0===k.modifiedPolygonRings.length)continue;let U=0;for(const e of k.meshes)U+=e.positions.length/3;const z=A?this.buildingWithFacade:this.buildingWithoutFacade,V=z.segmentsBucket.prepareSegment(U,z.layoutVertexArray,z.indexArray),G=[];let j=null,H=0,$=-1;const W=z.layoutVertexArray.length,q=z.indexArray.length;let X=0;for(const e of k.meshes){const t=z.layoutVertexArray.length;if("entrance"===e.buildingPart){const t=new Array;for(let i=0;i<e.positions.length;i+=12){const n=e.positions[i+0],r=e.positions[i+1],o=e.positions[i+3],s=e.positions[i+4],a=e.positions[i+2],l=e.positions[i+8]-a,c=1,u=o-n,h=s-r,d=Math.hypot(u,h);t.push({pos:[n+.5*u,r+.5*h,a],normal:[h/d,-u/d,0],width:d,height:l,depth:c,points:[n,r,o,s]})}const i=z.entranceBloom.segmentsBucket.prepareSegment(10*t.length,z.entranceBloom.layoutVertexArray,z.entranceBloom.indexArray),n=z.entranceBloom.layoutVertexArray.length;H=z.entranceBloom.indexArray.length,pm(t,.5/this.tileToMeter,z.entranceBloom.indexArray,z.entranceBloom.layoutVertexArray,z.entranceBloom.layoutAttenuationArray);const r=z.entranceBloom.layoutVertexArray.length-n;$=z.entranceBloom.indexArray.length-H;for(let e=0;e<r;e++){const e=65535;z.entranceBloom.layoutColorArray.emplaceBack(e,e)}i.vertexLength+=r,i.primitiveLength+=$,j={part:e.buildingPart,vertexOffset:n,vertexLength:r}}for(let t=0;t<e.positions.length;t+=3)X=Math.max(X,e.positions[t+2]),z.layoutVertexArray.emplaceBack(e.positions[t],e.positions[t+1],e.positions[t+2]);const i=Math.floor(F.x),n=Math.floor(F.y),r=Math.floor(X);for(let t=0;t<e.positions.length;t+=3)z.layoutCentroidArray.emplaceBack(i,n,r),z.layoutFloodLightDataArray.emplaceBack("wall"===e.buildingPart?w:0);for(let t=0;t<e.normals.length;t+=3)z.layoutNormalArray.emplaceBack(e.normals[t+0]*Sm,e.normals[t+1]*Sm,e.normals[t+2]*Sm);for(let t=0;t<e.ao.length;t++)z.layoutAOArray.emplaceBack(e.ao[t]);for(let t=0;t<e.colors.length;t+=3){const i=1+(e.ao[t/3]-1)*x;z.layoutColorArray.emplaceBack(e.colors[t]*i<<8|e.colors[t+1]*i,e.colors[t+2]*i<<8)}if(A){for(let t=0;t<e.positions.length;t+=3)z.layoutFacadePaintArray.emplaceBack(65535,255);for(let t=0;t<e.isFauxFacade.length;t++)if(e.isFauxFacade[t]){const i=1|Math.min(65535,Math.floor(e.uv[2*t]*k.outerRingLength)),n=Math.floor(255*M)<<8|Math.floor(255*I),r=Math.floor(65535*Math.min(1,C/zn)),o=Math.floor(65535*Math.min(1,P/zn));z.layoutFacadeDataArray.emplaceBack(i,n,r,o);const s=Math.floor(65535*Math.min(1,L/zn)),a=Math.floor(65535*Math.min(1,R/zn));z.layoutFacadeVerticalRangeArray.emplaceBack(s,a)}else z.layoutFacadeDataArray.emplaceBack(0,0,0,0),z.layoutFacadeVerticalRangeArray.emplaceBack(0,0)}const o=V.vertexLength;for(let t=0;t<e.indices.length;t+=3)z.indexArray.emplaceBack(o+e.indices[t],o+e.indices[t+1],o+e.indices[t+2]);V.vertexLength+=e.positions.length/3,V.primitiveLength+=e.indices.length/3,("roof"===e.buildingPart||"wall"===e.buildingPart||"facade_glazing"===e.buildingPart||"entrance"===e.buildingPart)&&G.push({part:e.buildingPart,vertexOffset:t,vertexLength:e.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,X),this.buildingFeatures.push({promoteId:c,feature:d,hasFauxFacade:A,segment:V,parts:G,buildingBloom:j});const Y=z.indexArray.length-q,Z=[],J=[],K=new Ee(1/0,1/0),Q=new Ee(-1/0,-1/0),ee=this.groundEffect.vertexArray.length;for(const e of k.modifiedPolygonRings){const t=[],i=new Ee(1/0,1/0),n=new Ee(-1/0,-1/0);for(let r=0;r<e.length;r+=2){const o=e.length-r-2;i.x=Math.min(i.x,e[o]),i.y=Math.min(i.y,e[o+1]),n.x=Math.max(n.x,e[o]),n.y=Math.max(n.y,e[o+1]);const s=new Ee(e[o],e[o+1]);t.push(s),Z.push(s.x,s.y),J.push(s.clone())}K.x=Math.min(K.x,i.x),K.y=Math.min(K.y,i.y),Q.x=Math.max(Q.x,n.x),Q.y=Math.max(Q.y,n.y),this.groundEffect.addData(t,[i,n],b)}const te=this.groundEffect.vertexArray.length-ee;for(let e=0;e<te;e++)this.groundEffect.groundRadiusArray.emplaceBack(v);(D.x<0||B.x>zn||D.y<0||B.y>zn)&&this.featuresOnBorder.push({featureId:l.id,footprintIndex:this.footprints.length});{const e=Ph(Z,null,2),t=new Sd(J,e,8,256);let i=l.id;l.properties&&l.properties.hasOwnProperty("building_id")&&(i=l.properties.building_id);const n={vertices:J,indices:e,grid:t,min:K,max:Q,buildingId:i,hiddenFlags:0,indicesOffset:q,indicesLength:Y,bloomIndicesOffset:H,bloomIndicesLength:$,groundEffectVertexOffset:ee,groundEffectVertexLength:te,hasFauxFacade:A,segment:V,height:X};void 0!==l.id&&this.featureFootprintLookup.set(l.id,this.footprints.length),this.footprints.push(n)}this.programConfigurations.populatePaintArrays(z.layoutVertexArray.length,l,u,{},t.availableImages,i,t.brightness),this.groundEffect.addPaintPropertiesData(l,u,{},t.availableImages,i,t.brightness),t.featureIndex.insert(l,p,u,h,this.index,W)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0],{})}update(e,t,i,n,r,o,s){this.programConfigurations.updatePaintArrays(e,t,r,i,n,o,s),this.groundEffect.update(e,t,r,i,n,o,s),this.evaluate(this.layers[0],e),this.colorBufferUploaded=!1}isEmpty(){return 0===this.buildingWithoutFacade.layoutVertexArray.length&&0===this.buildingWithFacade.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){const t=t=>{t.layoutVertexBuffer=e.createVertexBuffer(t.layoutVertexArray,mm.members),t.layoutNormalBuffer=e.createVertexBuffer(t.layoutNormalArray,gm.members),t.layoutCentroidBuffer=e.createVertexBuffer(t.layoutCentroidArray,_m.members),t.layoutFloodLightDataBuffer=e.createVertexBuffer(t.layoutFloodLightDataArray,wm.members),t.layoutFacadeDataArray&&t.layoutFacadeDataArray.length&&(t.layoutFacadeDataBuffer=e.createVertexBuffer(t.layoutFacadeDataArray,xm.members)),t.layoutFacadeVerticalRangeArray&&t.layoutFacadeVerticalRangeArray.length&&(t.layoutFacadeVerticalRangeBuffer=e.createVertexBuffer(t.layoutFacadeVerticalRangeArray,bm.members)),t.entranceBloom.layoutVertexArray.length&&(t.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(t.entranceBloom.layoutVertexArray,mm.members),t.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(t.entranceBloom.layoutAttenuationArray,Tm.members)),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e)};this.uploaded||(t(this.buildingWithoutFacade),t(this.buildingWithFacade),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){const e=e=>{e.layoutVertexBuffer&&(e.layoutVertexBuffer.destroy(),e.layoutNormalBuffer.destroy(),e.layoutColorBuffer.destroy(),e.segmentsBucket.destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.entranceBloom.layoutVertexBuffer&&(e.entranceBloom.layoutVertexBuffer.destroy(),e.entranceBloom.layoutColorBuffer.destroy(),e.entranceBloom.layoutAttenuationBuffer.destroy(),e.entranceBloom.indexBuffer.destroy(),e.entranceBloom.segmentsBucket.destroy()))};e(this.buildingWithoutFacade),e(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(e,t,i=!0){let n=!1;const r=i?t:0,o=0|(i?-1:~t);0===this.groundEffect.hiddenByLandmarkVertexArray.length&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const t of e){const e=this.footprints[t],i=e.hiddenFlags&o|r;e.hiddenFlags!==i&&(e.hiddenFlags=i,n=!0,this.groundEffect.updateHiddenByLandmarkRange(e.groundEffectVertexOffset,e.groundEffectVertexLength,0!==e.hiddenFlags))}return n&&(this.indexArrayForConflationUploaded=!1),n}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),this.indexArrayForConflationUploaded)return;const t=e=>{0!==e.indexArray.length&&(e.indexArrayForConflation.resize(e.indexArray.length),e.indexArrayForConflation.uint16.set(e.indexArray.uint16),e.entranceBloom.indexArrayForConflation.resize(e.entranceBloom.indexArray.length),e.entranceBloom.indexArrayForConflation.uint16.set(e.entranceBloom.indexArray.uint16))};t(this.buildingWithoutFacade),t(this.buildingWithFacade);for(const e of this.footprints){const t=e.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,i=e.indicesOffset+e.indicesLength;if(0!==e.hiddenFlags){for(let n=e.indicesOffset;n<i;n++)t.indexArrayForConflation.uint16[3*n+0]=0,t.indexArrayForConflation.uint16[3*n+1]=0,t.indexArrayForConflation.uint16[3*n+2]=0;const n=e.bloomIndicesOffset+e.bloomIndicesLength;for(let i=e.bloomIndicesOffset;i<n;i++)t.entranceBloom.indexArrayForConflation.uint16[3*i+0]=0,t.entranceBloom.indexArrayForConflation.uint16[3*i+1]=0,t.entranceBloom.indexArrayForConflation.uint16[3*i+2]=0}}const i=t=>{0!==t.indexArray.length&&(t.indexBuffer?t.indexBuffer.updateData(t.indexArrayForConflation):t.indexBuffer=e.createIndexBuffer(t.indexArrayForConflation,!0),t.entranceBloom.indexBuffer?t.entranceBloom.indexBuffer.updateData(t.entranceBloom.indexArrayForConflation):t.entranceBloom.indexBuffer=e.createIndexBuffer(t.entranceBloom.indexArrayForConflation,!0))};i(this.buildingWithoutFacade),i(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(e){const t=t=>{t.layoutColorBuffer?t.layoutColorBuffer.updateData(t.layoutColorArray):t.layoutColorBuffer=e.createVertexBuffer(t.layoutColorArray,ym.members,!0),t.layoutFacadePaintArray&&(t.layoutFacadePaintBuffer?t.layoutFacadePaintBuffer.updateData(t.layoutFacadePaintArray):t.layoutFacadePaintBuffer=e.createVertexBuffer(t.layoutFacadePaintArray,vm.members,!0)),t.entranceBloom.layoutColorBuffer?t.entranceBloom.layoutColorBuffer.updateData(t.entranceBloom.layoutColorArray):t.entranceBloom.layoutColorBuffer=e.createVertexBuffer(t.entranceBloom.layoutColorArray,ym.members,!0)};t(this.buildingWithoutFacade),t(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(e,t){const i=e.paint.get("building-ambient-occlusion-intensity");for(const n of this.buildingFeatures){const r=t[n.promoteId],o=n.feature;o.properties["building-part"]="roof";const s=e.paint.get("building-color").evaluate(o,r,this.canonical).toPremultipliedRenderColor(this.lut),a=e.paint.get("building-emissive-strength").evaluate(o,r,this.canonical);o.properties["building-part"]="wall";const l=e.paint.get("building-color").evaluate(o,r,this.canonical).toPremultipliedRenderColor(this.lut),c=e.paint.get("building-emissive-strength").evaluate(o,r,this.canonical);o.properties["building-part"]="window";const u=e.paint.get("building-color").evaluate(o,r,this.canonical).toPremultipliedRenderColor(this.lut),h=e.paint.get("building-emissive-strength").evaluate(o,r,this.canonical);o.properties["building-part"]="door";const d=e.paint.get("building-color").evaluate(o,r,this.canonical).toPremultipliedRenderColor(this.lut),p=e.paint.get("building-emissive-strength").evaluate(o,r,this.canonical),f=n.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(const e of n.parts){let t,r=s;"roof"===e.part?(r=s,t=a):"wall"===e.part?(r=l,t=c):"facade_glazing"===e.part?(r=u,t=h):"entrance"===e.part&&(r=d,t=p),t=De(t,0,1);for(let o=0;o<e.vertexLength;o++){const s=e.vertexOffset+o,a=1+(f.layoutAOArray.float32[s]-1)*i;f.layoutColorArray.emplace(s,r.r*a*255<<8|r.g*a*255,r.b*a*255<<8|255*t),n.hasFauxFacade&&f.layoutFacadePaintArray.emplace(s,255*u.r<<8|255*u.g,255*u.b<<8|255*h)}}const m=n.buildingBloom;if(m)for(let e=0;e<m.vertexLength;e++)f.entranceBloom.layoutColorArray.emplace(m.vertexOffset+e,255*d.r<<8|255*d.g,255*d.b<<8|51*p)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(e,t,i){if(t.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=t.updateTime;const n=t.getReplacementRegionsForTile(e.toUnwrapped());if(Gd(this.activeReplacements,n))return;this.activeReplacements=n;for(const e of this.footprints)e.hiddenFlags&=-2;const r=[];for(const t of this.activeReplacements){if(t.order<=Nd)continue;const i=Math.max(1,Math.pow(2,t.footprintTileId.canonical.z-e.canonical.z));for(const n of this.footprints)n.min.x>t.max.x||n.max.x<t.min.x||n.min.y>t.max.y||n.max.y<t.min.y||(r.length=0,Pm(n.vertices,0,n.vertices.length,t.footprintTileId.canonical,e.canonical,r),$d(t.footprint,r,n.indices,0,n.indices.length,0,-i)&&(n.hiddenFlags|=1))}0===this.groundEffect.hiddenByLandmarkVertexArray.length&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(e.groundEffectVertexOffset,e.groundEffectVertexLength,0!==e.hiddenFlags);this.indexArrayForConflationUploaded=!1}getFootprint(e){if(void 0!==e.id){const t=this.featureFootprintLookup.get(e.id);return this.footprints[t]}return null}getHeightAtTileCoord(e,t){let i=Number.NEGATIVE_INFINITY,n=!0;const r=4*(e+zn)*zn+(t+zn);if(this.footprintLookup.hasOwnProperty(r)){const e=this.footprintLookup[r];return e?{height:e.height,hidden:0!==e.hiddenFlags}:void 0}const o=new Ee(e,t);for(const s of this.footprints)e>s.max.x||s.min.x>e||t>s.max.y||s.min.y>t||s.height<=i||Xd(o,s)&&(i=s.height,this.footprintLookup[r]=s,n=0!==s.hiddenFlags);if(i!==Number.NEGATIVE_INFINITY)return{height:i,hidden:n};this.footprintLookup[r]=void 0}}function Pm(e,t,i,n,r,o){const s=Math.pow(2,n.z-r.z);for(let a=0;a<i;a++){let i=e[a+t].x,l=e[a+t].y;i=(i+r.x*zn)*s-n.x*zn,l=(l+r.y*zn)*s-n.y*zn,o.push(new Ee(i,l))}}let Lm,Rm;es(Cm,"BuildingBucket",{omit:["layers"]}),es(Im,"BuildingGeometry"),es(Mm,"BuildingBloomGeometry");const Om=ha([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),Dm=ha([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:Bm}=Om,Fm=ha([{name:"a_packed",components:3,type:"Float32"}]),{members:Nm}=Fm,km=ha([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Um}=km;class zm{constructor(e,t){this.width=e,this.height=t,this.nextRow=0,this.image=new Th({width:e,height:t}),this.positions={},this.uploaded=!1}getDash(e,t){const i=this.getKey(e,t);return this.positions[i]}trim(){const e=this.width,t=this.height=ze(this.nextRow);this.image.resize({width:e,height:t})}getKey(e,t){return e.join(",")+t}getDashRanges(e,t,i){const n=[];let r=e.length%2==1?-e[e.length-1]*i:0,o=e[0]*i,s=!0;n.push({left:r,right:o,isDash:s,zeroLength:0===e[0]});let a=e[0];for(let t=1;t<e.length;t++){s=!s;const l=e[t];r=a*i,a+=l,o=a*i,n.push({left:r,right:o,isDash:s,zeroLength:0===l})}return n}addRoundDash(e,t,i){const n=t/2;for(let t=-i;t<=i;t++){const r=this.width*(this.nextRow+i+t);let o=0,s=e[o];for(let a=0;a<this.width;a++){a/s.right>1&&(s=e[++o]);const l=Math.abs(a-s.left),c=Math.abs(a-s.right),u=Math.min(l,c);let h;const d=t/i*(n+1);if(s.isDash){const e=n-Math.abs(d);h=Math.sqrt(u*u+e*e)}else h=n-Math.sqrt(u*u+d*d);this.image.data[r+a]=Math.max(0,Math.min(255,h+128))}}}addRegularDash(e,t){for(let t=e.length-1;t>=0;--t){const i=e[t],n=e[t+1];i.zeroLength?e.splice(t,1):n&&n.isDash===i.isDash&&(n.left=i.left,e.splice(t,1))}const i=e[0],n=e[e.length-1];i.isDash===n.isDash&&(i.left=n.left-this.width,n.right=i.right+this.width);const r=this.width*this.nextRow;let o=0,s=e[o];for(let i=0;i<this.width;i++){i/s.right>1&&(s=e[++o]);const n=Math.abs(i-s.left),a=Math.abs(i-s.right),l=Math.min(n,a);this.image.data[r+i]=Math.max(0,Math.min(255,(s.isDash?l:-l)+t+128))}}addDash(e,t){const i=this.getKey(e,t);if(this.positions[i])return this.positions[i];const n="round"===t,r=n?7:0,o=2*r+1;if(this.nextRow+o>this.height)return qe("LineAtlas out of space"),null;0===e.length&&e.push(1);let s=0;for(let t=0;t<e.length;t++)e[t]<0&&(qe("Negative value is found in line dasharray, replacing values with 0"),e[t]=0),s+=e[t];if(0!==s){const i=this.width/s,o=this.getDashRanges(e,this.width,i);n?this.addRoundDash(o,i,r):this.addRegularDash(o,"square"===t?.5*i:0)}const a=this.nextRow+r;this.nextRow+=o;const l={tl:[a,r],br:[s,0]};return this.positions[i]=l,l}}es(zm,"LineAtlas");const Vm=Pc.types,Gm=Math.cos(Math.PI/180*37.5),jm=Math.cos(Math.PI/180*5);class Hm{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((e=>{this.gradients[e.id]={}})),this.layoutVertexArray=new xa,this.layoutVertexArray2=new ba,this.patternVertexArray=new ba,this.indexArray=new Da,this.programConfigurations=new zl(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new hl,this.maxLineLength=0,this.zOffsetVertexArray=new ba,this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.tessellationStep=e.tessellationStep?e.tessellationStep:zn/64,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,i,n){}populate(e,t,i,n){this.hasPattern=od("line",this.layers,this.pixelRatio,t);const r=this.layers[0].layout.get("line-sort-key");this.tileToMeter=vc(i);const o=this.layers[0].layout.get("line-elevation-reference");if("hd-road-markup"===o)this.elevationType="road";else{const e=this.layers[0].layout.get("line-z-offset"),t=e.isConstant()&&!e.constantOr(0);this.elevationType="sea"!==o&&"ground"!==o&&t?"none":"offset","offset"===this.elevationType&&"none"===o&&qe(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const s=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope="offset"===this.elevationType&&void 0!==s;const a=[];for(const{feature:o,id:s,index:l,sourceLayerIndex:c}of e){const e=this.layers[0]._featureFilter.needGeometry,u=Cc(o,e);if(!this.layers[0]._featureFilter.filter(new Ss(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),u,i))continue;const h=r?r.evaluate(u,{},i):void 0,d={id:s,properties:o.properties,type:o.type,sourceLayerIndex:c,index:l,geometry:e?u.geometry:Ic(o,i,n),patterns:{},sortKey:h};a.push(d)}r&&a.sort(((e,t)=>e.sortKey-t.sortKey));const{lineAtlas:l,featureIndex:c}=t,u=this.addConstantDashes(l);for(const n of a){const{geometry:r,index:o,sourceLayerIndex:s}=n;if(u&&this.addFeatureDashes(n,l),this.hasPattern){const e=sd("line",this.layers,n,this.zoom,this.pixelRatio,t);this.patternFeatures.push(e)}else this.addFeature(n,r,o,i,l.positions,t.availableImages,t.brightness,t.elevationFeatures);c.insert(e[o].feature,r,o,s,this.index)}}addConstantDashes(e){let t=!1;for(const i of this.layers){const n=i.paint.get("line-dasharray").value,r=i.layout.get("line-cap").value;if("constant"!==n.kind||"constant"!==r.kind)t=!0;else{const t=r.value,i=n.value;if(!i)continue;e.addDash(i,t)}}return t}addFeatureDashes(e,t){const i=this.zoom;for(const n of this.layers){const r=n.paint.get("line-dasharray").value,o=n.layout.get("line-cap").value;if("constant"===r.kind&&"constant"===o.kind)continue;let s,a;if("constant"===r.kind){if(s=r.value,!s)continue}else s=r.evaluate({zoom:i},e);a="constant"===o.kind?o.value:o.evaluate({zoom:i},e),t.addDash(s,a),e.patterns[n.id]=[t.getKey(s,a)]}}update(e,t,i,n,r,o,s,a){this.programConfigurations.updatePaintArrays(e,t,r,i,n,o,s,a)}addFeatures(e,t,i,n,r,o){for(const e of this.patternFeatures)this.addFeature(e,e.geometry,e.index,t,i,n,o)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Nm)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,Um)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,Dm.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Bm),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e,t){let i,n;if(t&&t>0?(i=`mapbox_clip_start_${t}`,n=`mapbox_clip_end_${t}`):(i="mapbox_clip_start",n="mapbox_clip_end"),e.properties&&e.properties.hasOwnProperty(i)&&e.properties.hasOwnProperty(n))return{start:+e.properties[i],end:+e.properties[n]}}addFeature(e,t,i,n,r,o,s,a){const l=this.layers[0].layout,c=l.get("line-join").evaluate(e,{}),u=l.get("line-cap").evaluate(e,{}),h=l.get("line-miter-limit"),d=l.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e;const p=!(!e.properties||!e.properties.hasOwnProperty("mapbox_line_metrics"))&&e.properties.mapbox_line_metrics;this.zOffsetValue=l.get("line-z-offset").value;const f=this.layers[0].paint.get("line-width").value;if("constant"!==f.kind&&!1===f.isLineProgressConstant&&(this.variableWidthValue=f),"road"===this.elevationType){const i=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,t,n,a,c,u,h,d)){const[r,o]=this.clipRuntimeLinesToTile(t,1);for(let t=0;t<r.length;t++){const i=r[t],s=o[t],a={progress:{min:s.progress.min,max:s.progress.max},nextDir:this.computeSegNextDir(s,i),prevDir:this.computeSegPrevDir(s,i)};this.addLine(i,e,n,c,u,h,d,a,p&&s.parentIndex>0?s.parentIndex:null)}this.fillNonElevatedRoadSegment(i)}}else for(let i=0;i<t.length;i++)this.addLine(t[i],e,n,c,u,h,d,void 0,p&&i>0?i:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,r,o,n,s,void 0,this.worldview)}computeSegNextDir(e,t){return e.nextPoint.sub(t.at(-2)).unit()}computeSegPrevDir(e,t){return t[1].sub(e.prevPoint).unit()}clipLinesToTile(e,t){return Dp(e,-t,-t,zn+t,zn+t)}clipRuntimeLinesToTile(e,t){const i=[];return[Dp(e,-t,-t,zn+t,zn+t,i),i]}addElevatedRoadFeature(e,t,i,n,r,o,s,a){const l=[],c=tu.getElevationFeature(e,n);if(c){const e=this.clipLinesToTile(t,1),n=this.prepareElevatedLines(e,c,i);for(const e of n)l.push({geometry:e,elevation:c,elevationTileID:i,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(0===l.length)return!1;for(const t of l){const n=this.layoutVertexArray.length;this.addLine(t.geometry,e,i,r,o,s,a);const l=new iu(i,t.elevationTileID);if(t.elevation)for(let e=n;e<this.layoutVertexArray.length;e++){const i=new Ee(this.layoutVertexArray.int16[6*e]>>1,this.layoutVertexArray.int16[6*e+1]>>1),n=l.pointElevation(i,t.elevation,.05);this.updateHeightRange(n),this.zOffsetVertexArray.emplaceBack(n,0,0)}else this.fillNonElevatedRoadSegment(n)}return!0}prepareElevatedLines(e,t,i){if(null!=t.constantHeight)return e;const n=[],r=1/vc(i);for(const i of e)Bp(i,new Qc(t,r),0,n);return n}fillNonElevatedRoadSegment(e){for(let t=e;t<this.layoutVertexArray.length;t++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,t,i,n,r,o,s,a,l){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=l?this.lineFeatureClips(t,l):this.lineClips;const c="none"===n;this.patternJoinNone=this.hasPattern&&c,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const u=a&&a.progress.min>0,h=a&&a.progress.max<1;if(this.lineClips){let i={min:this.lineClips.start,max:this.lineClips.end},n=1;if(a){const e=this.lineClips.end-this.lineClips.start;i=function(e,t,i){return{min:ot(e.min,t,i),max:ot(e.max,t,i)}}(a.progress,{min:0,max:1},i),e>0&&(n=(i.max-i.min)/e)}const r=+t.properties.mapbox_clip_feature_len,o=+t.properties.mapbox_clip_seg_len;if(Number.isNaN(r)||Number.isNaN(o)){for(let t=0;t<e.length-1;t++)this.totalDistance+=e[t].dist(e[t+1]);const t=this.totalDistance/(i.max-i.min);this.totalFeatureLength=Number.isFinite(t)?t:0,this.lineClips.start=i.min,this.lineClips.end=i.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=r,this.distance=o*n,this.lineClips.start=i.min,this.lineClips.end=i.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const d="Polygon"===Vm[t.type];let p=e.length;for(;p>=2&&e[p-1].equals(e[p-2]);)p--;let f=0;for(;f<p-1&&e[f].equals(e[f+1]);)f++;if(p<(d?3:2))return;"bevel"===n&&(o=1.05);const m=this.segments.prepareSegment(10*p,this.layoutVertexArray,this.indexArray);let g,_,y,v,x,b,T,w;a&&a.prevDir&&(b=a.prevDir.perp()),a&&a.nextDir&&(T=a.nextDir.perp()),this.e1=this.e2=-1,d&&(g=e[p-2],x=e[f].sub(g)._unit()._perp());for(let t=f;t<p;t++){if(y=t===p-1?d?e[f+1]:void 0:e[t+1],y&&e[t].equals(y))continue;x&&(v=x),g&&(_=g),g=e[t],w=this.evaluateLineProgressFeatures(_?_.dist(g):0),x=y?y.sub(g)._unit()._perp():v,v=v||x;const i=_&&y;let a=i?n:d||c?"butt":r;const l=v.x*x.x+v.y*x.y;if(c){const e=function(e){if(e.patternJoinNone){const t=e.segmentPoints.length/2,i=e.lineSoFar-e.segmentStart;for(let n=0;n<t;++n){const t=e.segmentPoints[2*n+1],r=Math.round(e.segmentPoints[2*n])+.5+.25*t;e.patternVertexArray.emplaceBack(r,i,e.segmentStart),e.patternVertexArray.emplaceBack(r,i,e.segmentStart)}e.segmentPoints.length=0}e.e1=e.e2=-1};if(i&&l<jm){this.updateDistance(_,g),this.addCurrentVertex(g,v,1,1,m,w),e(this),this.addCurrentVertex(g,x,-1,-1,m,w);continue}if(_){if(!y){this.updateDistance(_,g),this.addCurrentVertex(g,v,1,1,m,w),e(this);continue}a="miter"}}let E=v.add(x);0===E.x&&0===E.y||E._unit();const S=E.x*x.x+E.y*x.y,A=0!==S?1/S:1/0,M=2*Math.sqrt(2-2*S),I=S<Gm&&_&&y,C=v.x*x.y-v.y*x.x>0,P=this.overscaling<=16?15*zn/(512*this.overscaling):0;if(i&&"round"===a)if(A<s)a="miter";else if(A<=2){const e=$m(g,-10,zn+10);a="offset"===this.elevationType&&(e||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===a&&A>o&&(a="bevel"),"bevel"===a&&(A>2&&(a="flipbevel"),A<o&&(a="miter")),_&&!("miter"===a&&I)&&this.updateDistance(_,g),"miter"===a)if(I){const e=g.dist(_);if(e>2*P){const t=g.sub(g.sub(_)._mult(P/e)._round());this.updateDistance(_,t),this.addCurrentVertex(t,v,0,0,m,w),_=t}this.updateDistance(_,g),E._mult(A),this.addCurrentVertex(g,E,0,0,m,w);const t=g.dist(y);if(t>2*P){const e=g.add(y.sub(g)._mult(P/t)._round());this.updateDistance(g,e),this.addCurrentVertex(e,x,0,0,m,w),g=e}}else E._mult(A),this.addCurrentVertex(g,E,0,0,m,w);else if("flipbevel"===a){if(A>100)E=x.mult(-1);else{const e=A*v.add(x).mag()/v.sub(x).mag();E._perp()._mult(e*(C?-1:1))}this.addCurrentVertex(g,E,0,0,m,w),this.addCurrentVertex(g,E.mult(-1),0,0,m,w)}else if("bevel"===a||"fakeround"===a){null!=w&&_&&this.addCurrentVertex(g,T||v,-1,-1,m,w);const e=g.dist(_)<=2*P&&"bevel"!==a,t=E.mult(C?1:-1);t._mult(A);const i=x.mult(C?-1:1),n=v.mult(C?-1:1),r=this.evaluateLineProgressFeatures(this.distance);if(null==w&&(this.addHalfVertex(g,t.x,t.y,!1,!C,0,m,r),e||this.addHalfVertex(g,t.x+2*n.x,t.y+2*n.y,!1,C,0,m,r)),"fakeround"===a){const e=Math.round(180*M/Math.PI/20);this.addHalfVertex(g,n.x,n.y,!1,C,0,m,r);for(let t=0;t<e;t++){let o=t/e;if(.5!==o){const e=o-.5;o+=o*e*(o-1)*((1.0904+l*(l*(3.55645-1.43519*l)-3.2452))*e*e+(.848013+l*(.215638*l-1.06021)))}const s=i.sub(n)._mult(o)._add(n)._unit();this.addHalfVertex(g,s.x,s.y,!1,C,0,m,r)}this.addHalfVertex(g,i.x,i.y,!1,C,0,m,r)}e||null!=w||this.addHalfVertex(g,t.x+2*i.x,t.y+2*i.y,!1,C,0,m,r),null!=w&&y&&this.addCurrentVertex(g,b||x,1,1,m,w)}else if("butt"===a)this.addCurrentVertex(g,E,0,0,m,w);else if("square"===a){if(!_){const e=u?0:-1;this.addCurrentVertex(g,E,e,e,m,w)}if(this.addCurrentVertex(g,E,0,0,m,w),_){const e=h?0:1;this.addCurrentVertex(g,E,e,e,m,w)}}else if("round"===a){if(_){const e=!i&&T?T:v;this.addCurrentVertex(g,e,0,0,m,w),!i&&h||this.addCurrentVertex(g,e,1,1,m,w,!0)}if(y){const e=!i&&b?b:x;!i&&u||this.addCurrentVertex(g,e,-1,-1,m,w,!0),this.addCurrentVertex(g,e,0,0,m,w)}}}}addVerticesTo(e,t,i,n,r,o,s,a,l,c){const u=(t.w-e.w)/this.tessellationStep|0;let h=0;const d=this.scaledDistance;if(u>1){this.lineSoFar=e.w;const d=(t.x-e.x)/u,p=(t.y-e.y)/u,f=(t.z-e.z)/u,m=(t.w-e.w)/u;for(let t=1;t<u;++t){e.x+=d,e.y+=p,e.z+=f,this.lineSoFar+=m,h+=m;const t=this.evaluateLineProgressFeatures(this.prevDistance+h);this.scaledDistance=(this.prevDistance+h)/this.totalDistance,this.addHalfVertex(e,i,n,c,!1,s,l,t),this.addHalfVertex(e,r,o,c,!0,-a,l,t)}}this.lineSoFar=t.w,this.scaledDistance=d;const p=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(t,i,n,c,!1,s,l,p),this.addHalfVertex(t,r,o,c,!0,-a,l,p)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&"offset"!==this.elevationType)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):qe(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let t=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(t=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),"offset"!==this.elevationType?{zOffset:0,variableWidth:t}:"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:t}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:t}}addCurrentVertex(e,t,i,n,r,o,s=!1){const a=t.x+t.y*i,l=t.y-t.x*i,c=t.y*n-t.x,u=-t.y-t.x*n;if(null!=o){const t="offset"===this.elevationType,h=-10,d=zn+10,p=o.zOffset,f=new Lp(e.x,e.y,p,this.lineSoFar),m=!!t&&$m(e,h,d),g=this.lineSoFar,_=this.distance;if(this.currentVertex)if(m){const t=this.currentVertexIsOutside,o=this.currentVertex,m=new Lp(e.x,e.y,p,this.lineSoFar);if(Op(o,m,h,d),!$m(m,h,d)){if(t){this.e1=this.e2=-1,this.distance-=o.dist(f),this.lineSoFar=o.w;const e=this.evaluateLineProgressFeatures(o.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(o,a,l,s,!1,i,r,e),this.addHalfVertex(o,c,u,s,!0,-n,r,e),this.prevDistance=this.distance}this.distance=this.prevDistance+o.dist(m),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(o,m,a,l,c,u,i,n,r,s),this.distance=_,this.scaledDistance=this.distance/this.totalDistance}}else{const e=this.currentVertex;if(this.currentVertexIsOutside){Op(e,f,h,d),this.e1=this.e2=-1,this.distance-=e.dist(f),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e.w;const t=this.evaluateLineProgressFeatures(e.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(e,a,l,s,!1,i,r,t),this.addHalfVertex(e,c,u,s,!0,-n,r,t),this.prevDistance=this.distance,this.distance=_,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(e,f,a,l,c,u,i,n,r,s)}else m||(this.addHalfVertex(e,a,l,s,!1,i,r,o),this.addHalfVertex(e,c,u,s,!0,-n,r,o));this.currentVertex=f,this.currentVertexIsOutside=m,this.lineSoFar=g}else this.addHalfVertex(e,a,l,s,!1,i,r,o),this.addHalfVertex(e,c,u,s,!0,-n,r,o)}addHalfVertex({x:e,y:t},i,n,r,o,s,a,l){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),o||this.segmentPoints.push(this.lineSoFar-this.segmentStart,s)),this.layoutVertexArray.emplaceBack((e<<1)+(r?1:0),(t<<1)+(o?1:0),Math.round(63*i)+128,Math.round(63*n)+128,1+(0===s?0:s<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const e=di(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,e)}const c=a.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,c),a.primitiveLength++),o?this.e2=c:this.e1=c,null!=l&&this.zOffsetVertexArray.emplaceBack(l.zOffset,l.variableWidth,l.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,t){this.prevDistance=this.distance,this.distance+=e.dist(t),this.updateScaledDistance()}}function $m(e,t,i){return e.x<t||e.x>i||e.y<t||e.y>i}let Wm,qm;function Xm(e,t,i){return t*(zn/(e.tileSize*Math.pow(2,i-e.tileID.overscaledZ)))}es(Hm,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Ym=(e,t,i)=>(1-i)*e+i*t;function Zm(e,t){return 1/Xm(e,1,t.tileZoom)}function Jm(e,t,i,n){return e.translatePosMatrix(n||t.tileID.projMatrix,t,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const Km=e=>{const t=[];Qm(e)&&t.push("RENDER_LINE_DASH"),e.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");const i=e.paint.get("line-trim-offset");0===i[0]&&0===i[1]||t.push("RENDER_LINE_TRIM_OFFSET"),0!==e.paint.get("line-border-width").constantOr(1)&&t.push("RENDER_LINE_BORDER");const n="none"===e.layout.get("line-join").constantOr("miter"),r=!!e.paint.get("line-pattern").constantOr(1);return n&&r&&t.push("LINE_JOIN_NONE"),t};function Qm(e){const t=e.paint.get("line-dasharray").value;return"constant"!==t.kind||t.value}let eg;const tg=()=>eg||(eg={layout:Wm||(Wm=new Ns({"line-cap":new Bs(ks.layout_line["line-cap"]),"line-join":new Bs(ks.layout_line["line-join"]),"line-miter-limit":new Ds(ks.layout_line["line-miter-limit"]),"line-round-limit":new Ds(ks.layout_line["line-round-limit"]),"line-sort-key":new Bs(ks.layout_line["line-sort-key"]),"line-z-offset":new Bs(ks.layout_line["line-z-offset"]),"line-elevation-reference":new Ds(ks.layout_line["line-elevation-reference"]),"line-cross-slope":new Ds(ks.layout_line["line-cross-slope"]),visibility:new Ds(ks.layout_line.visibility),"line-width-unit":new Ds(ks.layout_line["line-width-unit"])})),paint:qm||(qm=new Ns({"line-opacity":new Bs(ks.paint_line["line-opacity"]),"line-color":new Bs(ks.paint_line["line-color"]),"line-translate":new Ds(ks.paint_line["line-translate"]),"line-translate-anchor":new Ds(ks.paint_line["line-translate-anchor"]),"line-width":new Bs(ks.paint_line["line-width"]),"line-gap-width":new Bs(ks.paint_line["line-gap-width"]),"line-offset":new Bs(ks.paint_line["line-offset"]),"line-blur":new Bs(ks.paint_line["line-blur"]),"line-dasharray":new Bs(ks.paint_line["line-dasharray"]),"line-pattern":new Bs(ks.paint_line["line-pattern"]),"line-pattern-cross-fade":new Ds(ks.paint_line["line-pattern-cross-fade"]),"line-gradient":new Fs(ks.paint_line["line-gradient"]),"line-trim-offset":new Ds(ks.paint_line["line-trim-offset"]),"line-trim-fade-range":new Ds(ks.paint_line["line-trim-fade-range"]),"line-trim-color":new Ds(ks.paint_line["line-trim-color"]),"line-emissive-strength":new Ds(ks.paint_line["line-emissive-strength"]),"line-border-width":new Bs(ks.paint_line["line-border-width"]),"line-border-color":new Bs(ks.paint_line["line-border-color"]),"line-occlusion-opacity":new Ds(ks.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},eg);class ig extends Bs{possiblyEvaluate(e,t){return t=new Ss(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,transition:t.transition,worldview:t.worldview}),super.possiblyEvaluate(e,t)}evaluate(e,t,i,n){return t=Object.assign({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(e,t,i,n)}}let ng;function rg(e,t){return t>0?t+2*e:e}const og=ha([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),sg=ha([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),ag=ha([{name:"a_projected_pos",components:4,type:"Float32"}],4);ha([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const lg=ha([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),cg=ha([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),ug=ha([{name:"a_texb",components:2,type:"Uint16"}]),hg=ha([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),dg=ha([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);ha([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const pg=ha([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),fg=ha([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ha([{name:"triangle",components:3,type:"Uint16"}]),ha([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ha([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),ha([{type:"Float32",name:"offsetX"}]),ha([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var mg=24;function gg(e,t,i){return e.sections.forEach((e=>{e.text=function(e,t,i){const n=t.layout.get("text-transform").evaluate(i,{});return"uppercase"===n?e=e.toLocaleUpperCase():"lowercase"===n&&(e=e.toLocaleLowerCase()),Es.applyArabicShaping&&(e=Es.applyArabicShaping(e)),e}(e.text,t,i)})),e}const _g={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function yg(e){return"︶"===e||"﹈"===e||"︸"===e||"﹄"===e||"﹂"===e||"︾"===e||"︼"===e||"︺"===e||"︘"===e||"﹀"===e||"︐"===e||"︓"===e||"︔"===e||"｀"===e||"￣"===e||"︑"===e||"︒"===e}function vg(e){return"︵"===e||"﹇"===e||"︷"===e||"﹃"===e||"﹁"===e||"︽"===e||"︻"===e||"︹"===e||"︗"===e||"︿"===e}const xg=4294967296,bg=1/xg,Tg="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");let wg=class{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,i=this.length){for(;this.pos<i;){const i=this.readVarint(),n=i>>3,r=this.pos;this.type=7&i,e(n,t,this),this.pos===r&&this.skip(i)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*xg;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*xg;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let i,n;return n=t[this.pos++],i=127&n,n<128?i:(n=t[this.pos++],i|=(127&n)<<7,n<128?i:(n=t[this.pos++],i|=(127&n)<<14,n<128?i:(n=t[this.pos++],i|=(127&n)<<21,n<128?i:(n=t[this.pos],i|=(15&n)<<28,function(e,t,i){const n=i.buf;let r,o;if(o=n[i.pos++],r=(112&o)>>4,o<128)return Eg(e,r,t);if(o=n[i.pos++],r|=(127&o)<<3,o<128)return Eg(e,r,t);if(o=n[i.pos++],r|=(127&o)<<10,o<128)return Eg(e,r,t);if(o=n[i.pos++],r|=(127&o)<<17,o<128)return Eg(e,r,t);if(o=n[i.pos++],r|=(127&o)<<24,o<128)return Eg(e,r,t);if(o=n[i.pos++],r|=(1&o)<<31,o<128)return Eg(e,r,t);throw new Error("Expected varint not more than 10 bytes")}(i,e,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2==1?(e+1)/-2:e/2}readBoolean(){return Boolean(this.readVarint())}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&Tg?Tg.decode(this.buf.subarray(t,e)):function(e,t,i){let n="",r=t;for(;r<i;){const t=e[r];let o,s,a,l=null,c=t>239?4:t>223?3:t>191?2:1;if(r+c>i)break;1===c?t<128&&(l=t):2===c?(o=e[r+1],128==(192&o)&&(l=(31&t)<<6|63&o,l<=127&&(l=null))):3===c?(o=e[r+1],s=e[r+2],128==(192&o)&&128==(192&s)&&(l=(15&t)<<12|(63&o)<<6|63&s,(l<=2047||l>=55296&&l<=57343)&&(l=null))):4===c&&(o=e[r+1],s=e[r+2],a=e[r+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(l=(15&t)<<18|(63&o)<<12|(63&s)<<6|63&a,(l<=65535||l>=1114112)&&(l=null))),null===l?(l=65533,c=1):l>65535&&(l-=65536,n+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),n+=String.fromCharCode(l),r+=c}return n}(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const i=this.readPackedEnd();for(;this.pos<i;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return 2===this.type?this.readVarint()+this.pos:this.pos+1}skip(e){const t=7&e;if(0===t)for(;this.buf[this.pos++]>127;);else if(2===t)this.pos=this.readVarint()+this.pos;else if(5===t)this.pos+=4;else{if(1!==t)throw new Error(`Unimplemented type: ${t}`);this.pos+=8}}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const e=new Uint8Array(t);e.set(this.buf),this.buf=e,this.dataView=new DataView(e.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*bg),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*bg),!0),this.pos+=8}writeVarint(e){(e=+e||0)>268435455||e<0?function(e,t){let i,n;if(e>=0?(i=e%4294967296|0,n=e/4294967296|0):(i=~(-e%4294967296),n=~(-e/4294967296),4294967295^i?i=i+1|0:(i=0,n=n+1|0)),e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,i){i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,i.buf[i.pos]=127&(e>>>=7)}(i,0,t),function(e,t){const i=(7&e)<<4;t.buf[t.pos++]|=i|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e)))))}(n,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))}writeSVarint(e){this.writeVarint(e<0?2*-e-1:2*e)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(4*e.length),this.pos++;const t=this.pos;this.pos=function(e,t,i){for(let n,r,o=0;o<t.length;o++){if(n=t.charCodeAt(o),n>55295&&n<57344){if(!r){n>56319||o+1===t.length?(e[i++]=239,e[i++]=191,e[i++]=189):r=n;continue}if(n<56320){e[i++]=239,e[i++]=191,e[i++]=189,r=n;continue}n=r-55296<<10|n-56320|65536,r=null}else r&&(e[i++]=239,e[i++]=191,e[i++]=189,r=null);n<128?e[i++]=n:(n<2048?e[i++]=n>>6|192:(n<65536?e[i++]=n>>12|224:(e[i++]=n>>18|240,e[i++]=n>>12&63|128),e[i++]=n>>6&63|128),e[i++]=63&n|128)}return i}(this.buf,e,this.pos);const i=this.pos-t;i>=128&&Sg(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let i=0;i<t;i++)this.buf[this.pos++]=e[i]}writeRawMessage(e,t){this.pos++;const i=this.pos;e(t,this);const n=this.pos-i;n>=128&&Sg(i,n,this),this.pos=i-1,this.writeVarint(n),this.pos+=n}writeMessage(e,t,i){this.writeTag(e,2),this.writeRawMessage(t,i)}writePackedVarint(e,t){t.length&&this.writeMessage(e,Ag,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,Mg,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,Pg,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,Ig,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,Cg,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,Lg,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,Rg,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,Og,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,Dg,t)}writeBytesField(e,t){this.writeTag(e,2),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,5),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,5),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,1),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,1),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,0),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,0),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,2),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,5),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,1),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}};function Eg(e,t,i){return i?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function Sg(e,t,i){const n=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));i.realloc(n);for(let t=i.pos-1;t>=e;t--)i.buf[t+n]=i.buf[t]}function Ag(e,t){for(let i=0;i<e.length;i++)t.writeVarint(e[i])}function Mg(e,t){for(let i=0;i<e.length;i++)t.writeSVarint(e[i])}function Ig(e,t){for(let i=0;i<e.length;i++)t.writeFloat(e[i])}function Cg(e,t){for(let i=0;i<e.length;i++)t.writeDouble(e[i])}function Pg(e,t){for(let i=0;i<e.length;i++)t.writeBoolean(e[i])}function Lg(e,t){for(let i=0;i<e.length;i++)t.writeFixed32(e[i])}function Rg(e,t){for(let i=0;i<e.length;i++)t.writeSFixed32(e[i])}function Og(e,t){for(let i=0;i<e.length;i++)t.writeFixed64(e[i])}function Dg(e,t){for(let i=0;i<e.length;i++)t.writeSFixed64(e[i])}const Bg=3;function Fg(e,t,i){t.glyphs=[],1===e&&i.readMessage(Ng,t)}function Ng(e,t,i){if(3===e){const{id:e,bitmap:n,width:r,height:o,left:s,top:a,advance:l}=i.readMessage(kg,{});t.glyphs.push({id:e,bitmap:new Th({width:r+2*Bg,height:o+2*Bg},n),metrics:{width:r,height:o,left:s,top:a,advance:l}})}else 4===e?t.ascender=i.readSVarint():5===e&&(t.descender=i.readSVarint())}function kg(e,t,i){1===e?t.id=i.readVarint():2===e?t.bitmap=i.readBytes():3===e?t.width=i.readVarint():4===e?t.height=i.readVarint():5===e?t.left=i.readSVarint():6===e?t.top=i.readSVarint():7===e&&(t.advance=i.readVarint())}const Ug=Bg,zg={horizontal:1,vertical:2,horizontalOnly:3};class Vg{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,t){const i=new Vg;return i.scale=e||1,i.fontStack=t,i}static forImage(e){const t=new Vg;return t.image=e,t}}class Gg{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,t,i){const n=new Gg;for(let r=0;r<e.sections.length;r++){const o=e.sections[r];o.image?n.addImageSection(o,i):n.addTextSection(o,t)}return n}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(e,t){let i="";for(let n=0;n<e.length;n++){const r=e.charCodeAt(n+1)||null,o=e.charCodeAt(n-1)||null;i+=!t&&(r&&us(r)&&!_g[e[n+1]]||o&&us(o)&&!_g[e[n-1]])||!_g[e[n]]?e[n]:_g[e[n]]}return i}(this.text,e)}trim(){let e=0;for(let t=0;t<this.text.length&&Hg[this.text.charCodeAt(t)];t++)e++;let t=this.text.length;for(let i=this.text.length-1;i>=0&&i>=e&&Hg[this.text.charCodeAt(i)];i--)t--;this.text=this.text.substring(e,t),this.sectionIndex=this.sectionIndex.slice(e,t)}substring(e,t){const i=new Gg;return i.text=this.text.substring(e,t),i.sectionIndex=this.sectionIndex.slice(e,t),i.sections=this.sections,i}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((e,t)=>Math.max(e,this.sections[t].scale)),0)}addTextSection(e,t){this.text+=e.text,this.sections.push(Vg.forText(e.scale,e.fontStack||t));const i=this.sections.length-1;for(let t=0;t<e.text.length;++t)this.sectionIndex.push(i)}addImageSection(e,t){const i=e.image?e.image.getPrimary():null;if(!i)return void qe("Can't add FormattedSection with an empty image.");i.scaleSelf(t);const n=this.getNextImageSectionCharCode();n?(this.text+=String.fromCodePoint(n),this.sections.push(Vg.forImage(i)),this.sectionIndex.push(this.sections.length-1)):qe("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function jg(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m=1){const g=Gg.fromFeature(e,r,m);h===zg.vertical&&g.verticalizePunctuation(d);let _=[];const y=function(e,t,i,n,r,o){if(!e)return[];const s=[],a=function(e,t,i,n,r,o){let s=0;for(let i=0;i<e.length();i++){const a=e.getSection(i);s+=Wg(e.getCodePoint(i),a,n,r,t,o)}return s/Math.max(1,Math.ceil(s/i))}(e,t,i,n,r,o),l=e.text.indexOf("​")>=0;let c=0;for(let i=0;i<e.length();i++){const h=e.getSection(i),d=e.getCodePoint(i);if(Hg[d]||(c+=Wg(d,h,n,r,t,o)),i<e.length()-1){const t=!((u=d)<11904||!(os["Bopomofo Extended"](u)||os.Bopomofo(u)||os["CJK Compatibility Forms"](u)||os["CJK Compatibility Ideographs"](u)||os["CJK Compatibility"](u)||os["CJK Radicals Supplement"](u)||os["CJK Strokes"](u)||os["CJK Symbols and Punctuation"](u)||os["CJK Unified Ideographs Extension A"](u)||os["CJK Unified Ideographs"](u)||os["Enclosed CJK Letters and Months"](u)||os["Halfwidth and Fullwidth Forms"](u)||os.Hiragana(u)||os["Ideographic Description Characters"](u)||os["Kangxi Radicals"](u)||os["Katakana Phonetic Extensions"](u)||os.Katakana(u)||os["Vertical Forms"](u)||os["Yi Radicals"](u)||os["Yi Syllables"](u)));($g[d]||t||h.image)&&s.push(Yg(i+1,c,a,s,Xg(d,e.getCodePoint(i+1),t&&l),!1))}}var u;return Zg(Yg(e.length(),c,a,s,0,!0))}(g,c,o,t,n,p),{processBidirectionalText:v,processStyledBidirectionalText:x}=Es;if(v&&1===g.sections.length){const e=v(g.toString(),y);for(const t of e){const e=new Gg;e.text=t,e.sections=g.sections;for(let i=0;i<t.length;i++)e.sectionIndex.push(0);_.push(e)}}else if(x){const e=x(g.text,g.sectionIndex,y);for(const t of e){const e=new Gg;e.text=t[0],e.sectionIndex=t[1],e.sections=g.sections,_.push(e)}}else _=function(e,t){const i=[],n=e.text;let r=0;for(const n of t)i.push(e.substring(r,n)),r=n;return r<n.length&&i.push(e.substring(r,n.length)),i}(g,y);const b=[],T={positionedLines:b,text:g.toString(),top:u[1],bottom:u[1],left:u[0],right:u[0],writingMode:h,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(e,t,i,n,r,o,s,a,l,c,u,h){let d=0,p=0,f=0;const m="right"===a?1:"left"===a?0:.5;let g=!1;for(const e of r){const i=e.getSections();for(const e of i){if(e.image)continue;const i=t[e.fontStack];if(i&&(g=void 0!==i.ascender&&void 0!==i.descender,!g))break}if(!g)break}let _=0;for(const s of r){s.trim();const r=s.getMaxScale(),a=(r-1)*mg,v={positionedGlyphs:[],lineOffset:0};e.positionedLines[_]=v;const x=v.positionedGlyphs;let b=0;if(!s.length()){p+=o,++_;continue}let T=0,w=0;for(let o=0;o<s.length();o++){const a=s.getSection(o),f=s.getSectionIndex(o),m=s.getCodePoint(o);let _=a.scale,v=null,E=null,S=null,A=mg,M=0,I=l;I===zg.vertical&&(12312===(y=m)||12313===y||12316===y||12540===y||12448===y)&&(I=zg.horizontal);const C=!(I===zg.horizontal||!u&&!cs(m)||u&&(Hg[m]||hs(m)));if(a.image){const t=n.get(a.image.toString());if(!t)continue;S=a.image,e.iconsInText=e.iconsInText||!0,E=t.paddedRect;const i=t.displaySize;_=_*mg/h,v={width:i[0],height:i[1],left:0,top:-Ug,advance:C?i[1]:i[0],localGlyph:!1},M=g?-v.height*_:r*mg-17-i[1]*_,A=v.advance;const o=(C?i[0]:i[1])*_-mg*r;o>0&&o>b&&(b=o)}else{const e=i[a.fontStack];if(!e)continue;e[m]&&(E=e[m]);const n=t[a.fontStack];if(!n)continue;const o=n.glyphs[m];if(!o)continue;if(v=o.metrics,A=8203!==m?mg:0,g){const e=void 0!==n.ascender?Math.abs(n.ascender):0,t=void 0!==n.descender?Math.abs(n.descender):0,i=(e+t)*_;T<i&&(T=i,w=(e-t)/2*_),M=-e*_}else M=(r-_)*mg-17}C?(e.verticalizable=!0,x.push({glyph:m,image:S,x:d,y:p+M,vertical:C,scale:_,localGlyph:v.localGlyph,fontStack:a.fontStack,sectionIndex:f,metrics:v,rect:E}),d+=A*_+c):(x.push({glyph:m,image:S,x:d,y:p+M,vertical:C,scale:_,localGlyph:v.localGlyph,fontStack:a.fontStack,sectionIndex:f,metrics:v,rect:E}),d+=v.advance*_+c)}0!==x.length&&(f=Math.max(d-c,f),g?Kg(x,m,b,w,o*r/2):Kg(x,m,b,0,o/2)),d=0;const E=o*r+b;v.lineOffset=Math.max(b,a),p+=E,++_}var y;const v=p,{horizontalAlign:x,verticalAlign:b}=Jg(s);(function(e,t,i,n,r,o){const s=(t-i)*r,a=-o*n;for(const t of e)for(const e of t.positionedGlyphs)e.x+=s,e.y+=a})(e.positionedLines,m,x,b,f,v),e.top+=-b*v,e.bottom=e.top+v,e.left+=-x*f,e.right=e.left+f,e.hasBaseline=g}(T,t,i,n,_,s,a,l,h,c,d,f),!function(e){for(const t of e)if(0!==t.positionedGlyphs.length)return!1;return!0}(b))return T}const Hg={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},$g={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Wg(e,t,i,n,r,o){if(t.image){const e=n.get(t.image.toString());return e?e.displaySize[0]*t.scale*mg/o+r:0}{const n=i[t.fontStack],o=n&&n.glyphs[e];return o?o.metrics.advance*t.scale+r:0}}function qg(e,t,i,n){const r=Math.pow(e-t,2);return n?e<t?r/2:2*r:r+Math.abs(i)*i}function Xg(e,t,i){let n=0;return 10===e&&(n-=1e4),i&&(n+=150),40!==e&&65288!==e||(n+=50),41!==t&&65289!==t||(n+=50),n}function Yg(e,t,i,n,r,o){let s=null,a=qg(t,i,r,o);for(const e of n){const n=qg(t-e.x,i,r,o)+e.badness;n<=a&&(s=e,a=n)}return{index:e,x:t,priorBreak:s,badness:a}}function Zg(e){return e?Zg(e.priorBreak).concat(e.index):[]}function Jg(e){let t=.5,i=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(e){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:t,verticalAlign:i}}function Kg(e,t,i,n,r){if(!(t||i||n||r))return;const o=e.length-1,s=e[o],a=(s.x+s.metrics.advance*s.scale)*t;for(let t=0;t<=o;t++)e[t].x-=a,e[t].y+=i+n+r}function Qg(e){return void 0!==e.imagePrimary&&void 0!==e.top&&void 0!==e.bottom&&void 0!==e.left&&void 0!==e.right}function e_(e,t,i,n){const{horizontalAlign:r,verticalAlign:o}=Jg(n),s=i[0]-e.displaySize[0]*r,a=i[1]-e.displaySize[1]*o;return{imagePrimary:e,imageSecondary:t,top:a,bottom:a+e.displaySize[1],left:s,right:s+e.displaySize[0]}}function t_(e,t,i,n,r,o){const s=e.imagePrimary;let a;if(s.content){const e=s.content,t=s.pixelRatio||1;a=[e[0]/t,e[1]/t,s.displaySize[0]-e[2]/t,s.displaySize[1]-e[3]/t]}const l=t.left*o,c=t.right*o;let u,h,d,p;"width"===i||"both"===i?(p=r[0]+l-n[3],h=r[0]+c+n[1]):(p=r[0]+(l+c-s.displaySize[0])/2,h=p+s.displaySize[0]);const f=t.top*o,m=t.bottom*o;return"height"===i||"both"===i?(u=r[1]+f-n[0],d=r[1]+m+n[2]):(u=r[1]+(f+m-s.displaySize[1])/2,d=u+s.displaySize[1]),{imagePrimary:s,imageSecondary:void 0,top:u,right:h,bottom:d,left:p,collisionPadding:a}}function i_(e){return!e.imagePrimary.stretchX}function n_(e){return!e.imagePrimary.stretchY}function r_(e){return{width:e.right-e.left,height:e.bottom-e.top}}const o_=128;function s_(e,t,i){const{expression:n}=t;if("constant"===n.kind)return{kind:"constant",layoutSize:n.evaluate(new Ss(e+1,{worldview:i}))};if("source"===n.kind)return{kind:"source"};{const{zoomStops:t,interpolationType:r}=n;let o=0;for(;o<t.length&&t[o]<=e;)o++;o=Math.max(0,o-1);let s=o;for(;s<t.length&&t[s]<e+1;)s++;s=Math.min(t.length-1,s);const a=t[o],l=t[s];return"composite"===n.kind?{kind:"composite",minZoom:a,maxZoom:l,interpolationType:r}:{kind:"camera",minZoom:a,maxZoom:l,minSize:n.evaluate(new Ss(a,{worldview:i})),maxSize:n.evaluate(new Ss(l,{worldview:i})),interpolationType:r}}}function a_(e,{uSize:t,uSizeT:i},{lowerSize:n,upperSize:r}){return"source"===e.kind?n/o_:"composite"===e.kind?di(n/o_,r/o_,i):t}function l_(e,t,i=1){let n=0,r=0;if("constant"===e.kind)r=e.layoutSize*i;else if("source"!==e.kind){const{interpolationType:o,minZoom:s,maxZoom:a}=e,l=o?De(qr.interpolationFactor(o,t,s,a),0,1):0;"camera"===e.kind?r=di(e.minSize,e.maxSize,l)*i:n=l*i}return{uSizeT:n,uSize:r}}class c_ extends Ee{constructor(e,t,i,n,r){super(e,t),this.angle=n,this.z=i,void 0!==r&&(this.segment=r)}clone(){return new c_(this.x,this.y,this.z,this.angle,this.segment)}}function u_(e,t,i,n,r){if(void 0===t.segment)return!0;let o=t,s=t.segment+1,a=0;for(;a>-i/2;){if(s--,s<0)return!1;a-=e[s].dist(o),o=e[s]}a+=e[s].dist(e[s+1]),s++;const l=[];let c=0;for(;a<i/2;){const t=e[s],i=e[s+1];if(!i)return!1;let o=e[s-1].angleTo(t)-t.angleTo(i);for(o=Math.abs((o+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:a,angleDelta:o}),c+=o;a-l[0].distance>n;)c-=l.shift().angleDelta;if(c>r)return!1;s++,a+=t.dist(i)}return!0}function h_(e){let t=0;for(let i=0;i<e.length-1;i++)t+=e[i].dist(e[i+1]);return t}function d_(e,t,i){return e?.6*t*i:0}function p_(e,t){return Math.max(e?e.right-e.left:0,t?t.right-t.left:0)}function f_(e,t,i,n,r,o){const s=d_(i,r,o),a=p_(i,n)*o;let l=0;const c=h_(e)/2;for(let i=0;i<e.length-1;i++){const n=e[i],r=e[i+1],o=n.dist(r);if(l+o>c){const u=(c-l)/o,h=di(n.x,r.x,u),d=di(n.y,r.y,u),p=new c_(h,d,0,r.angleTo(n),i);return!s||u_(e,p,a,s,t)?p:void 0}l+=o}}function m_(e,t,i,n,r,o,s,a,l){const c=d_(n,o,s),u=p_(n,r),h=u*s,d=0===e[0].x||e[0].x===l||0===e[0].y||e[0].y===l;return t-h<t/4&&(t=h+t/4),g_(e,d?t/2*a%t:(u/2+2*o)*s*a%t,t,c,i,h,d,!1,l)}function g_(e,t,i,n,r,o,s,a,l){const c=o/2,u=h_(e);let h=0,d=t-i,p=[];for(let t=0;t<e.length-1;t++){const s=e[t],a=e[t+1],f=s.dist(a),m=a.angleTo(s);for(;d+i<h+f;){d+=i;const g=(d-h)/f,_=di(s.x,a.x,g),y=di(s.y,a.y,g);if(_>=0&&_<l&&y>=0&&y<l&&d-c>=0&&d+c<=u){const i=new c_(_,y,0,m,t);n&&!u_(e,i,o,n,r)||p.push(i)}}h+=f}return a||p.length||s||(p=g_(e,h/2,i,n,r,o,s,!0,l)),p}function __(e){let t=0,i=0;for(const n of e)t+=n.w*n.h,i=Math.max(i,n.w);e.sort(((e,t)=>t.h-e.h));const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),i),h:1/0}];let r=0,o=0;for(const t of e)for(let e=n.length-1;e>=0;e--){const i=n[e];if(!(t.w>i.w||t.h>i.h)){if(t.x=i.x,t.y=i.y,o=Math.max(o,t.y+t.h),r=Math.max(r,t.x+t.w),t.w===i.w&&t.h===i.h){const t=n.pop();t&&e<n.length&&(n[e]=t)}else t.h===i.h?(i.x+=t.w,i.w-=t.w):t.w===i.w?(i.y+=t.h,i.h-=t.h):(n.push({x:i.x+t.w,y:i.y,w:i.w-t.w,h:t.h}),i.y+=t.h,i.h-=t.h);break}}return{w:r,h:o,fill:t/(r*o)||0}}es(c_,"Anchor");const y_=1;class v_{static getImagePositionScale(e,t,i){if(t&&e&&e.options&&e.options.transform){const t=e.options.transform;return{x:t.a,y:t.d}}return{x:i,y:i}}constructor(e,t,i,n){this.paddedRect=e;const{pixelRatio:r,version:o,stretchX:s,stretchY:a,content:l,sdf:c,usvg:u}=t;this.pixelRatio=r,this.stretchX=s,this.stretchY=a,this.content=l,this.version=o,this.padding=i,this.sdf=c,this.usvg=u,this.scale=v_.getImagePositionScale(n,u,r)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function x_(e,t,i){const n=Ni.parse(e),r=function(e,t,i=[1,1]){return{x:0,y:0,w:(e.data?e.data.width:e.width*i[0])+2*t,h:(e.data?e.data.height:e.height*i[1])+2*t}}(t,i,[n.options.transform.a,n.options.transform.d]);return{bin:r,imagePosition:new v_(r,t,i,n),imageVariant:n}}class b_{constructor(e,t,i){const n=new Map,r=new Map;this.haveRenderCallbacks=[];const o=[];this.addImages(e,n,y_,o),this.addImages(t,r,2,o);const{w:s,h:a}=__(o),l=new wh({width:s||1,height:a||1});for(const[t,i]of e.entries()){const e=n.get(t).paddedRect;wh.copy(i.data,l,{x:0,y:0},{x:e.x+y_,y:e.y+y_},i.data,null,i.sdf)}for(const[e,n]of t.entries()){const t=r.get(e),o=t.paddedRect;let s=t.padding;const a=o.x+s,c=o.y+s,u=n.data.width,h=n.data.height;s=s>1?s-1:s,wh.copy(n.data,l,{x:0,y:0},{x:a,y:c},n.data,i),wh.copy(n.data,l,{x:0,y:h-s},{x:a,y:c-s},{width:u,height:s},i),wh.copy(n.data,l,{x:0,y:0},{x:a,y:c+h},{width:u,height:s},i),wh.copy(n.data,l,{x:u-s,y:0},{x:a-s,y:c},{width:s,height:h},i),wh.copy(n.data,l,{x:0,y:0},{x:a+u,y:c},{width:s,height:h},i),wh.copy(n.data,l,{x:u-s,y:h-s},{x:a-s,y:c-s},{width:s,height:s},i),wh.copy(n.data,l,{x:0,y:h-s},{x:a+u,y:c-s},{width:s,height:s},i),wh.copy(n.data,l,{x:0,y:0},{x:a+u,y:c+h},{width:s,height:s},i),wh.copy(n.data,l,{x:u-s,y:0},{x:a-s,y:c+h},{width:s,height:s},i)}this.lut=i,this.image=l,this.iconPositions=n,this.patternPositions=r}addImages(e,t,i,n){for(const[r,o]of e.entries()){const{bin:e,imagePosition:s,imageVariant:a}=x_(r,o,i);t.set(r,s),n.push(e),o.hasRenderCallback&&this.haveRenderCallbacks.push(a.id)}}patchUpdatedImages(e,t,i){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((t=>e.hasImage(t,i))),e.dispatchRenderCallbacks(this.haveRenderCallbacks,i);for(const n of e.getUpdatedImages(i)){for(const r of this.iconPositions.keys()){const o=Ni.parse(r);if(ri.isEqual(o.id,n)){const o=e.getImage(n,i);this.patchUpdatedImage(this.iconPositions.get(r),o,t,null)}}for(const r of this.patternPositions.keys()){const o=Ni.parse(r);if(ri.isEqual(o.id,n)){const o=e.getImage(n,i);this.patchUpdatedImage(this.patternPositions.get(r),o,t,this.lut)}}}}patchUpdatedImage(e,t,i,n=null){if(!e||!t)return;if(e.version===t.version)return;e.version=t.version;const[r,o]=e.tl,s=e.sdf;if(this.lut||s){const e={width:t.data.width,height:t.data.height},a=new wh(e);wh.copy(t.data,a,{x:0,y:0},{x:0,y:0},e,n,s),i.update(a,{position:{x:r,y:o}})}else i.update(t.data,{position:{x:r,y:o}})}}es(v_,"ImagePosition"),es(b_,"ImageAtlas");const T_=1e20;function w_(e,t,i,n,r,o,s,a,l){for(let c=t;c<t+n;c++)E_(e,i*o+c,o,r,s,a,l);for(let c=i;c<i+r;c++)E_(e,c*o+t,1,n,s,a,l)}function E_(e,t,i,n,r,o,s){o[0]=0,s[0]=-T_,s[1]=T_,r[0]=e[t];for(let a=1,l=0,c=0;a<n;a++){r[a]=e[t+a*i];const n=a*a;do{const e=o[l];c=(r[a]-r[e]+n-e*e)/(a-e)/2}while(c<=s[l]&&--l>-1);l++,o[l]=a,s[l]=c,s[l+1]=T_}for(let a=0,l=0;a<n;a++){for(;s[l+1]<a;)l++;const n=o[l],c=a-n;e[t+a*i]=r[n]+c*c}}const S_=2,A_={none:0,ideographs:1,all:2};class M_{constructor(e,t,i){this.requestManager=e,this.localGlyphMode=t,this.localFontFamily=i,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,t){const i=[],n=this.url||st.GLYPHS_URL;for(const t in e)for(const n of e[t])i.push({stack:t,id:n});Ne(i,(({stack:e,id:t},i)=>{let r=this.entries[e];r||(r=this.entries[e]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let o=r.glyphs[t];if(void 0!==o)return void i(null,{stack:e,id:t,glyph:o});if(o=this._tinySDF(r,e,t),o)return r.glyphs[t]=o,void i(null,{stack:e,id:t,glyph:o});const s=Math.floor(t/256);if(256*s>65535)return qe("glyphs > 65535 not supported"),void i(null,{stack:e,id:t,glyph:o});if(r.ranges[s])return void i(null,{stack:e,id:t,glyph:o});let a=r.requests[s];a||(a=r.requests[s]=[],M_.loadGlyphRange(e,s,n,this.requestManager,((e,t)=>{if(t){r.ascender=t.ascender,r.descender=t.descender;for(const e in t.glyphs)this._doesCharSupportLocalGlyph(+e)||(r.glyphs[+e]=t.glyphs[+e]);r.ranges[s]=!0}for(const i of a)i(e,t);delete r.requests[s]}))),a.push(((n,r)=>{n?i(n):r&&i(null,{stack:e,id:t,glyph:r.glyphs[t]||null})}))}),((e,i)=>{if(e)t(e);else if(i){const e={};for(const{stack:t,id:n,glyph:r}of i)void 0===e[t]&&(e[t]={}),void 0===e[t].glyphs&&(e[t].glyphs={}),e[t].glyphs[n]=r&&{id:r.id,bitmap:r.bitmap.clone(),metrics:r.metrics},e[t].ascender=this.entries[t].ascender,e[t].descender=this.entries[t].descender;t(null,e)}}))}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==A_.none&&(this.localGlyphMode===A_.all?!!this.localFontFamily:!!this.localFontFamily&&(os["CJK Unified Ideographs"](e)||os["Hangul Syllables"](e)||os.Hiragana(e)||os.Katakana(e)||os["CJK Symbols and Punctuation"](e)||os["CJK Unified Ideographs Extension A"](e)||os["CJK Unified Ideographs Extension B"](e)||os.Osage(e)))}_tinySDF(e,t,i){const n=this.localFontFamily;if(!n||!this._doesCharSupportLocalGlyph(i))return;let r=e.tinySDF;if(!r){let i="400";/bold/i.test(t)?i="900":/medium/i.test(t)?i="500":/light/i.test(t)&&(i="200"),r=e.tinySDF=new M_.TinySDF({fontFamily:n,fontWeight:i,fontSize:24*S_,buffer:3*S_,radius:8*S_}),r.fontWeight=i}if(this.localGlyphs[r.fontWeight][i])return this.localGlyphs[r.fontWeight][i];const o=String.fromCodePoint(i),{data:s,width:a,height:l,glyphWidth:c,glyphHeight:u,glyphLeft:h,glyphTop:d,glyphAdvance:p}=r.draw(o);return this.localGlyphs[r.fontWeight][i]={id:i,bitmap:new Th({width:a,height:l},s),metrics:{width:c/S_,height:u/S_,left:h/S_,top:d/S_-27,advance:p/S_,localGlyph:!0}}}}M_.loadGlyphRange=function(e,t,i,n,r){const o=256*t,s=o+255,a=n.transformRequest(n.normalizeGlyphsURL(i).replace("{fontstack}",e).replace("{range}",`${o}-${s}`),Bt.Glyphs);Ut(a,((e,t)=>{if(e)r(e);else if(t){const e={},i=function(e){return new wg(e).readFields(Fg,{})}(t);for(const t of i.glyphs)e[t.id]=t;r(null,{glyphs:e,ascender:i.ascender,descender:i.descender})}}))},M_.TinySDF=class{constructor({fontSize:e=24,buffer:t=3,radius:i=8,cutoff:n=.25,fontFamily:r="sans-serif",fontWeight:o="normal",fontStyle:s="normal",lang:a=null}={}){this.buffer=t,this.cutoff=n,this.radius=i,this.lang=a;const l=this.size=e+4*t,c=this._createCanvas(l),u=this.ctx=c.getContext("2d",{willReadFrequently:!0});u.font=`${s} ${o} ${e}px ${r}`,u.textBaseline="alphabetic",u.textAlign="left",u.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:n,actualBoundingBoxLeft:r,actualBoundingBoxRight:o}=this.ctx.measureText(e),s=Math.ceil(i),a=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(o-r))),l=Math.min(this.size-this.buffer,s+Math.ceil(n)),c=a+2*this.buffer,u=l+2*this.buffer,h=Math.max(c*u,0),d=new Uint8ClampedArray(h),p={data:d,width:c,height:u,glyphWidth:a,glyphHeight:l,glyphTop:s,glyphLeft:0,glyphAdvance:t};if(0===a||0===l)return p;const{ctx:f,buffer:m,gridInner:g,gridOuter:_}=this;this.lang&&(f.lang=this.lang),f.clearRect(m,m,a,l),f.fillText(e,m,m+s);const y=f.getImageData(m,m,a,l);_.fill(T_,0,h),g.fill(0,0,h);for(let e=0;e<l;e++)for(let t=0;t<a;t++){const i=y.data[4*(e*a+t)+3]/255;if(0===i)continue;const n=(e+m)*c+t+m;if(1===i)_[n]=0,g[n]=T_;else{const e=.5-i;_[n]=e>0?e*e:0,g[n]=e<0?e*e:0}}w_(_,0,0,c,u,c,this.f,this.v,this.z),w_(g,m,m,a,l,c,this.f,this.v,this.z);for(let e=0;e<h;e++){const t=Math.sqrt(_[e])-Math.sqrt(g[e]);d[e]=Math.round(255-255*(t/this.radius+this.cutoff))}return p}};const I_=y_;function C_(e,t){return e+t[1]-t[0]}function P_(e,t,i,n,r=1){const o=[],s=e.imagePrimary,a=s.pixelRatio,l=s.paddedRect.w-2*I_,c=s.paddedRect.h-2*I_,u=(e.right-e.left)*r,h=(e.bottom-e.top)*r,d=s.stretchX||[[0,l]],p=s.stretchY||[[0,c]],f=d.reduce(C_,0),m=p.reduce(C_,0),g=l-f,_=c-m;let y=0,v=f,x=0,b=m,T=0,w=g,E=0,S=_;if(s.content&&n){const e=s.content;y=R_(d,0,e[0]),x=R_(p,0,e[1]),v=R_(d,e[0],e[2]),b=R_(p,e[1],e[3]),T=e[0]-y,E=e[1]-x,w=e[2]-e[0]-v,S=e[3]-e[1]-b}const A=(n,o,l,c)=>{const d=B_(n.stretch-y,v,u,e.left*r),p=F_(n.fixed-T,w,n.stretch,f),g=B_(o.stretch-x,b,h,e.top*r),_=F_(o.fixed-E,S,o.stretch,m),A=B_(l.stretch-y,v,u,e.left*r),M=F_(l.fixed-T,w,l.stretch,f),I=B_(c.stretch-x,b,h,e.top*r),C=F_(c.fixed-E,S,c.stretch,m),P=new Ee(d,g),L=new Ee(A,g),R=new Ee(A,I),O=new Ee(d,I),D=new Ee(p/a,_/a),B=new Ee(M/a,C/a),F=t*Math.PI/180;if(F){const e=Math.sin(F),t=Math.cos(F),i=[t,-e,e,t];P._matMult(i),L._matMult(i),O._matMult(i),R._matMult(i)}const N=n.stretch+n.fixed,k=l.stretch+l.fixed,U=o.stretch+o.fixed,z=c.stretch+c.fixed,V=e.imageSecondary;return{tl:P,tr:L,bl:O,br:R,texPrimary:{x:s.paddedRect.x+I_+N,y:s.paddedRect.y+I_+U,w:k-N,h:z-U},texSecondary:V?{x:V.paddedRect.x+I_+N,y:V.paddedRect.y+I_+U,w:k-N,h:z-U}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:D,pixelOffsetBR:B,minFontScaleX:w/a/u,minFontScaleY:S/a/h,isSDF:i}};if(n&&(s.stretchX||s.stretchY)){const e=O_(d,g,f),t=O_(p,_,m);for(let i=0;i<e.length-1;i++){const n=e[i],r=e[i+1];for(let e=0;e<t.length-1;e++)o.push(A(n,t[e],r,t[e+1]))}}else o.push(A({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:l+1},{fixed:0,stretch:c+1}));return o}function L_(e,t){const i=e.stretchY||[[0,e.paddedRect.h-2*I_]];return t&&(e.stretchX||e.stretchY)?D_(e.stretchX||[[0,e.paddedRect.w-2*I_]])*D_(i):1}function R_(e,t,i){let n=0;for(const r of e)n+=Math.max(t,Math.min(i,r[1]))-Math.max(t,Math.min(i,r[0]));return n}function O_(e,t,i){const n=[{fixed:-I_,stretch:0}];for(const[t,i]of e){const e=n[n.length-1];n.push({fixed:t-e.stretch,stretch:e.stretch}),n.push({fixed:t-e.stretch,stretch:e.stretch+(i-t)})}return n.push({fixed:t+I_,stretch:i}),n}function D_(e){return 2*e.length+1}function B_(e,t,i,n){return e/t*i+n}function F_(e,t,i,n){return e-t*i/n}function N_(e,t,i,n){const r=t+e.positionedLines[n].lineOffset;return 0===n?i+r/2:i+(r+(t+e.positionedLines[n-1].lineOffset))/2}function k_(e,t=1,i=!1){let n=1/0,r=1/0,o=-1/0,s=-1/0;const a=e[0];for(let e=0;e<a.length;e++){const t=a[e];(!e||t.x<n)&&(n=t.x),(!e||t.y<r)&&(r=t.y),(!e||t.x>o)&&(o=t.x),(!e||t.y>s)&&(s=t.y)}const l=Math.min(o-n,s-r);let c=l/2;const u=new Un([],U_);if(0===l)return new Ee(n,r);for(let t=n;t<o;t+=l)for(let i=r;i<s;i+=l)u.push(new z_(t+c,i+c,c,e));let h=function(e){let t=0,i=0,n=0;const r=e[0];for(let e=0,o=r.length,s=o-1;e<o;s=e++){const o=r[e],a=r[s],l=o.x*a.y-a.x*o.y;i+=(o.x+a.x)*l,n+=(o.y+a.y)*l,t+=3*l}return new z_(i/t,n/t,0,e)}(e),d=u.length;for(;u.length;){const i=u.pop();(i.d>h.d||!h.d)&&(h=i),i.max-h.d<=t||(c=i.h/2,u.push(new z_(i.p.x-c,i.p.y-c,c,e)),u.push(new z_(i.p.x+c,i.p.y-c,c,e)),u.push(new z_(i.p.x-c,i.p.y+c,c,e)),u.push(new z_(i.p.x+c,i.p.y+c,c,e)),d+=4)}return h.p}function U_(e,t){return t.max-e.max}class z_{constructor(e,t,i,n){this.p=new Ee(e,t),this.h=i,this.d=function(e,t){let i=!1,n=1/0;for(let r=0;r<t.length;r++){const o=t[r];for(let t=0,r=o.length,s=r-1;t<r;s=t++){const r=o[t],a=o[s];r.y>e.y!=a.y>e.y&&e.x<(a.x-r.x)*(e.y-r.y)/(a.y-r.y)+r.x&&(i=!i),n=Math.min(n,pu(e,r,a))}}return(i?1:-1)*Math.sqrt(n)}(this.p,n),this.max=this.d+this.h*Math.SQRT2}}const V_=Object.keys,G_=Number.POSITIVE_INFINITY,j_=Math.sqrt(2);function H_(e,t,i,n){const r=e.collisionPadding||[0,0,0,0],o={top:e.top-r[1],bottom:e.bottom+r[3],left:e.left-r[0],right:e.right+r[2],scaled:!1};return void 0!==n&&function(e,t){e.top*=t,e.bottom*=t,e.left*=t,e.right*=t,e.scaled=!0}(o,n),i&&function(e,t){if(!t)return;const i=Ie(t),n=new Ee(e.left,e.top),r=new Ee(e.right,e.top),o=new Ee(e.left,e.bottom),s=new Ee(e.right,e.bottom);n._rotateAround(i,new Ee(0,0)),r._rotateAround(i,new Ee(0,0)),o._rotateAround(i,new Ee(0,0)),s._rotateAround(i,new Ee(0,0)),e.left=Math.min(n.x,r.x,o.x,s.x),e.right=Math.max(n.x,r.x,o.x,s.x),e.top=Math.min(n.y,r.y,o.y,s.y),e.bottom=Math.max(n.y,r.y,o.y,s.y)}(o,i),t?{top:Math.min(t.top,o.top),bottom:Math.max(t.bottom,o.bottom),left:Math.min(t.left,o.left),right:Math.max(t.right,o.right),scaled:t.scaled||o.scaled}:o}function $_(e,[t,i]){let n=0,r=0;if(i===G_){t<0&&(t=0);const i=t/j_;switch(e){case"top-right":case"top-left":r=i-7;break;case"bottom-right":case"bottom-left":r=7-i;break;case"bottom":r=7-t;break;case"top":r=t-7}switch(e){case"top-right":case"bottom-right":n=-i;break;case"top-left":case"bottom-left":n=i;break;case"left":n=t;break;case"right":n=-t}}else{switch(t=Math.abs(t),i=Math.abs(i),e){case"top-right":case"top-left":case"top":r=i-7;break;case"bottom-right":case"bottom-left":case"bottom":r=7-i}switch(e){case"top-right":case"bottom-right":case"right":n=-t;break;case"top-left":case"bottom-left":case"left":n=t}}return[n,r]}function W_(e,t,i,n,r,o,s,a,l,c,u){const h=e.layers[0],d=h.appearances;if(0===d.length)return{iconBBox:null,iconVerticalBBox:null};let p=null,f=null;const m=n.get("icon-rotate").evaluate(r,{},o);t&&(p=H_(t,p,m,s),i)&&(f=H_(i,f,m+90,s));const[g,_]=n.get("icon-size-scale-range"),y=De(1,g,_);for(const i of d){const n=i.getUnevaluatedProperties(),d=void 0!==n._values["icon-image"].value,g=void 0!==n._values["icon-size"].value,_=void 0!==n._values["icon-offset"].value,v=void 0!==n._values["icon-rotate"].value;if(d||g||_||v){const x=_?h.getAppearanceValueAndResolveTokens(i,"icon-offset",r,o,[]):null,b=x&&Array.isArray(x)?x:a,T=v?h.getAppearanceValueAndResolveTokens(i,"icon-rotate",r,o,[]):null,w="number"==typeof T?T:m,E=g?h.getAppearanceValueAndResolveTokens(i,"icon-size",r,o,[]):null,S="number"==typeof E?E*l.iconScaleFactor:s;let A=null,M=null,I=null;if(d){const t=h.getAppearanceValueAndResolveTokens(i,"icon-image",r,o,[]);if(t){const i=e.getResolvedImageFromTokens(t),s=n._values["icon-size"],a=Y_(i,s_(e.zoom,s,e.worldview),s,o,e.zoom,r,e.pixelRatio,y,e.worldview);I=c.get(a.iconPrimary.toString())}}else t&&(I=t.imagePrimary);I&&(A=e_(I,null,b,u),e.allowVerticalPlacement&&(M=e_(I,null,b,u))),A&&(p=H_(A,p,w,S)),M&&(f=H_(M,f,w+90,S))}}return{iconBBox:p,iconVerticalBBox:f}}function q_(e,t,i,n,r,o,s,a,l){if(!t||!t.usvg)return;const c=r_(n),u=r_(r),h="both"!==o&&"width"!==o||!i_(n)?1:u.width/c.width,d="both"!==o&&"height"!==o||!n_(n)?1:u.height/c.height;i.scaleSelf(h,d);const p=i.toString();s.set(p,i),a.set(p,t);const{imagePosition:f}=x_(p,t,y_);l.set(p,f)}function X_(e,t,i,n,r,o,s,a,l){if(!e)return;const c=function(e,t,i,n,r,o){if("camera"===e.kind)return e.maxSize;if("composite"===e.kind){const n=t.possiblyEvaluate(new Ss(e.maxZoom,{worldview:o}),i).evaluate(r,{},i),s=t.possiblyEvaluate(new Ss(e.minZoom,{worldview:o}),i).evaluate(r,{},i);return Math.max(n,s)}return t.possiblyEvaluate(new Ss(n,{worldview:o})).evaluate(r,{},i)}(t,i,n,r,o,l);return e.scaleSelf(c*a*s)}function Y_(e,t,i,n,r,o,s,a,l){return{iconPrimary:X_(e.getPrimary(),t,i,n,r,o,s,a,l),iconSecondary:X_(e.getSecondary(),t,i,n,r,o,s,a,l)}}function Z_(e,t,i){if(!t)return;const n=i.get(e.toString()),r=i.get(t.toString());n&&r&&(n.paddedRect.w===r.paddedRect.w&&n.paddedRect.h===r.paddedRect.h||qe(`Mismatch in icon variant sizes: ${e.toString()} and ${t.toString()}`),n.usvg!==r.usvg&&qe(`Mismatch in icon variant image types: ${e.id} and ${t.id}`))}function J_(e,t,i,n){if(!e)return;const r=t.get(i.toString());if(e.imagePrimary=r,n){const i=t.get(n.toString());e.imageSecondary=i}}function K_(e,t){for(const i in e.horizontal)Q_(e.horizontal[i],t);Q_(e.vertical,t)}function Q_(e,t){if(e)for(const i of e.positionedLines)for(const e of i.positionedGlyphs)if(null!==e.image){const i=e.image.toString();e.rect=t.get(i).paddedRect}}function ey(e){switch(e){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function ty(e,t,i,n,r,o,s,a,l){const c=sy(o.horizontal)||o.vertical,u=i.get("icon-text-fit-padding").evaluate(n,{},r);let h,d=t;return t&&"none"!==l&&(e.allowVerticalPlacement&&o.vertical&&(h=t_(t,o.vertical,l,u,a,s)),c&&(d=t_(t,c,l,u,a,s))),{defaultShapedIcon:d,verticallyShapedIcon:h}}function iy(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b){let T=s.textMaxSize.evaluate(t,{},d);void 0===T?T=a*s.textScaleFactor:T*=s.textScaleFactor;const w=e.layers[0].layout,E=mg,S=a*s.textScaleFactor/E,A=sy(i.horizontal)||i.vertical;if("none"!==g&&e.appearanceFeatureData&&t.index<e.appearanceFeatureData.length){const i=e.appearanceFeatureData[t.index];i&&(i.textShaping=A,i.iconTextFitPadding=w.get("icon-text-fit-padding").evaluate(t,{},d),i.fontScale=S)}const M="globe"===p.name,I=e.tilePixelRatio*T/E,C=(B=e.overscaling,e.zoom>18&&B>2&&(B>>=1),Math.max(zn/(512*B),1)*w.get("symbol-spacing")),P=w.get("text-padding")*e.tilePixelRatio,L=w.get("icon-padding")*e.tilePixelRatio,R=Ie(w.get("text-max-angle")),O="map"===w.get("icon-rotation-alignment")&&"point"!==v,D=C/2;var B;!1===e.hasAnyIconTextFit&&"none"!==g&&(e.hasAnyIconTextFit=!0);const F=t.properties?+t.properties[Nc]:null,N=F&&e.elevationFeatureIdToIndex?e.elevationFeatureIdToIndex.get(F):65535,k=(a,l,v)=>{if(l.x<0||l.x>=zn||l.y<0||l.y>=zn)return;let T=null;if(M){const{x:e,y:t,z:i}=p.projectTilePoint(l.x,l.y,v);T={anchor:new c_(e,t,i,0,void 0),up:p.upVector(v,l.x,l.y)}}!function(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b,T,w,E,S,A,M,I,C,P){const L=e.addToLineVertexArray(t,n);let R,O,D,B,F,N,k,U=0,z=0,V=0,G=0,j=-1,H=-1;const $={};let W=Kt("");const q=i?i.anchor:t,X="none"!==M;let Y=0,Z=0;if(void 0===l._unevaluatedLayout.getValue("text-radial-offset")){const e=l.layout.get("text-offset").evaluate(x,{},E);Y=e[0]*mg,Z=e[1]*mg}else Y=l.layout.get("text-radial-offset").evaluate(x,{},E)*mg,Z=G_;if(e.allowVerticalPlacement&&r.vertical){const e=r.vertical;if(f)N=ly(e),a&&(k=ly(a));else{const i=l.layout.get("text-rotate").evaluate(x,{},E)+90;D=ay(c,q,t,u,h,d,e,p,i,m),a&&(B=ay(c,q,t,u,h,d,a,_,i,null,P))}}if(o){const n=e.iconSizeData,r=l.layout.get("icon-rotate").evaluate(x,{},E),s=P_(o,r,T,X,b.iconScaleFactor),p=a?P_(a,r,T,X,b.iconScaleFactor):void 0;O=ay(c,q,t,u,h,d,o,_,r,null,C);const f=function(e,t,i,n,r,o,s,a){const l=e.layers[0],c=l.appearances;let u=t.length;if(i&&(u=Math.max(u,i.length)),0===c.length)return u;const[h,d]=n.get("icon-size-scale-range"),p=De(1,h,d);for(const t of c){const i=t.getUnevaluatedProperties();if(void 0!==i._values["icon-image"].value){const n=l.getAppearanceValueAndResolveTokens(t,"icon-image",r,o,[]);if(n){const t=e.getResolvedImageFromTokens(n);if(t){const n=i._values["icon-size"],l=Y_(t,s_(e.zoom,n,e.worldview),n,o,e.zoom,r,e.pixelRatio,p,e.worldview),c=s.get(l.iconPrimary.toString());u=Math.max(u,L_(c,a))}}}}return u}(e,s,p,l.layout,x,E,e.iconAtlasPositions,X);U=4*f;let m=null;"source"===n.kind?(m=[o_*l.layout.get("icon-size").evaluate(x,{},E)*b.iconScaleFactor],m[0]>ry&&qe(`${e.layerIds[0]}: Value for "icon-size" is >= ${ny}. Reduce your "icon-size".`)):"composite"===n.kind&&(m=[o_*b.compositeIconSizes[0].evaluate(x,{},E)*b.iconScaleFactor,o_*b.compositeIconSizes[1].evaluate(x,{},E)*b.iconScaleFactor],(m[0]>ry||m[1]>ry)&&qe(`${e.layerIds[0]}: Value for "icon-size" is >= ${ny}. Reduce your "icon-size".`)),e.addSymbols(e.icon,s,m,v,y,x,void 0,i,t,L.lineStartIndex,L.lineLength,-1,w,E,S,A,e.symbolInstances.length,f),j=e.icon.placedSymbolArray.length-1,p&&(z=4*f,e.addSymbols(e.icon,p,m,v,y,x,zg.vertical,i,t,L.lineStartIndex,L.lineLength,-1,w,E,S,A,e.symbolInstances.length,f),H=e.icon.placedSymbolArray.length-1)}for(const n in r.horizontal){const o=n,a=r.horizontal[o];R||(W=Kt(a.text),f?F=ly(a):R=ay(c,q,t,u,h,d,a,p,l.layout.get("text-rotate").evaluate(x,{},E),m));const g=1===a.positionedLines.length;if(V+=oy(e,i,t,a,s,l,f,x,m,L,r.vertical?zg.horizontal:zg.horizontalOnly,g?V_(r.horizontal):[o],$,j,b,w,E,e.symbolInstances.length,S),g)break}r.vertical&&(G+=oy(e,i,t,r.vertical,s,l,f,x,m,L,zg.vertical,["vertical"],$,H,b,w,E,e.symbolInstances.length,S));let J=-1;const K=(e,t)=>e?Math.max(e,t):t;J=K(F,J),J=K(N,J),J=K(k,J);const Q=J>-1?1:0;e.glyphOffsetArray.length>=65535&&qe("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==x.sortKey&&e.addToSortKeyRanges(e.symbolInstances.length,x.sortKey),e.symbolInstances.emplaceBack(t.x,t.y,q.x,q.y,q.z,$.right>=0?$.right:-1,$.center>=0?$.center:-1,$.left>=0?$.left:-1,$.vertical>=0?$.vertical:-1,j,H,W,void 0!==R?R:e.collisionBoxArray.length,void 0!==R?R+1:e.collisionBoxArray.length,void 0!==D?D:e.collisionBoxArray.length,void 0!==D?D+1:e.collisionBoxArray.length,void 0!==O?O:e.collisionBoxArray.length,void 0!==O?O+1:e.collisionBoxArray.length,B||e.collisionBoxArray.length,B?B+1:e.collisionBoxArray.length,u,V,G,U,z,Q,0,Y,Z,J,0,X?1:0,I)}(e,l,T,a,i,n,o,r,e.layers[0],e.collisionBoxArray,t.index,t.sourceLayerIndex,e.index,P,y,c,0,L,O,_,t,s,u,h,d,f,m,g,N,x,b)};if("line"===v)for(const r of Dp(t.geometry,0,0,zn,zn)){const t=m_(r,C,R,i.vertical||A,n,E,I,e.overscaling,zn);for(const i of t)A&&cy(e,A.text,D,i)||k(r,i,d)}else if("line-center"===v){for(const e of t.geometry)if(e.length>1){const t=f_(e,R,i.vertical||A,n,E,I);t&&k(e,t,d)}}else if("Polygon"===t.type)for(const e of id(t.geometry,0)){const t=k_(e,16);k(e[0],new c_(t.x,t.y,0,0,void 0),d)}else if("LineString"===t.type)for(const e of t.geometry)k(e,new c_(e[0].x,e[0].y,0,0,void 0),d);else if("Point"===t.type)for(const e of t.geometry)for(const t of e)k([t],new c_(t.x,t.y,0,0,void 0),d)}const ny=255,ry=ny*o_;function oy(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y){const v=function(e,t,i,n,r,o,s,a){const l=[];if(0===t.positionedLines.length)return l;const c=n.layout.get("text-rotate").evaluate(o,{})*Math.PI/180,u=function(e){const t=e[0],i=e[1],n=t*i;return n>0?[t,-i]:n<0?[-t,i]:0===t?[i,t]:[i,-t]}(i);let h=Math.abs(t.top-t.bottom);for(const e of t.positionedLines)h-=e.lineOffset;const d=t.positionedLines.length,p=h/d;let f=t.top-i[1];for(let e=0;e<d;++e){const n=t.positionedLines[e];f=N_(t,p,f,e);for(const e of n.positionedGlyphs){if(!e.rect)continue;const n=e.rect||{};let o=Ug+1,h=!0,d=1,p=0;if(e.image){const t=s.get(e.image.toString());if(!t)continue;if(t.sdf){qe("SDF images are not supported in formatted text and will be ignored.");continue}h=!1,d=t.pixelRatio,o=y_/d}const m=(r||a)&&e.vertical,g=e.metrics.advance*e.scale/2,_=e.metrics,y=e.rect;if(null===y)continue;a&&t.verticalizable&&(p=e.image?g-e.metrics.width*e.scale/2:0);const v=r?[e.x+g,e.y]:[0,0];let x=[0,0],b=[0,0],T=!1;r||(m?(b=[e.x+g+u[0],e.y+u[1]-p],T=!0):x=[e.x+g+i[0],e.y+i[1]-p]);const w=y.w*e.scale/(d*(e.localGlyph?S_:1)),E=y.h*e.scale/(d*(e.localGlyph?S_:1));let S,A,M,I;if(m){const t=e.y-f,i=new Ee(-g,g-t),n=-Math.PI/2,r=new Ee(...b);S=new Ee(-g+x[0],x[1]),S._rotateAround(n,i)._add(r),S.x+=-t+g,S.y-=(_.left-o)*e.scale;const s=e.image?_.advance*e.scale:mg*e.scale,a=String.fromCodePoint(e.glyph);yg(a)?S.x+=(1-o)*e.scale:vg(a)?S.x+=s-_.height*e.scale+(-o-1)*e.scale:S.x+=e.image||_.width+2*o===y.w&&_.height+2*o===y.h?(s-E)/2:(s-(_.height+2*o)*e.scale)/2,A=new Ee(S.x,S.y-w),M=new Ee(S.x+E,S.y),I=new Ee(S.x+E,S.y-w)}else{const t=(_.left-o)*e.scale-g+x[0],i=(-_.top-o)*e.scale+x[1],n=t+w,r=i+E;S=new Ee(t,i),A=new Ee(n,i),M=new Ee(t,r),I=new Ee(n,r)}if(c){let e;e=r?new Ee(0,0):T?new Ee(u[0],u[1]):new Ee(i[0],i[1]),S._rotateAround(c,e),A._rotateAround(c,e),M._rotateAround(c,e),I._rotateAround(c,e)}const C=new Ee(0,0),P=new Ee(0,0);l.push({tl:S,tr:A,bl:M,br:I,texPrimary:n,texSecondary:void 0,writingMode:t.writingMode,glyphOffset:v,sectionIndex:e.sectionIndex,isSDF:h,pixelOffsetTL:C,pixelOffsetBR:P,minFontScaleX:0,minFontScaleY:0})}}return l}(0,n,l,o,s,a,r,e.allowVerticalPlacement),x=e.textSizeData;let b=null;"source"===x.kind?(b=[o_*o.layout.get("text-size").evaluate(a,{},g)*f.textScaleFactor],b[0]>ry&&qe(`${e.layerIds[0]}: Value for "text-size" is >= ${ny}. Reduce your "text-size".`)):"composite"===x.kind&&(b=[o_*f.compositeTextSizes[0].evaluate(a,{},g)*f.textScaleFactor,o_*f.compositeTextSizes[1].evaluate(a,{},g)*f.textScaleFactor],(b[0]>ry||b[1]>ry)&&qe(`${e.layerIds[0]}: Value for "text-size" is >= ${ny}. Reduce your "text-size".`)),e.addSymbols(e.text,v,b,l,s,a,u,t,i,c.lineStartIndex,c.lineLength,p,m,g,y,!1,_,v.length);for(const t of h)d[t]=e.text.placedSymbolArray.length-1;return 4*v.length}function sy(e){for(const t in e)return e[t];return null}function ay(e,t,i,n,r,o,s,a,l,c,u){let h,d,p,f;if(h=u?u.top:s.top,d=u?u.bottom:s.bottom,p=u?u.left:s.left,f=u?u.right:s.right,Qg(s)&&s.collisionPadding){const e=s.collisionPadding;p-=e[0],h-=e[1],f+=e[2],d+=e[3]}if(l){const e=new Ee(p,h),t=new Ee(f,h),i=new Ee(p,d),n=new Ee(f,d),r=Ie(l);let o=new Ee(0,0);c&&(o=new Ee(c[0],c[1])),e._rotateAround(r,o),t._rotateAround(r,o),i._rotateAround(r,o),n._rotateAround(r,o),p=Math.min(e.x,t.x,i.x,n.x),f=Math.max(e.x,t.x,i.x,n.x),h=Math.min(e.y,t.y,i.y,n.y),d=Math.max(e.y,t.y,i.y,n.y)}return e.emplaceBack(t.x,t.y,t.z,i.x,i.y,p,h,f,d,a,n,r,o),e.length-1}function ly(e){Qg(e)&&e.collisionPadding&&(e.top-=e.collisionPadding[1],e.bottom+=e.collisionPadding[3]);const t=e.bottom-e.top;return t>0?Math.max(10,t):null}function cy(e,t,i,n){const r=e.compareText;if(t in r){const e=r[t];for(let t=e.length-1;t>=0;t--)if(n.dist(e[t])<i)return!0}else r[t]=[];return r[t].push(n),!1}function uy(e,t){const i=e.fovAboveCenter,n=e.elevation?e.elevation.getMinElevationBelowMSL()*t:0,r=(e._camera.position[2]*e.worldSize-n)/Math.cos(e._pitch);Math.sin(i),Math.sin(Math.max(Math.PI/2-e._pitch-i,.01)),Math.sin(e._pitch);const o=r*(1/e._horizonShift);if(!e.elevation||0===e.elevation.exaggeration()){let t=Math.max(e.zoom-17,0);e.isOrthographic&&(t/=10)}return Math.max(o,r+1e3*e.pixelsPerMeter/Math.cos(e._pitch))}function hy(e,t){if(!t.isReprojectedInTileSpace)return{scale:1<<e.z,x:e.x,y:e.y,x2:e.x+1,y2:e.y+1,projection:t};const i=Math.pow(2,-e.z),n=e.x*i,r=(e.x+1)*i,o=e.y*i,s=(e.y+1)*i,a=dc(n),l=dc(r),c=pc(o),u=pc(s),h=t.project(a,c),d=t.project(l,c),p=t.project(l,u),f=t.project(a,u);let m=Math.min(h.x,d.x,p.x,f.x),g=Math.min(h.y,d.y,p.y,f.y),_=Math.max(h.x,d.x,p.x,f.x),y=Math.max(h.y,d.y,p.y,f.y);const v=i/16;function x(e,i,n,r,o,s){const a=(n+o)/2,l=(r+s)/2,c=t.project(dc(a),pc(l)),u=Math.max(0,m-c.x,g-c.y,c.x-_,c.y-y);m=Math.min(m,c.x),_=Math.max(_,c.x),g=Math.min(g,c.y),y=Math.max(y,c.y),u>v&&(x(e,c,n,r,a,l),x(c,i,a,l,o,s))}x(h,d,n,o,r,o),x(d,p,r,o,r,s),x(p,f,r,s,n,s),x(f,h,n,s,n,o),m-=v,g-=v,_+=v,y+=v;const b=1/Math.max(_-m,y-g);return{scale:b,x:m*b,y:g*b,x2:_*b,y2:y*b,projection:t}}function dy(e,{x:t,y:i},n=0){return new Ee(((t-n)*e.scale-e.x)*zn,(i*e.scale-e.y)*zn)}const py=c(new Float32Array(16));class fy{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,t){return{x:0,y:0,z:0}}unproject(e,t){return new rc(0,0)}projectTilePoint(e,t,i){return{x:e,y:t,z:0}}locationPoint(e,t,i,n=!0){return e._coordinatePoint(e.locationCoordinate(t,i),n)}pixelsPerMeter(e,t){return hc(1,e)*t}pixelSpaceConversion(e,t,i){return 1}farthestPixelDistance(e){return uy(e,e.pixelsPerMeter)}pointCoordinate(e,t,i,n){const r=e.horizonLineFromTop(!1),o=new Ee(t,Math.max(r,i));return e.rayIntersectionCoordinate(e.pointRayIntersection(o,n))}pointCoordinate3D(e,t,i){const n=new Ee(t,i);if(e.elevation)return e.elevation.pointCoordinate(n);{const t=this.pointCoordinate(e,n.x,n.y,0);return[t.x,t.y,t.z]}}isPointAboveHorizon(e,t){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,t.x,t.y);const i=e.horizonLineFromTop();return t.y<i}createInversionMatrix(e,t){return py}createTileMatrix(e,t,i){let n,r,o;const s=i.canonical,a=c(new Float64Array(16));if(this.isReprojectedInTileSpace){const l=hy(s,this);n=1,r=l.x+i.wrap*l.scale,o=l.y,p(a,a,[n/l.scale,n/l.scale,e.pixelsPerMeter/t])}else n=t/e.zoomScale(s.z),r=(s.x+Math.pow(2,s.z)*i.wrap)*n,o=s.y*n;return d(a,a,[r,o,0]),p(a,a,[n/zn,n/zn,1]),a}upVector(e,t,i){return[0,0,1]}upVectorScale(e,t,i){return{metersToTile:1}}}class my extends fy{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[t,i]=this.parallels=e.parallels||[29.5,45.5],n=Math.sin(Ie(t));this.n=(n+Math.sin(Ie(i)))/2,this.c=1+n*(2*this.n-n),this.r0=Math.sqrt(this.c)/this.n}project(e,t){const{n:i,c:n,r0:r}=this,o=Ie(e-this.center[0]),s=Ie(t),a=Math.sqrt(n-2*i*Math.sin(s))/i;return{x:a*Math.sin(o*i),y:a*Math.cos(o*i)-r,z:0}}unproject(e,t){const{n:i,c:n,r0:r}=this,o=r+t;let s=Math.atan2(e,Math.abs(o))*Math.sign(o);o*i<0&&(s-=Math.PI*Math.sign(e)*Math.sign(o));const a=Ie(this.center[0])*i;s=Fe(s,-Math.PI-a,Math.PI-a);const l=De(Ce(s/i)+this.center[0],-180,180),c=Math.asin(De((n-(e*e+o*o)*i*i)/(2*i),-1,1)),u=De(Ce(c),-mc,mc);return new rc(l,u)}}const gy=1.340264,_y=-.081106,yy=893e-6,vy=.003796,xy=Math.sqrt(3)/2;class by extends fy{project(e,t){t=t/180*Math.PI,e=e/180*Math.PI;const i=Math.asin(xy*Math.sin(t)),n=i*i,r=n*n*n;return{x:.5*(e*Math.cos(i)/(xy*(gy+3*_y*n+r*(7*yy+9*vy*n)))/Math.PI+.5),y:1-.5*(i*(gy+_y*n+r*(yy+vy*n))/Math.PI+1),z:0}}unproject(e,t){e=(2*e-.5)*Math.PI;let i=t=(2*(1-t)-1)*Math.PI,n=i*i,r=n*n*n;for(let e,o,s,a=0;a<12&&(o=i*(gy+_y*n+r*(yy+vy*n))-t,s=gy+3*_y*n+r*(7*yy+9*vy*n),e=o/s,i=De(i-e,-Math.PI/3,Math.PI/3),n=i*i,r=n*n*n,!(Math.abs(e)<1e-12));++a);const o=xy*e*(gy+3*_y*n+r*(7*yy+9*vy*n))/Math.cos(i),s=Math.asin(Math.sin(i)/xy),a=De(180*o/Math.PI,-180,180),l=De(180*s/Math.PI,-mc,mc);return new rc(a,l)}}class Ty extends fy{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,t){return{x:.5+e/360,y:.5-t/360,z:0}}unproject(e,t){const i=360*(e-.5),n=De(360*(.5-t),-mc,mc);return new rc(i,n)}}const wy=Math.PI/2;function Ey(e){return Math.tan((wy+e)/2)}class Sy extends fy{constructor(e){super(e),this.center=e.center||[0,30];const[t,i]=this.parallels=e.parallels||[30,30];let n=Ie(t),r=Ie(i);this.southernCenter=n+r<0,this.southernCenter&&(n=-n,r=-r);const o=Math.cos(n),s=Ey(n);this.n=n===r?Math.sin(n):Math.log(o/Math.cos(r))/Math.log(Ey(r)/s),this.f=o*Math.pow(Ey(n),this.n)/this.n}project(e,t){t=Ie(t),this.southernCenter&&(t=-t),e=Ie(e-this.center[0]);const i=1e-6,{n:n,f:r}=this;r>0?t<-wy+i&&(t=-wy+i):t>wy-i&&(t=wy-i);const o=r/Math.pow(Ey(t),n);let s=o*Math.sin(n*e),a=r-o*Math.cos(n*e);return s=.5*(s/Math.PI+.5),a=.5*(a/Math.PI+.5),{x:s,y:this.southernCenter?a:1-a,z:0}}unproject(e,t){e=(2*e-.5)*Math.PI,this.southernCenter&&(t=1-t),t=(2*(1-t)-.5)*Math.PI;const{n:i,f:n}=this,r=n-t,o=Math.sign(r),s=Math.sign(i)*Math.sqrt(e*e+r*r);let a=Math.atan2(e,Math.abs(r))*o;r*i<0&&(a-=Math.PI*Math.sign(e)*o);const l=De(Ce(a/i)+this.center[0],-180,180),c=De(Ce(2*Math.atan(Math.pow(n/s,1/i))-wy),-mc,mc);return new rc(l,this.southernCenter?-c:c)}}class Ay extends fy{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,t){return{x:cc(e),y:uc(t),z:0}}unproject(e,t){const i=dc(e),n=pc(t);return new rc(i,n)}}const My=Ie(mc);class Iy extends fy{project(e,t){const i=(t=Ie(t))*t,n=i*i;return{x:.5*((e=Ie(e))*(.8707-.131979*i+n*(n*(.003971*i-.001529*n)-.013791))/Math.PI+.5),y:1-.5*(t*(1.007226+i*(.015085+n*(.028874*i-.044475-.005916*n)))/Math.PI+1),z:0}}unproject(e,t){e=(2*e-.5)*Math.PI;let i=t=(2*(1-t)-1)*Math.PI,n=25,r=0,o=i*i;do{o=i*i;const e=o*o;r=(i*(1.007226+o*(.015085+e*(.028874*o-.044475-.005916*e)))-t)/(1.007226+o*(.045255+e*(.259866*o-.311325-.005916*11*e))),i=De(i-r,-My,My)}while(Math.abs(r)>1e-6&&--n>0);o=i*i;const s=De(Ce(e/(.8707+o*(o*(o*o*o*(.003971-.001529*o)-.013791)-.131979))),-180,180),a=Ce(i);return new rc(s,a)}}const Cy=Ie(mc);class Py extends fy{project(e,t){t=Ie(t),e=Ie(e);const i=Math.cos(t),n=2/Math.PI,r=Math.acos(i*Math.cos(e/2)),o=Math.sin(r)/r,s=.5*(e*n+2*i*Math.sin(e/2)/o)||0,a=.5*(t+Math.sin(t)/o)||0;return{x:.5*(s/Math.PI+.5),y:1-.5*(a/Math.PI+1),z:0}}unproject(e,t){let i=e=(2*e-.5)*Math.PI,n=t=(2*(1-t)-1)*Math.PI,r=25;const o=1e-6;let s=0,a=0;do{const r=Math.cos(n),o=Math.sin(n),l=2*o*r,c=o*o,u=r*r,h=Math.cos(i/2),d=Math.sin(i/2),p=2*h*d,f=d*d,m=1-u*h*h,g=m?1/m:0,_=m?Math.acos(r*h)*Math.sqrt(1/m):0,y=.5*(2*_*r*d+2*i/Math.PI)-e,v=.5*(_*o+n)-t,x=.5*g*(u*f+_*r*h*c)+1/Math.PI,b=g*(p*l/4-_*o*d),T=.125*g*(l*d-_*o*u*p),w=.5*g*(c*h+_*f*r)+.5,E=b*T-w*x;s=(v*b-y*w)/E,a=(y*T-v*x)/E,i=De(i-s,-Math.PI,Math.PI),n=De(n-a,-Cy,Cy)}while((Math.abs(s)>o||Math.abs(a)>o)&&--r>0);return new rc(Ce(i),Ce(n))}}class Ly extends fy{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Ie(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,t){const{scale:i,cosPhi:n}=this;return{x:Ie(e)*n*i+.5,y:-Math.sin(Ie(t))/n*i+.5,z:0}}unproject(e,t){const{scale:i,cosPhi:n}=this,r=-(t-.5)/i,o=De(Ce((e-.5)/i)/n,-180,180),s=Math.asin(De(r*n,-1,1)),a=De(Ce(s),-mc,mc);return new rc(o,a)}}class Ry extends Ay{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,t,i){const n=qu(e,t,i);return G(n,n,Zu(Vu(i))),{x:n[0],y:n[1],z:n[2]}}locationPoint(e,t,i){const n=tc(t.lat,t.lng),r=k([],n),o=i?e._centerAltitude+i:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(t),e._centerAltitude):e._centerAltitude;O(n,n,r,hc(1,0)*zn*o);const s=c(new Float64Array(16));return h(s,e.pixelMatrix,e.globeMatrix),G(n,n,s),new Ee(n[0],n[1])}pixelsPerMeter(e,t){return hc(1,0)*t}pixelSpaceConversion(e,t,i){const n=hc(1,e)*t,r=di(hc(1,45)*t,n,i);return this.pixelsPerMeter(e,t)/r}createTileMatrix(e,t,i){const n=Ju(Vu(i.canonical));return h(new Float64Array(16),e.globeMatrix,n)}createInversionMatrix(e,t){const{center:i}=e,n=Zu(Vu(t));return m(n,n,Ie(i.lng)),f(n,n,Ie(i.lat)),p(n,n,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(n)}pointCoordinate(e,t,i,n){return ku(e,t,i,!0)||new xc(0,0)}pointCoordinate3D(e,t,i){const n=this.pointCoordinate(e,t,i,0);return[n.x,n.y,n.z]}isPointAboveHorizon(e,t){return!ku(e,t.x,t.y,!1)}farthestPixelDistance(e){const t=function(e,t){const i=e.cameraToCenterDistance,n=e._centerAltitude*t,r=e._camera,o=e._camera.forward(),s=M([],R([],o,-i),[0,0,n]),a=e.worldSize/(2*Math.PI),l=[0,0,-a],c=e.width/e.height,u=Math.tan(e.fovAboveCenter),h=R([],r.up(),u),d=R([],r.right(),u*c),p=k([],M([],M([],o,h),d)),f=[];let m;if(new $c(s,p).closestPointOnSphere(l,a,f)){const t=M([],f,l),i=q([],t,s);m=Math.cos(e.fovAboveCenter)*E(i)}else{const e=q([],s,l),t=q([],l,s);k(t,t);const i=E(e)-a;m=Math.sqrt(i*(i+2*a));const n=Math.acos(m/(a+i))-Math.acos(U(o,t));m*=Math.cos(n)}return 1.01*m}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),i=th(e.zoom);if(i>0){const n=uy(e,hc(1,e.center.lat)*e.worldSize),r=e.worldSize/(2*Math.PI),o=Math.max(e.width,e.height)/e.worldSize*Math.PI;return di(t,n+r*(1-Math.cos(o)),Math.pow(i,10))}return t}upVector(e,t,i){return qu(t,i,e,1)}upVectorScale(e){return{metersToTile:Fu(Xu(Vu(e)))}}}function Oy(e){const t=e.parallels,i=!!t&&Math.abs(t[0]+t[1])<.01;switch(e.name){case"mercator":return new Ay(e);case"equirectangular":return new Ty(e);case"naturalEarth":return new Iy(e);case"equalEarth":return new by(e);case"winkelTripel":return new Py(e);case"albers":return i?new Ly(e):new my(e);case"lambertConformalConic":return i?new Ly(e):new Sy(e);case"globe":return new Ry(e)}throw new Error(`Invalid projection name: ${e.name}`)}const Dy=Pc.types,By=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Fy(e,t,i,n,r,o,s,a,l,c,u,h,d){const p=a?Math.min(ry,Math.round(a[0])):0,f=a?Math.min(ry,Math.round(a[1])):0;e.emplaceBack(t,i,Math.round(32*n),Math.round(32*r),o,s,(p<<1)+(l?1:0),0+(f<<1),16*c,16*u,256*h,256*d)}function Ny(e,t,i){e.emplaceBack(t,i)}function ky(e,t,i,n,r,o,s){e.emplaceBack(t,i,n,r,o,s)}const Uy=(e,t,i,n)=>{for(let r=0;r<t;r++)e.emplaceBack(i[0],i[1],i[2],n[0],n[1],n[2])};function zy(e,t,i,n,r){e.emplaceBack(t,i,n,r),e.emplaceBack(t,i,n,r),e.emplaceBack(t,i,n,r),e.emplaceBack(t,i,n,r)}function Vy(e){for(const t of e.sections)if(fs(t.text))return!0;return!1}class Gy{constructor(e){this.layoutVertexArray=new Sa,this.indexArray=new Da,this.programConfigurations=e,this.segments=new hl,this.dynamicLayoutVertexArray=new Ma,this.opacityVertexArray=new Ia,this.placedSymbolArray=new Ka,this.iconTransitioningVertexArray=new Ca,this.globeExtVertexArray=new Aa,this.zOffsetVertexArray=new ga,this.orientationVertexArray=new Na,this.symbolInstanceIndices=[]}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}getIconVertexData(e,t){const i=[],n=this.layoutVertexArray.uint16;for(let r=0;r<t;++r){const t=12*(e+r);i.push(...n.slice(t,t+12))}return i}updateIconVertexData(e,t,i,n,r,o,s,a,l,c,u,h,d){const p=this.layoutVertexArray.uint16,f=12*e;p[f]=t,p[f+1]=i,p[f+2]=n,p[f+3]=r,p[f+4]=o,p[f+5]=s,p[f+6]=a,p[f+7]=l,p[f+8]=c,p[f+9]=u,p[f+10]=h,p[f+11]=d}upload(e,t,i,n,r,o){this.isEmpty()||(i&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,og.members,!!o),this.indexBuffer=e.createIndexBuffer(this.indexArray,t),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,ag.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,By,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,ug.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,sg.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||r)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,lg.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,cg.members,!0)),this.opacityVertexBuffer.itemSize=1),(i||n)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}es(Gy,"SymbolBuffers");class jy{constructor(e,t,i){this.layoutVertexArray=new e,this.layoutAttributes=t,this.indexArray=new i,this.segments=new hl,this.collisionVertexArray=new Oa,this.collisionVertexArrayExt=new Ma}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,hg.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,dg.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}es(jy,"CollisionBuffers");class Hy{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=c([]),this.placementViewportMatrix=c([]);const t=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=s_(this.zoom,t["text-size"],this.worldview),this.iconSizeData=s_(this.zoom,t["icon-size"],this.worldview);const i=this.layers[0].layout,n=i.get("symbol-sort-key"),r=i.get("symbol-z-order");this.lut=e.lut,this.canOverlap=i.get("text-allow-overlap")||i.get("icon-allow-overlap")||i.get("text-ignore-placement")||i.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==r&&void 0!==n.constantOr(1),this.sortFeaturesByY=("viewport-y"===r||"auto"===r&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=i.get("text-writing-mode").map((e=>zg[e])),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null}hasAnyAppearanceProperty(e){const t=this.layers[0].getAppearances();return!(!t||0===t.length)&&t.some((t=>null!=t.getProperty(e)))}createArrays(){this.text=new Gy(new zl(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("text")||e.startsWith("symbol")))),this.icon=new Gy(new zl(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("icon")||e.startsWith("symbol")))),this.glyphOffsetArray=new tl,this.lineVertexArray=new il,this.symbolInstances=new el}calculateGlyphDependencies(e,t,i,n,r){for(const i of e){const e=i.codePointAt(0);if(void 0===e)break;if(t[e]=!0,n&&r&&e<=65535){const e=_g[i];e&&(t[e.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(e,t,i,n,r,o){let s=1;const a=e.getUnevaluatedProperties()._values["icon-size"],l=s_(this.zoom,a,this.worldview),c=l_(l,t);if("constant"!==l.kind&&"camera"!==l.kind||(s=c.uSize),"composite"===l.kind){const{minZoom:e,maxZoom:t}=l,o=a.possiblyEvaluate(new Ss(e,{worldview:this.worldview}),n),u=a.possiblyEvaluate(new Ss(t,{worldview:this.worldview}),n),h=o.evaluate(i,{},n,r);s=h+(u.evaluate(i,{},n,r)-h)*c.uSizeT}return"source"===l.kind&&(s=a.possiblyEvaluate(new Ss(this.zoom,{worldview:this.worldview}),n).evaluate(i,{},n,r)),s*o}updateFootprints(e,t){}updateReplacement(e,t){if(t.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=t.updateTime;const i=t.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Gd(this.activeReplacements,i)&&(this.activeReplacements=i,!0)}getResolvedImageFromTokens(e){return"string"==typeof e?ki.build(e):e}populate(e,t,i,n){const r=this.layers[0],o=r.layout,s="globe"===this.projection.name,a=o.get("text-font"),l=o.get("text-field"),c=o.get("icon-image"),[u,h]=o.get("icon-size-scale-range"),d=De(t.scaleFactor||1,u,h),p=("constant"!==l.value.kind||l.value.value instanceof Fi&&!l.value.value.isEmpty()||l.value.value.toString().length>0)&&("constant"!==a.value.kind||a.value.value.length>0),f="constant"!==c.value.kind||!!c.value.value||Object.keys(c.parameters).length>0,m=this.hasAnyAppearanceProperty("icon-image"),g=o.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!p&&!f&&!m)return;const _=t.iconDependencies,y=t.glyphDependencies,v=t.availableImages,x=new Ss(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),b=e=>{const t=e.id.toString();_.has(t)?_.get(t).push(e):_.set(t,[e])};for(const t of e){const{feature:e,id:l,index:c,sourceLayerIndex:u}=t,h=r._featureFilter.needGeometry,T=Cc(e,h);if(!r._featureFilter.filter(x,T,i))continue;if(h||(T.geometry=Ic(e,i,n)),s&&1!==e.type&&i.z<=5){const e=T.geometry,t=.98078528056,n=(e,n)=>U(qu(e.x,e.y,i,1),qu(n.x,n.y,i,1))<t;for(let t=0;t<e.length;t++)e[t]=Ec(e[t],n)}let w,E;if(p){const e=r.getValueAndResolveTokens("text-field",T,i,v),t=Fi.factory(e);Vy(t)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Ts()||this.hasRTLText&&Es.isParsed())&&(w=gg(t,r,T))}if(f){const e=r.getValueAndResolveTokens("icon-image",T,i,v);E=this.getResolvedImageFromTokens(e)}const S=this.layers[0];let A=!1;if(!E&&m){const e=S.getAppearances();for(const t of e)if(t.getProperty("icon-image")){const e=S.getAppearanceValueAndResolveTokens(t,"icon-image",T,i,v);if(e){E=this.getResolvedImageFromTokens(e),A=!0;break}}}if(!w&&!E)continue;const M=this.sortFeaturesByKey?g.evaluate(T,{},i):void 0,I={id:l,text:w,icon:E,index:c,sourceLayerIndex:u,geometry:T.geometry,properties:e.properties,type:Dy[e.type],sortKey:M};if(this.features.push(I),this.appearanceFeatureData.push({id:l,properties:e.properties,usesAppearanceIconAsPlaceholder:A,isUsingAppearanceVertexData:!1,layoutBasedVertexData:[],activeAppearance:null}),E){const e=S._unevaluatedLayout._values,{iconPrimary:t,iconSecondary:n}=Y_(E,this.iconSizeData,e["icon-size"],i,this.zoom,I,this.pixelRatio,d,this.worldview);b(t),n&&(this.hasAnySecondaryIcon=!0,b(n))}const C=S.getAppearances();if(0!==C.length&&C.forEach((e=>{if(!e.getProperty("icon-image"))return;const t=this.getCombinedIconPrimary(e,S,T,i,v,I,d);t&&b(t)})),w){const e=a.evaluate(T,{},i).join(","),t="map"===o.get("text-rotation-alignment")&&"point"!==o.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(zg.vertical)>=0;for(const i of w.sections)if(i.image){const e=i.image.getPrimary().scaleSelf(this.pixelRatio),t=e.id.toString(),n=_.get(t)||[];n.push(e),_.set(t,n)}else{const n=ss(w.toString()),r=i.fontStack||e,o=y[r]=y[r]||{};this.calculateGlyphDependencies(i.text,o,t,this.allowVerticalPlacement,n)}}}if("line"===o.get("symbol-placement")&&(this.features=function(e){const t={},i={},n=[];let r=0;function o(t){n.push(e[t]),r++}function s(e,t,r){const o=i[e];return delete i[e],i[t]=o,n[o].geometry[0].pop(),n[o].geometry[0]=n[o].geometry[0].concat(r[0]),o}function a(e,i,r){const o=t[i];return delete t[i],t[e]=o,n[o].geometry[0].shift(),n[o].geometry[0]=r[0].concat(n[o].geometry[0]),o}function l(e,t,i){const n=i?t[0][t[0].length-1]:t[0][0];return`${e}:${n.x}:${n.y}`}for(let c=0;c<e.length;c++){const u=e[c],h=u.geometry,d=u.text?u.text.toString():null;if(!d){o(c);continue}const p=l(d,h),f=l(d,h,!0);if(p in i&&f in t&&i[p]!==t[f]){const e=a(p,f,h),r=s(p,f,n[e].geometry);delete t[p],delete i[f],i[l(d,n[r].geometry,!0)]=r,n[e].geometry=null}else p in i?s(p,f,h):f in t?a(p,f,h):(o(c),t[p]=r-1,i[f]=r-1)}return n.filter((e=>e.geometry))}(this.features)),"hd-road-markup"===o.get("symbol-elevation-reference")){if(this.elevationType="road",t.elevationFeatures){!this.elevationFeatures&&t.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const e of t.elevationFeatures)this.elevationFeatureIdToIndex.set(e.id,this.elevationFeatures.length),this.elevationFeatures.push(e)}}else o.get("symbol-z-elevate")&&(this.elevationType="offset");"none"!==this.elevationType&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort(((e,t)=>e.sortKey-t.sortKey))}getCombinedIconPrimary(e,t,i,n,r,o,s){let a,l;const c=e.getUnevaluatedProperties();if(void 0!==c._values["icon-image"].value){const o=t.getAppearanceValueAndResolveTokens(e,"icon-image",i,n,r);a=this.getResolvedImageFromTokens(o)}else{const e=t.getValueAndResolveTokens("icon-image",i,n,r);a=this.getResolvedImageFromTokens(e)}if(a){const e=c._values["icon-size"]||t._unevaluatedLayout._values["icon-size"];l=Y_(a,s_(this.zoom,e,this.worldview),e,n,this.zoom,o,this.pixelRatio,s,this.worldview).iconPrimary}return l}updateAppearanceBasedIconTextures(e,t,i,n){if(!this.appearanceFeatureData)return!1;if(!this.icon.layoutVertexArray||0===this.icon.layoutVertexArray.length)return!1;const r=this.layers[0];let o=!1,s=0;const a=r.layout,[l,c]=a.get("icon-size-scale-range"),u=De(1,l,c);for(let a=0;a<this.symbolInstances.length;a++){const l=this.symbolInstances.get(a),c=this.appearanceFeatureData[l.featureIndex];if(c&&l.placedIconSymbolIndex>=0){const a=c.id,h=t&&void 0!==a?t[String(a)]:void 0,d={type:"Point",id:c.id,properties:c.properties,geometry:[]},p=this.layers[0].appearances&&this.layers[0].appearances.find((t=>t.isActive({globals:n,feature:d,canonical:e,featureState:h})));if(c.activeAppearance===p)continue;if(p){c.activeAppearance=p;const t={sortKey:void 0,text:void 0,icon:null,index:l.featureIndex,sourceLayerIndex:l.featureIndex,geometry:[],properties:c.properties,type:"Point",id:c.id};if(!p.hasCachedIconPrimary()){const n=this.getCombinedIconPrimary(p,r,d,e,i,t,u);p.setCachedIconPrimary(n)}const a=p.getCachedIconPrimary();if(!a)continue;const h=a.toString(),f=this.iconAtlasPositions&&this.iconAtlasPositions.get(h);if(f){const t=r.getAppearanceValueAndResolveTokens(p,"icon-offset",d,e,i),a=t&&Array.isArray(t)?t:[0,0];let h=e_(f,void 0,a,r.layout.get("icon-anchor").evaluate(d,{},e));const m=r.getAppearanceValueAndResolveTokens(p,"icon-rotate",d,e,i),g="number"==typeof m?m:0,_=f.sdf,y=r.layout.get("icon-text-fit").constantOr("none");"none"!==y&&c.textShaping&&c.iconTextFitPadding&&c.fontScale&&(h=t_(h,c.textShaping,y,c.iconTextFitPadding,a,c.fontScale));const v=this.calculateEffectiveAppearanceIconSize(p,n.zoom,d,e,i,u),x=0,b=1+(Math.min(ry,Math.round(v*o_))<<1),T=P_(h,g,_,"none"!==y,u);c.isUsingAppearanceVertexData||(c.isUsingAppearanceVertexData=!0,c.layoutBasedVertexData=this.icon.getIconVertexData(s,l.numIconVertices));for(let e=0;e<T.length;++e){const t=T[e],i=c.layoutBasedVertexData[0]||l.tileAnchorX,n=c.layoutBasedVertexData[1]||l.tileAnchorY,r=16*t.pixelOffsetTL.x,o=16*t.pixelOffsetTL.y,a=16*t.pixelOffsetBR.x,u=16*t.pixelOffsetBR.y,h=16*t.minFontScaleX,d=16*t.minFontScaleY;this.icon.updateIconVertexData(s,i,n,Math.round(32*t.tl.x),Math.round(32*t.tl.y),t.texPrimary.x,t.texPrimary.y,x,b,r,o,h,d),this.icon.updateIconVertexData(s+1,i,n,Math.round(32*t.tr.x),Math.round(32*t.tr.y),t.texPrimary.x+t.texPrimary.w,t.texPrimary.y,x,b,a,o,h,d),this.icon.updateIconVertexData(s+2,i,n,Math.round(32*t.bl.x),Math.round(32*t.bl.y),t.texPrimary.x,t.texPrimary.y+t.texPrimary.h,x,b,r,u,h,d),this.icon.updateIconVertexData(s+3,i,n,Math.round(32*t.br.x),Math.round(32*t.br.y),t.texPrimary.x+t.texPrimary.w,t.texPrimary.y+t.texPrimary.h,x,b,a,u,h,d),s+=4}const w=l.numIconVertices-4*T.length;for(let e=0;e<w;++e)this.icon.updateIconVertexData(s+e,0,0,0,0,0,0,0,0,0,0,0,0);o=!0}else s+=l.numIconVertices}else if(c.usesAppearanceIconAsPlaceholder)this.layers[0].appearances&&this.layers[0].appearances.length>0&&(this.icon.updateIconVertexData(s,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(s+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(s+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(s+3,0,0,0,0,0,0,0,0,0,0,0,0),o=!0),s+=l.numIconVertices,c.activeAppearance=null;else if(c.isUsingAppearanceVertexData){const e=12,t=c.layoutBasedVertexData.length/e;for(let i=0;i<t;++i){const t=i*e;this.icon.updateIconVertexData(s+i,c.layoutBasedVertexData[t+0],c.layoutBasedVertexData[t+1],c.layoutBasedVertexData[t+2],c.layoutBasedVertexData[t+3],c.layoutBasedVertexData[t+4],c.layoutBasedVertexData[t+5],c.layoutBasedVertexData[t+6],c.layoutBasedVertexData[t+7],c.layoutBasedVertexData[t+8],c.layoutBasedVertexData[t+9],c.layoutBasedVertexData[t+10],c.layoutBasedVertexData[t+11])}s+=t,c.isUsingAppearanceVertexData=!1,c.activeAppearance=null,o=!0}else s+=l.numIconVertices,c.activeAppearance=null}}return o}update(e,t,i,n,r,o,s){this.text.programConfigurations.updatePaintArrays(e,t,r,i,n,o,s,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,t,r,i,n,o,s,this.worldview)}updateRoadElevation(e){if("road"!==this.elevationType||!this.elevationFeatures)return;if(this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let t=!1;const i=vc(e),n=1/i;let r=!1,o=!1;for(let e=0;e<this.symbolInstances.length;e++){const s=this.symbolInstances.get(e),a=S(1,0,0),l=S(0,1,0),{numHorizontalGlyphVertices:c,numVerticalGlyphVertices:u,numIconVertices:h,numVerticalIconVertices:d}=s,p=c>0||u>0,f=h>0,m=this.elevationFeatures[s.elevationFeatureIndex];if(m){const e=new Ee(s.tileAnchorX,s.tileAnchorY),c=.075+m.pointElevation(e);s.zOffset!==c&&(t=!0,s.zOffset=c),0!==c&&(this.hasAnyZOffset=!0);const u=m.computeSlopeNormal(e,n),h=le(ee(),S(0,0,1),u);H(a,a,h),H(l,l,h),a[2]*=i,l[2]*=i,1===a[0]&&0===a[1]&&0===a[2]&&0===l[0]&&1===l[1]&&0===l[2]||(r=r||p,o=o||f)}if(p&&(Uy(this.text.orientationVertexArray,c,a,l),Uy(this.text.orientationVertexArray,u,a,l)),f){const{placedIconSymbolIndex:e,verticalPlacedIconSymbolIndex:t}=s;e>=0&&Uy(this.icon.orientationVertexArray,h,a,l),t>=0&&Uy(this.icon.orientationVertexArray,d,a,l)}}r||(this.text.orientationVertexArray=void 0),o||(this.icon.orientationVertexArray=void 0),t&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(e,t,n)=>{i+=t,i>e.length&&e.resize(i);for(let r=-t;r<0;r++)e.emplace(r+i,n)},t=(e,t,i)=>{n+=t,n>e.length&&e.resize(n);for(let r=-t;r<0;r++)e.emplace(r+n,i)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let i=0,n=0;for(let i=0;i<this.symbolInstances.length;i++){const n=this.symbolInstances.get(i),{numHorizontalGlyphVertices:r,numVerticalGlyphVertices:o,numIconVertices:s}=n,a=n.zOffset,l=s>0;if((r>0||o>0)&&(e(this.text.zOffsetVertexArray,r,a),e(this.text.zOffsetVertexArray,o,a)),l){const{placedIconSymbolIndex:e,verticalPlacedIconSymbolIndex:i}=n;e>=0&&t(this.icon.zOffsetVertexArray,s,a),i>=0&&t(this.icon.zOffsetVertexArray,n.numVerticalIconVertices,a)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e,t,i,n,r){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,!1),null===this.hasAppearances&&(this.hasAppearances=this.layers.some((e=>e.appearances&&e.appearances.length>0))),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(e,t,i,n){return!!(e&&t&&i)&&!(!this.icon.layoutVertexArray||0===this.icon.layoutVertexArray.length)&&!!this.icon.layoutVertexArray.arrayBuffer&&void(this.updateAppearanceBasedIconTextures(e,t,i,n)&&this.icon.layoutVertexBuffer&&null!==this.icon.layoutVertexArray.arrayBuffer&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray))}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Oy(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,t){const i=this.lineVertexArray.length;if(void 0!==e.segment)for(const{x:e,y:i}of t)this.lineVertexArray.emplaceBack(e,i);return{lineStartIndex:i,lineLength:this.lineVertexArray.length-i}}addSymbols(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_){const y=e.indexArray,v=e.layoutVertexArray,x=e.globeExtVertexArray,b=e.segments.prepareSegment(4*_,v,y,this.canOverlap?o.sortKey:void 0),T=this.glyphOffsetArray.length,w=b.vertexLength,E=this.allowVerticalPlacement&&s===zg.vertical?Math.PI/2:0,S=o.text&&o.text.sections;for(let n=0;n<t.length;n++){const{tl:r,tr:s,bl:c,br:u,texPrimary:h,texSecondary:g,pixelOffsetTL:_,pixelOffsetBR:T,minFontScaleX:w,minFontScaleY:A,glyphOffset:M,isSDF:I,sectionIndex:C}=t[n],P=b.vertexLength,L=M[1];if(Fy(v,l.x,l.y,r.x,L+r.y,h.x,h.y,i,I,_.x,_.y,w,A),Fy(v,l.x,l.y,s.x,L+s.y,h.x+h.w,h.y,i,I,T.x,_.y,w,A),Fy(v,l.x,l.y,c.x,L+c.y,h.x,h.y+h.h,i,I,_.x,T.y,w,A),Fy(v,l.x,l.y,u.x,L+u.y,h.x+h.w,h.y+h.h,i,I,T.x,T.y,w,A),a){const{x:t,y:i,z:n}=a.anchor,[r,o,s]=a.up;ky(x,t,i,n,r,o,s),ky(x,t,i,n,r,o,s),ky(x,t,i,n,r,o,s),ky(x,t,i,n,r,o,s),zy(e.dynamicLayoutVertexArray,t,i,n,E)}else zy(e.dynamicLayoutVertexArray,l.x,l.y,l.z,E);if(m){const t=g||h;Ny(e.iconTransitioningVertexArray,t.x,t.y),Ny(e.iconTransitioningVertexArray,t.x+t.w,t.y),Ny(e.iconTransitioningVertexArray,t.x,t.y+t.h),Ny(e.iconTransitioningVertexArray,t.x+t.w,t.y+t.h)}y.emplaceBack(P,P+1,P+2),y.emplaceBack(P+1,P+2,P+3),b.vertexLength+=4,b.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(M[0]),n!==t.length-1&&C===t[n+1].sectionIndex||e.programConfigurations.populatePaintArrays(v.length,o,o.index,{},d,p,f,S&&S[C],this.worldview)}const A=_-t.length;0!==A&&this._addNullVertices(A,v,i,a,x,e,m,b,y);const M=a?a.anchor:l;e.placedSymbolArray.emplaceBack(M.x,M.y,M.z,l.x,l.y,T,this.glyphOffsetArray.length-T,w,c,u,l.segment,i?i[0]:0,i?i[1]:0,n[0],n[1],s,0,0,0,h,0),e.symbolInstanceIndices.push(g)}_addNullVertices(e,t,i,n,r,o,s,a,l){for(let c=0;c<e;c++){for(let e=0;e<4;e++)Fy(t,0,0,0,0,0,0,i,!1,0,0,0,0),n?(ky(r,0,0,0,0,0,0),zy(o.dynamicLayoutVertexArray,0,0,0,0)):zy(o.dynamicLayoutVertexArray,0,0,0,0),s&&Ny(o.iconTransitioningVertexArray,0,0);const e=a.vertexLength;l.emplaceBack(e,e+1,e+2),l.emplaceBack(e+1,e+2,e+3),a.vertexLength+=4,a.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(e,t,i,n,r,o,s){e.emplaceBack(t,i,n,r,o,Math.round(s.x),Math.round(s.y))}_addCollisionDebugVertices(e,t,i,n,r,o,s){const a=i.segments.prepareSegment(4,i.layoutVertexArray,i.indexArray),l=a.vertexLength,c=s.tileAnchorX,u=s.tileAnchorY;for(let e=0;e<4;e++)i.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(i.collisionVertexArrayExt,t,e.padding,s.zOffset),this._commitLayoutVertex(i.layoutVertexArray,n,r,o,c,u,new Ee(e.x1,e.y1)),this._commitLayoutVertex(i.layoutVertexArray,n,r,o,c,u,new Ee(e.x2,e.y1)),this._commitLayoutVertex(i.layoutVertexArray,n,r,o,c,u,new Ee(e.x2,e.y2)),this._commitLayoutVertex(i.layoutVertexArray,n,r,o,c,u,new Ee(e.x1,e.y2)),a.vertexLength+=4;const h=i.indexArray;h.emplaceBack(l,l+1),h.emplaceBack(l+1,l+2),h.emplaceBack(l+2,l+3),h.emplaceBack(l+3,l),a.primitiveLength+=4}_addTextDebugCollisionBoxes(e,t,i,n,r,o){for(let s=n;s<r;s++){const n=i.get(s),r=this.getSymbolInstanceTextSize(e,o,t,s);this._addCollisionDebugVertices(n,r,this.textCollisionBox,n.projectedAnchorX,n.projectedAnchorY,n.projectedAnchorZ,o)}}_addIconDebugCollisionBoxes(e,t,i,n,r,o){for(let s=n;s<r;s++){const n=i.get(s),r=this.getSymbolInstanceIconSize(e,t,o.placedIconSymbolIndex);this._addCollisionDebugVertices(n,r,this.iconCollisionBox,n.projectedAnchorX,n.projectedAnchorY,n.projectedAnchorZ,o)}}generateCollisionDebugBuffers(e,t,i){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new jy(La,pg.members,Ca),this.iconCollisionBox=new jy(La,pg.members,Ca);const n=l_(this.iconSizeData,e),r=l_(this.textSizeData,e,i);for(let i=0;i<this.symbolInstances.length;i++){const o=this.symbolInstances.get(i);this._addTextDebugCollisionBoxes(r,e,t,o.textBoxStartIndex,o.textBoxEndIndex,o),this._addTextDebugCollisionBoxes(r,e,t,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o),this._addIconDebugCollisionBoxes(n,e,t,o.iconBoxStartIndex,o.iconBoxEndIndex,o),this._addIconDebugCollisionBoxes(n,e,t,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex,o)}}getSymbolInstanceTextSize(e,t,i,n){const r=this.text.placedSymbolArray.get(t.rightJustifiedTextSymbolIndex>=0?t.rightJustifiedTextSymbolIndex:t.centerJustifiedTextSymbolIndex>=0?t.centerJustifiedTextSymbolIndex:t.leftJustifiedTextSymbolIndex>=0?t.leftJustifiedTextSymbolIndex:t.verticalPlacedTextSymbolIndex>=0?t.verticalPlacedTextSymbolIndex:n),o=a_(this.textSizeData,e,r)/mg;return this.tilePixelRatio*o}getSymbolInstanceIconSize(e,t,i){const n=this.icon.placedSymbolArray.get(i),r=a_(this.iconSizeData,e,n);return this.tilePixelRatio*r}_commitDebugCollisionVertexUpdate(e,t,i,n){e.emplaceBack(t,-i,-i,n),e.emplaceBack(t,i,-i,n),e.emplaceBack(t,i,i,n),e.emplaceBack(t,-i,i,n)}_updateTextDebugCollisionBoxes(e,t,i,n,r,o,s){for(let s=n;s<r;s++){const n=i.get(s),r=this.getSymbolInstanceTextSize(e,o,t,s);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,r,n.padding,o.zOffset)}}_updateIconDebugCollisionBoxes(e,t,i,n,r,o,s){for(let s=n;s<r;s++){const n=i.get(s),r=this.getSymbolInstanceIconSize(e,t,o.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,r,n.padding,o.zOffset)}}updateCollisionDebugBuffers(e,t,i,n){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const r=l_(this.iconSizeData,e,n),o=l_(this.textSizeData,e,i);for(let s=0;s<this.symbolInstances.length;s++){const a=this.symbolInstances.get(s);this._updateTextDebugCollisionBoxes(o,e,t,a.textBoxStartIndex,a.textBoxEndIndex,a,i),this._updateTextDebugCollisionBoxes(o,e,t,a.verticalTextBoxStartIndex,a.verticalTextBoxEndIndex,a,i),this._updateIconDebugCollisionBoxes(r,e,t,a.iconBoxStartIndex,a.iconBoxEndIndex,a,n),this._updateIconDebugCollisionBoxes(r,e,t,a.verticalIconBoxStartIndex,a.verticalIconBoxEndIndex,a,n)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,t,i,n,r,o,s,a,l){const c={};if(t<i){const{x1:i,y1:n,x2:r,y2:o,padding:s,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:u,tileAnchorX:h,tileAnchorY:d,featureIndex:p}=e.get(t);c.textBox={x1:i,y1:n,x2:r,y2:o,padding:s,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:u,tileAnchorX:h,tileAnchorY:d},c.textFeatureIndex=p}if(n<r){const{x1:t,y1:i,x2:r,y2:o,padding:s,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:u,tileAnchorX:h,tileAnchorY:d,featureIndex:p}=e.get(n);c.verticalTextBox={x1:t,y1:i,x2:r,y2:o,padding:s,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:u,tileAnchorX:h,tileAnchorY:d},c.verticalTextFeatureIndex=p}if(o<s){const{x1:t,y1:i,x2:n,y2:r,padding:s,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:u,tileAnchorX:h,tileAnchorY:d,featureIndex:p}=e.get(o);c.iconBox={x1:t,y1:i,x2:n,y2:r,padding:s,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:u,tileAnchorX:h,tileAnchorY:d},c.iconFeatureIndex=p}if(a<l){const{x1:t,y1:i,x2:n,y2:r,padding:o,projectedAnchorX:s,projectedAnchorY:l,projectedAnchorZ:u,tileAnchorX:h,tileAnchorY:d,featureIndex:p}=e.get(a);c.verticalIconBox={x1:t,y1:i,x2:n,y2:r,padding:o,projectedAnchorX:s,projectedAnchorY:l,projectedAnchorZ:u,tileAnchorX:h,tileAnchorY:d},c.verticalIconFeatureIndex=p}return c}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let t=0;t<this.symbolInstances.length;t++){const i=this.symbolInstances.get(t);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,i.textBoxStartIndex,i.textBoxEndIndex,i.verticalTextBoxStartIndex,i.verticalTextBoxEndIndex,i.iconBoxStartIndex,i.iconBoxEndIndex,i.verticalIconBoxStartIndex,i.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,t){const i=e.placedSymbolArray.get(t),n=i.vertexStartIndex+4*i.numGlyphs;for(let t=i.vertexStartIndex;t<n;t+=4)e.indexArray.emplaceBack(t,t+1,t+2),e.indexArray.emplaceBack(t+1,t+2,t+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const t=Math.sin(e),i=Math.cos(e),n=[],r=[],o=[];for(let e=0;e<this.symbolInstances.length;++e){o.push(e);const s=this.symbolInstances.get(e);n.push(0|Math.round(t*s.tileAnchorX+i*s.tileAnchorY)),r.push(s.featureIndex)}return o.sort(((e,t)=>n[e]-n[t]||r[t]-r[e])),o}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((e,t)=>this.symbolInstances.get(t).zOffset-this.symbolInstances.get(e).zOffset))}addToSortKeyRanges(e,t){const i=this.sortKeyRanges[this.sortKeyRanges.length-1];i&&i.sortKey===t?i.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:t,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const e of this.symbolInstanceIndexes){const t=this.symbolInstances.get(e);this.featureSortOrder.push(t.featureIndex);const{rightJustifiedTextSymbolIndex:i,centerJustifiedTextSymbolIndex:n,leftJustifiedTextSymbolIndex:r,verticalPlacedTextSymbolIndex:o,placedIconSymbolIndex:s,verticalPlacedIconSymbolIndex:a}=t;i>=0&&this.addIndicesForPlacedSymbol(this.text,i),n>=0&&n!==i&&this.addIndicesForPlacedSymbol(this.text,n),r>=0&&r!==n&&r!==i&&this.addIndicesForPlacedSymbol(this.text,r),o>=0&&this.addIndicesForPlacedSymbol(this.text,o),s>=0&&this.addIndicesForPlacedSymbol(this.icon,s),a>=0&&this.addIndicesForPlacedSymbol(this.icon,a)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(e){const t=this.symbolInstances.get(this.text.symbolInstanceIndices[e]).elevationFeatureIndex;let i;return this.elevationFeatures&&t<this.elevationFeatures.length&&(i=this.elevationFeatures[t]),i}}function $y(e,t){return t.replace(/{([^{}]+)}/g,((t,i)=>i in e?String(e[i]):""))}let Wy,qy,Xy;es(Hy,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),Hy.addDynamicAttributes=zy;class Yy{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:_i,this.defaultValue=e}evaluate(e){if(e.formattedSection){const t=this.defaultValue.property.overrides;if(t&&t.hasOverride(e.formattedSection))return t.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}es(Yy,"FormatSectionOverride",{omit:["defaultValue"]});const Zy=()=>Xy||(Xy={layout:Wy||(Wy=new Ns({"symbol-placement":new Ds(ks.layout_symbol["symbol-placement"]),"symbol-spacing":new Ds(ks.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ds(ks.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Bs(ks.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ds(ks.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Ds(ks.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Ds(ks.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Ds(ks.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ds(ks.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ds(ks.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ds(ks.layout_symbol["icon-rotation-alignment"]),"icon-size":new Bs(ks.layout_symbol["icon-size"]),"icon-size-scale-range":new Ds(ks.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Bs(ks.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Bs(ks.layout_symbol["icon-text-fit-padding"]),"icon-image":new Bs(ks.layout_symbol["icon-image"]),"icon-image-use-theme":new Ds({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new Bs(ks.layout_symbol["icon-rotate"]),"icon-padding":new Ds(ks.layout_symbol["icon-padding"]),"icon-keep-upright":new Ds(ks.layout_symbol["icon-keep-upright"]),"icon-offset":new Bs(ks.layout_symbol["icon-offset"]),"icon-anchor":new Bs(ks.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ds(ks.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ds(ks.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ds(ks.layout_symbol["text-rotation-alignment"]),"text-field":new Bs(ks.layout_symbol["text-field"]),"text-font":new Bs(ks.layout_symbol["text-font"]),"text-size":new Bs(ks.layout_symbol["text-size"]),"text-size-scale-range":new Ds(ks.layout_symbol["text-size-scale-range"]),"text-max-width":new Bs(ks.layout_symbol["text-max-width"]),"text-line-height":new Bs(ks.layout_symbol["text-line-height"]),"text-letter-spacing":new Bs(ks.layout_symbol["text-letter-spacing"]),"text-justify":new Bs(ks.layout_symbol["text-justify"]),"text-radial-offset":new Bs(ks.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ds(ks.layout_symbol["text-variable-anchor"]),"text-anchor":new Bs(ks.layout_symbol["text-anchor"]),"text-max-angle":new Ds(ks.layout_symbol["text-max-angle"]),"text-writing-mode":new Ds(ks.layout_symbol["text-writing-mode"]),"text-rotate":new Bs(ks.layout_symbol["text-rotate"]),"text-padding":new Ds(ks.layout_symbol["text-padding"]),"text-keep-upright":new Ds(ks.layout_symbol["text-keep-upright"]),"text-transform":new Bs(ks.layout_symbol["text-transform"]),"text-offset":new Bs(ks.layout_symbol["text-offset"]),"text-allow-overlap":new Ds(ks.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ds(ks.layout_symbol["text-ignore-placement"]),"text-optional":new Ds(ks.layout_symbol["text-optional"]),visibility:new Ds(ks.layout_symbol.visibility)})),paint:qy||(qy=new Ns({"icon-opacity":new Bs(ks.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Bs(ks.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Bs(ks.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Bs(ks.paint_symbol["text-emissive-strength"]),"icon-color":new Bs(ks.paint_symbol["icon-color"]),"icon-halo-color":new Bs(ks.paint_symbol["icon-halo-color"]),"icon-halo-width":new Bs(ks.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Bs(ks.paint_symbol["icon-halo-blur"]),"icon-translate":new Ds(ks.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ds(ks.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ds(ks.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Bs(ks.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Bs(ks.paint_symbol["text-occlusion-opacity"]),"text-color":new Bs(ks.paint_symbol["text-color"],{runtimeType:bi,getOverride:e=>e.textColor,hasOverride:e=>!!e.textColor}),"text-halo-color":new Bs(ks.paint_symbol["text-halo-color"]),"text-halo-width":new Bs(ks.paint_symbol["text-halo-width"]),"text-halo-blur":new Bs(ks.paint_symbol["text-halo-blur"]),"text-translate":new Ds(ks.paint_symbol["text-translate"]),"text-translate-anchor":new Ds(ks.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Ds(ks.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Ds(ks.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Ds(ks.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Ds(ks.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Bs(ks.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},Xy);class Jy extends aa{constructor(e,t,i,n){super(e,Zy(),t,i,n,e.layout?e.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=c([]),this.hasOcclusionOpacityProperties=void 0!==e.paint&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}_handleSpecialPaintPropertyUpdate(e){"icon-occlusion-opacity"!==e&&"text-occlusion-opacity"!==e||(this.hasOcclusionOpacityProperties=!0)}recalculate(e,t){super.recalculate(e,t),this.appearances&&this.appearances.forEach((i=>{i.recalculate(e,t,this.iconImageUseTheme)})),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const i=this.layout.get("text-writing-mode");if(i){const e=[];for(const t of i)e.indexOf(t)<0&&e.push(t);this.layout._values["text-writing-mode"]=e}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,t,i,n){return this._saturation===e&&this._contrast===t&&this._brightnessMin===i&&this._brightnessMax===n||(this._colorAdjustmentMatrix=function(e,t,i,n){e=rt(e),t=nt(t);const r=a(),o=e/3,s=1-2*o,l=[s,o,o,0,o,s,o,0,o,o,s,0,0,0,0,1],c=.5-.5*t,u=n-i;return h(r,[u,0,0,0,0,u,0,0,0,0,u,0,i,i,i,1],[t,0,0,0,0,t,0,0,0,0,t,0,c,c,c,1]),h(r,r,l),r}(e,t,i,n),this._saturation=e,this._contrast=t,this._brightnessMin=i,this._brightnessMax=n),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,t,i,n){const r=this.layout.get(e).evaluate(t,{},i,n),o=this._unevaluatedLayout._values[e];return o.isDataDriven()||Go(o.value)||!r?r:$y(t.properties,r)}getAppearanceValueAndResolveTokens(e,t,i,n,r){const o=e.getProperty(t);if(!o)return;const s=o.evaluate(i,{},n,r),a=e.getUnevaluatedProperties()._values[t];return a.isDataDriven()||Go(a.value)||!s||"string"!=typeof s?s:$y(i.properties,s)}createBucket(e){return new Hy(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Zy().paint.overridableProperties){if(!Jy.hasPaintOverride(this.layout,e))continue;const t=this.paint.get(e),i=new Yy(t),n=new Vo(i,t.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme"));let r=null;r="constant"===t.value.kind||"source"===t.value.kind?new Ho("source",n):new $o("composite",n,t.value.zoomStops,t.value.interpolationType),this.paint._values[e]=new Rs(t.property,r,t.parameters)}}_handleOverridablePaintPropertyUpdate(e,t,i){return!(!this.layout||t.isDataDriven()||i.isDataDriven())&&Jy.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,t){const i=e.get("text-field"),n=Zy().paint.properties[t];let r=!1;const o=e=>{for(const t of e)if(n.overrides&&n.overrides.hasOverride(t))return void(r=!0)};if("constant"===i.value.kind&&i.value.value instanceof Fi)o(i.value.value.sections);else if("source"===i.value.kind){const e=t=>{r||(t instanceof ji&&Vi(t.value)===Si?o(t.value.sections):t instanceof qi?o(t.sections):t.eachChild(e))},t=i.value;t._styleExpression&&e(t._styleExpression.expression)}return r}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,t,i){return{config:new Ul(this,{zoom:t,lut:i}),overrideFog:!1}}hasElevation(){return this.layout&&"hd-road-markup"===this.layout.get("symbol-elevation-reference")}}let Ky,Qy,ev,tv;var iv=ha([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function nv(e,t,i,n,r,a,l,c){const u=[e,t,1,i,n,1,r,a,1],h=[l,c,1],d=o([],u),[p,f,m]=j(h,h,d);return s(u,u,[p,0,0,0,f,0,0,0,m])}function rv(e,t,i,n,r,a,l,c){const u=function(e,t,i,n,r,a,l,c){const u=nv(0,0,1,0,1,1,0,1),h=nv(e,t,i,n,r,a,l,c);return s(h,h,o([],u))}(e,t,i,n,r,a,l,c);return[u[2]/u[8]/zn,u[5]/u[8]/zn]}function ov(e){return[e[0],Math.min(Math.max(e[1],-mc),mc)]}class sv extends ni{constructor(e,t,i,n){super(),this.id=e,this.dispatcher=i,this.coordinates=t.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(n),this.options=t,this._dirty=!1}load(e,t){if(this._loaded=t||!1,this.fire(new Qt("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Ht(this.map._requestManager.transformRequest(this.url,Bt.Image),((t,i)=>{this._imageRequest=null,this._loaded=!0,t?this.fire(new ei(t)):i&&(this.image=i instanceof HTMLImageElement?gt.getImageData(i):i,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())}))}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Lf(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Qt("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Lf||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let t=e[0][1],i=e[0][1];for(const n of e)n[1]>i&&(i=n[1]),n[1]<t&&(t=n[1]);const n=(i+t)/2;if(n>mc?this.onNorthPole=!0:n<-mc&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const t=e.map(xc.fromLngLat);this.tileID=function(e){let t=1/0,i=1/0,n=-1/0,r=-1/0;for(const o of e)t=Math.min(t,o.x),i=Math.min(i,o.y),n=Math.max(n,o.x),r=Math.max(r,o.y);const o=Math.max(n-t,r-i),s=Math.max(0,Math.floor(-Math.log2(o))),a=Math.pow(2,s);let l=Math.floor((t+n)/2*a);return l>1&&(l-=1),new Mu(s,l,Math.floor((i+r)/2*a))}(t),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Qt("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Lf||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const e in this.tiles){const t=this.tiles[e];"loaded"!==t.state&&(t.state="loaded",t.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const t=hy(new Mu(0,0,0),this.map.transform.projection),i=[t.projection.project(this.coordinates[0][0],this.coordinates[0][1]),t.projection.project(this.coordinates[1][0],this.coordinates[1][1]),t.projection.project(this.coordinates[2][0],this.coordinates[2][1]),t.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(e){const t=e[1].x-e[0].x,i=e[1].y-e[0].y,n=e[2].x-e[1].x,r=e[2].y-e[1].y,o=e[3].x-e[2].x,s=e[3].y-e[2].y,a=e[0].x-e[3].x,l=e[0].y-e[3].y,c=t*r-n*i,u=n*s-o*r,h=o*l-a*s,d=a*i-t*l;return c>0&&u>0&&h>0&&d>0||c<0&&u<0&&h<0&&d<0}(i))return void(this._unsupportedCoords=!0);const n=hy(this.tileID,this.map.transform.projection),[r,a,l,c]=this.coordinates.map((e=>{const t=n.projection.project(e[0],e[1]);return dy(n,t)._round()}));this.perspectiveTransform=rv(r.x,r.y,a.x,a.y,l.x,l.y,c.x,c.y);const u=this._boundsArray=new ma;u.emplaceBack(r.x,r.y,0,0),u.emplaceBack(a.x,a.y,zn,0),u.emplaceBack(c.x,c.y,0,zn),u.emplaceBack(l.x,l.y,zn,zn),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(u,iv.members),this.boundsSegments=hl.simpleSegment(0,0,4,2);const h=[],d=[ov((p=this.coordinates)[0]),ov(p[1]),ov(p[2]),ov(p[3])];var p;const[f,m,g,_]=function(e){let t=e[0][0],i=t,n=e[0][1],r=n;for(let o=1;o<e.length;o++)e[o][0]<t?t=e[o][0]:e[o][0]>i&&(i=e[o][0]),e[o][1]<n?n=e[o][1]:e[o][1]>r&&(r=e[o][1]);return[t,n,i-t,r-n]}(d);{const n=new ma,[r,a,l,c]=function(e){let t=e[0].x,i=t,n=e[0].y,r=n;for(let o=1;o<e.length;o++)e[o].x<t?t=e[o].x:e[o].x>i&&(i=e[o].x),e[o].y<n?n=e[o].y:e[o].y>r&&(r=e[o].y);return[t,n,i-t,r-n]}(i),u=e=>[(e.x-r)/l,(e.y-a)/c],[d,p,y,v]=i.map(u),x=function(e,t,i,n,r,a,l,c){const u=nv(0,0,1,0,1,1,0,1);return s(u,u,o([],nv(e,t,i,n,r,a,l,c)))}(d[0],d[1],p[0],p[1],y[0],y[1],v[0],v[1]);this.elevatedGlobePerspectiveTransform=rv(d[0],d[1],p[0],p[1],y[0],y[1],v[0],v[1]);const b=(e,t)=>{h.push(e.lng);const i=Math.round((e.lng-f)/g*zn),r=Math.round((e.lat-m)/_*zn),o=u(t),s=j([],[o[0],o[1],1],x),a=Math.round(s[0]/s[2]*zn),l=Math.round(s[1]/s[2]*zn);n.emplaceBack(i,r,a,l)},T=i[3].x-i[0].x,w=i[3].y-i[0].y,E=i[2].x-i[1].x,S=i[2].y-i[1].y;for(let e=0;e<65;e++){const n=e/64,r=[i[0].x+n*T,i[0].y+n*w],o=[i[1].x+n*E,i[1].y+n*S],s=o[0]-r[0],a=o[1]-r[1];for(let e=0;e<65;e++){const i=e/64,n={x:r[0]+s*i,y:r[1]+a*i};b(t.projection.unproject(n.x,n.y),n)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(n,iv.members)}{this.maxLongitudeTriangleSize=0;let t=[],i=new Da;const n=(e,n,r)=>{i.emplaceBack(e,n,r);const o=h[e],s=h[n],a=h[r],l=Math.min(Math.min(o,s),a),c=Math.max(Math.max(o,s),a)-l;c>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=c),t.push(l+c/2)};for(let e=0;e<64;e++)for(let t=0;t<64;t++){const i=65*e+t,r=i+1,o=i+65,s=o+1;n(i,o,r),n(r,o,s)}[t,i]=function(e,t){const i=Array.from({length:e.length},((e,t)=>t));i.sort(((t,i)=>e[t]-e[i]));const n=[],r=new Da;for(let o=0;o<i.length;o++){const s=i[o];n.push(e[s]);const a=3*s,l=a+1;r.emplaceBack(t.uint16[a],t.uint16[l],t.uint16[l+1])}return[n,r]}(t,i),this.elevatedGlobeTrianglesCenterLongitudes=t,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(i)}this.elevatedGlobeSegments=hl.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,g/zn,0,_/zn,0,0,m,f,0])}prepare(){const e=0!==Object.keys(this.tiles).length;if(this.tileID&&!e)return;const t=this.map.painter.context,i=t.gl;!this._dirty||this.texture instanceof Lf||(this.texture?this.texture.update(this.image):(this.texture=new Pf(t,this.image,i.RGBA8),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(t)}loadTile(e,t){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},t(null)):(e.state="errored",t(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const t=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!t)return null;const i=this.elevatedGlobeTrianglesCenterLongitudes;let n=(r=e+180)+360*Math.round((i[0]-r)/360);var r;const o=new hl,s=(e,i)=>{o.segments.push({vertexOffset:0,primitiveOffset:e,vertexLength:t.segments[0].vertexLength,primitiveLength:i,sortKey:void 0,vaos:{}})},a=.51*this.maxLongitudeTriangleSize;if(Math.abs(i[0]-n)<=a){const e=it(i,0,i.length,n+a);return e===i.length||s(e,tt(i,e+1,i.length,n+360-a)-e),o}n<i[0]&&(n+=360);const l=tt(i,0,i.length,n-a);if(l===i.length)return s(0,i.length),o;s(0,l-0);const c=it(i,l+1,i.length,n+a);return c!==i.length&&s(c,i.length-c),o}}const av=(Math.pow(256,2)-1)/16907520;class lv extends aa{constructor(e,t,i,n){super(e,{layout:ev||(ev=new Ns({visibility:new Ds(ks.layout_raster.visibility)})),paint:tv||(tv=new Ns({"raster-opacity":new Ds(ks.paint_raster["raster-opacity"]),"raster-color":new Fs(ks.paint_raster["raster-color"]),"raster-color-mix":new Ds(ks.paint_raster["raster-color-mix"]),"raster-color-range":new Ds(ks.paint_raster["raster-color-range"]),"raster-hue-rotate":new Ds(ks.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ds(ks.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ds(ks.paint_raster["raster-brightness-max"]),"raster-saturation":new Ds(ks.paint_raster["raster-saturation"]),"raster-contrast":new Ds(ks.paint_raster["raster-contrast"]),"raster-resampling":new Ds(ks.paint_raster["raster-resampling"]),"raster-fade-duration":new Ds(ks.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Ds(ks.paint_raster["raster-emissive-strength"]),"raster-array-band":new Ds(ks.paint_raster["raster-array-band"]),"raster-elevation":new Ds(ks.paint_raster["raster-elevation"]),"raster-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof sv&&(e._source.onNorthPole||e._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(e){"raster-color"!==e&&"raster-color-range"!==e||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap())return;if(!this._curRampRange)return;const t=this._transitionablePaint._values["raster-color"].value.expression,[i,n]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(i)&&isNaN(n)||i===this._curRampRange[0]&&n===this._curRampRange[1]||(this.colorRamp=Sh({expression:t,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:i,end:n}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[i,n])}}let cv,uv,hv,dv,pv;class fv extends aa{constructor(e,t,i,n){super(e,{layout:cv||(cv=new Ns({visibility:new Ds(ks["layout_raster-particle"].visibility)})),paint:uv||(uv=new Ns({"raster-particle-array-band":new Ds(ks["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Ds(ks["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Fs(ks["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Ds(ks["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Ds(ks["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Ds(ks["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Ds(ks["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Ds(ks["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n),this._updateColorRamp(),this.lastInvalidatedAt=gt.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){"raster-particle-color"!==e&&"raster-particle-max-speed"!==e||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===e&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,t=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Sh({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:t}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=gt.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class mv extends aa{constructor(e,t){super(e,{},t,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(e){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function gv(e,t,i){const n=[0,0,1],r=te([]);return ne(r,r,i?-Ie(e)+Math.PI:Ie(e)),ie(r,r,-Ie(t)),H(n,n,r),k(n,n)}const _v={None:0,Model:1,Symbol:2,FillExtrusion:4};class yv{constructor(e,t,i,n){this.message=(e?`${e}: `:"")+i,n&&(this.identifier=n),null!=t&&t.__line__&&(this.line=t.__line__)}}function vv(e,t){const i=-1===e.indexOf("://");try{return new URL(e,i&&t?"http://example.com":void 0),!0}catch(e){return!1}}class xv{constructor(e,t){this.feature=e,this.instancedDataOffset=t,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class bv{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new $a,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(e){const t=16*e,i=this.instancedDataArray.float32;let n=Math.floor(i[t+2]);const r=1.05*(i[t+2]-n);return n/=100,[i[t]%1*1.05,i[t+1]%1*1.05,r,n]}tileCoordinatesForInstance(e){const t=16*e,i=this.instancedDataArray.float32;let n=i[t+0];return n=n>zn?n-zn:n,new Ee(Math.trunc(n),Math.trunc(i[t+1]))}translationForInstance(e){const t=16*e,i=this.instancedDataArray.float32;return[i[t+4],i[t+5],i[t+6]]}rotationScaleForInstance(e){const t=16*e,i=this.instancedDataArray.float32;return[i[t+7],i[t+8],i[t+9],i[t+10],i[t+11],i[t+12],i[t+13],i[t+14],i[t+15]]}transformForInstance(e){const t=16*e,i=this.instancedDataArray.float32;return[i[t+7],i[t+8],i[t+9],i[t+4],i[t+10],i[t+11],i[t+12],i[t+5],i[t+13],i[t+14],i[t+15],i[t+6],0,0,0,1]}}class Tv{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaledZ=this.canonical.z+Math.log2(e.overscaling),this.layers=e.layers,this.layerIds=this.layers.map((e=>e.fqid)),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(e,t){}updateAppearances(e,t,i,n){}populate(e,t,i,n){this.tileToMeter=vc(i);const r=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:o,id:s,index:a,sourceLayerIndex:l}of e){const e=null!=s?s:o.properties&&o.properties.hasOwnProperty("id")?o.properties.id:void 0,c=Cc(o,r);if(!this.layers[0]._featureFilter.filter(new Ss(this.zoom,{worldview:this.worldview,activeFloors:t.activeFloors}),c,i))continue;const u={id:e,sourceLayerIndex:l,index:a,geometry:r?c.geometry:Ic(o,i,n),properties:o.properties,type:o.type,patterns:{}},h=this.addFeature(u,u.geometry,c);h&&t.featureIndex.insert(o,u.geometry,a,l,this.index,this.instancesPerModel[h].instancedDataArray.length,zn/32)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){const e=this.layers[0].modelManager,t=this.layers[0].scope;let i=0;for(const n of this.modelUris){const r=e.getModel(n,t);if(!r)continue;const o=this.instancesPerModel[n];if(o){const e=.5*D(r.aabb.max,r.aabb.min)*o.maxScale+o.maxXYTranslationDistance,t=Math.min(zn,Math.max(e/this.tileToMeter,zn/32));i=Math.max(t,i)}}return i}update(e,t,i,n){for(const t in this.instancesPerModel){const i=this.instancesPerModel[t];for(const t in e)i.idToFeaturesIndex.hasOwnProperty(t)&&(this.evaluate(i.features[i.idToFeaturesIndex[t]],e[t],i,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const t in this.instancesPerModel){const i=this.instancesPerModel[t];for(const t of i.features){const n=this.layers[0],r=t.feature,o=this.canonical,s=n.paint.get("model-rotation").evaluate(r,{},o),a=n.paint.get("model-scale").evaluate(r,{},o),l=n.paint.get("model-translation").evaluate(r,{},o);W(t.rotation,s)&&W(t.scale,a)&&W(t.translation,l)||(this.evaluate(t,t.featureStates,i,!0),e=!0)}}return e}updateReplacement(e,t,i,n){if(t.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=t.updateTime;const r=t.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Gd(this.activeReplacements,r))return!1;this.activeReplacements=r;let o=!1;for(const t in this.instancesPerModel){const r=this.instancesPerModel[t],s=r.instancedDataArray;for(const t of r.features){const r=t.instancedDataOffset,a=t.instancedDataCount;for(let t=0;t<a;t++){const a=16*(t+r);let l=s.float32[a+0];const c=l>zn;l=c?l-zn:l;const u=Math.floor(l),h=Math.floor(s.float32[a+1]);let d=!1;for(const t of this.activeReplacements)if(!kd(t,i,_v.Model,n)&&!(t.min.x>u||u>t.max.x||t.min.y>h||h>t.max.y)&&(d=Xd(qd(u,h,e.canonical,t.footprintTileId.canonical),t.footprint),d))break;s.float32[a]=d?l+zn:l,o=o||d!==c}}}return o}isEmpty(){for(const e in this.instancesPerModel)if(0!==this.instancesPerModel[e].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const t in this.instancesPerModel){const i=this.instancesPerModel[t];i.instancedDataArray.length<0||0===i.instancedDataArray.length||(i.instancedDataBuffer?i.instancedDataBuffer.updateData(i.instancedDataArray):i.instancedDataBuffer=e.createVertexBuffer(i.instancedDataArray,Nf.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const e in this.instancesPerModel){const t=this.instancesPerModel[e];0!==t.instancedDataArray.length&&t.instancedDataBuffer&&t.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(const t of this.modelUris)e.removeModel(t,"",!0)}addFeature(e,t,i){const n=this.layers[0],r=n.layout.get("model-id").evaluate(i,{},this.canonical);if(!r)return qe(`modelId is not evaluated for layer ${n.id} and it is not going to get rendered.`),r;(vv(r,!1)||void 0!==this.styleDefinedModelURLs[r])&&(this.modelUris.includes(r)||this.modelUris.push(r)),this.instancesPerModel[r]||(this.instancesPerModel[r]=new bv);const o=this.instancesPerModel[r],s=o.instancedDataArray,a=new xv(i,s.length);for(const e of t)for(const t of e){if(t.x<0||t.x>=zn||t.y<0||t.y>=zn)continue;if(0!==this.lookupDim){const e=(this.lookupDim-1)/zn,i=this.lookupDim*(t.y*e|0)+t.x*e|0;if(this.lookup){if(0!==this.lookup[i])continue;this.lookup[i]=1}}this.instanceCount++;const e=s.length;s.resize(e+1),o.instancesEvaluatedElevation.push(0),s.float32[16*e]=t.x,s.float32[16*e+1]=t.y}return a.instancedDataCount=o.instancedDataArray.length-a.instancedDataOffset,a.instancedDataCount>0&&(e.id&&(o.idToFeaturesIndex[e.id]=o.features.length),o.features.push(a),this.evaluate(a,{},o,!1)),r}getModelUris(){return this.modelUris}evaluate(e,t,i,n){const r=this.layers[0],o=e.feature,s=this.canonical,a=e.rotation=r.paint.get("model-rotation").evaluate(o,t,s),l=e.scale=r.paint.get("model-scale").evaluate(o,t,s),c=e.translation=r.paint.get("model-translation").evaluate(o,t,s),u=Object.assign({},r.paint.get("model-color").evaluate(o,t,s));u.a=r.paint.get("model-color-mix-intensity").evaluate(o,t,s);const h=[];this.maxVerticalOffset<c[2]&&(this.maxVerticalOffset=c[2]);const d=c[0]*c[0]+c[1]*c[1],p=d>0?Math.sqrt(d):0;i.maxScale=Math.max(Math.max(i.maxScale,l[0]),Math.max(l[1],l[2])),i.maxXYTranslationDistance=Math.max(i.maxXYTranslationDistance,p),this.maxScale=Math.max(Math.max(this.maxScale,l[0]),Math.max(l[1],l[2])),$f(h,a,l);const f=Math.round(100*u.a)+u.b/1.05;for(let t=0;t<e.instancedDataCount;++t){const r=e.instancedDataOffset+t,o=16*r,a=i.instancedDataArray.float32;let l=0;n&&(l=a[o+6]-i.instancesEvaluatedElevation[r]);const d=0|a[o+1];a[o]=(0|a[o])+u.r/1.05,a[o+1]=d+u.g/1.05,a[o+2]=f,a[o+3]=1/(s.z>10?this.tileToMeter:vc(s,d)),a[o+4]=c[0],a[o+5]=c[1],a[o+6]=c[2]+l,a[o+7]=h[0],a[o+8]=h[1],a[o+9]=h[2],a[o+10]=h[4],a[o+11]=h[5],a[o+12]=h[6],a[o+13]=h[8],a[o+14]=h[9],a[o+15]=h[10],i.instancesEvaluatedElevation[r]=c[2]}}}let wv,Ev;es(Tv,"ModelBucket",{omit:["layers"]}),es(bv,"PerModelAttributes"),es(xv,"ModelFeature");class Sv{constructor(e,t,i){this._demTile=e,this._dem=this._demTile.dem,this._scale=t,this._offset=i}static create(e,t,i){const n=i||e.findDEMTileFor(t);if(!n||!n.dem)return;const r=n.dem,o=n.tileID,s=1<<t.canonical.z-o.canonical.z;return new Sv(n,r.dim/zn/s,[(t.canonical.x/s-o.canonical.x)*r.dim,(t.canonical.y/s-o.canonical.y)*r.dim])}tileCoordToPixel(e,t){const i=t*this._scale+this._offset[1];return new Ee(Math.floor(e*this._scale+this._offset[0]),Math.floor(i))}getElevationAt(e,t,i,n){const r=e*this._scale+this._offset[0],o=t*this._scale+this._offset[1],s=Math.floor(r),a=Math.floor(o),l=this._dem;return n=!!n,i?di(di(l.get(s,a,n),l.get(s,a+1,n),o-a),di(l.get(s+1,a,n),l.get(s+1,a+1,n),o-a),r-s):l.get(s,a,n)}getElevationAtPixel(e,t,i){return this._dem.get(e,t,!!i)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*hc(1,e)*this._dem.stride}}const Av=new Float32Array(262144),Mv=new Uint8Array(262144);function Iv(e){let t=0;if(e.meshes)for(const i of e.meshes)t=Math.max(t,i.aabb.max[2]);if(e.children)for(const i of e.children)t=Math.max(t,Iv(i));return t}function Cv(e,t,i){if(e.meshes)for(const n of e.meshes){if(n.aabb.min[0]===1/0)continue;const r=Kc.applyTransform(n.aabb,e.globalMatrix);i.insert(t,r.min[0],r.min[1],r.max[0],r.max[1])}if(e.children)for(const n of e.children)Cv(n,t,i)}const Pv=["","wall","door","roof","window","lamp","logo"];class Lv{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:Iv(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Kc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const t=new Kc([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const i of this.node.meshes)this.node.lightMeshIndex!==e&&(i.transformedAabb=Kc.applyTransformFast(i.aabb,this.node.globalMatrix),t.encapsulate(i.transformedAabb)),e++;this.aabb=t}return this.aabb}}class Rv{constructor(e,t,i,n,r,o,s,a){this.id=i,this.layers=e,this.layerIds=this.layers.map((e=>e.fqid)),this.stateDependentLayerIds=this.layers.filter((e=>e.isStateDependent())).map((e=>e.id)),this.modelTraits|=Zf.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,n&&(this.modelTraits|=Zf.HasMapboxMeshFeatures),r&&(this.modelTraits|=Zf.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=o,this.worldview=a,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const e of t)this.nodesInfo.push(new Lv(e)),Cv(e,s.featureIndexArray.length,s.grid),s.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,s.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(e,t){for(const i of this.getNodesInfo()){const n=i.node;n.footprint&&t.push({footprint:n.footprint,id:e})}}updateAppearances(e,t,i,n){}update(e){const t=0!==Object.keys(e).length;if(t&&!this.stateDependentLayers.length)return;const i=t?this.stateDependentLayers:this.layers;if(!Se(e,this.states))for(const t of i)this.evaluate(t,e);this.states=structuredClone(e)}populate(){}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const t=this.getNodesInfo();for(const i of t){const t=i.node;this.uploaded?this.updatePbrBuffer(t):tm(t,e,!0)}for(const e of t)im(e.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let t=!1;if(!e.meshes)return t;for(const i of e.meshes)i.pbrBuffer&&(i.pbrBuffer.updateData(i.featureArray),t=!0);return t}needsReEvaluation(e,t,i){const n=e.transform.projectionOptions,r=e.style.getBrightness(),o=this.brightness!==r;if(!this.uploaded||this.dirty||n.name!==this.projection.name||Ov(i.paint.get("model-color").value,o)||Ov(i.paint.get("model-color-mix-intensity").value,o)||Ov(i.paint.get("model-roughness").value,o)||Ov(i.paint.get("model-emissive-strength").value,o)||Ov(i.paint.get("model-height-based-emissive-strength-multiplier").value,o)){this.projection=n,this.brightness=r;const e=this.getNodesInfo();for(const t of e)t.state=null;return!0}return!1}evaluateTransform(e,t){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const i=this.getNodesInfo(),n=this.id.canonical;for(const e of i){const i=e.feature;e.evaluatedTranslation=t.paint.get("model-translation").evaluate(i,{},n),e.evaluatedScale=t.paint.get("model-scale").evaluate(i,{},n)}}evaluate(e,t){const i=this.getNodesInfo();for(const n of i){if(!n.node.meshes)continue;const i=n.feature,r=t&&t[i.id];if(Se(r,n.state))continue;n.state=structuredClone(r);const o=n.node.meshes&&n.node.meshes[0].featureData,s=n.evaluatedColor[2],a=n.evaluatedRMEA[2],l=this.id.canonical;if(n.hasTranslucentParts=!1,o){for(let t=0;t<Pv.length;t++){const o=Pv[t];o.length&&(i.properties.part=o);const s=e.paint.get("model-color").evaluate(i,r,l).toPremultipliedRenderColor(null),a=e.paint.get("model-color-mix-intensity").evaluate(i,r,l);n.evaluatedColor[t]=[s.r,s.g,s.b,a],n.evaluatedRMEA[t][0]=e.paint.get("model-roughness").evaluate(i,r,l),n.evaluatedRMEA[t][2]=e.paint.get("model-emissive-strength").evaluate(i,r,l),n.evaluatedRMEA[t][3]=s.a,n.emissionHeightBasedParams[t]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(i,r,l),!n.hasTranslucentParts&&s.a<1&&(n.hasTranslucentParts=!0)}delete i.properties.part,Bv(n,s!==n.evaluatedColor[2]||a!==n.evaluatedRMEA[2],this.modelTraits)}else n.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(i,r,l);n.evaluatedTranslation=e.paint.get("model-translation").evaluate(i,r,l),n.evaluatedScale=e.paint.get("model-scale").evaluate(i,r,l),this.updatePbrBuffer(n.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,t,i,n){const r=e.findDEMTileFor(i);if(r&&(r.tileID.canonical!==this.terrainTile||t!==this.terrainExaggeration)){if(r.dem&&r.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=r.tileID.overscaledZ;const t=Sv.create(e,i,r);if(!t)return;this.modelTraits&Zf.HasMapboxMeshFeatures&&this.updateDEM(e,t,i,n);for(const e of this.getNodesInfo()){const i=e.node;if(!i.footprint||!i.footprint.vertices||!i.footprint.vertices.length)continue;const n=i.footprint.vertices;let r=t.getElevationAt(n[0].x,n[0].y,!0,!0);for(let e=1;e<n.length;e++)r=Math.min(r,t.getElevationAt(n[e].x,n[e].y,!0,!0));i.elevation=r}}this.terrainTile=r.tileID.canonical,this.terrainExaggeration=t}}updateDEM(e,t,i,n){let r=t._dem._modifiedForSources[n];if(void 0===r&&(t._dem._modifiedForSources[n]=[],r=t._dem._modifiedForSources[n]),r.includes(i.canonical))return;const o=t._dem.dim;r.push(i.canonical);let s=!1;for(const e of this.getNodesInfo()){const i=e.node;if(!i.footprint||!i.footprint.grid)continue;const n=i.footprint.grid,r=t.tileCoordToPixel(n.min.x,n.min.y),a=t.tileCoordToPixel(n.max.x,n.max.y),l=Math.min(Math.min(o-a.y,r.x),Math.min(r.y,o-a.x));if(l<0)continue;const c=De(l,2,5);let u=Math.max(0,r.x-c),h=Math.max(0,r.y-c),d=Math.min(a.x+c,o-1),p=Math.min(a.y+c,o-1);for(let e=h;e<=p;++e)for(let t=u;t<=d;++t)Mv[e*o+t]=255;let f=0,m=0;for(let e=0;e<n.cellsY;++e)for(let i=0;i<n.cellsX;++i){if(!n.cells[e*n.cellsX+i])continue;const r=t.tileCoordToPixel(n.min.x+i/n.xScale,n.min.y+e/n.yScale),s=t.tileCoordToPixel(n.min.x+(i+1)/n.xScale,n.min.y+(e+1)/n.yScale);for(let e=r.y;e<=Math.min(s.y+1,o-1);++e)for(let i=r.x;i<=Math.min(s.x+1,o-1);++i)255===Mv[e*o+i]&&(Mv[e*o+i]=0,f+=t.getElevationAtPixel(i,e),m++)}const g=f/m;u=Math.max(1,r.x-c),h=Math.max(1,r.y-c),d=Math.min(a.x+c,o-2),p=Math.min(a.y+c,o-2),s=!0;for(let e=h;e<=p;++e)for(let i=u;i<=d;++i)0===Mv[e*o+i]&&(Av[e*o+i]=t._dem.set(i,e,g));for(let e=1;e<c;++e){u=Math.max(1,r.x-e),h=Math.max(1,r.y-e),d=Math.min(a.x+e,o-2),p=Math.min(a.y+e,o-2);for(let i=h;i<=p;++i)for(let n=u;n<=d;++n){const r=i*o+n;if(255===Mv[r]){let s=0,a=0,l=-1,u=-1;for(let t=-1;t<=1;++t)for(let r=-1;r<=1;++r){const c=(i+t)*o+n+r;if(Mv[c]>=e)continue;const h=Av[c],d=Math.abs(h);d>a&&(s=h,a=d,l=r,u=t)}if(a>.1){const o=1-(e+.5*Math.abs(l*u))/c;let a=t._dem.get(n,i)+s*o;const h=t._dem.get(n+l,i+u),d=t._dem.get(n-l,i-u,!0);(a-h)*(a-d)>0&&(a=(h+d)/2),Av[r]=t._dem.set(n,i,a),Mv[r]=e}}}}}s&&(t._demTile.needsDEMTextureUpload=!0,t._dem._timestamp=gt.now())}setFilter(e){this.filter=e?Gs(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter((e=>this.filter.filter(new Ss(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical))):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const t of e)im(t.node),nm(t.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,t){if(t.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=t.updateTime;const i=t.getReplacementRegionsForTile(e.toUnwrapped());for(const e of this.getNodesInfo()){const t=e.node.footprint;e.hiddenByReplacement=!!t&&!i.find((e=>e.footprint===t))}}getHeightAtTileCoord(e,t){const i=[],n=[0,0,0],r=c([]);for(const o of this.getNodesInfo()){const s=o.node.meshes[0],a=s.transformedAabb;if(e<a.min[0]||t<a.min[1]||e>a.max[0]||t>a.max[1])continue;if(!0===o.node.hidden)return{height:1/0,maxHeight:o.feature.properties.height,hidden:!1,verticalScale:o.evaluatedScale[2]};u(r,o.node.globalMatrix),n[0]=e,n[1]=t,G(n,n,r);const l=(n[0]-s.aabb.min[0])/(s.aabb.max[0]-s.aabb.min[0])*Yf|0,c=Math.min(63,(n[1]-s.aabb.min[1])/(s.aabb.max[1]-s.aabb.min[1])*Yf|0)*Yf+Math.min(63,l),h=s.heightmap[c];if(!(h<0&&o.node.footprint)){if(o.hiddenByReplacement)return;return{height:h,maxHeight:o.feature.properties.height,hidden:!1,verticalScale:o.evaluatedScale[2]}}if(o.node.footprint.grid.query(new Ee(e,t),new Ee(e,t),i),i.length>0)return{height:void 0,maxHeight:o.feature.properties.height,hidden:o.hiddenByReplacement,verticalScale:o.evaluatedScale[2]}}}}function Ov(e,t){return e instanceof Ho&&!e.isLightConstant&&t}function Dv(e,t,i,n,r,o,s,a){let l=(61440&t|(61440&t)>>4)>>8,c=(3840&t|(3840&t)>>4)>>4,u=240&t|(240&t)>>4;i[3]>0&&(l=di(l,255*i[0],i[3]),c=di(c,255*i[1],i[3]),u=di(u,255*i[2],i[3]));const h=l<<8|c,d=u<<8|Math.floor(255*n[3]),p=function(e){const t=De(e,0,2);return Math.min(Math.round(.5*t*255),255)}(n[2])<<8|15*n[0]<<4|15*n[1],f=De(r[0],0,1),m=De(r[1],0,1),g=De(r[2],0,1),_=De(r[3],0,1);let y,v,x,b;if(f!==m&&s!==o&&m!==f){const e=s-o;v=1/(e*(m-f)),x=-(o+e*f)/(e*(m-f));const t=De(r[4],-1,1);b=Math.pow(10,t),y=255*g<<8|255*_}else y=65535,v=0,x=1,b=1;if(e.emplaceBack(h,d,p,y,v,x,b),a){const e=a.length;a.clear();for(let t=0;t<e;t++)a.emplaceBack(h,d,p,y,v,x,b)}}function Bv(e,t,i){const n=e.node;let r=0;const o=i&Zf.HasMeshoptCompression;for(const i of n.meshes){if(n.lights&&n.lightMeshIndex===r)continue;if(!i.featureData)continue;i.featureArray=new Wa,i.featureArray.reserve(i.featureData.length);let s=t;for(const t of i.featureData){const r=o?65535&t:t>>16&65535,a=o?t>>16&65535:65535&t,l=(15&a)<8?15&a:0,c=e.evaluatedRMEA[l],u=e.evaluatedColor[l],h=e.emissionHeightBasedParams[l];let d;if(s&&2===l&&n.lights&&(d=new Wa,d.resize(10*n.lights.length)),Dv(i.featureArray,r,u,c,h,i.aabb.min[2],i.aabb.max[2],d),d&&s){s=!1;const e=n.meshes[n.lightMeshIndex];e.featureArray=d,e.featureArray._trim()}}i.featureArray._trim(),r++}}es(Rv,"Tiled3dModelBucket",{omit:["layers"]}),es(Lv,"Tiled3dModelFeature");const Fv=["id","tile","layer","source","sourceLayer","state"];class Nv{constructor(e,t,i,n,r){this.type="Feature",this._vectorTileFeature=e,this._z=t,this._x=i,this._y=n,this.properties=e?e.properties:{},this.id=r}clone(){const e=new Nv(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return void 0===this._geometry&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const t of Fv)void 0!==this[t]&&(e[t]=this[t]);return e}}class kv extends ni{constructor(e,t,i,n){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=t,this._modelsInfo=new Map}load(){const e=[];for(const t in this._options.models){const i=this._options.models[t],n=this._modelsInfo.get(t);if(n){const e=n.model;e.position=null!=i.position?new rc(i.position[0],i.position[1]):new rc(0,0),e.orientation=null!=i.orientation?i.orientation:[0,0,0],n.modelSpec=i,kv.applyModelSpecification(e,i),e.computeBoundsAndApplyParent(),this.models.push(e)}else{const n=Mf(this.map._requestManager.transformRequest(i.uri,Bt.Model).url).then((e=>{if(!e)return;const n=hm(e),r=new Kf(t,i.uri,i.position,i.orientation,n);kv.applyModelSpecification(r,i),r.computeBoundsAndApplyParent(),this.models.push(r),this._modelsInfo.set(t,{modelSpec:i,model:r})})).catch((e=>{this.fire(new ei(new Error(`Could not load model ${t} from ${i.uri}: ${e.message}`)))}));e.push(n)}}Promise.allSettled(e).then((()=>{this._loaded=!0,this.fire(new Qt("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((e=>{this._loaded=!0,this.fire(new ei(new Error(`Could not load models: ${e.message}`)))}))}static applyModelSpecification(e,t){t.nodeOverrides&&kv.convertNodeOverrides(e,t.nodeOverrides),t.materialOverrides&&kv.convertMaterialOverrides(e,t.materialOverrides),t.nodeOverrideNames&&(e.nodeOverrideNames=[...t.nodeOverrideNames]),t.materialOverrideNames&&(e.materialOverrideNames=[...t.materialOverrideNames]),t.featureProperties&&(e.featureProperties=t.featureProperties)}static convertNodeOverrides(e,t){if(Array.isArray(t)&&t.every((e=>"string"==typeof e))){e.nodeOverrideNames=[];for(const i of t)e.nodeOverrideNames.push(i)}else Object.entries(t).forEach((([t,i])=>{const n={orientation:[0,0,0]};if(i.hasOwnProperty("orientation")){const e=i.orientation;e&&(n.orientation=e)}e.nodeOverrides.set(t,n)}))}static convertMaterialOverrides(e,t){if(Array.isArray(t)&&t.every((e=>"string"==typeof e))){e.materialOverrideNames=[];for(const i of t)e.materialOverrideNames.push(i)}else Object.entries(t).forEach((([t,i])=>{const n={color:new li(1,1,1),colorMix:0,emissionStrength:0,opacity:1},r=i["model-color"];void 0!==r&&(n.color.r=r[0],n.color.g=r[1],n.color.b=r[2]);const o=i["model-color-mix-intensity"];void 0!==o&&(n.colorMix=o);const s=i["model-emissive-strength"];void 0!==s&&(n.emissionStrength=s);const a=i["model-opacity"];void 0!==a&&(n.opacity=a),e.materialOverrides.set(t,n)}))}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,t){}serialize(){return this._options}setProperty(e,t){return!1}reload(){const e=ta(this.id,this.scope);this.map.style.clearSource(e),this.models=[],this._modelsInfo.clear(),this._loaded=!1,this.load()}setModels(e){this.models=[];const t=new Map;for(const i in e){const n=e[i];if(this._modelsInfo.has(i)){const e=this._modelsInfo.get(i);e&&e.modelSpec.uri===n.uri&&t.set(i,e)}}this._modelsInfo=t,this._options.models=e,this._loaded=!1,this.load()}}function Uv(e,t,i,n){const r=1<<e.z;t.lat=pc((n/zn+e.y)/r),t.lng=dc((i/zn+e.x)/r)}function zv(e,t,i,n){const r=e.getNodesInfo()[t];if(!r||r.hiddenByReplacement||!r.node.meshes)return;let o=Number.MAX_VALUE;const s=r.node,a=i.tile,l=n.calculatePosMatrix(a.tileID.toUnwrapped(),n.worldSize),c=r.evaluatedScale;let u=0;n.elevation&&s.elevation&&(u=s.elevation*n.elevation.exaggeration()),d(l,l,[(s.anchor?s.anchor[0]:0)*(c[0]-1),(s.anchor?s.anchor[1]:0)*(c[1]-1),u]),p(l,l,c);const f=i.queryGeometry,m=f.isPointQuery()?f.screenBounds:f.screenGeometry,g=function(e){const t=h([],l,e.globalMatrix);h(t,n.expandedFarZProjMatrix,t);for(let i=0;i<e.meshes.length;++i){const r=e.meshes[i];if(i===e.lightMeshIndex)continue;const s=Xf(m,n,t,r.aabb);null!=s&&(o=Math.min(s,o))}if(e.children)for(const t of e.children)g(t)};if(g(s),o===Number.MAX_VALUE)return;const _=new rc(0,0);return Uv(a.tileID.canonical,_,r.node.anchor[0],r.node.anchor[1]),{intersectionZ:o,position:_,feature:r.feature}}const Vv={circle:class extends aa{constructor(e,t,i,n){super(e,{layout:Eu||(Eu=new Ns({"circle-sort-key":new Bs(ks.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Ds(ks.layout_circle["circle-elevation-reference"]),visibility:new Ds(ks.layout_circle.visibility)})),paint:Su||(Su=new Ns({"circle-radius":new Bs(ks.paint_circle["circle-radius"]),"circle-color":new Bs(ks.paint_circle["circle-color"]),"circle-blur":new Bs(ks.paint_circle["circle-blur"]),"circle-opacity":new Bs(ks.paint_circle["circle-opacity"]),"circle-translate":new Ds(ks.paint_circle["circle-translate"]),"circle-translate-anchor":new Ds(ks.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ds(ks.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ds(ks.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Bs(ks.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Bs(ks.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Bs(ks.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Ds(ks.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n)}createBucket(e){return new nu(e)}queryRadius(e){const t=e;return xu("circle-radius",this,t)+xu("circle-stroke-width",this,t)+bu(this.paint.get("circle-translate"))}queryIntersectsFeature(e,t,i,n,r,o,s,a){const l=wu(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),c=this.paint.get("circle-radius").evaluate(t,i)+this.paint.get("circle-stroke-width").evaluate(t,i);return ch(e,n,o,s,a,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),l,c)}getProgramIds(){return["circle"]}getDefaultProgramParams(e,t,i){const n=lh(this);return{config:new Ul(this,{zoom:t,lut:i}),defines:n,overrideFog:!1}}is3D(e){return!e&&!!this.layout&&"none"!==this.layout.get("circle-elevation-reference")}hasElevation(){return this.layout&&"none"!==this.layout.get("circle-elevation-reference")}},heatmap:class extends aa{createBucket(e){return new fh(e)}constructor(e,t,i,n){super(e,{layout:mh||(mh=new Ns({visibility:new Ds(ks.layout_heatmap.visibility)})),paint:gh||(gh=new Ns({"heatmap-radius":new Bs(ks.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Bs(ks.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ds(ks.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Fs(ks.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ds(ks.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){"heatmap-color"===e&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Sh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(e){return xu("heatmap-radius",this,e)}queryIntersectsFeature(e,t,i,n,r,o,s,a){const l=this.paint.get("heatmap-radius").evaluate(t,i);return ch(e,n,o,s,a,!0,!0,new Ee(0,0),l)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(e,t,i){return"heatmap"===e?{config:new Ul(this,{zoom:t,lut:i}),overrideFog:!1}:{}}},hillshade:class extends aa{constructor(e,t,i,n){super(e,{layout:_h||(_h=new Ns({visibility:new Ds(ks.layout_hillshade.visibility)})),paint:yh||(yh=new Ns({"hillshade-illumination-direction":new Ds(ks.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ds(ks.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ds(ks.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ds(ks.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ds(ks.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ds(ks.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Ds(ks.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(e,t,i){return{overrideFog:!1}}},fill:class extends aa{constructor(e,t,i,n){super(e,{layout:bd||(bd=new Ns({"fill-sort-key":new Bs(ks.layout_fill["fill-sort-key"]),visibility:new Ds(ks.layout_fill.visibility),"fill-elevation-reference":new Ds(ks.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Bs(ks.layout_fill["fill-construct-bridge-guard-rail"])})),paint:Td||(Td=new Ns({"fill-antialias":new Ds(ks.paint_fill["fill-antialias"]),"fill-opacity":new Bs(ks.paint_fill["fill-opacity"]),"fill-color":new Bs(ks.paint_fill["fill-color"]),"fill-outline-color":new Bs(ks.paint_fill["fill-outline-color"]),"fill-translate":new Ds(ks.paint_fill["fill-translate"]),"fill-translate-anchor":new Ds(ks.paint_fill["fill-translate-anchor"]),"fill-pattern":new Bs(ks.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new Ds(ks.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new Ds(ks.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Bs(ks.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Bs(ks.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Bs(ks.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n)}getProgramIds(){const e=this.paint.get("fill-pattern"),t=e&&e.constantOr(1),i=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(e,t,i){return{config:new Ul(this,{zoom:t,lut:i}),overrideFog:!1}}recalculate(e,t){super.recalculate(e,t);const i=this.paint._values["fill-outline-color"];"constant"===i.value.kind&&void 0===i.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new xd(e)}queryRadius(){return bu(this.paint.get("fill-translate"))}queryIntersectsFeature(e,t,i,n,r,o){return!e.queryGeometry.isAboveHorizon&&su(Tu(e.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),n)}isTileClipped(){return 0===this.paint.get("fill-z-offset").constantOr(1)}is3D(e){if(0!==this.paint.get("fill-z-offset").constantOr(1))return!0;const t=this.layout&&"none"!==this.layout.get("fill-elevation-reference");return null!=e?t&&!e:t}hasElevation(){return this.layout&&"none"!==this.layout.get("fill-elevation-reference")}hasShadowPass(){return this.layout&&"none"!==this.layout.get("fill-elevation-reference")}},"fill-extrusion":class extends aa{constructor(e,t,i,n){super(e,{layout:Ip||(Ip=new Ns({visibility:new Ds(ks["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Ds(ks["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:Cp||(Cp=new Ns({"fill-extrusion-opacity":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Bs(ks["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Bs(ks["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new Bs(ks["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Bs(ks["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Bs(ks["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Bs(ks["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Bs(ks["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Bs(ks["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Ds(ks["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(e){return new _p(e)}queryRadius(){return bu(this.paint.get("fill-extrusion-translate"))}is3D(e){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(e,t,i,n,r,o,s,a,l){const c=wu(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),u=this.paint.get("fill-extrusion-height").evaluate(t,i),h=this.paint.get("fill-extrusion-base").evaluate(t,i),d=[0,0],p=a&&o.elevation,f=o.elevation?o.elevation.exaggeration():1,m=e.tile.getBucket(this);if(p&&m instanceof _p){const e=m.centroidVertexArray,t=l+1;t<e.length&&(d[0]=e.geta_centroid_pos0(t),d[1]=e.geta_centroid_pos1(t))}if(0===d[0]&&1===d[1])return!1;"globe"===o.projection.name&&(n=Ap([n],[new Ee(0,0),new Ee(zn,zn)],e.tileID.canonical).map((e=>e.polygon)).flat());const g=p?a:null,[_,y]=zp(o,n,h,u,c,s,g,d,f,o.center.lat,e.tileID.canonical),v=e.queryGeometry;return Up(_,y,v.isPointQuery()?v.screenBounds:v.screenGeometry)}},building:class extends aa{constructor(e,t,i,n){super(e,{layout:Lm||(Lm=new Ns({visibility:new Ds(ks.layout_building.visibility),"building-facade":new Bs(ks.layout_building["building-facade"]),"building-facade-floors":new Bs(ks.layout_building["building-facade-floors"]),"building-facade-unit-width":new Bs(ks.layout_building["building-facade-unit-width"]),"building-facade-window":new Bs(ks.layout_building["building-facade-window"]),"building-roof-shape":new Bs(ks.layout_building["building-roof-shape"]),"building-height":new Bs(ks.layout_building["building-height"]),"building-base":new Bs(ks.layout_building["building-base"]),"building-flood-light-wall-radius":new Bs(ks.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new Bs(ks.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new Bs(ks.layout_building["building-flip-roof-orientation"])})),paint:Rm||(Rm=new Ns({"building-opacity":new Ds(ks.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new Ds(ks.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new Ds(ks.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new Ds(ks.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new Ds(ks.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new Ds(ks.paint_building["building-vertical-scale"]),"building-cast-shadows":new Ds(ks.paint_building["building-cast-shadows"]),"building-color":new Bs(ks.paint_building["building-color"]),"building-emissive-strength":new Bs(ks.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new Ds(ks.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new Ds(ks.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new Ds(ks.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new Ds(ks.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new Ds(ks.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(e){return new Cm(e)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(e){return!0}queryRadius(e){return 0}queryIntersectsFeature(e,t,i,n,r,o,s,a,l){let c=this.layout.get("building-height").evaluate(t,i);const u=this.layout.get("building-base").evaluate(t,i),h=e.tile.getBucket(this).getFootprint(t);if(h){if(0!==h.hiddenFlags)return!1;c=h.height}const[d,p]=zp(o,n,u,c,new Ee(0,0),s,null,[0,0],1,o.center.lat,e.tileID.canonical),f=e.queryGeometry;return Up(d,p,f.isPointQuery()?f.screenBounds:f.screenGeometry)}},line:class extends aa{constructor(e,t,i,n){const r=tg();super(e,r,t,i,n),r.layout&&(this.layout=new Os(r.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(e){if("line-gradient"===e){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Ir,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(e,t){super.recalculate(e,t),this.paint._values["line-floorwidth"]=(()=>{if(ng)return ng;const e=tg();return ng=new ig(e.paint.properties["line-width"].specification),ng.useIntegerZoom=!0,ng})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new Hm(e)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(e,t,i){const n=Km(this);return{config:new Ul(this,{zoom:t,lut:i}),defines:n,overrideFog:!1}}queryRadius(e){const t=e,i=rg(xu("line-width",this,t),xu("line-gap-width",this,t)),n=xu("line-offset",this,t);return i/2+Math.abs(n)+bu(this.paint.get("line-translate"))}queryIntersectsFeature(e,t,i,n,r,o){if(e.queryGeometry.isAboveHorizon)return!1;const s=Tu(e.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),a=e.pixelToTileUnitsFactor/2*rg(this.paint.get("line-width").evaluate(t,i),this.paint.get("line-gap-width").evaluate(t,i)),l=this.paint.get("line-offset").evaluate(t,i);return l&&(n=function(e,t){const i=[],n=new Ee(0,0);for(let r=0;r<e.length;r++){const o=e[r],s=[];for(let e=0;e<o.length;e++){const i=o[e],r=o[e+1],a=0===e?n:i.sub(o[e-1])._unit()._perp(),l=e===o.length-1?n:r.sub(i)._unit()._perp(),c=a._add(l)._unit();c._mult(1/(c.x*l.x+c.y*l.y)),s.push(c._mult(t)._add(i))}i.push(s)}return i}(n,l*e.pixelToTileUnitsFactor)),function(e,t,i){for(let n=0;n<t.length;n++){const r=t[n];if(e.length>=3)for(let t=0;t<r.length;t++)if(mu(e,r[t]))return!0;if(au(e,r,i))return!0}return!1}(s,n,a)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(e){return!this.hasElevatedBuckets||this.layout&&"hd-road-markup"===this.layout.get("line-elevation-reference")}hasElevation(){return this.layout&&"none"!==this.layout.get("line-elevation-reference")}},symbol:Jy,background:class extends aa{constructor(e,t,i,n){super(e,{layout:Ky||(Ky=new Ns({visibility:new Ds(ks.layout_background.visibility)})),paint:Qy||(Qy=new Ns({"background-pitch-alignment":new Ds(ks.paint_background["background-pitch-alignment"]),"background-color":new Ds(ks.paint_background["background-color"]),"background-pattern":new Ds(ks.paint_background["background-pattern"]),"background-opacity":new Ds(ks.paint_background["background-opacity"]),"background-emissive-strength":new Ds(ks.paint_background["background-emissive-strength"]),"background-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(e,t,i){return{overrideFog:!1}}is3D(e){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:lv,"raster-particle":fv,sky:class extends aa{constructor(e,t,i,n){super(e,{layout:hv||(hv=new Ns({visibility:new Ds(ks.layout_sky.visibility)})),paint:dv||(dv=new Ns({"sky-type":new Ds(ks.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ds(ks.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ds(ks.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ds(ks.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ds(ks.paint_sky["sky-gradient-radius"]),"sky-gradient":new Fs(ks.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ds(ks.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ds(ks.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ds(ks.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(e){"sky-gradient"===e?this._updateColorRamp():"sky-atmosphere-sun"!==e&&"sky-atmosphere-halo-color"!==e&&"sky-atmosphere-color"!==e&&"sky-atmosphere-sun-intensity"!==e||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Sh({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(e){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=e.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(e,t){if("atmosphere"===this.paint.get("sky-type")){const i=this.paint.get("sky-atmosphere-sun"),n=!i,r=e.style.light,o=r.properties.get("position");return n&&"viewport"===r.properties.get("anchor")&&qe("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),n?gv(o.azimuthal,90-o.polar,t):gv(i[0],90-i[1],t)}const i=this.paint.get("sky-gradient-center");return gv(i[0],90-i[1],t)}isSky(){return!0}markSkyboxValid(e){this._skyboxInvalidated=!1,this._lightPosition=e.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const e=this.paint.get("sky-type");return"atmosphere"===e?["skyboxCapture","skybox"]:"gradient"===e?["skyboxGradient"]:null}},slot:class extends aa{constructor(e,t,i,n){super(e,{paint:pv||(pv=new Ns({}))},t,null)}},model:class extends aa{constructor(e,t,i,n){super(e,{layout:wv||(wv=new Ns({visibility:new Ds(ks.layout_model.visibility),"model-id":new Bs(ks.layout_model["model-id"])})),paint:Ev||(Ev=new Ns({"model-opacity":new Bs(ks.paint_model["model-opacity"]),"model-rotation":new Bs(ks.paint_model["model-rotation"]),"model-scale":new Bs(ks.paint_model["model-scale"]),"model-translation":new Bs(ks.paint_model["model-translation"]),"model-color":new Bs(ks.paint_model["model-color"]),"model-color-mix-intensity":new Bs(ks.paint_model["model-color-mix-intensity"]),"model-type":new Ds(ks.paint_model["model-type"]),"model-cast-shadows":new Ds(ks.paint_model["model-cast-shadows"]),"model-receive-shadows":new Ds(ks.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Ds(ks.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Bs(ks.paint_model["model-emissive-strength"]),"model-roughness":new Bs(ks.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Bs(ks.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Ds(ks.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Ds(ks.paint_model["model-front-cutoff"]),"model-elevation-reference":new Ds(ks.paint_model["model-elevation-reference"]),"model-color-use-theme":new Bs({type:"string",default:"default","property-type":"data-driven"})}))},t,i,n),this.layer=e,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(e){return new Tv(e)}getProgramIds(){return["model"]}is3D(e){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(e){return e instanceof Rv?zn-1:0}queryRenderedFeatures(e,t,i){const n=t.getSource();if(!(n&&n instanceof kv))return{};const r=n,o={};o[this.id]=[];const s=o[this.id];let a=0;for(const n of r.models){const r=t.getFeatureState(this.sourceLayer,n.id),o={type:"Unknown",id:n.id,properties:n.featureProperties},l=this.paint.get("model-rotation").evaluate(o,r),c=this.paint.get("model-scale").evaluate(o,r),u=this.paint.get("model-translation").evaluate(o,r),d=this.paint.get("model-elevation-reference");let p=[];Jf(p,n,i,n.position,l,c,u,"ground"===d,"ground"===d,!1),"globe"===i.projection.name&&(p=qf(p,i));const f=h([],i.projMatrix,p),m=Xf(e.isPointQuery()?e.screenBounds:e.screenGeometry,i,f,n.aabb);if(null!=m){const e=new Nv(void 0,0,0,0,n.id);e.layer=this.layer,e.properties=structuredClone(n.featureProperties),e.properties.layer=this.id,e.properties.uri=n.uri,e.properties.orientation=n.orientation,e.sourceLayer=this.sourceLayer,e.geometry={type:"Point",coordinates:[n.position.lng,n.position.lat]},e.state=r,e.source=this.source,s.push({featureIndex:a,feature:e,intersectionZ:m})}++a}return o}queryIntersectsFeature(e,t,i,n,r,o){if(!this.modelManager)return!1;const s=this.modelManager,a=e.tile.getBucket(this);if(!(a&&a instanceof Tv))return!1;for(const i in a.instancesPerModel){const n=a.instancesPerModel[i],r=void 0!==t.id?t.id:t.properties&&t.properties.hasOwnProperty("id")?t.properties.id:void 0;if(n.idToFeaturesIndex.hasOwnProperty(r)){const t=n.features[n.idToFeaturesIndex[r]],l=s.getModel(i,this.scope);if(!l)return!1;let c=[];const u=new rc(0,0),d=a.canonical;let p=Number.MAX_VALUE;for(let i=0;i<t.instancedDataCount;++i){const r=16*(t.instancedDataOffset+i),s=n.instancedDataArray.float32,a=[s[r+4],s[r+5],s[r+6]];Uv(d,u,Math.floor(s[r]),Math.floor(s[r+1])),Jf(c,l,o,u,t.rotation,t.scale,a,!1,!1,!1),"globe"===o.projection.name&&(c=qf(c,o));const f=h([],o.projMatrix,c),m=e.queryGeometry,g=Xf(m.isPointQuery()?m.screenBounds:m.screenGeometry,o,f,l.aabb);null!=g&&(p=Math.min(g,p))}return p!==Number.MAX_VALUE&&p}}return!1}_handleOverridablePaintPropertyUpdate(e,t,i){return!(!this.layout||t.isDataDriven()||i.isDataDriven()||"model-color"!==e&&"model-color-mix-intensity"!==e&&"model-rotation"!==e&&"model-scale"!==e&&"model-translation"!==e&&"model-emissive-strength"!==e)}_isPropertyZoomDependent(e){const t=this._transitionablePaint._values[e];return null!=t&&null!=t.value&&null!=t.value.expression&&t.value.expression instanceof $o}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends aa{constructor(e,t,i,n){super(e,{layout:wd||(wd=new Ns({"clip-layer-types":new Ds(ks.layout_clip["clip-layer-types"]),"clip-layer-scope":new Ds(ks.layout_clip["clip-layer-scope"])})),paint:Ed||(Ed=new Ns({}))},t,i,n)}recalculate(e,t){super.recalculate(e,t)}createBucket(e){return new Md(e)}is3D(e){return!0}}},Gv=new li(0,0,0),jv={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},Hv={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},$v={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},Wv={PAINT_ORDER_FILL_AND_STROKE:1},qv={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},Xv={MASK_TYPE_LUMINANCE:1};function Yv(e,t,i){1===e&&t.icons.push(function(e,t){return function(e){if(e.usvg_tree.height||(e.usvg_tree.height=e.usvg_tree.width),!e.metadata)return e;const{metadata:t}=e;if(t.content_area){const{content_area:i}=t;null==i.left&&(i.left=0),null==i.top&&(i.top=i.left),null==i.width&&(i.width=e.usvg_tree.width),null==i.height&&(i.height=i.width)}if(t.text_placeholder){const{text_placeholder:e}=t;null==e.top&&(e.top=e.left),null==e.height&&(e.height=e.width)}return t.stretch_x&&t.stretch_x.length&&Zv(t,"x"),t.stretch_y&&t.stretch_y.length&&Zv(t,"y"),e}(e.readFields(Jv,{name:void 0},t))}(i,i.readVarint()+i.pos))}function Zv(e,t){const i=[],n=e[`stretch_${t}`];let r=null;for(let e=0;e<n.length;e++)null===r?r=0===i.length?n[0]:i[i.length-1][1]+n[e]:(i.push([r,r+n[e]]),r=null);e[`stretch_${t}_areas`]=i}function Jv(e,t,i){1===e?t.name=i.readString():2===e?t.metadata=function(e,t){return e.readFields(Kv,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},t)}(i,i.readVarint()+i.pos):3===e&&(t.usvg_tree=function(e,t){return e.readFields(ix,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},t)}(i,i.readVarint()+i.pos),t.data="usvg_tree")}function Kv(e,t,i){1===e?t.stretch_x=i.readPackedVarint():2===e?t.stretch_y=i.readPackedVarint():3===e?t.content_area=Qv(i,i.readVarint()+i.pos):4===e?t.variables.push(function(e,t){return e.readFields(tx,{name:void 0},t)}(i,i.readVarint()+i.pos)):5===e&&(t.text_placeholder=Qv(i,i.readVarint()+i.pos))}function Qv(e,t){return e.readFields(ex,{},t)}function ex(e,t,i){1===e?t.left=i.readVarint():2===e?t.width=i.readVarint():3===e?t.top=i.readVarint():4===e&&(t.height=i.readVarint())}function tx(e,t,i){1===e?t.name=i.readString():2===e&&(t.rgb_color=ux(i.readVarint()),t.value="rgb_color")}function ix(e,t,i){1===e?t.width=t.height=i.readVarint():2===e?t.height=i.readVarint():3===e?t.children.push(nx(i,i.readVarint()+i.pos)):4===e?t.linear_gradients.push(function(e,t){return e.readFields(dx,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},t)}(i,i.readVarint()+i.pos)):5===e?t.radial_gradients.push(function(e,t){return e.readFields(mx,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},t)}(i,i.readVarint()+i.pos)):7===e?t.clip_paths.push(function(e,t){return e.readFields(gx,{children:[]},t)}(i,i.readVarint()+i.pos)):8===e&&t.masks.push(function(e,t){const i=e.readFields(_x,{left:0,width:20,mask_type:Xv.MASK_TYPE_LUMINANCE,children:[]},t);return null==i.height&&(i.height=i.width),null==i.top&&(i.top=i.left),i}(i,i.readVarint()+i.pos))}function nx(e,t){return e.readFields(rx,{},t)}function rx(e,t,i){1===e?(t.group=function(e,t){return e.readFields(ox,{opacity:255,children:[]},t)}(i,i.readVarint()+i.pos),t.node="group"):2===e&&(t.path=function(e,t){return e.readFields(lx,{paint_order:1,commands:[],step:1,diffs:[],rule:jv.PATH_RULE_NON_ZERO},t)}(i,i.readVarint()+i.pos),t.node="path")}function ox(e,t,i){1===e?t.transform=sx(i,i.readVarint()+i.pos):2===e?t.opacity=i.readVarint():5===e?t.clip_path_idx=i.readVarint():6===e?t.mask_idx=i.readVarint():7===e&&t.children.push(nx(i,i.readVarint()+i.pos))}function sx(e,t){return e.readFields(ax,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},t)}function ax(e,t,i){1===e?t.sx=i.readFloat():2===e?t.ky=i.readFloat():3===e?t.kx=i.readFloat():4===e?t.sy=i.readFloat():5===e?t.tx=i.readFloat():6===e&&(t.ty=i.readFloat())}function lx(e,t,i){1===e?t.fill=function(e,t){return e.readFields(cx,{rgb_color:Gv,paint:"rgb_color",opacity:255},t)}(i,i.readVarint()+i.pos):2===e?t.stroke=function(e,t){return e.readFields(hx,{rgb_color:Gv,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},t)}(i,i.readVarint()+i.pos):3===e?t.paint_order=i.readVarint():5===e?i.readPackedVarint(t.commands):6===e?t.step=i.readFloat():7===e?i.readPackedSVarint(t.diffs):8===e&&(t.rule=i.readVarint())}function cx(e,t,i){1===e?(t.rgb_color=ux(i.readVarint()),t.paint="rgb_color"):2===e?(t.linear_gradient_idx=i.readVarint(),t.paint="linear_gradient_idx"):3===e?(t.radial_gradient_idx=i.readVarint(),t.paint="radial_gradient_idx"):5===e&&(t.opacity=i.readVarint())}function ux(e){return new li((e>>16&255)/255,(e>>8&255)/255,(255&e)/255,1)}function hx(e,t,i){1===e?(t.rgb_color=ux(i.readVarint()),t.paint="rgb_color"):2===e?(t.linear_gradient_idx=i.readVarint(),t.paint="linear_gradient_idx"):3===e?(t.radial_gradient_idx=i.readVarint(),t.paint="radial_gradient_idx"):5===e?i.readPackedFloat(t.dasharray):6===e?t.dashoffset=i.readFloat():7===e?t.miterlimit=i.readFloat():8===e?t.opacity=i.readVarint():9===e?t.width=i.readFloat():10===e?t.linecap=i.readVarint():11===e&&(t.linejoin=i.readVarint())}function dx(e,t,i){1===e?t.transform=sx(i,i.readVarint()+i.pos):2===e?t.spread_method=i.readVarint():3===e?t.stops.push(px(i,i.readVarint()+i.pos)):4===e?t.x1=i.readFloat():5===e?t.y1=i.readFloat():6===e?t.x2=i.readFloat():7===e&&(t.y2=i.readFloat())}function px(e,t){return e.readFields(fx,{offset:0,opacity:255,rgb_color:Gv},t)}function fx(e,t,i){1===e?t.offset=i.readFloat():2===e?t.opacity=i.readVarint():3===e&&(t.rgb_color=ux(i.readVarint()))}function mx(e,t,i){1===e?t.transform=sx(i,i.readVarint()+i.pos):2===e?t.spread_method=i.readVarint():3===e?t.stops.push(px(i,i.readVarint()+i.pos)):4===e?t.cx=i.readFloat():5===e?t.cy=i.readFloat():6===e?t.r=i.readFloat():7===e?t.fx=i.readFloat():8===e?t.fy=i.readFloat():9===e&&(t.fr=i.readFloat())}function gx(e,t,i){1===e?t.transform=sx(i,i.readVarint()+i.pos):2===e?t.clip_path_idx=i.readVarint():3===e&&t.children.push(nx(i,i.readVarint()+i.pos))}function _x(e,t,i){1===e?t.left=t.top=i.readFloat():2===e?t.width=t.height=i.readFloat():3===e?t.top=i.readFloat():4===e?t.height=i.readFloat():5===e?t.mask_type=i.readVarint():6===e?t.mask_idx=i.readVarint():7===e&&t.children.push(nx(i,i.readVarint()+i.pos))}class yx{static calculate(e={},t=[]){const i=new Map,n=new Map;if(0===Object.keys(e).length)return i;t.forEach((e=>{n.set(e.name,e.rgb_color||new li(0,0,0))}));for(const[t,r]of Object.entries(e))n.has(t)&&i.set(n.get(t).toString(),r);return i}}function vx(e,t=255,i){const n=t/255,r=e.toString(),o=i.has(r)?i.get(r).clone():e.clone();return o.a*=n,o.toString()}function xx(e,t){if(!mt()){const i=document.createElement("canvas");return i.width=e,i.height=t,i}return new OffscreenCanvas(e,t)}function bx(e,t){const i=yx.calculate(t.params,e.metadata?e.metadata.variables:[]),n=e.usvg_tree,r=n.width,o=n.height,s=t.transform?t.transform:new DOMMatrix,a=Math.max(1,Math.round(r*s.a)),l=Math.max(1,Math.round(o*s.d)),c=new DOMMatrix([a/r,0,0,l/o,0,0]),u=xx(a,l).getContext("2d");return Tx(u,c,n,n,i),u.getImageData(0,0,a,l)}function Tx(e,t,i,n,r){for(const o of n.children)wx(e,t,i,o,r)}function wx(e,t,i,n,r){n.group?(e.save(),function(e,t,i,n,r){const o=null!=n.mask_idx?i.masks[n.mask_idx]:null,s=null!=n.clip_path_idx?i.clip_paths[n.clip_path_idx]:null;if(n.transform&&(t=Rx(n.transform).preMultiplySelf(t)),!function(e,t,i){return 255!==e.opacity||t||i}(n,null!=s,null!=o))return void Tx(e,t,i,n,r);const a=xx(e.canvas.width,e.canvas.height),l=a.getContext("2d");Tx(l,t,i,n,r),s&&Px(l,t,i,s),o&&Lx(l,t,i,o,r),e.globalAlpha=n.opacity/255,e.drawImage(a,0,0)}(e,t,i,n.group,r),e.restore()):n.path&&(e.save(),function(e,t,i,n,r){e.setTransform(t),n.paint_order===Wv.PAINT_ORDER_FILL_AND_STROKE?(Ex(e,i,n,r),Ax(e,i,n,r)):(Ax(e,i,n,r),Ex(e,i,n,r))}(e,t,i,n.path,r),e.restore())}function Ex(e,t,i,n){const r=i.fill;if(!r)return;const o=r.opacity/255;switch(e.save(),e.beginPath(),Ox(i,e),r.paint){case"rgb_color":e.fillStyle=vx(r.rgb_color,r.opacity,n);break;case"linear_gradient_idx":{const i=t.linear_gradients[r.linear_gradient_idx];i.transform&&e.setTransform(Rx(i.transform).preMultiplySelf(e.getTransform())),e.fillStyle=Mx(e,i,o,n);break}case"radial_gradient_idx":{const i=t.radial_gradients[r.radial_gradient_idx];i.transform&&e.setTransform(Rx(i.transform).preMultiplySelf(e.getTransform())),e.fillStyle=Ix(e,i,o,n)}}e.fill(Sx(i)),e.restore()}function Sx(e){return e.rule===jv.PATH_RULE_NON_ZERO?"nonzero":e.rule===jv.PATH_RULE_EVEN_ODD?"evenodd":void 0}function Ax(e,t,i,n){const r=i.stroke;if(!r)return;const o=Dx(i);e.lineWidth=r.width,e.miterLimit=r.miterlimit,e.setLineDash(r.dasharray),e.lineDashOffset=r.dashoffset;const s=r.opacity/255;switch(r.paint){case"rgb_color":e.strokeStyle=vx(r.rgb_color,r.opacity,n);break;case"linear_gradient_idx":e.strokeStyle=Mx(e,t.linear_gradients[r.linear_gradient_idx],s,n,!0);break;case"radial_gradient_idx":e.strokeStyle=Ix(e,t.radial_gradients[r.radial_gradient_idx],s,n,!0)}switch(r.linejoin){case $v.LINE_JOIN_MITER_CLIP:case $v.LINE_JOIN_MITER:e.lineJoin="miter";break;case $v.LINE_JOIN_ROUND:e.lineJoin="round";break;case $v.LINE_JOIN_BEVEL:e.lineJoin="bevel"}switch(r.linecap){case Hv.LINE_CAP_BUTT:e.lineCap="butt";break;case Hv.LINE_CAP_ROUND:e.lineCap="round";break;case Hv.LINE_CAP_SQUARE:e.lineCap="square"}e.stroke(o)}function Mx(e,t,i,n,r=!1){if(1===t.stops.length){const e=t.stops[0];return vx(e.rgb_color,e.opacity*i,n)}const{x1:o,y1:s,x2:a,y2:l}=t;let c=new DOMPoint(o,s),u=new DOMPoint(a,l);if(r){const e=Rx(t.transform);c=e.transformPoint(c),u=e.transformPoint(u)}const h=e.createLinearGradient(c.x,c.y,u.x,u.y);for(const e of t.stops)h.addColorStop(e.offset,vx(e.rgb_color,e.opacity*i,n));return h}function Ix(e,t,i,n,r=!1){if(1===t.stops.length){const e=t.stops[0];return vx(e.rgb_color,e.opacity*i,n)}const o=Rx(t.transform),{fx:s,fy:a,fr:l,cx:c,cy:u,r:h}=t;let d=new DOMPoint(s,a),p=new DOMPoint(c,u),f=l,m=h;if(r){d=o.transformPoint(d),p=o.transformPoint(p);const e=(o.a+o.d)/2;f=l*e,m=t.r*e}const g=e.createRadialGradient(d.x,d.y,f,p.x,p.y,m);for(const e of t.stops)g.addColorStop(e.offset,vx(e.rgb_color,e.opacity*i,n));return g}function Cx(e,t,i,n){const r=n.transform?Rx(n.transform).preMultiplySelf(t):t,o=xx(e.canvas.width,e.canvas.height),s=o.getContext("2d");for(const e of n.children)if(e.group)Cx(s,r,i,e.group);else if(e.path){const t=e.path,i=new Path2D;i.addPath(Dx(t),r),s.fill(i,Sx(t))}const a=null!=n.clip_path_idx?i.clip_paths[n.clip_path_idx]:null;a&&Px(s,r,i,a),e.globalCompositeOperation="source-over",e.drawImage(o,0,0)}function Px(e,t,i,n){const r=xx(e.canvas.width,e.canvas.height);Cx(r.getContext("2d"),t,i,n),e.globalCompositeOperation="destination-in",e.drawImage(r,0,0)}function Lx(e,t,i,n,r){if(0===n.children.length)return;const o=null!=n.mask_idx?i.masks[n.mask_idx]:null;o&&Lx(e,t,i,o,r);const s=e.canvas.width,a=e.canvas.height,l=xx(s,a),c=l.getContext("2d"),u=n.width,h=n.height,d=n.left,p=n.top,f=new Path2D,m=new Path2D;m.rect(d,p,u,h),f.addPath(m,t),c.clip(f);for(const e of n.children)wx(c,t,i,e,r);const g=c.getImageData(0,0,s,a),_=g.data;if(n.mask_type===Xv.MASK_TYPE_LUMINANCE)for(let e=0;e<_.length;e+=4)_[e+3]=_[e+3]/255*(.2126*_[e]+.7152*_[e+1]+.0722*_[e+2]);c.putImageData(g,0,0),e.globalCompositeOperation="destination-in",e.drawImage(l,0,0)}function Rx(e){return e?new DOMMatrix([e.sx,e.ky,e.kx,e.sy,e.tx,e.ty]):new DOMMatrix}function Ox(e,t){const i=e.step;let n=e.diffs[0]*i,r=e.diffs[1]*i;t.moveTo(n,r);for(let o=0,s=2;o<e.commands.length;o++)switch(e.commands[o]){case qv.PATH_COMMAND_MOVE:n+=e.diffs[s++]*i,r+=e.diffs[s++]*i,t.moveTo(n,r);break;case qv.PATH_COMMAND_LINE:n+=e.diffs[s++]*i,r+=e.diffs[s++]*i,t.lineTo(n,r);break;case qv.PATH_COMMAND_QUAD:{const o=n+e.diffs[s++]*i,a=r+e.diffs[s++]*i;n=o+e.diffs[s++]*i,r=a+e.diffs[s++]*i,t.quadraticCurveTo(o,a,n,r);break}case qv.PATH_COMMAND_CUBIC:{const o=n+e.diffs[s++]*i,a=r+e.diffs[s++]*i,l=o+e.diffs[s++]*i,c=a+e.diffs[s++]*i;n=l+e.diffs[s++]*i,r=c+e.diffs[s++]*i,t.bezierCurveTo(o,a,l,c,n,r);break}case qv.PATH_COMMAND_CLOSE:t.closePath()}return t}function Dx(e){return Ox(e,new Path2D)}class Bx{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}put(e,t){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,t)}delete(e){this.cache.delete(e)}}es(Bx,"LRUCache");class Fx{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new wh(e,e.data)}getFromCache(e,t,i){return this.cacheMap.has(i)||this.cacheMap.set(i,new Bx(150)),this.cacheMap.get(i).get(ta(e.toString(),t))}setInCache(e,t,i,n){this.cacheDependenciesMap.has(n)||this.cacheDependenciesMap.set(n,new Map),this.cacheMap.has(n)||this.cacheMap.set(n,new Bx(150));const r=this.cacheDependenciesMap.get(n),o=ta(e.id.toString(),i);r.get(o)||r.set(o,new Set);const s=this.cacheMap.get(n),a=e.toString();r.get(o).add(a),s.put(ta(e.toString(),i),t)}removeImagesFromCacheByIds(e,t,i=0){if(!this.cacheMap.has(i)||!this.cacheDependenciesMap.has(i))return;const n=this.cacheMap.get(i),r=this.cacheDependenciesMap.get(i);for(const i of e){const e=ta(i.toString(),t);if(r.has(e)){for(const t of r.get(e))n.delete(t);r.delete(e)}}}rasterize(e,t,i,n,r=bx){const o=this.getFromCache(e,i,n);if(o)return o.clone();const s=r(t.icon,e.options),a=Fx._getImage(s);return this.setInCache(e,a,i,n),a.clone()}}class Nx{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,t){const i=this.toIdx(e,t);return{min:this.minimums[i],max:this.maximums[i]}}isLeaf(e,t){return this.leaves[this.toIdx(e,t)]}toIdx(e,t){return t*this.size+e}}function kx(e,t,i,n){let r=0,o=Number.MAX_VALUE;for(let s=0;s<3;s++)if(Math.abs(n[s])<1e-15){if(i[s]<e[s]||i[s]>t[s])return null}else{const a=1/n[s];let l=(e[s]-i[s])*a,c=(t[s]-i[s])*a;if(l>c){const e=l;l=c,c=e}if(l>r&&(r=l),c<o&&(o=c),r>o)return null}return r}function Ux(e,t,i,n,r,o,s,a,l,c,u){const h=n-e,d=r-t,p=o-i,f=s-e,m=a-t,g=l-i,_=u[1]*g-u[2]*m,y=u[2]*f-u[0]*g,v=u[0]*m-u[1]*f,x=h*_+d*y+p*v;if(Math.abs(x)<1e-15)return null;const b=1/x,T=c[0]-e,w=c[1]-t,E=c[2]-i,S=(T*_+w*y+E*v)*b;if(S<0||S>1)return null;const A=w*p-E*d,M=E*h-T*p,I=T*d-w*h,C=(u[0]*A+u[1]*M+u[2]*I)*b;return C<0||S+C>1?null:(f*A+m*M+g*I)*b}function zx(e,t,i){return(e-t)/(i-t)}function Vx(e,t,i,n,r,o,s,a,l){const c=1<<i,u=o-n,h=s-r,d=(e+1)/c*u+n,p=(t+0)/c*h+r,f=(t+1)/c*h+r;a[0]=(e+0)/c*u+n,a[1]=p,l[0]=d,l[1]=f}class Gx{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const t=function(e){const t=Math.ceil(Math.log2(e.dim/8)),i=[];let n=Math.ceil(Math.pow(2,t));const r=1/n,o=(e,t,i,n,r)=>{const o=n?1:0,s=(e+1)*i-o,a=t*i,l=(t+1)*i-o;r[0]=e*i,r[1]=a,r[2]=s,r[3]=l};let s=new Nx(n);const a=[];for(let t=0;t<n*n;t++){o(t%n,Math.floor(t/n),r,!1,a);const i=Hx(a[0],a[1],e),l=Hx(a[2],a[1],e),c=Hx(a[2],a[3],e),u=Hx(a[0],a[3],e);s.minimums.push(Math.min(i,l,c,u)),s.maximums.push(Math.max(i,l,c,u)),s.leaves.push(1)}for(i.push(s),n/=2;n>=1;n/=2){const e=i[i.length-1];s=new Nx(n);for(let t=0;t<n*n;t++){o(t%n,Math.floor(t/n),2,!0,a);const i=e.getElevation(a[0],a[1]),r=e.getElevation(a[2],a[1]),l=e.getElevation(a[2],a[3]),c=e.getElevation(a[0],a[3]),u=e.isLeaf(a[0],a[1]),h=e.isLeaf(a[2],a[1]),d=e.isLeaf(a[2],a[3]),p=e.isLeaf(a[0],a[3]),f=Math.min(i.min,r.min,l.min,c.min),m=Math.max(i.max,r.max,l.max,c.max),g=u&&h&&d&&p;s.maximums.push(m),s.minimums.push(f),s.leaves.push(m-f<=5&&g?1:0)}i.push(s)}return i}(this.dem),i=t.length-1,n=t[i];this._addNode(n.minimums[0],n.maximums[0],n.leaves[0]),this._construct(t,0,0,i,0)}raycastRoot(e,t,i,n,r,o,s=1){return kx([e,t,-100],[i,n,this.maximums[0]*s],r,o)}raycast(e,t,i,n,r,o,s=1){if(!this.nodeCount)return null;const a=this.raycastRoot(e,t,i,n,r,o,s);if(null==a)return null;const l=[],c=[],u=[],h=[],d=[{idx:0,t:a,nodex:0,nodey:0,depth:0}];for(;d.length>0;){const{idx:a,t:p,nodex:f,nodey:m,depth:g}=d.pop();if(this.leaves[a]){Vx(f,m,g,e,t,i,n,u,h);const a=1<<g,l=(f+0)/a,c=(f+1)/a,d=(m+0)/a,_=(m+1)/a,y=Hx(l,d,this.dem)*s,v=Hx(c,d,this.dem)*s,x=Hx(c,_,this.dem)*s,b=Hx(l,_,this.dem)*s,T=Ux(u[0],u[1],y,h[0],u[1],v,h[0],h[1],x,r,o),w=Ux(h[0],h[1],x,u[0],h[1],b,u[0],u[1],y,r,o),E=Math.min(null!==T?T:Number.MAX_VALUE,null!==w?w:Number.MAX_VALUE);if(E!==Number.MAX_VALUE)return E;{const e=O([],r,o,p);if(jx(y,v,b,x,zx(e[0],u[0],h[0]),zx(e[1],u[1],h[1]))>=e[2])return p}continue}let _=0;for(let d=0;d<this._siblingOffset.length;d++){Vx((f<<1)+this._siblingOffset[d][0],(m<<1)+this._siblingOffset[d][1],g+1,e,t,i,n,u,h),u[2]=-100,h[2]=this.maximums[this.childOffsets[a]+d]*s;const p=kx(u,h,r,o);if(null!=p){const e=p;l[d]=e;let t=!1;for(let i=0;i<_&&!t;i++)e>=l[c[i]]&&(c.splice(i,0,d),t=!0);t||(c[_]=d),_++}}for(let e=0;e<_;e++){const t=c[e];d.push({idx:this.childOffsets[a]+t,t:l[t],nodex:(f<<1)+this._siblingOffset[t][0],nodey:(m<<1)+this._siblingOffset[t][1],depth:g+1})}}return null}_addNode(e,t,i){return this.minimums.push(e),this.maximums.push(t),this.leaves.push(i),this.childOffsets.push(0),this.nodeCount++}_construct(e,t,i,n,r){if(1===e[n].isLeaf(t,i))return;this.childOffsets[r]||(this.childOffsets[r]=this.nodeCount);const o=n-1,s=e[o];let a=0,l=0;for(let e=0;e<this._siblingOffset.length;e++){const n=2*t+this._siblingOffset[e][0],r=2*i+this._siblingOffset[e][1],o=s.getElevation(n,r),c=s.isLeaf(n,r),u=this._addNode(o.min,o.max,c);c&&(a|=1<<e),l||(l=u)}for(let n=0;n<this._siblingOffset.length;n++)a&1<<n||this._construct(e,2*t+this._siblingOffset[n][0],2*i+this._siblingOffset[n][1],o,l+n)}}function jx(e,t,i,n,r,o){return di(di(e,i,o),di(t,n,o),r)}function Hx(e,t,i){const n=i.dim,r=De(e*n-.5,0,n-1),o=De(t*n-.5,0,n-1),s=Math.floor(r),a=Math.floor(o),l=Math.min(s+1,n-1),c=Math.min(a+1,n-1);return jx(i.get(s,a),i.get(l,a),i.get(s,c),i.get(l,c),r-s,o-a)}const $x={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Wx(e,t,i){return(256*e*256+256*t+i)/10-1e4}function qx(e,t,i){return 256*e+t+i/256-32768}class Xx{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,t,i,n=!1){if(this.uid=e,t.height!==t.width)throw new RangeError("DEM tiles must be square");if(i&&"mapbox"!==i&&"terrarium"!==i)return void qe(`"${i}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=t.height;const r=this.dim=t.height-2,o=new Uint32Array(t.data.buffer);if(this.pixels=new Uint8Array(t.data.buffer),this.floatView=new Float32Array(t.data.buffer),this.borderReady=n,this._modifiedForSources={},!n){for(let e=0;e<r;e++)o[this._idx(-1,e)]=o[this._idx(0,e)],o[this._idx(r,e)]=o[this._idx(r-1,e)],o[this._idx(e,-1)]=o[this._idx(e,0)],o[this._idx(e,r)]=o[this._idx(e,r-1)];o[this._idx(-1,-1)]=o[this._idx(0,0)],o[this._idx(r,-1)]=o[this._idx(r-1,0)],o[this._idx(-1,r)]=o[this._idx(0,r-1)],o[this._idx(r,r)]=o[this._idx(r-1,r-1)]}const s="terrarium"===i?qx:Wx;for(let e=0;e<o.length;++e){const t=4*e;this.floatView[e]=s(this.pixels[t],this.pixels[t+1],this.pixels[t+2])}this._timestamp=gt.now()}_buildQuadTree(){this._tree=new Gx(this)}get(e,t,i=!1){i&&(e=De(e,-1,this.dim),t=De(t,-1,this.dim));const n=this._idx(e,t);return this.floatView[n]}set(e,t,i){const n=this._idx(e,t),r=this.floatView[n];return this.floatView[n]=i,i-r}static getUnpackVector(e){return $x[e]}_idx(e,t){if(e<-1||e>=this.dim+1||t<-1||t>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(t+1)*this.stride+(e+1)}static pack(e,t){const i=[0,0,0,0],n=Xx.getUnpackVector(t);let r=Math.floor((e+n[3])/n[2]);return i[2]=r%256,r=Math.floor(r/256),i[1]=r%256,r=Math.floor(r/256),i[0]=r,i}getPixels(){return new Eh({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,t,i){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let n=t*this.dim,r=t*this.dim+this.dim,o=i*this.dim,s=i*this.dim+this.dim;switch(t){case-1:n=r-1;break;case 1:r=n+1}switch(i){case-1:o=s-1;break;case 1:s=o+1}const a=-t*this.dim,l=-i*this.dim;for(let t=o;t<s;t++)for(let i=n;i<r;i++){const n=4*this._idx(i,t),r=4*this._idx(i+a,t+l);this.pixels[n+0]=e.pixels[r+0],this.pixels[n+1]=e.pixels[r+1],this.pixels[n+2]=e.pixels[r+2],this.pixels[n+3]=e.pixels[r+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function Yx(e,t,i){1===e?t.headerLength=i.readFixed32():2===e?t.x=i.readVarint():3===e?t.y=i.readVarint():4===e?t.z=i.readVarint():5===e&&t.layers.push(function(e,t){return e.readFields(eb,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},t)}(i,i.readVarint()+i.pos))}function Zx(e,t,i){1===e?(t.delta_filter=function(e,t){return e.readFields(Jx,{blockSize:0},t)}(i,i.readVarint()+i.pos),t.filter="delta_filter"):2===e?(i.readVarint(),t.filter="zigzag_filter"):3===e?(i.readVarint(),t.filter="bitshuffle_filter"):4===e&&(i.readVarint(),t.filter="byteshuffle_filter")}function Jx(e,t,i){1===e&&(t.blockSize=i.readVarint())}function Kx(e,t,i){1===e?(i.readVarint(),t.codec="gzip_data"):2===e?(i.readVarint(),t.codec="jpeg_image"):3===e?(i.readVarint(),t.codec="webp_image"):4===e&&(i.readVarint(),t.codec="png_image")}function Qx(e,t,i){let n=0,r=0;1===e?t.firstByte=i.readFixed64():2===e?t.lastByte=i.readFixed64():3===e?t.filters.push(function(e,t){return e.readFields(Zx,{},t)}(i,i.readVarint()+i.pos)):4===e?t.codec=function(e,t){return e.readFields(Kx,{},t)}(i,i.readVarint()+i.pos):5===e?r=i.readFloat():6===e?n=i.readFloat():7===e?t.bands.push(i.readString()):8===e?t.offset=i.readDouble():9===e&&(t.scale=i.readDouble()),0===t.offset&&(t.offset=r),0===t.scale&&(t.scale=n)}function eb(e,t,i){1===e?t.version=i.readVarint():2===e?t.name=i.readString():3===e?t.units=i.readString():4===e?t.tileSize=i.readVarint():5===e?t.buffer=i.readVarint():6===e?t.pixelFormat=i.readVarint():7===e&&t.dataIndex.push(function(e,t){return e.readFields(Qx,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},t)}(i,i.readVarint()+i.pos))}function tb(e,t,i){if(2===e)!function(e,t,i){e.readFields(ib,i,t)}(i,i.readVarint()+i.pos,t);else if(3===e)throw new Error("Not implemented")}function ib(e,t,i){if(1===e){let e=0;const n=i.readVarint()+i.pos;for(;i.pos<n;)t[e++]=i.readVarint()}}function nb(e,t){if(4!==t.length)throw new Error(`Expected data of dimension 4 but got ${t.length}.`);let i=t[3];for(let n=2;n>=1;n--){const r=1===n?1:0,o=2===n?1:0;for(let n=0;n<t[0];n++){const s=t[1]*n;for(let n=r;n<t[1];n++){const r=t[2]*(n+s);for(let n=o;n<t[2];n++){const o=t[3]*(n+r);for(let n=0;n<t[3];n++){const t=o+n;e[t]+=e[t-i]}}}}i*=t[n]}return e}function rb(e){for(let t=0,i=e.length;t<i;t++)e[t]=e[t]>>>1^-(1&e[t]);return e}function ob(e,t){switch(t){case"uint32":return e;case"uint16":for(let t=0;t<e.length;t+=2){const i=e[t],n=e[t+1];e[t]=(240&i)>>4|(61440&i)>>8|(240&n)<<4|61440&n,e[t+1]=15&i|(3840&i)>>4|(15&n)<<8|(3840&n)<<4}return e;case"uint8":for(let t=0;t<e.length;t+=4){const i=e[t],n=e[t+1],r=e[t+2],o=e[t+3];e[t+0]=(192&i)>>6|(192&n)>>4|(192&r)>>2|192&o,e[t+1]=(48&i)>>4|(48&n)>>2|48&r|(48&o)<<2,e[t+2]=(12&i)>>2|12&n|(12&r)<<2|(12&o)<<4,e[t+3]=3&i|(3&n)<<2|(3&r)<<4|(3&o)<<6}return e;default:throw new Error(`Invalid pixel format, "${t}"`)}}es(Xx,"DEMData"),es(Gx,"DemMinMaxQuadTree",{omit:["dem"]});var sb=Uint8Array,ab=Uint16Array,lb=Int32Array,cb=new sb([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ub=new sb([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),hb=new sb([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),db=function(e,t){for(var i=new ab(31),n=0;n<31;++n)i[n]=t+=1<<e[n-1];var r=new lb(i[30]);for(n=1;n<30;++n)for(var o=i[n];o<i[n+1];++o)r[o]=o-i[n]<<5|n;return{b:i,r:r}},pb=db(cb,2),fb=pb.b,mb=pb.r;fb[28]=258,mb[258]=28;for(var gb=db(ub,0).b,_b=new ab(32768),yb=0;yb<32768;++yb){var vb=(43690&yb)>>1|(21845&yb)<<1;_b[yb]=((65280&(vb=(61680&(vb=(52428&vb)>>2|(13107&vb)<<2))>>4|(3855&vb)<<4))>>8|(255&vb)<<8)>>1}var xb=function(e,t,i){for(var n=e.length,r=0,o=new ab(t);r<n;++r)e[r]&&++o[e[r]-1];var s,a=new ab(t);for(r=1;r<t;++r)a[r]=a[r-1]+o[r-1]<<1;s=new ab(1<<t);var l=15-t;for(r=0;r<n;++r)if(e[r])for(var c=r<<4|e[r],u=t-e[r],h=a[e[r]-1]++<<u,d=h|(1<<u)-1;h<=d;++h)s[_b[h]>>l]=c;return s},bb=new sb(288);for(yb=0;yb<144;++yb)bb[yb]=8;for(yb=144;yb<256;++yb)bb[yb]=9;for(yb=256;yb<280;++yb)bb[yb]=7;for(yb=280;yb<288;++yb)bb[yb]=8;var Tb=new sb(32);for(yb=0;yb<32;++yb)Tb[yb]=5;var wb=xb(bb,9),Eb=xb(Tb,5),Sb=function(e){for(var t=e[0],i=1;i<e.length;++i)e[i]>t&&(t=e[i]);return t},Ab=function(e,t,i){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(7&t)&i},Mb=function(e,t){var i=t/8|0;return(e[i]|e[i+1]<<8|e[i+2]<<16)>>(7&t)},Ib=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Cb=function(e,t,i){var n=new Error(t||Ib[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,Cb),!i)throw n;return n},Pb=new sb(0),Lb="undefined"!=typeof TextDecoder&&new TextDecoder;try{Lb.decode(Pb,{stream:!0})}catch(e){}const Rb={gzip_data:"gzip"};class Ob extends Error{constructor(e){super(e),this.name="MRTError"}}const Db={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},Bb={uint32:1,uint16:2,uint8:4},Fb={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Nb;class kb{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const t=this.layers[e];if(!t)throw new Ob(`Layer '${e}' not found`);return t}getHeaderLength(e){const t=new Uint8Array(e),i=new DataView(e);if(13!==t[0])throw new Ob("File is not a valid MRT.");return i.getUint32(1,!0)}parseHeader(e){const t=new Uint8Array(e),i=this.getHeaderLength(e);if(t.length<i)throw new Ob(`Expected header with length >= ${i} but got buffer of length ${t.length}`);const n=new Nb(t.subarray(0,i)).readFields(Yx,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==n.x||this.y!==n.y||this.z!==n.z))throw new Ob(`Invalid attempt to parse header ${n.z}/${n.x}/${n.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=n.x,this.y=n.y,this.z=n.z;for(const e of n.layers)this.layers[e.name]=new Ub(e,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const t=[],i=this.getLayer(e.layerName);for(let n of e.blockIndices){const r=i.dataIndex[n],o=r.firstByte-e.firstByte,s=r.lastByte-e.firstByte;if(i._blocksInProgress.has(n))continue;const a={layerName:i.name,firstByte:o,lastByte:s,pixelFormat:i.pixelFormat,blockIndex:n,blockShape:[r.bands.length].concat(i.bandShape),buffer:i.buffer,codec:r.codec.codec,filters:r.filters.map((e=>e.filter))};i._blocksInProgress.add(n),t.push(a)}return new zb(t,(()=>{t.forEach((e=>i._blocksInProgress.delete(e.blockIndex)))}),((e,n)=>{if(t.forEach((e=>i._blocksInProgress.delete(e.blockIndex))),e)throw e;n.forEach((e=>{this.getLayer(e.layerName).processDecodedData(e)}))}))}}class Ub{constructor({version:e,name:t,units:i,tileSize:n,pixelFormat:r,buffer:o,dataIndex:s},a){if(this.version=e,1!==this.version)throw new Ob(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=t,this.units=i,this.tileSize=n,this.buffer=o,this.pixelFormat=Db[r],this.dataIndex=s,this.bandShape=[n+2*o,n+2*o,Bb[this.pixelFormat]],this._decodedBlocks=new Bx(a?a.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return Bb[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:e})=>e)).flat()}processDecodedData(e){const t=e.blockIndex.toString();this._decodedBlocks.get(t)||this._decodedBlocks.put(t,e.data)}getBlockForBand(e){let t=0;switch(typeof e){case"string":for(const[i,n]of this.dataIndex.entries()){for(const[r,o]of n.bands.entries())if(o===e)return{bandIndex:t+r,blockIndex:i,blockBandIndex:r};t+=n.bands.length}break;case"number":for(const[i,n]of this.dataIndex.entries()){if(e>=t&&e<t+n.bands.length)return{bandIndex:e,blockIndex:i,blockBandIndex:e-t};t+=n.bands.length}break;default:throw new Ob(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let t=1/0,i=-1/0;const n=[],r=new Set;for(const o of e){const{blockIndex:e}=this.getBlockForBand(o);if(e<0)throw new Ob(`Invalid band: ${JSON.stringify(o)}`);const s=this.dataIndex[e];n.includes(e)||n.push(e),r.add(e),t=Math.min(t,s.firstByte),i=Math.max(i,s.lastByte)}if(r.size>this.cacheSize)throw new Ob(`Number of blocks to decode (${r.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:t,lastByte:i,blockIndices:n}}hasBand(e){const{blockIndex:t}=this.getBlockForBand(e);return t>=0}hasDataForBand(e){const{blockIndex:t}=this.getBlockForBand(e);return t>=0&&!!this._decodedBlocks.get(t.toString())}getBandView(e){const{blockIndex:t,blockBandIndex:i}=this.getBlockForBand(e);if(t<0)throw new Ob(`Band not found: ${JSON.stringify(e)}`);const n=this._decodedBlocks.get(t.toString());if(!n)throw new Ob(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const r=this.dataIndex[t],o=this.bandShape.reduce(((e,t)=>e*t),1),s=i*o,a=n.subarray(s,s+o);return{data:a,bytes:new Uint8Array(a.buffer).subarray(a.byteOffset,a.byteOffset+a.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:r.offset,scale:r.scale}}}kb.setPbf=function(e){Nb=e};class zb{constructor(e,t,i){this.tasks=e,this._onCancel=t,this._onComplete=i,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,t){this._finalized||(this._onComplete(e,t),this._finalized=!0)}}kb.performDecoding=function(e,t){const i=new Uint8Array(e);return Promise.all(t.tasks.map((e=>{const{layerName:t,firstByte:n,lastByte:r,pixelFormat:o,blockShape:s,blockIndex:a,filters:l,codec:c}=e,u=i.subarray(n,r+1),h=new Uint32Array(s[0]*s[1]*s[2]);let d;if("gzip_data"!==c)throw new Ob(`Unhandled codec: ${c}`);return d=function(e,t){if(!globalThis.DecompressionStream&&"gzip_data"===t)return Promise.resolve(((o=function(e){31==e[0]&&139==e[1]&&8==e[2]||Cb(6,"invalid gzip data");var t=e[3],i=10;4&t&&(i+=2+(e[10]|e[11]<<8));for(var n=(t>>3&1)+(t>>4&1);n>0;n-=!e[i++]);return i+(2&t)}(r=e))+8>r.length&&Cb(6,"invalid gzip data"),function(e,t,i){var n=e.length;if(!n||t.f&&!t.l)return i||new sb(0);var r=!i,o=r||2!=t.i,s=t.i;r&&(i=new sb(3*n));var a,l,c=function(e){var t=i.length;if(e>t){var n=new sb(Math.max(2*t,e));n.set(i),i=n}},u=t.f||0,h=t.p||0,d=t.b||0,p=t.l,f=t.d,m=t.m,g=t.n,_=8*n;do{if(!p){u=Ab(e,h,1);var y=Ab(e,h+1,3);if(h+=3,!y){var v=e[(P=4+((h+7)/8|0))-4]|e[P-3]<<8,x=P+v;if(x>n){s&&Cb(0);break}o&&c(d+v),i.set(e.subarray(P,x),d),t.b=d+=v,t.p=h=8*x,t.f=u;continue}if(1==y)p=wb,f=Eb,m=9,g=5;else if(2==y){var b=Ab(e,h,31)+257,T=Ab(e,h+10,15)+4,w=b+Ab(e,h+5,31)+1;h+=14;for(var E=new sb(w),S=new sb(19),A=0;A<T;++A)S[hb[A]]=Ab(e,h+3*A,7);h+=3*T;var M=Sb(S),I=(1<<M)-1,C=xb(S,M);for(A=0;A<w;){var P,L=C[Ab(e,h,I)];if(h+=15&L,(P=L>>4)<16)E[A++]=P;else{var R=0,O=0;for(16==P?(O=3+Ab(e,h,3),h+=2,R=E[A-1]):17==P?(O=3+Ab(e,h,7),h+=3):18==P&&(O=11+Ab(e,h,127),h+=7);O--;)E[A++]=R}}var D=E.subarray(0,b),B=E.subarray(b);m=Sb(D),g=Sb(B),p=xb(D,m),f=xb(B,g)}else Cb(1);if(h>_){s&&Cb(0);break}}o&&c(d+131072);for(var F=(1<<m)-1,N=(1<<g)-1,k=h;;k=h){var U=(R=p[Mb(e,h)&F])>>4;if((h+=15&R)>_){s&&Cb(0);break}if(R||Cb(2),U<256)i[d++]=U;else{if(256==U){k=h,p=null;break}var z=U-254;U>264&&(z=Ab(e,h,(1<<(j=cb[A=U-257]))-1)+fb[A],h+=j);var V=f[Mb(e,h)&N],G=V>>4;if(V||Cb(3),h+=15&V,B=gb[G],G>3){var j=ub[G];B+=Mb(e,h)&(1<<j)-1,h+=j}if(h>_){s&&Cb(0);break}o&&c(d+131072);var H=d+z;if(d<B){var $=0-B,W=Math.min(B,H);for($+d<0&&Cb(3);d<W;++d)i[d]=(void 0)[$+d]}for(;d<H;++d)i[d]=i[d-B]}}t.l=p,t.p=k,t.b=d,t.f=u,p&&(u=1,t.m=m,t.d=f,t.n=g)}while(!u);return d!=i.length&&r?(a=i,(null==(l=d)||l>a.length)&&(l=a.length),new sb(a.subarray(0,l))):i.subarray(0,d)}(r.subarray(o,-8),{i:2},new sb(((i=r)[(n=i.length)-4]|i[n-3]<<8|i[n-2]<<16|i[n-1]<<24)>>>0))));var i,n,r,o;const s=Rb[t];if(!s)throw new Error(`Unhandled codec: ${t}`);const a=new globalThis.DecompressionStream(s);return new Response(new Blob([e]).stream().pipeThrough(a)).arrayBuffer().then((e=>new Uint8Array(e)))}(u,c).then((e=>(function(e,t){e.readFields(tb,t)}(new Nb(e),h),new Fb[o](h.buffer)))),d.then((e=>{for(let t=l.length-1;t>=0;t--)switch(l[t]){case"delta_filter":nb(e,s);break;case"zigzag_filter":rb(e);break;case"bitshuffle_filter":ob(e,o);break;default:throw new Ob(`Unhandled filter "${l[t]}"`)}return{layerName:t,blockIndex:a,data:e}})).catch((e=>{throw e}))})))},es(zb,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),es(kb,"MapboxRasterTile"),es(Ub,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class Vb{constructor(e){this._stringToNumber={},this._numberToString=[];for(let t=0;t<e.length;t++){const i=e[t];this._stringToNumber[i]=t,this._numberToString[t]=i}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}class Gb{constructor(e,t){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Ko(zn,16,0),this.featureIndexArray=new rl,this.promoteId=t,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,t,i,n,r,o=0,s=0){const a=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(i,n,r,o);const l=this.grid;for(let e=0;e<t.length;e++){const i=t[e],n=[1/0,1/0,-1/0,-1/0];for(let e=0;e<i.length;e++){const t=i[e];n[0]=Math.min(n[0],t.x),n[1]=Math.min(n[1],t.y),n[2]=Math.max(n[2],t.x),n[3]=Math.max(n[3],t.y)}0!==s&&(n[0]-=s,n[1]-=s,n[2]+=s,n[3]+=s),n[0]<zn&&n[1]<zn&&n[2]>=0&&n[3]>=0&&l.insert(a,n[0],n[1],n[2],n[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Bc(new wg(this.rawTileData)).layers,this.sourceLayerCoder=new Vb(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,t){const{tilespaceGeometry:i,transform:n,tileTransform:r,pixelPosMatrix:o,availableImages:s,worldview:a}=t;this.loadVTLayers(),this.serializedLayersCache.clear();const l=t.queryRadius?t.queryRadius:0,c=i.bufferedTilespaceBounds,u=this.grid.query(c.min.x,c.min.y,c.max.x,c.max.y,((e,t,n,r)=>gu(i.bufferedTilespaceGeometry,e-l,t-l,n+l,r+l)));u.sort(Hb);let h=null;n.elevation&&u.length>0&&(h=Sv.create(n.elevation,this.tileID));const d={};let p;for(let t=0;t<u.length;t++){const l=u[t];if(l===p)continue;p=l;const c=this.featureIndexArray.get(l);let f=null;this.is3DTile?this.loadMatchingModelFeature(d,c,e,i,n,a):this.loadMatchingFeature(d,c,e,s,a,((e,t,s,a=0)=>(f||(f=Ic(e,this.tileID.canonical,r)),t.queryIntersectsFeature(i,e,s,f,this.z,n,o,h,a))))}return d}loadMatchingFeature(e,t,i,n,r,o){const{featureIndex:s,bucketIndex:a,sourceLayerIndex:l,layoutVertexArrayOffset:c}=t,u=this.bucketLayerIDs[a],h=i.layers,d=Object.keys(h);if(d.length&&!$e(d,u))return;const p=i.sourceCache,f=this.sourceLayerCoder.decode(l),m=this.vtLayers[f].feature(s),g=this.getId(m,f);for(let t=0;t<u.length;t++){const i=u[t];if(!h[i])continue;const{styleLayer:a,targets:l}=h[i];let d={};void 0!==g&&(d=p.getFeatureState(a.sourceLayer,g));const f=!o||o(m,a,d,c);if(!f)continue;const _=new Nv(m,this.z,this.x,this.y,g);_.tile=this.tileID.canonical,_.state=d;let y=this.serializedLayersCache.get(i);y||(y=a.serialize(),y.id=i,this.serializedLayersCache.set(i,y)),_.source=y.source,_.sourceLayer=y["source-layer"],_.layer=Object.assign({},y),_.layer.paint=jb(y.paint,a.paint,m,d,n),_.layer.layout=jb(y.layout,a.layout,m,d,n);let v=!1;for(const e of l){this.updateFeatureProperties(_,e);const{filter:t}=e;if(t)if(m.properties=_.properties,t.needGeometry){const e=Cc(m,!0);if(!t.filter(new Ss(this.tileID.overscaledZ,{worldview:r}),e,this.tileID.canonical))continue}else if(!t.filter(new Ss(this.tileID.overscaledZ,{worldview:r}),m))continue;v=!0,e.targetId&&this.addFeatureVariant(_,e)}v&&this.appendToResult(e,i,s,_,f)}}loadMatchingModelFeature(e,t,i,n,r,o){const{featureIndex:s,bucketIndex:a}=t,l=this.bucketLayerIDs[a],c=i.layers,u=Object.keys(c);if(!u.length||$e(u,l))for(let t=0;t<l.length;t++){const a=l[t],{styleLayer:u,targets:h}=c[a];if("model"!==u.type)continue;const d=n.tile,p=d.getBucket(u);if(!(p&&p instanceof Rv))continue;const f=zv(p,s,n,r);if(!f)continue;const{z:m,x:g,y:_}=d.tileID.canonical,{feature:y,intersectionZ:v,position:x}=f;let b={};void 0!==y.id&&(b=i.sourceCache.getFeatureState(u.sourceLayer,y.id));const T=new Nv({},m,g,_,y.id);T.tile=this.tileID.canonical,T.state=b,T.properties=y.properties,T.geometry={type:"Point",coordinates:[x.lng,x.lat]};let w=this.serializedLayersCache.get(a);w||(w=u.serialize(),w.id=a,this.serializedLayersCache.set(a,w)),T.source=w.source,T.sourceLayer=w["source-layer"],T.layer=Object.assign({},w);let E=!1;for(const e of h){this.updateFeatureProperties(T,e);const{filter:t}=e;if(t)if(y.properties=T.properties,t.needGeometry){if(!t.filter(new Ss(this.tileID.overscaledZ,{worldview:o}),y,this.tileID.canonical))continue}else if(!t.filter(new Ss(this.tileID.overscaledZ,{worldview:o}),y))continue;E=!0,e.targetId&&this.addFeatureVariant(T,e)}E&&this.appendToResult(e,a,s,T,v)}}updateFeatureProperties(e,t,i){if(t.properties){const n={};for(const r in t.properties){const o=t.properties[r].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,i);null!=o&&(n[r]=o)}e.properties=n}}addFeatureVariant(e,t,i){const n={target:t.target,namespace:t.namespace,uniqueFeatureID:t.uniqueFeatureID};t.properties&&(n.properties=e.properties),e.variants=e.variants||{},e.variants[t.targetId]=e.variants[t.targetId]||[],e.variants[t.targetId].push(n)}appendToResult(e,t,i,n,r){let o=e[t];void 0===o&&(o=e[t]=[]),o.push({featureIndex:i,feature:n,intersectionZ:r})}lookupSymbolFeatures(e,t,i,n,r,o){const s={};this.loadVTLayers();for(const a of e)this.loadMatchingFeature(s,{bucketIndex:t,sourceLayerIndex:i,featureIndex:a,layoutVertexArrayOffset:0},n,r,o);return s}loadFeature(e){const{featureIndex:t,sourceLayerIndex:i}=e;this.loadVTLayers();const n=this.sourceLayerCoder.decode(i),r=this.vtFeatures[n];if(r[t])return r[t];const o=this.vtLayers[n].feature(t);return r[t]=o,o}hasLayer(e){for(const t of this.bucketLayerIDs)for(const i of t)if(e===i)return!0;return!1}getId(e,t){let i=e.id;if(this.promoteId){const n=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[t];if(null!=n)if(Array.isArray(n)){if(!this.promoteIdExpression){const e=jo(n);if("success"!==e.result)return void qe(`Failed to create expression for promoteId: ${e.value.map((e=>`${e.key}: ${e.message}`)).join(", ")}`);this.promoteIdExpression=e.value}i=this.promoteIdExpression.evaluate({zoom:0},e)}else i=e.properties[n];"boolean"==typeof i&&(i=Number(i))}return i}}function jb(e,t,i,n,r){return Ge(e,((e,o)=>{const s=t instanceof Os?t.get(o):null;return s&&s.evaluate?s.evaluate(i,n,void 0,r):s}))}function Hb(e,t){return t-e}es(Gb,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const $b=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Wb{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[t,i]=new Uint8Array(e,0,2);if(219!==t)throw new Error("Data does not appear to be in a KDBush format.");const n=i>>4;if(1!==n)throw new Error(`Got v${n} data when expected v1.`);const r=$b[15&i];if(!r)throw new Error("Unrecognized array type.");const[o]=new Uint16Array(e,2,1),[s]=new Uint32Array(e,4,1);return new Wb(s,o,r,e)}constructor(e,t=64,i=Float64Array,n){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.ArrayType=i,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const r=$b.indexOf(this.ArrayType),o=2*e*this.ArrayType.BYTES_PER_ELEMENT,s=e*this.IndexArrayType.BYTES_PER_ELEMENT,a=(8-s%8)%8;if(r<0)throw new Error(`Unexpected typed array class: ${i}.`);n&&n instanceof ArrayBuffer?(this.data=n,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+s+a,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+o+s+a),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+s+a,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+r]),new Uint16Array(this.data,2,1)[0]=t,new Uint32Array(this.data,4,1)[0]=e)}add(e,t){const i=this._pos>>1;return this.ids[i]=i,this.coords[this._pos++]=e,this.coords[this._pos++]=t,i}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return qb(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,t,i,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:r,coords:o,nodeSize:s}=this,a=[0,r.length-1,0],l=[];for(;a.length;){const c=a.pop()||0,u=a.pop()||0,h=a.pop()||0;if(u-h<=s){for(let s=h;s<=u;s++){const a=o[2*s],c=o[2*s+1];a>=e&&a<=i&&c>=t&&c<=n&&l.push(r[s])}continue}const d=h+u>>1,p=o[2*d],f=o[2*d+1];p>=e&&p<=i&&f>=t&&f<=n&&l.push(r[d]),(0===c?e<=p:t<=f)&&(a.push(h),a.push(d-1),a.push(1-c)),(0===c?i>=p:n>=f)&&(a.push(d+1),a.push(u),a.push(1-c))}return l}within(e,t,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:n,coords:r,nodeSize:o}=this,s=[0,n.length-1,0],a=[],l=i*i;for(;s.length;){const c=s.pop()||0,u=s.pop()||0,h=s.pop()||0;if(u-h<=o){for(let i=h;i<=u;i++)Jb(r[2*i],r[2*i+1],e,t)<=l&&a.push(n[i]);continue}const d=h+u>>1,p=r[2*d],f=r[2*d+1];Jb(p,f,e,t)<=l&&a.push(n[d]),(0===c?e-i<=p:t-i<=f)&&(s.push(h),s.push(d-1),s.push(1-c)),(0===c?e+i>=p:t+i>=f)&&(s.push(d+1),s.push(u),s.push(1-c))}return a}}function qb(e,t,i,n,r,o){if(r-n<=i)return;const s=n+r>>1;Xb(e,t,s,n,r,o),qb(e,t,i,n,s-1,1-o),qb(e,t,i,s+1,r,1-o)}function Xb(e,t,i,n,r,o){for(;r>n;){if(r-n>600){const s=r-n+1,a=i-n+1,l=Math.log(s),c=.5*Math.exp(2*l/3),u=.5*Math.sqrt(l*c*(s-c)/s)*(a-s/2<0?-1:1);Xb(e,t,i,Math.max(n,Math.floor(i-a*c/s+u)),Math.min(r,Math.floor(i+(s-a)*c/s+u)),o)}const s=t[2*i+o];let a=n,l=r;for(Yb(e,t,n,i),t[2*r+o]>s&&Yb(e,t,n,r);a<l;){for(Yb(e,t,a,l),a++,l--;t[2*a+o]<s;)a++;for(;t[2*l+o]>s;)l--}t[2*n+o]===s?Yb(e,t,n,l):(l++,Yb(e,t,l,r)),l<=i&&(n=l+1),i<=l&&(r=l-1)}}function Yb(e,t,i,n){Zb(e,i,n),Zb(t,2*i,2*n),Zb(t,2*i+1,2*n+1)}function Zb(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}function Jb(e,t,i,n){const r=e-i,o=t-n;return r*r+o*o}e.$=Qi,e.A=Ni,e.B=ta,e.C=2,e.D=Xp,e.E=ni,e.F=v_,e.G=__,e.H=Zi,e.I=ri,e.J=Us,e.K=Yi,e.L=Ki,e.M=Ro,e.N=Co,e.O=Lo,e.P=Ee,e.Q=Go,e.R=Bt,e.S=zs,e.T=Pf,e.U=jo,e.V=yv,e.W=Wo,e.X=vr,e.Y=_r,e.Z=yr,e._=on,e.a=function(e){return st.API_CDN_URL_REGEX.test(e)},e.a$=ma,e.a0=Ji,e.a1=ai,e.a2=Vs,e.a3=class extends yv{},e.a4=Oo,e.a5=Po,e.a6=ks,e.a7=function(e){const t=e.value;return t?Ji(t)?vv(t,!0)?[]:[new yv(e.key,t,`invalid url "${t}"`)]:[new yv(e.key,t,`string expected, "${Yi(t)}" found`)]:[]},e.a8=Is,e.a9=Ns,e.aA=De,e.aB=h,e.aC=Q,e.aD=Wl,e.aE=mu,e.aF=cc,e.aG=Tc,e.aH=function(e,t){const i={};for(let n=0;n<t.length;n++){const r=t[n];r in e&&(i[r]=e[r])}return i},e.aI=oc,e.aJ=uc,e.aK=class{constructor(e){this.entries={},this.scheduler=e}request(e,t,i,n){const r=this.entries[e]=this.entries[e]||{callbacks:[]};if(r.result){const[e,i]=r.result;return this.scheduler?this.scheduler.add((()=>{n(e,i)}),t):n(e,i),()=>{}}return r.callbacks.push(n),r.cancel||(r.cancel=i(((i,n)=>{r.result=[i,n];for(const e of r.callbacks)this.scheduler?this.scheduler.add((()=>{e(i,n)}),t):e(i,n);setTimeout((()=>delete this.entries[e]),3e3)}))),()=>{r.result||(r.callbacks=r.callbacks.filter((e=>e!==n)),r.callbacks.length||(r.cancel(),delete this.entries[e]))}}},e.aL=function(e,t,i){const n=JSON.stringify(e.request);return e.data&&(this.deduped.entries[n]={result:[null,e.data]}),this.deduped.request(n,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom},(t=>{const n=Ut(e.request,((e,n,r)=>{e?t(e):n&&t(null,{vectorTile:i?void 0:new Bc(new wg(n)),rawData:n,responseHeaders:new Map(r.entries())})}));return()=>{n.cancel(),t()}}),t)},e.aM=function(e){return e?{cacheControl:e.get("Cache-Control"),expires:e.get("Expires")}:{cacheControl:void 0,expires:void 0}},e.aN=function(e){Mt++,Mt>bt&&(e.getActor().send("enforceCacheSizeLimit",xt),Mt=0)},e.aO=function(e){return e<=1?1:Math.pow(2,Math.floor(Math.log2(e)))},e.aP=Cu,e.aQ=lv,e.aR=fv,e.aS=rc,e.aT=sv,e.aU=function(e,t){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){t(null,i)};for(let t=0;t<e.length;t++){const n=document.createElement("source");zt(e[t])||(i.crossOrigin="Anonymous"),n.src=e[t],i.appendChild(n)}return{cancel:()=>{}}},e.aV=Lf,e.aW=kv,e.aX=Ve,e.aY=hy,e.aZ=dc,e.a_=pc,e.aa=Ds,e.ab=class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return Ze(e.expression.evaluate(t))}interpolate(e,t,i){return{x:di(e.x,t.x,i),y:di(e.y,t.y,i),z:di(e.z,t.z,i),azimuthal:di(e.azimuthal,t.azimuthal,i),polar:di(e.polar,t.polar,i)}}},e.ac=Ss,e.ad=$o,e.ae=xc,e.af=G,e.ag=E,e.ah=Be,e.ai=Os,e.aj=th,e.ak=di,e.al=zn,e.am=pi,e.an=Ie,e.ao=li,e.ap=class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return function([e,t]){const i=Ze([1,e,t]);return{x:i.x,y:i.y,z:i.z}}(e.expression.evaluate(t))}interpolate(e,t,i){return{x:di(e.x,t.x,i),y:di(e.y,t.y,i),z:di(e.z,t.z,i)}}},e.aq=function(e,t,i=0,n=!0){const r=new Ee(i,i),o=e.sub(r),s=t.add(r),a=[o,new Ee(s.x,o.y),s,new Ee(o.x,s.y)];return n&&a.push(o.clone()),a},e.ar=function(e,t){const i=[];for(let n=0;n<e.length;n++){const r=Fe(n-1,-1,e.length-1),o=Fe(n+1,-1,e.length-1),s=e[n],a=e[o],l=e[r].sub(s).unit(),c=a.sub(s).unit(),u=c.angleWithSep(l.x,l.y),h=l.add(c).unit().mult(-1*t/Math.sin(u/2));i.push(s.add(h))}return i},e.as=dy,e.at=gu,e.au=function(e,t,i=0){return S(((t.x-i)*e.scale-e.x)*zn,(t.y*e.scale-e.y)*zn,fc(t.z,t.y))},e.av=q,e.aw=k,e.ax=$c,e.ay=Xm,e.az=function(e){let t=1/0,i=1/0,n=-1/0,r=-1/0;for(const o of e)t=Math.min(t,o.x),i=Math.min(i,o.y),n=Math.max(n,o.x),r=Math.max(r,o.y);return{min:new Ee(t,i),max:new Ee(n,r)}},e.b=function(e){return st.API_FONTS_REGEX.test(e)},e.b$=Xd,e.b0=Da,e.b1=Ue,e.b2=Za,e.b3=Hy,e.b4=function(){Es.isLoading()||Es.isLoaded()||"deferred"!==Ts()||ws()},e.b5=Gs,e.b6=Cc,e.b7=Nv,e.b8=Ke,e.b9=Hm,e.bA=g,e.bB=a,e.bC=function(e,t){const{x:i,y:n}=e.point,r=eh(i,n,e.worldSize/e._pixelsPerMercatorPixel,0,0);return h(r,r,Ju(Vu(t)))},e.bD=n,e.bE=$,e.bF=D,e.bG=O,e.bH=z,e.bI=U,e.bJ=l_,e.bK=zg,e.bL=a_,e.bM=function(e,t,i,n,r){const o=5*t+2;e.float32[o+0]=i,e.float32[o+1]=n,e.float32[o+2]=r},e.bN=zy,e.bO=ue,e.bP=fe,e.bQ=de,e.bR=xe,e.bS=Fe,e.bT=function(e,t,n,r){var o=new i(4);return o[0]=e,o[1]=t,o[2]=n,o[3]=r,o},e.bU=class{isDataAvailableAtPoint(e){const t=this._source();if(this.isUsingMockSource()||!t||e.y<0||e.y>1)return!1;const i=t.getSource().maxzoom,n=1<<i,r=Math.floor(e.x),o=Math.floor((e.x-r)*n),s=Math.floor(e.y*n),a=this.findDEMTileFor(new Cu(i,r,i,o,s));return!(!a||!a.dem)}getAtPointOrZero(e,t=0){return this.getAtPoint(e,t)||0}getAtPoint(e,t,i=!0){if(this.isUsingMockSource())return null;null==t&&(t=null);const n=this._source();if(!n)return t;if(e.y<0||e.y>1)return t;const r=n.getSource().maxzoom,o=1<<r,s=Math.floor(e.x),a=e.x-s,l=new Cu(r,s,r,Math.floor(a*o),Math.floor(e.y*o)),c=this.findDEMTileFor(l);if(!c||!c.dem)return t;const u=c.dem,h=1<<c.tileID.canonical.z,d=(a*h-c.tileID.canonical.x)*u.dim,p=(e.y*h-c.tileID.canonical.y)*u.dim,f=Math.floor(d),m=Math.floor(p);return(i?this.exaggeration():1)*di(di(u.get(f,m),u.get(f,m+1),p-m),di(u.get(f+1,m),u.get(f+1,m+1),p-m),d-f)}static getAtTileOffset(e,t,i,n){const r=1<<e.canonical.z;return n?n.pointElevation(t):i?i.getAtPointOrZero(new xc(e.wrap+(e.canonical.x+t.x/zn)/r,(e.canonical.y+t.y/zn)/r)):0}static getAtTileOffsetFunc(e,t,i,n){return(r,o,s)=>{const a=this.getAtTileOffset(e,r,o,s),l=n.upVector(e.canonical,r.x,r.y);return R(l,l,a*n.upVectorScale(e.canonical,t,i).metersToTile),l}}getForTilePoints(e,t,i,n){if(this.isUsingMockSource())return!1;const r=Sv.create(this,e,n);return!!r&&(t.forEach((e=>{e[2]=this.exaggeration()*r.getElevationAt(e[0],e[1],i)})),!0)}getMinMaxForTile(e){if(this.isUsingMockSource())return null;const t=this.findDEMTileFor(e);if(!t||!t.dem)return null;const i=t.dem.tree,n=t.tileID,r=1<<e.canonical.z-n.canonical.z;let o=e.canonical.x/r-n.canonical.x,s=e.canonical.y/r-n.canonical.y,a=0;for(let t=0;t<e.canonical.z-n.canonical.z&&!i.leaves[a];t++){o*=2,s*=2;const e=2*Math.floor(s)+Math.floor(o);a=i.childOffsets[a]+e,o%=1,s%=1}return{min:this.exaggeration()*i.minimums[a],max:this.exaggeration()*i.maximums[a]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(e,t,i){throw new Error("Pure virtual method called.")}pointCoordinate(e){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(e){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const e=this.visibleDemTiles;if(0===e.length)return null;let t=!1,i=Number.MAX_VALUE,n=Number.MIN_VALUE;for(const r of e){const e=this.getMinMaxForTile(r.tileID);e&&(i=Math.min(i,e.min),n=Math.max(n,e.max),t=!0)}return t?{min:i,max:n}:null}},e.bV=Dp,e.bW=ru,e.bX=mg,e.bY=kd,e.bZ=_v,e.b_=qd,e.ba=xd,e.bb=Ic,e.bc=pa,e.bd=Ha,e.be=Bu,e.bf=hl,e.bg=Ph,e.bh=iv,e.bi=function(e,t){const i=th(t.zoom);if(0===i)return Vu(e);const n=$u(e),r=Wu(n),o=cc(n.getWest())*t.worldSize,s=cc(n.getEast())*t.worldSize,a=uc(n.getNorth())*t.worldSize,l=uc(n.getSouth())*t.worldSize,c=[o,a,0],h=[s,a,0],d=[o,l,0],p=[s,l,0],f=u([],t.globeMatrix);return G(c,c,f),G(h,h,f),G(d,d,f),G(p,p,f),r[0]=Gu(r[0],d,i),r[1]=Gu(r[1],p,i),r[2]=Gu(r[2],h,i),r[3]=Gu(r[3],c,i),Kc.fromPoints(r)},e.bj=Zu,e.bk=u,e.bl=qu,e.bm=Gu,e.bn=fa,e.bo=Du,e.bp=_,e.bq=d,e.br=kb,e.bs=wg,e.bt=Ut,e.bu=function(e,t){const i=[];for(const n in e)n in t||i.push(n);return i},e.bv=Ne,e.bw=["type","source","source-layer","minzoom","maxzoom","filter","layout"],e.bx=Se,e.by=l,e.bz=c,e.c=lt,e.c$=function(e){return e*e*e*e*e},e.c0=Jg,e.c1=$_,e.c2=ey,e.c3=Wb,e.c4=R,e.c5=Y,e.c6=te,e.c7=function(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l+r*a,e[1]=r*l-n*a,e[2]=o*l+s*a,e[3]=s*l-o*a,e},e.c8=ie,e.c9=et,e.cA=Jc,e.cB=zf,e.cC=Mu,e.cD=Hu,e.cE=function(e,t,i,n,r,o,s,a,l){if("globe"===l.name)return Hu(e,t,new Mu(i,n,r),!1);const c=hy({z:i,x:n,y:r},l);return new Kc([(o+c.x/c.scale)*t,t*(c.y/c.scale),s],[(o+c.x2/c.scale)*t,t*(c.y2/c.scale),a])},e.cF=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e},e.cG=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e},e.cH=function(e){const t=Math.round((e+45+360)%360/90)%4;return Pe[t]},e.cI=mc,e.cJ=J,e.cK=Xl,e.cL=function(e){const t=c(new Float64Array(16));h(t,e.pixelMatrix,e.globeMatrix);const i=[0,Kl,0],n=[0,Ql,0];return G(i,i,t),G(n,n,t),[i[0]>0&&i[0]<=e.width&&i[1]>0&&i[1]<=e.height&&!nh(e,new rc(e.center.lat,90)),n[0]>0&&n[0]<=e.width&&n[1]>0&&n[1]<=e.height&&!nh(e,new rc(e.center.lat,-90))]},e.cM=function(e,t){const{scale:i}=e.tileTransform,n=i*zn/(e.tileSize*Math.pow(2,t.zoom-e.tileID.overscaledZ+e.tileID.canonical.z));return function(e,t,i){var n=t[1],r=t[2],o=t[3],s=i[0],a=i[1];return e[0]=t[0]*s,e[1]=n*s,e[2]=r*a,e[3]=o*a,e}(new Float32Array(4),t.inverseAdjustmentMatrix,[n,n])},e.cN=Vf,e.cO=b,e.cP=Uf,e.cQ=function(e){const t=Uf(e,!0);return n([],[t[0],t[1],t[4],t[5]])},e.cR=p,e.cS=Wc,e.cT=f,e.cU=function(e){const{x:t,y:i}=e.point,{lng:n,lat:r}=e._center;return eh(t,i,e.worldSize,n,r)},e.cV=C,e.cW=Ce,e.cX=Pu,e.cY=_u,e.cZ=ql,e.c_=function(e,t,i){let n=0;for(let i=0;i<2;++i){const r=0;e[i]>r&&(n+=(e[i]-r)*(e[i]-r)),t[i]<r&&(n+=(r-t[i])*(r-t[i]))}return n},e.ca=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},e.cb=x,e.cc=function(e,t,i,n,r){var o=1/Math.tan(t/2);if(e[0]=o/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0){var s=1/(n-r);e[10]=(r+n)*s,e[14]=2*r*n*s}else e[10]=-1,e[14]=-2*n;return e},e.cd=function(e,t,i,n,r,o,s){var a=1/(t-i),l=1/(n-r),c=1/(o-s);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*a,e[13]=(r+n)*l,e[14]=(s+o)*c,e[15]=1,e},e.ce=hc,e.cf=function(e,t,i){e[4*t+0]=i[0],e[4*t+1]=i[1],e[4*t+2]=i[2],e[4*t+3]=i[3]},e.cg=bl,e.ch=El,e.ci=Tl,e.cj=wl,e.ck=Il,e.cl=Oy,e.cm=function(){var e=new i(4);return i!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},e.cn=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l+o*a,e[1]=r*l+s*a,e[2]=n*-a+o*l,e[3]=r*-a+s*l,e},e.co=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},e.cp=W,e.cq=function(e){var t=e[0],i=e[1],n=e[2],r=e[3];return Math.sqrt(t*t+i*i+n*n+r*r)},e.cr=ae,e.cs=H,e.ct=Iu,e.cu=3,e.cv=2,e.cw=7,e.cx=6,e.cy=V,e.cz=T,e.d=function(e){return st.API_TILEJSON_REGEX.test(e)},e.d$=lh,e.d0=lc,e.d1=45,e.d2=Sl,e.d3=function(e,t,i){const n=Math.sqrt(e*e+t*t+i*i),r=n>0?Math.acos(i/n)*Me:0;let o=0!==e||0!==t?Math.atan2(-t,-e)*Me+90:0;return o<0&&(o+=360),[n,o,r]},e.d4=S,e.d5=Ze,e.d6=vc,e.d7=M,e.d8=Kc,e.d9=I,e.dA=Al,e.dB=class extends xl{constructor(e){super(e),this.current=Cl}set(e,t,i){if(this.fetchUniformLocation(e,t))for(let e=0;e<9;e++)if(i[e]!==this.current[e]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}},e.dC=Le,e.dD=function(e,t,i){const n=th(i.zoom),r=e.style.map._antialias,o=e.terrain&&e.terrain.exaggeration()>0;return 0===n&&!r&&!o},e.dE=function(e){const t=e.pixelsPerMeter,i=t/hc(1,e.center.lat),n=c(new Float64Array(16));return d(n,n,[e.point.x,e.point.y,0]),p(n,n,[i,i,t]),Float32Array.from(n)},e.dF=$u,e.dG=function(e){const t=mc-5;e=De(e,-t,t)/t*90;const i=Math.pow(Math.abs(Math.sin(Ie(e))),3);return Math.round(i*(Jl.length-1))},e.dH=function(e,t,i,n){const r=t.getNorth(),o=t.getSouth(),a=t.getWest(),l=t.getEast(),c=1<<e.z,u=l-a,h=r-o,d=u/Zl,p=-h/Jl[i],f=[0,d,0,p,0,0,r,a,0];if(e.z>0){const e=180/n;s(f,f,[e/u+1,0,0,0,e/h+1,0,-.5*e/d,.5*e/p,1])}return f[2]=c,f[5]=e.x,f[8]=e.y,f},e.dI=Vu,e.dJ=function(e,t,i){const n=c(new Float64Array(16)),r=(t/(1<<e)-.5)*Math.PI*2;return m(n,i.globeMatrix,r),Float32Array.from(n)},e.dK=Eh,e.dL=Fu,e.dM=function(e,t){return[Math.pow(e[0],2.2)*t,Math.pow(e[1],2.2)*t,Math.pow(e[2],2.2)*t]},e.dN=r,e.dO=function(e,t){var i=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=i,e[2]=0,e[3]=-i,e[4]=n,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},e.dP=j,e.dQ=Qu,e.dR=nt,e.dS=rt,e.dT=256,e.dU=function(e,t){const i=[0,0,0];return G(i,i,Zu(Vu(t.canonical))),G(i,i,e),i},e.dV=e=>({u_matrix:new Il(e),u_texsize:new wl(e),u_pixels_to_tile_units:new Ll(e),u_device_pixel_ratio:new Tl(e),u_width_scale:new Tl(e),u_floor_width_scale:new Tl(e),u_image:new bl(e),u_units_to_pixels:new wl(e),u_tile_units_to_pixels:new Tl(e),u_alpha_discard_threshold:new Tl(e),u_trim_offset:new wl(e),u_trim_fade_range:new wl(e),u_trim_color:new Sl(e),u_emissive_strength:new Tl(e),u_zbias_factor:new Tl(e),u_tile_to_meter:new Tl(e),u_ground_shadow_factor:new El(e),u_pattern_transition:new Tl(e)}),e.dW=e=>({u_matrix:new Il(e),u_pixels_to_tile_units:new Ll(e),u_device_pixel_ratio:new Tl(e),u_width_scale:new Tl(e),u_floor_width_scale:new Tl(e),u_units_to_pixels:new wl(e),u_dash_image:new bl(e),u_gradient_image:new bl(e),u_image_height:new Tl(e),u_texsize:new wl(e),u_tile_units_to_pixels:new Tl(e),u_alpha_discard_threshold:new Tl(e),u_trim_offset:new wl(e),u_trim_fade_range:new wl(e),u_trim_color:new Sl(e),u_emissive_strength:new Tl(e),u_zbias_factor:new Tl(e),u_tile_to_meter:new Tl(e),u_ground_shadow_factor:new El(e)}),e.dX=e=>({u_camera_to_center_distance:new Tl(e),u_extrude_scale:new Ll(e),u_device_pixel_ratio:new Tl(e),u_matrix:new Il(e),u_inv_rot_matrix:new Il(e),u_merc_center:new wl(e),u_tile_id:new El(e),u_zoom_transition:new Tl(e),u_up_dir:new El(e),u_emissive_strength:new Tl(e)}),e.dY=Ra,e.dZ=fg,e.d_=class{constructor(e,t,i,n){this.context=e,this.format=n,this.size=i,this.texture=e.gl.createTexture();const[r,o,s]=this.size,{gl:a}=e;a.bindTexture(a.TEXTURE_3D,this.texture),e.pixelStoreUnpackFlipY.set(!1),e.pixelStoreUnpack.set(1),e.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in t&&t.data&&a.texImage3D(a.TEXTURE_3D,0,this.format,r,o,s,0,If(this.format),Cf(this.format),t.data)}bind(e,t){const{context:i}=this,{gl:n}=i;n.bindTexture(n.TEXTURE_3D,this.texture),e!==this.minFilter&&(n.texParameteri(n.TEXTURE_3D,n.TEXTURE_MAG_FILTER,e),n.texParameteri(n.TEXTURE_3D,n.TEXTURE_MIN_FILTER,e),this.minFilter=e),t!==this.wrapS&&(n.texParameteri(n.TEXTURE_3D,n.TEXTURE_WRAP_S,t),n.texParameteri(n.TEXTURE_3D,n.TEXTURE_WRAP_T,t),this.wrapS=t)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}},e.da=function(e){return[Math.pow(e[0],1/2.2),Math.pow(e[1],1/2.2),Math.pow(e[2],1/2.2)]},e.db=Mf,e.dc=hm,e.dd=Kf,e.de=vv,e.df=function(e,t){return e.readFields(Yv,{icons:[]},t)},e.dg=Jp,e.dh=M_,e.di=A_,e.dj=Nt,e.dk=vs,e.dl=yt,e.dm=Kt,e.dn=He,e.dp=function(e){const t=e.indexOf(ea);return t>=0?e.slice(0,t):e},e.dq=function(e){return e.indexOf(ea)>=0},e.dr=function(e){const t=e.lastIndexOf(ea);return t>=0?e.slice(t+1):""},e.ds=function(e){const t=[],i=e.id;return void 0===i&&t.push({message:`layers.${i}: missing required property "id"`}),void 0===e.render&&t.push({message:`layers.${i}: missing required method "render"`}),e.renderingMode&&"2d"!==e.renderingMode&&"3d"!==e.renderingMode&&t.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),t},e.dt=function(e,t,i,n){return"custom"===e.type?new mv(e,t):new Vv[e.type](e,t,i,n)},e.du=je,e.dv=function(e){const t=e.indexOf(ea);return t>=0?e.slice(t+1):""},e.dw=class extends Nv{constructor(e,t){super(e._vectorTileFeature,e._z,e._x,e._y,e.id),e.state&&(this.state=Object.assign({},e.state)),this.target=t.target,this.namespace=t.namespace,t.properties&&(this.properties=t.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=e.source,this.sourceLayer=e.sourceLayer,this.layer=e.layer)}toJSON(){const e=super.toJSON();return e.target=this.target,e.namespace=this.namespace,e}},e.dx=bs,e.dy=kt,e.dz=function(e){return e({pluginStatus:_s,pluginURL:ys}),bs.on("pluginStateChange",e),e},e.e=st,e.e$=function([e,t,i]){const n=Math.hypot(e,t,i),r=Math.atan2(e,i),o=.5*Math.PI-Math.acos(-t/n);return new rc(Ce(r),Ce(o))},e.e0=(e,t,i,n,r,o)=>{const s=e.transform,a="globe"===s.projection.name;let l;if("map"===o.paint.get("circle-pitch-alignment"))if(a){const e=Qu(s.zoom,t.canonical)*s._pixelsPerMercatorPixel;l=Float32Array.from([e,0,0,e])}else l=s.calculatePixelsToTileUnitsMatrix(i);else l=new Float32Array([s.pixelsToGLUnits[0],0,0,s.pixelsToGLUnits[1]]);const c={u_camera_to_center_distance:e.transform.getCameraToCenterDistance(s.projection),u_matrix:e.translatePosMatrix(t.projMatrix,i,o.paint.get("circle-translate"),o.paint.get("circle-translate-anchor")),u_device_pixel_ratio:gt.devicePixelRatio,u_extrude_scale:l,u_inv_rot_matrix:ah,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:o.paint.get("circle-emissive-strength")};if(a){c.u_inv_rot_matrix=n,c.u_merc_center=r,c.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],c.u_zoom_transition=th(s.zoom);const e=r[0]*zn,i=r[1]*zn;c.u_up_dir=s.projection.upVector(new Mu(0,0,0),e,i)}return c},e.e1=Km,e.e2=ki,e.e3=(e,t,i,n,r,o,s,a,l,c)=>{const u=e.transform,h=u.pitch<15?Ym(.07,.7,De((14-u.zoom)/5,0,1)):.07,d="none"===i.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:Jm(e,t,i,n),u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:u.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:r,u_width_scale:o,u_floor_width_scale:s,u_image:0,u_tile_units_to_pixels:Zm(t,u),u_units_to_pixels:[1/u.pixelsToGLUnits[0],1/u.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:a,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(d?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:h,u_tile_to_meter:vc(t.tileID.canonical,0),u_ground_shadow_factor:l,u_pattern_transition:c}},e.e4=(e,t,i,n,r,o,s,a,l,c)=>{const u=e.transform,h=u.calculatePixelsToTileUnitsMatrix(t),d="none"===i.paint.get("line-trim-color-use-theme").constantOr("default"),p=u.pitch<15?Ym(.07,.7,De((14-u.zoom)/5,0,1)):.07;return{u_matrix:Jm(e,t,i,n),u_pixels_to_tile_units:h,u_device_pixel_ratio:o,u_width_scale:s,u_floor_width_scale:a,u_units_to_pixels:[1/u.pixelsToGLUnits[0],1/u.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:r,u_texsize:Qm(i)&&t.lineAtlasTexture?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Zm(t,e.transform),u_alpha_discard_threshold:0,u_trim_offset:l,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(d?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:p,u_tile_to_meter:vc(t.tileID.canonical,0),u_ground_shadow_factor:c}},e.e5=ze,e.e6=Sh,e.e7=fc,e.e8=Lu,e.e9=_p,e.eA=Uv,e.eB=Jf,e.eC=qf,e.eD=[1,1,1],e.eE=Sv,e.eF=Z,e.eG=function(e,t,i,n){var r=t[0],o=t[1],s=t[2],a=t[3];return e[0]=r+n*(i[0]-r),e[1]=o+n*(i[1]-o),e[2]=s+n*(i[2]-s),e[3]=a+n*(i[3]-a),e},e.eH=Zf,e.eI=Ca,e.eJ=Ga,e.eK=function(e,t,n,r,o,s,a,l,c,u,h,d,p,f,m,g){var _=new i(16);return _[0]=e,_[1]=t,_[2]=n,_[3]=r,_[4]=o,_[5]=s,_[6]=a,_[7]=l,_[8]=c,_[9]=u,_[10]=h,_[11]=d,_[12]=p,_[13]=f,_[14]=m,_[15]=g,_},e.eL=ic,e.eM=Va,e.eN=za,e.eO=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Ee(1/0,1/0),max:new Ee(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(e,t=!1){const i=jd(new Ee(0,0),new Ee(zn,zn),e),n=[];if(t&&!Vd(i,this._globalClipBounds))return n;for(const t of this._activeRegions){if(t.hiddenByOverlap)continue;if(!Vd(i,t))continue;const r=Hd(t.min,t.max,e);n.push({min:r.min,max:r.max,sourceId:this._sourceIds[t.priority],footprint:t.footprint,footprintTileId:t.tileId,order:t.order,clipMask:t.clipMask,clipScope:t.clipScope})}return n}setSources(e){this._setSources(e.map((e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const t=[];for(const i of e.cache.getVisibleCoordinates()){const n=e.cache.getTile(i).buckets[e.layer];n&&n.updateFootprints(i.toUnwrapped(),t)}return t},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope}))))}_addSource(e){const t=e.getFootprints();if(0===t.length)return;const i=e.getOrder(),n=e.getClipMask(),r=e.getClipScope();for(const e of t){if(!e.footprint)continue;const t=jd(e.footprint.min,e.footprint.max,e.id);this._activeRegions.push({min:t.min,max:t.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:e.id,footprint:e.footprint,order:i,clipMask:n,clipScope:r})}this._sourceIds.push(e.getSourceId())}_computeReplacement(){this._activeRegions.sort(((e,t)=>e.priority-t.priority||Ud(e.min,t.min)||Ud(e.max,t.max)||e.order-t.order||e.clipMask-t.clipMask||function(e,t){const i=(e,t)=>e+t;return e.length-t.length||e.reduce(i,"").localeCompare(t.reduce(i,""))}(e.clipScope,t.clipScope)));let e=this._activeRegions.length!==this._prevRegions.length;if(!e){let t=0;for(;!e&&t!==this._activeRegions.length;){const i=this._activeRegions[t],n=this._prevRegions[t];e=i.priority!==n.priority||!zd(i,n)||i.order!==n.order||i.clipMask!==n.clipMask||!Se(i.clipScope,n.clipScope),this._activeRegions[t].hiddenByOverlap=n.hiddenByOverlap,++t}}if(e){++this._updateTime;for(const e of this._activeRegions)e.order!==Fd&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,e.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,e.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,e.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,e.max.y));const e=e=>{const t=this._activeRegions;if(e>=t.length)return e;const i=t[e].priority;for(;e<t.length&&t[e].priority===i;)++e;return e};if(this._sourceIds.length>1){let t=0,i=e(t);for(;t!==i;){let n=t;const r=t;for(;n!==i;){const e=this._activeRegions[n];e.hiddenByOverlap=!1;for(let t=0;t<r;t++){const i=this._activeRegions[t];if(!i.hiddenByOverlap&&e.order===Fd&&Vd(e,i)&&(e.hiddenByOverlap=Wd(e.footprint,e.tileId,i.footprint,i.tileId),e.hiddenByOverlap))break}++n}t=i,i=e(t)}}}}_setSources(e){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let t=e.length-1;t>=0;t--)this._addSource(e[t]);this._computeReplacement()}},e.eP=Fd,e.eQ=class{constructor(e){this._createGrid(e),this._createPoles(e)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const e of this._poleSegments)e.destroy();for(const e of this._gridSegments)e.withSkirts.destroy(),e.withoutSkirts.destroy()}_fillGridMeshWithLods(e,t){const i=new pa,n=new Da,r=[],o=e+1+2,s=t[0]+1,a=t[0]+1+(1+t.length),l=(e,t,i)=>{let n=e===o-1?e-2:0===e?e:e-1;return n+=i?24575:0,[n,t]};for(let e=0;e<o;++e)i.emplaceBack(...l(e,0,!0));for(let e=0;e<s;++e)for(let t=0;t<o;++t)i.emplaceBack(...l(t,e,(0===t||t===o-1)&&!0));for(let e=0;e<t.length;++e){const n=t[e];for(let e=0;e<o;++e)i.emplaceBack(...l(e,n,!0))}for(let e=0;e<t.length;++e){const s=n.length,l=t[e]+1+2,c=new Da;for(let i=0;i<l-1;i++){const r=i===l-2,s=r?o*(a-t.length+e-i):o;for(let e=0;e<o-1;e++){const t=i*o+e;0===i||r||0===e||e===o-2?(c.emplaceBack(t+1,t,t+s),c.emplaceBack(t+s,t+s+1,t+1)):(n.emplaceBack(t+1,t,t+s),n.emplaceBack(t+s,t+s+1,t+1))}}const u=hl.simpleSegment(0,s,i.length,n.length-s);for(let e=0;e<c.uint16.length;e+=3)n.emplaceBack(c.uint16[e],c.uint16[e+1],c.uint16[e+2]);const h=hl.simpleSegment(0,s,i.length,n.length-s);r.push({withoutSkirts:u,withSkirts:h})}return{vertices:i,indices:n,segments:r}}_createGrid(e){const t=this._fillGridMeshWithLods(Zl,Jl);this._gridSegments=t.segments,this._gridBuffer=e.createVertexBuffer(t.vertices,Bu.members),this._gridIndexBuffer=e.createIndexBuffer(t.indices,!0)}_createPoles(e){const t=new Da;for(let e=0;e<=Zl;e++)t.emplaceBack(0,e+1,e+2);this._poleIndexBuffer=e.createIndexBuffer(t,!0);const i=new ka,n=new ka,r=new ka,o=new ka;this._poleSegments=[];for(let e=0,t=0;e<ql;e++){const s=360/(1<<e);i.emplaceBack(0,-Wl,0,.5,0),n.emplaceBack(0,-Wl,0,.5,1),r.emplaceBack(0,-Wl,0,.5,.5),o.emplaceBack(0,-Wl,0,.5,.5);for(let e=0;e<=Zl;e++){let t=e/Zl,a=0;const l=di(0,s,t),[c,u,h]=ec(oh,sh,l,Wl);i.emplaceBack(c,u,h,t,a),n.emplaceBack(c,u,h,t,1-a);const d=Ie(l);t=.5+.5*Math.sin(d),a=.5+.5*Math.cos(d),r.emplaceBack(c,u,h,t,a),o.emplaceBack(c,u,h,t,1-a)}this._poleSegments.push(hl.simpleSegment(t,0,66,64)),t+=66}this._poleNorthVertexBuffer=e.createVertexBuffer(i,Ou,!1),this._poleSouthVertexBuffer=e.createVertexBuffer(n,Ou,!1),this._texturedPoleNorthVertexBuffer=e.createVertexBuffer(r,Ou,!1),this._texturedPoleSouthVertexBuffer=e.createVertexBuffer(o,Ou,!1)}getGridBuffers(e,t){return[this._gridBuffer,this._gridIndexBuffer,t?this._gridSegments[e].withSkirts:this._gridSegments[e].withoutSkirts]}getPoleBuffers(e,t){return[t?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,t?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[e]]}},e.eR=Nd,e.eS=Re,e.eT=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},e.eU=Oe,e.eV=yc,e.eW=function(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e},e.eX=X,e.eY=tc,e.eZ=F,e.e_=A,e.ea=Sp,e.eb=np,e.ec=op,e.ed=rp,e.ee=_c,e.ef=function(e,t){if(e===t){var i=t[1],n=t[2],r=t[3],o=t[6],s=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=o,e[11]=t[14],e[12]=r,e[13]=s,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},e.eg=av,e.eh=ha,e.ei=qa,e.ej=256,e.ek=Ju,e.el=ba,e.em=m,e.en=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},e.eo=ka,e.ep=Ua,e.eq=_o,e.er=function(e,t,i,n,r){return De((e-t)/(i-t)*(r-n)+n,n,r)},e.es=ne,e.et=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=u*s-a*c,d=-u*o+a*l,p=c*o-s*l,f=i*h+n*d+r*p;return f?(e[0]=h*(f=1/f),e[1]=(-u*n+r*c)*f,e[2]=(a*n-r*s)*f,e[3]=d*f,e[4]=(u*i-r*l)*f,e[5]=(-a*i+r*o)*f,e[6]=p*f,e[7]=(-c*i+n*l)*f,e[8]=(s*i-n*o)*f,e):null},e.eu=2,e.ev=N,e.ew=ee,e.ex=v,e.ey=function(e,t){var n=new i(3);v(n,t);var r=1/n[0],o=1/n[1],s=1/n[2],a=t[0]*r,l=t[1]*o,c=t[2]*s,u=t[4]*r,h=t[5]*o,d=t[6]*s,p=t[8]*r,f=t[9]*o,m=t[10]*s,g=a+h+m,_=0;return g>0?(_=2*Math.sqrt(g+1),e[3]=.25*_,e[0]=(d-f)/_,e[1]=(p-c)/_,e[2]=(l-u)/_):a>h&&a>m?(_=2*Math.sqrt(1+a-h-m),e[3]=(d-f)/_,e[0]=.25*_,e[1]=(l+u)/_,e[2]=(p+c)/_):h>m?(_=2*Math.sqrt(1+h-a-m),e[3]=(p-c)/_,e[0]=(l+u)/_,e[1]=.25*_,e[2]=(d+f)/_):(_=2*Math.sqrt(1+m-a-h),e[3]=(l-u)/_,e[0]=(p+c)/_,e[1]=(d+f)/_,e[2]=.25*_),e},e.ez=function(e,i){var n=2*Math.acos(i[3]),r=Math.sin(n/2);return r>t?(e[0]=i[0]/r,e[1]=i[1]/r,e[2]=i[2]/r):(e[0]=1,e[1]=0,e[2]=0),n},e.f=function(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,((e,t)=>String.fromCharCode(Number("0x"+t)))))},e.f0=K,e.f1=jf,e.f2=function(e){const t=e.navigator?e.navigator.userAgent:null;return!!function(e){if(null==Qe){const t=e.navigator?e.navigator.userAgent:null;Qe=!!e.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")))}return Qe}(e)&&!(!t||!(t.match("Version/15.4")||t.match("Version/15.5")||t.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},e.f3=function(e,t){xt=e,bt=t},e.f4=nh,e.f5=ih,e.f6=function(e){const t=[0,0,0],i=c(new Float64Array(16));return h(i,e.pixelMatrix,e.globeMatrix),G(t,t,i),new Ee(t[0],t[1])},e.f7=function(){const e=Yp;e&&e.isPreloaded()&&1===e.numActive()&&(e.release(Wp),Yp=null)},e.f8=function(){Jp().acquire(Wp)},e.f9=Ts,e.fA=Pc,e.fB=function(e){let t=0;if(new Uint32Array(e,0,1)[0]!==xf){const i=new Uint32Array(e,0,7),[,,n,r,o,s]=i;t=i.byteLength+r+o+s+o,(n!==e.byteLength||t>=e.byteLength)&&qe("Invalid b3dm header information.")}return Af(e,t)},e.fC=function(e,t){const i=hm(e);for(const e of i){for(const t of e.meshes)dm(t);e.lights&&(e.lightMeshIndex=e.meshes.length,e.meshes.push(fm(e.lights,t)))}return i},e.fD=Rv,e.fE=Je,e.fF=Hp,e.fG=Es,e.fH=ms,e.fI=function(e){At(),null!=wt&&wt.then((t=>{t.keys().then((i=>{for(let n=0;n<i.length-e;n++)t.delete(i[n]).catch((e=>qe(e.message)))})).catch((e=>qe(e.message)))})).catch((e=>qe(e.message)))},e.fa=function(e,t,i=!1){if(_s===ms.deferred||_s===ms.loading||_s===ms.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");ys=gt.resolveURL(e),_s=ms.deferred,gs=t,xs(),i||ws()},e.fb=function(e){nf=gt.resolveURL(e),of||(of=new Xp(Jp(),new ni)),of.broadcast("setMeshoptUrl",nf)},e.fc=uf,e.fd=function(e){ef=gt.resolveURL(e),of||(of=new Xp(Jp(),new ni)),of.broadcast("setDracoUrl",ef)},e.fe=cf,e.ff=$p,e.fg=function(e){const t=St();if(!t)return;const i=t.delete(vt);e&&i.then((()=>e())).catch(e)},e.fh=qp,e.fi=es,e.fj=Th,e.fk=S_,e.fl=Vb,e.fm=Gb,e.fn=zm,e.fo=Nc,e.fp="hd_road_elevation",e.fq=tu,e.fr=Ge,e.fs=ld,e.ft=x_,e.fu=y_,e.fv=function(e,t,i,n,r,o,s,a=1,l,c,u){e.createArrays(),e.tilePixelRatio=zn/(512*e.overscaling),e.compareText={},e.iconsNeedLinear=!1;const h=e.layers[0].layout,d=e.layers[0]._unevaluatedLayout._values,p={};p.scaleFactor=a,p.textSizeScaleRange=h.get("text-size-scale-range"),p.iconSizeScaleRange=h.get("icon-size-scale-range");const[f,m]=p.textSizeScaleRange,[g,_]=p.iconSizeScaleRange;p.textScaleFactor=De(p.scaleFactor,f,m),p.iconScaleFactor=De(p.scaleFactor,g,_);const y=d["text-size"],v=d["icon-size"];if("composite"===e.textSizeData.kind){const{minZoom:t,maxZoom:i}=e.textSizeData;p.compositeTextSizes=[y.possiblyEvaluate(new Ss(t,{worldview:u}),o),y.possiblyEvaluate(new Ss(i,{worldview:u}),o)]}if("composite"===e.iconSizeData.kind){const{minZoom:t,maxZoom:i}=e.iconSizeData;p.compositeIconSizes=[v.possiblyEvaluate(new Ss(t,{worldview:u}),o),v.possiblyEvaluate(new Ss(i,{worldview:u}),o)]}p.layoutTextSize=y.possiblyEvaluate(new Ss(s+1,{worldview:u}),o),p.layoutIconSize=v.possiblyEvaluate(new Ss(s+1,{worldview:u}),o),p.textMaxSize=y.possiblyEvaluate(new Ss(18,{worldview:u}),o);const x=h.get("symbol-placement"),b="map"===h.get("text-rotation-alignment")&&"point"!==x,T=h.get("text-size");let w=!1;const E=[];for(const s of e.features){const a=h.get("text-font").evaluate(s,{},o).join(","),f=T.evaluate(s,{},o)*p.textScaleFactor,m=p.layoutTextSize.evaluate(s,{},o)*p.textScaleFactor,g=p.layoutIconSize.evaluate(s,{},o)*p.iconScaleFactor,_={horizontal:{},vertical:void 0},y=s.text;let v,S=[0,0];if(y){const n=y.toString(),c=h.get("text-letter-spacing").evaluate(s,{},o)*mg,u=h.get("text-line-height").evaluate(s,{},o)*mg,d=as(n)?c:0,p=h.get("text-anchor").evaluate(s,{},o),g=h.get("text-variable-anchor");if(!g){const e=h.get("text-radial-offset").evaluate(s,{},o);if(e)S=$_(p,[e*mg,G_]);else{const e=h.get("text-offset").evaluate(s,{},o);S=[e[0]*mg,e[1]*mg]}}let v=b?"center":h.get("text-justify").evaluate(s,{},o);const T="point"===x,w=T?h.get("text-max-width").evaluate(s,{},o)*mg:1/0,E=o=>{e.allowVerticalPlacement&&ss(n)&&(_.vertical=jg(y,t,i,r,a,w,u,p,o,d,S,zg.vertical,!0,m,f,l))};if(!b&&g){const e="auto"===v?g.map((e=>ey(e))):[v];let n=!1;for(let o=0;o<e.length;o++){const s=e[o];if(!_.horizontal[s])if(n)_.horizontal[s]=_.horizontal[0];else{const e=jg(y,t,i,r,a,w,u,"center",s,d,S,zg.horizontal,!1,m,f,l);e&&(_.horizontal[s]=e,n=1===e.positionedLines.length)}}E("left")}else{if("auto"===v&&(v=ey(p)),T||h.get("text-writing-mode").indexOf("horizontal")>=0||!ss(n)){const e=jg(y,t,i,r,a,w,u,p,v,d,S,zg.horizontal,!1,m,f,l);e&&(_.horizontal[v]=e)}E(T?"left":v)}}let A,M,I,C,P,L,R=!1;const O=h.get("icon-text-fit").evaluate(s,{},o);if(s.icon&&s.icon.hasPrimary()){const t=Y_(s.icon,e.iconSizeData,d["icon-size"],o,e.zoom,s,l,p.iconScaleFactor,u);A=t.iconPrimary,I=t.iconSecondary;const i=A.toString();if(M=n.get(i),M&&(P=h.get("icon-offset").evaluate(s,{},o),L=h.get("icon-anchor").evaluate(s,{},o),v=e_(r.get(i),I?r.get(I.toString()):void 0,P,L),R=M.sdf,void 0===e.sdfIcons?e.sdfIcons=M.sdf:e.sdfIcons!==M.sdf&&qe("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(M.pixelRatio!==e.pixelRatio||0!==h.get("icon-rotate").constantOr(1))&&(e.iconsNeedLinear=!0)),I){const e=I.toString();C=n.get(e)}}w=w||!(!s.icon||!s.icon.hasSecondary());const D=sy(_.horizontal)||_.vertical;e.iconsInText||(e.iconsInText=!!D&&D.iconsInText);const B=m*p.textScaleFactor/mg,{defaultShapedIcon:F,verticallyShapedIcon:N}=ty(e,v,h,s,o,_,B,P,O);"none"!==O&&v&&(i_(v)||n_(v))&&(q_(0,M,A,v,F,O,c,n,r),q_(0,C,I,v,F,O,c,n,r),N&&(q_(0,M,A,v,N,O,c,n,r),q_(0,C,I,v,N,O,c,n,r))),v=F;const{iconBBox:k,iconVerticalBBox:U}=W_(e,v,N,h,s,o,g,P,p,r,L);E.push({feature:s,shapedTextOrientations:_,shapedText:D,shapedIcon:v,iconPrimary:A,iconSecondary:I,iconOffset:P,iconAnchor:L,verticallyShapedIcon:N,layoutTextSize:m,layoutIconSize:g,textOffset:S,isSDFIcon:R,iconTextFit:O,iconCollisionBounds:k,iconVerticalCollisionBounds:U})}return{featureData:E,sizes:p,hasAnySecondaryIcon:w,textAlongLine:b,symbolPlacement:x}},e.fw=b_,e.fx=function(e,t,i,n,r,o,s,a,l,c){e.iconAtlasPositions=c.iconPositions;const{featureData:u,hasAnySecondaryIcon:h,sizes:d,textAlongLine:p,symbolPlacement:f}=t;for(const t of u){const{shapedIcon:i,verticallyShapedIcon:o,feature:u,shapedTextOrientations:m,shapedText:g,layoutTextSize:_,textOffset:y,isSDFIcon:v,iconPrimary:x,iconSecondary:b,iconTextFit:T,iconOffset:w,iconCollisionBounds:E,iconVerticalCollisionBounds:S}=t;J_(i,c.iconPositions,x,b),J_(o,c.iconPositions,x,b),K_(m,c.iconPositions),Z_(x,b,c.iconPositions),(g||i)&&iy(e,u,m,i,o,l,d,_,0,y,v,n,r,s,a,h,T,w,p,f,E,S)}i&&e.generateCollisionDebugBuffers(o,e.collisionBoxArray,d.textScaleFactor)},e.fy=Bc,e.fz=Xx,e.g=function(e,t){return kt(Object.assign(e,{method:"GET"}),t)},e.h=function(e){return 0===e.indexOf("mapbox:")},e.i=function(e){return st.API_STYLE_REGEX.test(e)&&!lt(e)},e.j=at,e.k=It,e.l=function(e){return decodeURIComponent(atob(e).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""))},e.m=function(e,t){return kt(Object.assign(e,{type:"json"}),t)},e.n=Ht,e.o=gt,e.p=function(e,t){return kt(Object.assign(e,{method:"POST"}),t)},e.q=wh,e.r=mt,e.s=function(e){try{const t=self[e];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch(e){return!1}},e.t=function(){return Zp||(Zp=new qp),Zp},e.u=function(){return function e(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()},e.v=function(e){return!!e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)},e.w=qe,e.x=Fx,e.y=ei,e.z=Qt})),n(["./shared"],(function(e){function t(e){const t=e?e.url.toString():void 0;return t?performance.getEntriesByName(t):[]}function i(e){if("number"==typeof e||"boolean"==typeof e||"string"==typeof e||null==e)return JSON.stringify(e);if(Array.isArray(e)){let t="[";for(const n of e)t+=`${i(n)},`;return`${t}]`}let t="{";for(const n of Object.keys(e).sort())t+=`${n}:${i(e[n])},`;return`${t}}`}function n(t){let n="";for(const r of e.bw)n+=`/${i(t[r])}`;return n}class r{constructor(e){this.keyCache={},this._layers={},this._layerConfigs={},e&&this.replace(e)}replace(e,t){this._layerConfigs={},this._layers={},this.update(e,[],t)}update(t,r,o){this._options=o;for(const i of t)this._layerConfigs[i.id]=i,(this._layers[i.id]=e.dt(i,this.scope,null,this._options)).compileFilter(o),this.keyCache[i.id]&&delete this.keyCache[i.id];for(const e of r)delete this.keyCache[e],delete this._layerConfigs[e],delete this._layers[e];this.familiesBySource={};const s=function(e,t){const r={};for(let o=0;o<e.length;o++){const s=e[o];let a=t&&t[s.id];a||("symbol"===s.type?a=s.id:(a=n(s),"line"===s.type&&s.paint&&function e(t){return"string"==typeof t&&"line-progress"===t||(Array.isArray(t)?t.some(e):!(!t||"object"!=typeof t)&&Object.values(t).some(e))}(s.paint["line-width"])&&(a+=`/${i(s.paint["line-width"])}`))),t&&(t[s.id]=a);let l=r[a];l||(l=r[a]=[]),l.push(s)}const o=[];for(const e in r)o.push(r[e]);return o}(Object.values(this._layerConfigs),this.keyCache);for(const e of s){const t=e.map((e=>this._layers[e.id])),i=t[0];if("none"===i.visibility)continue;const n=i.source||"";let r=this.familiesBySource[n];r||(r=this.familiesBySource[n]={});const o=i.sourceLayer||"_geojsonTileLayer";let s=r[o];s||(s=r[o]=[]),s.push(t)}}}const o=1*e.fk;class s{constructor(t){const i={},n=[];for(const e in t){const r=t[e],s=i[e]={};for(const e in r.glyphs){const t=r.glyphs[+e];if(!t||0===t.bitmap.width||0===t.bitmap.height)continue;const i=t.metrics.localGlyph?o:1,a={x:0,y:0,w:t.bitmap.width+2*i,h:t.bitmap.height+2*i};n.push(a),s[e]=a}}const{w:r,h:s}=e.G(n),a=new e.fj({width:r||1,height:s||1});for(const n in t){const r=t[n];for(const t in r.glyphs){const s=r.glyphs[+t];if(!s||0===s.bitmap.width||0===s.bitmap.height)continue;const l=i[n][t],c=s.metrics.localGlyph?o:1;e.fj.copy(s.bitmap,a,{x:0,y:0},{x:l.x+c,y:l.y+c},s.bitmap)}}this.image=a,this.positions=i}}function a(e,t,i){e[t]?i&&(e[t].center=i):e[t]={floorIds:new Set,center:i||[0,0],floors:{}}}function l(e,t,i,n){for(const r of t)a(e,r),e[r].floors[i]=n,e[r].floorIds.add(i)}function c(e){return{id:e.properties.id.toString(),center:e.properties.center.toString().split(";").map(Number)}}function u(e){return{id:e.properties.id.toString(),isDefault:!!e.properties.is_default&&e.properties.is_default,connections:e.properties.connected_floor_ids?new Set(e.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:e.properties.conflicted_floor_ids?new Set(e.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:e.properties.building_ids?new Set(e.properties.building_ids.toString().split(";")):new Set,name:e.properties.name.toString(),zIndex:e.properties.z_index}}function h(e,t){return t.every((t=>e.properties&&null!=e.properties[t]))}function d(e){return h(e,["type","id","name"])&&"building"===e.properties.type}function p(e){return h(e,["type","id","name","z_index"])&&"floor"===e.properties.type}e.fi(s,"GlyphAtlas");class f{constructor(t){this.tileID=new e.aP(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.lut=t.lut,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.scope=t.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.request&&t.request.collectResourceTiming,this.promoteId=t.promoteId,this.isSymbolTile=t.isSymbolTile,this.tileTransform=e.aY(t.tileID.canonical,t.projection),this.projection=t.projection,this.worldview=t.worldview,this.localizableLayerIds=t.localizableLayerIds,this.brightness=t.brightness,this.extraShadowCaster=!!t.extraShadowCaster,this.tessellationStep=t.tessellationStep,this.scaleFactor=t.scaleFactor,this.worldview=t.worldview,this.indoor=t.indoor}parse(t,i,n,r,o,h){this.status="parsing",this.data=t,this.collisionBoxArray=new e.b2;const f=new e.fl(Object.keys(t.layers).sort()),g=new e.fm(this.tileID,this.promoteId);g.bucketLayerIDs=[];const _={},y=new e.fn(256,256),v={featureIndex:g,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:y,availableImages:n,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){const i=this.indoor.indoorState.activeFloorsVisible,n=function(t,i,n){const r=function(t,i){if(!t)return e.w("No source layers defined in indoor specification"),i;if(0===t.size)return i;const n=t.difference(i);for(const t of n)e.w(`Missing source layer required in indoor specification: ${t}`);return i.intersection(i)}(i.sourceLayers,new Set(Object.keys(t.layers))),o=i.indoorState,s=function(t,i,n,r){const o=new Set,s=new Set,h=new Set,f=new Map,m={},g=e=>{const t=f.get(e)||new Set;for(const i of o)if((f.get(i)||new Set).has(e)||t.has(i))return!0;return!1};for(const n of i){const i=t.layers[n];if(i)for(let e=0;e<i.length;e++){const t=i.feature(e);if(d(t)){const{id:e,center:i}=c(t);a(m,e,i),o.add(e)}else if(p(t)){const{id:e,isDefault:i,connections:n,conflicts:a,buildings:c,name:d,zIndex:p}=u(t);l(m,c,e,{name:d,zIndex:p}),f.set(e,a),(e===r||n.has(r))&&o.add(e),s.add(e),i&&h.add(e)}}else e.w(`indoor source layer not found: ${n}`)}if(n)for(const e of n)s.has(e)&&(g(e)||o.add(e));for(const e of h)o.has(e)||g(e)||o.add(e);return{buildings:m,activeFloors:o}}(t,r,o.lastActiveFloors,o.selectedFloorId);return n.send("setIndoorData",s),s}(t,this.indoor,o);v.activeFloors=i?n.activeFloors:void 0}const x=[],b=i.familiesBySource[this.source];for(const i in b){const o=t.layers[i];if(!o)continue;let s=!1,a=!1,l=!1;for(const e of b[i])"symbol"===e[0].type?s=!0:a=!0,e[0].is3D()&&"model"!==e[0].type&&(l=!0);if(this.extraShadowCaster&&!l)continue;if(!0===this.isSymbolTile&&!s)continue;if(!1===this.isSymbolTile&&!a)continue;1===o.version&&e.w(`Vector tile source "${this.source}" layer "${i}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const c=f.encode(i),u=[];let h=!1;for(let t=0,n=0;t<o.length;t++){const r=o.feature(t),s=g.getId(r,i);if(this.localizableLayerIds&&this.localizableLayerIds.has(i)){const e=r.properties?r.properties.worldview:null;if(this.worldview&&"string"==typeof e)if("all"===e)r.properties.$localized=!0;else{if(!e.split(",").includes(this.worldview))continue;r.properties.$localized=!0,r.properties.worldview=this.worldview}}!h&&r.properties&&r.properties.hasOwnProperty(e.fo)&&(h=!0),u.push({feature:r,id:s,index:n,sourceLayerIndex:c}),n++}h&&!v.elevationFeatures&&t.layers.hasOwnProperty(e.fp)&&(v.elevationFeatures=e.fq.parseFrom(t.layers[e.fp],this.canonical));for(const t of b[i]){const i=t[0];if(this.extraShadowCaster&&(!i.is3D()||"model"===i.type))continue;if(void 0!==this.isSymbolTile&&"symbol"===i.type!==this.isSymbolTile)continue;if(i.minzoom&&this.zoom<Math.floor(i.minzoom))continue;if(i.maxzoom&&this.zoom>=i.maxzoom)continue;if("none"===i.visibility)continue;m(t,this.zoom,v.brightness,n,this.worldview);const o=_[i.id]=i.createBucket({index:g.bucketLayerIDs.length,layers:t,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:c,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:r,worldview:this.worldview});g.bucketLayerIDs.push(t.map((t=>e.B(t.id,t.scope))));let s=o.prepare?o.prepare():null;null!=s?(s=s.then((()=>o.populate(u,v,this.tileID.canonical,this.tileTransform))),x.push(s)):o.populate(u,v,this.tileID.canonical,this.tileTransform)}}const T=()=>{let i,r,a,l,c,u;y.trim();const d={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},p=()=>{if(i)return this.status="done",h(i);if(this.extraShadowCaster)this.status="done",h(null,{buckets:Object.values(_).filter((e=>!e.isEmpty())),featureIndex:g,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:v.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(r&&a&&l){const t=new s(r),i=new Map;for(const[t,n]of a.entries()){const{imagePosition:r}=e.ft(t,n,e.fu);i.set(t,r)}const h={};for(const o in _){const s=_[o];s instanceof e.b3&&(m(s.layers,this.zoom,v.brightness,n,this.worldview),h[o]=e.fv(s,r,t.positions,a,i,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,c,this.worldview))}const d={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(o,a,c,(()=>{d.iconsPending=!1,x(h,t,d)})),this.rasterizeIfNeeded(o,l,u,(()=>{d.patternsPending=!1,x(h,t,d)}))}},x=(t,i,r,o)=>{if(r.iconsPending||r.patternsPending)return;const s=new e.fw(a,l,this.lut);for(const i in _){const r=_[i];if(i in t)e.fx(r,t[i],this.showCollisionBoxes,n,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,a,s);else if(r.hasPattern&&(r instanceof e.b9||r instanceof e.ba||r instanceof e.e9)){m(r.layers,this.zoom,v.brightness,n,this.worldview);const e=Object.fromEntries(s.patternPositions);r.addFeatures(v,this.tileID.canonical,e,n,this.tileTransform,this.brightness)}}this.status="done",h(null,{buckets:Object.values(_).filter((e=>!e.isEmpty())),featureIndex:g,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:i.image,lineAtlas:y,imageAtlas:s,brightness:v.brightness})};if(!this.extraShadowCaster){const t=e.fr(v.glyphDependencies,(e=>Object.keys(e).map(Number)));Object.keys(t).length?o.send("getGlyphs",{uid:this.uid,stacks:t},((e,t)=>{i||(i=e,r=t,p())}),void 0,!1,d):r={};const n=Array.from(v.iconDependencies.keys()).map((t=>e.I.parse(t)));n.length?o.send("getImages",{images:n,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((e,t)=>{i||(i=e,a=new Map,c=this.updateImageMapAndGetImageTaskQueue(a,t,v.iconDependencies),p())}),void 0,!1,d):(a=new Map,c=new Map);const s=Array.from(v.patternDependencies.keys()).map((t=>e.I.parse(t)));s.length?o.send("getImages",{images:s,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((e,t)=>{i||(i=e,l=new Map,u=this.updateImageMapAndGetImageTaskQueue(l,t,v.patternDependencies),p())}),void 0,!1,d):(l=new Map,u=new Map)}if(v.elevationFeatures&&v.elevationFeatures.length>0){const i=[];for(const t of Object.values(_))if(t instanceof e.ba){const e=t.getUnevaluatedPortalGraph();e&&i.push(e)}const n=e.fs.evaluate(i);for(const i of Object.values(_))if(i instanceof e.ba){const e=t.layers[f.decode(i.sourceLayerIndex)];i.setEvaluatedPortalGraph(n,e,this.tileID.canonical,v.availableImages,v.brightness)}}p()};x.length>0?Promise.allSettled(x).then(T).catch(h):T()}updateParameters(t){this.scaleFactor=t.scaleFactor,this.showCollisionBoxes=t.showCollisionBoxes,this.projection=t.projection,this.brightness=t.brightness,this.tileTransform=e.aY(t.tileID.canonical,t.projection),this.extraShadowCaster=t.extraShadowCaster,this.lut=t.lut,this.worldview=t.worldview,this.indoor=t.indoor}rasterizeIfNeeded(e,t,i,n){Array.from(t.values()).some((e=>e.usvg))?this.rasterize(e,t,i,n):n()}updateImageMapAndGetImageTaskQueue(e,t,i){const n=new Map;for(const r of t.keys()){const o=i.get(r)||[];for(const i of o){const r=i.toString(),o=t.get(i.id.toString());o.usvg?n.has(r)||(n.set(r,i),e.set(r,Object.assign({},o))):e.set(r,o)}}return n}rasterize(e,t,i,n){this.rasterizeTask=e.send("rasterizeImages",{scope:this.scope,tasks:i},((e,i)=>{if(!e)for(const[e,n]of i.entries()){const i=Object.assign(t.get(e),{data:n});t.set(e,i)}n()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function m(t,i,n,r,o){const s=new e.ac(i,{brightness:n,worldview:o});for(const e of t)e.recalculate(s,r)}class g extends e.E{constructor(t,i,n,r,o,s,a){super(),this.actor=t,this.layerIndex=i,this.availableImages=n,this.availableModels=r,this.loadVectorData=s||e.aL,this.loading={},this.loaded={},this.deduped=new e.aK(t.scheduler),this.isSpriteLoaded=o,this.scheduler=t.scheduler,this.brightness=a}loadTile(i,n){const r=i.uid,o=i&&i.request,s=o&&o.collectResourceTiming,a=this.loading[r]=new f(i);a.abort=this.loadVectorData(i,((l,c)=>{const u=!this.loading[r];if(delete this.loading[r],a.cancelRasterize(),u||l||!c)return a.status="done",u||(this.loaded[r]=a),n(l);const h=c.rawData,d={},p=e.aM(c.responseHeaders);p&&p.expires&&(d.expires=p.expires),p&&p.cacheControl&&(d.cacheControl=p.cacheControl),a.vectorTile=c.vectorTile||new e.fy(new e.bs(h));const f=()=>{a.parse(a.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,((e,i)=>{if(e||!i)return n(e);const r={};if(s){const e=t(o);e.length>0&&(r.resourceTiming=JSON.parse(JSON.stringify(e)))}n(null,Object.assign({rawTileData:h.slice(0),responseHeaders:c.responseHeaders},i,d,r))}))};this.isSpriteLoaded?f():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(f,{type:"parseTile",isSymbolTile:i.isSymbolTile,zoom:i.tileZoom}):f()})),this.loaded=this.loaded||{},this.loaded[r]=a}))}reloadTile(e,t){const i=this.loaded,n=e.uid;if(i&&i[n]){const r=i[n];r.updateParameters(e);const o=(e,i)=>{const n=r.reloadCallback;n&&(delete r.reloadCallback,r.parse(r.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,n)),t(e,i)};"parsing"===r.status?r.reloadCallback=o:"done"===r.status&&(r.vectorTile?r.parse(r.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,o):o())}else t(null,void 0)}abortTile(e,t){const i=e.uid,n=this.loading[i];n&&(n.abort&&n.abort(),delete this.loading[i]),t()}removeTile(e,t){const i=this.loaded,n=e.uid;i&&i[n]&&delete i[n],t()}}class _{loadTile(t,i){const{uid:n,encoding:r,rawImageData:o,padding:s}=t,a=ImageBitmap&&o instanceof ImageBitmap?this.getImageData(o,s):o;i(null,new e.fz(n,a,r,s<1))}reloadTile(e,t){t(null,null)}abortTile(e,t){t()}removeTile(e,t){t()}getImageData(e,t){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(e.width,e.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=e.width,this.offscreenCanvas.height=e.height,this.offscreenCanvasContext.drawImage(e,0,0,e.width,e.height);const i=this.offscreenCanvasContext.getImageData(-t,-t,e.width+2*t,e.height+2*t);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),i}}e.br.setPbf(e.bs);class y{constructor(t){this._mrt=new e.br(t.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=t.uid,this.tileID=t.tileID,this.source=t.source}parse(t,i){const n=this._mrt;this.status="parsing",this._entireBuffer=t;try{n.parseHeader(t),this._isHeaderLoaded=!0;const r=[];for(const i in n.layers){const o=n.getLayer(i),s=o.getDataRange(o.getBandList()),a=n.createDecodingTask(s),l=t.slice(s.firstByte,s.lastByte+1),c=e.br.performDecoding(l,a).then((e=>a.complete(null,e))).catch((e=>a.complete(e,null)));r.push(c)}Promise.allSettled(r).then((()=>i(null,n))).catch((e=>i(e)))}catch(e){i(e)}}}class v{constructor(e){this.actor=e,this.loading={},this.loaded={}}loadTile(t,i){const n=t.uid,r=t.request,o=this.loading[n]=new y(t),{cancel:s}=e.bt(r,((e,t,r)=>{const s=!this.loading[n];if(delete this.loading[n],s||e||!t)return o.status="done",s||(this.loaded[n]=o),i(e);o.parse(t,((e,t)=>{if(e||!t)return i(e);i(null,t,r)})),this.loaded[n]=o}));o.abort=s}reloadTile(e,t){t(null,void 0)}abortTile(e,t){const i=e.uid,n=this.loading[i];n&&(n.abort&&n.abort(),delete this.loading[i]),t()}removeTile(e,t){const i=e.uid;this.loaded[i]&&delete this.loaded[i],t()}decodeRasterArray(t,i){e.br.performDecoding(t.buffer,t.task).then((e=>i(null,e))).catch((e=>i(e)))}}const x=e.fA.prototype.toGeoJSON;class b{constructor(t){this._feature=t,this.extent=e.al,this.type=t.type,this.properties=t.tags,"id"in t&&!isNaN(t.id)&&(this.id=parseInt(t.id,10))}loadGeometry(){if(1===this._feature.type){const t=[];for(const i of this._feature.geometry)t.push([new e.P(i[0],i[1])]);return t}{const t=[];for(const i of this._feature.geometry){const n=[];for(const t of i)n.push(new e.P(t[0],t[1]));t.push(n)}return t}}toGeoJSON(e,t,i){return x.call(this,e,t,i)}}class T{constructor(t,i){this.name=t,this.extent=e.al,this.length=i.length,this._jsonFeatures=i}feature(e){return new b(this._jsonFeatures[e])}}class w{constructor(t){this.layers={},this.extent=e.al;for(const e of Object.keys(t))this.layers[e]=new T(e,t[e])}}const E=64/4096,S=128;class A{constructor(){this.features=new Map}clear(){this.features.clear()}load(e=[],t){for(const i of e){const e=i.id;if(null==e)continue;let n=this.features.get(e);n&&this.updateCache(n,t),i.geometry?(n=I(i),this.updateCache(n,t),this.features.set(e,n)):this.features.delete(e),this.updateCache(n,t)}}updateCache(e,t){for(const{canonical:i,uid:n}of Object.values(t)){const{z:r,x:o,y:s}=i;M(e,Math.pow(2,r),o,s)&&delete t[n]}}getTile(e,t,i){const n=Math.pow(2,e),r=[];for(const e of this.features.values())M(e,n,t,i)&&r.push(R(e,n,t,i));return{features:r}}getFeatures(){return[...this.features.values()]}}function M({minX:e,minY:t,maxX:i,maxY:n},r,o,s){return e<(o+1+E)/r&&t<(s+1+E)/r&&i>(o-E)/r&&n>(s-E)/r}function I(e){const{id:t,geometry:i,properties:n}=e;if(!i)return;if("GeometryCollection"===i.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:r,coordinates:o}=i,s={id:t,type:1,geometry:[],tags:n,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},a=s.geometry;if("Point"===r)C(o,a,s);else if("MultiPoint"===r)for(const e of o)C(e,a,s);else if("LineString"===r)s.type=2,P(o,a,s);else if("MultiLineString"===r)s.type=2,L(o,a,s);else if("Polygon"===r)s.type=3,L(o,a,s,!0);else{if("MultiPolygon"!==r)throw new Error("Input data is not a valid GeoJSON object.");s.type=3;for(const e of o)L(e,a,s,!0)}return s}function C([t,i],n,r){const o=e.aF(t);let s=e.aJ(i);s=s<0?0:s>1?1:s,n.push(o,s),r.minX=Math.min(r.minX,o),r.minY=Math.min(r.minY,s),r.maxX=Math.max(r.maxX,o),r.maxY=Math.max(r.maxY,s)}function P(e,t,i,n=!1,r=!1){const o=[];for(const t of e)C(t,o,i);t.push(o),n&&function(e,t){let i=0;for(let t=0,n=e.length,r=n-2;t<n;r=t,t+=2)i+=(e[t]-e[r])*(e[t+1]+e[r+1]);if(i>0===t)for(let t=0,i=e.length;t<i/2;t+=2){const n=e[t],r=e[t+1];e[t]=e[i-2-t],e[t+1]=e[i-1-t],e[i-2-t]=n,e[i-1-t]=r}}(o,r)}function L(e,t,i,n=!1){for(let r=0;r<e.length;r++)P(e[r],t,i,n,0===r)}function R(t,i,n,r){const{id:o,type:s,geometry:a,tags:l}=t,c=[];if(1===s)!function(t,i,n,r,o){for(let s=0;s<t.length;s+=2){const a=Math.round(e.al*(t[s+0]*i-n)),l=Math.round(e.al*(t[s+1]*i-r));o.push([a,l])}}(a,i,n,r,c);else for(const e of a)O(e,i,n,r,c);return{id:o,type:s,geometry:c,tags:l}}function O(t,i,n,r,o){const s=-S,a=e.al+S;let l;for(let c=0;c<t.length-2;c+=2){let u=Math.round(e.al*(t[c+0]*i-n)),h=Math.round(e.al*(t[c+1]*i-r)),d=Math.round(e.al*(t[c+2]*i-n)),p=Math.round(e.al*(t[c+3]*i-r));const f=d-u,m=p-h;u<s&&d<s||(u<s?(h+=Math.round(m*((s-u)/f)),u=s):d<s&&(p=h+Math.round(m*((s-u)/f)),d=s),h<s&&p<s||(h<s?(u+=Math.round(f*((s-h)/m)),h=s):p<s&&(d=u+Math.round(f*((s-h)/m)),p=s),u>=a&&d>=a||(u>=a?(h+=Math.round(m*((a-u)/f)),u=a):d>=a&&(p=h+Math.round(m*((a-u)/f)),d=a),h>=a&&p>=a||(h>=a?(u+=Math.round(f*((a-h)/m)),h=a):p>=a&&(d=u+Math.round(f*((a-h)/m)),p=a),l&&u===l[l.length-1][0]&&h===l[l.length-1][1]||(l=[[u,h]],o.push(l)),l.push([d,p])))))}}function D({name:t,features:i},n){n.writeStringField(1,t),n.writeVarintField(5,e.al);const r=new Map,o=new Map,s={keys:r,values:o,feature:null};for(const e of i)s.feature=e,n.writeMessage(2,B,s);for(const e of r.keys())n.writeStringField(3,e);for(const e of o.keys())n.writeMessage(4,z,e)}function B(e,t){const i=e.feature;void 0!==i.id&&Number.isSafeInteger(+i.id)&&t.writeVarintField(1,+i.id),i.tags&&t.writeMessage(2,F,e),t.writeVarintField(3,i.type),t.writeMessage(4,U,i)}function F({keys:e,values:t,feature:i},n){for(const r of Object.keys(i.tags)){let o=i.tags[r];if(null===o)continue;let s=e.get(r);void 0===s&&(s=e.size,e.set(r,s)),n.writeVarint(s);const a=typeof o;"string"!==a&&"boolean"!==a&&"number"!==a&&(o=JSON.stringify(o));let l=t.get(o);void 0===l&&(l=t.size,t.set(o,l)),n.writeVarint(l)}}function N(e,t){return(t<<3)+(7&e)}function k(e){return e<<1^e>>31}function U(e,t){const{geometry:i,type:n}=e;let r=0,o=0;if(1===n){t.writeVarint(N(1,i.length));for(const e of i){const i=e[0]-r,n=e[1]-o;t.writeVarint(k(i)),t.writeVarint(k(n)),r+=i,o+=n}}else for(const e of i){t.writeVarint(N(1,1));const i=e.length-(3===n?1:0);for(let n=0;n<i;n++){1===n&&t.writeVarint(N(2,i-1));const s=e[n][0]-r,a=e[n][1]-o;t.writeVarint(k(s)),t.writeVarint(k(a)),r+=s,o+=a}3===n&&t.writeVarint(N(7,1))}}function z(e,t){const i=typeof e;"string"===i?t.writeStringField(1,e):"boolean"===i?t.writeBooleanField(7,e):"number"===i&&(e%1!=0?t.writeDoubleField(3,e):e<0?t.writeSVarintField(6,e):t.writeVarintField(5,e))}const V={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:e=>e},G=Math.fround||(j=new Float32Array(1),e=>(j[0]=+e,j[0]));var j;const H=3,$=5,W=6;class q{constructor(e){this.options=Object.assign(Object.create(V),e),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(e){const{minZoom:t,maxZoom:i}=this.options;this.points=e;const n=[];for(let t=0;t<e.length;t++){const i=e[t];if(!i.geometry)continue;const[r,o]=i.geometry.coordinates,s=G(Z(r)),a=G(J(o));n.push(s,a,1/0,t,-1,1),this.options.reduce&&n.push(0)}let r=this.trees[i+1]=this._createTree(n);for(let e=i;e>=t;e--)r=this.trees[e]=this._createTree(this._cluster(r,e));return this}getClusters(e,t){let i=((e[0]+180)%360+360)%360-180;const n=Math.max(-90,Math.min(90,e[1]));let r=180===e[2]?180:((e[2]+180)%360+360)%360-180;const o=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)i=-180,r=180;else if(i>r){const e=this.getClusters([i,n,180,o],t),s=this.getClusters([-180,n,r,o],t);return e.concat(s)}const s=this.trees[this._limitZoom(t)],a=s.range(Z(i),J(o),Z(r),J(n)),l=s.data,c=[];for(const e of a){const t=this.stride*e;c.push(l[t+$]>1?X(l,t,this.clusterProps):this.points[l[t+H]])}return c}getChildren(e){const t=this._getOriginId(e),i=this._getOriginZoom(e),n="No cluster with the specified id.",r=this.trees[i];if(!r)throw new Error(n);const o=r.data;if(t*this.stride>=o.length)throw new Error(n);const s=this.options.radius/(this.options.extent*Math.pow(2,i-1)),a=r.within(o[t*this.stride],o[t*this.stride+1],s),l=[];for(const t of a){const i=t*this.stride;o[i+4]===e&&l.push(o[i+$]>1?X(o,i,this.clusterProps):this.points[o[i+H]])}if(0===l.length)throw new Error(n);return l}getLeaves(e,t,i){const n=[];return this._appendLeaves(n,e,t=t||10,i=i||0,0),n}getTile(e,t,i){const n=this.trees[this._limitZoom(e)],r=Math.pow(2,e),{extent:o,radius:s}=this.options,a=s/o,l=(i-a)/r,c=(i+1+a)/r,u={features:[]};return this._addTileFeatures(n.range((t-a)/r,l,(t+1+a)/r,c),n.data,t,i,r,u),0===t&&this._addTileFeatures(n.range(1-a/r,l,1,c),n.data,r,i,r,u),t===r-1&&this._addTileFeatures(n.range(0,l,a/r,c),n.data,-1,i,r,u),u.features.length?u:null}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){const i=this.getChildren(e);if(t++,1!==i.length)break;e=i[0].properties.cluster_id}return t}_appendLeaves(e,t,i,n,r){const o=this.getChildren(t);for(const t of o){const o=t.properties;if(o&&o.cluster?r+o.point_count<=n?r+=o.point_count:r=this._appendLeaves(e,o.cluster_id,i,n,r):r<n?r++:e.push(t),e.length===i)break}return r}_createTree(t){const i=new e.c3(t.length/this.stride|0,this.options.nodeSize,Float32Array);for(let e=0;e<t.length;e+=this.stride)i.add(t[e],t[e+1]);return i.finish(),i.data=t,i}_addTileFeatures(e,t,i,n,r,o){for(const s of e){const e=s*this.stride,a=t[e+$]>1;let l,c,u;if(a)l=Y(t,e,this.clusterProps),c=t[e],u=t[e+1];else{const i=this.points[t[e+H]];l=i.properties;const[n,r]=i.geometry.coordinates;c=Z(n),u=J(r)}const h={type:1,geometry:[[Math.round(this.options.extent*(c*r-i)),Math.round(this.options.extent*(u*r-n))]],tags:l};let d;d=a||this.options.generateId?t[e+H]:this.points[t[e+H]].id,void 0!==d&&(h.id=d),o.features.push(h)}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(Math.floor(+e),this.options.maxZoom+1))}_cluster(e,t){const{radius:i,extent:n,reduce:r,minPoints:o}=this.options,s=i/(n*Math.pow(2,t)),a=e.data,l=[],c=this.stride;for(let i=0;i<a.length;i+=c){if(a[i+2]<=t)continue;a[i+2]=t;const n=a[i],u=a[i+1],h=e.within(a[i],a[i+1],s),d=a[i+$];let p=d;for(const e of h){const i=e*c;a[i+2]>t&&(p+=a[i+$])}if(p>d&&p>=o){let e,o=n*d,s=u*d,f=-1;const m=(i/c<<5)+(t+1)+this.points.length;for(const n of h){const l=n*c;if(a[l+2]<=t)continue;a[l+2]=t;const u=a[l+$];o+=a[l]*u,s+=a[l+1]*u,a[l+4]=m,r&&(e||(e=this._map(a,i,!0),f=this.clusterProps.length,this.clusterProps.push(e)),r(e,this._map(a,l)))}a[i+4]=m,l.push(o/p,s/p,1/0,m,-1,p),r&&l.push(f)}else{for(let e=0;e<c;e++)l.push(a[i+e]);if(p>1)for(const e of h){const i=e*c;if(!(a[i+2]<=t)){a[i+2]=t;for(let e=0;e<c;e++)l.push(a[i+e])}}}}return l}_getOriginId(e){return e-this.points.length>>5}_getOriginZoom(e){return(e-this.points.length)%32}_map(e,t,i){if(e[t+$]>1){const n=this.clusterProps[e[t+W]];return i?Object.assign({},n):n}const n=this.points[e[t+H]].properties,r=this.options.map(n);return i&&r===n?Object.assign({},r):r}}function X(e,t,i){return{type:"Feature",id:e[t+H],properties:Y(e,t,i),geometry:{type:"Point",coordinates:[(n=e[t],360*(n-.5)),K(e[t+1])]}};var n}function Y(e,t,i){const n=e[t+$],r=n>=1e4?`${Math.round(n/1e3)}k`:n>=1e3?Math.round(n/100)/10+"k":n,o=e[t+W],s=-1===o?{}:Object.assign({},i[o]);return Object.assign(s,{cluster:!0,cluster_id:e[t+H],point_count:n,point_count_abbreviated:r})}function Z(e){return e/360+.5}function J(e){const t=Math.sin(e*Math.PI/180),i=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return i<0?0:i>1?1:i}function K(e){const t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}function Q(e,t,i,n){let r=n;const o=t+(i-t>>1);let s,a=i-t;const l=e[t],c=e[t+1],u=e[i],h=e[i+1];for(let n=t+3;n<i;n+=3){const t=ee(e[n],e[n+1],l,c,u,h);if(t>r)s=n,r=t;else if(t===r){const e=Math.abs(n-o);e<a&&(s=n,a=e)}}r>n&&(s-t>3&&Q(e,t,s,n),e[s+2]=r,i-s>3&&Q(e,s,i,n))}function ee(e,t,i,n,r,o){let s=r-i,a=o-n;if(0!==s||0!==a){const l=((e-i)*s+(t-n)*a)/(s*s+a*a);l>1?(i=r,n=o):l>0&&(i+=s*l,n+=a*l)}return s=e-i,a=t-n,s*s+a*a}function te(e,t,i,n){const r={id:e??null,type:t,geometry:i,tags:n,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===t||"MultiPoint"===t||"LineString"===t)ie(r,i);else if("Polygon"===t)ie(r,i[0]);else if("MultiLineString"===t)for(const e of i)ie(r,e);else if("MultiPolygon"===t)for(const e of i)ie(r,e[0]);return r}function ie(e,t){for(let i=0;i<t.length;i+=3)e.minX=Math.min(e.minX,t[i]),e.minY=Math.min(e.minY,t[i+1]),e.maxX=Math.max(e.maxX,t[i]),e.maxY=Math.max(e.maxY,t[i+1])}function ne(e,t,i,n){if(!t.geometry)return;const r=t.geometry.coordinates;if(r&&0===r.length)return;const o=t.geometry.type,s=Math.pow(i.tolerance/((1<<i.maxZoom)*i.extent),2);let a=[],l=t.id;if(i.promoteId?l=t.properties[i.promoteId]:i.generateId&&(l=n||0),"Point"===o)re(r,a);else if("MultiPoint"===o)for(const e of r)re(e,a);else if("LineString"===o)oe(r,a,s,!1);else if("MultiLineString"===o){if(i.lineMetrics){for(const i of r)a=[],oe(i,a,s,!1),e.push(te(l,"LineString",a,t.properties));return}se(r,a,s,!1)}else if("Polygon"===o)se(r,a,s,!0);else{if("MultiPolygon"!==o){if("GeometryCollection"===o){for(const r of t.geometry.geometries)ne(e,{id:l,geometry:r,properties:t.properties},i,n);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const e of r){const t=[];se(e,t,s,!0),a.push(t)}}e.push(te(l,o,a,t.properties))}function re(e,t){t.push(ae(e[0]),le(e[1]),0)}function oe(e,t,i,n){let r,o,s=0;for(let i=0;i<e.length;i++){const a=ae(e[i][0]),l=le(e[i][1]);t.push(a,l,0),i>0&&(s+=n?(r*l-a*o)/2:Math.sqrt(Math.pow(a-r,2)+Math.pow(l-o,2))),r=a,o=l}const a=t.length-3;t[2]=1,Q(t,0,a,i),t[a+2]=1,t.size=Math.abs(s),t.start=0,t.end=t.size}function se(e,t,i,n){for(let r=0;r<e.length;r++){const o=[];oe(e[r],o,i,n),t.push(o)}}function ae(e){return e/360+.5}function le(e){const t=Math.sin(e*Math.PI/180),i=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return i<0?0:i>1?1:i}function ce(e,t,i,n,r,o,s,a){if(n/=t,o>=(i/=t)&&s<n)return e;if(s<i||o>=n)return null;const l=[];for(const t of e){const e=t.geometry;let o=t.type;const s=0===r?t.minX:t.minY,c=0===r?t.maxX:t.maxY;if(s>=i&&c<n){l.push(t);continue}if(c<i||s>=n)continue;let u=[];if("Point"===o||"MultiPoint"===o)ue(e,u,i,n,r);else if("LineString"===o)he(e,u,i,n,r,!1,a.lineMetrics);else if("MultiLineString"===o)pe(e,u,i,n,r,!1);else if("Polygon"===o)pe(e,u,i,n,r,!0);else if("MultiPolygon"===o)for(const t of e){const e=[];pe(t,e,i,n,r,!0),e.length&&u.push(e)}if(u.length){if(a.lineMetrics&&"LineString"===o){for(const e of u)l.push(te(t.id,o,e,t.tags));continue}"LineString"!==o&&"MultiLineString"!==o||(1===u.length?(o="LineString",u=u[0]):o="MultiLineString"),"Point"!==o&&"MultiPoint"!==o||(o=3===u.length?"Point":"MultiPoint"),l.push(te(t.id,o,u,t.tags))}}return l.length?l:null}function ue(e,t,i,n,r){for(let o=0;o<e.length;o+=3){const s=e[o+r];s>=i&&s<=n&&fe(t,e[o],e[o+1],e[o+2])}}function he(e,t,i,n,r,o,s){let a=de(e);const l=0===r?me:ge;let c,u,h=e.start;for(let d=0;d<e.length-3;d+=3){const p=e[d],f=e[d+1],m=e[d+2],g=e[d+3],_=e[d+4],y=0===r?p:f,v=0===r?g:_;let x=!1;s&&(c=Math.sqrt(Math.pow(p-g,2)+Math.pow(f-_,2))),y<i?v>i&&(u=l(a,p,f,g,_,i),s&&(a.start=h+c*u)):y>n?v<n&&(u=l(a,p,f,g,_,n),s&&(a.start=h+c*u)):fe(a,p,f,m),v<i&&y>=i&&(u=l(a,p,f,g,_,i),x=!0),v>n&&y<=n&&(u=l(a,p,f,g,_,n),x=!0),!o&&x&&(s&&(a.end=h+c*u),t.push(a),a=de(e)),s&&(h+=c)}let d=e.length-3;const p=e[d],f=e[d+1],m=0===r?p:f;m>=i&&m<=n&&fe(a,p,f,e[d+2]),d=a.length-3,o&&d>=3&&(a[d]!==a[0]||a[d+1]!==a[1])&&fe(a,a[0],a[1],a[2]),a.length&&t.push(a)}function de(e){const t=[];return t.size=e.size,t.start=e.start,t.end=e.end,t}function pe(e,t,i,n,r,o){for(const s of e)he(s,t,i,n,r,o,!1)}function fe(e,t,i,n){e.push(t,i,n)}function me(e,t,i,n,r,o){const s=(o-t)/(n-t);return fe(e,o,i+(r-i)*s,1),s}function ge(e,t,i,n,r,o){const s=(o-i)/(r-i);return fe(e,t+(n-t)*s,o,1),s}function _e(e,t){const i=[];for(let n=0;n<e.length;n++){const r=e[n],o=r.type;let s;if("Point"===o||"MultiPoint"===o||"LineString"===o)s=ye(r.geometry,t);else if("MultiLineString"===o||"Polygon"===o){s=[];for(const e of r.geometry)s.push(ye(e,t))}else if("MultiPolygon"===o){s=[];for(const e of r.geometry){const i=[];for(const n of e)i.push(ye(n,t));s.push(i)}}i.push(te(r.id,o,s,r.tags))}return i}function ye(e,t){const i=[];i.size=e.size,void 0!==e.start&&(i.start=e.start,i.end=e.end);for(let n=0;n<e.length;n+=3)i.push(e[n]+t,e[n+1],e[n+2]);return i}function ve(e,t){if(e.transformed)return e;const i=1<<e.z,n=e.x,r=e.y;for(const o of e.features){const e=o.geometry,s=o.type;if(o.geometry=[],1===s)for(let s=0;s<e.length;s+=2)o.geometry.push(xe(e[s],e[s+1],t,i,n,r));else for(let s=0;s<e.length;s++){const a=[];for(let o=0;o<e[s].length;o+=2)a.push(xe(e[s][o],e[s][o+1],t,i,n,r));o.geometry.push(a)}}return e.transformed=!0,e}function xe(e,t,i,n,r,o){return[Math.round(i*(e*n-r)),Math.round(i*(t*n-o))]}function be(e,t,i,n,r){const o=t===r.maxZoom?0:r.tolerance/((1<<t)*r.extent),s={features:[],numPoints:0,numSimplified:0,numFeatures:e.length,source:null,x:i,y:n,z:t,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const t of e)Te(s,t,o,r);return s}function Te(e,t,i,n){const r=t.geometry,o=t.type,s=[];if(e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),"Point"===o||"MultiPoint"===o)for(let t=0;t<r.length;t+=3)s.push(r[t],r[t+1]),e.numPoints++,e.numSimplified++;else if("LineString"===o)we(s,r,e,i,!1,!1);else if("MultiLineString"===o||"Polygon"===o)for(let t=0;t<r.length;t++)we(s,r[t],e,i,"Polygon"===o,0===t);else if("MultiPolygon"===o)for(let t=0;t<r.length;t++){const n=r[t];for(let t=0;t<n.length;t++)we(s,n[t],e,i,!0,0===t)}if(s.length){let i=t.tags||null;if("LineString"===o&&n.lineMetrics){i={};for(const e in t.tags)i[e]=t.tags[e];i.mapbox_clip_start=r.start/r.size,i.mapbox_clip_end=r.end/r.size}const a={geometry:s,type:"Polygon"===o||"MultiPolygon"===o?3:"LineString"===o||"MultiLineString"===o?2:1,tags:i};null!==t.id&&(a.id=t.id),e.features.push(a)}}function we(e,t,i,n,r,o){const s=n*n;if(n>0&&t.size<(r?s:n))return void(i.numPoints+=t.length/3);const a=[];for(let e=0;e<t.length;e+=3)(0===n||t[e+2]>s)&&(i.numSimplified++,a.push(t[e],t[e+1])),i.numPoints++;r&&function(e,t){let i=0;for(let t=0,n=e.length,r=n-2;t<n;r=t,t+=2)i+=(e[t]-e[r])*(e[t+1]+e[r+1]);if(i>0===t)for(let t=0,i=e.length;t<i/2;t+=2){const n=e[t],r=e[t+1];e[t]=e[i-2-t],e[t+1]=e[i-1-t],e[i-2-t]=n,e[i-1-t]=r}}(a,o),e.push(a)}const Ee={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Se{constructor(e,t){const i=(t=this.options=function(e,t){for(const i in t)e[i]=t[i];return e}(Object.create(Ee),t)).debug;if(t.maxZoom<0||t.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(t.promoteId&&t.generateId)throw new Error("promoteId and generateId cannot be used together.");let n=function(e,t){const i=[];if("FeatureCollection"===e.type)for(let n=0;n<e.features.length;n++)ne(i,e.features[n],t,n);else ne(i,"Feature"===e.type?e:{geometry:e},t);return i}(e,t);this.tiles={},this.tileCoords=[],i&&(this.stats={},this.total=0),n=function(e,t){const i=t.buffer/t.extent;let n=e;const r=ce(e,1,-1-i,i,0,-1,2,t),o=ce(e,1,1-i,2+i,0,-1,2,t);return(r||o)&&(n=ce(e,1,-i,1+i,0,-1,2,t)||[],r&&(n=_e(r,1).concat(n)),o&&(n=n.concat(_e(o,-1)))),n}(n,t),n.length&&this.splitTile(n,0,0,0)}splitTile(e,t,i,n,r,o,s){const a=[e,t,i,n],l=this.options,c=l.debug;for(;a.length;){n=a.pop(),i=a.pop(),t=a.pop(),e=a.pop();const u=1<<t,h=Ae(t,i,n);let d=this.tiles[h];if(!d&&(d=this.tiles[h]=be(e,t,i,n,l),this.tileCoords.push({z:t,x:i,y:n}),c)){const e=`z${t}`;this.stats[e]=(this.stats[e]||0)+1,this.total++}if(d.source=e,null==r){if(t===l.indexMaxZoom||d.numPoints<=l.indexMaxPoints)continue}else{if(t===l.maxZoom||t===r)continue;if(null!=r){const e=r-t;if(i!==o>>e||n!==s>>e)continue}}if(d.source=null,0===e.length)continue;const p=.5*l.buffer/l.extent,f=.5-p,m=.5+p,g=1+p;let _=null,y=null,v=null,x=null,b=ce(e,u,i-p,i+m,0,d.minX,d.maxX,l),T=ce(e,u,i+f,i+g,0,d.minX,d.maxX,l);e=null,b&&(_=ce(b,u,n-p,n+m,1,d.minY,d.maxY,l),y=ce(b,u,n+f,n+g,1,d.minY,d.maxY,l),b=null),T&&(v=ce(T,u,n-p,n+m,1,d.minY,d.maxY,l),x=ce(T,u,n+f,n+g,1,d.minY,d.maxY,l),T=null),a.push(_||[],t+1,2*i,2*n),a.push(y||[],t+1,2*i,2*n+1),a.push(v||[],t+1,2*i+1,2*n),a.push(x||[],t+1,2*i+1,2*n+1)}}getTile(e,t,i){e=+e,t=+t,i=+i;const n=this.options,{extent:r}=n;if(e<0||e>24)return null;const o=1<<e,s=Ae(e,t=t+o&o-1,i);if(this.tiles[s])return ve(this.tiles[s],r);let a,l=e,c=t,u=i;for(;!a&&l>0;)l--,c>>=1,u>>=1,a=this.tiles[Ae(l,c,u)];return a&&a.source?(this.splitTile(a.source,l,c,u,e,t,i),this.tiles[s]?ve(this.tiles[s],r):null):null}}function Ae(e,t,i){return 32*((1<<e)*i+t)+e}function Me(t,i){const n=t.tileID.canonical;if(!this._geoJSONIndex)return void i(null,null);const r=this._geoJSONIndex.getTile(n.z,n.x,n.y);if(!r)return void i(null,null);const o=e=>e.tags&&"3d_elevation_id"in e.tags&&"source"in e.tags&&"elevation"===e.tags.source,s=r.features.filter((e=>o(e)));let a={_geojsonTileLayer:r.features};s.length>0&&(a={_geojsonTileLayer:r.features.filter((e=>!o(e))),hd_road_elevation:s});const l=new w(a),c=function(t){const i=new e.bs;for(const e of Object.keys(t))i.writeMessage(3,D,{name:e,features:t[e]});return i.finish()}(a).buffer;i(null,{vectorTile:l,rawData:c})}class Ie extends g{constructor(e,t,i,n,r,o,s){super(e,t,i,n,r,Me,s),o&&(this.loadGeoJSON=o),this._dynamicIndex=new A}loadData(i,n){const r=i&&i.request,o=r&&r.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(i,((s,a)=>{if(s||!a)return n(s);if("object"!=typeof a)return n(new Error(`Input data given to '${i.source}' is not a valid GeoJSON object.`));{try{if(i.filter){const t=e.U(i.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===t.result)throw new Error(t.value.map((e=>`${e.key}: ${e.message}`)).join(", "));a.features=a.features.filter((e=>t.value.evaluate({zoom:0},e)))}i.dynamic?("Feature"===a.type&&(a={type:"FeatureCollection",features:[a]}),i.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(a.features,this.loaded),i.cluster&&(a.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=i.cluster?new q(function({superclusterOptions:t,clusterProperties:i}){if(!i||!t)return t;const n={},r={},o={accumulated:null,zoom:0},s={properties:null},a=Object.keys(i);for(const t of a){const[o,s]=i[t],a=e.U(s),l=e.U("string"==typeof o?[o,["accumulated"],["get",t]]:o);n[t]=a.value,r[t]=l.value}return t.map=e=>{s.properties=e;const t={};for(const e of a)t[e]=n[e].evaluate(o,s);return t},t.reduce=(e,t)=>{s.properties=t;for(const t of a)o.accumulated=e[t],e[t]=r[t].evaluate(o,s)},t}(i)).load(a.features):i.dynamic?this._dynamicIndex:function(e,t){return new Se(e,t)}(a,i.geojsonVtOptions)}catch(e){return n(e)}const s={};if(o){const e=t(r);e&&(s.resourceTiming={},s.resourceTiming[i.source]=JSON.parse(JSON.stringify(e)))}n(null,s)}}))}reloadTile(e,t){const i=this.loaded;return i&&i[e.uid]?e.partial?t(null,void 0):super.reloadTile(e,t):this.loadTile(e,t)}loadGeoJSON(t,i){if(t.request)e.m(t.request,i);else{if("string"!=typeof t.data)return i(new Error(`Input data given to '${t.source}' is not a valid GeoJSON object.`));setTimeout((()=>{try{return i(null,JSON.parse(t.data))}catch(e){return i(new Error(`Input data given to '${t.source}' is not a valid GeoJSON object.`))}}),0)}}getClusterExpansionZoom(e,t){try{t(null,this._geoJSONIndex.getClusterExpansionZoom(e.clusterId))}catch(e){t(e)}}getClusterChildren(e,t){try{t(null,this._geoJSONIndex.getChildren(e.clusterId))}catch(e){t(e)}}getClusterLeaves(e,t){try{t(null,this._geoJSONIndex.getLeaves(e.clusterId,e.limit,e.offset))}catch(e){t(e)}}}class Ce{constructor(t,i,n){this.tileID=new e.aP(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=t.projection,this.brightness=i,this.worldview=n}parse(t,i,n,r){this.status="parsing";const o=new e.aP(n.tileID.overscaledZ,n.tileID.wrap,n.tileID.canonical.z,n.tileID.canonical.x,n.tileID.canonical.y),s=[],a=i.familiesBySource[n.source],l=new e.fm(o,n.promoteId);l.bucketLayerIDs=[],l.is3DTile=!0,e.fB(t).then((t=>{if(!t)return r(new Error("Could not parse tile"));const i=t.json.extensionsUsed&&t.json.extensionsUsed.includes("MAPBOX_mesh_features")||t.json.asset.extras&&t.json.asset.extras.MAPBOX_mesh_features,c=t.json.extensionsUsed&&t.json.extensionsUsed.includes("EXT_meshopt_compression"),u=new e.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const r in a)for(const h of a[r]){const r=h[0];l.bucketLayerIDs.push(h.map((t=>e.B(t.id,t.scope)))),r.recalculate(u,[]);const a=e.fC(t,1/e.d6(n.tileID.canonical)),d=new e.fD(h,a,o,i,c,this.brightness,l,this.worldview);i||(d.needsUpload=!0),s.push(d),d.evaluate(r)}this.status="done",r(null,{buckets:s,featureIndex:l,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((e=>r(new Error(e.message))))}}class Pe{constructor(e,t,i,n,r,o,s,a){this.actor=e,this.layerIndex=t,this.availableImages=i,this.availableModels=n,this.brightness=s,this.loading={},this.loaded={},this.worldview=a}loadTile(t,i){const n=t.uid,r=this.loading[n]=new Ce(t,this.brightness,this.worldview);e.bt(t.request,((e,o)=>{const s=!this.loading[n];return delete this.loading[n],s||e?(r.status="done",s||(this.loaded[n]=r),i(e)):o&&0!==o.byteLength?void r.parse(o,this.layerIndex,t,((e,t)=>{r.status="done",this.loaded=this.loaded||{},this.loaded[n]=r,e||!t?i(e):i(null,t)})):(r.status="done",this.loaded[n]=r,i())}))}reloadTile(e,t){const i=this.loaded,n=e.uid;if(i&&i[n]){const r=i[n];r.projection=e.projection,r.brightness=e.brightness;const o=(i,n)=>{r.reloadCallback&&(delete r.reloadCallback,this.loadTile(e,t)),t(i,n)};"parsing"===r.status?r.reloadCallback=o:"done"===r.status&&this.loadTile(e,t)}}abortTile(e,t){const i=e.uid;this.loading[i]&&delete this.loading[i],t()}removeTile(e,t){const i=this.loaded,n=e.uid;i&&i[n]&&delete i[n],t()}}class Le{constructor(t){this.self=t,this.actor=new e.fF(t,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new e.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=e.cl({name:"mercator"}),this.workerSourceTypes={vector:g,geojson:Ie,"raster-dem":_,"raster-array":v,"batched-model":Pe},this.workerSources={},this.self.registerWorkerSource=(e,t)=>{if(this.workerSourceTypes[e])throw new Error(`Worker source with name "${e}" already registered.`);this.workerSourceTypes[e]=t},this.self.registerRTLTextPlugin=t=>{if(e.fG.isParsed())throw new Error("RTL text plugin already registered.");e.fG.setState({pluginStatus:e.fH.parsed,pluginURL:e.fG.getPluginURL()}),e.fG.applyArabicShaping=t.applyArabicShaping,e.fG.processBidirectionalText=t.processBidirectionalText,e.fG.processStyledBidirectionalText=t.processStyledBidirectionalText;for(const e of this.rtlPluginParsingListeners)e(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(e,t,i){delete this.layerIndexes[e],delete this.availableImages[e],delete this.availableModels[e],delete this.workerSources[e],i()}checkIfReady(e,t,i){i()}setReferrer(e,t){this.referrer=t}spriteLoaded(t,i){this.isSpriteLoaded[t]||(this.isSpriteLoaded[t]={});const{scope:n,isLoaded:r}=i;if(this.isSpriteLoaded[t][n]=r,this.workerSources[t]&&this.workerSources[t][n])for(const i in this.workerSources[t][n]){const o=this.workerSources[t][n][i];for(const t in o){const i=o[t];i instanceof g&&(i.isSpriteLoaded=r,i.fire(new e.z("isSpriteLoaded")))}}}setImages(e,t,i){this.availableImages[e]||(this.availableImages[e]={});const{scope:n,images:r}=t;if(this.availableImages[e][n]=r,this.workerSources[e]&&this.workerSources[e][n]){for(const t in this.workerSources[e][n]){const i=this.workerSources[e][n][t];for(const e in i)i[e].availableImages=r}i()}else i()}setModels(e,{scope:t,models:i},n){if(this.availableModels[e]||(this.availableModels[e]={}),this.availableModels[e][t]=i,this.workerSources[e]&&this.workerSources[e][t]){for(const n in this.workerSources[e][t]){const r=this.workerSources[e][t][n];for(const e in r)r[e].availableModels=i}n()}else n()}setProjection(t,i){this.projections[t]=e.cl(i)}setBrightness(e,t,i){this.brightness=t,i()}setWorldview(e,t,i){this.worldview=t,i()}setLayers(e,t,i){this.getLayerIndex(e,t.scope).replace(t.layers,t.options),i()}updateLayers(e,t,i){this.getLayerIndex(e,t.scope).update(t.layers,t.removedIds,t.options),i()}loadTile(e,t,i){t.projection=this.projections[e]||this.defaultProjection,this.getWorkerSource(e,t.type,t.source,t.scope).loadTile(t,i)}decodeRasterArray(e,t,i){this.getWorkerSource(e,t.type,t.source,t.scope).decodeRasterArray(t,i)}reloadTile(e,t,i){t.projection=this.projections[e]||this.defaultProjection,this.getWorkerSource(e,t.type,t.source,t.scope).reloadTile(t,i)}abortTile(e,t,i){this.getWorkerSource(e,t.type,t.source,t.scope).abortTile(t,i)}removeTile(e,t,i){this.getWorkerSource(e,t.type,t.source,t.scope).removeTile(t,i)}removeSource(e,t,i){if(!(this.workerSources[e]&&this.workerSources[e][t.scope]&&this.workerSources[e][t.scope][t.type]&&this.workerSources[e][t.scope][t.type][t.source]))return;const n=this.workerSources[e][t.scope][t.type][t.source];delete this.workerSources[e][t.scope][t.type][t.source],void 0!==n.removeSource?n.removeSource(t,i):i()}loadWorkerSource(e,t,i){try{this.self.importScripts(t.url),i()}catch(e){i(e.toString())}}syncRTLPluginState(t,i,n){if(e.fG.isParsed())n(null,!0);else if(e.fG.isParsing())this.rtlPluginParsingListeners.push(n);else try{e.fG.setState(i);const t=e.fG.getPluginURL();!e.fG.isLoaded()||e.fG.isParsed()||e.fG.isParsing()||null==t||(e.fG.setState({pluginStatus:e.fH.parsing,pluginURL:e.fG.getPluginURL()}),this.self.importScripts(t),e.fG.isParsed()?n(null,!0):this.rtlPluginParsingListeners.push(n))}catch(e){n(e.toString())}}setDracoUrl(e,t){this.dracoUrl=t}getAvailableImages(e,t){this.availableImages[e]||(this.availableImages[e]={});let i=this.availableImages[e][t];return i||(i=[]),i}getAvailableModels(e,t){this.availableModels[e]||(this.availableModels[e]={});let i=this.availableModels[e][t];return i||(i={}),i}getLayerIndex(e,t){this.layerIndexes[e]||(this.layerIndexes[e]={});let i=this.layerIndexes[e][t];return i||(i=this.layerIndexes[e][t]=new r,i.scope=t),i}getWorkerSource(e,t,i,n){const r=this.workerSources;return r[e]||(r[e]={}),r[e][n]||(r[e][n]={}),r[e][n][t]||(r[e][n][t]={}),this.isSpriteLoaded[e]||(this.isSpriteLoaded[e]={}),r[e][n][t][i]||(r[e][n][t][i]=new this.workerSourceTypes[t]({send:(t,i,n,r,o,s)=>this.actor.send(t,i,n,e,o,s),scheduler:this.actor.scheduler},this.getLayerIndex(e,n),this.getAvailableImages(e,n),this.getAvailableModels(e,n),this.isSpriteLoaded[e][n],void 0,this.brightness,this.worldview)),r[e][n][t][i]}rasterizeImagesWorker(e,t,i){const n=new Map;for(const[i,{image:r,imageVariant:o}]of t.tasks.entries()){const s=this.imageRasterizer.rasterize(o,r,t.scope,e);n.set(i,s)}i(void 0,n)}removeRasterizedImages(e,t,i){this.imageRasterizer.removeImagesFromCacheByIds(t.imageIds,t.scope,e),i()}enforceCacheSizeLimit(t,i){e.fI(i)}getWorkerPerformanceMetrics(e,t,i){i(void 0,void 0)}}return e.fE(self)&&(self.worker=new Le(self)),Le})),n(["./shared"],(function(e){var t="3.16.0";const i={create:"create",load:"load",fullLoad:"fullLoad"},n={mark(e){performance.mark(e)},measure(e,t,i){performance.measure(e,t,i)}};function r(t){const i=t.name.split("?")[0];return e.a(i)&&i.includes("mapbox-gl.js")?"javascript":e.a(i)&&i.includes("mapbox-gl.css")?"css":e.b(i)?"fontRange":e.c(i)?"sprite":e.i(i)?"style":e.d(i)?"tilejson":"other"}var o,s={},a=function(){if(o)return s;function e(e){return!t(e)}function t(t){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var e,t,i=new Blob([""],{type:"text/javascript"}),n=URL.createObjectURL(i);try{t=new Worker(n),e=!0}catch(t){e=!1}return t&&t.terminate(),URL.revokeObjectURL(n),e}()?function(){var e=document.createElement("canvas");e.width=e.height=1;var t=e.getContext("2d");if(!t)return!1;var i=t.getImageData(0,0,1,1);return i&&i.width===e.width}()?(void 0===i[n=t&&t.failIfMajorPerformanceCaveat]&&(i[n]=function(t){var i,n=function(t){var i=document.createElement("canvas"),n=Object.create(e.webGLContextAttributes);return n.failIfMajorPerformanceCaveat=t,i.getContext("webgl2",n)}(t);if(!n)return!1;try{i=n.createShader(n.VERTEX_SHADER)}catch(e){return!1}return!(!i||n.isContextLost())&&(n.shaderSource(i,"void main() {}"),n.compileShader(i),!0===n.getShaderParameter(i,n.COMPILE_STATUS))}(n)),i[n]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var n}o=1,s.supported=e,s.notSupportedReason=t;var i={};return e.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},s}();function l(e,t,i){const n=document.createElement(e);return null!=t&&(n.className=t),i&&i.appendChild(n),n}function c(e,t,i){const n=document.createElementNS("http://www.w3.org/2000/svg",e);for(const e of Object.keys(t))n.setAttributeNS(null,e,String(t[e]));return i&&i.appendChild(n),n}const u="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,h=u&&void 0!==u.userSelect?"userSelect":"WebkitUserSelect";let d;function p(){u&&h&&(d=u[h],u[h]="none")}function f(){u&&h&&(u[h]=d)}function m(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("click",m,!0)}function g(){window.addEventListener("click",m,!0),window.setTimeout((()=>{window.removeEventListener("click",m,!0)}),0)}function _(e,t){const i=e.getBoundingClientRect();return x(e,i,t)}function y(e,t){const i=e.getBoundingClientRect(),n=[];for(let r=0;r<t.length;r++)n.push(x(e,i,t[r]));return n}function v(e){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===e.button&&e.ctrlKey?0:e.button}function x(t,i,n){const r=t.offsetWidth===i.width?1:t.offsetWidth/i.width;return new e.P((n.clientX-i.left)*r,(n.clientY-i.top)*r)}const b="01",T="NO_ACCESS_TOKEN";class w{constructor(e,t,i){this._transformRequestFn=e,this._customAccessToken=t,this._silenceAuthErrors=!!i,this._createSkuToken()}_createSkuToken(){const e=function(){let e="";for(let t=0;t<10;t++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",b,e].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=e.token,this._skuTokenExpiresAt=e.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(e,t){return this._transformRequestFn&&this._transformRequestFn(e,t)||{url:e}}normalizeStyleURL(i,n){if(!e.h(i))return i;const r=S(i);return r.params.push(`sdk=js-${t}`),r.path=`/styles/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||n)}normalizeGlyphsURL(t,i){if(!e.h(t))return t;const n=S(t);return n.path=`/fonts/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||i)}normalizeModelURL(t,i){if(!e.h(t))return t;const n=S(t);return n.path=`/models/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||i)}normalizeSourceURL(t,i,n,r){if(!e.h(t))return t;const o=S(t);return o.path=`/v4/${o.authority}.json`,o.params.push("secure"),n&&o.params.push(`language=${n}`),r&&o.params.push(`worldview=${r}`),this._makeAPIURL(o,this._customAccessToken||i)}normalizeIconsetURL(t,i){const n=S(t);return e.h(t)?(n.path=`/styles/v1${n.path}/iconset.pbf`,this._makeAPIURL(n,this._customAccessToken||i)):A(n)}normalizeSpriteURL(t,i,n,r){const o=S(t);return e.h(t)?(o.path=`/styles/v1${o.path}/sprite${i}${n}`,this._makeAPIURL(o,this._customAccessToken||r)):(o.path+=`${i}${n}`,A(o))}normalizeTileURL(t,i,n){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!e.h(t))return t;const r=S(t);r.path=r.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${i||n&&"raster"!==r.authority&&512===n?"@2x":""}${e.k.supported?".webp":"$1"}`),"raster"===r.authority?r.path=`/${e.e.RASTER_URL_PREFIX}${r.path}`:"rasterarrays"===r.authority?r.path=`/${e.e.RASTERARRAYS_URL_PREFIX}${r.path}`:"3dtiles"===r.authority?r.path=`/${e.e.TILES3D_URL_PREFIX}${r.path}`:(r.path=r.path.replace(/^.+\/v4\//,"/"),r.path=`/${e.e.TILE_URL_VERSION}${r.path}`);const o=this._customAccessToken||function(e){for(const t of e){const e=t.match(/^access_token=(.*)$/);if(e)return e[1]}return null}(r.params)||e.e.ACCESS_TOKEN;return e.e.REQUIRE_ACCESS_TOKEN&&o&&this._skuToken&&r.params.push(`sku=${this._skuToken}`),this._makeAPIURL(r,o)}canonicalizeTileURL(t,i){const n=S(t);if(!n.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!n.path.match(/\.[\w]+$/))return t;let r="mapbox://";n.path.match(/^\/raster\/v1\//)?r+=`raster/${n.path.replace(`/${e.e.RASTER_URL_PREFIX}/`,"")}`:n.path.match(/^\/rasterarrays\/v1\//)?r+=`rasterarrays/${n.path.replace(`/${e.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:r+=`tiles/${n.path.replace(`/${e.e.TILE_URL_VERSION}/`,"")}`;let o=n.params;return i&&(o=o.filter((e=>!e.match(/^access_token=/)))),o.length&&(r+=`?${o.join("&")}`),r}canonicalizeTileset(t,i){const n=!!i&&e.h(i),r=[];for(const i of t.tiles||[])e.j(i)?r.push(this.canonicalizeTileURL(i,n)):r.push(i);return r}_makeAPIURL(t,i){const n="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",r=S(e.e.API_URL);if(t.protocol=r.protocol,t.authority=r.authority,"http"===t.protocol){const e=t.params.indexOf("secure");e>=0&&t.params.splice(e,1)}if("/"!==r.path&&(t.path=`${r.path}${t.path}`),!e.e.REQUIRE_ACCESS_TOKEN)return A(t);if(i=i||e.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!i)throw new Error(`An API access token is required to use Mapbox GL. ${n}`);if("s"===i[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${n}`)}return t.params=t.params.filter((e=>-1===e.indexOf("access_token"))),t.params.push(`access_token=${i||""}`),A(t)}}const E=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function S(e){const t=e.match(E);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function A(e){const t=e.params.length?`?${e.params.join("&")}`:"";return`${e.protocol}://${e.authority}${e.path}${t}`}const M="mapbox.eventData";function I(t){if(!t)return null;const i=t.split(".");if(!i||3!==i.length)return null;try{return JSON.parse(e.l(i[1]))}catch(e){return null}}class C{constructor(e){this.type=e,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const i=I(e.e.ACCESS_TOKEN);let n="";return n=i&&i.u?e.f(i.u):e.e.ACCESS_TOKEN||"",t?`${M}.${t}:${n}`:`${M}:${n}`}fetchEventData(){const t=e.s("localStorage"),i=this.getStorageKey(),n=this.getStorageKey("uuid"),r=this.getStorageKey("uuidTimestamp");if(t)try{const e=localStorage.getItem(i);e&&(this.eventData=JSON.parse(e));const t=localStorage.getItem(n);t&&(this.anonId=t);const o=localStorage.getItem(r);o&&(this.anonIdTimestamp=Number(o));const s=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<s)&&this.refreshUUID()}catch(t){e.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=e.u(),this.anonIdTimestamp=Date.now()}saveEventData(){const t=e.s("localStorage"),i=this.getStorageKey(),n=this.getStorageKey("uuid"),r=this.getStorageKey("uuidTimestamp"),o=this.anonId,s=this.anonIdTimestamp;if(t&&o)try{localStorage.setItem(n,o),Object.keys(this.eventData).length>=1&&localStorage.setItem(i,JSON.stringify(this.eventData)),s&&localStorage.setItem(r,s.toString())}catch(t){e.w("Unable to write to LocalStorage")}}processRequests(e){}postEvent(t,i,n,r){if(!e.e.EVENTS_URL)return;const o=S(e.e.EVENTS_URL);o.params.push(`access_token=${r||e.e.ACCESS_TOKEN||""}`);const s={event:this.type,created:new Date(t).toISOString()},a=i?Object.assign(s,i):s,l={url:A(o),headers:{"Content-Type":"text/plain"},body:JSON.stringify([a])};this.pendingRequest=e.p(l,(e=>{this.pendingRequest=null,n(e),this.saveEventData(),this.processRequests(r)}))}queueRequest(e,t){this.queue.push(e),this.processRequests(t)}}const P=new class extends C{constructor(e){super("appUserTurnstile"),this._customAccessToken=e}postTurnstileEvent(t,i){e.e.EVENTS_URL&&e.e.ACCESS_TOKEN&&Array.isArray(t)&&t.some((t=>e.h(t)||e.j(t)))&&this.queueRequest(Date.now(),i)}processRequests(i){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const n=I(e.e.ACCESS_TOKEN),r=n?n.u:e.e.ACCESS_TOKEN;let o=r!==this.eventData.tokenU;e.v(this.anonId)||(this.refreshUUID(),o=!0);const s=this.queue.shift();if(this.eventData.lastSuccess){const e=new Date(this.eventData.lastSuccess),t=new Date(s),i=(s-this.eventData.lastSuccess)/864e5;o=o||i>=1||i<-1||e.getDate()!==t.getDate()}else o=!0;o?this.postEvent(s,{sdkIdentifier:"mapbox-gl-js",sdkVersion:t,skuId:b,"enabled.telemetry":!1,userId:this.anonId},(e=>{e||(this.eventData.lastSuccess=s,this.eventData.tokenU=r)}),i):this.processRequests()}},L=P.postTurnstileEvent.bind(P),R=new class extends C{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(t,i,n,r){this.skuToken=i,this.errorCb=r,e.e.EVENTS_URL&&(n||e.e.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},n):this.errorCb(new Error(T)))}processRequests(i){if(this.pendingRequest||0===this.queue.length)return;const{id:n,timestamp:r}=this.queue.shift();n&&this.success[n]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),e.v(this.anonId)||this.refreshUUID(),this.postEvent(r,{sdkIdentifier:"mapbox-gl-js",sdkVersion:t,skuId:b,skuToken:this.skuToken,userId:this.anonId},(e=>{e?this.errorCb(e):n&&(this.success[n]=!0)}),i))}remove(){this.errorCb=null}},O=R.postMapLoadEvent.bind(R),D=new class extends C{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(t){let i=this.mapInstanceIdMap.get(t);return i||(i=e.u(),this.mapInstanceIdMap.set(t,i)),i}getEventId(e){const t=this.eventIdPerMapInstanceMap.get(e)||0;return this.eventIdPerMapInstanceMap.set(e,t+1),t}postStyleLoadEvent(t,i){const{map:n,style:r,importedStyles:o}=i;if(!e.e.EVENTS_URL||!t&&!e.e.ACCESS_TOKEN)return;const s=this.getMapInstanceId(n),a={mapInstanceId:s,eventId:this.getEventId(s),style:r};o.length&&(a.importedStyles=o),this.queueRequest({timestamp:Date.now(),payload:a},t)}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:t,payload:i}=this.queue.shift();this.postEvent(t,i,(()=>{}),e)}},B=D.postStyleLoadEvent.bind(D),F=new class extends C{constructor(e){super("metrics"),e&&(this.data=e)}postMetricsEvent(t){if(!e.e.EVENTS_URL||!t&&!e.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),e.v(this.anonId)||this.refreshUUID();const i=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:i},t)}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:t,payload:i}=this.queue.shift();this.postEvent(t,i,(()=>{}),e)}}({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),N=F.postMetricsEvent.bind(F),k=new class extends C{constructor(){super("gljs.performance")}postPerformanceEvent(t,i){e.e.EVENTS_URL&&(t||e.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:i},t)}processRequests(n){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:o,performanceData:s}=this.queue.shift(),a=function(n){const o=performance.getEntriesByType("resource"),s=performance.getEntriesByType("mark"),a=function(e){const t={};if(e)for(const i in e)if("other"!==i)for(const n of e[i]){const e=`${i}ResolveRangeMin`,r=`${i}ResolveRangeMax`,o=`${i}RequestCount`,s=`${i}RequestCachedCount`;t[e]=Math.min(t[e]||1/0,n.startTime),t[r]=Math.max(t[r]||-1/0,n.responseEnd);const a=e=>{void 0===t[e]&&(t[e]=0),++t[e]};void 0!==n.transferSize&&0===n.transferSize&&a(s),a(o)}return t}(function(e,t){const i={};if(e)for(const n of e){const e=t(n);void 0===i[e]&&(i[e]=[]),i[e].push(n)}return i}(o,r)),l=window.devicePixelRatio,c=navigator.connection||navigator.mozConnection||navigator.webkitConnection,u=c?c.effectiveType:void 0,h={counters:[],metadata:[],attributes:[]},d=(e,t,i)=>{null!=i&&e.push({name:t,value:i.toString()})};for(const e in a)d(h.counters,e,a[e]);if(n.interactionRange[0]!==1/0&&n.interactionRange[1]!==-1/0&&(d(h.counters,"interactionRangeMin",n.interactionRange[0]),d(h.counters,"interactionRangeMax",n.interactionRange[1])),s)for(const e of Object.values(i)){const t=s.find((t=>t.name===e));t&&d(h.counters,e,t.startTime)}return d(h.counters,"visibilityHidden",n.visibilityHidden),d(h.attributes,"style",function(t){if(t)for(const i of t){const t=i.name.split("?")[0];if(e.i(t)){const e=t.split("/").slice(-2);if(2===e.length)return`mapbox://styles/${e[0]}/${e[1]}`}}}(o)),d(h.attributes,"terrainEnabled",n.terrainEnabled?"true":"false"),d(h.attributes,"fogEnabled",n.fogEnabled?"true":"false"),d(h.attributes,"projection",n.projection),d(h.attributes,"zoom",n.zoom),d(h.metadata,"devicePixelRatio",l),d(h.metadata,"connectionEffectiveType",u),d(h.metadata,"navigatorUserAgent",navigator.userAgent),d(h.metadata,"screenWidth",window.screen.width),d(h.metadata,"screenHeight",window.screen.height),d(h.metadata,"windowWidth",window.innerWidth),d(h.metadata,"windowHeight",window.innerHeight),d(h.metadata,"mapWidth",n.width/l),d(h.metadata,"mapHeight",n.height/l),d(h.metadata,"webglRenderer",n.renderer),d(h.metadata,"webglVendor",n.vendor),d(h.metadata,"sdkVersion",t),d(h.metadata,"sdkIdentifier","mapbox-gl-js"),h}(s);for(const e of a.metadata);for(const e of a.counters);for(const e of a.attributes);this.postEvent(o,a,(()=>{}),n)}},U=k.postPerformanceEvent.bind(k),z=new class extends C{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(t,i,n,r){if(!e.e.API_URL||!e.e.SESSION_PATH)return;const o=S(e.e.API_URL+e.e.SESSION_PATH);o.params.push(`sku=${i||""}`),o.params.push(`access_token=${r||e.e.ACCESS_TOKEN||""}`);const s={url:A(o),headers:{"Content-Type":"text/plain"}};this.pendingRequest=e.g(s,(e=>{this.pendingRequest=null,n(e),this.saveEventData(),this.processRequests(r)}))}getSessionAPI(t,i,n,r){this.skuToken=i,this.errorCb=r,e.e.SESSION_PATH&&e.e.API_URL&&(n||e.e.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},n):this.errorCb(new Error(T)))}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:i}=this.queue.shift();t&&this.success[t]||this.getSession(i,this.skuToken,(e=>{e?this.errorCb(e):t&&(this.success[t]=!0)}),e)}remove(){this.errorCb=null}},V=z.getSessionAPI.bind(z),G=new Set;function j(e,t){t?G.add(e):G.delete(e)}class H{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(e,t){this._updatedSourceCaches[e]=t,this.setDirty()}discardSourceCacheUpdate(e){delete this._updatedSourceCaches[e]}updateLayer(e){const t=e.scope;this._updatedLayers[t]=this._updatedLayers[t]||new Set,this._updatedLayers[t].add(e.id),this.setDirty()}removeLayer(e){const t=e.scope;this._removedLayers[t]=this._removedLayers[t]||{},this._updatedLayers[t]=this._updatedLayers[t]||new Set,this._removedLayers[t][e.id]=e,this._updatedLayers[t].delete(e.id),this._updatedPaintProps.delete(e.fqid),this.setDirty()}getRemovedLayer(e){return this._removedLayers[e.scope]?this._removedLayers[e.scope][e.id]:null}discardLayerRemoval(e){this._removedLayers[e.scope]&&delete this._removedLayers[e.scope][e.id]}getLayerUpdatesByScope(){const e={};for(const t in this._updatedLayers)e[t]=e[t]||{},e[t].updatedIds=Array.from(this._updatedLayers[t].values());for(const t in this._removedLayers)e[t]=e[t]||{},e[t].removedIds=Object.keys(this._removedLayers[t]);return e}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(e){this._updatedPaintProps.add(e.fqid),this.setDirty()}getUpdatedImages(e){return this._updatedImages[e]?Array.from(this._updatedImages[e].values()):[]}updateImage(t,i){this._updatedImages[i]=this._updatedImages[i]||new Set,this._updatedImages[i].add(e.I.toString(t)),this.setDirty()}resetUpdatedImages(e){this._updatedImages[e]&&this._updatedImages[e].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function $(e){const{userImage:t}=e;return!!(t&&t.render&&t.render())&&(e.data.replace(new Uint8Array(t.data.buffer)),!0)}class W extends e.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,"raster"!==t&&e.r()&&(this.imageRasterizerDispatcher=new e.D(e.t(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new e.q({width:1,height:1}))}removeScope(e){this.loaded.delete(e),this.imageProviders.delete(e),this.images.delete(e),this.updatedImages.delete(e),this.callbackDispatchedThisFrame.delete(e),this.patterns.delete(e),this.atlasImage.delete(e);const t=this.atlasTexture.get(e);t&&(t.destroy(),this.atlasTexture.delete(e))}addImageProvider(e,t){this.imageProviders.has(t)||this.imageProviders.set(t,new Map),this.imageProviders.get(t).set(e.id,e)}removeImageProvider(e,t){this.imageProviders.has(t)&&this.imageProviders.get(t).delete(e)}getPendingImageProviders(){const e=[];for(const t of this.imageProviders.values())for(const i of t.values())i.hasPendingRequests()&&e.push(i);return e}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new e.x),this._imageRasterizer}isLoaded(){for(const e of this.loaded.keys())if(!this.loaded.get(e))return!1;return!0}setLoaded(e,t){if(this.loaded.get(t)!==e&&(this.loaded.set(t,e),e)){for(const{ids:e,callback:i}of this.requestors)this._notify(e,t,i);this.requestors=[]}}hasImage(e,t){return!!this.getImage(e,t)}getImage(e,t){return this.images.get(t).get(e.toString())}addImage(e,t,i){this._validate(e,i)&&this.images.get(t).set(e.toString(),i)}_validate(t,i){let n=!0;return this._validateStretch(i.stretchX,i.data&&i.data.width)||(this.fire(new e.y(new Error(`Image "${t.name}" has invalid "stretchX" value`))),n=!1),this._validateStretch(i.stretchY,i.data&&i.data.height)||(this.fire(new e.y(new Error(`Image "${t.name}" has invalid "stretchY" value`))),n=!1),this._validateContent(i.content,i)||(this.fire(new e.y(new Error(`Image "${t.name}" has invalid "content" value`))),n=!1),n}_validateStretch(e,t){if(!e)return!0;let i=0;for(const n of e){if(n[0]<i||n[1]<n[0]||t<n[1])return!1;i=n[1]}return!0}_validateContent(e,t){if(!e)return!0;if(4!==e.length)return!1;if(!t.usvg){if(e[0]<0||t.data.width<e[0])return!1;if(e[1]<0||t.data.height<e[1])return!1;if(e[2]<0||t.data.width<e[2])return!1;if(e[3]<0||t.data.height<e[3])return!1}return!(e[2]<e[0]||e[3]<e[1])}updateImage(e,t,i){const n=this.images.get(t).get(e.toString());i.version=n.version+1,this.images.get(t).set(e.toString(),i),this.updatedImages.get(t).add(e),this.removeFromImageRasterizerCache(e,t)}clearUpdatedImages(e){this.updatedImages.get(e).clear()}removeFromImageRasterizerCache(t,i){"raster"!==this.spriteFormat&&(e.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:i}):this.imageRasterizer.removeImagesFromCacheByIds([t],i))}removeImage(e,t){const i=this.images.get(t),n=i.get(e.toString());i.delete(e.toString()),this.patterns.get(t).delete(e.toString()),this.removeFromImageRasterizerCache(e,t),n.userImage&&n.userImage.onRemove&&n.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map((t=>e.I.from(t)))}getImages(e,t,i){const n=[],r=[],o=this.imageProviders.get(t);for(const i of e){if(!i.iconsetId){n.push(i);continue}const e=o.get(i.iconsetId);e&&(this.getImage(i,t)?r.push(i):e.addPendingRequest(i))}if(0===n.length)return void this._notify(r,t,i);let s=!0;const a=!!this.loaded.get(t),l=this.images.get(t);if(!a)for(const e of n)l.has(e.toString())||(s=!1);a||s?this._notify(n,t,i):this.requestors.push({ids:n,scope:t,callback:i})}rasterizeImages(e,t){const i=new Map,{tasks:n,scope:r}=e;for(const[e,t]of n.entries()){const n=this.getImage(t.id,r);n&&i.set(e,{image:n,imageVariant:t})}this._rasterizeImages(r,i,t)}_rasterizeImages(t,i,n){if(e.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:i,scope:t},n);else{const e=new Map;for(const[n,{image:r,imageVariant:o}]of i.entries())e.set(n,this.imageRasterizer.rasterize(o,r,t,0));n(void 0,e)}}getUpdatedImages(e){return this.updatedImages.get(e)||new Set}_notify(t,i,n){const r=this.images.get(i),o=new Map;for(const i of t){if(!r.get(i.toString())){if(i.iconsetId)continue;this.fire(new e.z("styleimagemissing",{id:i.name}))}const t=r.get(i.toString());if(!t){e.w(`Image "${i.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const n={data:t.usvg?null:t.data.clone(),pixelRatio:t.pixelRatio,sdf:t.sdf,usvg:t.usvg,version:t.version,stretchX:t.stretchX,stretchY:t.stretchY,content:t.content,hasRenderCallback:Boolean(t.userImage&&t.userImage.render)};t.usvg&&Object.assign(n,{width:t.icon.usvg_tree.width,height:t.icon.usvg_tree.height}),o.set(e.I.toString(i),n)}n(null,o)}getPixelSize(e){const{width:t,height:i}=this.atlasImage.get(e);return{width:t,height:i}}getPattern(t,i,n){const r=t.toString(),o=this.patterns.get(i),s=o.get(r),a=this.getImage(t,i);if(!a)return null;if(s){if(s.position.version===a.version)return s.position;s.position.version=a.version}else{if(a.usvg&&!a.data){const o=this.getPatternInFlightId(r,i);if(this.patternsInFlight.has(o))return null;this.patternsInFlight.add(o);const s=new e.A(t).scaleSelf(e.o.devicePixelRatio),l=new Map([[s.toString(),{image:a,imageVariant:s}]]);return this._rasterizeImages(i,l,((e,t)=>this.storePatternImage(s,i,a,n,t))),null}this.storePattern(t,i,a)}return this._updatePatternAtlas(i,n),o.get(r).position}getPatternInFlightId(t,i){return e.B(t,i)}hasPatternsInFlight(){return 0!==this.patternsInFlight.size}storePatternImage(e,t,i,n,r){const o=e.toString(),s=r?r.get(o):void 0;s&&(i.data=s,this.storePattern(e.id,t,i),this._updatePatternAtlas(t,n),this.patternsInFlight.delete(this.getPatternInFlightId(e.id.toString(),t)))}storePattern(t,i,n){const r={w:n.data.width+2*e.C,h:n.data.height+2*e.C,x:0,y:0},o=new e.F(r,n,e.C);this.patterns.get(i).set(t.toString(),{bin:r,position:o})}destroyAtlasTextures(){for(const e of this.atlasTexture.values())e&&e.destroy();this.atlasTexture.clear()}bind(t,i){const n=t.gl;let r=this.atlasTexture.get(i);r?this.dirty&&(r.update(this.atlasImage.get(i)),this.dirty=!1):(r=new e.T(t,this.atlasImage.get(i),n.RGBA8),this.atlasTexture.set(i,r)),r.bind(n.LINEAR,n.CLAMP_TO_EDGE)}_updatePatternAtlas(t,i){const n=this.patterns.get(t),r=Array.from(n.values()).map((({bin:e})=>e)),{w:o,h:s}=e.G(r),a=this.atlasImage.get(t);a.resize({width:o||1,height:s||1});const l=this.images.get(t);for(const[t,{bin:r,position:o}]of n.entries()){let n=o.padding;const s=r.x+n,c=r.y+n,u=l.get(t).data,h=u.width,d=u.height;n=n>1?n-1:n,e.q.copy(u,a,{x:0,y:0},{x:s,y:c},{width:h,height:d},i),e.q.copy(u,a,{x:0,y:d-n},{x:s,y:c-n},{width:h,height:n},i),e.q.copy(u,a,{x:0,y:0},{x:s,y:c+d},{width:h,height:n},i),e.q.copy(u,a,{x:h-n,y:0},{x:s-n,y:c},{width:n,height:d},i),e.q.copy(u,a,{x:0,y:0},{x:s+h,y:c},{width:n,height:d},i),e.q.copy(u,a,{x:h-n,y:d-n},{x:s-n,y:c-n},{width:n,height:n},i),e.q.copy(u,a,{x:0,y:d-n},{x:s+h,y:c-n},{width:n,height:n},i),e.q.copy(u,a,{x:0,y:0},{x:s+h,y:c+d},{width:n,height:n},i),e.q.copy(u,a,{x:h-n,y:0},{x:s-n,y:c+d},{width:n,height:n},i)}this.dirty=!0}beginFrame(){for(const e of this.images.keys())this.callbackDispatchedThisFrame.set(e,new Set)}dispatchRenderCallbacks(e,t){const i=this.images.get(t);for(const n of e){if(this.callbackDispatchedThisFrame.get(t).has(n.toString()))continue;this.callbackDispatchedThisFrame.get(t).add(n.toString());const e=i.get(n.toString());$(e)&&this.updateImage(n,t,e)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function q(t){const i=t.value,n=t.valueSpec,r=t.style,o=t.styleSpec,s=t.key,a=t.arrayElementValidator||me;if(!Array.isArray(i))return[new e.V(s,i,`array expected, ${e.K(i)} found`)];if(n.length&&i.length!==n.length)return[new e.V(s,i,`array length ${n.length} expected, length ${i.length} found`)];if(n["min-length"]&&i.length<n["min-length"])return[new e.V(s,i,`array length at least ${n["min-length"]} expected, length ${i.length} found`)];let l={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};o.$version<7&&(l.function=n.function),e.H(n.value)&&(l=n.value);let c=[];for(let e=0;e<i.length;e++)c=c.concat(a({array:i,arrayIndex:e,value:i[e],valueSpec:l,style:r,styleSpec:o,key:`${s}[${e}]`},!0));return c}function X(t){const i=t.key,n=t.value,r=t.valueSpec;if(!e.L(n))return[new e.V(i,n,`number expected, ${e.K(n)} found`)];if(n!=n)return[new e.V(i,n,"number expected, NaN found")];if("minimum"in r){let o=r.minimum;if(Array.isArray(r.minimum)&&(o=r.minimum[t.arrayIndex]),n<o)return[new e.V(i,n,`${n} is less than the minimum value ${o}`)]}if("maximum"in r){let o=r.maximum;if(Array.isArray(r.maximum)&&(o=r.maximum[t.arrayIndex]),n>o)return[new e.V(i,n,`${n} is greater than the maximum value ${o}`)]}return[]}function Y(t){const i=t.key,n=t.value;if(!e.H(n))return[new e.V(i,n,`object expected, ${e.K(n)} found`)];const r=t.valueSpec,o=e.J(n.type);let s,a,l,c={};const u="categorical"!==o&&void 0===n.property,h=!u,d=function(t){const i=t.stops;return Array.isArray(i)&&Array.isArray(i[0])&&e.H(i[0][0])}(n),p=ge({key:t.key,value:t.value,valueSpec:t.styleSpec.function,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{stops:function(t){if("identity"===o)return[new e.V(t.key,t.value,'identity function may not have a "stops" property')];let i=[];const n=t.value;return i=i.concat(q({key:t.key,value:n,valueSpec:t.valueSpec,style:t.style,styleSpec:t.styleSpec,arrayElementValidator:f})),Array.isArray(n)&&0===n.length&&i.push(new e.V(t.key,n,"array must have at least one stop")),i},default:function(e){return me({key:e.key,value:e.value,valueSpec:r,style:e.style,styleSpec:e.styleSpec})}}});return"identity"===o&&u&&p.push(new e.V(t.key,t.value,'missing required property "property"')),"identity"===o||n.stops||p.push(new e.V(t.key,t.value,'missing required property "stops"')),"exponential"===o&&r.expression&&!e.M(r)&&p.push(new e.V(t.key,t.value,"exponential functions not supported")),t.styleSpec.$version>=8&&(h&&!e.N(r)?p.push(new e.V(t.key,t.value,"property functions not supported")):u&&!e.O(r)&&p.push(new e.V(t.key,t.value,"zoom functions not supported"))),"categorical"!==o&&!d||void 0!==n.property||p.push(new e.V(t.key,t.value,'"property" property is required')),p;function f(t){let i=[];const n=t.value,o=t.key;if(!Array.isArray(n))return[new e.V(o,n,`array expected, ${e.K(n)} found`)];if(2!==n.length)return[new e.V(o,n,`array length 2 expected, length ${n.length} found`)];if(d){if(!e.H(n[0]))return[new e.V(o,n,`object expected, ${e.K(n[0])} found`)];const r=n[0];if(void 0===r.zoom)return[new e.V(o,n,"object stop key must have zoom")];if(void 0===r.value)return[new e.V(o,n,"object stop key must have value")];const s=e.J(r.zoom);if("number"!=typeof s)return[new e.V(o,r.zoom,"stop zoom values must be numbers")];if(l&&l>s)return[new e.V(o,r.zoom,"stop zoom values must appear in ascending order")];s!==l&&(l=s,a=void 0,c={}),i=i.concat(ge({key:`${o}[0]`,value:n[0],valueSpec:{zoom:{}},style:t.style,styleSpec:t.styleSpec,objectElementValidators:{zoom:X,value:m}}))}else i=i.concat(m({key:`${o}[0]`,value:n[0],style:t.style,styleSpec:t.styleSpec},n));return e.Q(e.S(n[1]))?i.concat([new e.V(`${o}[1]`,n[1],"expressions are not allowed in function stops.")]):i.concat(me({key:`${o}[1]`,value:n[1],valueSpec:r,style:t.style,styleSpec:t.styleSpec}))}function m(t,i){const n=e.K(t.value),l=e.J(t.value),u=null!==t.value?t.value:i;if(s){if(n!==s)return[new e.V(t.key,u,`${n} stop domain type must match previous stop domain type ${s}`)]}else s=n;if("number"!==n&&"string"!==n&&"boolean"!==n&&"number"!=typeof l&&"string"!=typeof l&&"boolean"!=typeof l)return[new e.V(t.key,u,"stop domain value must be a number, string, or boolean")];if("number"!==n&&"categorical"!==o){let i=`number expected, ${n} found`;return e.N(r)&&void 0===o&&(i+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new e.V(t.key,u,i)]}return"categorical"!==o||"number"!==n||"number"==typeof l&&isFinite(l)&&Math.floor(l)===l?"categorical"!==o&&"number"===n&&"number"==typeof l&&"number"==typeof a&&void 0!==a&&l<a?[new e.V(t.key,u,"stop domain values must appear in ascending order")]:(a=l,"categorical"===o&&l in c?[new e.V(t.key,u,"stop domain values must be unique")]:(c[l]=!0,[])):[new e.V(t.key,u,`integer expected, found ${String(l)}`)]}}function Z(t){const i=("property"===t.expressionContext?e.W:e.U)(e.S(t.value),t.valueSpec);if("error"===i.result)return i.value.map((i=>new e.V(`${t.key}${i.key}`,t.value,i.message)));const n=i.value.expression||i.value._styleExpression.expression;if("property"===t.expressionContext&&"text-font"===t.propertyKey&&!n.outputDefined())return[new e.V(t.key,t.value,`Invalid data expression for "${t.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===t.expressionContext&&"layout"===t.propertyType&&!e.Z(n))return[new e.V(t.key,t.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===t.expressionContext)return J(n,t);if("appearance"===t.expressionContext)return K(n,t);if(t.expressionContext&&0===t.expressionContext.indexOf("cluster")){if(!e.X(n,["zoom","feature-state"]))return[new e.V(t.key,t.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===t.expressionContext&&!e.Y(n))return[new e.V(t.key,t.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function J(t,i){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(i.valueSpec&&i.valueSpec.expression)for(const e of i.valueSpec.expression.parameters)n.delete(e);if(0===n.size)return[];const r=[];return t instanceof e._&&n.has(t.name)?[new e.V(i.key,i.value,`["${t.name}"] expression is not supported in a filter for a ${i.object.type} layer with id: ${i.object.id}`)]:(t.eachChild((e=>{r.push(...J(e,i))})),r)}function K(t,i){const n=new Set;if(i.valueSpec&&i.valueSpec.expression)for(const e of i.valueSpec.expression.parameters)n.add(e);if(0===n.size)return[];const r=[];return t instanceof e._&&!n.has(t.name)?[new e.V(i.key,i.value,`["${t.name}"] is not an allowed parameter`)]:(t.eachChild((e=>{r.push(...K(e,i))})),r)}function Q(t){const i=t.key,n=t.value,r=t.valueSpec,o=[];return Array.isArray(r.values)?-1===r.values.indexOf(e.J(n))&&o.push(new e.V(i,n,`expected one of [${r.values.join(", ")}], ${JSON.stringify(n)} found`)):-1===Object.keys(r.values).indexOf(e.J(n))&&o.push(new e.V(i,n,`expected one of [${Object.keys(r.values).join(", ")}], ${JSON.stringify(n)} found`)),o}function ee(t){return e.a2(e.S(t.value))?Z(Object.assign({},t,{expressionContext:"filter",valueSpec:t.styleSpec[`filter_${t.layerType||"fill"}`]})):te(t)}function te(t){const i=t.value,n=t.key;if(!Array.isArray(i))return[new e.V(n,i,`array expected, ${e.K(i)} found`)];if(i.length<1)return[new e.V(n,i,"filter array must have at least 1 element")];const r=t.styleSpec;let o=Q({key:`${n}[0]`,value:i[0],valueSpec:r.filter_operator});switch(e.J(i[0])){case"<":case"<=":case">":case">=":i.length>=2&&"$type"===e.J(i[1])&&o.push(new e.V(n,i,`"$type" cannot be use with operator "${i[0]}"`));case"==":case"!=":3!==i.length&&o.push(new e.V(n,i,`filter array for operator "${i[0]}" must have 3 elements`));case"in":case"!in":i.length>=2&&(e.a0(i[1])||o.push(new e.V(`${n}[1]`,i[1],`string expected, ${e.K(i[1])} found`)));for(let t=2;t<i.length;t++)"$type"===e.J(i[1])?o=o.concat(Q({key:`${n}[${t}]`,value:i[t],valueSpec:r.geometry_type})):e.a0(i[t])||e.L(i[t])||e.$(i[t])||o.push(new e.V(`${n}[${t}]`,i[t],`string, number, or boolean expected, ${e.K(i[t])} found.`));break;case"any":case"all":case"none":for(let e=1;e<i.length;e++)o=o.concat(te({key:`${n}[${e}]`,value:i[e],style:t.style,styleSpec:t.styleSpec}));break;case"has":case"!has":2!==i.length?o.push(new e.V(n,i,`filter array for "${i[0]}" operator must have 2 elements`)):e.a0(i[1])||o.push(new e.V(`${n}[1]`,i[1],`string expected, ${e.K(i[1])} found`))}return o}function ie(t,i){const n=t.key,r=t.style,o=t.layer,s=t.styleSpec,a=t.value,l=t.objectKey,c=s[`${i}_${t.layerType}`];if(!c)return[];const u=l.match(/^(.*)-use-theme$/);if(u&&c[u[1]])return e.Q(e.S(a))?[].concat(me({key:n,value:a,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:r,styleSpec:s,expressionContext:"property",propertyType:i,propertyKey:l})):me({key:n,value:a,valueSpec:{type:"string"},style:r,styleSpec:s});const h=l.match(/^(.*)-transition$/);if("paint"===i&&h&&c[h[1]]&&c[h[1]].transition)return me({key:n,value:a,valueSpec:s.transition,style:r,styleSpec:s});const d=t.valueSpec||c[l];if(!d)return[new e.a3(n,a,`unknown property "${l}"`)];let p;if(e.a0(a)&&e.N(d)&&!d.tokens&&(p=/^{([^}]+)}$/.exec(a))){const t=`\`{ "type": "identity", "property": ${p?JSON.stringify(p[1]):'"_"'} }\``;return[new e.V(n,a,`"${l}" does not support interpolation syntax\nUse an identity property function instead: ${t}.`)]}const f=[];if("symbol"===t.layerType)"text-field"!==l||!r||r.glyphs||r.imports||f.push(new e.V(n,a,'use of "text-field" requires a style "glyphs" property')),"text-font"===l&&e.a4(e.S(a))&&"identity"===e.J(a.type)&&f.push(new e.V(n,a,'"text-font" does not support identity functions'));else if("model"===t.layerType&&"paint"===i&&o&&o.layout&&o.layout.hasOwnProperty("model-id")&&e.N(d)&&(e.a5(d)||e.O(d))){const t=e.W(e.S(a),d).value,i="expression"in t&&t.expression||"_styleExpression"in t&&t._styleExpression&&t._styleExpression.expression;i&&!e.X(i,["measure-light"])&&("model-emissive-strength"===l&&e.Y(i)&&e.Z(i)||f.push(new e.V(n,a,`${l} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return f.concat(me({key:t.key,value:a,valueSpec:d,style:r,styleSpec:s,expressionContext:"property",propertyType:i,propertyKey:l}))}function ne(e){return ie(e,"paint")}function re(e){return ie(e,"layout")}function oe(t){let i=[];const n=t.value,r=t.key,o=t.style,s=t.styleSpec;if(!e.H(n))return[new e.V(r,n,"object expected")];n.type||n.ref||i.push(new e.V(r,n,'either "type" or "ref" is required'));let a=e.J(n.type);const l=e.J(n.ref);if(n.id){const s=e.J(n.id);for(let a=0;a<t.arrayIndex;a++){const t=o.layers[a];e.J(t.id)===s&&i.push(new e.V(r,n.id,`duplicate layer id "${s}", previously used at line ${t.id.__line__}`))}}if("ref"in n){let t;["type","source","source-layer","filter","layout"].forEach((t=>{t in n&&i.push(new e.V(r,n[t],`"${t}" is prohibited for ref layers`))})),o.layers.forEach((i=>{e.J(i.id)===l&&(t=i)})),t?t.ref?i.push(new e.V(r,n.ref,"ref cannot reference another ref layer")):a=e.J(t.type):"string"==typeof l&&i.push(new e.V(r,n.ref,`ref layer "${l}" not found`))}else if("background"!==a&&"sky"!==a&&"slot"!==a)if(n.source)if(e.a0(n.source)){const t=o.sources&&o.sources[n.source],s=t&&e.J(t.type);t?"vector"===s&&"raster"===a?i.push(new e.V(r,n.source,`layer "${n.id}" requires a raster source`)):"raster"===s&&"raster"!==a?i.push(new e.V(r,n.source,`layer "${n.id}" requires a vector source`)):"vector"!==s||n["source-layer"]?"raster-dem"===s&&"hillshade"!==a?i.push(new e.V(r,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==s||["raster","raster-particle"].includes(a)?"line"===a&&n.paint&&(n.paint["line-gradient"]||n.paint["line-trim-offset"])&&"geojson"===s&&!t.lineMetrics?i.push(new e.V(r,n,`layer "${n.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):"raster-particle"===a&&"raster-array"!==s&&i.push(new e.V(r,n.source,`layer "${n.id}" requires a 'raster-array' source.`)):i.push(new e.V(r,n.source,"raster-array source can only be used with layer type 'raster'.")):i.push(new e.V(r,n,`layer "${n.id}" must specify a "source-layer"`)):i.push(new e.V(r,n.source,`source "${n.source}" not found`))}else i.push(new e.V(`${r}.source`,n.source,'"source" must be a string'));else i.push(new e.V(r,n,'missing required property "source"'));return i=i.concat(ge({key:r,value:n,valueSpec:s.layer,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":()=>[],type:()=>me({key:`${r}.type`,value:n.type,valueSpec:s.layer.type,style:t.style,styleSpec:t.styleSpec,object:n,objectKey:"type"}),filter:e=>ee(Object.assign({layerType:a},e)),layout:e=>ge({layer:n,key:e.key,value:e.value,valueSpec:{},style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":e=>re(Object.assign({layerType:a},e))}}),paint:e=>ge({layer:n,key:e.key,value:e.value,valueSpec:{},style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":e=>ne(Object.assign({layerType:a,layer:n},e))}}),appearances(t){const i=q({key:t.key,value:t.value,valueSpec:t.valueSpec,style:t.style,styleSpec:t.styleSpec,arrayElementValidator:t=>function(t){const{key:i,layer:n,layerType:r}=t,o=e.J(t.value),s=e.J(o.name),a=e.J(o.condition),l=ge({key:i,value:o,valueSpec:t.styleSpec.appearance,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{condition:t=>function(t){const i=[];return i.push(...Z({key:t.key,value:t.object.condition,valueSpec:e.a6.appearance.condition,expressionContext:"appearance"})),i}(Object.assign({layer:n,layerType:r},t)),properties:t=>function(t){const i=[],{styleSpec:n,layer:r,layerType:o}=t,s=n[`paint_${o}`],a=n[`layout_${o}`],l=t.object[t.objectKey];for(const n in l){const c=n in s?"paint":n in a?"layout":void 0;if(!c){i.push(new e.V(t.key,n,`unknown property "${n}" for layer type "${o}"`));continue}const u=Object.assign({},t,{key:`${t.key}.${n}`,object:l,objectKey:n,layer:r,layerType:o,value:l[n],valueSpec:"paint"===c?s[n]:a[n]});i.push(...ie(u,c))}return i}(Object.assign({layer:n,layerType:r},t))}});return"hidden"!==s&&void 0===a&&l.push(new e.V(t.key,"name",'Appearance with name different than "hidden" must have a condition')),l}(Object.assign({layerType:a,layer:n},t))}),r=Array.isArray(t.value)?t.value:[],o=new Set;return r.forEach(((r,s)=>{const a=e.J(r.name);if(a)if(o.has(a)){const r=e.J(n.id);i.push(new e.V(t.key,a,`Duplicated appearance name "${a}" for layer "${r}"`))}else o.add(a)})),i}}})),i}function se({key:t,value:i}){return e.a0(i)?[]:[new e.V(t,i,`string expected, ${e.K(i)} found`)]}const ae={promoteId:function t({key:i,value:n}){if(e.a0(n))return se({key:i,value:n});if(Array.isArray(n)){const t=[],r=e.S(n),o=e.U(r);return"error"===o.result&&o.value.forEach((n=>{t.push(new e.V(`${i}${n.key}`,null,`${n.message}`))})),e.X(o.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||t.push(new e.V(`${i}`,null,"promoteId expression should be only feature dependent")),t}if(!e.H(n))return[new e.V(i,n,`string, expression or object expected, "${e.K(n)}" found`)];const r=[];for(const e in n)r.push(...t({key:`${i}.${e}`,value:n[e]}));return r}};function le(t){const i=t.value,n=t.key,r=t.styleSpec,o=t.style;if(!e.H(i))return[new e.V(n,i,`object expected, ${e.K(i)} found`)];if(!("type"in i))return[new e.V(n,i,'"type" is required')];const s=e.J(i.type);let a=[];switch(["vector","raster","raster-dem","raster-array"].includes(s)&&("url"in i||"tiles"in i||a.push(new e.a3(n,i,'Either "url" or "tiles" is required.'))),s){case"vector":case"raster":case"raster-dem":case"raster-array":return a=a.concat(ge({key:n,value:i,valueSpec:r[`source_${s.replace("-","_")}`],style:t.style,styleSpec:r,objectElementValidators:ae})),a;case"geojson":if(a=ge({key:n,value:i,valueSpec:r.source_geojson,style:o,styleSpec:r,objectElementValidators:ae}),"cluster"in i&&"clusterProperties"in i){if(!e.H(i.clusterProperties))return[new e.V(`${n}.clusterProperties`,i,`object expected, ${e.K(i)} found`)];for(const t in i.clusterProperties){const r=i.clusterProperties[t];if(!Array.isArray(r))return[new e.V(`${n}.clusterProperties.${t}`,r,"array expected")];const[o,s]=r,l="string"==typeof o?[o,["accumulated"],["get",t]]:o;a.push(...Z({key:`${n}.${t}.map`,value:s,expressionContext:"cluster-map"})),a.push(...Z({key:`${n}.${t}.reduce`,value:l,expressionContext:"cluster-reduce"}))}}return a;case"video":return ge({key:n,value:i,valueSpec:r.source_video,style:o,styleSpec:r});case"image":return ge({key:n,value:i,valueSpec:r.source_image,style:o,styleSpec:r});case"canvas":return[new e.V(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Q({key:`${n}.type`,value:i.type,valueSpec:{values:ce(r)}})}}function ce(e){return e.source.reduce(((t,i)=>{const n=e[i];return"enum"===n.type.type&&(t=t.concat(Object.keys(n.type.values||{}))),t}),[])}function ue(t){const i=t.value,n=t.styleSpec,r=n.light,o=t.style;if(void 0===i)return[];if(!e.H(i))return[new e.V("light",i,`object expected, ${e.K(i)} found`)];let s=[];for(const t in i){const a=t.match(/^(.*)-transition$/),l=t.match(/^(.*)-use-theme$/);s=s.concat(l&&r[l[1]]?me({key:t,value:i[t],valueSpec:{type:"string"},style:o,styleSpec:n}):a&&r[a[1]]&&r[a[1]].transition?me({key:t,value:i[t],valueSpec:n.transition,style:o,styleSpec:n}):r[t]?me({key:t,value:i[t],valueSpec:r[t],style:o,styleSpec:n}):[new e.V(t,i[t],`unknown property "${t}"`)])}return s}function he(t){const i=t.value;if(!i)return[];const n=t.key;if(!e.H(i))return[new e.V(n,i,`object expected, ${e.K(i)} found`)];let r=[];const o=t.styleSpec,s=o["light-3d"],a=t.style,l=t.style.lights;for(const t of["type","id"])if(!(t in i))return r=r.concat([new e.V(n,i,`missing property "${t}"`)]),r;if(!e.a0(i.type))return r=r.concat([new e.V(`${n}.type`,i.type,"string expected")]),r;if(l)for(let o=0;o<t.arrayIndex;o++){const t=e.J(i.type),s=l[o];e.J(s.type)===t&&r.push(new e.V(n,i.id,`duplicate light type "${i.type}", previously defined at line ${s.id.__line__}`))}const c=`properties_light_${i.type}`;if(!(c in o))return r=r.concat([new e.V(`${n}.type`,i,`Invalid light type ${i.type}`)]),r;const u=o[c];for(const n in i)if("properties"===n){const s=i[n];if(!e.H(s))return r=r.concat([new e.V("properties",s,`object expected, ${e.K(s)} found`)]),r;for(const l in s){const c=l.match(/^(.*)-transition$/),h=l.match(/^(.*)-use-theme$/);r=r.concat(h&&u[h[1]]?me({key:n,value:s[l],valueSpec:{type:"string"},style:a,styleSpec:o}):c&&u[c[1]]&&u[c[1]].transition?me({key:n,value:i[n],valueSpec:o.transition,style:a,styleSpec:o}):u[l]?me({key:l,value:s[l],valueSpec:u[l],style:a,styleSpec:o}):[new e.a3(t.key,s[l],`unknown property "${l}"`)])}}else r=r.concat(s[n]?me({key:n,value:i[n],valueSpec:s[n],style:a,styleSpec:o}):[new e.a3(n,i[n],`unknown property "${n}"`)]);return r}function de(t){const i=t.value,n=t.key,r=t.style,o=t.styleSpec,s=o.terrain;if(null==i)return[];if(!e.H(i))return[new e.V("terrain",i,`object expected, ${e.K(i)} found`)];let a=[];for(const t in i){const n=t.match(/^(.*)-transition$/),l=t.match(/^(.*)-use-theme$/);a=a.concat(l&&s[l[1]]?me({key:t,value:i[t],valueSpec:{type:"string"},style:r,styleSpec:o}):n&&s[n[1]]&&s[n[1]].transition?me({key:t,value:i[t],valueSpec:o.transition,style:r,styleSpec:o}):s[t]?me({key:t,value:i[t],valueSpec:s[t],style:r,styleSpec:o}):[new e.a3(t,i[t],`unknown property "${t}"`)])}if(i.source)if(e.a0(i.source)){const t=r.sources&&r.sources[i.source],o=t&&e.J(t.type);t?"raster-dem"!==o&&a.push(new e.V(`${n}.source`,i.source,`terrain cannot be used with a source of type ${o}, it only be used with a "raster-dem" source type`)):a.push(new e.V(`${n}.source`,i.source,`source "${i.source}" not found`))}else a.push(new e.V(`${n}.source`,i.source,"source must be a string"));else a.push(new e.V(n,i,'terrain is missing required property "source"'));return a}function pe(t){const i=t.value,n=t.style,r=t.styleSpec,o=r.fog;if(void 0===i)return[];if(!e.H(i))return[new e.V("fog",i,`object expected, ${e.K(i)} found`)];let s=[];for(const t in i){const a=t.match(/^(.*)-transition$/),l=t.match(/^(.*)-use-theme$/);s=s.concat(l&&o[l[1]]?me({key:t,value:i[t],valueSpec:{type:"string"},style:n,styleSpec:r}):a&&o[a[1]]&&o[a[1]].transition?me({key:t,value:i[t],valueSpec:r.transition,style:n,styleSpec:r}):o[t]?me({key:t,value:i[t],valueSpec:o[t],style:n,styleSpec:r}):[new e.a3(t,i[t],`unknown property "${t}"`)])}return s}const fe={"*":()=>[],array:q,boolean:function(t){const i=t.value,n=t.key;return e.$(i)?[]:[new e.V(n,i,`boolean expected, ${e.K(i)} found`)]},number:X,color:function({key:t,value:i}){return e.a0(i)?null===e.a1.parseCSSColor(i)?[new e.V(t,i,`color expected, "${i}" found`)]:[]:[new e.V(t,i,`color expected, ${e.K(i)} found`)]},enum:Q,filter:ee,function:Y,layer:oe,object:ge,source:le,model:e.a7,light:ue,"light-3d":he,terrain:de,fog:pe,string:se,formatted:function(e){return 0===se(e).length?[]:Z(e)},resolvedImage:function(e){return 0===se(e).length?[]:Z(e)},projection:function(t){const i=t.value,n=t.styleSpec,r=n.projection,o=t.style;if(e.H(i)){let e=[];for(const t in i)e=e.concat(me({key:t,value:i[t],valueSpec:r[t],style:o,styleSpec:n}));return e}return e.a0(i)?[]:[new e.V("projection",i,`object or string expected, ${e.K(i)} found`)]},import:function(t){const i=t.key,{value:n,styleSpec:r}=t;if(!e.H(n))return[new e.V(i,n,"import must be an object")];const{data:o,...s}=n;Object.defineProperty(s,"__line__",{value:n.__line__,enumerable:!1});let a=ge(Object.assign({},t,{value:s,valueSpec:r.import}));return""===e.J(s.id)&&a.push(new e.V(`${t.key}.id`,s,"import id can't be an empty string")),o&&(a=a.concat(ye(o,r,{key:`${t.key}.data`}))),a},iconset:function(t){const i=t.value,n=t.key,r=t.styleSpec,o=t.style;if(!e.H(i))return[new e.V(n,i,"object expected")];if(!i.type)return[new e.V(n,i,'"type" is required')];const s=e.J(i.type);let a=[];if(a=a.concat(ge({key:n,value:i,valueSpec:r[`iconset_${s}`],style:o,styleSpec:r})),function(e,t){return!("source"!==e||!t.source)}(s,i)){const t=o.sources&&o.sources[i.source],r=t&&e.J(t.type);t?"raster-array"!==r&&a.push(new e.V(n,i.source,`iconset cannot be used with a source of type ${String(r)}, it only be used with a "raster-array" source type`)):a.push(new e.V(n,i.source,`source "${i.source}" not found`))}return a}};function me(t,i=!1){const n=t.value,r=t.valueSpec,o=t.styleSpec;if(r.expression){if(e.a4(e.J(n)))return Y(t);if(e.Q(e.S(n)))return Z(t)}if(r.type&&fe[r.type]){const e=fe[r.type](t);return!0===i&&e.length>0&&Array.isArray(t.value)?Z(t):e}return ge(Object.assign({},t,{valueSpec:r.type?o[r.type]:r}))}function ge(t){const i=t.key,n=t.value,r=t.valueSpec||{},o=t.objectElementValidators||{},s=t.style,a=t.styleSpec;if(!e.H(n))return[new e.V(i,n,`object expected, ${e.K(n)} found`)];let l=[];for(const t in n){const c=t.split(".")[0];let u;o[c]?u=o[c]:r[c]?u=me:o["*"]?u=o["*"]:r["*"]&&(u=me),u?l=l.concat(u({key:(i?`${i}.`:i)+t,value:n[t],valueSpec:r[c]||r["*"],style:s,styleSpec:a,object:n,objectKey:t},n)):l.push(new e.a3(i,n[t],`unknown property "${t}"`))}for(const t in r){if(o[t])continue;const s=r[t];s.required&&void 0===s.default&&void 0===n[t]&&l.push(new e.V(i,n,`missing required property "${t}"`))}return l}function _e({key:t,value:i}){const n=se({key:t,value:i});if(n.length)return n;const r=i;return-1===r.indexOf("{fontstack}")&&n.push(new e.V(t,i,'"glyphs" url must include a "{fontstack}" token')),-1===r.indexOf("{range}")&&n.push(new e.V(t,i,'"glyphs" url must include a "{range}" token')),n}function ye(t,i=e.a6,n={}){return ge({key:n.key||"",value:t,valueSpec:Object.assign(i.$root,{"*":{type:"*"}}),styleSpec:i,style:t,objectElementValidators:{glyphs:_e}})}function ve(t,i=e.a6){return Re(ye(t,i))}const xe=e=>Re(le(e)),be=e=>Re(ue(e)),Te=e=>Re(he(e)),we=e=>Re(de(e)),Ee=e=>Re(pe(e)),Se=t=>Re(function(t){const i=t.value,n=t.style,r=t.styleSpec,o=r.snow;if(void 0===i)return[];if(!e.H(i))return[new e.V("snow",i,`object expected, ${e.K(i)} found`)];let s=[];for(const t in i){const a=t.match(/^(.*)-transition$/);s=s.concat(a&&o[a[1]]&&o[a[1]].transition?me({key:t,value:i[t],valueSpec:r.transition,style:n,styleSpec:r}):o[t]?me({key:t,value:i[t],valueSpec:o[t],style:n,styleSpec:r}):[new e.a3(t,i[t],`unknown property "${t}"`)])}return s}(t)),Ae=t=>Re(function(t){const i=t.value,n=t.style,r=t.styleSpec,o=r.rain;if(void 0===i)return[];if(!e.H(i))return[new e.V("rain",i,`object expected, ${e.K(i)} found`)];let s=[];for(const t in i){const a=t.match(/^(.*)-transition$/);s=s.concat(a&&o[a[1]]&&o[a[1]].transition?me({key:t,value:i[t],valueSpec:r.transition,style:n,styleSpec:r}):o[t]?me({key:t,value:i[t],valueSpec:o[t],style:n,styleSpec:r}):[new e.a3(t,i[t],`unknown property "${t}"`)])}return s}(t)),Me=e=>Re(oe(e)),Ie=e=>Re(ee(e)),Ce=e=>Re(ne(e)),Pe=e=>Re(re(e)),Le=t=>Re(e.a7(t));function Re(e){return e.slice().sort(((e,t)=>e.line&&t.line?e.line-t.line:0))}function Oe(t,i){let n=!1;if(i&&i.length)for(const r of i)r instanceof e.a3?e.w(r.message):(t.fire(new e.y(new Error(r.message))),n=!0);return n}const De=e.a6.light;let Be;class Fe extends e.E{constructor(t,i="flat"){super(),this._transitionable=new e.a8(Be||(Be=new e.a9({anchor:new e.aa(De.anchor),position:new e.ab(De.position),color:new e.aa(De.color),intensity:new e.aa(De.intensity)}))),this.setLight(t,i),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,t,i={}){this._validate(be,e,i)||(this._transitionable.setTransitionOrValue(e),this.id=t)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,i,n){return(!n||!1!==n.validate)&&Oe(this,t.call(ve,Object.assign({value:i,style:{glyphs:!0,sprite:!0},styleSpec:e.a6})))}}const Ne=e.a6.terrain;let ke=class extends e.E{constructor(t,i,n,r,o){super(),this.scope=n,this._transitionable=new e.a8(new e.a9({source:new e.aa(Ne.source),exaggeration:new e.aa(Ne.exaggeration)}),n,r),this._transitionable.setTransitionOrValue(t,r),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=i,this.worldview=o}get(){return this._transitionable.serialize()}set(e,t){this._transitionable.setTransitionOrValue(e,t)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}getExaggeration(t){return this._transitioning.possiblyEvaluate(new e.ac(t,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const t=this._transitionable._values.exaggeration;if(!t)return null;const i=t.value.expression;if(!i)return null;let n=-1,r=-1,o=1;for(const t of i.zoomStops)o=i.evaluate(new e.ac(t,{worldview:this.worldview})),o>.01?(n=t,r=-1):r=t;return o<.01&&n>0&&r>n?[n,r]:null}isZoomDependent(){const t=this._transitionable._values.exaggeration;return null!=t&&null!=t.value&&null!=t.value.expression&&t.value.expression instanceof e.ad}};const Ue=45,ze=65,Ve=.05;function Ge(t,i,n,r){const o=e.ah(Ue,ze,n),[s,a]=je(t,r);let l=1-Math.min(1,Math.exp((i-s)/(a-s)*-6));return l*=l*l,l=Math.min(1,1.00747*l),l*o*t.alpha}function je(e,t){const i=.5/Math.tan(.5*t);return[e.range[0]+i,e.range[1]+i]}function He(t,i,n,r,o){const s=e.af([],[i,n,r],o.mercatorFogMatrix);return Ge(t,e.ag(s),o.pitch,o._fov)}function $e(t,i,n,r,o,s,a){const l=[[n,r,0],[o,r,0],[o,s,0],[n,s,0]];let c=Number.MAX_VALUE,u=-Number.MAX_VALUE;for(const t of l){const n=e.af([],t,i),r=e.ag(n);c=Math.min(c,r),u=Math.max(u,r)}return[Ge(t,c,a.pitch,a._fov),Ge(t,u,a.pitch,a._fov)]}const We=e.a6.fog;class qe extends e.E{constructor(t,i,n,r){super();const o=new e.a9({range:new e.aa(We.range),color:new e.aa(We.color),"color-use-theme":new e.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new e.aa(We["high-color"]),"high-color-use-theme":new e.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new e.aa(We["space-color"]),"space-color-use-theme":new e.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new e.aa(We["horizon-blend"]),"star-intensity":new e.aa(We["star-intensity"]),"vertical-range":new e.aa(We["vertical-range"])});this._transitionable=new e.a8(o,n,new Map(r)),this.set(t,r),this._transitioning=this._transitionable.untransitioned(),this._transform=i,this.properties=new e.ai(o),this.scope=n}get state(){const t=this._transform,i="globe"===t.projection.name,n=e.aj(t.zoom),r=this.properties.get("range"),o=[.5,3];return{range:i?[e.ak(o[0],r[0],n),e.ak(o[1],r[1],n)]:r,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(e,t,i={}){if(this._validate(Ee,e,i))return;const n=Object.assign({},e);for(const e of Object.keys(We))void 0===n[e]&&(n[e]=We[e].default);this._options=n,this._transitionable.setTransitionOrValue(this._options,t)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const i=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:e.ah(Ue,ze,t))*i.a}getOpacityAtLatLng(t,i){return this._transform.projection.supportsFog?function(t,i,n){const r=e.ae.fromLngLat(i),o=n.elevation?n.elevation.getAtPointOrZero(r):0;return He(t,r.x,r.y,o,n)}(this.state,t,i):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const i=this._transform.calculateFogTileMatrix(t.toUnwrapped());return $e(this.state,i,0,0,e.al,e.al,this._transform)}getOpacityForBounds(e,t,i,n,r){return this._transform.projection.supportsFog?$e(this.state,e,t,i,n,r,this._transform):[1,1]}getFovAdjustedRange(e){return this._transform.projection.supportsFog?je(this.state,e):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const i=[4,5,6,7];for(const n of i){const i=t.points[n];let r;if(i[2]>=0)r=i;else{const o=t.points[n-4];r=e.am(o,i,o[2]/(o[2]-i[2]))}if(He(this.state,r[0],r[1],0,this._transform)>=Ve)return!0}return!1}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,i,n){return(!n||!1!==n.validate)&&Oe(this,t.call(ve,Object.assign({value:i,style:{glyphs:!0,sprite:!0},styleSpec:e.a6})))}}let Xe,Ye,Ze,Je,Ke=class extends e.E{constructor(t,i,n,r){super();const o=Xe||(Xe=new e.a9({density:new e.aa(e.a6.snow.density),intensity:new e.aa(e.a6.snow.intensity),color:new e.aa(e.a6.snow.color),opacity:new e.aa(e.a6.snow.opacity),vignette:new e.aa(e.a6.snow.vignette),"vignette-color":new e.aa(e.a6.snow["vignette-color"]),"center-thinning":new e.aa(e.a6.snow["center-thinning"]),direction:new e.aa(e.a6.snow.direction),"flake-size":new e.aa(e.a6.snow["flake-size"])}));this._transitionable=new e.a8(o,n,new Map(r)),this.set(t,r),this._transitioning=this._transitionable.untransitioned(),this.properties=new e.ai(o),this.scope=n}get state(){const t=this.properties.get("opacity"),i=this.properties.get("color"),n=this.properties.get("direction"),r=e.an(n[0]),o=-Math.max(e.an(n[1]),.01),s=[Math.cos(r)*Math.cos(o),Math.sin(r)*Math.cos(o),Math.sin(o)],a=this.properties.get("vignette"),l=this.properties.get("vignette-color");return l.a=a,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new e.ao(i.r,i.g,i.b,i.a*t),direction:s,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:l}}get(){return this._transitionable.serialize()}set(t,i,n={}){if(this._validate(Se,t,n))return;const r=Object.assign({},t),o=e.a6.snow;for(const e of Object.keys(o))void 0===r[e]&&(r[e]=o[e].default);this._options=r,this._transitionable.setTransitionOrValue(this._options,i)}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,i,n){return(!n||!1!==n.validate)&&Oe(this,t.call(ve,Object.assign({value:i,style:{glyphs:!0,sprite:!0},styleSpec:e.a6})))}},Qe=class extends e.E{constructor(t,i,n,r){super();const o=Ye||(Ye=new e.a9({density:new e.aa(e.a6.rain.density),intensity:new e.aa(e.a6.rain.intensity),color:new e.aa(e.a6.rain.color),opacity:new e.aa(e.a6.rain.opacity),vignette:new e.aa(e.a6.rain.vignette),"vignette-color":new e.aa(e.a6.rain["vignette-color"]),"center-thinning":new e.aa(e.a6.rain["center-thinning"]),direction:new e.aa(e.a6.rain.direction),"droplet-size":new e.aa(e.a6.rain["droplet-size"]),"distortion-strength":new e.aa(e.a6.rain["distortion-strength"])}));this._transitionable=new e.a8(o,n,new Map(r)),this.set(t,r),this._transitioning=this._transitionable.untransitioned(),this.properties=new e.ai(o),this.scope=n}get state(){const t=this.properties.get("opacity"),i=this.properties.get("color"),n=this.properties.get("direction"),r=e.an(n[0]),o=-Math.max(e.an(n[1]),.01),s=[Math.cos(r)*Math.cos(o),Math.sin(r)*Math.cos(o),Math.sin(o)],a=this.properties.get("vignette-color");return a.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new e.ao(i.r,i.g,i.b,i.a*t),direction:s,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:a}}get(){return this._transitionable.serialize()}set(t,i,n={}){if(this._validate(Ae,t,n))return;const r=Object.assign({},t),o=e.a6.rain;for(const e of Object.keys(o))void 0===r[e]&&(r[e]=o[e].default);this._options=r,this._transitionable.setTransitionOrValue(this._options,i)}updateConfig(e){this._transitionable.setTransitionOrValue(this._options,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}_validate(t,i,n){return(!n||!1!==n.validate)&&Oe(this,t.call(ve,Object.assign({value:i,style:{glyphs:!0,sprite:!0},styleSpec:e.a6})))}};class et extends e.E{constructor(t,i,n,r){super(),this.scope=n,this._options=t,this.properties=new e.ai(i),this._transitionable=new e.a8(i,n,new Map(r)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(e){this._transitionable.setTransitionOrValue(this._options.properties,new Map(e))}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(e,t){this._options=e,this._transitionable.setTransitionOrValue(e.properties,t)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}class tt{constructor(e,t,i){this.screenBounds=e,this.cameraPoint=i.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=t,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,i)}static createFromScreenPoints(t,i){let n,r;if(t instanceof e.P||"number"==typeof t[0]){const o=e.P.convert(t);n=[o],r=i.isPointAboveHorizon(o)}else{const o=e.P.convert(t[0]),s=e.P.convert(t[1]),a=o.add(s)._div(2);n=[o,s],r=e.aq(o,s).every((e=>i.isPointAboveHorizon(e)))&&i.isPointAboveHorizon(a)}return new tt(n,r,i)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(t){return e.aq(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const i=this.screenBounds[0],n=1===this.screenBounds.length?this.screenBounds[0].add(new e.P(1,1)):this.screenBounds[1],r=e.aq(i,n,0,!1);return this.cameraPoint.y>n.y&&(this.cameraPoint.x>i.x&&this.cameraPoint.x<n.x?r.splice(3,0,this.cameraPoint):this.cameraPoint.x>=n.x?r[2]=this.cameraPoint:this.cameraPoint.x<=i.x&&(r[3]=this.cameraPoint)),e.ar(r,t)}bufferedCameraGeometryGlobe(t){const i=this.screenBounds[0],n=1===this.screenBounds.length?this.screenBounds[0].add(new e.P(1,1)):this.screenBounds[1],r=e.aq(i,n,t),o=this.cameraPoint.clone();switch(3*((o.y>i.y)+(o.y>n.y))+((o.x>i.x)+(o.x>n.x))){case 0:r[0]=o,r[4]=o.clone();break;case 1:r.splice(1,0,o);break;case 2:r[1]=o;break;case 3:r.splice(4,0,o);break;case 5:r.splice(2,0,o);break;case 6:r[3]=o;break;case 7:r.splice(3,0,o);break;case 8:r[2]=o}return r}containsTile(t,i,n,r=0){const o=Math.max(t.queryPadding,t.evaluateQueryRenderedFeaturePadding())/i._pixelsPerMercatorPixel+1,s=n?this._bufferedCameraMercator(o,i):this._bufferedScreenMercator(o,i);let a=t.tileID.wrap+(s.unwrapped?r:0);const l=s.polygon.map((i=>e.as(t.tileTransform,i,a)));if(!e.at(l,0,0,e.al,e.al))return;a=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?r:0);const c=this.screenGeometryMercator.polygon.map((i=>e.au(t.tileTransform,i,a))),u=c.map((t=>new e.P(t[0],t[1]))),h=i.getFreeCameraOptions().position||new e.ae(0,0,0),d=e.au(t.tileTransform,h,a),p=c.map((t=>{const i=e.av(t,t,d);return e.aw(i,i),new e.ax(d,i)})),f=e.ay(t,1,i.zoom)*i._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:u,tilespaceRays:p,bufferedTilespaceGeometry:l,bufferedTilespaceBounds:(m=e.az(l),m.min.x=e.aA(m.min.x,0,e.al),m.min.y=e.aA(m.min.y,0,e.al),m.max.x=e.aA(m.max.x,0,e.al),m.max.y=e.aA(m.max.y,0,e.al),m),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:f};var m}_bufferedScreenMercator(e,t){const i=rt(e);if(this._screenRaycastCache[i])return this._screenRaycastCache[i];{let n;return n="globe"===t.projection.name?this._projectAndResample(this.bufferedScreenGeometry(e),t):{polygon:this.bufferedScreenGeometry(e).map((e=>t.pointCoordinate3D(e))),unwrapped:!0},this._screenRaycastCache[i]=n,n}}_bufferedCameraMercator(e,t){const i=rt(e);if(this._cameraRaycastCache[i])return this._cameraRaycastCache[i];{let n;return n="globe"===t.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(e),t):{polygon:this.bufferedCameraGeometry(e).map((e=>t.pointCoordinate3D(e))),unwrapped:!0},this._cameraRaycastCache[i]=n,n}}_projectAndResample(t,i){const n=function(t,i){const n=e.aB([],i.pixelMatrix,i.globeMatrix),r=[0,-e.aD,0,1],o=[0,e.aD,0,1],s=[0,0,0,1];e.aC(r,r,n),e.aC(o,o,n),e.aC(s,s,n);const a=new e.P(r[0]/r[3],r[1]/r[3]),l=new e.P(o[0]/o[3],o[1]/o[3]),c=e.aE(t,a)&&r[3]<s[3],u=e.aE(t,l)&&o[3]<s[3];if(!c&&!u)return null;const h=function(e,t,i){for(let n=1;n<e.length;n++){const r=nt(t.pointCoordinate3D(e[n-1]).x),o=nt(t.pointCoordinate3D(e[n]).x);if(i<0){if(r<o)return{idx:n,t:-r/(o-1-r)}}else if(o<r)return{idx:n,t:(1-r)/(o+1-r)}}return null}(t,i,c?-1:1);if(!h)return null;const{idx:d,t:p}=h;let f=d>1?it(t.slice(0,d),i):[],m=d<t.length?it(t.slice(d),i):[];f=f.map((t=>new e.P(nt(t.x),t.y))),m=m.map((t=>new e.P(nt(t.x),t.y)));const g=[...f];0===g.length&&g.push(m[m.length-1]);const _=e.ak(g[g.length-1].y,(0===m.length?f[0]:m[0]).y,p);let y;return y=c?[new e.P(0,_),new e.P(0,0),new e.P(1,0),new e.P(1,_)]:[new e.P(1,_),new e.P(1,1),new e.P(0,1),new e.P(0,_)],g.push(...y),0===m.length?g.push(f[0]):g.push(...m),{polygon:g.map((t=>new e.ae(t.x,t.y))),unwrapped:!1}}(t,i);if(n)return n;const r=function(t,i){let n=!1,r=-1/0,o=0;for(let e=0;e<t.length-1;e++)t[e].x>r&&(r=t[e].x,o=e);for(let e=0;e<t.length-1;e++){const i=(o+e)%(t.length-1),r=t[i],s=t[i+1];Math.abs(r.x-s.x)>.5&&(r.x<s.x?(r.x+=1,0===i&&(t[t.length-1].x+=1)):(s.x+=1,i+1===t.length-1&&(t[0].x+=1)),n=!0)}const s=e.aF(i.center.lng);return n&&s<Math.abs(s-1)&&t.forEach((e=>{e.x-=1})),{polygon:t,unwrapped:n}}(it(t,i).map((t=>new e.P(nt(t.x),t.y))),i);return{polygon:r.polygon.map((t=>new e.ae(t.x,t.y))),unwrapped:r.unwrapped}}}function it(t,i){return e.aG(t,(e=>{const t=i.pointCoordinate3D(e);e.x=t.x,e.y=t.y}),1/256)}function nt(e){return e<0?1+e%1:e%1}function rt(e){return 100*e|0}function ot(t,i,n,r,o){const s=function(n,r){if(n)return o(n);if(r){if(t.url&&r.tiles&&t.tiles&&delete t.tiles,r.variants){if(!Array.isArray(r.variants))return o(new Error("variants must be an array"));for(const e of r.variants){if(null==e||"object"!=typeof e||e.constructor!==Object)return o(new Error("variant must be an object"));if(!Array.isArray(e.capabilities))return o(new Error("capabilities must be an array"));if(1===e.capabilities.length&&"meshopt"===e.capabilities[0]){r=Object.assign(r,e);break}}}const n=e.aH(Object.assign({},r,t),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);n.tiles=i.canonicalizeTileset(n,t.url),o(null,n)}},a=function(e,t,i){if(!e)return null;if(!t&&!i)return e;i=i||e.worldview_default;const n=Object.values(e.language||{});if(0===n.length)return null;const r=Object.values(e.worldview||{});if(0===r.length)return null;const o=n.every((e=>e===t)),s=r.every((e=>e===i));return o&&s?e:t in(e.language_options||{})||i in(e.worldview_options||{})?null:e.language_options&&e.worldview_options?e:null}(t.data,n,r);return a?e.o.frame((()=>s(null,a))):t.url?e.m(i.transformRequest(i.normalizeSourceURL(t.url,null,n,r),e.R.Source),s):e.o.frame((()=>{const{data:e,...i}=t;s(null,i)}))}function st(t,i){const n=Math.pow(2,i.z),r=Math.floor(e.aF(t.getWest())*n),o=Math.floor(e.aJ(t.getNorth())*n),s=Math.ceil(e.aF(t.getEast())*n),a=Math.ceil(e.aJ(t.getSouth())*n);return i.x>=r&&i.x<s&&i.y>=o&&i.y<a}class at{constructor(t,i,n){this.bounds=t?e.aI.convert(this.validateBounds(t)):null,this.minzoom=i||0,this.maxzoom=n||24}validateBounds(e){return Array.isArray(e)&&4===e.length?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const i of t)this.extraBounds.push(e.aI.convert(this.validateBounds(i)))}}contains(e){if(e.z>this.maxzoom||e.z<this.minzoom)return!1;if(this.bounds&&!st(this.bounds,e))return!1;if(!this.extraBounds)return!0;for(const t of this.extraBounds)if(st(t,e))return!0;return!1}static fromTileJSON(e){if(!e.bounds&&!e.extra_bounds)return null;const t=new at(e.bounds,e.minzoom,e.maxzoom);return t.addExtraBounds(e.extra_bounds),t}}class lt extends e.E{constructor(t,i,n,r){if(super(),this.id=t,this.dispatcher=n,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,e.aH(i,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},i),this._collectResourceTiming=!!i.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(r),this._tileWorkers={},this._deduped=new e.aK}load(t){this._loaded=!1,this.fire(new e.z("dataloading",{dataType:"source"}));const i=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map.getWorldview();this._tileJSONRequest=ot(this._options,this.map._requestManager,i,n,((i,n)=>{if(this._tileJSONRequest=null,this._loaded=!0,i)this.fire(new e.y(i));else if(n){if(Object.assign(this,n),this.hasWorldviews=!!n.worldview_options,n.worldview_default&&(this.worldviewDefault=n.worldview_default),n.vector_layers){this.vectorLayers=n.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const e of n.vector_layers)this.vectorLayerIds.push(e.id),n.worldview&&n.worldview[e.source]&&this.localizableLayerIds.add(e.id)}this.tileBounds=at.fromTileJSON(n),L(n.tiles,this.map._requestManager._customAccessToken),this.fire(new e.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(i)}))}loaded(){return this._loaded}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const t=e.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(t,i){const n=t.tileID.canonical.url(this.tiles,this.scheme),r=this.map._requestManager.normalizeTileURL(n),o=this.map._requestManager.transformRequest(r,e.R.Tile),s=this.map.style?this.map.style.getLut(this.scope):null,a=s?{image:s.image.clone()}:null,l={request:o,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:a,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:e.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};if(this.hasWorldviews&&e.h(n)&&(l.localizableLayerIds=this.localizableLayerIds),l.request.collectResourceTiming=this._collectResourceTiming,t.actor&&"expired"!==t.state)"loading"===t.state?t.reloadCallback=i:t.request=t.actor.send("reloadTile",l,c.bind(this));else if(t.actor=this._tileWorkers[r]=this._tileWorkers[r]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",l,c.bind(this),void 0,!0);else{const i=e.aL.call({deduped:this._deduped},l,((i,n)=>{if(i||!n)c.call(this,i);else{const i=e.aM(n.responseHeaders);l.data={cacheControl:i.cacheControl,expires:i.expires,rawData:n.rawData.slice(0)},t.actor&&t.actor.send("loadTile",l,c.bind(this),void 0,!0)}}),!0);t.request={cancel:i}}function c(n,r){return delete t.request,t.aborted?i(null):n&&404!==n.status?i(n):(r&&r.resourceTiming&&(t.resourceTiming=r.resourceTiming),this.map._refreshExpiredTiles&&r&&t.setExpiryData(r),t.loadVectorData(r,this.map.painter),e.aN(this.dispatcher),i(null,r),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,t){e.actor&&e.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ct extends e.E{constructor(t,i,n,r){super(),this.id=t,this.dispatcher=n,this.setEventedParent(r),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},i),Object.assign(this,e.aH(i,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new e.z("dataloading",{dataType:"source"}));const i=this.map.getWorldview();this._tileJSONRequest=ot(this._options,this.map._requestManager,null,i,((i,n)=>{this._tileJSONRequest=null,this._loaded=!0,i?this.fire(new e.y(i)):n&&(Object.assign(this,n),n.raster_layers&&(this.rasterLayers=n.raster_layers,this.rasterLayerIds=this.rasterLayers.map((e=>e.id))),this.tileBounds=at.fromTileJSON(n),L(n.tiles),this.fire(new e.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(i)}))}loaded(){return this._loaded}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const t=e.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(e){return this._options.tiles=e,this.reload(),this}setUrl(e){return this.url=e,this._options.url=e,this.reload(),this}onRemove(e){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(t,i){const n=e.o.devicePixelRatio>=2,r=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),n,this.tileSize);t.request=e.n(this.map._requestManager.transformRequest(r,e.R.Tile),((n,r,o)=>{if(delete t.request,t.aborted)return t.state="unloaded",i(null);if(n)return t.state="errored",i(n);if(!r)return i(null);const s=e.aM(o);this.map._refreshExpiredTiles&&t.setExpiryData(s),t.setTexture(r,this.map.painter),t.state="loaded",e.aN(this.dispatcher),i(null)}))}abortTile(e,t){e.request&&(e.request.cancel(),delete e.request),t&&t()}unloadTile(t,i){t.texture&&t.texture instanceof e.T?(t.destroy(!0),t.texture&&t.texture instanceof e.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),i&&i()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function ut([t,i],n,r,{scaled:o=!0}={}){const{tileSize:s,buffer:a}=r,{x:l,y:c,z:u}=n;if(!isFinite(l)||!isFinite(c)||!isFinite(u))throw new Error("Invalid MRT header");const h=2**u,d=h*e.aF(t),p=h*e.aJ(i);return function([e,t],i,{scaled:n=!0}={}){if(!i)throw new Error("bandView is undefined");const{data:r,tileSize:o,buffer:s,offset:a,scale:l,dimension:c}=i;if(e<-s||e>o+s||t<-s||t>o+s)throw new Error(`Point (${e}, ${t}) out of bounds for tileSize=${o}, buffer=${s}`);const u=(t+s)*(o+2*s)+(e+s);if(4294967295===new Uint32Array(r.buffer)[u])return null;let h=[];h=n?[]:new i.data.constructor(c);for(let e=0;e<c;e++)h[e]=Math.round(1e12*(r[c*u+e]*l+a))/1e12;return h}([Math.min(Math.max(-a,Math.floor((d-l)*s)),s-1+a),Math.min(Math.max(-a,Math.floor((p-c)*s)),s-1+a)],r,{scaled:o})}class ht extends ct{constructor(e,t,i,n){super(e,t,i,n),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},t)}triggerRepaint(e){const t=this.map.painter._terrain,i=this.map.style.getSourceCache(this.id);t&&t.enabled&&i&&t._clearRenderCacheForTile(i.id,e.tileID),this.map.triggerRepaint()}loadTile(t,i){const n=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),r=this.map._requestManager.transformRequest(n,e.R.Tile),o={request:r,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=r,t.actor||(t.actor=this.dispatcher.getActor());const s=(n,r,o)=>{if(delete t.request,t.aborted)return t.state="unloaded",i(null);if(n){if("AbortError"===n.name)return;return t.state="errored",i(n)}if(this.map._refreshExpiredTiles&&r){const i=e.aM(o);t.setExpiryData(i)}if(this.partial&&"expired"!==t.state)t.state="empty";else if(!this.partial){if(!r)return i(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=r}i(null)};t.request=this.partial?t.fetchHeader(void 0,s.bind(this)):t.actor.send("loadTile",o,s.bind(this),void 0,!0)}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(e,t){const i=e.texturePerLayer;if(e.flushAllQueues(),i.size){e.destroy(!0);for(const e of i.values())this.map.painter.saveTileTexture(e)}else e.destroy()}prepareTile(t,i,n,r){t._isHeaderLoaded&&("empty"!==t.state&&(t.state="reloading"),t.fetchBandForRender(i,n,r,((i,r)=>{if(i)return t.state="errored",this.fire(new e.y(i)),void this.triggerRepaint(t);r&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(n,r,this.map.painter),t.state="loaded",this.triggerRepaint(t))})))}getInitialBand(e){if(!this.rasterLayers)return 0;const t=this.rasterLayers.find((({id:t})=>t===e)),i=t&&t.fields,n=i&&i.bands&&i.bands;return n?n[0]:0}getTextureDescriptor(t,i,n){if(!t)return;const r=i.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!r)return;let o=null;i instanceof e.aQ?o=i.paint.get("raster-array-band"):i instanceof e.aR&&(o=i.paint.get("raster-particle-array-band"));const s=o||this.getInitialBand(r);if(null==s)return;if(!t.textureDescriptorPerLayer.get(i.id))return void this.prepareTile(t,r,i.id,s);if(t.updateNeeded(i.id,s)&&!n)return;const a=t.textureDescriptorPerLayer.get(i.id);return Object.assign({},a,{texture:t.texturePerLayer.get(i.id)})}getImages(t,i){const n=new Map;for(const r of t)for(const t of i){const[i,o]=t.split("/"),s=r.getLayer(i);if(!s)continue;if(!s.hasBand(o)||!s.hasDataForBand(o))continue;const{bytes:a,tileSize:l,buffer:c}=s.getBandView(o),u=l+2*c,h={data:new e.q({width:u,height:u},a),pixelRatio:2,sdf:!1,usvg:!1,version:0};n.set(t,h)}return n}queryRasterArrayValueByBandId(t,i,n){const r=i._mrt;return new Promise((o=>{const s={},a=new Set;for(const[l,c]of Object.entries(r.layers)){if(n.layerName&&l!==n.layerName)continue;const u={};s[l]=u;for(const{bands:h}of c.dataIndex)for(const d of h)n.bands&&!n.bands.includes(d)||(a.add(e.B(l,d)),i.fetchBand(l,null,d,(i=>{e.o.frame((()=>{u[d]=i?null:ut([t.lng,t.lat],r,c.getBandView(d)),a.delete(e.B(l,d)),0===a.size&&o(s)}))}),!1))}0===a.size&&o(s)}))}_loadTileForQuery(t,i){if(this._loadTileLoaded[t.uid])return void i(null,t._mrt);if(this._loadTilePending[t.uid])return void this._loadTilePending[t.uid].push(i);this._loadTilePending[t.uid]=[i];const n=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),r=this.map._requestManager.transformRequest(n,e.R.Tile);t.actor.send("loadTile",{request:r,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},((i,n,r)=>{if(i)return this._loadTilePending[t.uid].forEach((e=>e(i,null))),void delete this._loadTilePending[t.uid];if(!n)return this._loadTilePending[t.uid].forEach((e=>e(null,null))),void delete this._loadTilePending[t.uid];if(this.map._refreshExpiredTiles&&n){const i=e.aM(r);t.setExpiryData(i)}t._mrt=n,t._isHeaderLoaded=!0,t.state="loaded",this._loadTilePending[t.uid].forEach((e=>e(null,n))),this._loadTileLoaded[t.uid]=!0,delete this._loadTilePending[t.uid]}),void 0,!0)}queryRasterArrayValueByAllBands(e,t,i){return new Promise(((n,r)=>{this._loadTileForQuery(t,((o,s)=>{o?r(o):n(s?this.queryRasterArrayValueByBandId(e,t,i):null)}))}))}queryRasterArrayValue(t,i){const n=e.aS.convert(t),r=this.findLoadedParent(n);return r&&r._mrt?i.bands||!this.partial?this.queryRasterArrayValueByBandId(n,r,i):this.queryRasterArrayValueByAllBands(n,r,i):Promise.resolve(null)}findLoadedParent(t){const i=e.ae.fromLngLat(t,this.map.transform.tileSize),n=this.maxzoom+1,r=1<<n,o=Math.floor(i.x),s=Math.floor((i.x-o)*r),a=Math.floor(i.y*r),l=this.map.style.getSourceCache(this.id),c=new e.aP(n,o,n,s,a);return l.findLoadedParent(c,this.minzoom)}}const dt={vector:lt,raster:ct,"raster-dem":class extends ct{constructor(e,t,i,n){super(e,t,i,n),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(t,i){const n=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function r(e,n){e&&(t.state="errored",i(e)),n&&(t.dem=n,t.dem.onDeserialize(),t.needsHillshadePrepare=!0,t.needsDEMTextureUpload=!0,t.state="loaded",i(null))}t.request=e.n(this.map._requestManager.transformRequest(n,e.R.Tile),function(n,o,s){if(delete t.request,t.aborted)t.state="unloaded",i(null);else if(n)t.state="errored",i(n);else if(o){const i=e.aM(s);this.map._refreshExpiredTiles&&t.setExpiryData(i);const n=ImageBitmap&&o instanceof ImageBitmap&&e.r(),a=1-(o.width-e.aO(o.width))/2;a<1||t.neighboringTiles||(t.neighboringTiles=this._getNeighboringTiles(t.tileID));const l=n?o:e.o.getImageData(o,a),c={uid:t.uid,tileID:t.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:l,encoding:this.encoding,padding:a};t.actor&&"expired"!==t.state||(t.actor=this.dispatcher.getActor(),t.actor.send("loadTile",c,r.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(t){const i=t.canonical,n=Math.pow(2,i.z),r=(i.x-1+n)%n,o=0===i.x?t.wrap-1:t.wrap,s=(i.x+1+n)%n,a=i.x+1===n?t.wrap+1:t.wrap,l={};return l[new e.aP(t.overscaledZ,o,i.z,r,i.y).key]={backfilled:!1},l[new e.aP(t.overscaledZ,a,i.z,s,i.y).key]={backfilled:!1},i.y>0&&(l[new e.aP(t.overscaledZ,o,i.z,r,i.y-1).key]={backfilled:!1},l[new e.aP(t.overscaledZ,t.wrap,i.z,i.x,i.y-1).key]={backfilled:!1},l[new e.aP(t.overscaledZ,a,i.z,s,i.y-1).key]={backfilled:!1}),i.y+1<n&&(l[new e.aP(t.overscaledZ,o,i.z,r,i.y+1).key]={backfilled:!1},l[new e.aP(t.overscaledZ,t.wrap,i.z,i.x,i.y+1).key]={backfilled:!1},l[new e.aP(t.overscaledZ,a,i.z,s,i.y+1).key]={backfilled:!1}),l}},"raster-array":ht,geojson:class extends e.E{constructor(t,i,n,r){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(r),this._data=i.data,this._options=Object.assign({},i),this._collectResourceTiming=i.collectResourceTiming,void 0!==i.maxzoom&&(this.maxzoom=i.maxzoom),void 0!==i.minzoom&&(this.minzoom=i.minzoom),i.type&&(this.type=i.type),i.attribution&&(this.attribution=i.attribution),this.promoteId=i.promoteId;const o=e.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:i.cluster||!1,geojsonVtOptions:{buffer:(void 0!==i.buffer?i.buffer:128)*o,tolerance:(void 0!==i.tolerance?i.tolerance:.375)*o,extent:e.al,maxZoom:this.maxzoom,lineMetrics:i.lineMetrics||!1,generateId:i.generateId||!1},superclusterOptions:{maxZoom:void 0!==i.clusterMaxZoom?i.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,i.clusterMinPoints||2),extent:e.al,radius:(void 0!==i.clusterRadius?i.clusterRadius:50)*o,log:!1,generateId:i.generateId||!1},clusterProperties:i.clusterProperties,filter:i.filter,dynamic:i.dynamic},i.workerOptions)}onAdd(e){this.map=e,this.setData(this._data)}setData(e){return this._data=e,this._updateWorkerData(),this}updateData(t){if(!this._options.dynamic)return this.fire(new e.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof t&&("Feature"===t.type&&(t={type:"FeatureCollection",features:[t]}),"FeatureCollection"!==t.type))return this.fire(new e.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof t&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const e=new Map;for(const t of this._data.features)e.set(t.id,t);for(const i of t.features)e.set(i.id,i);this._data.features=[...e.values()]}else this._data=t;return this._updateWorkerData(!0),this}getClusterExpansionZoom(e,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterChildren(e,t){return this.actor.send("geojson.getClusterChildren",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterLeaves(e,t,i,n){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:e,limit:t,offset:i},n),this}_updateWorkerData(t=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new e.z("dataloading",{dataType:"source"})),this._loaded=!1;const i=Object.assign({append:t},this.workerOptions);i.scope=this.scope;const n=this._data;"string"==typeof n?(i.request=this.map._requestManager.transformRequest(e.o.resolveURL(n),e.R.Source),i.request.collectResourceTiming=this._collectResourceTiming):i.data=JSON.stringify(n),this._pendingLoad=this.actor.send(`${this.type}.loadData`,i,((i,n)=>{if(this._loaded=!0,this._pendingLoad=null,i)this.fire(new e.y(i));else{const i={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&n&&n.resourceTiming&&n.resourceTiming[this.id]&&(i.resourceTiming=n.resourceTiming[this.id]),t&&(this._partialReload=!0),this.fire(new e.z("data",i)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(t),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const t=e.B(this.id,this.scope);this.map.style.clearSource(t),this._updateWorkerData()}loadTile(t,i){const n=t.actor?"reloadTile":"loadTile";t.actor=this.actor;const r=this.map.style?this.map.style.getLut(this.scope):null,o=r?{image:r.image.clone()}:null,s=this._partialReload,a={type:this.type,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:o,scope:this.scope,pixelRatio:e.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:s,worldview:this.map.getWorldview(),indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};t.request=this.actor.send(n,a,((e,r)=>s&&!r?(t.state="loaded",i(null)):(delete t.request,t.destroy(),t.aborted?i(null):e?i(e):(t.loadVectorData(r,this.map.painter,"reloadTile"===n),i(null)))),void 0,"loadTile"===n)}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.aborted=!0}unloadTile(e,t){this.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}onRemove(e){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends e.aT{constructor(e,t,i,n){super(e,t,i,n),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const t=this.options;this.urls=[];for(const i of t.urls)this.urls.push(this.map._requestManager.transformRequest(i,e.R.Source).url);e.aU(this.urls,((t,i)=>{this._loaded=!0,t?this.fire(new e.y(t)):i&&(this.video=i,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(t){if(this.video){const i=this.video.seekable;t<i.start(0)||t>i.end(0)?this.fire(new e.y(new e.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${i.start(0)} and ${i.end(0)}-second mark.`))):this.video.currentTime=t}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const t=this.map.painter.context,i=t.gl;this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new e.T(t,this.video,i.RGBA8),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(t)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:e.aT,model:e.aW,"batched-model":class extends e.E{constructor(e,t,i,n){super(),this.type="batched-model",this.id=e,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=i,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(n)}onAdd(e){this.map=e,this.load()}reload(){this.cancelTileJSONRequest();const t=e.B(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(t){this._loaded=!1,this.fire(new e.z("dataloading",{dataType:"source"}));const i=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map.getWorldview();this._tileJSONRequest=ot(this._options,this.map._requestManager,i,n,((i,n)=>{this._tileJSONRequest=null,this._loaded=!0,i?this.fire(new e.y(i)):n&&(Object.assign(this,n),n.bounds&&(this.tileBounds=new at(n.bounds,this.minzoom,this.maxzoom)),L(n.tiles,this.map._requestManager._customAccessToken),this.fire(new e.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(i)}))}hasTransition(){return!1}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loaded(){return this._loaded}loadTile(t,i){const n=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),r={request:this.map._requestManager.transformRequest(n,e.R.Tile),data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:e.o.devicePixelRatio,promoteId:this.promoteId};if(t.actor&&"expired"!==t.state)if("loading"===t.state)t.reloadCallback=i;else{if(t.buckets){const e=Object.values(t.buckets);for(const t of e)t.dirty=!0;return void(t.state="loaded")}t.request=t.actor.send("reloadTile",r,o.bind(this))}else t.actor=this.dispatcher.getActor(),t.request=t.actor.send("loadTile",r,o.bind(this),void 0,!0);function o(e,n){return t.aborted?i(null):e&&404!==e.status?i(e):(this.map._refreshExpiredTiles&&n&&t.setExpiryData(n),t.loadModelData(n,this.map.painter),t.state="loaded",void i(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends e.aT{constructor(t,i,n,r){super(t,i,n,r),i.coordinates?Array.isArray(i.coordinates)&&4===i.coordinates.length&&!i.coordinates.some((e=>!Array.isArray(e)||2!==e.length||e.some((e=>"number"!=typeof e))))||this.fire(new e.y(new e.V(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new e.y(new e.V(`sources.${t}`,null,'missing required property "coordinates"'))),i.animate&&"boolean"!=typeof i.animate&&this.fire(new e.y(new e.V(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),i.canvas?"string"==typeof i.canvas||i.canvas instanceof HTMLCanvasElement||this.fire(new e.y(new e.V(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new e.y(new e.V(`sources.${t}`,null,'missing required property "canvas"'))),this.options=i,this.animate=void 0===i.animate||i.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new e.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(e){this.pause()}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const i=this.map.painter.context;this.texture?!t&&!this._playing||this.texture instanceof e.aV||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new e.T(i,this.canvas,i.gl.RGBA8,{premultiply:!0}),this._prepareData(i)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}},custom:class extends e.E{constructor(t,i,n,r){super(),this.id=t,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=i,this.setEventedParent(r),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new e.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new e.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new at(this._implementation.bounds,this.minzoom,this.maxzoom)),i.update=this._update.bind(this),i.clearTiles=this._clearTiles.bind(this),i.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,e.aH(i,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return e.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new e.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(t){this.map=t,this._loaded=!1,this.fire(new e.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(t),this.load()}onRemove(e){this._implementation.onRemove&&this._implementation.onRemove(e)}hasTile(e){if(this._implementation.hasTile){const{x:t,y:i,z:n}=e.canonical;return this._implementation.hasTile({x:t,y:i,z:n})}return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,t){const{x:i,y:n,z:r}=e.tileID.canonical,o=new AbortController;e.request=Promise.resolve(this._implementation.loadTile({x:i,y:n,z:r},{signal:o.signal})).then(function(i){return delete e.request,e.aborted?(e.state="unloaded",t(null)):void 0===i?(e.state="errored",t(null)):null===i?(this.loadTileData(e,{width:this.tileSize,height:this.tileSize,data:null}),e.state="loaded",t(null)):function(e){return e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof ImageBitmap||e instanceof HTMLImageElement}(i)?(this.loadTileData(e,i),e.state="loaded",void t(null)):(e.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((i=>{"AbortError"!==i.name&&(e.state="errored",t(i))})),e.request.cancel=()=>o.abort()}loadTileData(e,t){e.setTexture(t,this.map.painter)}unloadTile(t,i){if(t.texture&&t.texture instanceof e.T?(t.destroy(!0),t.texture&&t.texture instanceof e.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),this._implementation.unloadTile){const{x:e,y:i,z:n}=t.tileID.canonical;this._implementation.unloadTile({x:e,y:i,z:n})}i&&i()}abortTile(e,t){e.request&&e.request.cancel&&(e.request.cancel(),delete e.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((e=>({x:e.canonical.x,y:e.canonical.y,z:e.canonical.z})))}_clearTiles(){const t=e.B(this.id,this.scope);this.map.style.clearSource(t)}_update(){this.fire(new e.z("data",{dataType:"source",sourceDataType:"content"}))}}},pt=function(t,i,n,r){const o=new dt[i.type](t,i,n,r);if(o.id!==t)throw new Error(`Expected Source id to be ${t} instead of ${o.id}`);return e.aX(["load","abort","unload","serialize","prepare"],o),o};function ft(e,t,i=""){return`${i}:${t.id||""}:${t.layer.id}:${function(e){if("layerId"in e)return`layer:${e.layerId}`;{const{featuresetId:t,importId:i}=e;return`featureset:${t}${i?`:import:${i}`:""}`}}(e.target)}`}function mt(e,t,i,n=""){if(e.uniqueFeatureID){const r=ft(e,t,n);if(i.has(r))return!0;i.add(r)}return!1}function gt(e,t,i,n,r=!1){const o=t.sourceCache.transform,s=t.sourceCache.tilesIn(e,t.has3DLayers,r);s.sort(vt);const a=[];for(const e of s){const s=e.tile.queryRenderedFeatures(t,e,i,n,o,r);Object.keys(s).length&&a.push({wrappedTileID:e.tile.tileID.wrapped().key,queryResults:s})}for(const i in t.layers){const r=t.layers[i];if(r.styleLayer){const i=r.styleLayer.queryRenderedFeatures(e,t.sourceCache,n);Object.keys(i).length&&a.push({wrappedTileID:0,queryResults:i})}}return 0===a.length?{}:function(e){const t={},i={};for(const n of e){const e=n.queryResults,r=n.wrappedTileID,o=i[r]=i[r]||{};for(const i in e){const n=e[i],r=o[i]=o[i]||{},s=t[i]=t[i]||[];for(const e of n)r[e.featureIndex]||(r[e.featureIndex]=!0,s.push(e))}}return t}(a)}function _t(e,t,i,n,r,o){const s={},a=n.queryRenderedSymbols(e),l=[];for(const e of Object.keys(a).map(Number))l.push(r[e]);l.sort(vt);for(const e of l){const n=e.featureIndex.lookupSymbolFeatures(a[e.bucketInstanceId],e.bucketIndex,e.sourceLayerIndex,t,i,o);for(const t in n){const i=s[t]=s[t]||[],r=n[t];r.sort(((t,i)=>{const n=e.featureSortOrder;if(n){const e=n.indexOf(t.featureIndex);return n.indexOf(i.featureIndex)-e}return i.featureIndex-t.featureIndex}));for(const e of r)i.push(e)}}return s}function yt(e,t){const i=e.getRenderableIds().map((t=>e.getTileByID(t))),n=[],r={};for(let e=0;e<i.length;e++){const o=i[e],s=o.tileID.canonical.key;r[s]||(r[s]=!0,o.querySourceFeatures(n,t))}return n}function vt(e,t){const i=e.tileID,n=t.tileID;return i.overscaledZ-n.overscaledZ||i.canonical.y-n.canonical.y||i.wrap-n.wrap||i.canonical.x-n.canonical.x}function xt(e,t){const i={};if(!t)return i;for(const n of e){const e=n.layerIds.map((e=>t.getLayer(e))).filter(Boolean);if(0!==e.length){n.layers=e,n.stateDependentLayerIds&&(n.stateDependentLayers=n.stateDependentLayerIds.map((t=>e.filter((e=>e.id===t))[0])));for(const t of e)i[t.fqid]=n}}return i}const bt=32,Tt=33,wt=new Uint16Array(8184);for(let e=0;e<2046;e++){let t=e+2,i=0,n=0,r=0,o=0,s=0,a=0;for(1&t?r=o=s=bt:i=n=a=bt;(t>>=1)>1;){const e=i+r>>1,l=n+o>>1;1&t?(r=i,o=n,i=s,n=a):(i=r,n=o,r=s,o=a),s=e,a=l}const l=4*e;wt[l+0]=i,wt[l+1]=n,wt[l+2]=r,wt[l+3]=o}const Et=new Uint16Array(2178),St=new Uint8Array(1089),At=new Uint16Array(1089);function Mt(e){return 0===e?-.03125:32===e?.03125:0}const It={type:2,extent:e.al,loadGeometry:()=>[[new e.P(0,0),new e.P(e.al+1,0),new e.P(e.al+1,e.al+1),new e.P(0,e.al+1),new e.P(0,0)]]};class Ct{constructor(t,i,n,r,o,s){this.tileID=t,this.uid=e.b1(),this.uses=0,this.tileSize=i,this.tileZoom=n,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=o,r&&r.style&&(this._lastUpdatedBrightness=r.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",r&&r.transform&&(this.projection=r.transform.projection),this.worldview=s,this._hasAppearances=null}registerFadeDuration(t){const i=t+this.timeAdded;i<e.o.now()||this.fadeEndTime&&i<this.fadeEndTime||(this.fadeEndTime=i)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=e.aY(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,i,n){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=xt(t.buckets,i.style),this.hasSymbolBuckets=!1;for(const t in this.buckets){const i=this.buckets[t];if(i instanceof e.b3){if(this.hasSymbolBuckets=!0,!n)break;i.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const t in this.buckets){const i=this.buckets[t];if(i instanceof e.b3&&i.hasRTLText){this.hasRTLText=!0,e.b4();break}}this.queryPadding=0;for(const e in this.buckets){const t=this.buckets[e],n=i.style.getOwnLayer(e);if(!n)continue;const r=n.queryRadius(t);this.queryPadding=Math.max(this.queryPadding,r)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new e.b2}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(e,t,i){e&&(e.resourceTiming&&(this.resourceTiming=e.resourceTiming),this.buckets=Object.assign({},this.buckets,xt(e.buckets,t.style)),e.featureIndex&&(this.latestFeatureIndex=e.featureIndex))}getBucket(e){return this.buckets[e.fqid]}upload(t,i){for(const e in this.buckets){const n=this.buckets[e];if(n.uploadPending()){let e={},r=[],o={zoom:0,pitch:0,brightness:0,worldview:""};if(i){if(i.style){r=i.style.listImages();const t=n.layers[0],o=t.sourceLayer||"_geojsonTileLayer",s=i.style.getLayerSourceCache(t);s&&(e=s._state.getState(o,void 0))}o={zoom:i.transform.zoom||0,pitch:i.transform.pitch||0,brightness:i.style.getBrightness()||0,worldview:i.worldview||""}}n.upload(t,this.tileID.canonical,e,r,o)}}const n=t.gl,r=this.imageAtlas;r&&!r.uploaded&&(this.imageAtlasTexture=new e.T(t,r.image,n.RGBA8,{useMipmap:!!r.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new e.T(t,this.glyphAtlasImage,n.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new e.T(t,this.lineAtlas.image,n.R8),this.lineAtlas.uploaded=!0)}prepare(e,t,i){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture,i),!t||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const n=t.style.getBrightness();null===this._hasAppearances&&(this._hasAppearances=this.hasAppearances(t)),(this._lastUpdatedBrightness||n||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&n&&Math.abs(this._lastUpdatedBrightness-n)<.001||(this.updateBuckets(t,this._lastUpdatedBrightness!==n),this._lastUpdatedBrightness=n))}evaluateQueryRenderedFeaturePadding(){let e=0;for(const t in this.buckets){const i=this.buckets[t];i.evaluateQueryRenderedFeaturePadding&&(e=Math.max(e,i.evaluateQueryRenderedFeaturePadding()))}return e}queryRenderedFeatures(t,i,n,r,o,s){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const a=this.evaluateQueryRenderedFeaturePadding(),l=function(t,i){const n=e.bp([],[.5*t.width,.5*-t.height,1]);return e.bq(n,n,[1,-1,0]),e.aB(n,n,t.calculateProjMatrix(i.toUnwrapped())),Float32Array.from(n)}(o,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:i,pixelPosMatrix:l,transform:r,availableImages:n,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:a})}querySourceFeatures(t,i){const n=this.latestFeatureIndex;if(!n||!n.rawTileData)return;const r=n.loadVTLayers(),o=i?i.sourceLayer:"",s=r._geojsonTileLayer||r[o];if(!s)return;const a=e.b5(i&&i.filter),{z:l,x:c,y:u}=this.tileID.canonical,h={z:l,x:c,y:u};for(let i=0;i<s.length;i++){const r=s.feature(i);if(a.needGeometry){const t=e.b6(r,!0);if(!a.filter(new e.ac(this.tileID.overscaledZ,{worldview:this.worldview}),t,this.tileID.canonical))continue}else if(!a.filter(new e.ac(this.tileID.overscaledZ,{worldview:this.worldview}),r))continue;const d=n.getId(r,o),p=new e.b7(r,l,c,u,d);p.tile=h,t.push(p)}}loaded(){return"loaded"===this.state||"errored"===this.state}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const i=this.expirationTime;if(t.cacheControl){const i=e.b8(t.cacheControl);i["max-age"]&&(this.expirationTime=Date.now()+1e3*i["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const e=Date.now();let t=!1;if(this.expirationTime>e)t=!1;else if(i)if(this.expirationTime<i)t=!0;else{const n=this.expirationTime-i;n?this.expirationTime=e+Math.max(n,3e4):t=!0}else t=!0;t?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(e){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&e&&this.updateBuckets(e)}hasAppearances(e){for(const t in this.buckets)if(e.style.hasLayer(t)&&this.buckets[t].layers.some((e=>e.appearances&&e.appearances.length>0)))return!0;return!1}updateBuckets(t,i){if(!this.latestFeatureIndex)return;if(!t.style)return;const n=this.latestFeatureIndex.loadVTLayers(),r=t.style.listImages(),o=t.style.getBrightness();for(const s in this.buckets){if(!t.style.hasLayer(s))continue;const a=this.buckets[s],l=a.layers[0],c=l.sourceLayer||"_geojsonTileLayer",u=n[c],h=t.style.getLayerSourceCache(l);let d={};h&&(d=h._state.getState(c,void 0));const p=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},f=Object.keys(d).length>0&&!i;if(a.hasAppearances=a.layers.some((e=>e.appearances&&e.appearances.length>0)),(f&&0!==a.stateDependentLayers.length||i)&&a.update(d,u,r,p,f?a.stateDependentLayers:a.layers,i,o),f&&0!==a.stateDependentLayers.length||i||a.hasAppearances){const e={zoom:t.transform.zoom,pitch:t.transform.pitch,brightness:t.style.getBrightness()||0,worldview:t.worldview};a.updateAppearances(this.tileID.canonical,d,r,e)}(a instanceof e.b9||a instanceof e.ba)&&t._terrain&&t._terrain.enabled&&h&&a.uploadPending()&&t._terrain._clearRenderCacheForTile(h.id,this.tileID);const m=t&&t.style&&t.style.getOwnLayer(s);m&&(this.queryPadding=Math.max(this.queryPadding,m.queryRadius(a)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<e.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=e.o.now()+t}setTexture(t,i){const n=i.context,r=n.gl;this.texture=this.texture||i.getTileTexture(t.width),this.texture&&this.texture instanceof e.T?this.texture.update(t):(this.texture=new e.T(n,t,r.RGBA8,{useMipmap:!0}),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE))}setDependencies(e,t){const i={};for(const e of t)i[e]=!0;this.dependencies[e]=i}hasDependency(e,t){for(const i of e){const e=this.dependencies[i];if(e)for(const i of t)if(e[i])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,i){if(!i||"mercator"===i.name||this._tileDebugBuffer)return;const n=e.bb(It,this.tileID.canonical,this.tileTransform)[0],r=new e.bc,o=new e.bd;for(let e=0;e<n.length;e++){const{x:t,y:i}=n[e];r.emplaceBack(t,i),o.emplaceBack(e)}o.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(o),this._tileDebugBuffer=t.createVertexBuffer(r,e.be.members),this._tileDebugSegments=e.bf.simpleSegment(0,0,r.length,o.length)}_makeTileBoundsBuffers(t,i){if(this._tileBoundsBuffer||!i||"mercator"===i.name)return;const n=e.bb(It,this.tileID.canonical,this.tileTransform)[0];let r,o;if(this.isRaster){const t=function(t,i){const n=e.aY(t,i),r=Math.pow(2,t.z);for(let o=0;o<Tt;o++)for(let s=0;s<Tt;s++){const a=e.aZ((t.x+(s+Mt(s))/bt)/r),l=e.a_((t.y+(o+Mt(o))/bt)/r),c=i.project(a,l),u=o*Tt+s;Et[2*u+0]=Math.round((c.x*n.scale-n.x)*e.al),Et[2*u+1]=Math.round((c.y*n.scale-n.y)*e.al)}St.fill(0),At.fill(0);for(let e=2045;e>=0;e--){const t=4*e,i=wt[t+0],n=wt[t+1],r=wt[t+2],o=wt[t+3],s=i+r>>1,a=n+o>>1,l=s+a-n,c=a+i-s,u=n*Tt+i,h=o*Tt+r,d=a*Tt+s,p=Math.hypot((Et[2*u+0]+Et[2*h+0])/2-Et[2*d+0],(Et[2*u+1]+Et[2*h+1])/2-Et[2*d+1])>=16;St[d]=St[d]||(p?1:0),e<1022&&(St[d]=St[d]||St[(n+c>>1)*Tt+(i+l>>1)]||St[(o+c>>1)*Tt+(r+l>>1)])}const o=new e.a$,s=new e.b0;let a=0;function l(t,i){const n=i*Tt+t;return 0===At[n]&&(o.emplaceBack(Et[2*n+0],Et[2*n+1],t*e.al/bt,i*e.al/bt),At[n]=++a),At[n]-1}function c(e,t,i,n,r,o){const a=e+i>>1,u=t+n>>1;if(Math.abs(e-r)+Math.abs(t-o)>1&&St[u*Tt+a])c(r,o,e,t,a,u),c(i,n,r,o,a,u);else{const a=l(e,t),c=l(i,n),u=l(r,o);s.emplaceBack(a,c,u)}}return c(0,0,bt,bt,bt,0),c(bt,bt,0,0,0,bt),{vertices:o,indices:s}}(this.tileID.canonical,i);r=t.vertices,o=t.indices}else{r=new e.a$,o=new e.b0;for(const{x:e,y:t}of n)r.emplaceBack(e,t,0,0);const t=e.bg(r.int16.subarray(0,4*r.length),void 0,4);for(let e=0;e<t.length;e+=3)o.emplaceBack(t[e],t[e+1],t[e+2])}this._tileBoundsBuffer=t.createVertexBuffer(r,e.bh.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(o),this._tileBoundsSegments=e.bf.simpleSegment(0,0,r.length,o.length)}_makeGlobeTileDebugBuffers(t,i){const n=i.projection;if(!n||"globe"!==n.name||i.freezeTileCoverage)return;const r=this.tileID.canonical,o=e.bi(r,i),s=e.bj(o),a=e.aj(i.zoom);let l;a>0&&(l=e.bk(new Float64Array(16),i.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,r,i,s,l,a),this._makeGlobeTileDebugTextBuffer(t,r,i,s,l,a)}_globePoint(t,i,n,r,o,s,a){let l=e.bl(t,i,n);if(s){const o=1<<n.z,c=e.aF(r.center.lng),u=e.aJ(r.center.lat),h=(n.x+.5)/o-c;let d=0;h>.5?d=-1:h<-.5&&(d=1);let p=(t/e.al+n.x)/o+d,f=(i/e.al+n.y)/o;p=(p-c)*r._pixelsPerMercatorPixel+c,f=(f-u)*r._pixelsPerMercatorPixel+u;const m=[p*r.worldSize,f*r.worldSize,0];e.af(m,m,s),l=e.bm(l,m,a)}return e.af(l,l,o)}_makeGlobeTileDebugBorderBuffer(t,i,n,r,o,s){const a=new e.bc,l=new e.bd,c=new e.bn,u=(e,t,u,h,d)=>{const p=(u-e)/(d-1),f=(h-t)/(d-1),m=a.length;for(let u=0;u<d;u++){const h=e+u*p,d=t+u*f;a.emplaceBack(h,d);const g=this._globePoint(h,d,i,n,r,o,s);c.emplaceBack(g[0],g[1],g[2]),l.emplaceBack(m+u)}},h=e.al;u(0,0,h,0,16),u(h,0,h,h,16),u(h,h,0,h,16),u(0,h,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(l),this._tileDebugBuffer=t.createVertexBuffer(a,e.be.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(c,e.bo.members),this._tileDebugSegments=e.bf.simpleSegment(0,0,a.length,l.length)}_makeGlobeTileDebugTextBuffer(t,i,n,r,o,s){const a=e.al/4,l=new e.bc,c=new e.b0,u=new e.bn,h=25;c.reserve(32),l.reserve(h),u.reserve(h);const d=(e,t)=>h*e+t;for(let e=0;e<h;e++){const t=e*a;for(let e=0;e<h;e++){const c=e*a;l.emplaceBack(c,t);const h=this._globePoint(c,t,i,n,r,o,s);u.emplaceBack(h[0],h[1],h[2])}}for(let e=0;e<4;e++)for(let t=0;t<4;t++){const i=d(e,t),n=d(e,t+1),r=d(e+1,t),o=d(e+1,t+1);c.emplaceBack(i,n,r),c.emplaceBack(r,n,o)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(c),this._tileDebugTextBuffer=t.createVertexBuffer(l,e.be.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(u,e.bo.members),this._tileDebugTextSegments=e.bf.simpleSegment(0,0,h,32)}destroy(t=!1){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof e.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}e.br.setPbf(e.bs);class Pt extends Ct{constructor(e,t,i,n,r){super(e,t,i,n,r),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(e){return this._mrt&&this._mrt.getLayer(e)}setTexturePerLayer(t,i,n){const r=n.context,o=r.gl;let s=this.texturePerLayer.get(t)||n.getTileTexture(i.width);s&&s instanceof e.T?s.update(i,{premultiply:!1}):s=new e.T(r,i,o.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,s)}flushQueues(e){const t=this._workQueuePerLayer.get(e)||[],i=this._fetchQueuePerLayer.get(e)||[];for(;t.length;)t.pop()();for(;i.length;)i.pop()()}flushAllQueues(){for(const e of this._workQueuePerLayer.keys()){const t=this._workQueuePerLayer.get(e)||[];for(;t.length;)t.pop()()}for(const e of this._fetchQueuePerLayer.keys()){const t=this._fetchQueuePerLayer.get(e)||[];for(;t.length;)t.pop()()}}fetchHeader(t=16384,i){const n=this._mrt=new e.br(30),r=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=e.bt(r,((e,r,o)=>{if(e)i(e);else try{const e=n.getHeaderLength(r);if(e>t)return void(this.request=this.fetchHeader(e,i));n.parseHeader(r),this._isHeaderLoaded=!0;let s=0;for(const e of Object.values(n.layers))s=Math.max(s,e.dataIndex[e.dataIndex.length-1].lastByte);r.byteLength>=s&&(this.entireBuffer=r),i(null,this.entireBuffer||r,o)}catch(e){i(e)}})),this.request}fetchBandForRender(e,t,i,n){this.fetchBand(e,t,i,(r=>{if(r)return void n(r);this.updateTextureDescriptor(e,t,i);const o=this.textureDescriptorPerLayer.get(t);n(null,o?o.img:null)}))}fetchBand(t,i,n,r,o=!0){const s=this._mrt;if(!this._isHeaderLoaded||!s)return void r(new Error("Tile header is not ready"));const a=this.actor;if(!a)return void r(new Error("Can't fetch tile band without an actor"));let l;const c=e.B(String(n),e.B(this.tileID.key,t));let u=this._taskQueue.get(c);u?u.add(r):(u=new Set,u.add(r),this._taskQueue.set(c,u));const h=(e,t)=>{l.complete(e,t),e?r(e):(u.values().forEach((e=>e(null,t))),this._taskQueue.delete(c))},d=(e,t)=>{if(e)return r(e);const n=a.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:t,task:l},h,void 0,!0);if(null!==i){const e=this._workQueuePerLayer.get(i)||[];e.push((()=>{n&&n.cancel(),l.cancel()})),this._workQueuePerLayer.has(i)||this._workQueuePerLayer.set(i,e)}};let p;try{p=s.getLayer(t)}catch(e){if("reloading"===this.state)return;throw e}if(!p)return void r(new Error(`Unknown sourceLayer "${t}"`));if(p.hasDataForBand(n))return u.values().forEach((e=>e(null,null))),void this._taskQueue.delete(c);const f=p.getDataRange([n]);if(l=s.createDecodingTask(f),!l||l.tasks.length)if(null!==i&&this.flushQueues(i),this.entireBuffer)d(null,this.entireBuffer.slice(f.firstByte,f.lastByte+1));else{const t=Object.assign({},this.requestParams,{headers:{Range:`bytes=${f.firstByte}-${f.lastByte}`}}),n=e.bt(t,d);if(null!==i){const e=this._fetchQueuePerLayer.get(i)||[];e.push((()=>{n.cancel(),l.cancel()})),this._fetchQueuePerLayer.has(i)||this._fetchQueuePerLayer.set(i,e)}}}updateNeeded(e,t){return(!this.textureDescriptorPerLayer.get(e)||this.textureDescriptorPerLayer.get(e).band!==t||this.refreshedUponExpiration)&&"errored"!==this.state}updateTextureDescriptor(t,i,n){if(!this._mrt)return;const r=this._mrt.getLayer(t);if(!r||!r.hasBand(n)||!r.hasDataForBand(n))return;const{bytes:o,tileSize:s,buffer:a,offset:l,scale:c}=r.getBandView(n),u=s+2*a,h=new e.q({width:u,height:u},o),d=this.texturePerLayer.get(i);d&&d instanceof e.T&&d.update(h,{premultiply:!1}),this.textureDescriptorPerLayer.set(i,{layer:t,band:n,img:h,buffer:a,offset:l,tileSize:s,format:r.pixelFormat,mix:[c,256*c,65536*c,16777216*c]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(const t of this.texturePerLayer.values())t&&t instanceof e.T&&t.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class Lt{constructor(e,t){this.max=e,this.onRemove=t,this.reset()}reset(){for(const e in this.data)for(const t of this.data[e])t.timeout&&clearTimeout(t.timeout),this.onRemove(t.value);return this.data={},this.order=[],this}add(e,t,i){const n=e.wrapped().key;void 0===this.data[n]&&(this.data[n]=[]);const r={value:t,timeout:void 0};if(void 0!==i&&(r.timeout=setTimeout((()=>{this.remove(e,r)}),i)),this.data[n].push(r),this.order.push(n),this.order.length>this.max){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e)}return this}has(e){return e.wrapped().key in this.data}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null}_getAndRemoveByKey(e){const t=this.data[e].shift();return t.timeout&&clearTimeout(t.timeout),0===this.data[e].length&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),t.value}getByKey(e){const t=this.data[e];return t?t[0].value:null}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null}remove(e,t){if(!this.has(e))return this;const i=e.wrapped().key,n=void 0===t?0:this.data[i].indexOf(t),r=this.data[i][n];return this.data[i].splice(n,1),r.timeout&&clearTimeout(r.timeout),0===this.data[i].length&&delete this.data[i],this.onRemove(r.value),this.order.splice(this.order.indexOf(i),1),this}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e)}return this}filter(e){const t=[];for(const i in this.data)for(const n of this.data[i])e(n.value)||t.push(n);for(const e of t)this.remove(e.value.tileID,e)}}class Rt{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(e,t,i){const n=String(t);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][n]=this.stateChanges[e][n]||{},Object.assign(this.stateChanges[e][n],i),null===this.deletedStates[e]){this.deletedStates[e]={};for(const t in this.state[e])t!==n&&(this.deletedStates[e][t]=null)}else if(this.deletedStates[e]&&null===this.deletedStates[e][n]){this.deletedStates[e][n]={};for(const t in this.state[e][n])i[t]||(this.deletedStates[e][n][t]=null)}else for(const t in i)this.deletedStates[e]&&this.deletedStates[e][n]&&null===this.deletedStates[e][n][t]&&delete this.deletedStates[e][n][t]}removeFeatureState(e,t,i){if(null===this.deletedStates[e])return;const n=String(t);if(this.deletedStates[e]=this.deletedStates[e]||{},i&&void 0!==t)null!==this.deletedStates[e][n]&&(this.deletedStates[e][n]=this.deletedStates[e][n]||{},this.deletedStates[e][n][i]=null);else if(void 0!==t)if(this.stateChanges[e]&&this.stateChanges[e][n])for(i in this.deletedStates[e][n]={},this.stateChanges[e][n])this.deletedStates[e][n][i]=null;else this.deletedStates[e][n]=null;else this.deletedStates[e]=null}getState(e,t){const i=this.state[e]||{},n=this.stateChanges[e]||{},r=this.deletedStates[e];if(null===r)return{};if(void 0!==t){const e=String(t),o=Object.assign({},i[e],n[e]);if(r){const e=r[t];if(null===e)return{};for(const t in e)delete o[t]}return o}const o=Object.assign({},i,n);if(r)for(const e in r)delete o[e];return o}initializeTileState(e,t){e.refreshFeatureState(t)}coalesceChanges(e,t){const i={};for(const e in this.stateChanges){this.state[e]=this.state[e]||{};const t={};for(const i in this.stateChanges[e])this.state[e][i]||(this.state[e][i]={}),Object.assign(this.state[e][i],this.stateChanges[e][i]),t[i]=this.state[e][i];i[e]=t}for(const e in this.deletedStates){this.state[e]=this.state[e]||{};const t={};if(null===this.deletedStates[e])for(const i in this.state[e])t[i]={},this.state[e][i]={};else for(const i in this.deletedStates[e]){if(null===this.deletedStates[e][i])this.state[e][i]={};else if(this.state[e][i])for(const t of Object.keys(this.deletedStates[e][i]))delete this.state[e][i][t];t[i]=this.state[e][i]}i[e]=i[e]||{},Object.assign(i[e],t)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(i).length)for(const i in e)e[i].refreshFeatureState(t)}}class Ot extends e.E{constructor(e,t,i){super(),this.id=e,this._onlySymbols=i,t.on("data",(e=>{"source"===e.dataType&&"metadata"===e.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===e.dataType&&"content"===e.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),t.on("error",(()=>{this._sourceErrored=!0})),this._source=t,this._tiles={},this._cache=new Lt(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=t.minTileCacheSize,this._maxTileCacheSize=t.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Rt,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(e){this.map=e,this._minTileCacheSize=void 0===this._minTileCacheSize&&e?e._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&e?e._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const e in this._tiles)if(!this._tiles[e].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(e,t){return e.isSymbolTile=this._onlySymbols,e.isExtraShadowCaster=this._shadowCasterTiles[e.tileID.key],this._source.loadTile(e,t)}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e)}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e)}serialize(){return this._source.serialize()}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const t in this._tiles){const i=this._tiles[t];i.upload(e,this.map?this.map.painter:void 0),i.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map((e=>e.tileID)).sort(Dt).map((e=>e.key))}getRenderableIds(t,i){const n=[];for(const e in this._tiles)this._isIdRenderable(+e,t,i)&&n.push(this._tiles[e]);return t?n.sort(((t,i)=>{const n=t.tileID,r=i.tileID,o=new e.P(n.canonical.x,n.canonical.y)._rotate(this.transform.angle),s=new e.P(r.canonical.x,r.canonical.y)._rotate(this.transform.angle);return n.overscaledZ-r.overscaledZ||s.y-o.y||s.x-o.x})).map((e=>e.tileID.key)):n.map((e=>e.tileID)).sort(Dt).map((e=>e.key))}hasRenderableParent(e){const t=this.findLoadedParent(e,0);return!!t&&this._isIdRenderable(t.tileID.key)}_isIdRenderable(e,t,i){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(t||!this._tiles[e].holdingForFade())&&(i||!this._shadowCasterTiles[e])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const e in this._tiles)"errored"!==this._tiles[e].state&&this._reloadTile(+e,"reloading")}}_reloadTile(e,t){const i=this._tiles[e];i&&("loading"!==i.state&&(i.state=t),this._loadTile(i,this._tileLoaded.bind(this,i,e,t)))}_tileLoaded(t,i,n,r,o){if(r){if(t.state="errored",404!==r.status)this._source.fire(new e.y(r,{tile:t}));else{if(this._source.fire(new e.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const e=this.map.painter.terrain;this.update(this.transform,e.getScaledDemTileSize(),!0),e.resetTileLookupCache(this.id)}else this.update(this.transform)}return}t.timeAdded=e.o.now(),"expired"===n&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(i,t),"raster-dem"===this._source.type&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null);let s=new Map;o&&o.responseHeaders&&(s=o.responseHeaders),this._source.fire(new e.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id,responseHeaders:s}))}_backfillDEM(e){const t=this.getRenderableIds();for(let n=0;n<t.length;n++){const r=t[n];if(e.neighboringTiles&&e.neighboringTiles[r]){const t=this.getTileByID(r);i(e,t),i(t,e)}}function i(e,t){if(!e.dem||e.dem.borderReady)return;e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0;let i=t.tileID.canonical.x-e.tileID.canonical.x;const n=t.tileID.canonical.y-e.tileID.canonical.y,r=Math.pow(2,e.tileID.canonical.z),o=t.tileID.key;0===i&&0===n||Math.abs(n)>1||(Math.abs(i)>1&&(1===Math.abs(i+r)?i+=r:1===Math.abs(i-r)&&(i-=r)),t.dem&&e.dem&&(e.dem.backfillBorder(t.dem,i,n),e.neighboringTiles&&e.neighboringTiles[o]&&(e.neighboringTiles[o].backfilled=!0)))}}getTile(e){return this.getTileByID(e.key)}getTileByID(e){return this._tiles[e]}_retainLoadedChildren(e,t,i,n){for(const r in this._tiles){let o=this._tiles[r];if(n[r]||!o.hasData()||o.tileID.overscaledZ<=t||o.tileID.overscaledZ>i)continue;let s=o.tileID;for(;o&&o.tileID.overscaledZ>t+1;){const e=o.tileID.scaledTo(o.tileID.overscaledZ-1);o=this._tiles[e.key],o&&o.hasData()&&(s=e)}let a=s;for(;a.overscaledZ>t;)if(a=a.scaledTo(a.overscaledZ-1),e[a.key]){n[s.key]=s;break}}}findLoadedParent(e,t){if(e.key in this._loadedParentTiles){const i=this._loadedParentTiles[e.key];return i&&i.tileID.overscaledZ>=t?i:null}for(let i=e.overscaledZ-1;i>=t;i--){const t=e.scaledTo(i),n=this._getLoadedTile(t);if(n)return n}}_getLoadedTile(e){const t=this._tiles[e.key];return t&&t.hasData()?t:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key)}updateCacheSize(e,t){t=t||this._source.tileSize;const i=Math.ceil(e.width/t)+1,n=Math.ceil(e.height/t)+1,r=Math.floor(i*n*5),o="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,r):r,s="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,o):o;this._cache.setMaxSize(s)}handleWrapJump(e){const t=Math.round((e-(void 0===this._prevLng?e:this._prevLng))/360);if(this._prevLng=e,t){const e={};for(const i in this._tiles){const n=this._tiles[i];n.tileID=n.tileID.unwrapTo(n.tileID.wrap+t),e[n.tileID.key]=n}this._tiles=e;for(const e in this._timers)clearTimeout(this._timers[e]),delete this._timers[e];for(const e in this._tiles)this._setTileReloadTimer(+e,this._tiles[e])}}update(t,i,n,r,o){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!n)return;this.updateCacheSize(t,i),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const s="batched-model"===this._source.type;let a,l=this._source.maxzoom;const c=this.map&&this.map.painter?this.map.painter._terrain:null;if(c&&c.sourceCache===this&&c.attenuationRange()){const e=c.attenuationRange()[0],t=Math.floor(e)-Math.log2(c.getDemUpscale());l>t&&(l=t)}if(this.used||this.usedForTerrain){if(this._source.tileID)a=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((t=>new e.aP(t.canonical.z,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y)));else if(0!==this.tileCoverLift){const r=t.clone();r.tileCoverLift=this.tileCoverLift,a=r.coveringTiles({tileSize:i||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:l,roundZoom:this._source.roundZoom&&!n,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:s}),this._source.minzoom<=1&&"globe"===t.projection.name&&(a.push(new e.aP(1,0,1,0,0)),a.push(new e.aP(1,0,1,1,0)),a.push(new e.aP(1,0,1,0,1)),a.push(new e.aP(1,0,1,1,1)))}else if(a=t.coveringTiles({tileSize:i||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:l,roundZoom:this._source.roundZoom&&!n,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:s}),this._source.hasTile){const e=this._source.hasTile.bind(this._source);a=a.filter((t=>e(t)))}}else a=[];if(a.length>0&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!Bt(this._source.type)){const e=t.coveringZoomLevel({tileSize:i||this._source.tileSize,roundZoom:this._source.roundZoom&&!n}),l=Math.min(e,this._source.maxzoom);if(s){const e=t.extendTileCover(a,l);for(const t of e)a.push(t)}else if(o){const e=t.extendTileCoverToNearPlane(a,this.transform.getFrustum(l),l);for(const t of e)a.push(t)}else if(this.castsShadows&&r){const e=t.extendTileCover(a,l,r);for(const t of e)this._shadowCasterTiles[t.key]=!0,a.push(t)}}const u=this._updateRetainedTiles(a);if(Bt(this._source.type)&&0!==a.length){const t={},i={},n=Object.keys(u);for(const r of n){const n=u[r],o=this._tiles[r];if(!o||o.fadeEndTime&&o.fadeEndTime<=e.o.now())continue;const s=this.findLoadedParent(n,Math.max(n.overscaledZ-Ot.maxOverzooming,this._source.minzoom));s&&(this._addTile(s.tileID),t[s.tileID.key]=s.tileID),i[r]=n}const r=a[a.length-1].overscaledZ;for(const e in this._tiles){const t=this._tiles[e];if(u[e]||!t.hasData())continue;let n=t.tileID;for(;n.overscaledZ>r;){n=n.scaledTo(n.overscaledZ-1);const r=this._tiles[n.key];if(r&&r.hasData()&&i[n.key]){u[e]=t.tileID;break}}}for(const e in t)u[e]||(this._coveredTiles[e]=!0,u[e]=t[e])}for(const e in u)this._tiles[e].clearFadeHold();const h=e.bu(this._tiles,u);for(const e of h){const t=this._tiles[e];t.hasSymbolBuckets&&!t.holdingForFade()?t.setHoldDuration(this.map._fadeDuration):t.hasSymbolBuckets&&!t.symbolFadeFinished()||this._removeTile(+e)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e)}_updateRetainedTiles(e){const t={};if(0===e.length)return t;const i={},n=e.reduce(((e,t)=>Math.min(e,t.overscaledZ)),1/0),r=e[0].overscaledZ,o=Math.max(r-Ot.maxOverzooming,this._source.minzoom),s=Math.max(r+Ot.maxUnderzooming,this._source.minzoom),a={};for(const i of e){const e=this._addTile(i);t[i.key]=i,e.hasData()||n<this._source.maxzoom&&(a[i.key]=i)}this._retainLoadedChildren(a,n,s,t);for(const n of e){let e=this._tiles[n.key];if(e.hasData())continue;if(n.canonical.z>=this._source.maxzoom){const e=n.children(this._source.maxzoom)[0],i=this.getTile(e);if(i&&i.hasData()){t[e.key]=e;continue}}else{const e=n.children(this._source.maxzoom);if(t[e[0].key]&&t[e[1].key]&&t[e[2].key]&&t[e[3].key])continue}let r=e.wasRequested();for(let s=n.overscaledZ-1;s>=o;--s){const o=n.scaledTo(s);if(i[o.key])break;if(i[o.key]=!0,e=this.getTile(o),!e&&r&&(e=this._addTile(o)),e&&(t[o.key]=o,r=e.wasRequested(),e.hasData()))break}}return t}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const t=[];let i,n=this._tiles[e].tileID;for(;n.overscaledZ>0;){if(n.key in this._loadedParentTiles){i=this._loadedParentTiles[n.key];break}t.push(n.key);const e=n.scaledTo(n.overscaledZ-1);if(i=this._getLoadedTile(e),i)break;n=e}for(const e of t)this._loadedParentTiles[e]=i}}_addTile(t){let i=this._tiles[t.key];if(i)return!0!==i.isExtraShadowCaster||!!this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),i;i=this._cache.getAndRemove(t),i&&(this._setTileReloadTimer(t.key,i),i.tileID=t,this._state.initializeTileState(i,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,i)));const n=Boolean(i);if(!n){const e=this.map?this.map.painter:null,n=this._source.tileSize*t.overscaleFactor();i="raster-array"===this._source.type?new Pt(t,n,this.transform.tileZoom,e,this._isRaster):new Ct(t,n,this.transform.tileZoom,e,this._isRaster,this._source.worldview),this._loadTile(i,this._tileLoaded.bind(this,i,t.key,i.state))}return i.uses++,this._tiles[t.key]=i,n||this._source.fire(new e.z("dataloading",{tile:i,coord:i.tileID,dataType:"source"})),i}_setTileReloadTimer(e,t){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const i=t.getExpiryTimeout();i&&(this._timers[e]=setTimeout((()=>{this._reloadTile(e,"expired"),delete this._timers[e]}),i))}_removeTile(e){const t=this._tiles[e];t&&(t.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),t.uses>0||(t.hasData()&&"reloading"!==t.state||"empty"===t.state?this._cache.add(t.tileID,t,t.getExpiryTimeout()):(t.aborted=!0,this._abortTile(t),this._unloadTile(t))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,i,n){const r=[],o=this.transform;if(!o)return r;const s="globe"===o.projection.name,a=e.aF(o.center.lng);for(const l in this._tiles){const c=this._tiles[l];if(n&&c.clearQueryDebugViz(),c.holdingForFade())continue;let u;if(s){const t=c.tileID.canonical;if(0===t.z){const i=[Math.abs(e.aA(a,...Ft(t,-1))-a),Math.abs(e.aA(a,...Ft(t,1))-a)];u=[0,2*i.indexOf(Math.min(...i))-1]}else{const i=[Math.abs(e.aA(a,...Ft(t,-1))-a),Math.abs(e.aA(a,...Ft(t,0))-a),Math.abs(e.aA(a,...Ft(t,1))-a)];u=[i.indexOf(Math.min(...i))-1]}}else u=[0];for(const e of u){const n=t.containsTile(c,o,i,e);n&&r.push(n)}}return r}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(e){return this._getRenderableCoordinates(e)}_getRenderableCoordinates(e,t){const i=this.getRenderableIds(e,t).map((e=>this._tiles[e].tileID)),n="globe"===this.transform.projection.name;for(const e of i)e.projMatrix=this.transform.calculateProjMatrix(e.toUnwrapped()),e.expandedProjMatrix=n?this.transform.calculateProjMatrix(e.toUnwrapped(),!1,!0):e.projMatrix;return i}sortCoordinatesByDistance(e){const t=e.slice(),i=this.transform._camera.position,n=this.transform._camera.forward(),r={};for(const e of t){const t=1/(1<<e.canonical.z);r[e.key]=((e.canonical.x+.5)*t+e.wrap-i[0])*n[0]+((e.canonical.y+.5)*t-i[1])*n[1]-i[2]*n[2]}return t.sort(((e,t)=>r[e.key]-r[t.key])),t}hasTransition(){if(this._source.hasTransition())return!0;if(Bt(this._source.type))for(const t in this._tiles){const i=this._tiles[t];if(void 0!==i.fadeEndTime&&i.fadeEndTime>=e.o.now())return!0}return!1}setFeatureState(e,t,i){this._state.updateState(e=e||"_geojsonTileLayer",t,i)}removeFeatureState(e,t,i){this._state.removeFeatureState(e=e||"_geojsonTileLayer",t,i)}getFeatureState(e,t){return this._state.getState(e=e||"_geojsonTileLayer",t)}setDependencies(e,t,i){const n=this._tiles[e];n&&n.setDependencies(t,i)}reloadTilesForDependencies(e,t){for(const i in this._tiles)this._tiles[i].hasDependency(e,t)&&this._reloadTile(+i,"reloading");this._cache.filter((i=>!i.hasDependency(e,t)))}_preloadTiles(t,i){if(!this._sourceLoaded){const e=()=>{this._sourceLoaded&&(this._source.off("data",e),this._preloadTiles(t,i))};return void this._source.on("data",e)}const n=new Map,r=Array.isArray(t)?t:[t],o=this.map.painter.terrain,s=this.usedForTerrain&&o?o.getScaledDemTileSize():this._source.tileSize;for(const e of r){const t=e.coveringTiles({tileSize:s,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const e of t)n.set(e.key,e);this.usedForTerrain&&e.updateElevation(!1)}const a=Array.from(n.values());e.bv(a,((e,t)=>{const i=new Ct(e,this._source.tileSize*e.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(i,(e=>{"raster-dem"===this._source.type&&i.dem&&this._backfillDEM(i),t(e,i)}))}),i)}}function Dt(e,t){const i=Math.abs(2*e.wrap)-+(e.wrap<0),n=Math.abs(2*t.wrap)-+(t.wrap<0);return e.overscaledZ-t.overscaledZ||n-i||t.canonical.y-e.canonical.y||t.canonical.x-e.canonical.x}function Bt(e){return"raster"===e||"image"===e||"video"===e||"custom"===e}function Ft(e,t){const i=1<<e.z;return[e.x/i+t,(e.x+1)/i+t]}Ot.maxOverzooming=10,Ot.maxUnderzooming=3;class Nt{constructor(e){this.style=e,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const e=!1,t=!1;for(const i in this.style._mergedLayers){const n=this.style._mergedLayers[i];if("fill-extrusion"===n.type||"building"===n.type)this.layers.push({layer:n,visible:e,visibilityChanged:t});else if("model"===n.type){const i=this.style.getLayerSource(n);i&&"batched-model"===i.type&&this.layers.push({layer:n,visible:e,visibilityChanged:t})}}}onNewFrame(e){this.layersGotHidden=!1;for(const t of this.layers){const i=t.layer;let n=!1;"fill-extrusion"===i.type?n=!i.isHidden(e)&&i.paint.get("fill-extrusion-opacity")>0:"building"===i.type?n=!i.isHidden(e)&&i.paint.get("building-opacity")>0:"model"===i.type&&(n=!i.isHidden(e)&&i.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!n&&t.visible,t.visible=n}}updateZOffset(e,t){this.currentBuildingBuckets=[];for(const e of this.layers){const i=e.layer,n=this.style.getLayerSourceCache(i);let r=1;"fill-extrusion"===i.type?r=e.visible?i.paint.get("fill-extrusion-vertical-scale"):0:"building"===i.type&&(r=e.visible?i.paint.get("building-vertical-scale"):0);let o=n?n.getTile(t):null;if(!o&&n)for(const e in n._tiles){const i=n._tiles[e];if(t.canonical.isChildOf(i.tileID.canonical)){o=i;break}}this.currentBuildingBuckets.push({bucket:o?o.getBucket(i):null,tileID:o?o.tileID:t,verticalScale:r})}e.hasAnyZOffset=!1;let i=!1;for(let n=0;n<e.symbolInstances.length;n++){const r=e.symbolInstances.get(n),o=r.zOffset,s=this._getHeightAtTileOffset(t,r.tileAnchorX,r.tileAnchorY);r.zOffset=s!==Number.NEGATIVE_INFINITY?s:o,i||o===r.zOffset||(i=!0),e.hasAnyZOffset||0===r.zOffset||(e.hasAnyZOffset=!0)}i&&(e.zOffsetBuffersNeedUpload=!0,e.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,i,n,r){let o=i,s=n;if(t.canonical.z!==r.canonical.z){const a=r.canonical,l=1/(1<<t.canonical.z-a.z);o=(i+t.canonical.x*e.al)*l-a.x*e.al|0,s=(n+t.canonical.y*e.al)*l-a.y*e.al|0}return{tileX:o,tileY:s}}_getHeightAtTileOffset(e,t,i){let n,r;for(let o=0;o<this.layers.length;++o){const s=this.layers[o].layer;if("fill-extrusion"!==s.type&&"building"!==s.type)continue;const{bucket:a,tileID:l,verticalScale:c}=this.currentBuildingBuckets[o];if(!a)continue;const{tileX:u,tileY:h}=this._mapCoordToOverlappingTile(e,t,i,l),d=a.getHeightAtTileCoord(u,h);d&&void 0!==d.height&&(d.hidden?n=d.height:r=Math.max(d.height*c,r||0))}if(void 0!==r)return r;for(let r=0;r<this.layers.length;++r){const o=this.layers[r];if("model"!==o.layer.type||!o.visible)continue;const{bucket:s,tileID:a}=this.currentBuildingBuckets[r];if(!s)continue;const{tileX:l,tileY:c}=this._mapCoordToOverlappingTile(e,t,i,a),u=s.getHeightAtTileCoord(l,c);if(u&&!u.hidden)return void 0===u.height&&void 0!==n?Math.min(u.maxHeight,n)*u.verticalScale:u.height?u.height*u.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function kt(t,i){const n={};for(const e in t)"ref"!==e&&(n[e]=t[e]);return e.bw.forEach((e=>{e in i&&(n[e]=i[e])})),n}function Ut(e){e=e.slice();const t=Object.create(null);for(let i=0;i<e.length;i++)t[e[i].id]=e[i];for(let i=0;i<e.length;i++)"ref"in e[i]&&(e[i]=kt(e[i],t[e[i].ref]));return e}const zt={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Vt(e,t,i){i.push({command:zt.addSource,args:[e,t[e]]})}function Gt(e,t,i){t.push({command:zt.removeSource,args:[e]}),i[e]=!0}function jt(e,t,i,n){Gt(e,i,n),Vt(e,t,i)}function Ht(t,i,n){let r;for(r in t[n])if(t[n].hasOwnProperty(r)&&"data"!==r&&!e.bx(t[n][r],i[n][r]))return!1;for(r in i[n])if(i[n].hasOwnProperty(r)&&"data"!==r&&!e.bx(t[n][r],i[n][r]))return!1;return!0}function $t(t,i,n,r,o,s){let a;for(a in i=i||{},t=t||{})t.hasOwnProperty(a)&&(e.bx(t[a],i[a])||n.push({command:s,args:[r,a,i[a],o]}));for(a in i)i.hasOwnProperty(a)&&!t.hasOwnProperty(a)&&(e.bx(t[a],i[a])||n.push({command:s,args:[r,a,i[a],o]}))}function Wt(e){return e.id}function qt(e,t){return e[t.id]=t,e}function Xt(t,i,n){const r=i.createTileMatrix(t,t.worldSize,n.toUnwrapped());return e.aB(new Float32Array(16),t.projMatrix,r)}function Yt(e,t,i){if(t.projection.name===i.projection.name)return e.projMatrix;const n=i.clone();return n.setProjection(t.projection),Xt(n,t.getProjection(),e)}function Zt(e,t,i){return t.name===i.projection.name?e.projMatrix:Xt(i,t,e)}class Jt{constructor(e,t){this.reset(e,t)}reset(e,t){this.points=e||[],this._distances=[0];for(let e=1;e<this.points.length;e++)this._distances[e]=this._distances[e-1]+this.points[e].dist(this.points[e-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(t||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(1===this.points.length)return this.points[0];t=e.aA(t,0,1);let i=1,n=this._distances[i];const r=t*this.paddedLength+this.padding;for(;n<r&&i<this._distances.length;)n=this._distances[++i];const o=i-1,s=this._distances[o],a=n-s,l=a>0?(r-s)/a:0;return this.points[o].mult(1-l).add(this.points[i].mult(l))}}class Kt{constructor(e,t,i){const n=this.boxCells=[],r=this.circleCells=[];this.xCellCount=Math.ceil(e/i),this.yCellCount=Math.ceil(t/i);for(let e=0;e<this.xCellCount*this.yCellCount;e++)n.push([]),r.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=t,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/t,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(e,t,i,n,r){this._forEachCell(t,i,n,r,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(t),this.bboxes.push(i),this.bboxes.push(n),this.bboxes.push(r)}insertCircle(e,t,i,n){this._forEachCell(t-n,i-n,t+n,i+n,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(t),this.circles.push(i),this.circles.push(n)}_insertBoxCell(e,t,i,n,r,o){this.boxCells[r].push(o)}_insertCircleCell(e,t,i,n,r,o){this.circleCells[r].push(o)}_query(e,t,i,n,r,o){if(i<0||e>this.width||n<0||t>this.height)return!r&&[];const s=[];if(e<=0&&t<=0&&this.width<=i&&this.height<=n){if(r)return!0;for(let e=0;e<this.boxKeys.length;e++)s.push({key:this.boxKeys[e],x1:this.bboxes[4*e],y1:this.bboxes[4*e+1],x2:this.bboxes[4*e+2],y2:this.bboxes[4*e+3]});for(let e=0;e<this.circleKeys.length;e++){const t=this.circles[3*e],i=this.circles[3*e+1],n=this.circles[3*e+2];s.push({key:this.circleKeys[e],x1:t-n,y1:i-n,x2:t+n,y2:i+n})}return o?s.filter(o):s}return this._forEachCell(e,t,i,n,this._queryCell,s,{hitTest:r,seenUids:{box:{},circle:{}}},o),r?s.length>0:s}_queryCircle(e,t,i,n,r){const o=e-i,s=e+i,a=t-i,l=t+i;if(s<0||o>this.width||l<0||a>this.height)return!n&&[];const c=[];return this._forEachCell(o,a,s,l,this._queryCellCircle,c,{hitTest:n,circle:{x:e,y:t,radius:i},seenUids:{box:{},circle:{}}},r),n?c.length>0:c}query(e,t,i,n,r){return this._query(e,t,i,n,!1,r)}hitTest(e,t,i,n,r){return this._query(e,t,i,n,!0,r)}hitTestCircle(e,t,i,n){return this._queryCircle(e,t,i,!0,n)}_queryCell(e,t,i,n,r,o,s,a){const l=s.seenUids,c=this.boxCells[r];if(null!==c){const r=this.bboxes;for(const u of c)if(!l.box[u]){l.box[u]=!0;const c=4*u;if(e<=r[c+2]&&t<=r[c+3]&&i>=r[c+0]&&n>=r[c+1]&&(!a||a(this.boxKeys[u]))){if(s.hitTest)return o.push(!0),!0;o.push({key:this.boxKeys[u],x1:r[c],y1:r[c+1],x2:r[c+2],y2:r[c+3]})}}}const u=this.circleCells[r];if(null!==u){const r=this.circles;for(const c of u)if(!l.circle[c]){l.circle[c]=!0;const u=3*c;if(this._circleAndRectCollide(r[u],r[u+1],r[u+2],e,t,i,n)&&(!a||a(this.circleKeys[c]))){if(s.hitTest)return o.push(!0),!0;{const e=r[u],t=r[u+1],i=r[u+2];o.push({key:this.circleKeys[c],x1:e-i,y1:t-i,x2:e+i,y2:t+i})}}}}}_queryCellCircle(e,t,i,n,r,o,s,a){const l=s.circle,c=s.seenUids,u=this.boxCells[r];if(null!==u){const e=this.bboxes;for(const t of u)if(!c.box[t]){c.box[t]=!0;const i=4*t;if(this._circleAndRectCollide(l.x,l.y,l.radius,e[i+0],e[i+1],e[i+2],e[i+3])&&(!a||a(this.boxKeys[t])))return o.push(!0),!0}}const h=this.circleCells[r];if(null!==h){const e=this.circles;for(const t of h)if(!c.circle[t]){c.circle[t]=!0;const i=3*t;if(this._circlesCollide(e[i],e[i+1],e[i+2],l.x,l.y,l.radius)&&(!a||a(this.circleKeys[t])))return o.push(!0),!0}}}_forEachCell(e,t,i,n,r,o,s,a){const l=this._convertToXCellCoord(e),c=this._convertToYCellCoord(t),u=this._convertToXCellCoord(i),h=this._convertToYCellCoord(n);for(let d=l;d<=u;d++)for(let l=c;l<=h;l++)if(r.call(this,e,t,i,n,this.xCellCount*l+d,o,s,a))return}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}_circlesCollide(e,t,i,n,r,o){const s=n-e,a=r-t,l=i+o;return l*l>s*s+a*a}_circleAndRectCollide(e,t,i,n,r,o,s){const a=(o-n)/2,l=Math.abs(e-(n+a));if(l>a+i)return!1;const c=(s-r)/2,u=Math.abs(t-(r+c));if(u>c+i)return!1;if(l<=a||u<=c)return!0;const h=l-a,d=u-c;return h*h+d*d<=i*i}}const Qt={unknown:0,flipRequired:1,flipNotRequired:2},ei=Math.tan(85*Math.PI/180);function ti(t,i,n,r,o,s,a){const l=e.bB();if(n)if("globe"===s.name){const t=e.bC(o,i);e.aB(l,l,t)}else{const t=e.bD([],a);l[0]=t[0],l[1]=t[1],l[4]=t[2],l[5]=t[3],r||e.bA(l,l,o.angle)}else e.aB(l,o.labelPlaneMatrix,t);return l}function ii(e,t,i,n,r,o,s){const a=ti(e,t,i,n,r,o,s);return"globe"===o.name&&i||(a[2]=a[6]=a[10]=a[14]=0),a}function ni(t,i,n,r,o,s,a){if(n){if("globe"===s.name){const l=ti(t,i,n,r,o,s,a);return e.bk(l,l),e.aB(l,t,l),l}{const i=e.by(t),n=e.bz([]);return n[0]=a[0],n[1]=a[1],n[4]=a[2],n[5]=a[3],e.aB(i,i,n),r||e.bA(i,i,-o.angle),i}}return o.glCoordMatrix}function ri(t,i,n,r){const o=[t,i,n,1];n?e.aC(o,o,r):mi(o,o,r);const s=o[3];return o[0]/=s,o[1]/=s,o[2]/=s,o}function oi(e,t){return Math.min(.5+e/t*.5,1.5)}function si(e,t){const i=e[0]/e[3],n=e[1]/e[3];return i>=-t[0]&&i<=t[0]&&n>=-t[1]&&n<=t[1]}function ai(t,i,n,r,o,s,a,l,c,u,h=1){const d=n.transform,p=r?t.textSizeData:t.iconSizeData,f=e.bJ(p,n.transform.zoom,h),m="globe"===d.projection.name,g=[256/n.width*2+1,256/n.height*2+1],_=r?t.text.dynamicLayoutVertexArray:t.icon.dynamicLayoutVertexArray;_.clear();let y=null;m&&(y=r?t.text.globeExtVertexArray:t.icon.globeExtVertexArray);const v=t.lineVertexArray,x=r?t.text.placedSymbolArray:t.icon.placedSymbolArray,b=n.transform.width/n.transform.height;let T,w=!1;for(let r=0;r<x.length;r++){const h=x.get(r),{numGlyphs:m,writingMode:E}=h;if(E!==e.bK.vertical||w||T===e.bK.horizontal||(w=!0),T=E,(h.hidden||E===e.bK.vertical)&&!w){fi(m,_);continue}w=!1;const S=new e.P(h.tileAnchorX,h.tileAnchorY),A="road"===t.elevationType,M=!!d.elevation||A;let{x:I,y:C,z:P}=d.projection.projectTilePoint(S.x,S.y,u.canonical),L=null;if(M){const e=A?t.getElevationFeatureForText(r):null;L={getElevation:c,elevation:d.elevation,elevationFeature:e};const[i,n,o]=c(S,d.elevation,e);I+=i,C+=n,P+=o}const R=[I,C,P,1];if(e.aC(R,R,i),!si(R,g)){fi(m,_);continue}const O=R[3],D=oi(n.transform.getCameraToCenterDistance(d.projection),O),B=e.bL(p,f,h),F=a?B/D:B*D,N=ri(I,C,P,o);if(N[3]<=0){fi(m,_);continue}let k={};const U=e.an(t.layers[0].layout.get("text-max-angle")),z=Math.cos(U),V=a?null:L,G=ui(h,F,!1,l,i,o,s,t.glyphOffsetArray,v,_,y,N,S,k,b,V,d.projection,u,a,z);w=G.useVertical,V&&G.needsFlipping&&(k={}),(G.notEnoughRoom||w||G.needsFlipping&&ui(h,F,!0,l,i,o,s,t.glyphOffsetArray,v,_,y,N,S,k,b,V,d.projection,u,a,z).notEnoughRoom)&&fi(m,_)}r?(t.text.dynamicLayoutVertexBuffer.updateData(_),y&&t.text.globeExtVertexBuffer&&t.text.globeExtVertexBuffer.updateData(y)):(t.icon.dynamicLayoutVertexBuffer.updateData(_),y&&t.icon.globeExtVertexBuffer&&t.icon.globeExtVertexBuffer.updateData(y))}function li(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g){const{lineStartIndex:_,glyphStartIndex:y,segment:v}=a,x=y+a.numGlyphs,b=_+a.lineLength,T=t.getoffsetX(y),w=t.getoffsetX(x-1),E=pi(e*T,i,n,r,o,s,v,_,b,l,c,u,h,d,!0,p,f,m,g);if(!E)return null;const S=pi(e*w,i,n,r,o,s,v,_,b,l,c,u,h,d,!0,p,f,m,g);return S?{first:E,last:S}:null}function ci(t,i,n,r){return t===e.bK.horizontal&&Math.abs(r)>Math.abs(n)?{useVertical:!0}:t===e.bK.vertical?r>0?{needsFlipping:!0}:null:i!==Qt.unknown&&function(e,t){return 0===e||Math.abs(t/e)>ei}(n,r)?i===Qt.flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null}function ui(t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x){const b=i/24,T=t.lineOffsetX*b,w=t.lineOffsetY*b,{lineStartIndex:E,glyphStartIndex:S,numGlyphs:A,segment:M,writingMode:I,flipState:C}=t,P=E+t.lineLength,L=t=>{if(h){const[i,n,r]=t.up,o=u.length;e.bM(h,o+0,i,n,r),e.bM(h,o+1,i,n,r),e.bM(h,o+2,i,n,r),e.bM(h,o+3,i,n,r)}const[i,n,r]=t.point;e.bN(u,i,n,r,t.angle)};if(A>1){const e=li(b,l,T,w,n,d,p,t,c,s,f,g,!1,_,y,v,x);if(!e)return{notEnoughRoom:!0};if(r&&!n){let[i,n,r]=e.first.point,[o,s,l]=e.last.point;[i,n]=ri(i,n,r,a),[o,s]=ri(o,s,l,a);const c=ci(I,C,(o-i)*m,s-n);if(t.flipState=c&&c.needsFlipping?Qt.flipRequired:Qt.flipNotRequired,c)return c}L(e.first);for(let e=S+1;e<S+A-1;e++){const t=pi(b*l.getoffsetX(e),T,w,n,d,p,M,E,P,c,s,f,g,!1,!1,_,y,v,x);if(!t)return u.length-=4*(e-S),{notEnoughRoom:!0};L(t)}L(e.last)}else{if(r&&!n){const i=ri(p.x,p.y,0,o),n=E+M+1,r=new e.P(c.getx(n),c.gety(n)),s=ri(r.x,r.y,0,o),a=s[3]>0?s:di(p,r,i,1,o,void 0,_,y.canonical),l=ci(I,C,(a[0]-i[0])*m,a[1]-i[1]);if(t.flipState=l&&l.needsFlipping?Qt.flipRequired:Qt.flipNotRequired,l)return l}const i=pi(b*l.getoffsetX(S),T,w,n,d,p,M,E,P,c,s,f,g,!1,!1,_,y,v,x);if(!i)return{notEnoughRoom:!0};L(i)}return{}}function hi(e,t,i,n,r){const{x:o,y:s,z:a}=n.projectTilePoint(e.x,e.y,t);if(!r)return ri(o,s,a,i);const[l,c,u]=r.getElevation(e,r.elevation,r.elevationFeature);return ri(o+l,s+c,a+u,i)}function di(t,i,n,r,o,s,a,l){const c=hi(t.sub(i)._unit()._add(t),l,o,a,s);return e.av(c,n,c),e.aw(c,c),e.bG(c,n,c,r)}function pi(t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v){const x=r?t-i:t+i;let b=x>0?1:-1,T=0;r&&(b*=-1,T=Math.PI),b<0&&(T+=Math.PI);let w=l+a+(b>0?0:1)|0,E=o,S=o,A=0,M=0;const I=Math.abs(x),C=[],P=[];let L=s,R=L,O=e.bE([]);const D=()=>di(R,L,S,I-A+1,h,p,g,_.canonical);for(;A+M<=I;){if(w+=b,w<l||w>=c)return null;if(S=E,R=L,C.push(S),f&&P.push(R),L=new e.P(u.getx(w),u.gety(w)),E=d[w],!E){const e=hi(L,_.canonical,h,g,p);E=e[3]>0?d[w]=e:D()}A+=M;const t=e.av([],E,S),i=e.bF(S,E);if(n&&i>0&&M>0&&e.bI(O,t)/(M*i)<v)return null;M=i,O=t}m&&p&&(d[w]&&(E=D(),M=e.bF(S,E),O=e.av([],E,S)),d[w]=E);const B=(I-A)/M,F=L.sub(R)._mult(B)._add(R),N=e.bG([],S,O,B);let k=[0,0,1],U=O[0],z=O[1];if(y&&(k=g.upVector(_.canonical,F.x,F.y),0!==k[0]||0!==k[1]||1!==k[2])){const t=[k[2],0,-k[0]],i=e.bH([],k,t);e.aw(t,t),e.aw(i,i),U=e.bI(O,t),z=e.bI(O,i)}if(n){const t=e.bH([],k,O);e.aw(t,t),e.bG(N,N,t,n*b)}const V=T+Math.atan2(z,U);return C.push(N),f&&P.push(F),{point:N,angle:V,path:C,tilePath:P,up:k}}function fi(e,t){const i=t.length,n=i+4*e;t.resize(n),t.float32.fill(-1/0,4*i,4*n)}function mi(e,t,i){const n=t[0],r=t[1];return e[0]=i[0]*n+i[4]*r+i[12],e[1]=i[1]*n+i[5]*r+i[13],e[3]=i[3]*n+i[7]*r+i[15],e}const gi=100;class _i{constructor(e,t,i=new Kt(e.width+200,e.height+200,25),n=new Kt(e.width+200,e.height+200,25)){this.transform=e,this.grid=i,this.ignoredGrid=n,this.pitchfactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+gi,this.screenBottomBoundary=e.height+gi,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.fogState=t}placeCollisionBox(t,i,n,r,o,s,a,l,c,u,h){let d=n.projectedAnchorX,p=n.projectedAnchorY,f=n.projectedAnchorZ;const m=n.tileAnchorX,g=n.tileAnchorY,_=n.elevation,y=n.tileID,v=t.getProjection();if(_&&y){const[e,t,i]=v.upVector(y.canonical,n.tileAnchorX,n.tileAnchorY),r=v.upVectorScale(y.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;d+=e*_*r,p+=t*_*r,f+=i*_*r}const x="globe"===t.projection.name,b="globe"===t.projection.name?e.aj(this.transform.zoom):0;if(y&&x&&b<1&&!s){const t=1<<y.canonical.z,i=e.bO(m,g);e.bP(i,i,1/e.al),e.bQ(i,i,e.bO(y.canonical.x,y.canonical.y)),e.bP(i,i,1/t),e.bR(i,i,e.bO(r[0],r[1])),i[0]=e.bS(i[0],-.5,.5),e.bP(i,i,e.al);const n=e.bT(i[0],i[1],e.al/(2*Math.PI),1);e.aC(n,n,o),d=e.ak(d,n[0],b),p=e.ak(p,n[1],b),f=e.ak(f,n[2],b)}const T=this.projectAndGetPerspectiveRatio(u,d,p,f,n.tileID,"globe"===v.name||!!_||this.transform.pitch>0,v),w=c*T.perspectiveRatio,E=(n.x1*i+a.x-n.padding)*w+T.point.x,S=(n.y1*i+a.y-n.padding)*w+T.point.y,A=(n.x2*i+a.x+n.padding)*w+T.point.x,M=(n.y2*i+a.y+n.padding)*w+T.point.y,I=T.perspectiveRatio<=.55||T.occluded;return!this.isInsideGrid(E,S,A,M)||!l&&this.grid.hitTest(E,S,A,M,h)||I?{box:[],offscreen:!1,occluded:T.occluded}:{box:[E,S,A,M],offscreen:this.isOffscreen(E,S,A,M),occluded:!1}}placeCollisionCircles(t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g){const _=[],y=this.transform.elevation,v=t.getProjection(),x="road"===t.elevationType,b=!!y||x,T=e.bU.getAtTileOffsetFunc(g,this.transform.center.lat,this.transform.worldSize,v),w=new e.P(n.tileAnchorX,n.tileAnchorY),E=new e.P(n.tileAnchorX,n.tileAnchorY);let{x:S,y:A,z:M}=v.projectTilePoint(E.x,E.y,g.canonical),I=null;if(b){const e=x?t.getElevationFeatureForText(r):null;I={getElevation:T,elevation:y,elevationFeature:e};const[i,n,o]=T(w,y,e);S+=i,A+=n,M+=o}const C="globe"===v.name,P=this.projectAndGetPerspectiveRatio(l,S,A,M,g,C||!!y||this.transform.pitch>0,v),{perspectiveRatio:L}=P,R=(d?a/L:a*L)/e.bX,O=ri(S,A,M,c),D=n.lineOffsetX*R,B=n.lineOffsetY*R,F=e.an(t.layers[0].layout.get("text-max-angle")),N=Math.cos(F),k=P.signedDistanceFromCamera>0?li(R,s,D,B,x&&1===n.flipState,O,E,n,o,c,{},b&&!d?I:null,d&&b,v,g,d,N):null;let U=!1,z=!1,V=!0;if(k&&!P.occluded){const t=.5*f*L+m,n=new e.P(-100,-100),r=new e.P(this.screenRightBoundary,this.screenBottomBoundary),o=new Jt,{first:s,last:a}=k,l=s.path.length;let c=[];for(let e=l-1;e>=1;e--)c.push(s.path[e]);for(let e=1;e<a.path.length;e++)c.push(a.path[e]);const d=2.5*t;u&&(c=c.map((([e,t,i],n)=>(b&&!C&&(i=T(n<l-1?s.tilePath[l-1-n]:a.tilePath[n-l+2],y,I.elevationFeature)[2]),ri(e,t,i,u)))),c.some((e=>e[3]<=0))&&(c=[]));let g=[];if(c.length>0){let t=1/0,i=-1/0,o=1/0,s=-1/0;for(const e of c)t=Math.min(t,e[0]),o=Math.min(o,e[1]),i=Math.max(i,e[0]),s=Math.max(s,e[1]);i>=n.x&&t<=r.x&&s>=n.y&&o<=r.y&&(g=[c.map((t=>new e.P(t[0],t[1])))],(t<n.x||i>r.x||o<n.y||s>r.y)&&(g=e.bV(g,n.x,n.y,r.x,r.y)))}for(const e of g){o.reset(e,.25*t);let n=0;n=o.length<=.5*t?1:Math.ceil(o.paddedLength/d)+1;for(let e=0;e<n;e++){const r=e/Math.max(n-1,1),s=o.lerp(r),a=s.x+gi,l=s.y+gi;_.push(a,l,t,0);const c=a-t,u=l-t,d=a+t,f=l+t;if(V=V&&this.isOffscreen(c,u,d,f),z=z||this.isInsideGrid(c,u,d,f),!i&&this.grid.hitTestCircle(a,l,t,p)&&(U=!0,!h))return{circles:[],offscreen:!1,collisionDetected:U,occluded:!1}}}}return{circles:!h&&U||!z?[]:_,offscreen:V,collisionDetected:U,occluded:P.occluded}}queryRenderedSymbols(t){if(0===t.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const i=[];let n=1/0,r=1/0,o=-1/0,s=-1/0;for(const a of t){const t=new e.P(a.x+gi,a.y+gi);n=Math.min(n,t.x),r=Math.min(r,t.y),o=Math.max(o,t.x),s=Math.max(s,t.y),i.push(t)}const a=this.grid.query(n,r,o,s).concat(this.ignoredGrid.query(n,r,o,s)),l={},c={};for(const t of a){const n=t.key;if(void 0===l[n.bucketInstanceId]&&(l[n.bucketInstanceId]={}),l[n.bucketInstanceId][n.featureIndex])continue;const r=[new e.P(t.x1,t.y1),new e.P(t.x2,t.y1),new e.P(t.x2,t.y2),new e.P(t.x1,t.y2)];e.bW(i,r)&&(l[n.bucketInstanceId][n.featureIndex]=!0,void 0===c[n.bucketInstanceId]&&(c[n.bucketInstanceId]=[]),c[n.bucketInstanceId].push(n.featureIndex))}return c}insertCollisionBox(e,t,i,n,r){(t?this.ignoredGrid:this.grid).insert({bucketInstanceId:i,featureIndex:n,collisionGroupID:r},e[0],e[1],e[2],e[3])}insertCollisionCircles(e,t,i,n,r){const o=t?this.ignoredGrid:this.grid,s={bucketInstanceId:i,featureIndex:n,collisionGroupID:r};for(let t=0;t<e.length;t+=4)o.insertCircle(s,e[t],e[t+1],e[t+2])}projectAndGetPerspectiveRatio(t,i,n,r,o,s,a){const l=[i,n,r,1];let c=!1;if(r||this.transform.pitch>0){if(e.aC(l,l,t),this.fogState&&o&&"globe"!==a.name){const t=function(t,i,n,r,o,s){const a=s.calculateFogTileMatrix(o),l=[i,n,r];return e.af(l,l,a),Ge(t,e.ag(l),s.pitch,s._fov)}(this.fogState,i,n,r,o.toUnwrapped(),this.transform);c=t>.9}}else mi(l,l,t);const u=l[3];return{point:new e.P((l[0]/u+1)/2*this.transform.width+gi,(-l[1]/u+1)/2*this.transform.height+gi),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(a)/u*.5,1.5),signedDistanceFromCamera:u,occluded:s&&l[2]>u||c}}isOffscreen(e,t,i,n){return i<gi||e>=this.screenRightBoundary||n<gi||t>this.screenBottomBoundary}isInsideGrid(e,t,i,n){return i>=0&&e<this.gridRightBoundary&&n>=0&&t<this.gridBottomBoundary}getViewportMatrix(){const t=e.bz([]);return e.bq(t,t,[-100,-100,0]),t}}class yi{constructor(e,t,i,n){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?t:-t))):n&&i?1:0,this.placed=i}isHidden(){return 0===this.opacity&&!this.placed}}class vi{constructor(e,t,i,n,r,o=!1){this.text=new yi(e?e.text:null,t,i,r),this.icon=new yi(e?e.icon:null,t,n,r),this.clipped=o}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class xi{constructor(e,t,i,n=!1){this.text=e,this.icon=t,this.skipFade=i,this.clipped=n}}class bi{constructor(){this.invProjMatrix=e.bB(),this.viewportMatrix=e.bB(),this.circles=[]}}class Ti{constructor(e,t,i,n,r){this.bucketInstanceId=e,this.featureIndex=t,this.sourceLayerIndex=i,this.bucketIndex=n,this.tileID=r}}class wi{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={}}get(e){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[e]){const t=++this.maxGroupID;this.collisionGroups[e]={ID:t,predicate:e=>e.collisionGroupID===t}}return this.collisionGroups[e]}}function Ei(t,i,n,r,o){const{horizontalAlign:s,verticalAlign:a}=e.c0(t),l=-(s-.5)*i,c=-(a-.5)*n,u=e.c1(t,r);return new e.P(l+u[0]*o,c+u[1]*o)}function Si(t,i,n,r,o){const s=new e.P(t,i);return n&&s._rotate(r?o:-o),s}class Ai{constructor(e,t,i,n,r,o){this.transform=e.clone(),this.projection=e.projection.name,this.collisionIndex=new _i(this.transform,r),this.buildingIndex=o,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=t,this.retainedQueryData={},this.collisionGroups=new wi(i),this.collisionCircleArrays={},this.prevPlacement=n,n&&(n.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,i,n,r,o=1){const s=n.getBucket(i),a=n.latestFeatureIndex;if(!s||!a||i.fqid!==s.layerIds[0])return;const l=s.layers[0].layout,c=s.layers[0].paint,u=n.collisionBoxArray,h=Math.pow(2,this.transform.zoom-n.tileID.overscaledZ),d=n.tileSize/e.al,p=n.tileID.toUnwrapped();this.transform.setProjection(s.projection);const f=(m=n.tileID,g=s.getProjection(),_=this.transform,g.name===this.projection?_.calculateProjMatrix(m.toUnwrapped()):Xt(_,g,m));var m,g,_;const y="map"===l.get("text-pitch-alignment"),v="map"===l.get("text-rotation-alignment");i.compileFilter(i.options);const x=i.dynamicFilter(),b=i.dynamicFilterNeedsFeature(),T=this.transform.calculatePixelsToTileUnitsMatrix(n),w=ii(f,n.tileID.canonical,y,v,this.transform,s.getProjection(),T);let E=null;const S=s.getProjection().createInversionMatrix(this.transform,n.tileID.canonical);if(y){const t=ni(f,n.tileID.canonical,y,v,this.transform,s.getProjection(),T);E=e.aB([],this.transform.labelPlaneMatrix,t)}let A=null;x&&n.latestFeatureIndex&&(A={unwrappedTileID:p,dynamicFilter:x,dynamicFilterNeedsFeature:b}),this.retainedQueryData[s.bucketInstanceId]=new Ti(s.bucketInstanceId,a,s.sourceLayerIndex,s.index,n.tileID);const[M,I]=s.layers[0].layout.get("text-size-scale-range"),C=e.aA(o,M,I),[P,L]=l.get("icon-size-scale-range"),R=e.aA(o,P,L),O={bucket:s,layout:l,paint:c,posMatrix:f,invMatrix:S,mercatorCenter:[e.aF(this.transform.center.lng),e.aJ(this.transform.center.lat)],textLabelPlaneMatrix:w,labelToScreenMatrix:E,clippingData:A,scale:h,textPixelRatio:d,holdingForFade:n.holdingForFade(),collisionBoxArray:u,partiallyEvaluatedTextSize:e.bJ(s.textSizeData,this.transform.zoom,C),partiallyEvaluatedIconSize:e.bJ(s.iconSizeData,this.transform.zoom,R),collisionGroup:this.collisionGroups.get(s.sourceID),latestFeatureIndex:n.latestFeatureIndex};if(r)for(const e of s.sortKeyRanges){const{sortKey:i,symbolInstanceStart:n,symbolInstanceEnd:r}=e;t.push({sortKey:i,symbolInstanceStart:n,symbolInstanceEnd:r,parameters:O})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:s.symbolInstances.length,parameters:O})}attemptAnchorPlacement(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x){const{textOffset0:b,textOffset1:T,crossTileID:w}=f,E=[b,T],S=Ei(e,o,s,E,a),A=this.collisionIndex.placeCollisionBox(g,a,t,i,n,r,Si(S.x,S.y,l,c,this.transform.angle),p,u,h,d.predicate);if(y){const e=g.getSymbolInstanceIconSize(x,this.transform.zoom,f.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(g,e,y,i,n,r,Si(S.x,S.y,l,c,this.transform.angle),p,u,h,d.predicate).box.length)return}if(A.box.length>0){let t;return this.prevPlacement&&this.prevPlacement.variableOffsets[w]&&this.prevPlacement.placements[w]&&this.prevPlacement.placements[w].text&&(t=this.prevPlacement.variableOffsets[w].anchor),this.variableOffsets[w]={textOffset:E,width:o,height:s,anchor:e,textScale:a,prevAnchor:t},this.markUsedJustification(g,e,f,_),g.allowVerticalPlacement&&(this.markUsedOrientation(g,_,f),this.placedOrientations[w]=_),{shift:S,placedGlyphBoxes:A}}}placeLayerBucketPart(t,i,n,r,o=1){const{bucket:s,layout:a,paint:l,posMatrix:c,textLabelPlaneMatrix:u,labelToScreenMatrix:h,clippingData:d,textPixelRatio:p,mercatorCenter:f,invMatrix:m,holdingForFade:g,collisionBoxArray:_,partiallyEvaluatedTextSize:y,partiallyEvaluatedIconSize:v,collisionGroup:x,latestFeatureIndex:b}=t.parameters,T=a.get("text-optional"),w=a.get("icon-optional"),E=a.get("text-allow-overlap"),S=a.get("icon-allow-overlap"),A="map"===a.get("text-rotation-alignment"),M="map"===a.get("icon-rotation-alignment"),I="map"===a.get("text-pitch-alignment"),C=l.get("symbol-z-offset"),P="sea"===a.get("symbol-elevation-reference"),L=a.get("symbol-placement"),[R,O]=a.get("text-size-scale-range"),[D,B]=a.get("icon-size-scale-range"),F=e.aA(o,R,O),N=e.aA(o,D,B),k=a.get("text-variable-anchor"),U=A&&"point"!==L,z=M&&"point"!==L,V=k&&s.hasTextData(),G=s.hasIconTextFit()&&V&&s.hasIconData();this.transform.setProjection(s.projection);const j=V||U,H=z||G;let $=E&&(S||!s.hasIconData()||w),W=S&&(E||!s.hasTextData()||T);const q=!C.isConstant();!s.collisionArrays&&_&&s.deserializeCollisionBoxes(_),n&&r&&s.updateCollisionDebugBuffers(this.transform.zoom,_,F,N);const X=(t,r,o)=>{const{crossTileID:l,numVerticalGlyphVertices:_}=t;let M=null;if(d&&d.dynamicFilterNeedsFeature||q){const e=this.retainedQueryData[s.bucketInstanceId];M=b.loadFeature({featureIndex:t.featureIndex,bucketIndex:e.bucketIndex,sourceLayerIndex:e.sourceLayerIndex,layoutVertexArrayOffset:0})}if(d&&!(0,d.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:s.worldview},M,this.retainedQueryData[s.bucketInstanceId].tileID.canonical,new e.P(t.tileAnchorX,t.tileAnchorY),this.transform.calculateDistanceTileData(d.unwrappedTileID)))return this.placements[l]=new xi(!1,!1,!1,!0),void i.add(l);const L=C.evaluate(M,{});if(i.has(l))return;if(g)return void(this.placements[l]=new xi(!1,!1,!1));let R=!1,O=!1,D=!0,B=!1,F=!1,N=null,U={box:null,offscreen:null,occluded:null},z={box:null},V=null,G=null,X=null,Y=0,Z=0,J=0;o.textFeatureIndex?Y=o.textFeatureIndex:t.useRuntimeCollisionCircles&&(Y=t.featureIndex),o.verticalTextFeatureIndex&&(Z=o.verticalTextFeatureIndex);const K=s.elevationFeatures?s.elevationFeatures[t.elevationFeatureIndex]:void 0,Q=i=>{i.tileID=this.retainedQueryData[s.bucketInstanceId].tileID;const n=this.transform.elevation;i.elevation=P?L:L+e.bU.getAtTileOffset(i.tileID,new e.P(i.tileAnchorX,i.tileAnchorY),n,K),i.elevation+=t.zOffset},ee=o.textBox;if(ee){Q(ee);const i=i=>{let n=e.bK.horizontal;if(s.allowVerticalPlacement&&!i&&this.prevPlacement){const e=this.prevPlacement.placedOrientations[l];e&&(this.placedOrientations[l]=e,n=e,this.markUsedOrientation(s,n,t))}return n},n=(t,i)=>{if(s.allowVerticalPlacement&&_>0&&o.verticalTextBox){for(const n of s.writingModes)if(n===e.bK.vertical?(U=i(),z=U):U=t(),U&&U.box&&U.box.length)break}else U=t()};if(k){let a=k;if(this.prevPlacement&&this.prevPlacement.variableOffsets[l]){const e=this.prevPlacement.variableOffsets[l];a.indexOf(e.anchor)>0&&(a=a.filter((t=>t!==e.anchor)),a.unshift(e.anchor))}const u=(e,i,n)=>{const o=s.getSymbolInstanceTextSize(y,t,this.transform.zoom,r),l=(e.x2-e.x1)*o+2*e.padding,u=(e.y2-e.y1)*o+2*e.padding,h=t.hasIconTextFit&&!S?i:null;h&&Q(h);let d={box:[],offscreen:!1,occluded:!1};const g=E?2*a.length:a.length;for(let i=0;i<g;++i){const g=this.attemptAnchorPlacement(a[i%a.length],e,f,m,j,l,u,o,A,I,p,c,x,i>=a.length,t,r,s,n,h,y,v);if(g&&(d=g.placedGlyphBoxes,d&&d.box&&d.box.length)){R=!0,N=g.shift;break}}return d};n((()=>u(ee,o.iconBox,e.bK.horizontal)),(()=>{const t=o.verticalTextBox;return t&&Q(t),s.allowVerticalPlacement&&!(U&&U.box&&U.box.length)&&_>0&&t?u(t,o.verticalIconBox,e.bK.vertical):{box:null,offscreen:null,occluded:null}})),U&&(R=U.box,D=U.offscreen,B=U.occluded);const h=i(!(!U||!U.box));if(!R&&this.prevPlacement){const e=this.prevPlacement.variableOffsets[l];e&&(this.variableOffsets[l]=e,this.markUsedJustification(s,e.anchor,t,h))}}else{const a=(i,n)=>{const o=s.getSymbolInstanceTextSize(y,t,this.transform.zoom,r),a=this.collisionIndex.placeCollisionBox(s,o,i,f,m,j,new e.P(0,0),E,p,c,x.predicate);return a&&a.box&&a.box.length&&(this.markUsedOrientation(s,n,t),this.placedOrientations[l]=n),a};n((()=>a(ee,e.bK.horizontal)),(()=>{const t=o.verticalTextBox;return s.allowVerticalPlacement&&_>0&&t?(Q(t),a(t,e.bK.vertical)):{box:null,offscreen:null,occluded:null}})),i(!!(U&&U.box&&U.box.length))}}if(V=U,R=V&&V.box&&V.box.length>0,D=V&&V.offscreen,B=V&&V.occluded,t.useRuntimeCollisionCircles){const i=t.centerJustifiedTextSymbolIndex>=0?t.centerJustifiedTextSymbolIndex:t.verticalPlacedTextSymbolIndex,r=s.text.placedSymbolArray.get(i),o=e.bL(s.textSizeData,y,r),l=a.get("text-padding");G=this.collisionIndex.placeCollisionCircles(s,E,r,i,s.lineVertexArray,s.glyphOffsetArray,o,c,u,h,n,I,x.predicate,t.collisionCircleDiameter*o/e.bX,l,this.retainedQueryData[s.bucketInstanceId].tileID),R=E||G.circles.length>0&&!G.collisionDetected,D=D&&G.offscreen,B=G.occluded}if(o.iconFeatureIndex&&(J=o.iconFeatureIndex),o.iconBox){const i=i=>{Q(i);const n=t.hasIconTextFit&&N?Si(N.x,N.y,A,I,this.transform.angle):new e.P(0,0),r=s.getSymbolInstanceIconSize(v,this.transform.zoom,t.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(s,r,i,f,m,H,n,S,p,c,x.predicate)};z&&z.box&&z.box.length&&o.verticalIconBox?(X=i(o.verticalIconBox),O=X.box.length>0):(X=i(o.iconBox),O=X.box.length>0),D=D&&X.offscreen,F=X.occluded}const te=T||0===t.numHorizontalGlyphVertices&&0===_,ie=w||0===t.numIconVertices;if(te||ie?ie?te||(O=O&&R):R=O&&R:O=R=O&&R,R&&V&&V.box&&this.collisionIndex.insertCollisionBox(V.box,a.get("text-ignore-placement"),s.bucketInstanceId,z&&z.box&&Z?Z:Y,x.ID),O&&X&&this.collisionIndex.insertCollisionBox(X.box,a.get("icon-ignore-placement"),s.bucketInstanceId,J,x.ID),G&&(R&&this.collisionIndex.insertCollisionCircles(G.circles,a.get("text-ignore-placement"),s.bucketInstanceId,Y,x.ID),n)){const e=s.bucketInstanceId;let t=this.collisionCircleArrays[e];void 0===t&&(t=this.collisionCircleArrays[e]=new bi);for(let e=0;e<G.circles.length;e+=4)t.circles.push(G.circles[e+0]),t.circles.push(G.circles[e+1]),t.circles.push(G.circles[e+2]),t.circles.push(G.collisionDetected?1:0)}const ne="globe"!==s.projection.name;$=$&&(ne||!B),W=W&&(ne||!F),this.placements[l]=new xi(R||$,O||W,D||s.justReloaded),i.add(l)},Y=this.retainedQueryData[s.bucketInstanceId].tileID;if("offset"===s.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(s,Y),"road"===s.elevationType&&s.updateRoadElevation(Y.canonical),s.updateZOffset(),s.sortFeaturesByY){const t=s.getSortedSymbolIndexes(this.transform.angle);for(let e=t.length-1;e>=0;--e){const i=t[e];X(s.symbolInstances.get(i),i,s.collisionArrays[i])}s.hasAnyZOffset&&e.w(`${s.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(s.hasAnyZOffset){const e=s.getSortedIndexesByZOffset();for(let t=0;t<e.length;++t){const i=e[t];X(s.symbolInstances.get(i),i,s.collisionArrays[i])}}else for(let e=t.symbolInstanceStart;e<t.symbolInstanceEnd;e++)X(s.symbolInstances.get(e),e,s.collisionArrays[e]);if(n&&s.bucketInstanceId in this.collisionCircleArrays){const t=this.collisionCircleArrays[s.bucketInstanceId];e.bk(t.invProjMatrix,c),t.viewportMatrix=this.collisionIndex.getViewportMatrix()}s.justReloaded=!1}markUsedJustification(t,i,n,r){const{leftJustifiedTextSymbolIndex:o,centerJustifiedTextSymbolIndex:s,rightJustifiedTextSymbolIndex:a,verticalPlacedTextSymbolIndex:l,crossTileID:c}=n,u=e.c2(i),h=r===e.bK.vertical?l:"left"===u?o:"center"===u?s:"right"===u?a:-1;o>=0&&(t.text.placedSymbolArray.get(o).crossTileID=h>=0&&o!==h?0:c),s>=0&&(t.text.placedSymbolArray.get(s).crossTileID=h>=0&&s!==h?0:c),a>=0&&(t.text.placedSymbolArray.get(a).crossTileID=h>=0&&a!==h?0:c),l>=0&&(t.text.placedSymbolArray.get(l).crossTileID=h>=0&&l!==h?0:c)}markUsedOrientation(t,i,n){const r=i===e.bK.horizontal||i===e.bK.horizontalOnly?i:0,o=i===e.bK.vertical?i:0,{leftJustifiedTextSymbolIndex:s,centerJustifiedTextSymbolIndex:a,rightJustifiedTextSymbolIndex:l,verticalPlacedTextSymbolIndex:c}=n,u=t.text.placedSymbolArray;s>=0&&(u.get(s).placedOrientation=r),a>=0&&(u.get(a).placedOrientation=r),l>=0&&(u.get(l).placedOrientation=r),c>=0&&(u.get(c).placedOrientation=o)}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const t=this.prevPlacement;let i=!1;this.prevZoomAdjustment=t?t.zoomAdjustment(this.transform.zoom):0;const n=t?t.symbolFadeChange(e):1,r=t?t.opacities:{},o=t?t.variableOffsets:{},s=t?t.placedOrientations:{};for(const e in this.placements){const t=this.placements[e],o=r[e];o?(this.opacities[e]=new vi(o,n,t.text,t.icon,null,t.clipped),i=i||t.text!==o.text.placed||t.icon!==o.icon.placed):(this.opacities[e]=new vi(null,n,t.text,t.icon,t.skipFade,t.clipped),i=i||t.text||t.icon)}for(const e in r){const t=r[e];if(!this.opacities[e]){const r=new vi(t,n,!1,!1);r.isHidden()||(this.opacities[e]=r,i=i||t.text.placed||t.icon.placed)}}for(const e in o)this.variableOffsets[e]||!this.opacities[e]||this.opacities[e].isHidden()||(this.variableOffsets[e]=o[e]);for(const e in s)this.placedOrientations[e]||!this.opacities[e]||this.opacities[e].isHidden()||(this.placedOrientations[e]=s[e]);i?this.lastPlacementChangeTime=e:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=t?t.lastPlacementChangeTime:e)}updateLayerOpacities(e,t,i,n){const r=new Set;for(const o of t){const t=o.getBucket(e);t&&o.latestFeatureIndex&&e.fqid===t.layerIds[0]&&(this.updateBucketOpacities(t,r,o,o.collisionBoxArray,i,n,o.tileID,e.scope),"offset"===t.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(t,o.tileID),"road"===t.elevationType&&t.updateRoadElevation(o.tileID.canonical),t.updateZOffset())}}updateBucketOpacities(t,i,n,r,o,s,a,l){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const c=t.layers[0].layout,u=t.layers[0].paint,h=!!t.layers[0].dynamicFilter(),d=new vi(null,0,!1,!1,!0),p=c.get("text-allow-overlap"),f=c.get("icon-allow-overlap"),m=c.get("text-variable-anchor"),g="map"===c.get("text-rotation-alignment"),_="map"===c.get("text-pitch-alignment"),y=u.get("symbol-z-offset"),v="sea"===c.get("symbol-elevation-reference"),x=!y.isConstant(),b=new vi(null,0,p&&(f||!t.hasIconData()||c.get("icon-optional")),f&&(p||!t.hasTextData()||c.get("text-optional")),!0);!t.collisionArrays&&r&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(r);const T=(e,t,i)=>{for(let n=0;n<t/4;n++)e.opacityVertexArray.emplaceBack(i)};let w=0;s&&t.updateReplacement(a,s);for(let r=0;r<t.symbolInstances.length;r++){const c=t.symbolInstances.get(r),{numHorizontalGlyphVertices:u,numVerticalGlyphVertices:p,crossTileID:f,numIconVertices:E,tileAnchorX:S,tileAnchorY:A}=c;let M=null;const I=this.retainedQueryData[t.bucketInstanceId];x&&c&&I&&(M=n.latestFeatureIndex.loadFeature({featureIndex:c.featureIndex,bucketIndex:I.bucketIndex,sourceLayerIndex:I.sourceLayerIndex,layoutVertexArrayOffset:0}));const C=y.evaluate(M,{}),P=i.has(f);let L=this.opacities[f];P?L=d:L||(L=b,this.opacities[f]=L),i.add(f);const R=u>0||p>0,O=E>0,D=this.placedOrientations[f],B=D===e.bK.vertical,F=D===e.bK.horizontal||D===e.bK.horizontalOnly;!R&&!O||L.isHidden()||w++;let N=!1;if((R||O)&&s)for(const i of t.activeReplacements){if(e.bY(i,o,e.bZ.Symbol,l))continue;if(i.min.x>S||S>i.max.x||i.min.y>A||A>i.max.y)continue;const t=e.b_(S,A,a.canonical,i.footprintTileId.canonical);if(N=e.b$(t,i.footprint),N)break}if(R){const e=N?Fi:Bi(L.text);T(t.text,u,B?Fi:e),T(t.text,p,F?Fi:e);const i=L.text.isHidden(),{leftJustifiedTextSymbolIndex:n,centerJustifiedTextSymbolIndex:r,rightJustifiedTextSymbolIndex:o,verticalPlacedTextSymbolIndex:s}=c,a=t.text.placedSymbolArray,l=i||B?1:0;n>=0&&(a.get(n).hidden=l),r>=0&&(a.get(r).hidden=l),o>=0&&(a.get(o).hidden=l),s>=0&&(a.get(s).hidden=i||F?1:0);const h=this.variableOffsets[f];h&&this.markUsedJustification(t,h.anchor,c,D);const d=this.placedOrientations[f];d&&(this.markUsedJustification(t,"left",c,d),this.markUsedOrientation(t,d,c))}if(O){const e=N?Fi:Bi(L.icon),{placedIconSymbolIndex:i,verticalPlacedIconSymbolIndex:n}=c,r=t.icon.placedSymbolArray,o=L.icon.isHidden()?1:0;i>=0&&(T(t.icon,E,B?Fi:e),r.get(i).hidden=o),n>=0&&(T(t.icon,c.numVerticalIconVertices,F?Fi:e),r.get(n).hidden=o)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const i=t.collisionArrays[r];if(i){let n=new e.P(0,0),r=!0;if(i.textBox||i.verticalTextBox){if(m){const e=this.variableOffsets[f];e?(n=Ei(e.anchor,e.width,e.height,e.textOffset,e.textScale),g&&n._rotate(_?this.transform.angle:-this.transform.angle)):r=!1}h&&(r=!L.clipped),i.textBox&&Mi(t.textCollisionBox.collisionVertexArray,L.text.placed,!r||B,C,v,n.x,n.y),i.verticalTextBox&&Mi(t.textCollisionBox.collisionVertexArray,L.text.placed,!r||F,C,v,n.x,n.y)}const o=r&&Boolean(!F&&i.verticalIconBox);i.iconBox&&Mi(t.iconCollisionBox.collisionVertexArray,L.icon.placed,o,C,v,c.hasIconTextFit?n.x:0,c.hasIconTextFit?n.y:0),i.verticalIconBox&&Mi(t.iconCollisionBox.collisionVertexArray,L.icon.placed,!o,C,v,c.hasIconTextFit?n.x:0,c.hasIconTextFit?n.y:0)}}}if(t.fullyClipped=0===w,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const e=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=e.invProjMatrix,t.placementViewportMatrix=e.viewportMatrix,t.collisionCircleArray=e.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(e){return 0===this.fadeDuration?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5)}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(e,t){const i=this.zoomAtLastRecencyCheck===t?1-this.zoomAdjustment(t):1;return this.zoomAtLastRecencyCheck=t,this.commitTime+this.fadeDuration*i>e}setStale(){this.stale=!0}}function Mi(e,t,i,n,r,o,s){e.emplaceBack(t?1:0,i?1:0,o||0,s||0,n,r?1:0),e.emplaceBack(t?1:0,i?1:0,o||0,s||0,n,r?1:0),e.emplaceBack(t?1:0,i?1:0,o||0,s||0,n,r?1:0),e.emplaceBack(t?1:0,i?1:0,o||0,s||0,n,r?1:0)}const Ii=Math.pow(2,25),Ci=Math.pow(2,24),Pi=Math.pow(2,17),Li=Math.pow(2,16),Ri=Math.pow(2,9),Oi=Math.pow(2,8),Di=Math.pow(2,1);function Bi(e){if(0===e.opacity&&!e.placed)return 0;if(1===e.opacity&&e.placed)return 4294967295;const t=e.placed?1:0,i=Math.floor(127*e.opacity);return i*Ii+t*Ci+i*Pi+t*Li+i*Ri+t*Oi+i*Di+t}const Fi=0;class Ni{constructor(e){this._sortAcrossTiles="viewport-y"!==e.layout.get("symbol-z-order")&&void 0!==e.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(e,t,i,n,r,o){const s=this._bucketParts;for(;this._currentTileIndex<e.length;)if(t.getBucketParts(s,n,e[this._currentTileIndex],this._sortAcrossTiles,o),this._currentTileIndex++,r())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,s.sort(((e,t)=>e.sortKey-t.sortKey)));this._currentPartIndex<s.length;){const e=s[this._currentPartIndex];if(t.placeLayerBucketPart(e,this._seenCrossTileIDs,i,0===e.symbolInstanceStart,o),this._currentPartIndex++,r())return!0}return!1}}class ki{constructor(e,t,i,n,r,o,s,a,l){this.placement=new Ai(e,r,o,s,a,l),this._currentPlacementIndex=t.length-1,this._forceFullPlacement=i,this._showCollisionBoxes=n,this._done=!1}isDone(){return this._done}continuePlacement(t,i,n,r,o){const s=e.o.now(),a=()=>{const t=e.o.now()-s;return!this._forceFullPlacement&&t>2};for(;this._currentPlacementIndex>=0;){const s=i[t[this._currentPlacementIndex]],l=this.placement.collisionIndex.transform.zoom;if("symbol"===s.type&&(!s.minzoom||s.minzoom<=l)&&(!s.maxzoom||s.maxzoom>l)){const t=s,i=t.layout.get("symbol-z-elevate"),l=void 0!==t.layout.get("symbol-sort-key").constantOr(1),c=t.layout.get("symbol-z-order"),u="viewport-y"===c||"auto"===c&&!("viewport-y"!==c&&l),h=t.layout.get("text-allow-overlap")||t.layout.get("icon-allow-overlap")||t.layout.get("text-ignore-placement")||t.layout.get("icon-ignore-placement"),d=u&&h,p=this._inProgressLayer=this._inProgressLayer||new Ni(t),f=e.B(s.source,s.scope);if(p.continuePlacement(i||d?r[f]:n[f],this.placement,this._showCollisionBoxes,s,a,o))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(e){return this.placement.commit(e),this.placement}}const Ui=512/e.al/2;class zi{constructor(t,i,n){this.tileID=t,this.bucketInstanceId=n,this.index=new e.c3(i.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const r=t.canonical.x*e.al,o=t.canonical.y*e.al;for(let e=0;e<i.length;e++){const{key:t,crossTileID:n,tileAnchorX:s,tileAnchorY:a}=i.get(e),l=Math.floor((r+s)*Ui),c=Math.floor((o+a)*Ui);this.index.add(l,c),this.keys.push(t),this.crossTileIDs.push(n)}this.index.finish()}findMatches(t,i,n){const r=this.tileID.canonical.z<i.canonical.z?1:Math.pow(2,this.tileID.canonical.z-i.canonical.z),o=Ui/Math.pow(2,i.canonical.z-this.tileID.canonical.z),s=i.canonical.x*e.al,a=i.canonical.y*e.al;for(let e=0;e<t.length;e++){const i=t.get(e);if(i.crossTileID)continue;const{key:l,tileAnchorX:c,tileAnchorY:u}=i,h=Math.floor((s+c)*o),d=Math.floor((a+u)*o),p=this.index.range(h-r,d-r,h+r,d+r).sort(((e,t)=>e-t));for(const e of p){const t=this.crossTileIDs[e];if(this.keys[e]===l&&!n.has(t)){n.add(t),i.crossTileID=t;break}}}}}class Vi{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Gi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(e){const t=Math.round((e-this.lng)/360);if(0!==t)for(const e in this.indexes){const i=this.indexes[e],n={};for(const e in i){const r=i[e];r.tileID=r.tileID.unwrapTo(r.tileID.wrap+t),n[r.tileID.key]=r}this.indexes[e]=n}this.lng=e}addBucket(e,t,i){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===t.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key])}for(let e=0;e<t.symbolInstances.length;e++)t.symbolInstances.get(e).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]=new Set);const n=this.usedCrossTileIDs[e.overscaledZ];for(const i in this.indexes){const r=this.indexes[i];if(Number(i)>e.overscaledZ)for(const i in r){const o=r[i];o.tileID.isChildOf(e)&&o.findMatches(t.symbolInstances,e,n)}else{const o=r[e.scaledTo(Number(i)).key];o&&o.findMatches(t.symbolInstances,e,n)}}for(let e=0;e<t.symbolInstances.length;e++){const r=t.symbolInstances.get(e);r.crossTileID||(r.crossTileID=i.generate(),n.add(r.crossTileID))}return void 0===this.indexes[e.overscaledZ]&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new zi(e,t.symbolInstances,t.bucketInstanceId),!0}removeBucketCrossTileIDs(e,t){for(const i of t.crossTileIDs)this.usedCrossTileIDs[e].delete(i)}removeStaleBuckets(e){let t=!1;for(const i in this.indexes){const n=this.indexes[i];for(const r in n)e[n[r].bucketInstanceId]||(this.removeBucketCrossTileIDs(i,n[r]),delete n[r],t=!0)}return t}}class ji{constructor(){this.layerIndexes={},this.crossTileIDs=new Vi,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(e,t,i,n){let r=this.layerIndexes[e.fqid];void 0===r&&(r=this.layerIndexes[e.fqid]=new Gi);let o=!1;const s={};"globe"!==n.name&&r.handleWrapJump(i);for(const i of t){const t=i.getBucket(e);t&&e.fqid===t.layerIds[0]&&(t.bucketInstanceId||(t.bucketInstanceId=++this.maxBucketInstanceId),r.addBucket(i.tileID,t,this.crossTileIDs)&&(o=!0),s[t.bucketInstanceId]=!0)}return r.removeStaleBuckets(s)&&(o=!0),o}pruneUnusedLayers(e){const t={};e.forEach((e=>{t[e]=!0}));for(const e in this.layerIndexes)t[e]||delete this.layerIndexes[e]}}const Hi=771;class $i{constructor(e,t,i,n){this.blendFunction=e,this.blendColor=t.toNonPremultipliedRenderColor(null),this.mask=i,this.blendEquation=n}}$i.Replace=[1,0,1,0],$i.disabled=new $i($i.Replace,e.ao.transparent,[!1,!1,!1,!1]),$i.unblended=new $i($i.Replace,e.ao.transparent,[!0,!0,!0,!0]),$i.alphaBlended=new $i([1,Hi,1,Hi],e.ao.transparent,[!0,!0,!0,!0]),$i.alphaBlendedNonPremultiplied=new $i([770,Hi,770,Hi],e.ao.transparent,[!0,!0,!0,!0]),$i.multiply=new $i([774,0,774,0],e.ao.transparent,[!0,!0,!0,!0]),$i.additive=new $i([1,1,1,1],e.ao.transparent,[!0,!0,!0,!0]);class Wi{constructor(e,t,i){this.func=e,this.mask=t,this.range=i}}Wi.ReadOnly=!1,Wi.ReadWrite=!0,Wi.disabled=new Wi(519,Wi.ReadOnly,[0,1]);const qi=7680;class Xi{constructor(e,t,i,n,r,o){this.test=e,this.ref=t,this.mask=i,this.fail=n,this.depthFail=r,this.pass=o}}Xi.disabled=new Xi({func:519,mask:0},0,0,qi,qi,qi);const Yi=1029,Zi=2305;class Ji{constructor(e,t,i){this.enable=e,this.mode=t,this.frontFace=i}}function Ki(t,i){const n=e.c9(t,3);e.cb(t,i),e.cf(t,3,n)}function Qi(t,i){const n=e.c6([]);return e.c7(n,n,-i),e.c8(n,n,-t),n}function en(t,i){const n=[t[0],t[1],0],r=[i[0],i[1],0];if(e.ag(n)>=1e-15){const t=e.aw([],n);e.c4(r,t,e.bI(r,t)),i[0]=r[0],i[1]=r[1]}const o=e.bH([],i,t);if(e.c5(o)<1e-15)return null;const s=Math.atan2(-o[1],o[0]);return Qi(Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2]),s)}Ji.disabled=new Ji(!1,Yi,Zi),Ji.backCCW=new Ji(!0,Yi,Zi),Ji.backCW=new Ji(!0,Yi,2304),Ji.frontCW=new Ji(!0,1028,2304),Ji.frontCCW=new Ji(!0,1028,Zi);class tn{constructor(e,t){this.position=e,this.orientation=t}get position(){return this._position}set position(t){if(t){const i=t instanceof e.ae?t:new e.ae(t[0],t[1],t[2]);this._renderWorldCopies&&(i.x=e.bS(i.x,0,1)),this._position=i}else this._position=null}lookAtPoint(t,i,n){if(this.orientation=null,!this.position)return;const r=this.position,o=n||(this._elevation?this._elevation.getAtPointOrZero(e.ae.fromLngLat(t)):0),s=e.ae.fromLngLat(t,o),a=[s.x-r.x,s.y-r.y,s.z-r.z];i||(i=[0,0,1]),i[2]=Math.abs(i[2]),this.orientation=en(a,i)}setPitchBearing(t,i){this.orientation=Qi(e.an(t),e.an(-i))}}class nn{constructor(t,i){this._transform=e.bz([]),this.orientation=i,this.position=t}get mercatorPosition(){const t=this.position;return new e.ae(t[0],t[1],t[2])}get position(){const t=e.c9(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var i;t&&e.cf(this._transform,3,[(i=t)[0],i[1],i[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||e.c6([]),t&&Ki(this._transform,this._orientation)}getPitchBearing(){const e=this.forward(),t=this.right();return{bearing:Math.atan2(-t[1],t[0]),pitch:Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2])}}setPitchBearing(e,t){this._orientation=Qi(e,t),Ki(this._transform,this._orientation)}forward(){const t=e.c9(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=e.c9(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=e.c9(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,i){const n=new Float64Array(16);return e.bk(n,this.getWorldToCamera(t,i)),n}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,i,n){const r=this.position;e.c4(r,r,-t);const o=new Float64Array(16);return e.bp(o,[n,n,n]),e.bq(o,o,r),o[10]*=i,o}getWorldToCamera(t,i){const n=new Float64Array(16),r=new Float64Array(4),o=this.position;return e.ca(r,this._orientation),e.c4(o,o,-t),e.cb(n,r),e.bq(n,n,o),n[1]*=-1,n[5]*=-1,n[9]*=-1,n[13]*=-1,n[8]*=i,n[9]*=i,n[10]*=i,n[11]*=i,n}getCameraToClipPerspective(t,i,n,r){const o=new Float64Array(16);return e.cc(o,t,i,n,r),o}getCameraToClipOrthographic(t,i,n,r,o,s){const a=new Float64Array(16);return e.cd(a,t,i,n,r,o,s),a}getDistanceToElevation(t,i=!1){const n=0===t?0:e.ce(t,i?e.a_(this.position[1]):this.position[1]),r=this.forward();return(n-this.position[2])/r[2]}clone(){return new nn([...this.position],[...this.orientation])}}const rn={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class on{constructor(e=0,t=0,i=0,n=0){if(isNaN(e)||e<0||isNaN(t)||t<0||isNaN(i)||i<0||isNaN(n)||n<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=t,this.left=i,this.right=n}interpolate(t,i,n){return null!=i.top&&null!=t.top&&(this.top=e.ak(t.top,i.top,n)),null!=i.bottom&&null!=t.bottom&&(this.bottom=e.ak(t.bottom,i.bottom,n)),null!=i.left&&null!=t.left&&(this.left=e.ak(t.left,i.left,n)),null!=i.right&&null!=t.right&&(this.right=e.ak(t.right,i.right,n)),this}getCenter(t,i){const n=e.aA((this.left+t-this.right)/2,0,t),r=e.aA((this.top+i-this.bottom)/2,0,i);return new e.P(n,r)}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right}clone(){return new on(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const sn=15;class an{constructor(t,i,n,r,o,s,a){this.tileSize=512,this._renderWorldCopies=void 0===o||o,this._minZoom=t||0,this._maxZoom=i||22,this._minPitch=n??0,this._maxPitch=r??60,this.setProjection(s),this.setMaxBounds(a),this.width=0,this.height=0,this._center=new e.aS(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new on,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new nn,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const e=new an(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return e._elevation=this._elevation,e._centerAltitude=this._centerAltitude,e._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,e.tileSize=this.tileSize,e.mercatorFromTransition=this.mercatorFromTransition,e.width=this.width,e.height=this.height,e.cameraElevationReference=this.cameraElevationReference,e._center=this._center,e._setZoom(this.zoom),e._seaLevelZoom=this._seaLevelZoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._nearZ=this._nearZ,e._farZ=this._farZ,e._averageElevation=this._averageElevation,e._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,e._unmodified=this._unmodified,e._edgeInsets=this._edgeInsets.clone(),e._camera=this._camera.clone(),e._calcMatrices(),e.freezeTileCoverage=this.freezeTileCoverage,e.frustumCorners=this.frustumCorners,e._allowWorldUnderZoom=this._allowWorldUnderZoom,e}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<sn}get elevation(){return this._elevation}set elevation(e){this._elevation!==e&&(this._elevation=e,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(e,t=!1){const i=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||i)&&this._updateCameraOnTerrain(),(e||i)&&this._constrainCamera(t),this._calcMatrices()}getProjection(){return e.aH(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const i=this.projection?this.getProjection():void 0;this.projection=e.cl(this.projectionOptions);const n=this.getProjection(),r=!e.bx(i,n);return r&&this._calcMatrices(),this.mercatorFromTransition=!1,r}setOrthographicProjectionAtLowPitch(e){return this._orthographicProjectionAtLowPitch!==e&&(this._orthographicProjectionAtLowPitch=e,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=e.cl({name:"mercator"});const i=t!==this.projection.name;return i&&this._calcMatrices(),i}get minZoom(){return this._minZoom}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e))}get maxZoom(){return this._maxZoom}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e))}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e))}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(e){void 0===e?e=!0:null===e&&(e=!1),this._renderWorldCopies=e}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get cameraWorldSize(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return e.ce(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new e.P(this.width,this.height)}get bearing(){return e.bS(this.rotation,-180,180)}set bearing(e){this.rotation=e}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const i=-t*Math.PI/180;this.angle!==i&&(this._unmodified=!1,this.angle=i,this._calcMatrices(),this.rotationMatrix=e.cm(),e.cn(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const i=e.aA(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==i&&(this._unmodified=!1,this._pitch=i,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=e.an(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const e=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/e)}get averageElevation(){return this._averageElevation}set averageElevation(e){this._averageElevation=e,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(e){const t=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==t&&(this._unmodified=!1,this._setZoom(t),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(e){this._zoom=e,this.scale=this.zoomScale(e),this.tileZoom=Math.floor(e),this.zoomFraction=e-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(e){this._tileCoverLift!==e&&(this._tileCoverLift=e)}_updateCameraOnTerrain(){const e=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,t=this.elevation&&e===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||e===Number.NEGATIVE_INFINITY&&(!t||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const i=this._elevation;t||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&i.exaggeration()&&this._centerAltitudeValidForExaggeration!==i.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*i.exaggeration(),this._centerAltitudeValidForExaggeration=i.exaggeration()):(this._centerAltitude=e||0,this._centerAltitudeValidForExaggeration=i.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(void 0===this._centerAltitudeValidForExaggeration)return;const e=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(e)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,i=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],n=this.horizonLineFromTop();let r=0,o=0;for(let s=0;s<i.length;s++){const a=new e.P(i[s][0]*this.width,n+i[s][1]*(this.height-n)),l=t.pointCoordinate(a);if(!l)continue;const c=1/Math.hypot(l[0]-this._camera.position[0],l[1]-this._camera.position[1]);r+=l[3]*c,o+=c}return 0===o?NaN:r/o}get center(){return this._center}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const e=this._seaLevelZoom,t=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),i=this.pixelsPerMeter/this.worldSize*t,n=this._mercatorZfromZoom(e),r=this._mercatorZfromZoom(this._maxZoom),o=Math.max(n-i,r);this._setZoom(this._zoomFromMercatorZ(o))}get padding(){return this._edgeInsets.toJSON()}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices())}computeZoomRelativeTo(t){const i=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let n;n=t.z<this._camera.position[2]?[i.x,i.y,i.z]:[t.x,t.y,t.z];const r=e.ag(e.av([],this._camera.position,n));return e.aA(this._zoomFromMercatorZ(r),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height)return;if(!t.position&&!t.orientation)return;this._updateCameraState();let i=!1;if(t.orientation&&!e.co(t.orientation,this._camera.orientation)&&(i=this._setCameraOrientation(t.orientation)),t.position){const n=[t.position.x,t.position.y,t.position.z];e.cp(n,this._camera.position)||(this._setCameraPosition(n),i=!0)}i&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,i=new tn;return i.position=new e.ae(t[0],t[1],t[2]),i.orientation=this._camera.orientation,i._elevation=this.elevation,i._renderWorldCopies=this.renderWorldCopies,i}_setCameraOrientation(t){if(!e.cq(t))return!1;e.cr(t,t);const i=e.cs([],[0,0,-1],t),n=e.cs([],[0,-1,0],t);if(n[2]<0)return!1;const r=en(i,n);return!!r&&(this._camera.orientation=r,!0)}_setCameraPosition(t){const i=this.zoomScale(this.minZoom)*this.tileSize,n=this.zoomScale(this.maxZoom)*this.tileSize,r=this.cameraToCenterDistance;t[2]=e.aA(t[2],r/n,r/i),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(e){return this._edgeInsets.equals(e)}interpolatePadding(e,t,i){this._unmodified=!1,this._edgeInsets.interpolate(e,t,i),this._constrain(),this._calcMatrices()}coveringZoomLevel(e){const t=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,t)}getVisibleUnwrappedCoordinates(t){const i=[new e.ct(0,t)];if(this.renderWorldCopies){const n=this.pointCoordinate(new e.P(0,0)),r=this.pointCoordinate(new e.P(this.width,0)),o=this.pointCoordinate(new e.P(this.width,this.height)),s=this.pointCoordinate(new e.P(0,this.height)),a=Math.floor(Math.min(n.x,r.x,o.x,s.x)),l=Math.floor(Math.max(n.x,r.x,o.x,s.x)),c=1;for(let n=a-c;n<=l+c;n++)0!==n&&i.push(new e.ct(n,t))}return i}isLODDisabled(e){return(!e||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,i,n){let r=[];const o=null!=n,s=!o;if(s&&this.zoom<i)return r;if(o&&0===n[0]&&0===n[1])return r;const a=new Set,l=(t,i,n,o,s)=>{const l=e.cX(i,t,n,o,s);a.has(l)||(r.push(new e.aP(t,i,n,o,s)),a.add(l))};for(let e=0;e<t.length;e++){const r=t[e];if(s&&r.canonical.z!==i)continue;const a=r.canonical,c=r.overscaledZ,u=r.wrap,h=1<<a.z,d=a.x+1<h,p=a.x>0,f=a.y+1<h,m=a.y>0,g=r.wrap-(p?0:1),_=r.wrap+(d?0:1),y=p?a.x-1:h-1,v=d?a.x+1:0;if(o)n[0]<0?(l(c,_,a.z,v,a.y),n[1]<0&&f&&(l(c,u,a.z,a.x,a.y+1),l(c,_,a.z,v,a.y+1)),n[1]>0&&m&&(l(c,u,a.z,a.x,a.y-1),l(c,_,a.z,v,a.y-1))):n[0]>0?(l(c,g,a.z,y,a.y),n[1]<0&&f&&(l(c,u,a.z,a.x,a.y+1),l(c,g,a.z,y,a.y+1)),n[1]>0&&m&&(l(c,u,a.z,a.x,a.y-1),l(c,g,a.z,y,a.y-1))):n[1]<0&&f?l(c,u,a.z,a.x,a.y+1):m&&l(c,u,a.z,a.x,a.y-1);else{const e=r.visibleQuadrants;1&e&&(l(c,g,a.z,y,a.y),m&&(l(c,u,a.z,a.x,a.y-1),l(c,g,a.z,y,a.y-1))),2&e&&(l(c,_,a.z,v,a.y),m&&(l(c,u,a.z,a.x,a.y-1),l(c,_,a.z,v,a.y-1))),4&e&&(l(c,g,a.z,y,a.y),f&&(l(c,u,a.z,a.x,a.y+1),l(c,g,a.z,y,a.y+1))),8&e&&(l(c,_,a.z,v,a.y),f&&(l(c,u,a.z,a.x,a.y+1),l(c,_,a.z,v,a.y+1)))}}const c=[];for(const e of r)r.some((t=>e.isChildOf(t)))||c.push(e);if(r=c.filter((e=>!t.some((t=>!!(e.overscaledZ<i&&t.isChildOf(e))||e.equals(t)||e.isChildOf(t))))),s){const e=1<<i,t="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),n=[e*t.x,e*t.y],o=4,s=o*o;r=r.filter((e=>{const t=e.canonical.x+.5-n[0],i=e.canonical.y+.5-n[1];return t*t+i*i<s}))}return r}extendTileCoverToNearPlane(t,i,n){const r=[],o=new Set;for(const e of t)o.add(e.key);const s=(t,i,n,s,a)=>{const l=e.cX(i,t,n,s,a);o.has(l)||(r.push(new e.aP(t,i,n,s,a)),o.add(l))},a=t.reduce(((e,t)=>Math.max(e,t.overscaledZ)),n),l=1<<n,c=[new e.P(0,0),new e.P(e.al,0),new e.P(e.al,e.al),new e.P(0,e.al)],u=new e.P(0,0),h=new e.P(0,0),d=(t,i)=>{const r=Math.floor(t[0]),o=Math.floor(t[1]),d=(t[0]-r)*e.al,p=(t[1]-o)*e.al,f=Math.floor(i[0]),m=Math.floor(i[1]),g=(i[0]-f)*e.al,_=(i[1]-m)*e.al;for(let t=-1;t<=1;t++){const i=r+t;if(!(i<0||i>=l)){u.x=d-t*e.al,h.x=g-(i-f)*e.al;for(let t=-1;t<=1;t++){const r=o+t;u.y=p-t*e.al,h.y=_-(r-m)*e.al,e.cY(u,h,c)&&s(a,0,n,i,r)}}}},p=i.points,f=p[e.cu],m=p[e.cv],g=this._projectToGround(f,p[e.cw]),_=this._projectToGround(m,p[e.cx]);return d(f,g),d(m,_),r}_projectToGround(t,i){return e.cy(e.cz(),t,i,t[2]/(t[2]-i[2]))}coveringTiles(t){let i=this.coveringZoomLevel(t);const n=i,r=this.elevation&&this.elevation.exaggeration(),o=r&&!t.isTerrainDEM,s="mercator"===this.projection.name;if(void 0!==t.minzoom&&i<t.minzoom)return[];void 0!==t.maxzoom&&i>t.maxzoom&&(i=t.maxzoom);const a=this.locationCoordinate(this.center),l=this.center.lat,c=1<<i,u=[c*a.x,c*a.y,0],h="globe"===this.projection.name,d=!h,p=e.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,i,d),f=h?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),m=c*e.ce(1,this.center.lat),g=this._camera.position[2]/e.ce(1,this.center.lat),_=[c*f.x,c*f.y,g*(d?1:m)],y=h||r,v=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),x=this.isLODDisabled(!0)?i:0;let b;if(this._elevation&&t.isTerrainDEM)b=1e4*this._elevation.exaggeration();else if(this._elevation){const e=this._elevation.getMinMaxForVisibleTiles();b=e?e.max:this._centerAltitude}else b=this._centerAltitude;const T=t.isTerrainDEM?-b:this._elevation?this._elevation.getMinElevationBelowMSL():0,w=this.projection.isReprojectedInTileSpace?e.cB(this):1,E=t=>{const i=1/4e4,n=new e.ae(t.x+i,t.y,t.z),r=new e.ae(t.x,t.y+i,t.z),o=t.toLngLat(),s=n.toLngLat(),a=r.toLngLat(),l=this.locationCoordinate(o),c=this.locationCoordinate(s),u=this.locationCoordinate(a),h=Math.hypot(c.x-l.x,c.y-l.y),d=Math.hypot(u.x-l.x,u.y-l.y);return Math.sqrt(h*d)*w/i},S=t=>{const i=b,n=T;return{aabb:e.cE(this,c,0,0,0,t,n,i,this.projection),zoom:0,x:0,y:0,minZ:n,maxZ:i,wrap:t,fullyVisible:!1}},A=[];let M=[];const I=i,C=t.reparseOverscaled?n:i,P=(g-this._centerAltitude)*m,L=e=>{if(!this._elevation||!e.tileID||!s)return;const t=this._elevation.getMinMaxForTile(e.tileID),i=e.aabb;t?(i.min[2]=t.min,i.max[2]=t.max,i.center[2]=(i.min[2]+i.max[2])/2):(e.shouldSplit=O(e),e.shouldSplit||(i.min[2]=i.max[2]=i.center[2]=this._centerAltitude))},R=(e,t)=>{if(.707*t<e)return 1;const i=t/e;return i/(1.4144271570014144+(Math.pow(1.1,i-1.4144271570014144+1)-1)/(1.1-1)-1)},O=t=>{if(t.zoom<x)return!0;if(t.zoom===I)return!1;if(null!=t.shouldSplit)return t.shouldSplit;const i=t.aabb.distanceX(_),r=t.aabb.distanceY(_);let a=P,c=1;if(h){a=t.aabb.distanceZ(_);const i=Math.pow(2,t.zoom),n=e.a_((t.y+1)/i),r=e.a_(t.y/i),o=Math.min(Math.max(l,n),r),s=e.d0(o)/e.d0(l);if(c=o===l?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,s/this._mercatorScaleRatio),this.zoom<=e.cZ&&t.zoom===I-1&&s>=.9)return!0}else if(o&&(a=t.aabb.distanceZ(_)*m),this.projection.isReprojectedInTileSpace&&n<=5){const i=Math.pow(2,t.zoom),n=E(new e.ae((t.x+.5)/i,(t.y+.5)/i));c=n>.85?1:n}if(!s&&!h){const e=Math.sqrt(i*i+r*r+a*a);let n=(1<<I-t.zoom)*v*c;return n*=R(Math.max(a,P),e),e<n}let d=Number.MAX_VALUE,p=0;const f=t.aabb.getCorners(),g=[];for(const t of f){e.av(g,t,_),h||(o?g[2]*=m:g[2]=P);const i=e.bI(g,this._camera.forward());i<d&&(d=i,p=Math.abs(g[2]))}let y=(1<<I-t.zoom)*v*c;if(y*=R(Math.max(p,P),d),d<y)return!0;const b=t.aabb.closestPoint(u);return b[0]===u[0]&&b[1]===u[1]};if(this.renderWorldCopies)for(let e=1;e<=3;e++)A.push(S(-e)),A.push(S(e));for(A.push(S(0));A.length>0;){const n=A.pop(),r=n.x,a=n.y;let l=n.fullyVisible;const d=()=>"globe"===this.projection.name&&(0===n.y||n.y===(1<<n.zoom)-1);if(!l){let t=y?n.aabb.intersects(p):n.aabb.intersectsFlat(p);if(0===t&&d()){const i=new e.cC(n.zoom,r,a);t=e.cD(this,c,i,!0).intersects(p)}if(0===t)continue;l=2===t}if(n.zoom!==I&&O(n))for(let t=0;t<4;t++){const i=(r<<1)+t%2,u=(a<<1)+(t>>1),d={aabb:s?n.aabb.quadrant(t):e.cE(this,c,n.zoom+1,i,u,n.wrap,n.minZ,n.maxZ,this.projection),zoom:n.zoom+1,x:i,y:u,wrap:n.wrap,fullyVisible:l,tileID:void 0,shouldSplit:void 0,minZ:n.minZ,maxZ:n.maxZ};o&&!h&&(d.tileID=new e.aP(n.zoom+1===I?C:n.zoom+1,n.wrap,n.zoom+1,i,u),L(d)),A.push(d)}else{const o=n.zoom===I?C:n.zoom;if(t.minzoom&&t.minzoom>o)continue;let s=0;if(!l){let i=y?n.aabb.intersectsPrecise(p):n.aabb.intersectsPreciseFlat(p);if(0===i&&d()){const t=new e.cC(n.zoom,r,a);i=e.cD(this,c,t,!0).intersectsPrecise(p)}if(0===i)continue;if(t.calculateQuadrantVisibility)if(p.containsPoint(n.aabb.center))s=15;else for(let e=0;e<4;e++)0!==n.aabb.quadrant(e).intersects(p)&&(s|=1<<e)}const h=u[0]-(.5+r+(n.wrap<<n.zoom))*(1<<i-n.zoom),f=u[1]-.5-a,m=n.tileID?n.tileID:new e.aP(o,n.wrap,n.zoom,r,a);t.calculateQuadrantVisibility&&(m.visibleQuadrants=s),M.push({tileID:m,distanceSq:h*h+f*f})}}if(this.fogCullDistSq){const i=this.fogCullDistSq,n=this.horizonLineFromTop();M=M.filter((r=>{const o=[0,0,0,1],s=[e.al,e.al,0,1],a=this.calculateFogTileMatrix(r.tileID.toUnwrapped());e.aC(o,o,a),e.aC(s,s,a);const l=e.cF([],o,s),c=e.cG([],o,s),u=e.c_(l,c);if(0===u)return!0;let h=!1;const d=this._elevation;if(d&&u>i&&0!==n){const i=this.calculateProjMatrix(r.tileID.toUnwrapped());let o;t.isTerrainDEM||(o=d.getMinMaxForTile(r.tileID)),o||(o={min:T,max:b});const s=e.cH(this.rotation),a=[s[0]*e.al,s[1]*e.al,o.max];e.af(a,a,i),h=(1-a[1])*this.height*.5<n}return u<i||h}))}return M.sort(((e,t)=>e.distanceSq-t.distanceSq)).map((e=>e.tileID))}resize(e,t){this.width=e,this.height=t,this.pixelsToGLUnits=[2/e,-2/t],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(e){return Math.pow(2,e)}scaleZoom(e){return Math.log2(e)}project(t){const i=e.aA(t.lat,-e.cI,e.cI),n=this.projection.project(t.lng,i);return new e.P(n.x*this.worldSize,n.y*this.worldSize)}unproject(e){return this.projection.unproject(e.x/this.worldSize,e.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/e.ce(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,i){let n,r;const o=this.centerPoint;if("globe"===this.projection.name){const e=this.worldSize;n=(i.x-o.x)/e,r=(i.y-o.y)/e}else{const e=this.pointCoordinate(i),t=this.pointCoordinate(o);n=e.x-t.x,r=e.y-t.y}const s=this.locationCoordinate(t);this.setLocation(new e.ae(s.x-n,s.y-r))}setLocation(e){this.center=this.coordinateLocation(e),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(e,t){return this.projection.locationPoint(this,e,t)}locationPoint3D(e,t){return this.projection.locationPoint(this,e,t,!0)}pointLocation(e){return this.coordinateLocation(this.pointCoordinate(e))}pointLocation3D(e,t){return this.coordinateLocation(this.pointCoordinate3D(e,t))}locationCoordinate(t,i){const n=i?e.ce(i,t.lat):void 0,r=this.projection.project(t.lng,t.lat);return new e.ae(r.x,r.y,n)}coordinateLocation(e){return this.projection.unproject(e.x,e.y)}pointRayIntersection(t,i){const n=null!=i?i:this._centerAltitude,r=[t.x,t.y,0,1],o=[t.x,t.y,1,1];e.aC(r,r,this.pixelMatrixInverse),e.aC(o,o,this.pixelMatrixInverse);const s=o[3];e.cJ(r,r,1/r[3]),e.cJ(o,o,1/s);const a=r[2],l=o[2];return{p0:r,p1:o,t:a===l?0:(n-a)/(l-a)}}screenPointToMercatorRay(t){const i=[t.x,t.y,0,1],n=[t.x,t.y,1,1];return e.aC(i,i,this.pixelMatrixInverse),e.aC(n,n,this.pixelMatrixInverse),e.cJ(i,i,1/i[3]),e.cJ(n,n,1/n[3]),i[2]=e.ce(i[2],this._center.lat)*this.worldSize,n[2]=e.ce(n[2],this._center.lat)*this.worldSize,e.cJ(i,i,1/this.worldSize),e.cJ(n,n,1/this.worldSize),new e.ax([i[0],i[1],i[2]],e.aw([],e.av([],n,i)))}rayIntersectionCoordinate(t){const{p0:i,p1:n,t:r}=t,o=e.ce(i[2],this._center.lat),s=e.ce(n[2],this._center.lat);return new e.ae(e.ak(i[0],n[0],r)/this.worldSize,e.ak(i[1],n[1],r)/this.worldSize,e.ak(o,s,r))}pointCoordinate(e,t=this._centerAltitude){return this.projection.pointCoordinate(this,e.x,e.y,t)}pointCoordinate3D(t,i){if(!this.elevation)return this.pointCoordinate(t,i);let n=this.projection.pointCoordinate3D(this,t.x,t.y);if(n)return new e.ae(n[0],n[1],n[2]);let r=0,o=this.horizonLineFromTop();if(t.y>o)return this.pointCoordinate(t,i);const s=.02*o,a=t.clone();for(let t=0;t<10&&o-r>s;t++){a.y=e.ak(r,o,.66);const t=this.projection.pointCoordinate3D(this,a.x,a.y);t?(o=a.y,n=t):r=a.y}return n?new e.ae(n[0],n[1],n[2]):this.pointCoordinate(t)}isPointAboveHorizon(e){return this.projection.isPointAboveHorizon(this,e)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=e.cK)return!this.isPointAboveHorizon(t);const i=this.pointCoordinate(t);return i.y>=0&&i.y<=1}_coordinatePoint(t,i){const n=i&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,r=[t.x*this.worldSize,t.y*this.worldSize,n+t.toAltitude(),1];return e.aC(r,r,this.pixelMatrix),r[3]>0?new e.P(r[0]/r[3],r[1]/r[3]):new e.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:i}=this._edgeInsets,n=this.height-this._edgeInsets.bottom,r=this.width-this._edgeInsets.right,o=this.pointLocation3D(new e.P(i,t)),s=this.pointLocation3D(new e.P(r,t)),a=this.pointLocation3D(new e.P(r,n)),l=this.pointLocation3D(new e.P(i,n));let c=Math.min(o.lng,s.lng,a.lng,l.lng),u=Math.max(o.lng,s.lng,a.lng,l.lng),h=Math.min(o.lat,s.lat,a.lat,l.lat),d=Math.max(o.lat,s.lat,a.lat,l.lat);const p=Math.pow(2,-this.zoom)/16*270,f="globe"===this.projection.name?1:4,m=(t,i,n,r,o)=>{const s=(t+n)/2,a=(i+r)/2,l=new e.P(s,a),{lng:g,lat:_}=this.pointLocation3D(l),y=Math.max(0,c-g,h-_,g-u,_-d);c=Math.min(c,g),u=Math.max(u,g),h=Math.min(h,_),d=Math.max(d,_),(o<f||y>p)&&(m(t,i,s,a,o+1),m(s,a,n,r,o+1))};if(m(i,t,r,t,1),m(r,t,r,n,1),m(r,n,i,n,1),m(i,n,i,t,1),"globe"===this.projection.name){const[t,i]=e.cL(this);t?(d=90,u=180,c=-180):i&&(h=-90,u=180,c=-180)}return new e.aI(new e.aS(c,h),new e.aS(u,d))}_getBoundsRectangular(t,i){const{top:n,left:r}=this._edgeInsets,o=this.height-this._edgeInsets.bottom,s=this.width-this._edgeInsets.right,a=new e.P(r,n),l=new e.P(s,n),c=new e.P(s,o),u=new e.P(r,o);let h=this.pointCoordinate(a,t),d=this.pointCoordinate(l,t);const p=this.pointCoordinate(c,i),f=this.pointCoordinate(u,i),m=(e,t)=>(t.y-e.y)/(t.x-e.x);return h.y>1&&d.y>=0?h=new e.ae((1-f.y)/m(f,h)+f.x,1):h.y<0&&d.y<=1&&(h=new e.ae(-f.y/m(f,h)+f.x,0)),d.y>1&&h.y>=0?d=new e.ae((1-p.y)/m(p,d)+p.x,1):d.y<0&&h.y<=1&&(d=new e.ae(-p.y/m(p,d)+p.x,0)),(new e.aI).extend(this.coordinateLocation(h)).extend(this.coordinateLocation(d)).extend(this.coordinateLocation(f)).extend(this.coordinateLocation(p))}_getBoundsRectangularTerrain(){const e=this.elevation;if(!e.visibleDemTiles.length||e.isUsingMockSource())return this._getBoundsRectangular(0,0);const t=e.visibleDemTiles.reduce(((e,t)=>{if(t.dem){const i=t.dem.tree;e.min=Math.min(e.min,i.minimums[0]),e.max=Math.max(e.max,i.maximums[0])}return e}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(t.min*e.exaggeration(),t.max*e.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(e=!0){const t=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,i=this.height/2-t*(1-this._horizonShift);return e?Math.max(0,i):i}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-e.cI,this.maxLat=e.cI,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=e.aF(this.minLng)*this.tileSize,this.worldMaxX=e.aF(this.maxLng)*this.tileSize,this.worldMinY=e.aJ(this.maxLat)*this.tileSize,this.worldMaxY=e.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(e,t){return this.projection.createTileMatrix(this,t,e)}calculateDistanceTileData(t){const i=t.key,n=this._distanceTileDataCache;if(n[i])return n[i];const r=t.canonical,o=1/this.height,s=this.cameraWorldSize,a=s/this.zoomScale(r.z),l=(r.x+Math.pow(2,r.z)*t.wrap)*a,c=r.y*a,u=this.point;u.x*=s/this.worldSize,u.y*=s/this.worldSize;const h=this.angle,d=Math.sin(-h),p=-Math.cos(-h);return n[i]={bearing:[d,p],center:[(u.x-l)*o,(u.y-c)*o],scale:a/e.al*o},n[i]}calculateFogTileMatrix(t){const i=t.key,n=this._fogTileMatrixCache;if(n[i])return n[i];const r=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return e.aB(r,this.worldToFogMatrix,r),n[i]=new Float32Array(r),n[i]}calculateProjMatrix(t,i=!1,n=!1){const r=t.key;let o;if(o=n?this._expandedProjMatrixCache:i?this._alignedProjMatrixCache:this._projMatrixCache,o[r])return o[r];const s=this.calculatePosMatrix(t,this.worldSize);let a;return a=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:n?this.expandedFarZProjMatrix:i?this.alignedProjMatrix:this.projMatrix,e.aB(s,a,s),o[r]=new Float32Array(s),o[r]}calculatePixelsToTileUnitsMatrix(t){const i=t.tileID.key,n=this._pixelsToTileUnitsCache;if(n[i])return n[i];const r=e.cM(t,this);return n[i]=r,n[i]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const t=1/this.worldSize,i=e.bp([],[t,t,t]);return e.aB(i,i,this.globeMatrix),i}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const t=this._elevation;this._updateCameraState();const i=e.ce(1,this._center.lat)*this.worldSize,n=this._computeCameraPosition(i),r=this._camera.forward(),o=e.ce(1,this._center.lat);n[2]/=o,r[2]/=o,e.aw(r,r);const s=t.raycast(n,r,t.exaggeration());if(s){const t=e.bG([],n,r,s),i=new e.ae(t[0],t[1],e.ce(t[2],e.a_(t[1]))),a=(i.z+e.ag([i.x-n[0],i.y-n[1],i.z-n[2]*o]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(a),this._centerAltitude=i.toAltitude(),this._center=this.coordinateLocation(i),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const i=this._elevation,n=e.ce(1,this._center.lat)*this.worldSize,r=this._computeCameraPosition(n),o=i.getAtPointOrZero(new e.ae(...r)),s=this.pixelsPerMeter/this.worldSize*o,a=this._minimumHeightOverTerrain(),l=r[2]-s;if(l<=a)if(l<0||t){const t=this.locationCoordinate(this._center,this._centerAltitude),i=[r[0],r[1],t.z-r[2]],n=e.ag(i);i[2]-=(a-l)/this._pixelsPerMercatorPixel;const o=e.ag(i);if(0===o)return;e.c4(i,i,n/o*this._pixelsPerMercatorPixel),this._camera.position=[r[0],r[1],t.z*this._pixelsPerMercatorPixel-i[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const i=this.center;return i.lat=e.aA(i.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(i.lng=e.aA(i.lng,this.minLng,this.maxLng)),this.center=i,void(this._constraining=!1)}const i=this._unmodified,{x:n,y:r}=this.point;let o=0,s=n,a=r;const l=this.width/2,c=this.height/2,u=this.worldMinY*this.scale,h=this.worldMaxY*this.scale;if(r-c<u&&(a=u+c),r+c>h&&(a=h-c),h-u<this.height&&(o=Math.max(o,this.height/(h-u)),a=(h+u)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const e=this.worldMinX*this.scale,t=this.worldMaxX*this.scale,i=this.worldSize/2-(e+t)/2;s=(n+i+this.worldSize)%this.worldSize-i,s-l<e&&(s=e+l),s+l>t&&(s=t-l),t-e<this.width&&(o=Math.max(o,this.width/(t-e)),s=(t+e)/2)}s===n&&a===r||this._allowWorldUnderZoom||(this.center=this.unproject(new e.P(s,a))),o&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(o)),this._constrainCamera(),this._unmodified=i,this._constraining=!1}_minZoomForBounds(){let e=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(e=Math.max(e,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),e}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,i="globe"===this.projection.name,n=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=e.ce(1,this.center.lat)/e.ce(1,e.d1));const r=e.cN(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,r),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const o="meters"===this.projection.zAxisUnit?n:1,s=this._camera.getWorldToCamera(this.worldSize,o);let a;const l=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(l[8]=2*-t.x/this.width,l[9]=2*t.y/this.height,this.isOrthographic){let i=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),n=i*this.aspect,r=-n,o=-i;n-=t.x,r-=t.x,i+=t.y,o+=t.y,a=this._camera.getCameraToClipOrthographic(r,n,o,i,this._nearZ,this._farZ),((t,i,n,r)=>{for(let o=0;o<16;o++)t[o]=e.ak(i[o],n[o],r)})(a,a,l,e.c$(this.pitch>=sn?1:this.pitch/sn))}else a=l;const c=e.cO([],l,s);let u=e.cO([],a,s);if(this.projection.isReprojectedInTileSpace){const t=this.locationCoordinate(this.center),i=e.bz([]);e.bq(i,i,[t.x*this.worldSize,t.y*this.worldSize,0]),e.aB(i,i,e.cP(this)),e.bq(i,i,[-t.x*this.worldSize,-t.y*this.worldSize,0]),e.aB(u,u,i),e.aB(c,c,i),this.inverseAdjustmentMatrix=e.cQ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=e.cR([],u,[this.worldSize,this.worldSize,this.worldSize/o,1]),this.projMatrix=u,this.invProjMatrix=e.bk(new Float64Array(16),this.projMatrix),i){const i=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);i[8]=2*-t.x/this.width,i[9]=2*t.y/this.height,this.expandedFarZProjMatrix=e.cO([],i,s)}else this.expandedFarZProjMatrix=this.projMatrix;const h=e.bk([],a);this.frustumCorners=e.cS.fromInvProjectionMatrix(h,this.horizonLineFromTop(),this.height),this.cameraFrustum=e.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!i);const d=new Float32Array(16);e.bz(d),e.cR(d,d,[1,-1,1]),e.cT(d,d,this._pitch),e.bA(d,d,this.angle);const p=e.cc(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=e.by(p);const f=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;p[8]=2*-t.x/this.width,p[9]=2*(t.y+f)/this.height,this.skyboxMatrix=e.aB(d,p,d);const m=this.point,g=m.x,_=m.y,y=this.width%2/2,v=this.height%2/2,x=Math.cos(this.angle),b=Math.sin(this.angle),T=g-Math.round(g)+x*y+b*v,w=_-Math.round(_)+x*v+b*y,E=new Float64Array(u);if(e.bq(E,E,[T>.5?T-1:T,w>.5?w-1:w,0]),this.alignedProjMatrix=E,u=e.bB(),e.cR(u,u,[this.width/2,-this.height/2,1]),e.bq(u,u,[1,-1,0]),this.labelPlaneMatrix=u,u=e.bB(),e.cR(u,u,[1,-1,1]),e.bq(u,u,[-1,-1,0]),e.cR(u,u,[2/this.width,2/this.height,1]),this.glCoordMatrix=u,this.pixelMatrix=e.aB(new Float64Array(16),this.labelPlaneMatrix,c),this._calcFogMatrices(),this._distanceTileDataCache={},u=e.bk(new Float64Array(16),this.pixelMatrix),!u)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=u,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=e.cU(this);const t=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=e.af(t,t,s),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=u;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,i=this.cameraPixelsPerMeter,n=this._camera.position,r=1/this.height/this._pixelsPerMercatorPixel,o=[t,t,i];e.c4(o,o,r),e.c4(n,n,-1),e.cV(n,n,o);const s=e.bB();e.bq(s,s,n),e.cR(s,s,o),this.mercatorFogMatrix=s,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,i,r)}_computeCameraPosition(e){const t=(e=e||this.pixelsPerMeter)/this.pixelsPerMeter,i=this._camera.forward(),n=this.point,r=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*t-e/this.worldSize*this._centerAltitude;return[n.x/this.worldSize-i[0]*r,n.y/this.worldSize-i[1]*r,e/this.worldSize*this._centerAltitude-i[2]*r]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const i=this._maxCameraBoundsDistance()*Math.cos(this._pitch),n=this._camera.position[2],r=t[2];let o=1;this.projection.wrap&&(this.center=this.center.wrap()),r>0&&(o=Math.min((i-n)/r,1)),this._camera.position=e.bG([],this._camera.position,t,o),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,i=this._camera.forward(),{pitch:n,bearing:r}=this._camera.getPitchBearing(),o=e.ce(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,s=this._mercatorZfromZoom(this._maxZoom)*Math.cos(e.an(this._maxPitch)),a=Math.max((t[2]-o)/Math.cos(n),s),l=this._zoomFromMercatorZ(a);e.bG(t,t,i,a),this._pitch=e.aA(n,e.an(this.minPitch),e.an(this.maxPitch)),this.angle=e.bS(r,-Math.PI,Math.PI),this._setZoom(e.aA(l,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new e.ae(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(e){return Math.pow(2,e)*this.tileSize}_mercatorZfromZoom(e){return this.cameraToCenterDistance/this._worldSizeFromZoom(e)}_minimumHeightOverTerrain(){const e=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(e)}_zoomFromMercatorZ(e){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,e)*this.tileSize))}zoomFromMercatorZAdjusted(t){let i=0,n=e.cK,r=0,o=1/0;for(;n-i>1e-6&&n>i;){const e=i+.5*(n-i),s=this.tileSize*Math.pow(2,e),a=this.getCameraToCenterDistance(this.projection,e,s),l=this.scaleZoom(a/(Math.max(0,t)*this.tileSize)),c=Math.abs(e-l);c<o&&(o=c,r=e),e<l?i=e:n=e}return r}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(e.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,i){const n=Math.min(t.x,i.x),r=Math.max(t.x,i.x),o=Math.min(t.y,i.y),s=Math.max(t.y,i.y);if(o<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const a=[new e.P(n,o),new e.P(r,s),new e.P(n,s),new e.P(r,o)],l=this.renderWorldCopies?-3:0,c=this.renderWorldCopies?4:1;for(const e of a){const t=this.pointRayIntersection(e);if(t.t<0)return!0;const i=this.rayIntersectionCoordinate(t);if(i.x<l||i.y<0||i.x>c||i.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+e.cW(this.fovAboveCenter)>88||this.anyCornerOffEdge(new e.P(0,0),new e.P(this.width,this.height))}zoomDeltaToMovement(t,i){const n=e.ag(e.av([],this._camera.position,t)),r=this._zoomFromMercatorZ(n)+i;return n-this._mercatorZfromZoom(r)}getCameraPoint(){if("globe"===this.projection.name){const t=function([t,i,n],r){const o=[t,i,n,1];e.aC(o,o,r);const s=o[3]=Math.max(o[3],1e-6);return o[0]/=s,o[1]/=s,o[2]/=s,o}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new e.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new e.P(0,t))}}getCameraToCenterDistance(t,i=this.zoom,n=this.worldSize){const r=e.cN(t,i,this.width,this.height,1024),o=t.pixelSpaceConversion(this.center.lat,n,r);let s=.5/Math.tan(.5*this._fov)*this.height*o;return this.isOrthographic&&(s=e.ak(1,s,e.c$(this.pitch>=sn?1:this.pitch/sn))),s}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&e.aB(t,t,this.globeMatrix),t}getFrustum(t){return e.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,"meters"===this.projection.zAxisUnit)}}const ln=(t,i)=>{if(i>0&&t.terrain&&e.w("Cutoff is currently disabled on terrain"),i<=0||t.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const n=t.transform,r=Math.max(Math.abs(n._zoom-(t.minCutoffZoom-1)),1),o=n.isLODDisabled(!1)?e.ah(60,45,n.pitch):e.ah(30,15,n.pitch),s=n._farZ-n._nearZ,a=i*n.height,l=((1-(c=o))*n.cameraToCenterDistance+c*(n._farZ+a))*r;var c;return{shouldRenderCutoff:o<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(l-n._nearZ)/s,(l-a-n._nearZ)/s]}}},cn={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class un{constructor(e,t){this.aabb=e,this.lastCascade=t}}class hn{add(e,t){const i=this.receivers[e.key];void 0!==i?(i.aabb.min[0]=Math.min(i.aabb.min[0],t.min[0]),i.aabb.min[1]=Math.min(i.aabb.min[1],t.min[1]),i.aabb.min[2]=Math.min(i.aabb.min[2],t.min[2]),i.aabb.max[0]=Math.max(i.aabb.max[0],t.max[0]),i.aabb.max[1]=Math.max(i.aabb.max[1],t.max[1]),i.aabb.max[2]=Math.max(i.aabb.max[2],t.max[2])):this.receivers[e.key]=new un(t,null)}clear(){this.receivers={}}get(e){return this.receivers[e.key]}computeRequiredCascades(t,i,n){const r=e.d8.fromPoints(t.points);let o=0;for(const t in this.receivers){const s=this.receivers[t];if(!s)continue;if(!r.intersectsAabb(s.aabb))continue;s.aabb.min=r.closestPoint(s.aabb.min),s.aabb.max=r.closestPoint(s.aabb.max);const a=s.aabb.getCorners();for(let t=0;t<n.length;t++){let r=!0;for(const o of a){const s=[o[0]*i,o[1]*i,o[2]];if(e.af(s,s,n[t].matrix),s[0]<-1||s[0]>1||s[1]<-1||s[1]>1){r=!1;break}}if(s.lastCascade=t,o=Math.max(o,t),r)break}}return o+1}}class dn{constructor(e){this.painter=e,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new hn,this._depthMode=new Wi(e.context.gl.LEQUAL,Wi.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,e.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),e.tp.registerParameter(cn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),e.tp.registerParameter(cn,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),e.tp.registerParameter(cn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),e.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const e of this._cascades)e.texture.destroy(),e.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,i){const n=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!i||!i.properties)return;const r=i.properties.get("shadow-intensity");if(!i.shadowsEnabled()||r<=0)return;if(this._shadowLayerCount=n.style.order.reduce(((e,i)=>{const r=n.style._mergedLayers[i];return e+(r.hasShadowPass()&&!r.isHidden(t.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled)return;const o=n.context,s=cn.shadowMapResolution,a=cn.shadowMapResolution;if(0===this._cascades.length||cn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let t=0;t<cn.cascadeCount;++t){const t=n._shadowMapDebug,i=o.gl,r=o.createFramebuffer(s,a,t,"texture"),l=new e.T(o,{width:s,height:a,data:null},i.DEPTH_COMPONENT16);if(r.depthAttachment.set(l.texture),t){const t=new e.T(o,{width:s,height:a,data:null},i.RGBA8);r.colorAttachment.set(t.texture)}this._cascades.push({framebuffer:r,texture:l,matrix:[],far:0,boundingSphereRadius:0,frustum:new e.cA,scale:0})}}this.shadowDirection=fn(i);let l=0;if(t.elevation){const e=t.elevation,i=[1e4,-1e4];e.visibleDemTiles.filter((e=>e.dem)).forEach((e=>{const t=e.dem.tree;i[0]=Math.min(i[0],t.minimums[0]),i[1]=Math.max(i[1],t.maximums[0])})),1e4!==i[0]&&(l=(i[1]-i[0])*e.exaggeration())}const c=1.5*t.cameraToCenterDistance,u=3*c,h=new Float64Array(16);for(let i=0;i<this._cascades.length;++i){const n=this._cascades[i];let r=t.height/50,o=1;1===cn.cascadeCount?o=u:0===i?o=c:(r=c,o=u);const[s,a]=gn(t,this.shadowDirection,r,o,cn.shadowMapResolution,l);n.scale=t.scale,n.matrix=s,n.boundingSphereRadius=a,e.bk(h,n.matrix),n.frustum=e.cA.fromInvProjectionMatrix(h,1,0,!0),n.far=o}const d=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[d].far,this._cascades[d].far],this._uniformValues.u_shadow_intensity=r,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/cn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=cn.shadowMapResolution,this._uniformValues.u_shadowmap_0=rn.ShadowMap0,this._uniformValues.u_shadowmap_1=rn.ShadowMap0+1,this._groundShadowTiles=n.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const p=n.transform.elevation;for(const e of this._groundShadowTiles){let t={min:0,max:0};if(p){const i=p.getMinMaxForTile(e);i&&(t=i)}this.addShadowReceiver(e.toUnwrapped(),t.min,t.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(e){this._enabled=e}drawShadowPass(t,i){if(!this.enabled)return;const n=this.painter,r=n.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(n.transform.getFrustum(0),n.transform.worldSize,this._cascades),r.viewport.set([0,0,cn.shadowMapResolution,cn.shadowMapResolution]);for(let o=0;o<this._numCascadesToRender;++o){n.currentShadowCascade=o,r.bindFramebuffer.set(this._cascades[o].framebuffer.framebuffer),r.clear({color:e.ao.white,depth:1});for(const e of t.order){const r=t._mergedLayers[e];if(!r.hasShadowPass()||r.isHidden(n.transform.zoom))continue;const o=t.getLayerSourceCache(r),s=o?i[o.id]:void 0;("model"===r.type||s&&s.length)&&n.renderLayer(n,o,r,s)}}n.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const e=this.painter,t=e.style,i=e.context,n=i.gl,r=t.directionalLight,o=t.ambientLight;if(!r||!o)return;const s=[],a=ln(e,e.longestCutoffRange);a.shouldRenderCutoff&&s.push("RENDER_CUTOFF"),s.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&s.push("NORMAL_OFFSET");const l=mn(t,r,o),c=new Wi(n.LEQUAL,Wi.ReadOnly,e.depthRangeFor3D),u=new Xi({func:n.EQUAL,mask:255},0,255,n.KEEP,n.KEEP,n.KEEP);for(const t of this._groundShadowTiles){const r=t.toUnwrapped(),o=e.isTileAffectedByFog(t),h=e.getOrCreateProgram("groundShadow",{defines:s,overrideFog:o});this.setupShadows(r,h),e.uploadCommonUniforms(i,h,r,null,a);const d={u_matrix:e.transform.calculateProjMatrix(r),u_ground_shadow_factor:l};h.draw(e,n.TRIANGLES,c,u,$i.multiply,Ji.disabled,d,"ground_shadow",e.tileExtentBuffer,e.quadTriangleIndexBuffer,e.tileExtentSegments,null,e.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?$i.unblended:$i.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const i=this.painter.transform,n=i.calculatePosMatrix(t,i.worldSize);return e.aB(n,this._cascades[this.painter.currentShadowCascade].matrix,n),Float32Array.from(n)}calculateShadowPassMatrixFromMatrix(t){const i=e.by(t);return e.aB(i,this._cascades[this.painter.currentShadowCascade].matrix,t),i}setupShadows(t,i,n){if(!this.enabled)return;const r=this.painter.transform,o=this.painter.context,s=o.gl,a=this._uniformValues,l=new Float64Array(16),c=r.calculatePosMatrix(t,r.worldSize);for(let t=0;t<this._cascades.length;t++)e.aB(l,this._cascades[t].matrix,c),a[0===t?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(l),o.activeTexture.set(s.TEXTURE0+rn.ShadowMap0+t),this._cascades[t].texture.bindExtraParam(s.LINEAR,s.LINEAR,s.CLAMP_TO_EDGE,s.CLAMP_TO_EDGE,s.GREATER);if(this.useNormalOffset=!!n,this.useNormalOffset){const i=e.d6(t.canonical),o=2/r.tileSize*e.al/cn.shadowMapResolution,s=o*this._cascades[0].boundingSphereRadius,l=o*this._cascades[this._cascades.length-1].boundingSphereRadius,c=("vector-tile"===n?1:3)*function(t){const i=e.aA((t-22)/-22,0,1);return.125*(1-i)+4*i}(r.zoom);a.u_shadow_normal_offset=[i,s*c,l*c],a.u_shadow_bias=[1e-4,.0012,.012]}else a.u_shadow_bias=[36e-5,.0012,.012];i.setShadowUniformValues(o,a)}setupShadowsFromMatrix(t,i,n=!1){if(!this.enabled)return;const r=this.painter.context,o=r.gl,s=this._uniformValues,a=new Float64Array(16);for(let i=0;i<cn.cascadeCount;i++)e.aB(a,this._cascades[i].matrix,t),s[0===i?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(a),r.activeTexture.set(o.TEXTURE0+rn.ShadowMap0+i),this._cascades[i].texture.bindExtraParam(o.LINEAR,o.LINEAR,o.CLAMP_TO_EDGE,o.CLAMP_TO_EDGE,o.GREATER);if(this.useNormalOffset=n,n){const e=cn.normalOffset;s.u_shadow_normal_offset=[1,e,e],s.u_shadow_bias=[6e-5,.0012,.012]}else s.u_shadow_bias=[36e-5,.0012,.012];i.setShadowUniformValues(r,s)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,i,n,r){if(r[2]>=0)return{};const o=function(t,i,n){const r=n/(1<<t.canonical.z);return new e.d8([t.canonical.x*r+t.wrap*n,t.canonical.y*r+t.wrap*n,0],[(t.canonical.x+1)*r+t.wrap*n,(t.canonical.y+1)*r+t.wrap*n,i])}(t,i,n).getCorners(),s=i/-r[2];r[0]<0?(e.d7(o[0],o[0],[r[0]*s,0,0]),e.d7(o[3],o[3],[r[0]*s,0,0])):r[0]>0&&(e.d7(o[1],o[1],[r[0]*s,0,0]),e.d7(o[2],o[2],[r[0]*s,0,0])),r[1]<0?(e.d7(o[0],o[0],[0,r[1]*s,0]),e.d7(o[1],o[1],[0,r[1]*s,0])):r[1]>0&&(e.d7(o[2],o[2],[0,r[1]*s,0]),e.d7(o[3],o[3],[0,r[1]*s,0]));const a={};return a.vertices=o,a.planes=[pn(o[1],o[0],o[4]),pn(o[2],o[1],o[5]),pn(o[3],o[2],o[6]),pn(o[0],o[3],o[7])],a}addShadowReceiver(t,i,n){this._receivers.add(t,e.d8.fromTileIdAndHeight(t,i,n))}getMaxCascadeForTile(e){const t=this._receivers.get(e);return t&&t.lastCascade?t.lastCascade:0}}function pn(t,i,n){const r=e.av([],n,i),o=e.av([],t,i),s=e.bH([],r,o),a=e.ag(s);return 0===a?[0,0,1,0]:(e.c4(s,s,1/a),[s[0],s[1],s[2],-e.bI(s,i)])}function fn(t){const i=t.properties.get("direction"),n=e.d3(i.x,i.y,i.z);n[2]=e.aA(n[2],0,75);const r=e.d5([n[0],n[1],n[2]]);return e.d4(r.x,r.y,r.z)}function mn(t,i,n){const r="none"===i.properties.get("color-use-theme"),o=i.properties.get("color"),s=i.properties.get("intensity"),a=i.properties.get("direction"),l=[a.x,a.y,a.z],c="none"===n.properties.get("color-use-theme"),u=n.properties.get("color"),h=n.properties.get("intensity"),d=Math.max(e.bI([0,0,1],l),0),p=[0,0,0];e.c4(p,u.toPremultipliedRenderColor(c?null:t.getLut(i.scope)).toArray01Linear().slice(0,3),h);const f=[0,0,0];return e.c4(f,o.toPremultipliedRenderColor(r?null:t.getLut(n.scope)).toArray01Linear().slice(0,3),d*s),e.da([p[0]>0?p[0]/(p[0]+f[0]):0,p[1]>0?p[1]/(p[1]+f[1]):0,p[2]>0?p[2]/(p[2]+f[2]):0])}function gn(t,i,n,r,o,s){const a=t.zoom,l=t.scale,c=t.worldSize,u=1/c,h=t.aspect,d=Math.sqrt(1+h*h)*Math.tan(.5*t.fovX),p=d*d,f=r-n,m=r+n;let g,_;p>f/m?(g=r,_=r*d):(g=.5*m*(1+p),_=.5*Math.sqrt(f*f+2*(r*r+n*n)*p+m*m*p*p));const y=t.projection.pixelsPerMeter(t.center.lat,c),v=t._camera.getCameraToWorldMercator(),x=[0,0,-g*u];e.af(x,x,v);let b=_*u;const T=t._edgeInsets;if(!(0===T.left&&0===T.top&&0===T.right&&0===T.bottom||T.left===T.right&&T.top===T.bottom)){const i=t._camera.getWorldToCamera(t.worldSize,"meters"===t.projection.zAxisUnit?y:1),o=t._camera.getCameraToClipPerspective(t._fov,t.width/t.height,n,r);o[8]=2*-t.centerOffset.x/t.width,o[9]=2*t.centerOffset.y/t.height;const s=new Float64Array(16);e.cO(s,o,i);const u=new Float64Array(16);e.bk(u,s);const h=e.cA.fromInvProjectionMatrix(u,c,a,!0);for(const i of h.points){const n=((w=i)[0]/=l,w[1]/=l,w[2]=e.ce(w[2],t._center.lat),w);b=Math.max(b,e.c5(e.d9([],x,n)))}}var w;b*=o/(o-1);const E=Math.acos(i[2]),S=Math.atan2(-i[0],-i[1]),A=new nn;A.position=x,A.setPitchBearing(E,S);const M=A.getWorldToCamera(c,y),I=b*c,C=Math.min(t._mercatorZfromZoom(17)*c*-2,-2*I),P=A.getCameraToClipOrthographic(-I,I,-I,I,C,(I+s*y)/i[2]),L=new Float64Array(16);e.aB(L,P,M);const R=e.d4(Math.floor(1e6*x[0])/1e6*c,Math.floor(1e6*x[1])/1e6*c,0),O=.5*o,D=[0,0,0];e.af(D,R,L),e.c4(D,D,O);const B=[Math.floor(D[0]),Math.floor(D[1]),Math.floor(D[2])],F=[0,0,0];e.av(F,D,B),e.c4(F,F,-1/O);const N=new Float64Array(16);return e.bz(N),e.bq(N,N,F),e.aB(L,N,L),[L,I]}class _n extends e.E{constructor(e){super(),this.requestManager=e,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,i){return e.db(this.requestManager.transformRequest(i,e.R.Model).url).then((n=>{if(!n)return;const r=e.dc(n),o=new e.dd(t,i,void 0,void 0,r);return o.computeBoundsAndApplyParent(),o})).catch((n=>{if(n&&404===n.status)return null;this.fire(new e.y(new Error(`Could not load model ${t} from ${i}: ${n.message}`)))}))}load(t,i,n={forceReload:!1}){this.models[i]||(this.models[i]={});const r=Object.keys(t),o=[],s=[];for(const e of r){const r=t[e];this.hasURLBeenRequested(r)&&!n.forceReload||(this.modelByURL[r]={modelId:e,scope:i},o.push(this.loadModel(e,r)),s.push(e)),this.models[i][e]||(this.models[i][e]={model:null,numReferences:1})}this.numModelsLoading[i]=(this.numModelsLoading[i]||0)+s.length,Promise.allSettled(o).then((t=>{for(let e=0;e<t.length;e++){const{status:n}=t[e];if("rejected"===n)continue;const{value:r}=t[e];this.models[i][s[e]]||(this.models[i][s[e]]={model:null,numReferences:1}),this.models[i][s[e]].model=r}this.numModelsLoading[i]-=s.length,this.fire(new e.z("data",{dataType:"style"}))})).catch((t=>{this.fire(new e.y(new Error(`Could not load models: ${t.message}`)))}))}isLoaded(){for(const e in this.numModelsLoading)if(this.numModelsLoading[e]>0)return!1;return!0}hasModel(e,t,i={exactIdMatch:!1}){return!!(i.exactIdMatch?this.getModel(e,t):this.getModelByURL(this.modelUris[t][e]))}getModel(e,t){return this.models[t]||(this.models[t]={}),this.models[t][e]?this.models[t][e].model:void 0}getModelByURL(e){if(!e)return null;const t=this.modelByURL[e];return t?this.models[t.scope][t.modelId].model:null}hasModelBeenAdded(e,t){return this.models[t]&&void 0!==this.models[t][e]}getModelURIs(e){return this.modelUris[e]||{}}addModel(e,t,i){this.models[i]||(this.models[i]={}),this.modelUris[i]||(this.modelUris[i]={});const n=this.requestManager.normalizeModelURL(t);if((this.hasModel(e,i,{exactIdMatch:!0})||this.hasModelBeenAdded(e,i))&&this.modelUris[i][e]===n)this.models[i][e].numReferences++;else if(this.hasURLBeenRequested(n)){const{scope:e,modelId:t}=this.modelByURL[n];this.models[e][t].numReferences++}else this.modelUris[i][e]=n,this.load({[e]:this.modelUris[i][e]},i)}addModelURLs(e,t){this.models[t]||(this.models[t]={}),this.modelUris[t]||(this.modelUris[t]={});const i=this.modelUris[t];for(const t in e)i[t]=this.requestManager.normalizeModelURL(e[t])}reloadModels(e){this.load(this.modelUris[e],e,{forceReload:!0})}addModelsFromBucket(t,i){this.models[i]||(this.models[i]={}),this.modelUris[i]||(this.modelUris[i]={});const n={};for(const r of t)this.hasModel(r,i,{exactIdMatch:!0})||this.hasURLBeenRequested(r)?this.models[i][r].numReferences++:this.modelUris[i][r]&&!this.hasURLBeenRequested(r)?n[r]=this.modelUris[i][r]:!this.hasURLBeenRequested(r)&&e.de(r,!1)&&(this.modelUris[i][r]=this.requestManager.normalizeModelURL(r),n[r]=this.modelUris[i][r]);this.load(n,i)}hasURLBeenRequested(e){return void 0!==this.modelByURL[e]}removeModel(e,t,i=!1,n=!1){if(this.models[t]&&this.models[t][e]&&(this.models[t][e].numReferences--,0===this.models[t][e].numReferences||n)){const n=this.modelUris[t][e];i||delete this.modelUris[t][e],delete this.modelByURL[n];const r=this.models[t][e].model;if(!r)return;delete this.models[t][e],r.destroy()}}destroy(){for(const e of Object.keys(this.models))for(const t of Object.keys(this.models[e])){const i=this.models[e][t].model;delete this.models[e][t],i&&i.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(e){return this.models[e]||(this.models[e]={}),Object.keys(this.models[e])}upload(e,t){this.models[t]||(this.models[t]={});for(const i in this.models[t])this.models[t][i].model&&this.models[t][i].model.upload(e.context)}}const yn=e.a6.colorTheme,vn=new e.a9({data:new e.aa(yn.data)});function xn(t){if(!t.metadata||!t.metadata.content_area)return;const i=e.o.devicePixelRatio,{left:n,top:r,width:o,height:s}=t.metadata.content_area,a=n*i,l=r*i;return[a,l,a+o*i,l+s*i]}function bn(t){if(t)return t.map((([t,i])=>[t*e.o.devicePixelRatio,i*e.o.devicePixelRatio]))}class Tn{constructor(e,t,i){this.id=e,this.scope=t,this.sourceCache=i,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(e){this.missingRequests.has(e.name)||this.pendingRequests.has(e.name)||this.pendingRequests.add(e.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const i=this.sourceCache.getVisibleCoordinates();if(0===i.length)return t;const n=this.sourceCache.getSource();if(!(n instanceof ht))return t;const r=i.map((e=>this.sourceCache.getTile(e))),o=n.getImages(r,Array.from(this.pendingRequests));for(const[i,n]of o)t.set(e.I.from({name:i,iconsetId:this.id}),n),this.pendingRequests.delete(i);for(const e of this.pendingRequests)this.missingRequests.add(e);return this.pendingRequests.clear(),t}}const wn=(e,t)=>Oe(e,t&&t.filter((e=>"source.canvas"!==e.identifier))),En=e.aH(zt,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),Sn=e.aH(zt,["setCenter","setZoom","setBearing","setPitch"]),An=new Set(["background","sky","slot","custom"]),Mn={version:8,layers:[],sources:{}},In={duration:300,delay:0};class Cn extends e.E{constructor(t,i={}){super(),this.map=t,this.scope=i.scope||"",this.globalId=null,this.fragments=[],this.importDepth=i.importDepth||0,this.importsCache=i.importsCache||new Map,this.resolvedImports=i.resolvedImports||new Set,this.transition=Object.assign({},In),this._buildingIndex=new Nt(this),this.crossTileSymbolIndex=new ji,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=i.styleChanges||new H,this.dispatcher=i.dispatcher?i.dispatcher:new e.D(e.dg(),this),i.imageManager?this.imageManager=i.imageManager:(this.imageManager=new W(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=i.glyphManager?i.glyphManager:new e.dh(t._requestManager,i.localFontFamily?e.di.all:i.localIdeographFontFamily?e.di.ideographs:e.di.none,i.localFontFamily||i.localIdeographFontFamily),i.modelManager?this.modelManager=i.modelManager:(this.modelManager=new _n(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=i.configOptions?i.configOptions:new Map,this._configDependentLayers=i.configDependentLayers?i.configDependentLayers:new Set,this._indoorDependentLayers=i.indoorDependentLayers?i.indoorDependentLayers:new Set,this._config=i.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:i.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=i.initialConfig,this.dispatcher.broadcast("setReferrer",e.dj());const n=this;this._rtlTextPluginCallback=Cn.registerForPluginStateChange((t=>{n.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:t.pluginStatus,pluginURL:t.pluginURL},((t,i)=>{if(e.dk(t),i&&i.every((e=>e)))for(const e in n._sourceCaches){const t=n._sourceCaches[e],i=t.getSource().type;"vector"!==i&&"geojson"!==i||t.reload()}}))})),this.on("data",(e=>{if("source"!==e.dataType||"metadata"!==e.sourceDataType)return;const t=this.getOwnSource(e.sourceId);if(t&&t.vectorLayerIds)for(const e in this._layers){const i=this._layers[e];i.source===t.id&&this._validateLayer(i)}}))}load(e){return e?("string"==typeof e?this.loadURL(e):this.loadJSON(e),this):this}_getGlobalId(t){if(!t)return null;if("string"==typeof t){if(e.h(t))return t;const i=e.dl(t);if(!i.startsWith("http"))try{return new URL(i,location.href).toString()}catch(e){return i}return i}return`json://${e.dm(JSON.stringify(t))}`}_diffStyle(t,i,n){this.globalId=this._getGlobalId(t);const r=(e,t)=>{try{t(null,this.setState(e,n))}catch(e){t(e,!1)}};if("string"==typeof t){const n=this.map._requestManager.normalizeStyleURL(t),o=this.map._requestManager.transformRequest(n,e.R.Style);e.m(o,((t,n)=>{t?this.fire(new e.y(t)):n&&r(n,i)}))}else"object"==typeof t&&r(t,i)}loadURL(t,i={}){this.fire(new e.z("dataloading",{dataType:"style"}));const n="boolean"==typeof i.validate?i.validate:!e.h(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,i.accessToken),this.resolvedImports.add(t);const r=this.importsCache.get(t);if(r)return this._load(r,n);const o=this.map._requestManager.transformRequest(t,e.R.Style);this._request=e.m(o,((i,r)=>{if(this._request=null,i)this.fire(new e.y(i));else if(r)return this.importsCache.set(t,r),this._load(r,n)}))}loadJSON(t,i={}){this.fire(new e.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=e.o.frame((()=>{this._request=null,this._load(t,!1!==i.validate)}))}loadEmpty(){this.fire(new e.z("dataloading",{dataType:"style"})),this._load(Mn,!1)}_loadImports(t,i,n){if(this.importDepth>=4)return e.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const r=[];for(const e of t){const t=this._createFragmentStyle(e),o=new Promise((e=>{t.once("style.import.load",e),t.once("error",e)})).then((()=>this.mergeAll()));if(r.push(o),this.resolvedImports.has(e.url)){t.loadEmpty();continue}const s=e.data||this.importsCache.get(e.url);s?(t.loadJSON(s,{validate:i}),this._isInternalStyle(s)&&(t.globalId=null)):e.url?t.loadURL(e.url,{validate:i}):t.loadEmpty();const a={style:t,id:e.id,config:e.config};if(n){const e=this.fragments.findIndex((({id:e})=>e===n));this.fragments=this.fragments.slice(0,e).concat(a).concat(this.fragments.slice(e))}else this.fragments.push(a)}return Promise.allSettled(r)}getImportGlobalIds(e=this,t=new Set){for(const i of e.fragments)i.style.globalId&&t.add(i.style.globalId),this.getImportGlobalIds(i.style,t);return[...t.values()]}_createFragmentStyle(t){const i=this.scope?e.B(t.id,this.scope):t.id;let n;const r=this._initialConfig&&this._initialConfig[i];(t.config||r)&&(n=Object.assign({},t.config,r));const o=new Cn(this.map,{scope:i,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:n,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return o.setEventedParent(this.map,{style:o}),o}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(e){return this.isRootStyle()&&(e.fragment||!!e.schema&&!1!==e.fragment)}_load(t,i){if(this._isInternalStyle(t)){const e=Object.assign({},Mn,{imports:[{id:"basemap",data:t,url:""}]},t.center?{center:t.center}:{},t.bearing?{bearing:t.bearing}:{},t.pitch?{pitch:t.pitch}:{},t.zoom?{zoom:t.zoom}:{},t.light?{light:t.light}:{});return this._importedAsBasemap=!0,void this._load(e,i)}if(this.updateConfig(this._config,t.schema),i&&wn(this,ve(t)))return;this._loaded=!0,this.stylesheet=e.dn(t);const n=()=>{for(const e in t.sources)this.addSource(e,t.sources[e],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const e in t.iconsets)this.addIconset(e,t.iconsets[e]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);const n=Ut(this.stylesheet.layers);if(this._order=n.map((e=>e.id)),this.stylesheet.light&&e.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const e=this.stylesheet.lights[0];this.light=new Fe(e.properties,e.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Fe(this.stylesheet.light)),this._layers={};for(const t of n){const i=e.dt(t,this.scope,this._styleColorTheme.lut,this.options);0!==i.expressionDependencies.configDependencies.size&&this._configDependentLayers.add(i.fqid),i.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(i.fqid),this._hasAppearances=this._hasAppearances||0!==i.getAppearances().length,i.setEventedParent(this,{layer:{id:i.id}}),this._layers[i.id]=i;const n=this.getOwnLayerSourceCache(i),r=!!this.directionalLight&&this.directionalLight.shadowsEnabled();n&&i.canCastShadows()&&r&&(n.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const r=this.stylesheet.terrain;r&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(r,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new e.z("data",{dataType:"style"}));const o=this.isRootStyle();t.imports?this._loadImports(t.imports,i).then((()=>{this._reloadImports(),this.fire(new e.z(o?"style.load":"style.import.load"))})).catch((t=>{this.fire(new e.y(new Error("Failed to load imports",t))),this.fire(new e.z(o?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new e.z(o?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const r=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(r){const t=this._evaluateColorThemeData(r);this._loadColorTheme(t).then((()=>{n()})).catch((t=>{e.w(`Couldn't load color theme from the stylesheet: ${t}`),n()}))}else this._styleColorTheme.lut=null,n()}isRootStyle(){return 0===this.importDepth}hasAppearances(){return this._hasAppearances}mergeAll(){let e,t,i,n,r,o,s,a,l,c;const u={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((h=>{if(h.stylesheet){if(null!=h.light&&(e=h.light),h.stylesheet.lights)for(const e of h.stylesheet.lights)"ambient"===e.type&&null!=h.ambientLight&&(t=h.ambientLight),"directional"===e.type&&null!=h.directionalLight&&(i=h.directionalLight);n=this._prioritizeTerrain(n,h.terrain,h.stylesheet.terrain),h.stylesheet.fog&&null!=h.fog&&(r=h.fog),h.stylesheet.snow&&null!=h.snow&&(o=h.snow),h.stylesheet.rain&&null!=h.rain&&(s=h.rain),null!=h.stylesheet.camera&&(c=h.stylesheet.camera),null!=h.stylesheet.projection&&(a=h.stylesheet.projection),null!=h.stylesheet.transition&&(l=h.stylesheet.transition),u[h.scope]=h._styleColorTheme}})),this.light=e,this.ambientLight=t,this.directionalLight=i,this.fog=r,this.snow=o,this.rain=s,this._styleColorThemeForScope=u,null===n?delete this.terrain:this.terrain=n,this.camera=c||{"camera-projection":"perspective"},this.projection=a||{name:"mercator"},this.transition=Object.assign({},In,l),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(e){const t=i=>{for(const e of i.fragments)t(e.style);e(i)};t(this)}_prioritizeTerrain(e,t,i){const n=e&&0===e.drapeRenderMode;return null===i?t&&0===t.drapeRenderMode?t:n?e:null:null!=t&&(!e||n||t&&1===t.drapeRenderMode)?t:e}mergeTerrain(){let e;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((t=>{e=this._prioritizeTerrain(e,t.terrain,t.stylesheet.terrain)})),null===e?delete this.terrain:this.terrain=e}mergeProjection(){let e;this.forEachFragmentStyle((t=>{null!=t.stylesheet.projection&&(e=t.stylesheet.projection)})),this.projection=e||{name:"mercator"}}mergeSources(){const t={},i={},n={};this.forEachFragmentStyle((r=>{for(const i in r._sourceCaches){const n=e.B(i,r.scope);t[n]=r._sourceCaches[i]}for(const t in r._otherSourceCaches){const n=e.B(t,r.scope);i[n]=r._otherSourceCaches[t]}for(const t in r._symbolSourceCaches){const i=e.B(t,r.scope);n[i]=r._symbolSourceCaches[t]}})),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=i,this._mergedSymbolSourceCaches=n}mergeIndoor(){this.forEachFragmentStyle((t=>{if(t.stylesheet&&t.stylesheet.indoor)for(const i of Object.values(t.stylesheet.indoor)){const n=i,r=e.B(n.sourceId,t.scope);this._mergedIndoor[r]=new Set(n.sourceLayers||[])}}))}mergeLayers(){const t={},i=[],n={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((n=>{for(const r of n._order){const o=n._layers[r];if("slot"===o.type){const i=e.dp(r);if(t[i])continue;t[i]=[]}o.slot&&t[o.slot]?t[o.slot].push(o):i.push(o)}})),this._mergedOrder=[];let r=-1;const o=(i=[])=>{for(const s of i)if("slot"===s.type){const i=e.dp(s.id);t[i]&&o(t[i]),this._mergedSlots.push(i)}else{const t=e.B(s.id,s.scope);this._mergedOrder.push(t),n[t]=s,s.is3D(!!this.terrain)&&(this._has3DLayers=!0,r=this._mergedOrder.length-1),"circle"===s.type&&(this._hasCircleLayers=!0),"symbol"===s.type&&(this._hasSymbolLayers=!0),"clip"===s.type&&(this._clipLayerPresent=!0)}};if(o(i),this._has3DLayers){const e={};for(let t=0;t<this._mergedOrder.length;++t){const i=this._mergedOrder[t];e[i]=t===r?1:t<r?n[i].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort(((t,i)=>e[t]-e[i]))}this._mergedLayers=n,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(e){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,e),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(t,i,n){const r=Object.assign({},i);for(const e of Object.keys(yn))void 0===r[e]&&(r[e]=yn[e].default);const o=new e.a8(vn,t,new Map(n));return o.setTransitionOrValue(r,n),o.untransitioned().possiblyEvaluate(new e.ac(0,{worldview:void 0}))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const i=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((n,r)=>{const o="data:image/png;base64,";if(!t||0===t.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void n();let s=t;s.startsWith(o)||(s=o+s);const a=e.I.from("mapbox-reserved-lut"),l=new Image;l.src=s,l.onerror=()=>{this._styleColorTheme.lutLoading=!1,r(new Error("Failed to load image data"))},l.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==i)return void n();this._styleColorTheme.lutLoading=!1;const{width:o,height:s,data:c}=e.o.getImageData(l);if(s>32)return void r(new Error("The height of the image must be less than or equal to 32 pixels."));if(o!==s*s)return void r(new Error("The width of the image must be equal to the height squared."));this.getImage(a)&&this.removeImage(a),this.addImage(a,{data:new e.q({width:o,height:s},c),pixelRatio:1,sdf:!1,usvg:!1,version:0});const u=this.imageManager.getImage(a,this.scope);u?(this._styleColorTheme.lut={image:u.data,data:t},n()):r(new Error("Missing LUT image."))}}))}getLut(e){const t=this._styleColorThemeForScope[e];return t?t.lut:null}setProjection(e){e?this.stylesheet.projection=e:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(t,i,n){let r,o,s;const a=e.o.devicePixelRatio>1?"@2x":"";let l=e.m(i.transformRequest(i.normalizeSpriteURL(t,a,".json"),e.R.SpriteJSON),((e,t)=>{l=null,s||(s=e,r=t,u())})),c=e.n(i.transformRequest(i.normalizeSpriteURL(t,a,".png"),e.R.SpriteImage),((e,t)=>{c=null,s||(s=e,o=t,u())}));function u(){if(s)n(s);else if(r&&o){const t=e.o.getImageData(o),i={};for(const n in r){const{width:o,height:s,x:a,y:l,sdf:c,pixelRatio:u,stretchX:h,stretchY:d,content:p}=r[n],f=new e.q({width:o,height:s});e.q.copy(t,f,{x:a,y:l},{x:0,y:0},{width:o,height:s},null),i[n]={data:f,pixelRatio:void 0!==u?u:1,sdf:void 0!==c&&c,stretchX:h,stretchY:d,content:p,usvg:!1,version:0}}n(null,i)}}return{cancel(){l&&(l.cancel(),l=null),c&&(c.cancel(),c=null)}}}(t,this.map._requestManager,((t,i)=>{if(this._spriteRequest=null,t)this.fire(new e.y(t));else if(i){const t=new Map;for(const n in i)t.set(e.I.from(n),i[n]);this.addImages(t)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new e.z("data",{dataType:"style"}))}))}addIconset(t,i){if("sprite"===i.type)return void this._loadSprite(i.url);const n=this.getOwnSourceCache(i.source);if(!n)return void this.fire(new e.y(new Error(`Source "${i.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));const r=n.getSource();if("raster-array"!==r.type)return void this.fire(new e.y(new Error(`Source "${i.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));r.partial=!1;const o=new Tn(t,this.scope,n);this.imageManager.addImageProvider(o,this.scope)}removeIconset(e){this.imageManager.removeImageProvider(e,this.scope)}_loadIconset(t){if(!e.h(t)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(t);const i="auto"===this.map._spriteFormat;var n,r;this._spriteRequest=(r=(n,r)=>{if(this._spriteRequest=null,n)i?this._loadSprite(t):this.fire(new e.y(n));else if(r){const t=new Map;for(const i in r)t.set(e.I.from(i),r[i]);this.addImages(t)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new e.z("data",{dataType:"style"}))},e.bt((n=this.map._requestManager).transformRequest(n.normalizeIconsetURL(t),e.R.Iconset),((t,i)=>{if(t)return void r(t);const n={},o=e.df(new e.bs(i));for(const t of o.icons){const i={version:1,pixelRatio:e.o.devicePixelRatio,content:xn(t),stretchX:t.metadata?bn(t.metadata.stretch_x_areas):void 0,stretchY:t.metadata?bn(t.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:t};n[t.name]=i}r(null,n)})))}_validateLayer(t){const i=this.getOwnSource(t.source);if(!i)return;const n=t.sourceLayer;n&&("geojson"===i.type||i.vectorLayerIds&&-1===i.vectorLayerIds.indexOf(n))&&this.fire(new e.y(new Error(`Source layer "${n}" does not exist on source "${i.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const e in this._sourceCaches)if(!this._sourceCaches[e].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(this.imageManager.hasPatternsInFlight())return!1;if(!this.modelManager.isLoaded())return!1;if(this._styleColorTheme.lutLoading)return!1;for(const{style:e}of this.fragments)if(!e.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((e,t)=>{const i=this.fragments[t];return i&&i.style&&(e.data=i.style.serialize()),e}))}_serializeSources(){const e={};for(const t in this._sourceCaches){const i=this._sourceCaches[t].getSource();e[i.id]||(e[i.id]=i.serialize())}return e}_serializeLayers(e){const t=[];for(const i of e){const e=this._layers[i];e&&"custom"!==e.type&&t.push(e.serialize())}return t}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;if(this.hasSnowTransition())return!0;if(this.hasRainTransition())return!0;for(const e in this._sourceCaches)if(this._sourceCaches[e].hasTransition())return!0;for(const e in this._layers)if(this._layers[e].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(e){return e?this.order:this._mergedOrder}isLayerDraped(e){return!!this.terrain&&e.isDraped(this.getLayerSourceCache(e))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const i=this.getOwnLayer(t);if(i)return i;this.fire(new e.y(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const i=this.getOwnSource(t);if(i)return i;this.fire(new e.y(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(e,t){const i=this.map.painter;if(i)for(let n=e.minzoom||0;n<(e.maxzoom||25.5);n++){const n=e.getProgramIds();if(n)for(const r of n){const n=e.getDefaultProgramParams(r,t.zoom,this._styleColorTheme.lut);n&&(i.style=this,this.fog&&(i._fogVisible=!0,n.overrideFog=!0,i.getOrCreateProgram(r,n)),i._fogVisible=!1,n.overrideFog=!1,i.getOrCreateProgram(r,n),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(n.overrideRtt=!0,i.getOrCreateProgram(r,n)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const i=this.calculateLightsBrightness();t.brightness=i||0,i!==this._brightness&&(this._brightness=i,this.dispatcher.broadcast("setBrightness",i)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const n=this._changes.isDirty();let r=!1;if(this._changes.isDirty()){const e=this._changes.getLayerUpdatesByScope();for(const t in e){const{updatedIds:i,removedIds:n}=e[t];(i||n)&&(this._updateWorkerLayers(t,i,n),r=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const o={};for(const e in this._mergedSourceCaches){const t=this._mergedSourceCaches[e];o[e]=t.used,t.used=!1,t.tileCoverLift=0}for(const e of this._mergedOrder){const i=this._mergedLayers[e];if(i.recalculate(t,this._availableImages),!i.isHidden(t.zoom)){const e=this.getLayerSourceCache(i);e&&(e.used=!0,e.tileCoverLift=Math.max(e.tileCoverLift,i.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(i,t)})):this.precompilePrograms(i,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&r&&this.mergeLayers();const s=this.imageManager.getPendingImageProviders();for(const e of s)e.sourceCache.used=!0;for(const t in o){const i=this._mergedSourceCaches[t];o[t]!==i.used&&i.getSource().fire(new e.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:i.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),n&&this.fire(new e.z("data",{dataType:"style"}))}updateImageProviders(){const e=this.imageManager.getPendingImageProviders();for(const t of e){const e=t.resolvePendingRequests(),i=this.getFragmentStyle(t.scope);i&&i.addImages(e)}}_updateTilesForChangedImages(){const e={};for(const t in this._mergedSourceCaches){const i=this._mergedSourceCaches[t].getSource().scope;e[i]=e[i]||this._changes.getUpdatedImages(i),0!==e[i].length&&this._mergedSourceCaches[t].reloadTilesForDependencies(["icons","patterns"],e[i])}for(const t in e)this._changes.resetUpdatedImages(t)}_updateWorkerLayers(e,t,i){const n=this.getFragmentStyle(e);n&&this.dispatcher.broadcast("updateLayers",{layers:t?n._serializeLayers(t):[],scope:e,removedIds:i||[],options:n.options})}setState(t,i){if(this._checkLoaded(),wn(this,ve(t)))return!1;(t=e.dn(t)).layers=Ut(t.layers);const n=function(t,i){if(!t)return[{command:zt.setStyle,args:[i]}];let n=[];try{if(!e.bx(t.version,i.version))return[{command:zt.setStyle,args:[i]}];if(e.bx(t.center,i.center)||n.push({command:zt.setCenter,args:[i.center]}),e.bx(t.zoom,i.zoom)||n.push({command:zt.setZoom,args:[i.zoom]}),e.bx(t.bearing,i.bearing)||n.push({command:zt.setBearing,args:[i.bearing]}),e.bx(t.pitch,i.pitch)||n.push({command:zt.setPitch,args:[i.pitch]}),e.bx(t.sprite,i.sprite)||n.push({command:zt.setSprite,args:[i.sprite]}),e.bx(t.glyphs,i.glyphs)||n.push({command:zt.setGlyphs,args:[i.glyphs]}),e.bx(t.imports,i.imports)||function(t=[],i=[],n){i=i||[];const r=(t=t||[]).map(Wt),o=i.map(Wt),s=t.reduce(qt,{}),a=i.reduce(qt,{}),l=r.slice();let c,u,h,d;for(c=0,u=0;c<r.length;c++)h=r[c],a.hasOwnProperty(h)?u++:(n.push({command:zt.removeImport,args:[h]}),l.splice(l.indexOf(h,u),1));for(c=0,u=0;c<o.length;c++)h=o[o.length-1-c],l[l.length-1-c]!==h&&(s.hasOwnProperty(h)?(n.push({command:zt.removeImport,args:[h]}),l.splice(l.lastIndexOf(h,l.length-u),1)):u++,d=l[l.length-c],n.push({command:zt.addImport,args:[a[h],d]}),l.splice(l.length-c,0,h));for(const t of i){const i=s[t.id];i&&(delete i.data,e.bx(i,t)||n.push({command:zt.updateImport,args:[t.id,t]}))}}(t.imports,i.imports,n),e.bx(t.transition,i.transition)||n.push({command:zt.setTransition,args:[i.transition]}),e.bx(t.light,i.light)||n.push({command:zt.setLight,args:[i.light]}),e.bx(t.fog,i.fog)||n.push({command:zt.setFog,args:[i.fog]}),e.bx(t.snow,i.snow)||n.push({command:zt.setSnow,args:[i.snow]}),e.bx(t.rain,i.rain)||n.push({command:zt.setRain,args:[i.rain]}),e.bx(t.projection,i.projection)||n.push({command:zt.setProjection,args:[i.projection]}),e.bx(t.lights,i.lights)||n.push({command:zt.setLights,args:[i.lights]}),e.bx(t.camera,i.camera)||n.push({command:zt.setCamera,args:[i.camera]}),e.bx(t.iconsets,i.iconsets)||function(t,i,n){let r;for(r in i=i||{},t=t||{})t.hasOwnProperty(r)&&(i.hasOwnProperty(r)||n.push({command:zt.removeIconset,args:[r]}));for(r in i){if(!i.hasOwnProperty(r))continue;const o=i[r];t.hasOwnProperty(r)?e.bx(t[r],o)||(n.push({command:zt.removeIconset,args:[r]}),n.push({command:zt.addIconset,args:[r,o]})):n.push({command:zt.addIconset,args:[r,o]})}}(t.iconsets,i.iconsets,n),!e.bx(t["color-theme"],i["color-theme"]))return[{command:zt.setStyle,args:[i]}];const r={},o=[];!function(t,i,n,r){let o;for(o in i=i||{},t=t||{})t.hasOwnProperty(o)&&(i.hasOwnProperty(o)||Gt(o,n,r));for(o in i){if(!i.hasOwnProperty(o))continue;const s=i[o];t.hasOwnProperty(o)?e.bx(t[o],s)||("geojson"===t[o].type&&"geojson"===s.type&&Ht(t,i,o)?n.push({command:zt.setGeoJSONSourceData,args:[o,s.data]}):jt(o,i,n,r)):Vt(o,i,n)}}(t.sources,i.sources,o,r);const s=[];t.layers&&t.layers.forEach((e=>{e.source&&r[e.source]?n.push({command:zt.removeLayer,args:[e.id]}):s.push(e)}));let a=t.terrain;a&&r[a.source]&&(n.push({command:zt.setTerrain,args:[void 0]}),a=void 0),n=n.concat(o),e.bx(a,i.terrain)||n.push({command:zt.setTerrain,args:[i.terrain]}),function(t,i,n){i=i||[];const r=(t=t||[]).map(Wt),o=i.map(Wt),s=t.reduce(qt,{}),a=i.reduce(qt,{}),l=r.slice(),c=Object.create(null);let u,h,d,p,f,m,g;for(u=0,h=0;u<r.length;u++)d=r[u],a.hasOwnProperty(d)?h++:(n.push({command:zt.removeLayer,args:[d]}),l.splice(l.indexOf(d,h),1));for(u=0,h=0;u<o.length;u++)d=o[o.length-1-u],l[l.length-1-u]!==d&&(s.hasOwnProperty(d)?(n.push({command:zt.removeLayer,args:[d]}),l.splice(l.lastIndexOf(d,l.length-h),1)):h++,m=l[l.length-u],n.push({command:zt.addLayer,args:[a[d],m]}),l.splice(l.length-u,0,d),c[d]=!0);for(u=0;u<o.length;u++)if(d=o[u],p=s[d],f=a[d],!c[d]&&!e.bx(p,f))if(e.bx(p.source,f.source)&&e.bx(p["source-layer"],f["source-layer"])&&e.bx(p.type,f.type)){for(g in $t(p.layout,f.layout,n,d,null,zt.setLayoutProperty),$t(p.paint,f.paint,n,d,null,zt.setPaintProperty),e.bx(p.slot,f.slot)||n.push({command:zt.setSlot,args:[d,f.slot]}),e.bx(p.filter,f.filter)||n.push({command:zt.setFilter,args:[d,f.filter]}),e.bx(p.minzoom,f.minzoom)&&e.bx(p.maxzoom,f.maxzoom)||n.push({command:zt.setLayerZoomRange,args:[d,f.minzoom,f.maxzoom]}),p)p.hasOwnProperty(g)&&"layout"!==g&&"paint"!==g&&"filter"!==g&&"metadata"!==g&&"minzoom"!==g&&"maxzoom"!==g&&"slot"!==g&&(0===g.indexOf("paint.")?$t(p[g],f[g],n,d,g.slice(6),zt.setPaintProperty):e.bx(p[g],f[g])||n.push({command:zt.setLayerProperty,args:[d,g,f[g]]}));for(g in f)f.hasOwnProperty(g)&&!p.hasOwnProperty(g)&&"layout"!==g&&"paint"!==g&&"filter"!==g&&"metadata"!==g&&"minzoom"!==g&&"maxzoom"!==g&&"slot"!==g&&(0===g.indexOf("paint.")?$t(p[g],f[g],n,d,g.slice(6),zt.setPaintProperty):e.bx(p[g],f[g])||n.push({command:zt.setLayerProperty,args:[d,g,f[g]]}))}else n.push({command:zt.removeLayer,args:[d]}),m=l[l.lastIndexOf(d)+1],n.push({command:zt.addLayer,args:[f,m]})}(s,i.layers,n)}catch(e){n=[{command:zt.setStyle,args:[i]}]}return n}(this.serialize(),t).filter((e=>!(e.command in Sn)));if(0===n.length)return!1;const r=n.filter((e=>!(e.command in En)));if(r.length>0)throw new Error(`Unimplemented: ${r.map((e=>e.command)).join(", ")}.`);const o=[];return n.forEach((e=>{o.push(this[e.command](...e.args))})),i&&Promise.all(o).then(i).catch(i),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(0===t.size)return this;for(const[i,n]of t.entries()){if(this.getImage(i))return this.fire(new e.y(new Error(`An image with the name "${i.name}" already exists.`)));this.imageManager.addImage(i,this.scope,n),this._changes.updateImage(i,this.scope)}return this._updateWorkerImages(),this.fire(new e.z("data",{dataType:"style"})),this}addImage(t,i){return this.getImage(t)?this.fire(new e.y(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,i),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new e.z("data",{dataType:"style"})),this)}updateImage(t,i,n=!1){this.imageManager.updateImage(t,this.scope,i),n&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new e.z("data",{dataType:"style"})))}getImage(e){return this.imageManager.getImage(e,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new e.z("data",{dataType:"style"})),this):this.fire(new e.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new e.z("data",{dataType:"style"})),this}addModel(t,i,n={}){return this._checkLoaded(),this._validate(Le,`models.${t}`,i,null,n)||(this.modelManager.addModel(t,i,this.scope),this.fire(new e.z("data",{dataType:"style"}))),this}hasModel(e){return this.modelManager.hasModel(e,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new e.z("data",{dataType:"style"})),this):this.fire(new e.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,i,n={}){if(this._checkLoaded(),void 0!==this.getOwnSource(t))throw new Error(`There is already a source with ID "${t}".`);if(!i.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(i).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(i.type)>=0&&this._validate(xe,`sources.${t}`,i,null,n))return;this.map&&this.map._collectResourceTiming&&(i.collectResourceTiming=!0);const r=pt(t,i,this.dispatcher,this);r.scope=this.scope,r.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(r.id),source:r.serialize(),sourceId:r.id})));const o=t=>{const i=(t?"symbol:":"other:")+r.id,n=e.B(i,this.scope),o=this._sourceCaches[i]=new Ot(n,r,t);(t?this._symbolSourceCaches:this._otherSourceCaches)[r.id]=o,o.onAdd(this.map)};o(!1),"vector"!==i.type&&"geojson"!==i.type||o(!0),r.onAdd&&r.onAdd(this.map),n.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const i=this.getOwnSource(t);if(!i)throw new Error("There is no source with this ID");for(const i in this._layers)if(this._layers[i].source===t)return this.fire(new e.y(new Error(`Source "${t}" cannot be removed while layer "${i}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new e.y(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const i=Object.entries(this.stylesheet.iconsets).find((([e,i])=>"source"===i.type&&i.source===t));if(i)return this.fire(new e.y(new Error(`Source "${t}" cannot be removed while iconset "${i[0]}" is using it.`)))}const n=this.getOwnSourceCaches(t);for(const t of n){const i=e.dp(t.id);delete this._sourceCaches[i],this._changes.discardSourceCacheUpdate(t.id),t.fire(new e.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:t.getSource().id})),t.setEventedParent(null),t.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),i.setEventedParent(null),i.onRemove&&i.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(e,t){this._checkLoaded(),this.getOwnSource(e).setData(t),this._changes.setDirty()}getOwnSource(e){const t=this.getOwnSourceCache(e);return t&&t.getSource()}getOwnSources(){const e=[];for(const t in this._otherSourceCaches){const i=this.getOwnSourceCache(t);i&&e.push(i.getSource())}return e}areTilesLoaded(){const e=this._mergedSourceCaches;for(const t in e){const i=e[t]._tiles;for(const e in i){const t=i[e];if("loaded"!==t.state&&"errored"!==t.state)return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const i=this._getTransitionParameters();for(const n of t){if(this._validate(Te,"lights",n))return;switch(n.type){case"ambient":if(this.ambientLight){const e=this.ambientLight;e.set(n),e.updateTransitions(i)}else this.ambientLight=new et(n,Ze||(Ze=new e.a9({color:new e.aa(e.a6.properties_light_ambient.color),"color-use-theme":new e.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new e.aa(e.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const e=this.directionalLight;e.set(n),e.updateTransitions(i)}else this.directionalLight=new et(n,Je||(Je=new e.a9({direction:new e.ap(e.a6.properties_light_directional.direction),color:new e.aa(e.a6.properties_light_directional.color),"color-use-theme":new e.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new e.aa(e.a6.properties_light_directional.intensity),"cast-shadows":new e.aa(e.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new e.aa(e.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new e.aa(e.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const n=Object.assign(i,{worldview:this.map.getWorldview()}),r=new e.ac(this.z||0,n);this.ambientLight&&this.ambientLight.recalculate(r),this.directionalLight&&this.directionalLight.recalculate(r),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,i=this.ambientLight;if(!t||!i)return;const n=e=>.2126*(e[0]<=.03928?e[0]/12.92:Math.pow((e[0]+.055)/1.055,2.4))+.7152*(e[1]<=.03928?e[1]/12.92:Math.pow((e[1]+.055)/1.055,2.4))+.0722*(e[2]<=.03928?e[2]/12.92:Math.pow((e[2]+.055)/1.055,2.4)),r=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),o=t.properties.get("intensity"),s=t.properties.get("direction"),a=1-e.d3(s.x,s.y,s.z)[2]/90,l=n(r)*o*a,c=i.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),u=i.properties.get("intensity"),h=n(c)*u;return Number(((l+h)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const e=[];return this.directionalLight&&e.push(this.directionalLight.get()),this.ambientLight&&e.push(this.ambientLight.get()),e}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(null==t||""===t&&this.isRootStyle())return this;if(e.dq(t)){const i=e.dr(t),n=this.fragments.find((({id:e})=>e===i));if(!n)return;const r=e.dp(t);return n.style.getFragmentStyle(r)}{const e=this.fragments.find((({id:e})=>e===t));return e?e.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const i={},n=(e,t="")=>`${e}::${t}`;this._featuresetSelectors={};for(const r in t){const o=this._featuresetSelectors[r]=[];for(const s of t[r].selectors){if(s.featureNamespace){const t=this.getOwnLayer(s.layer);if(!t){e.w(`Layer is undefined for selector: ${s.layer}`);continue}const o=n(t.source,t.sourceLayer);if(o in i&&i[o]!==s.featureNamespace){e.w(`"featureNamespace ${s.featureNamespace} of featureset ${r}'s selector is not associated to the same source, skip this selector`);continue}i[o]=s.featureNamespace}let t;if(s.properties)for(const i in s.properties){const n=e.U(s.properties[i]);"success"===n.result&&(t=t||{},t[i]=n.value)}o.push({layerId:s.layer,namespace:s.featureNamespace,properties:t,uniqueFeatureID:s._uniqueFeatureID})}}}getFeaturesetDescriptors(e){const t=this.getFragmentStyle(e);if(!t||!t.stylesheet.featuresets)return[];const i=[];for(const e in t.stylesheet.featuresets)i.push({featuresetId:e,importId:t.scope?t.scope:void 0});return i}getFeaturesetLayers(t,i){const n=this.getFragmentStyle(i),r=n.stylesheet.featuresets;if(!r||!r[t])return this.fire(new e.y(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const o=[];for(const e of r[t].selectors){const t=n.getOwnLayer(e.layer);t&&o.push(t)}return o}getConfigProperty(t,i){const n=this.getFragmentStyle(t);if(!n)return null;const r=e.B(i,n.scope),o=n.options.get(r),s=o?o.value||o.default:null;return s?s.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(t,i){const n=e.B(t,i);return this._mergedIndoor[n]}setIndoorData(e,t){this.map.indoor.setIndoorData(t)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(t,i,n){const r=this.getFragmentStyle(t);if(!r)return;const o=r.stylesheet.schema;if(!o||!o[i])return;const s=e.U(n);if("success"!==s.result)return void wn(this,s.value);const a=s.value.expression,l=e.B(i,r.scope),c=r.options.get(l);if(!c)return;let u;const{minValue:h,maxValue:d,stepValue:p,type:f,values:m}=o[i],g=e.U(o[i].default);"success"===g.result&&(u=g.value.expression),u?(this.options.set(l,Object.assign({},c,{value:a,default:u,minValue:h,maxValue:d,stepValue:p,type:f,values:m})),this.updateConfigDependencies(i)):this.fire(new e.y(new Error(`No schema defined for the config option "${i}" in the "${t}" fragment.`)))}getConfig(t){const i=this.getFragmentStyle(t);if(!i)return null;const n=i.stylesheet.schema;if(!n)return null;const r={};for(const t in n){const n=e.B(t,i.scope),o=i.options.get(n),s=o?o.value||o.default:null;r[t]=s?s.serialize():null}return r}setConfig(e,t){const i=this.getFragmentStyle(e);i&&(i.updateConfig(t,i.stylesheet.schema),this.updateConfigDependencies())}getSchema(e){const t=this.getFragmentStyle(e);return t?t.stylesheet.schema:null}setSchema(e,t){const i=this.getFragmentStyle(e);i&&(i.stylesheet.schema=t,i.updateConfig(i._config,t),this.updateConfigDependencies())}updateConfig(t,i){if(this._config=t,t||i)if(i)for(const n in i){let r,o;const s=e.U(i[n].default);if("success"===s.result&&(r=s.value.expression),t&&void 0!==t[n]){const i=e.U(t[n]);"success"===i.result&&(o=i.value.expression)}const{minValue:a,maxValue:l,stepValue:c,type:u,values:h}=i[n];if(r){const t=e.B(n,this.scope);this.options.set(t,{default:r,value:o,minValue:a,maxValue:l,stepValue:c,type:u,values:h})}else this.fire(new e.y(new Error(`No schema defined for config option "${n}".`)))}else this.fire(new e.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(e,t=()=>!0){for(const i of e){const e=this.getLayer(i);e&&t(e)&&(e.possiblyEvaluateVisibility(),this._updateLayer(e),this._changes.setDirty())}}updateConfigDependencies(e){this._updateLayers(this._configDependentLayers,(t=>!e||t.expressionDependencies.configDependencies.has(e))),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((e=>{const t=e._styleColorTheme.colorThemeOverride?e._styleColorTheme.colorThemeOverride:e._styleColorTheme.colorTheme;if(t){const i=e._evaluateColorThemeData(t);(!e._styleColorTheme.lut&&""!==i||e._styleColorTheme.lut&&i!==e._styleColorTheme.lut.data)&&e.setColorTheme(t)}})),this._changes.setDirty()}addLayer(t,i,n={}){this._checkLoaded();const r=t.id;if(this._layers[r])return void this.fire(new e.y(new Error(`Layer with id "${r}" already exists on this map`)));let o;if("custom"===t.type){if(wn(this,e.ds(t)))return;o=e.dt(t,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof t.source&&(this.addSource(r,t.source),t=e.dn(t),t=Object.assign(t,{source:r})),this._validate(Me,`layers.${r}`,t,{arrayIndex:-1},n))return;o=e.dt(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(o),o.setEventedParent(this,{layer:{id:r}})}const s=e.B(o.source,o.scope);0!==o.expressionDependencies.configDependencies.size&&this._configDependentLayers.add(s),o.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(s);let a=this._order.length;if(i){const t=this._order.indexOf(i);if(-1===t)return void this.fire(new e.y(new Error(`Layer with id "${i}" does not exist on this map.`)));o.slot===this._layers[i].slot?a=t:e.w(`Layer with id "${i}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(a,0,r),this._layerOrderChanged=!0,this._layers[r]=o;const l=this.getOwnLayerSourceCache(o),c=!!this.directionalLight&&this.directionalLight.shadowsEnabled();l&&o.canCastShadows()&&c&&(l.castsShadows=!0);const u=this._changes.getRemovedLayer(o);if(u&&o.source&&l&&"custom"!==o.type){this._changes.discardLayerRemoval(o);const t=e.B(o.source,o.scope);u.type!==o.type?this._changes.updateSourceCache(t,"clear"):(this._changes.updateSourceCache(t,"reload"),l.pause())}this._updateLayer(o),o.onAdd&&o.onAdd(this.map),o.scope=this.scope,this.mergeLayers()}moveLayer(t,i){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;if(t===i)return;const r=this._order.indexOf(t);this._order.splice(r,1);let o=this._order.length;if(i){const t=this._order.indexOf(i);if(-1===t)return void this.fire(new e.y(new Error(`Layer with id "${i}" does not exist on this map.`)));n.slot===this._layers[i].slot?o=t:e.w(`Layer with id "${i}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(o,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(e){this._checkLoaded();const t=this._checkLayer(e);if(!t)return;t.setEventedParent(null);const i=this._order.indexOf(e);this._order.splice(i,1),delete this._layers[e],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(t.fqid),this._indoorDependentLayers.delete(t.fqid),this._changes.removeLayer(t);const n=this.getOwnLayerSourceCache(t);if(n&&n.castsShadows){let e=!1;for(const i in this._layers)if(this._layers[i].source===t.source&&this._layers[i].canCastShadows()){e=!0;break}n.castsShadows=e}t.onRemove&&t.onRemove(this.map),this.mergeLayers()}getOwnLayer(e){return this._layers[e]}hasLayer(e){return e in this._mergedLayers}hasLayerType(e){for(const t in this._layers)if(this._layers[t].type===e)return!0;return!1}setLayerZoomRange(e,t,i){this._checkLoaded();const n=this._checkLayer(e);n&&(n.minzoom===t&&n.maxzoom===i||(null!=t&&(n.minzoom=t),null!=i&&(n.maxzoom=i),this._updateLayer(n)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(e,t){this._checkLoaded();const i=this._checkLayer(e);i&&i.slot!==t&&(i.slot=t,this._updateLayer(i))}setFilter(t,i,n={}){this._checkLoaded();const r=this._checkLayer(t);if(r&&!e.bx(r.filter,i))return null==i?(r.filter=void 0,void this._updateLayer(r)):void(this._validate(Ie,`layers.${r.id}.filter`,i,{layerType:r.type},n)||(r.filter=e.dn(i),this._updateLayer(r)))}getFilter(t){const i=this._checkLayer(t);if(i)return e.dn(i.filter)}setLayoutProperty(t,i,n,r={}){this._checkLoaded();const o=this._checkLayer(t);if(o&&!e.bx(o.getLayoutProperty(i),n)){if(null!=n&&(!r||!1!==r.validate)&&wn(o,Pe.call(ve,{key:`layers.${t}.layout.${i}`,layerType:o.type,objectKey:i,value:n,styleSpec:e.a6,style:{glyphs:!0,sprite:!0}})))return;o.setLayoutProperty(i,n),0!==o.expressionDependencies.configDependencies.size&&this._configDependentLayers.add(o.fqid),o.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(o.fqid),this._updateLayer(o)}}setLayerProperty(e,t,i,n={}){this._checkLoaded();const r=this._checkLayer(e);r&&("appearances"===t?(r.setAppearances(i),this._changes.setDirty()):r.isPaintProperty(t)?this.setPaintProperty(e,t,i,n):this.setLayoutProperty(e,t,i,n))}getLayoutProperty(e,t){const i=this._checkLayer(e);if(i)return i.getLayoutProperty(t)}setPaintProperty(t,i,n,r={}){this._checkLoaded();const o=this._checkLayer(t);if(!o)return;if(e.bx(o.getPaintProperty(i),n))return;if(null!=n&&(!r||!1!==r.validate)&&wn(o,Ce.call(ve,{key:`layers.${t}.paint.${i}`,layerType:o.type,objectKey:i,value:n,styleSpec:e.a6})))return;const s=o.setPaintProperty(i,n);0!==o.expressionDependencies.configDependencies.size&&this._configDependentLayers.add(o.fqid),o.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(o.fqid),s&&this._updateLayer(o),this._changes.updatePaintProperties(o)}getPaintProperty(e,t){const i=this._checkLayer(e);if(i)return i.getPaintProperty(t)}setFeatureState(t,i){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:e,importId:n}=t.target,r=this.getFragmentStyle(n),o=r.getFeaturesetLayers(e);for(const{source:e,sourceLayer:n}of o)r.setFeatureState({id:t.id,source:e,sourceLayer:n},i)}else if("layerId"in t.target){const{layerId:e}=t.target,n=this.getLayer(e);this.setFeatureState({id:t.id,source:n.source,sourceLayer:n.sourceLayer},i)}return}const n=t.source,r=t.sourceLayer,o=this._checkSource(n);if(!o)return;const s=o.type;if("geojson"===s&&r)return void this.fire(new e.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===s&&!r)return void this.fire(new e.y(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===t.id&&this.fire(new e.y(new Error("The feature id parameter must be provided.")));const a=this.getOwnSourceCaches(n);for(const e of a)e.setFeatureState(r,t.id,i)}removeFeatureState(t,i){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:e,importId:n}=t.target,r=this.getFragmentStyle(n),o=r.getFeaturesetLayers(e);for(const{source:e,sourceLayer:n}of o)r.removeFeatureState({id:t.id,source:e,sourceLayer:n},i)}else if("layerId"in t.target){const{layerId:e}=t.target,n=this.getLayer(e);this.removeFeatureState({id:t.id,source:n.source,sourceLayer:n.sourceLayer},i)}return}const n=t.source,r=this._checkSource(n);if(!r)return;const o=r.type,s="vector"===o?t.sourceLayer:void 0;if("vector"===o&&!s)return void this.fire(new e.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(i&&"string"!=typeof t.id&&"number"!=typeof t.id)return void this.fire(new e.y(new Error("A feature id is required to remove its specific state property.")));const a=this.getOwnSourceCaches(n);for(const e of a)e.removeFeatureState(s,t.id,i)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let i;if("featuresetId"in t.target){const{featuresetId:n,importId:r}=t.target,o=this.getFragmentStyle(r),s=o.getFeaturesetLayers(n);for(const{source:n,sourceLayer:r}of s){const s=o.getFeatureState({id:t.id,source:n,sourceLayer:r});if(s&&!i)i=s;else if(!e.bx(i,s))return void this.fire(new e.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:e}=t.target,n=this.getLayer(e);i=this.getFeatureState({id:t.id,source:n.source,sourceLayer:n.sourceLayer})}return i}const i=t.source,n=t.sourceLayer,r=this._checkSource(i);if(r){if("vector"!==r.type||n)return void 0===t.id&&this.fire(new e.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(i)[0].getFeatureState(n,t.id);this.fire(new e.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(e){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,e),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),i=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return e.du({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:i,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(e=>void 0!==e))}_updateFilteredLayers(e){for(const t of Object.values(this._mergedLayers))e(t)&&this._updateLayer(t)}_updateLayer(t){this._changes.updateLayer(t);const i=this.getLayerSourceCache(t),n=e.B(t.source,t.scope),r=this._changes.getUpdatedSourceCaches();t.source&&!r[n]&&i&&"raster"!==i.getSource().type&&(this._changes.updateSourceCache(n,"reload"),i.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(e){const t=e=>this._mergedLayers[e].is3D(!!this.terrain),i=this.order,n={},r=[];for(let o=i.length-1;o>=0;o--){const s=i[o];if(t(s)){n[s]=o;for(const t of e){const e=t[s];if(e)for(const t of e)r.push(t)}}}r.sort(((e,t)=>t.intersectionZ-e.intersectionZ));const o=[];for(let s=i.length-1;s>=0;s--){const a=i[s];if(t(a))for(let e=r.length-1;e>=0;e--){const t=r[e].feature;if(t.layer&&n[t.layer.id]<s)break;o.push(t),r.pop()}else for(const t of e){const e=t[a];if(e)for(const t of e)o.push(t.feature)}}return o}queryRasterValue(t,i,n){const r=this.getOwnSource(t);return r?"raster-array"!==r.type?(this.fire(new e.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):r.queryRasterArrayValue(i,n):(this.fire(new e.y(new Error(`Source with id "${t}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(t,i,n){let r;i&&!Array.isArray(i)&&i.filter&&(this._validate(Ie,"queryRenderedFeatures.filter",i.filter,null,i),r=e.b5(i.filter));const o={},s=e=>{if(An.has(e.type))return;const t=this.getOwnLayerSourceCache(e),i=o[t.id]=o[t.id]||{sourceCache:t,layers:{},has3DLayers:!1};e.is3D(!!this.terrain)&&(i.has3DLayers=!0),i.layers[e.fqid]=i.layers[e.fqid]||{styleLayer:e,targets:[]},i.layers[e.fqid].targets.push({filter:r})};if(i&&i.layers){if(!Array.isArray(i.layers))return this.fire(new e.y(new Error("parameters.layers must be an Array."))),[];for(const t of i.layers){const i=this._layers[t];if(!i)return this.fire(new e.y(new Error(`The layer '${t}' does not exist in the map's style and cannot be queried for features.`))),[];s(i)}}else for(const e in this._layers)s(this._layers[e]);const a=this._queryRenderedFeatures(t,o,n),l=this._flattenAndSortRenderedFeatures(a),c=[];for(const t of l)e.dv(t.layer.id)===this.scope&&c.push(t);return c}queryRenderedFeatureset(t,i,n){let r;i&&!Array.isArray(i)&&i.filter&&(this._validate(Ie,"queryRenderedFeatures.filter",i.filter,null,i),r=e.b5(i.filter));const o="mock",s=[];if(i&&i.target)s.push(Object.assign({},i,{targetId:o,filter:r}));else{const e=this.getFeaturesetDescriptors();for(const t of e)s.push({targetId:o,filter:r,target:t});for(const{style:e}of this.fragments){const t=e.getFeaturesetDescriptors();for(const e of t)s.push({targetId:o,filter:r,target:e})}}const a=this.queryRenderedTargets(t,s,n),l=[],c=new Set;for(const t of a)for(const i of t.variants[o])mt(i,t,c)||l.push(new e.dw(t,i));return l}queryRenderedTargets(t,i,n){const r={},o=(e,t,i,n)=>{const o=r[t.id]=r[t.id]||{sourceCache:t,layers:{},has3DLayers:!1};if(o.layers[e.fqid]=o.layers[e.fqid]||{styleLayer:e,targets:[]},e.is3D(!!this.terrain)&&(o.has3DLayers=!0),!n)return i.uniqueFeatureID=!1,void o.layers[e.fqid].targets.push(i);o.layers[e.fqid].targets.push(Object.assign({},i,{namespace:n.namespace,properties:n.properties,uniqueFeatureID:n.uniqueFeatureID}))};for(const t of i)if("featuresetId"in t.target){const{featuresetId:i,importId:n}=t.target,r=this.getFragmentStyle(n);if(!r||!r._featuresetSelectors)continue;const s=r._featuresetSelectors[i];if(!s){this.fire(new e.y(new Error(`The featureset '${i}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const e of s){const i=r.getOwnLayer(e.layerId);i&&!An.has(i.type)&&o(i,r.getOwnLayerSourceCache(i),t,e)}}else if("layerId"in t.target){const{layerId:e}=t.target,i=this.getLayer(e);if(!i||An.has(i.type))continue;o(i,this.getLayerSourceCache(i),t)}const s=this._queryRenderedFeatures(t,r,n);return this._flattenAndSortRenderedFeatures(s)}_queryRenderedFeatures(e,t,i){const n=[],r=!!this.map._showQueryGeometry,o=tt.createFromScreenPoints(e,i);for(const e in t){const s=gt(o,t[e],this._availableImages,i,r);Object.keys(s).length&&n.push(s)}if(this.placement)for(const e in t){if(!t[e].sourceCache._onlySymbols)continue;const i=_t(o.screenGeometry,t[e],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(i).length&&n.push(i)}return n}querySourceFeatures(e,t){const i=t&&t.filter;i&&this._validate(Ie,"querySourceFeatures.filter",i,null,t);let n=[];const r=this.getOwnSourceCaches(e);for(const e of r)n=n.concat(yt(e,t));return n}addSourceType(e,t,i){return Cn.getSourceType(e)?i(new Error(`A source type called "${e}" already exists.`)):(Cn.setSourceType(e,t),t.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:e,url:t.workerSourceURL},i):i(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,i,n={}){this._checkLoaded();const r=this.light.getLight();let o=!1;for(const i in t)if(!e.bx(t[i],r[i])){o=!0;break}if(!o)return;const s=this._getTransitionParameters();this.light.setLight(t,i,n),this.light.updateTransitions(s)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=e.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&e.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,i=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===i&&delete this.terrain,null===t?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let n=t;const r=null==t.source;if(1===i){if(this.disableElevatedTerrain)return;if("object"==typeof n.source){const t="terrain-dem-src";this.addSource(t,n.source),n=e.dn(n),n=Object.assign(n,{source:t})}const t=Object.assign({},n),i={};if(this.terrain&&r){t.source=this.terrain.get().source;const e=this.terrain?this.getFragmentStyle(this.terrain.scope):null;e&&(i.style=e.serialize())}if(this._validate(we,"terrain",t,i))return}if(!this.terrain||this.terrain.scope!==this.scope&&!r||this.terrain&&i!==this.terrain.drapeRenderMode){if(!n)return;this._createTerrain(n,i),this.fire(new e.z("data",{dataType:"style"}))}else{const i=this.terrain,r=i.get();for(const t of Object.keys(e.a6.terrain))!n.hasOwnProperty(t)&&e.a6.terrain[t].default&&(n[t]=e.a6.terrain[t].default);for(const n in t)if(!e.bx(t[n],r[n])){i.set(t,this.options),this.stylesheet.terrain=t;const n=this._getTransitionParameters({duration:0});i.updateTransitions(n),this.fire(new e.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(e){const t=this.fog=new qe(e,this.map.transform,this.scope,this.options);this.stylesheet.fog=t.get();const i=this._getTransitionParameters({duration:0});t.updateTransitions(i)}_createSnow(e){const t=this.snow=new Ke(e,this.map.transform,this.scope,this.options);this.stylesheet.snow=t.get();const i=this._getTransitionParameters({duration:0});t.updateTransitions(i)}_createRain(e){const t=this.rain=new Qe(e,this.map.transform,this.scope,this.options);this.stylesheet.rain=t.get();const i=this._getTransitionParameters({duration:0});t.updateTransitions(i)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const e of this.map._markers)e._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const i=this.fog;if(!e.bx(i.get(),t)){i.set(t,this.options),this.stylesheet.fog=i.get();const e=this._getTransitionParameters({duration:0});i.updateTransitions(e)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const i=this.snow;if(!e.bx(i.get(),t)){i.set(t,this.options),this.stylesheet.snow=i.get();const e=this._getTransitionParameters({duration:0});i.updateTransitions(e)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const i=this.rain;if(!e.bx(i.get(),t)){i.set(t,this.options),this.stylesheet.rain=i.get();const e=this._getTransitionParameters({duration:0});i.updateTransitions(e)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const e in this._layers)this._layers[e].lut=this._styleColorTheme.lut;for(const e in this._sourceCaches)this._sourceCaches[e].clearTiles()},i=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!i)return this._styleColorTheme.lut=null,void t();const n=this._evaluateColorThemeData(i);this._loadColorTheme(n).then((()=>{this.fire(new e.z("colorthemeset")),t()})).catch((t=>{e.w(`Couldn't set color theme: ${t}`)}))}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&e.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(e,t){const i=this.getFragmentStyle(e);i&&(i._styleColorTheme.colorThemeOverride=t,i._reloadColorTheme())}_getTransitionParameters(t){return{now:e.o.now(),transition:Object.assign(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const e=[],t=[];for(const i of this._mergedOrder)this.isLayerDraped(this._mergedLayers[i])?e.push(i):t.push(i);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...e),this._drapedFirstOrder.push(...t)}_createTerrain(e,t){const i=this.terrain=new ke(e,t,this.scope,this.options,this.map.getWorldview());1===t&&(this.stylesheet.terrain=e),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const n=this._getTransitionParameters({duration:0});i.updateTransitions(n)}_force3DLayerUpdate(){for(const e in this._layers){const t=this._layers[e];"fill-extrusion"===t.type&&this._updateLayer(t)}}_forceSymbolLayerUpdate(){for(const e in this._layers){const t=this._layers[e];"symbol"===t.type&&this._updateLayer(t)}}_validate(t,i,n,r,o={}){if(o&&!1===o.validate)return!1;const s=Object.assign({},this.serialize());return wn(this,t.call(ve,Object.assign({key:i,style:s,value:n,styleSpec:e.a6},r)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),e.dx.off("pluginStateChange",this._rtlTextPluginCallback);for(const e in this._mergedLayers)this._mergedLayers[e].setEventedParent(null);for(const e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles(),this._mergedSourceCaches[e].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(e){const t=this.getSourceCaches(e);for(const e of t)e.clearTiles()}clearSources(){for(const e in this._mergedSourceCaches)this._mergedSourceCaches[e].clearTiles()}clearLayers(){for(const e in this._mergedLayers){const t=this._mergedLayers[e];t._clear&&t._clear()}}reloadSource(e){const t=this.getSourceCaches(e);for(const e of t)e.resume(),e.reload()}reloadSources(){for(const e of this.getSources())e.reload&&e.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((e=>{e.modelManager.reloadModels(e.scope)}))}updateSources(e){let t;this.directionalLight&&(t=fn(this.directionalLight));const i=new Set;for(const e in this._mergedLayers){const t=this._mergedLayers[e];t.hasElevation()&&!i.has(t.source)&&i.add(t.source)}for(const n in this._mergedSourceCaches){const r=this._mergedSourceCaches[n],o=i.has(r._source.id);r.update(e,void 0,void 0,t,o)}}_generateCollisionBoxes(){for(const e in this._sourceCaches){const t=this._sourceCaches[e];t.resume(),t.reload()}}_updatePlacement(t,i,n,r,o,s,a=!1){let l=!1,c=!1;const u={},h={};for(const t of this._mergedOrder){const n=this._mergedLayers[t];if("symbol"!==n.type)continue;const r=e.B(n.source,n.scope);let o=u[r];if(!o){const e=this.getLayerSourceCache(n);if(!e)continue;const t=e.getRenderableIds(!0).map((t=>e.getTileByID(t)));h[r]=t.slice(),o=u[r]=t.sort(((e,t)=>t.tileID.overscaledZ-e.tileID.overscaledZ||(e.tileID.isLessThan(t.tileID)?-1:1)))}const s=this.crossTileSymbolIndex.addLayer(n,o,i.center.lng,i.projection);l=l||s}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),a=a||this._layerOrderChanged||0===r,this._layerOrderChanged&&this.fire(new e.z("neworder")),(a||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(e.o.now(),i.zoom))&&(this.pauseablePlacement=new ki(i,this._mergedOrder,a,n,r,o,this.placement,this.fog&&i.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,u,h,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(e.o.now()),c=!0),l&&this.pauseablePlacement.placement.setStale()),c||l){this._buildingIndex.onNewFrame(i.zoom);for(let t=0;t<this._mergedOrder.length;t++){const i=this._mergedLayers[this._mergedOrder[t]];if("symbol"!==i.type)continue;const n=this.isLayerClipped(i);this.placement.updateLayerOpacities(i,u[e.B(i.source,i.scope)],t,n?s:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(e.o.now())}}_releaseSymbolFadeTiles(){for(const e in this._sourceCaches)this._sourceCaches[e].releaseSymbolFadeTiles()}addImport(t,i){this._checkLoaded();const n=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==n.findIndex((({id:e})=>e===t.id)))return void this.fire(new e.y(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!i)return n.push(t),this._loadImports([t],!0);const r=n.findIndex((({id:e})=>e===i));return-1===r&&this.fire(new e.y(new Error(`Import with id "${i}" does not exist on this map.`))),this.stylesheet.imports=n.slice(0,r).concat(t).concat(n.slice(r)),this._loadImports([t],!0,i)}updateImport(t,i){this._checkLoaded();const n=this.stylesheet.imports||[],r=this.getImportIndex(t);return-1===r?this:"string"==typeof i?(this.setImportUrl(t,i),this):(i.url&&i.url!==n[r].url&&this.setImportUrl(t,i.url),e.bx(i.config,n[r].config)||this.setImportConfig(t,i.config,i.data.schema),e.bx(i.data,n[r].data)||this.setImportData(t,i.data),this)}moveImport(e,t){this._checkLoaded();let i=this.stylesheet.imports||[];const n=this.getImportIndex(e);if(-1===n)return this;const r=this.getImportIndex(t);if(-1===r)return this;const o=i[n],s=this.fragments[n];return i=i.filter((({id:t})=>t!==e)),this.fragments=this.fragments.filter((({id:t})=>t!==e)),this.stylesheet.imports=i.slice(0,r).concat(o).concat(i.slice(r)),this.fragments=this.fragments.slice(0,r).concat(s).concat(this.fragments.slice(r)),this.mergeLayers(),this}setImportUrl(e,t){this._checkLoaded();const i=this.stylesheet.imports||[],n=this.getImportIndex(e);if(-1===n)return this;i[n].url=t;const r=this.fragments[n];return r.style=this._createFragmentStyle(i[n]),r.style.on("style.import.load",(()=>this.mergeAll())),r.style.loadURL(t),this}setImportData(e,t){this._checkLoaded();const i=this.getImportIndex(e),n=this.stylesheet.imports||[];return-1===i?this:t?(this.fragments[i].style.setState(t),this._reloadImports(),this):(delete n[i].data,this.setImportUrl(e,n[i].url))}setImportConfig(e,t,i){this._checkLoaded();const n=this.getImportIndex(e),r=this.stylesheet.imports||[];if(-1===n)return this;t?r[n].config=t:delete r[n].config;const o=this.fragments[n];i&&o.style.stylesheet&&(o.style.stylesheet.schema=i);const s=o.style.stylesheet&&o.style.stylesheet.schema;return o.config=t,o.style.updateConfig(t,s),this.updateConfigDependencies(),this}removeImport(e){this._checkLoaded();const t=this.stylesheet.imports||[],i=this.getImportIndex(e);-1!==i&&(t.splice(i,1),this.fragments[i].style._remove(),this.fragments.splice(i,1),this._reloadImports())}getImportIndex(t){const i=(this.stylesheet.imports||[]).findIndex((e=>e.id===t));return-1===i&&this.fire(new e.y(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),i}getLayer(e){return this._mergedLayers[e]}getSources(){const e=[];for(const t in this._mergedOtherSourceCaches){const i=this._mergedOtherSourceCaches[t];i&&e.push(i.getSource())}return e}getSource(e,t){const i=this.getSourceCache(e,t);return i&&i.getSource()}getLayerSource(e){const t=this.getLayerSourceCache(e);return t&&t.getSource()}getSourceCache(t,i){const n=e.B(t,i);return this._mergedOtherSourceCaches[n]}getLayerSourceCache(t){const i=e.B(t.source,t.scope);return"symbol"===t.type?this._mergedSymbolSourceCaches[i]:this._mergedOtherSourceCaches[i]}getSourceCaches(e){if(null==e)return Object.values(this._mergedSourceCaches);const t=[];return this._mergedOtherSourceCaches[e]&&t.push(this._mergedOtherSourceCaches[e]),this._mergedSymbolSourceCaches[e]&&t.push(this._mergedSymbolSourceCaches[e]),t}updateSourceCaches(){const e=this._changes.getUpdatedSourceCaches();for(const t in e){const i=e[t];"reload"===i?this.reloadSource(t):"clear"===i&&this.clearSource(t)}}updateLayers(e){const t=this._changes.getUpdatedPaintProperties();for(const i of t){const t=this.getLayer(i);t&&t.updateTransitions(e)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(e){this.stylesheet.glyphs=e,this.glyphManager.setURL(e)}getImages(t,i,n){this.imageManager.getImages(i.images,i.scope,n),this._updateTilesForChangedImages();const r=t=>{if(t){const n=i.images.map((t=>e.I.toString(t)));t.setDependencies(i.tileID.key,i.type,n)}},o=e.B(i.source,i.scope);r(this._mergedOtherSourceCaches[o]),r(this._mergedSymbolSourceCaches[o]),i.images.some((e=>e.iconsetId))&&this.fire(new e.z("data",{dataType:"style"}))}rasterizeImages(e,t,i){this.imageManager.rasterizeImages(t,i)}getGlyphs(e,t,i){this.glyphManager.getGlyphs(t.stacks,i)}getResource(t,i,n){return e.dy(i,n)}getOwnSourceCache(e){return this._otherSourceCaches[e]}getOwnLayerSourceCache(e){return"symbol"===e.type?this._symbolSourceCaches[e.source]:this._otherSourceCaches[e.source]}getOwnSourceCaches(e){const t=[];return this._otherSourceCaches[e]&&t.push(this._otherSourceCaches[e]),this._symbolSourceCaches[e]&&t.push(this._symbolSourceCaches[e]),t}_isSourceCacheLoaded(t){const i=this.getOwnSourceCaches(t);return 0===i.length?(this.fire(new e.y(new Error(`There is no source with ID '${t}'`))),!1):i.every((e=>e.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(e,t){if(!this._clipLayerPresent&&"fill-extrusion"!==e.type&&"building"!==e.type)return!1;const i="fill-extrusion"===e.type&&("building"===e.sourceLayer||"procedural_buildings"===e.sourceLayer),n="building"===e.type;if(e.is3D(!!this.terrain)){if(i||n||t&&"batched-model"===t.type)return!0;if("model"===e.type)return!0}else if("symbol"===e.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((e=>{e.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Cn.getSourceType=function(e){return dt[e]},Cn.setSourceType=function(e,t){dt[e]=t},Cn.registerForPluginStateChange=e.dz;class Pn extends e.E{constructor(t){super(),this._style=t,this._buildings={},this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},e.aX(["_updateUI"],this)}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null}selectFloor(e){e===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=e,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(e){this._activeFloorsVisible=e,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(e){for(const[t,i]of Object.entries(e.buildings))if(this._buildings[t])for(const e of i.floorIds)this._buildings[t].floors[e]||(this._buildings[t].floors[e]=i.floors[e]);else this._buildings[t]=i;for(const t of e.activeFloors)this._activeFloors.add(t);this._updateIndoorSelector()}getIndoorTileOptions(e,t){const i=this._style.getIndoorSourceLayers(e,t);return i&&this._indoorState?{sourceLayers:i,indoorState:this._indoorState}:null}_updateUI(t,i,n){const r=function(t,i,n,r){let o=null,s=Number.MAX_SAFE_INTEGER;if(r<16)return null;for(const[r,a]of Object.entries(t)){const t=a.center;if(t){const a=i.distanceTo(e.aS.convert(t));a<s&&n.contains(t)&&(s=a,o=r)}}return o}(this._buildings,i,n,t);r!==this._closestBuildingId&&(this._closestBuildingId=r,this._updateIndoorSelector())}_updateIndoorSelector(){const t=this._buildings,i=this._closestBuildingId,n=i&&t?t[i]:void 0;if(!n)return void this.fire(new e.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));let r=null;for(const e of n.floorIds)if(this._activeFloors&&this._activeFloors.has(e)){r=e;break}const o=Array.from(n.floorIds).map((e=>({id:e,name:n.floors[e].name,zIndex:n.floors[e].zIndex}))).sort(((e,t)=>t.zIndex-e.zIndex));this.fire(new e.z("selector-update",{selectedFloorId:r,activeFloorsVisible:this._activeFloorsVisible,floors:o}))}_updateActiveFloors(){const e=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:e,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}var Ln="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",Rn="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",On="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}\n#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer\n#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib\n#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib\n#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib\n#define DECLARE_MATERIAL_TABLE_INFO\n#endif",Dn="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Bn="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\nint NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;\n#ifdef CLIP_ZERO_TO_ONE\ncoord.z=-1.0+2.0*coord.z; \n#endif\nhighp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",Fn="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",Nn="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",kn="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",Un="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",zn="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",Vn="#ifdef RENDER_SHADOWS\nprecision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {\n#ifdef CLIP_ZERO_TO_ONE\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);\n#else\nhighp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);\n#endif\nreturn texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;\n#ifdef SHADOWS_SINGLE_CASCADE\nvec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);\n#else\nlight_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const Gn=[];Xn(Ln,Gn),Xn(On,Gn),Xn(Rn,Gn);const jn={"_prelude_fog.vertex.glsl":Fn,"_prelude_terrain.vertex.glsl":Bn,"_prelude_shadow.vertex.glsl":zn,"_prelude_material_table.vertex.glsl":"#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer\n#define MATERIAL_TABLE_DEBUG 0\nuniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;\n#if MATERIAL_TABLE_DEBUG\nvec4 colorDebug;\n#endif\n};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { \nif (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; \n}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { \niRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;\n#if MATERIAL_TABLE_DEBUG\nconst vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;\n#endif\nuint offset=0u;\n#if MATERIAL_TABLE_DEBUG\nbool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}\n#endif\noffset++;\n#if MATERIAL_TABLE_DEBUG\nuint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}\n#endif\noffset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}\n#endif\nuint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding)\n{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}\n#endif\noffset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;\n#if MATERIAL_TABLE_DEBUG\nif(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}\n#endif\ninfo.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)\n{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}\n#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)\n#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)\n#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)\n#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));\n#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;\n#endif","_prelude_fog.fragment.glsl":Nn,"_prelude_shadow.fragment.glsl":Vn,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":kn,"_prelude_raster_particle.glsl":Un},Hn={};Yn("",Bn),Yn(Nn,Fn),Yn(Vn,zn),Yn(kn,""),Yn(Un,"");const $n=Yn(Rn,On),Wn=Ln;var qn={background:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),building:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nconst float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nin lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;\n#endif\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef FLOOD_LIGHT\nin highp float v_flood_radius;in float v_has_flood_light;\n#endif\nuniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}\n#ifdef BUILDING_FAUX_FACADE\nfloat hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;\n#if 0\nif (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;\n#else\nif (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;\n#endif\nreturn out_color;}\n#endif\nvec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;\n#ifdef BUILDING_FAUX_FACADE\nif (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}\n#endif\nvec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;\n#ifdef RENDER_SHADOWS\nshadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nshadowed_lighting_factor=dot(normal,u_lighting_directional_dir);\n#endif\ncolor.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);\n#ifdef FLOOD_LIGHT\nfloat flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);\n#endif\ncolor.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));\n#endif\ncolor*=u_opacity;\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_pos.z);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color; \n#ifdef DEBUG_SHOW_NORMALS\ncolor.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;\n#ifdef BUILDING_FAUX_FACADE\nout lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\n#ifdef FLOOD_LIGHT\nout highp float v_flood_radius;out float v_has_flood_light;\n#endif\nconst float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#ifdef BUILDING_FAUX_FACADE\nmat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}\n#endif\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive\nvoid main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive\n#ifdef FLOOD_LIGHT\nv_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);\n#endif\nvec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;\n#ifdef BUILDING_FAUX_FACADE\nv_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}\n#endif\nv_pos=a_pos_3f;\n#ifdef RENDER_CUTOFF\nvec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=v_pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(v_pos);\n#endif\ngl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}'),buildingBloom:Yn("in vec4 v_color_emissive;\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\nfloat saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;\n#ifdef HAS_ATTRIBUTE_a_bloom_attenuation\nfloat distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);\n#endif\nglFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}","in vec3 a_pos_3f;\n#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive\n#pragma mapbox: define-attribute highp vec4 bloom_attenuation\nout vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive\n#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation\n#ifdef HAS_ATTRIBUTE_a_part_color_emissive\nvec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);\n#else\nv_color_emissive=vec4(1.0);\n#endif\ngl_Position=u_matrix*vec4(a_pos_3f,1.0);}"),buildingDepth:Yn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:Yn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Yn('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:Yn("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Yn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;\n#endif\nout float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);\n#ifdef PROJECTION_GLOBE_VIEW\n#ifndef PROJECTED_POS_ON_VIEWPORT\nvec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);\n#endif\n#endif\nvec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:Yn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Yn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:Yn("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Yn("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#else\n#ifdef FEATURE_CUTOUT\napply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);\n#endif\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)\n{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nvec3 color=structure_color.xyz;\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,transformed_normal);\n#endif\ncolor=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#pragma mapbox: define highp vec4 structure_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 structure_color\nv_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef FLIP_Y\nv_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nuniform float u_emissive_strength;\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FLIP_Y\nv_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;\n#else\nv_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;out highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\n#ifdef FILL_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;v_road_z_offset=z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\n#ifdef FEATURE_CUTOUT\ncolor=apply_feature_cutout(color,gl_FragCoord);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);\n#ifdef CLIP_ZERO_TO_ONE\ncutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);\n#else\ncutoff=cutoff_opacity(u_cutoff_params,ground.z);\n#endif\nif (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:Yn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_material_table.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {DECLARE_MATERIAL_TABLE_INFO\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef FILL_EXTRUSION_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:Yn('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:Yn("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:Yn("precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef LINE_PATTERN_TRANSITION\nuniform float u_pattern_transition;\n#endif\nin vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\n#ifdef LINE_PATTERN_TRANSITION\nvec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: define mediump vec4 pattern_b\n#endif\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#ifdef LINE_PATTERN_TRANSITION\n#pragma mapbox: initialize mediump vec4 pattern_b\n#endif\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:Yn("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:Yn("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Yn('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Yn('#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nin highp float v_z_offset;\n#endif\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nout_color=applyLUT(u_lutTexture,out_color);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef TERRAIN\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#else\nout_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\n#ifdef FEATURE_CUTOUT\nout_color=apply_feature_cutout(out_color,gl_FragCoord);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#define APPEARANCE_ICON 1.0\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef ELEVATED_ROADS\nin vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#else\n#ifdef RENDER_SHADOWS\nout highp float v_z_offset;\n#endif\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance_icon=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance_icon==APPEARANCE_ICON) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;\n#else\nz+=u_pitch_with_map ? z_offset : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\n#ifdef Z_TEST_OCCLUSION\nout_fade_opacity*=occlusion_opacity;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\n#ifdef ELEVATED_ROADS\nvec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;\n#else\npos=vec3(projected_pos.xy/projected_pos.w+offset,z);\n#endif\n#endif\ngl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#else\n#ifdef RENDER_SHADOWS\nv_z_offset=e;\n#endif\n#endif\n}'),terrainRaster:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:Yn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:Yn('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Dn),skyboxGradient:Yn('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Dn),skyboxCapture:Yn("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;\n#ifdef FLIP_Y\nuv.y=1.0-uv.y;\n#endif\nhighp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:Yn('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:Yn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef FLIP_Y\ncoord.y=1.0-coord.y;\n#endif\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;\n#ifdef FLIP_Y\nT=-T;B=-B;\n#endif\nhighp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));\n#ifdef FLIP_Y\nn=normalize(cross(fdx,fdy));\n#else\nn=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\n#ifdef FEATURE_CUTOUT\nfinalColor=apply_feature_cutout(finalColor,gl_FragCoord);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#ifdef CLIP_ZERO_TO_ONE\nv_depth=-1.0+2.0*v_depth; \n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:Yn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:Yn("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:Yn("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:Yn("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:Yn("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Yn("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Xn(e,t){const i=e.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let e of i)if(e=e.trim(),"#"===e[0]&&e.includes("if")&&!e.includes("endif")){e=e.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const i=e.split(" ");for(const e of i)t.includes(e)||t.push(e)}}function Yn(e,t){const i=/#include\s+"([^"]+)"/g,n=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,r={},o=[],s=[];if(e=e.replace(i,((e,t)=>(s.push(t),""))),(t=t.replace(i,((e,t)=>(o.push(t),"")))).includes("flat out"))return;let a=[...Gn];Xn(e,a),Xn(t,a);for(const e of[...o,...s])Hn[e]||(Hn[e]=[],Xn(jn[e],Hn[e])),a=[...a,...Hn[e]];return{fragmentSource:e=e.replace(n,((e,t,i,n,o)=>(r[o]=!0,"define"===t?`\n#ifndef HAS_UNIFORM_u_${o}\nin ${i} ${n} ${o};\n#else\nuniform ${i} ${n} u_${o};\n#endif\n`:"initialize"===t?`\n#ifdef HAS_UNIFORM_u_${o}\n    ${i} ${n} ${o} = u_${o};\n#endif\n`:"define-attribute"===t?`\n#ifdef HAS_ATTRIBUTE_a_${o}\n    in ${i} ${n} ${o};\n#endif\n`:"initialize-attribute"===t?"":void 0))),vertexSource:t=t.replace(n,((e,t,i,n,o)=>{const s=`MATERIAL_ATTRIBUTE_OFFSET_${o}`,a="float"===n?"vec2":n,l=`GET_ATTRIBUTE_${a}(a_${o}, materialInfo, ${s})`,c=o.match(/color/)?"color":a;return"define-attribute-vertex-shader-only"===t?`\n#ifdef HAS_ATTRIBUTE_a_${o}\nin ${i} ${n} a_${o};\n#endif\n`:r[o]?"define"===t?`\n#ifndef HAS_UNIFORM_u_${o}\nuniform lowp float u_${o}_t;\n    #if !defined(${s})\n        in ${i} ${a} a_${o};\n    #endif\nout ${i} ${n} ${o};\n#else\nuniform ${i} ${n} u_${o};\n#endif\n`:"initialize"===t?"vec4"===c?`\n#ifndef HAS_UNIFORM_u_${o}\n    ${o} = a_${o};\n#else\n    ${i} ${n} ${o} = u_${o};\n#endif\n`:`\n#if !defined(HAS_UNIFORM_u_${o}) \n    #ifdef ${s}\n        ${o} = unpack_mix_${c}(${l}, u_${o}_t);\n    #else\n        ${o} = unpack_mix_${c}(a_${o}, u_${o}_t);\n    #endif\n#else\n    ${i} ${n} ${o} = u_${o};\n#endif\n`:"define-attribute"===t?`\n#ifdef HAS_ATTRIBUTE_a_${o}\n    in ${i} ${n} a_${o};\n    out ${i} ${n} ${o};\n#endif\n`:"initialize-attribute"===t?`\n#ifdef HAS_ATTRIBUTE_a_${o}\n    ${o} = a_${o};\n#endif\n`:void 0:"define"===t?`\n#ifndef HAS_UNIFORM_u_${o}\nuniform lowp float u_${o}_t;\n    #if !defined(${s})\n        in ${i} ${a} a_${o};\n    #endif  \n#else\nuniform ${i} ${n} u_${o};\n#endif\n`:"define-instanced"===t?"mat4"===c?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${o}0;\nin vec4 a_${o}1;\nin vec4 a_${o}2;\nin vec4 a_${o}3;\n#else\nuniform ${i} ${n} u_${o};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${i} ${a} a_${o};\n#else\nuniform ${i} ${n} u_${o};\n#endif\n`:"initialize-attribute-custom"===t?`\n#ifdef HAS_ATTRIBUTE_a_${o}\n    ${i} ${n} ${o} = a_${o};\n#endif\n`:"vec4"===c?`\n#ifndef HAS_UNIFORM_u_${o}\n    #ifdef ${s}\n        ${i} ${n} ${o} = ${l};\n    #else\n        ${i} ${n} ${o} = a_${o};\n    #endif\n#else\n    ${i} ${n} ${o} = u_${o};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${o}\n    #ifdef ${s}\n        ${i} ${n} ${o} = unpack_mix_${c}(${l}, u_${o}_t);\n    #else\n        ${i} ${n} ${o} = unpack_mix_${c}(a_${o}, u_${o}_t);\n    #endif\n#else\n    ${i} ${n} ${o} = u_${o};\n#endif\n`})),usedDefines:a,vertexIncludes:o,fragmentIncludes:s}}class Zn{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(e,t,i,n,r,o,s,a){this.context=e;let l=this.boundPaintVertexBuffers.length!==n.length;for(let e=0;!l&&e<n.length;e++)this.boundPaintVertexBuffers[e]!==n[e]&&(l=!0);let c=this.boundDynamicVertexBuffers.length!==s.length;for(let e=0;!c&&e<s.length;e++)this.boundDynamicVertexBuffers[e]!==s[e]&&(c=!0);if(!this.vao||this.boundProgram!==t||this.boundLayoutVertexBuffer!==i||l||c||this.boundIndexBuffer!==r||this.boundVertexOffset!==o)this.freshBind(t,i,n,r,o,s,a);else{e.bindVertexArrayOES.set(this.vao);for(const i of s)i&&(i.bind(),a&&i.instanceCount&&i.setVertexAttribDivisor(e.gl,t,a));r&&r.dynamicDraw&&r.bind()}}freshBind(e,t,i,n,r,o,s){const a=this.context,l=a.gl;this.vao&&this.destroy(),this.vao=a.gl.createVertexArray(),a.bindVertexArrayOES.set(this.vao),this.boundProgram=e,this.boundLayoutVertexBuffer=t,this.boundPaintVertexBuffers=i,this.boundIndexBuffer=n,this.boundVertexOffset=r,this.boundDynamicVertexBuffers=o,t.enableAttributes(l,e),t.bind(),t.setVertexAttribPointers(l,e,r);for(const t of i)t.enableAttributes(l,e),t.bind(),t.setVertexAttribPointers(l,e,r);for(const t of o)t&&(t.enableAttributes(l,e),t.bind(),t.setVertexAttribPointers(l,e,r),s&&t.instanceCount&&t.setVertexAttribDivisor(l,e,s));n&&n.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Jn(t,i){const n=Math.pow(2,i.canonical.z),r=i.canonical.y;return[new e.ae(0,r/n).toLngLat().lat,new e.ae(0,(r+1)/n).toLngLat().lat]}function Kn(t,i,n,r,o,s,a){const l=t.context,c=l.gl,u=n.hillshadeFBO;if(!u)return;t.prepareDrawTile();const h=t.isTileAffectedByFog(i),d=t.getOrCreateProgram("hillshade",{overrideFog:h});l.activeTexture.set(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,u.colorAttachment.get());const p=((t,i,n,r)=>{const o=n.paint.get("hillshade-shadow-color"),s="none"===n.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),a=n.paint.get("hillshade-highlight-color"),l="none"===n.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),c=n.paint.get("hillshade-accent-color"),u="none"===n.paint.get("hillshade-accent-color-use-theme").constantOr("default"),h=n.paint.get("hillshade-emissive-strength");let d=e.an(n.paint.get("hillshade-illumination-direction"));if("viewport"===n.paint.get("hillshade-illumination-anchor"))d-=t.transform.angle;else if(t.style&&t.style.enable3dLights()&&t.style.directionalLight){const i=t.style.directionalLight.properties.get("direction"),n=e.d3(i.x,i.y,i.z);d=e.an(n[1])}const p=!t.options.moving;return{u_matrix:r||t.transform.calculateProjMatrix(i.tileID.toUnwrapped(),p),u_image:0,u_latrange:Jn(0,i.tileID),u_light:[n.paint.get("hillshade-exaggeration"),d],u_shadow:o.toPremultipliedRenderColor(s?null:n.lut),u_highlight:a.toPremultipliedRenderColor(l?null:n.lut),u_emissive_strength:h,u_accent:c.toPremultipliedRenderColor(u?null:n.lut)}})(t,n,r,t.terrain?i.projMatrix:null);t.uploadCommonUniforms(l,d,i.toUnwrapped());const{tileBoundsBuffer:f,tileBoundsIndexBuffer:m,tileBoundsSegments:g}=t.getTileBoundsBuffers(n);d.draw(t,c.TRIANGLES,o,s,a,Ji.disabled,p,r.id,f,m,g)}function Qn(t,i,n){if(!i.needsDEMTextureUpload)return;const r=t.context,o=r.gl;r.pixelStoreUnpackPremultiplyAlpha.set(!1),i.demTexture=i.demTexture||t.getTileTexture(n.stride);const s=n.getPixels();i.demTexture?i.demTexture.update(s,{premultiply:!1}):i.demTexture=new e.T(r,s,o.R32F,{premultiply:!1}),i.needsDEMTextureUpload=!1}function er(t,i,n){const r=t.context,o=r.gl;if(!i.dem)return;const s=i.dem;if(r.activeTexture.set(o.TEXTURE1),Qn(t,i,s),!i.demTexture)return;i.demTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE);const a=s.dim;r.activeTexture.set(o.TEXTURE0);let l=i.hillshadeFBO;if(!l){const t=new e.T(r,{width:a,height:a,data:null},o.RGBA8);t.bind(o.LINEAR,o.CLAMP_TO_EDGE),l=i.hillshadeFBO=r.createFramebuffer(a,a,!0,"renderbuffer"),l.colorAttachment.set(t.texture)}r.bindFramebuffer.set(l.framebuffer),r.viewport.set([0,0,a,a]);const{tileBoundsBuffer:c,tileBoundsIndexBuffer:u,tileBoundsSegments:h}=t.getMercatorTileBoundsBuffers(),d=[];t.linearFloatFilteringSupported()&&d.push("TERRAIN_DEM_FLOAT_FORMAT"),t.getOrCreateProgram("hillshadePrepare",{defines:d}).draw(t,o.TRIANGLES,Wi.disabled,Xi.disabled,$i.unblended,Ji.disabled,((t,i)=>{const n=i.stride,r=e.bB();return e.cd(r,0,e.al,-e.al,0,0,1),e.bq(r,r,[0,-e.al,0]),{u_matrix:r,u_image:1,u_dimension:[n,n],u_zoom:t.overscaledZ}})(i.tileID,s),n.id,c,u,h),i.needsHillshadePrepare=!1}class tr{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(e){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ir extends tr{getDefault(){return e.ao.transparent.toNonPremultipliedRenderColor(null)}set(e){const t=this.current;(e.r!==t.r||e.g!==t.g||e.b!==t.b||e.a!==t.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class nr extends tr{getDefault(){return 1}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1)}}class rr extends tr{getDefault(){return 0}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1)}}class or extends tr{getDefault(){return[!0,!0,!0,!0]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class sr extends tr{getDefault(){return!0}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1)}}class ar extends tr{getDefault(){return 255}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1)}}class lr extends tr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(e){const t=this.current;(e.func!==t.func||e.ref!==t.ref||e.mask!==t.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1)}}class cr extends tr{getDefault(){const e=this.gl;return[e.KEEP,e.KEEP,e.KEEP]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1)}}class ur extends tr{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.current=e,this.dirty=!1}}class hr extends tr{getDefault(){return[0,1]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1)}}class dr extends tr{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.current=e,this.dirty=!1}}class pr extends tr{getDefault(){return this.gl.LESS}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1)}}class fr extends tr{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.BLEND):t.disable(t.BLEND),this.current=e,this.dirty=!1}}class mr extends tr{getDefault(){const e=this.gl;return[e.ONE,e.ZERO,e.ONE,e.ZERO]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.blendFuncSeparate(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class gr extends tr{getDefault(){return e.ao.transparent.toNonPremultipliedRenderColor(null)}set(e){const t=this.current;(e.r!==t.r||e.g!==t.g||e.b!==t.b||e.a!==t.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1)}}class _r extends tr{getDefault(){return this.gl.FUNC_ADD}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(e,e),this.current=e,this.dirty=!1)}}class yr extends tr{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this.current=e,this.dirty=!1}}class vr extends tr{getDefault(){return this.gl.BACK}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1)}}class xr extends tr{getDefault(){return this.gl.CCW}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1)}}let br=class extends tr{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}};class Tr extends tr{getDefault(){return this.gl.TEXTURE0}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1)}}class wr extends tr{getDefault(){const e=this.gl;return[0,0,e.drawingBufferWidth,e.drawingBufferHeight]}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1)}}class Er extends tr{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.current=e,this.dirty=!1}}class Sr extends tr{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindRenderbuffer(t.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class Ar extends tr{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindTexture(t.TEXTURE_2D,e),this.current=e,this.dirty=!1}}class Mr extends tr{getDefault(){return null}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Ir extends tr{getDefault(){return null}set(e){const t=this.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1}}class Cr extends tr{getDefault(){return null}set(e){this.gl&&(e!==this.current||this.dirty)&&(this.gl.bindVertexArray(e),this.current=e,this.dirty=!1)}}class Pr extends tr{getDefault(){return 4}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1}}class Lr extends tr{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1}}class Rr extends tr{getDefault(){return!1}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1}}class Or extends tr{constructor(e,t){super(e),this.context=e,this.parent=t}getDefault(){return null}}class Dr extends Or{setDirty(){this.dirty=!0}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class Br extends Or{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,this.attachment(),t.RENDERBUFFER,e),this.current=e,this.dirty=!1}}class Fr extends Or{attachment(){return this.gl.DEPTH_ATTACHMENT}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,this.attachment(),t.TEXTURE_2D,e,0),this.current=e,this.dirty=!1}}class Nr extends Br{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const kr=(e,t,i)=>({u_matrix:e,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:i}),Ur=(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m)=>({u_proj_matrix:Float32Array.from(e),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(n),u_merc_matrix:i,u_zoom_transition:r,u_merc_center:o,u_image0:0,u_frustum_tl:s,u_frustum_tr:a,u_frustum_br:l,u_frustum_bl:c,u_globe_pos:u,u_globe_radius:h,u_viewport:d,u_grid_matrix:m?Float32Array.from(m):new Float32Array(9),u_skirt_height:p,u_far_z_cutoff:f});function zr(e,t){return null!=e&&null!=t&&!(!e.hasData()||!t.hasData())&&null!=e.demTexture&&null!=t.demTexture&&e.tileID.key!==t.tileID.key}const Vr=new class{constructor(){this.operations={}}newMorphing(e,t,i,n,r){if(e in this.operations){const t=this.operations[e];t.to.tileID.key!==i.tileID.key&&(t.queued=i)}else this.operations[e]={startTime:n,phase:0,duration:r,from:t,to:i,queued:null}}getMorphValuesForProxy(e){if(!(e in this.operations))return null;const t=this.operations[e];return{from:t.from,to:t.to,phase:t.phase}}update(e){for(const t in this.operations){const i=this.operations[t];for(i.phase=(e-i.startTime)/i.duration;i.phase>=1||!this._validOp(i);)if(!this._nextOp(i,e)){delete this.operations[t];break}}}_nextOp(e,t){return!!e.queued&&(e.from=e.to,e.to=e.queued,e.queued=null,e.phase=0,e.startTime=t,!0)}_validOp(e){return e.from.hasData()&&e.to.hasData()}},Gr={0:null,1:"TERRAIN_VERTEX_MORPHING"};function jr(e,t,i){if(0===t)return 0;const n=t<1&&514===i?.25/t:1;return 6*Math.pow(1.5,22-e)*Math.max(t,1)*n}function Hr(e,t){const i=1<<e.z;return!t&&(0===e.x||e.x===i-1)||0===e.y||e.y===i-1}const $r=e=>({u_matrix:e});function Wr(t,i,n,r,o){if(o>0){const s=e.o.now(),a=(s-t.timeAdded)/o,l=i?(s-i.timeAdded)/o:-1,c=n.getSource(),u=r.coveringZoomLevel({tileSize:c.tileSize,roundZoom:c.roundZoom}),h=!i||Math.abs(i.tileID.overscaledZ-u)>Math.abs(t.tileID.overscaledZ-u),d=h&&t.refreshedUponExpiration?1:e.aA(h?a:1-l,0,1);return i?{opacity:1,mix:1-d,isFading:a<1}:{opacity:d,mix:0,isFading:a<1}}return{opacity:1,mix:0,isFading:!1}}class qr extends Ot{constructor(e){const t=pt("mock-dem",{type:"raster-dem",maxzoom:e.transform.maxZoom},e.style.dispatcher,e.style);super("mock-dem",t,!1),t.setEventedParent(this),this._sourceLoaded=!0}_loadTile(e,t){e.state="loaded",t(null)}}class Xr extends Ot{constructor(e){const t=pt("proxy",{type:"geojson",maxzoom:e.transform.maxZoom},e.style.dispatcher,e.style);super("proxy",t,!1),t.setEventedParent(this),this.map=this.getSource().map=e,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(e,t,i){if(e.freezeTileCoverage)return;this.transform=e;const n=e.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((t,i)=>{if(t[i.key]="",!this._tiles[i.key]){const t=new Ct(i,this._source.tileSize*i.overscaleFactor(),e.tileZoom,void 0,void 0,this._source.worldview);t.state="loaded",this._tiles[i.key]=t}return t}),{});for(const e in this._tiles)e in n||(this.freeFBO(e),this._tiles[e].unloadVectorData(),delete this._tiles[e])}freeFBO(e){const t=this.proxyCachedFBO[e];if(void 0!==t){const i=Object.values(t);this.renderCachePool.push(...i),delete this.proxyCachedFBO[e]}}deallocRenderCache(){this.renderCache.forEach((e=>e.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Yr extends e.aP{constructor(e,t,i){super(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y),this.proxyTileKey=t,this.projMatrix=i}}class Zr extends e.bU{constructor(t,i){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[n,r,o]=function(){const t=new e.bc,i=new e.b0,n=131;t.reserve(17161),i.reserve(33800);const r=e.al/128,o=e.al+r/2,s=o+r;for(let i=-r;i<s;i+=r)for(let n=-r;n<s;n+=r){const r=n<0||n>o||i<0||i>o?24575:0,s=e.aA(Math.round(n),0,e.al),a=e.aA(Math.round(i),0,e.al);t.emplaceBack(s+r,a)}const a=(e,t)=>{const r=t*n+e;i.emplaceBack(r+1,r,r+n),i.emplaceBack(r+n,r+n+1,r+1)};for(let e=1;e<129;e++)for(let t=1;t<129;t++)a(t,e);return[0,129].forEach((e=>{for(let t=0;t<130;t++)a(t,e),a(e,t)})),[t,i,32768]}(),s=t.context;this.gridBuffer=s.createVertexBuffer(n,e.be.members),this.gridIndexBuffer=s.createIndexBuffer(r),this.gridSegments=e.bf.simpleSegment(0,0,n.length,r.length),this.gridNoSkirtSegments=e.bf.simpleSegment(0,0,n.length,o),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Xr(i.map),this.orthoMatrix=e.bB(),e.cd(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,e.al,0,e.al,0,1);const a=s.gl;this._overlapStencilMode=new Xi({func:a.GEQUAL,mask:255},0,255,a.KEEP,a.KEEP,a.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=i,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new qr(i.map),this._pendingGroundEffectLayers=[]}set style(e){e.on("data",this._onStyleDataEvent.bind(this)),this._style=e,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(t,i,n){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const r=t.terrain.properties,o=0===t.terrain.drapeRenderMode,s=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=e.o.now();const a=t.terrain&&t.terrain.scope,l=r.get("source"),c=o?this._mockSourceCache:t.getSourceCache(l,a);if(!c)return void e.w(`Couldn't find terrain source "${l}".`);if(this.sourceCache=c,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=s?this.calculateExaggeration(i):r.get("exaggeration"),!i.projection.requiresDraping&&s&&0===this._exaggeration)return void this._disable();this.enabled=!0;const u=()=>{this.sourceCache.used&&e.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const t=this.getScaledDemTileSize();this.sourceCache.update(i,t,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,u(),this._initializing=!0),u(),i.updateElevation(!0,n),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(i),this._emptyDEMTextureDirty=!0,this._previousZoom=i.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const i=this._previousCameraAltitude,n=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=n;const r=null!=i?n-i:Number.MAX_VALUE;if(Math.abs(r)<2)return this._exaggeration;const o=t.zoom,s=this._style.terrain;if(!this._previousUpdateTimestamp)return s.getExaggeration(o);let a=o-this._previousZoom;const l=this._previousUpdateTimestamp;let c=o;null!=this._evaluationZoom&&(c=this._evaluationZoom,Math.abs(o-c)>.5&&(a=.5*(o-c+a)),a*r<0&&(c+=a)),this._evaluationZoom=c;const u=s.getExaggeration(c),h=u===s.getExaggeration(Math.max(0,c-.1));if(h&&Math.abs(u-this._exaggeration)<.01)return u;let d=Math.min(.1,.00375*(this._updateTimestamp-l));return(h||u<.1||Math.abs(a)<1e-4)&&(d=Math.min(.2,4*d)),e.ak(this._exaggeration,u,d)}resetTileLookupCache(e){this._findCoveringTileCache[e]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(e){"source"===e.dataType&&e.coord?this._clearRenderCacheForTile(e.sourceCacheId,e.coord):"style"===e.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const e in this._style._mergedSourceCaches)this._style._mergedSourceCaches[e].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((e=>e.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const e=2*this.proxySourceCache.getSource().tileSize;return[e,e]}set useVertexMorphing(e){this._useVertexMorphing=e}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const i=this.proxySourceCache,n=this.painter.transform;this._initializing&&(this._initializing=0===n._centerAltitude&&-1===this.getAtPointOrZero(e.ae.fromLngLat(n.center),-1),this._emptyDEMTextureDirty=!this._initializing);const r=this.proxyCoords=i.getIds().map((e=>{const t=i.getTileByID(e).tileID;return t.projMatrix=n.calculateProjMatrix(t.toUnwrapped()),t}));!function(t,i){const n=i.transform.pointCoordinate(i.transform.getCameraPoint()),r=new e.P(n.x,n.y);t.sort(((t,i)=>{if(i.overscaledZ-t.overscaledZ)return i.overscaledZ-t.overscaledZ;const n=new e.P(t.canonical.x+(1<<t.canonical.z)*t.wrap,t.canonical.y),o=new e.P(i.canonical.x+(1<<i.canonical.z)*i.wrap,i.canonical.y),s=r.mult(1<<t.canonical.z);return s.x-=.5,s.y-=.5,s.distSqr(n)-s.distSqr(o)}))}(r,this.painter);const o=this.proxyToSource||{};this.proxyToSource={},r.forEach((e=>{this.proxyToSource[e.key]={}})),this.terrainTileForTile={};const s=this._style._mergedSourceCaches;for(const e in s){const i=s[e];if(!i.used)continue;if(i!==this.sourceCache&&this.resetTileLookupCache(i.id),this._setupProxiedCoordsForOrtho(i,t[e],o),i.usedForTerrain)continue;const n=t[e];i.getSource().reparseOverscaled&&this._assignTerrainTiles(n)}this.proxiedCoords[i.id]=r.map((e=>new Yr(e,e.key,this.orthoMatrix))),this._assignTerrainTiles(r),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(o),this.renderingToTexture=!1;const a={};this._visibleDemTiles=[];for(const e of this.proxyCoords){const t=this.terrainTileForTile[e.key];if(!t)continue;const i=t.tileID.key;i in a||(this._visibleDemTiles.push(t),a[i]=i)}}_assignTerrainTiles(e){this._initializing||e.forEach((e=>{if(this.terrainTileForTile[e.key])return;const t=this._findTileCoveringTileID(e,this.sourceCache);t&&(this.terrainTileForTile[e.key]=t)}))}_prepareDEMTextures(){const e=this.painter.context,t=e.gl;for(const i in this.terrainTileForTile){const n=this.terrainTileForTile[i],r=n.dem;!r||n.demTexture&&!n.needsDEMTextureUpload||(e.activeTexture.set(t.TEXTURE1),Qn(this.painter,n,r))}}_prepareDemTileUniforms(e,t,i,n){if(!t||null==t.demTexture)return!1;const r=e.tileID.canonical,o=Math.pow(2,t.tileID.canonical.z-r.z),s=n||"";return i[`u_dem_tl${s}`]=[r.x*o%1,r.y*o%1],i[`u_dem_scale${s}`]=o,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let e=0;const t=this._visibleDemTiles.reduce(((t,i)=>{if(!i.dem)return t;const n=i.dem.tree.minimums[0];return n>0&&e++,t+n}),0);return e?t/e:0}_updateEmptyDEMTexture(){const t=this.painter.context,i=t.gl;t.activeTexture.set(i.TEXTURE2);const n=this._getLoadedAreaMinimum(),r=new e.dK({width:1,height:1},new Float32Array([n]));this._emptyDEMTextureDirty=!1;let o=this._emptyDEMTexture;return o?o.update(r,{premultiply:!1}):o=this._emptyDEMTexture=new e.T(t,r,i.R32F,{premultiply:!1}),o}setupElevationDraw(t,i,n){const r=this.painter.context,o=r.gl,s={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};s.u_exaggeration=this.exaggeration();let a=null,l=null,c=1;if(n&&n.morphing&&this._useVertexMorphing){const e=n.morphing.srcDemTile,i=n.morphing.dstDemTile;c=n.morphing.phase,e&&i&&(this._prepareDemTileUniforms(t,e,s,"_prev")&&(l=e),this._prepareDemTileUniforms(t,i,s)&&(a=i))}const u=e=>e&&e.demTexture&&this.painter.linearFloatFilteringSupported()?o.LINEAR:o.NEAREST;let h=null;var d;if(this.enabled?l&&a?(h=a.demTexture,r.activeTexture.set(o.TEXTURE4),l.demTexture.bind(u(l),o.CLAMP_TO_EDGE),s.u_dem_lerp=c):(a=this.terrainTileForTile[t.tileID.key],h=this._prepareDemTileUniforms(t,a,s)?a.demTexture:this.emptyDEMTexture):h=this.emptyDEMTexture,r.activeTexture.set(o.TEXTURE2),h&&(s.u_dem_size=1===(d=h).size[0]?1:d.size[0]-2,h.bind(u(a),o.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(n&&n.useDepthForOcclusion,i,s),n&&n.useMeterToDem&&a){const t=(1<<a.tileID.canonical.z)*e.ce(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;s.u_meter_to_dem=t}if(n&&n.labelPlaneMatrixInv&&(s.u_label_plane_matrix_inv=n.labelPlaneMatrixInv),i.setTerrainUniformValues(r,s),"globe"===this.painter.transform.projection.name){const e=this.globeUniformValues(this.painter.transform,t.tileID.canonical,n&&n.useDenormalizedUpVectorScale);i.setGlobeUniformValues(r,e)}}globeUniformValues(t,i,n){const r=t.projection;return{u_tile_tl_up:r.upVector(i,0,0),u_tile_tr_up:r.upVector(i,e.al,0),u_tile_br_up:r.upVector(i,e.al,e.al),u_tile_bl_up:r.upVector(i,0,e.al),u_tile_up_scale:n?e.dL(1):r.upVectorScale(i,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const i=this.painter,n=this.painter.context;0!==t.length&&(n.bindFramebuffer.set(null),n.viewport.set([0,0,i.width,i.height]),i.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(t,i,n,r,o){if("globe"===t.transform.projection.name)!function(t,i,n,r,o){const s=t.context,a=s.gl;let l,c;const u=t.transform,h=e.dD(t,s,u),d=(e,i)=>{if(c===i)return;const n=[Gr[i],"PROJECTION_GLOBE_VIEW"];h&&n.push("CUSTOM_ANTIALIASING");const r=t.isTileAffectedByFog(e);l=t.getOrCreateProgram("globeRaster",{defines:n,overrideFog:r}),c=i},p=t.colorModeForRenderPass(),f=new Wi(a.LEQUAL,Wi.ReadWrite,t.depthRangeFor3D);Vr.update(o);const m=e.dE(u),g=[e.aF(u.center.lng),e.aJ(u.center.lat)],_=t.globeSharedBuffers,y=[u.width*e.o.devicePixelRatio,u.height*e.o.devicePixelRatio],v=Float32Array.from(u.globeMatrix),x={useDenormalizedUpVectorScale:!0};{const u=t.transform,h=jr(u.zoom,i.exaggeration(),i.sourceCache._source.tileSize);c=-1;const b=a.TRIANGLES;for(const c of r){const r=n.getTile(c),T=Xi.disabled,w=i.prevTerrainTileForTile[c.key],E=i.terrainTileForTile[c.key];zr(w,E)&&Vr.newMorphing(c.key,w,E,o,250),s.activeTexture.set(a.TEXTURE0),r.texture&&r.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE);const S=Vr.getMorphValuesForProxy(c.key),A=S?1:0;S&&Object.assign(x,{morphing:{srcDemTile:S.from,dstDemTile:S.to,phase:e.dC(S.phase)}});const M=e.dF(c.canonical),I=e.dG(M.getCenter().lat),C=e.dH(c.canonical,M,I,u.worldSize/u._pixelsPerMercatorPixel),P=e.bj(e.dI(c.canonical)),L=Ur(u.expandedFarZProjMatrix,v,m,P,e.aj(u.zoom),g,u.frustumCorners.TL,u.frustumCorners.TR,u.frustumCorners.BR,u.frustumCorners.BL,u.globeCenterInViewSpace,u.globeRadius,y,h,u._farZ,C);if(d(c,A),l&&(i.setupElevationDraw(r,l,x),t.uploadCommonUniforms(s,l,c.toUnwrapped()),_)){const[e,i,n]=_.getGridBuffers(I,0!==h);l.draw(t,b,f,T,p,Ji.backCCW,L,"globe_raster",e,i,n)}}}if(_&&(t.renderDefaultNorthPole||t.renderDefaultSouthPole)){const o=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];h&&o.push("CUSTOM_ANTIALIASING"),l=t.getOrCreateProgram("globeRaster",{defines:o});for(const o of r){const{x:r,y:c,z:h}=o.canonical,d=0===c,m=c===(1<<h)-1,[v,b,T,w]=_.getPoleBuffers(h,!1);if(w&&(d||m)){const c=n.getTile(o);s.activeTexture.set(a.TEXTURE0),c.texture&&c.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE);let _=e.dJ(h,r,u);const E=e.bj(e.dI(o.canonical)),S=(e,i)=>e.draw(t,a.TRIANGLES,f,Xi.disabled,p,Ji.disabled,Ur(u.expandedFarZProjMatrix,_,_,E,0,g,u.frustumCorners.TL,u.frustumCorners.TR,u.frustumCorners.BR,u.frustumCorners.BL,u.globeCenterInViewSpace,u.globeRadius,y,0,u._farZ),"globe_pole_raster",i,T,w);i.setupElevationDraw(c,l,x),t.uploadCommonUniforms(s,l,o.toUnwrapped()),d&&t.renderDefaultNorthPole&&S(l,v),m&&t.renderDefaultSouthPole&&(_=e.cR(e.bB(),_,[1,-1,1]),S(l,b))}}}}(t,i,n,r,o);else{const s=t.context,a=s.gl;let l,c;const u=t.shadowRenderer,h=ln(t,t.longestCutoffRange),d=e=>{if(c===e)return;const i=[];i.push(Gr[e]),h.shouldRenderCutoff&&i.push("RENDER_CUTOFF"),u&&(i.push("RENDER_SHADOWS","DEPTH_TEXTURE"),u.useNormalOffset&&i.push("NORMAL_OFFSET")),l=t.getOrCreateProgram("terrainRaster",{defines:i}),c=e},p=t.colorModeForRenderPass(),f=new Wi(a.LEQUAL,Wi.ReadWrite,t.depthRangeFor3D);Vr.update(o);const m=t.transform,g=jr(m.zoom,i.exaggeration(),i.sourceCache._source.tileSize);let _=[0,0,0];if(u){const e=t.style.directionalLight,i=t.style.ambientLight;e&&i&&(_=mn(t.style,e,i))}{c=-1;const y=a.TRIANGLES,[v,x]=[i.gridIndexBuffer,i.gridSegments];for(const c of r){const r=n.getTile(c),b=Xi.disabled,T=i.prevTerrainTileForTile[c.key],w=i.terrainTileForTile[c.key];zr(T,w)&&Vr.newMorphing(c.key,T,w,o,250),s.activeTexture.set(a.TEXTURE0),r.texture&&r.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE);const E=Vr.getMorphValuesForProxy(c.key),S=E?1:0;let A;E&&(A={morphing:{srcDemTile:E.from,dstDemTile:E.to,phase:e.dC(E.phase)}});const M=kr(c.projMatrix,Hr(c.canonical,m.renderWorldCopies)?g/10:g,_);if(d(S),!l)continue;i.setupElevationDraw(r,l,A);const I=c.toUnwrapped();u&&u.setupShadows(I,l),t.uploadCommonUniforms(s,l,I,null,h),l.draw(t,y,f,b,p,Ji.backCCW,M,"terrain_raster",i.gridBuffer,v,x)}}}}(i,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,i.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(0===this._drapedRenderBatches.length)return t+1;this.renderingToTexture=!0;const i=this.painter,n=this.painter.context,r=this.proxySourceCache,o=this.proxiedCoords[r.id],s=this._drapedRenderBatches.shift(),a=i.style.order,l=[];let c=0;for(const u of o){const o=r.getTileByID(u.proxyTileKey),h=r.proxyCachedFBO[u.key]?r.proxyCachedFBO[u.key][t]:void 0,d=void 0!==h?r.renderCache[h]:this.pool[c++],p=void 0!==h;if(o.texture=d.tex,p&&!d.dirty){l.push(o.tileID);continue}let f;n.bindFramebuffer.set(d.fb.framebuffer),this.renderedToTile=!1,d.dirty&&(n.clear({color:e.ao.transparent,stencil:0}),d.dirty=!1);for(let e=s.start;e<=s.end;++e){const t=i.style._mergedLayers[a[e]];if(t.isHidden(i.transform.zoom))continue;const r=i.style.getLayerSourceCache(t),o=r?this.proxyToSource[u.key][r.id]:[u];if(!o)continue;const s=o;n.viewport.set([0,0,d.fb.width,d.fb.height]),f!==(r?r.id:null)&&(this._setupStencil(d,o,t,r),f=r?r.id:null),i.renderLayer(i,r,t,s)}if(0===this._drapedRenderBatches.length)for(const e of this._pendingGroundEffectLayers){const t=i.style._mergedLayers[a[e]];if(t.isHidden(i.transform.zoom))continue;const r=i.style.getLayerSourceCache(t),o=r?this.proxyToSource[u.key][r.id]:[u];if(!o)continue;const s=o;n.viewport.set([0,0,d.fb.width,d.fb.height]),f!==(r?r.id:null)&&(this._setupStencil(d,o,t,r),f=r?r.id:null),i.renderLayer(i,r,t,s)}this.renderedToTile?(d.dirty=!0,l.push(o.tileID)):p||--c,5===c&&(c=0,this.renderToBackBuffer(l))}return this.renderToBackBuffer(l),this.renderingToTexture=!1,n.bindFramebuffer.set(null),n.viewport.set([0,0,i.width,i.height]),s.end+1}postRender(){}isLayerOrderingCorrect(e){const t=e.order.length;let i=-1,n=t;for(let r=0;r<t;++r)this._style.isLayerDraped(e._mergedLayers[e.order[r]])?i=Math.max(i,r):n=Math.min(n,r);return n>i}getMinElevationBelowMSL(){let e=0;return this._visibleDemTiles.filter((e=>e.dem)).forEach((t=>{e=Math.min(e,t.dem.tree.minimums[0])})),0===e?e:(e-30)*this._exaggeration}raycast(e,t,i){if(!this._visibleDemTiles)return null;const n=this._visibleDemTiles.filter((e=>e.dem)).map((n=>{const r=n.tileID,o=1<<r.overscaledZ,{x:s,y:a}=r.canonical,l=s/o,c=(s+1)/o,u=a/o,h=(a+1)/o;return{minx:l,miny:u,maxx:c,maxy:h,t:n.dem.tree.raycastRoot(l,u,c,h,e,t,i),tile:n}}));n.sort(((e,t)=>(null!==e.t?e.t:Number.MAX_VALUE)-(null!==t.t?t.t:Number.MAX_VALUE)));for(const r of n){if(null==r.t)return null;const n=r.tile.dem.tree.raycast(r.minx,r.miny,r.maxx,r.maxy,e,t,i);if(null!=n)return n}return null}_createFBO(){const t=this.painter.context,i=t.gl,n=this.drapeBufferSize;t.activeTexture.set(i.TEXTURE0);const r=new e.T(t,{width:n[0],height:n[1],data:null},i.RGBA8);r.bind(i.LINEAR,i.CLAMP_TO_EDGE);const o=t.createFramebuffer(n[0],n[1],!0,null);return o.colorAttachment.set(r.texture),o.depthAttachment=new Nr(t,o.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,n[0],n[1]),this._stencilRef=0,o.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):o.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&i.texParameterf(i.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:o,tex:r,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache)return!0;if(this._style.hasLightTransitions())return!0;for(const e in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[e].hasTransition())return!0;return this._style.order.some((e=>{const t=this._style._mergedLayers[e],i=t.isHidden(this.painter.transform.zoom);return"hillshade"===t.type||"custom"===t.type?!i&&t.shouldRedrape():!i&&t.hasTransition()}))}_clearLineLayersFromRenderCache(){let t=!1;for(const e of this._style.getSources())if(e instanceof lt){t=!0;break}if(!t)return;const i={};for(let t=0;t<this._style.order.length;++t){const n=this._style._mergedLayers[this._style.order[t]],r=this._style.getLayerSourceCache(n);if(r&&!i[r.id]&&!n.isHidden(this.painter.transform.zoom)&&"line"===n.type&&n.widthExpression()instanceof e.ad){i[r.id]=!0;for(const e of this.proxyCoords){const t=this.proxyToSource[e.key][r.id];if(t)for(const e of t)this._clearRenderCacheForTile(r.id,e)}}}}_clearRasterLayersFromRenderCache(){let e=!1;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t]._source instanceof ct){e=!0;break}if(!e)return;const t={};for(let e=0;e<this._style.order.length;++e){const i=this._style._mergedLayers[this._style.order[e]],n=this._style.getLayerSourceCache(i);if(!n||t[n.id])continue;if(i.isHidden(this.painter.transform.zoom)||"raster"!==i.type)continue;const r=i.paint.get("raster-fade-duration");for(const e of this.proxyCoords){const t=this.proxyToSource[e.key][n.id];if(t)for(const e of t){const t=Wr(n.getTile(e),n.findLoadedParent(e,0),n,this.painter.transform,r);(1!==t.opacity||0!==t.mix)&&this._clearRenderCacheForTile(n.id,e)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,i=t.length;if(0===i)return;const n=[];this._pendingGroundEffectLayers=[];let r,o=0,s=this._style._mergedLayers[t[o]];for(;!this._style.isLayerDraped(s)&&s.isHidden(this.painter.transform.zoom)&&++o<i;)s=this._style._mergedLayers[t[o]];for(;o<i;++o){const e=this._style._mergedLayers[t[o]];e.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(e)?void 0===r&&(r=o):("fill-extrusion"===e.type&&this._pendingGroundEffectLayers.push(o),void 0!==r&&(n.push({start:r,end:o-1}),r=void 0)))}if(void 0!==r&&n.push({start:r,end:o-1}),0!==n.length){const t=n[n.length-1];this._pendingGroundEffectLayers.every((e=>e>t.end))||e.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=n}_setupRenderCache(e){const t=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,t.renderCache.length>t.renderCachePool.length){const e=Object.values(t.proxyCachedFBO);t.proxyCachedFBO={};for(let i=0;i<e.length;++i){const n=Object.values(e[i]);t.renderCachePool.push(...n)}}return}this._clearRasterLayersFromRenderCache();const i=this.proxyCoords,n=this._tilesDirty;for(let r=i.length-1;r>=0;r--){const o=i[r];if(t.getTileByID(o.key),void 0!==t.proxyCachedFBO[o.key]){const i=e[o.key],r=this.proxyToSource[o.key];let s=0;for(const e in r){const t=r[e],o=i[e];if(!o||o.length!==t.length||t.some(((t,i)=>t!==o[i]||n[e]&&n[e].hasOwnProperty(t.key)))){s=-1;break}++s}for(const e in t.proxyCachedFBO[o.key])t.renderCache[t.proxyCachedFBO[o.key][e]].dirty=s<0||s!==Object.values(i).length}}const r=[...this._drapedRenderBatches];r.sort(((e,t)=>t.end-t.start-(e.end-e.start)));for(const e of r)for(const n of i){if(t.proxyCachedFBO[n.key])continue;let i=t.renderCachePool.pop();void 0===i&&t.renderCache.length<50&&(i=t.renderCache.length,t.renderCache.push(this._createFBO())),void 0!==i&&(t.proxyCachedFBO[n.key]={},t.proxyCachedFBO[n.key][e.start]=i,t.renderCache[i].dirty=!0)}this._tilesDirty={}}_setupStencil(e,t,i,n){if(!n||!this._sourceTilesOverlap[n.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const r=this.painter.context,o=r.gl;if(t.length<=1)return void(this._overlapStencilType=!1);let s;if(i.isTileClipped())s=t.length,this._overlapStencilMode.test={func:o.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(t[0].overscaledZ>t[t.length-1].overscaledZ))return void(this._overlapStencilType=!1);s=1,this._overlapStencilMode.test={func:o.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+s>255&&(r.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=s,this._overlapStencilMode.ref=this._stencilRef,i.isTileClipped()&&this._renderTileClippingMasks(t,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(e){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[e.key]),this._overlapStencilMode):Xi.disabled}_renderTileClippingMasks(e,t){const i=this.painter,n=this.painter.context,r=n.gl;i._tileClippingMaskIDs={},n.setColorMode($i.disabled),n.setDepthMode(Wi.disabled);const o=i.getOrCreateProgram("clippingMask");for(const n of e){const e=i._tileClippingMaskIDs[n.key]=--t;o.draw(i,r.TRIANGLES,Wi.disabled,new Xi({func:r.ALWAYS,mask:0},e,255,r.KEEP,r.KEEP,r.REPLACE),$i.disabled,Ji.disabled,$r(n.projMatrix),"$clipping",i.tileExtentBuffer,i.quadTriangleIndexBuffer,i.tileExtentSegments)}}pointCoordinate(t){const i=this.painter.transform;if(t.x<0||t.x>i.width||t.y<0||t.y>i.height)return null;const n=[t.x,t.y,1,1];e.aC(n,n,i.pixelMatrixInverse),e.cJ(n,n,1/n[3]),n[0]/=i.worldSize,n[1]/=i.worldSize;const r=i._camera.position,o=e.ce(1,i.center.lat),s=[r[0],r[1],r[2]/o,0],a=e.d9([],n.slice(0,3),s);e.aw(a,a);const l=this.raycast(s,a,this._exaggeration);return null!==l&&l?(e.bG(s,s,a,l),s[3]=s[2],s[2]*=o,s):null}_setupProxiedCoordsForOrtho(t,i,n){if(t.getSource()instanceof e.aT)return this._setupProxiedCoordsForImageSource(t,i,n);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const r=this.proxiedCoords[t.id]=[],o=this.proxyCoords;for(let e=0;e<o.length;e++){const i=o[e],s=this._findTileCoveringTileID(i,t);if(s){const e=this._createProxiedId(i,s,n[i.key]&&n[i.key][t.id]);r.push(e),this.proxyToSource[i.key][t.id]=[e]}}let s=!1;const a=new Set;for(let e=0;e<i.length;e++){const o=t.getTile(i[e]);if(!o||!o.hasData())continue;const l=this._findTileCoveringTileID(o.tileID,this.proxySourceCache);if(l&&l.tileID.canonical.z!==o.tileID.canonical.z){const e=this.proxyToSource[l.tileID.key][t.id],i=this._createProxiedId(l.tileID,o,n[l.tileID.key]&&n[l.tileID.key][t.id]);e?e.splice(e.length-1,0,i):this.proxyToSource[l.tileID.key][t.id]=[i];const c=this.proxyToSource[l.tileID.key][t.id];a.has(c)||a.add(c),r.push(i),s=!0}}if(this._sourceTilesOverlap[t.id]=s,s&&this._debugParams.sortTilesHiZFirst)for(const e of a)e.sort(((e,t)=>t.overscaledZ-e.overscaledZ))}_setupProxiedCoordsForImageSource(t,i,n){if(!t.getSource().loaded())return;const r=this.proxiedCoords[t.id]=[],o=this.proxyCoords,s=t.getSource(),a=s.tileID;if(!a)return;const l=new e.P(a.x,a.y)._div(1<<a.z),c=s.coordinates.map(e.ae.fromLngLat).reduce(((e,t)=>(e.min.x=Math.min(e.min.x,t.x-l.x),e.min.y=Math.min(e.min.y,t.y-l.y),e.max.x=Math.max(e.max.x,t.x-l.x),e.max.y=Math.max(e.max.y,t.y-l.y),e)),{min:new e.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new e.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),u=(t,i)=>{const n=t.wrap+t.canonical.x/(1<<t.canonical.z),r=t.canonical.y/(1<<t.canonical.z),o=e.al/(1<<t.canonical.z),s=i.wrap+i.canonical.x/(1<<i.canonical.z),a=i.canonical.y/(1<<i.canonical.z);return n+o<s+c.min.x||n>s+c.max.x||r+o<a+c.min.y||r>a+c.max.y};for(let e=0;e<o.length;e++){const s=o[e];for(let e=0;e<i.length;e++){const o=t.getTile(i[e]);if(!o||!o.hasData())continue;if(u(s,o.tileID))continue;const a=this._createProxiedId(s,o,n[s.key]&&n[s.key][t.id]),l=this.proxyToSource[s.key][t.id];l?l.push(a):this.proxyToSource[s.key][t.id]=[a],r.push(a)}}}_createProxiedId(t,i,n){let r=this.orthoMatrix;if(n){const e=n.find((e=>e.key===i.tileID.key));if(e)return e}if(i.tileID.key!==t.key){const n=t.canonical.z-i.tileID.canonical.z;let o,s,a;r=e.bB();const l=i.tileID.wrap-t.wrap<<t.overscaledZ;n>0?(o=e.al>>n,s=o*((i.tileID.canonical.x<<n)-t.canonical.x+l),a=o*((i.tileID.canonical.y<<n)-t.canonical.y)):(o=e.al<<-n,s=e.al*(i.tileID.canonical.x-(t.canonical.x+l<<-n)),a=e.al*(i.tileID.canonical.y-(t.canonical.y<<-n))),e.cd(r,0,o,0,o,0,1),e.bq(r,r,[s,a,0])}return new Yr(i.tileID,t.key,r)}_findTileCoveringTileID(t,i){let n=i.getTile(t);if(n&&n.hasData())return n;const r=this._findCoveringTileCache[i.id],o=r[t.key];if(n=o?i.getTileByID(o):null,n&&n.hasData()||null===o)return n;let s=n?n.tileID:t,a=s.overscaledZ;const l=i.getSource().minzoom,c=[];if(!o){const r=i.getSource().maxzoom;if(t.canonical.z>=r){const n=t.canonical.z-r;i.getSource().reparseOverscaled?(a=Math.max(t.canonical.z+2,i.transform.tileZoom),s=new e.aP(a,t.wrap,r,t.canonical.x>>n,t.canonical.y>>n)):0!==n&&(a=r,s=new e.aP(a,t.wrap,r,t.canonical.x>>n,t.canonical.y>>n))}s.key!==t.key&&(c.push(s.key),n=i.getTile(s))}const u=e=>{c.forEach((t=>{r[t]=e})),c.length=0};for(a-=1;a>=l&&(!n||!n.hasData());a--){n&&u(n.tileID.key);const e=s.calculateScaledKey(a);if(n=i.getTileByID(e),n&&n.hasData())break;const t=r[e];if(null===t)break;void 0===t?c.push(e):n=i.getTileByID(t)}return u(n?n.tileID.key:null),n&&n.hasData()?n:null}findDEMTileFor(e){return this.enabled?this._findTileCoveringTileID(e,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(e,t){let i=this._tilesDirty[e];i||(i=this._tilesDirty[e]={}),i[t.key]=!0}}function Jr(t,i,n){const r=function(t,i,n){const r=e.bI(i,t),o=e.bI(n,[.2126,.7152,.0722]),s=(e,t,i)=>(1-i)*e+i*t,a=s(1-.3*Math.min(o,1),1,Math.min(r+1,1));return s(.92,1,Math.asin(e.aA(i[2],-1,1))/Math.PI+.5)*a}(t,[0,0,1],i),o=[0,0,0];e.c4(o,n.slice(0,3),r);const s=[0,0,0];e.c4(s,i.slice(0,3),t[2]);const a=[0,0,0];return e.d7(a,o,s),e.da(a)}const Kr=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Qr=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class eo{static cacheKey(e,t,i,n){let r=`${t}${n?n.cacheKey:""}`;for(const t of i)e.usedDefines.includes(t)&&(r+=`/${t}`);return r}constructor(t,i,n,r,o,s){const a=t.gl;this.program=a.createProgram(),this.configuration=r,this.name=i,this.fixedDefines=[...s];let l=r?r.defines():[];l=l.concat(s.map((e=>`#define ${e}`)));const c="#version 300 es\n";let u=c+l.concat("precision mediump float;",Wn,$n.fragmentSource).join("\n");for(const e of n.fragmentIncludes)u+=`\n${jn[e]}`;u+=`\n${n.fragmentSource}`;let h=c+l.concat("precision highp float;",Wn,$n.vertexSource).join("\n");for(const e of n.vertexIncludes)h+=`\n${jn[e]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&-1!==n.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(h+="\nuniform int u_instanceID;\n"),h+=`\n${n.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(h=h.replaceAll("gl_InstanceID","u_instanceID"));const d=a.createShader(a.FRAGMENT_SHADER);if(a.isContextLost())return void(this.failedToCreate=!0);a.shaderSource(d,u),a.compileShader(d),a.attachShader(this.program,d);const p=a.createShader(a.VERTEX_SHADER);a.isContextLost()?this.failedToCreate=!0:(a.shaderSource(p,h),a.compileShader(p),a.attachShader(this.program,p),this.attributes={},a.linkProgram(this.program),a.deleteShader(p),a.deleteShader(d),this.fixedUniforms=o(t),this.binderUniforms=r?r.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(t=>({u_instanceID:new e.cg(t)}))(t)),(s.includes("TERRAIN")||-1!==i.indexOf("symbol")||-1!==i.indexOf("circle"))&&(this.terrainUniforms=(t=>({u_dem:new e.cg(t),u_dem_prev:new e.cg(t),u_dem_tl:new e.cj(t),u_dem_scale:new e.ci(t),u_dem_tl_prev:new e.cj(t),u_dem_scale_prev:new e.ci(t),u_dem_size:new e.ci(t),u_dem_lerp:new e.ci(t),u_exaggeration:new e.ci(t),u_depth:new e.cg(t),u_depth_size_inv:new e.cj(t),u_depth_range_unpack:new e.cj(t),u_occluder_half_size:new e.ci(t),u_occlusion_depth_offset:new e.ci(t),u_meter_to_dem:new e.ci(t),u_label_plane_matrix_inv:new e.ck(t)}))(t)),s.includes("GLOBE")&&(this.globeUniforms=(t=>({u_tile_tl_up:new e.ch(t),u_tile_tr_up:new e.ch(t),u_tile_br_up:new e.ch(t),u_tile_bl_up:new e.ch(t),u_tile_up_scale:new e.ci(t)}))(t)),s.includes("FOG")&&(this.fogUniforms=(t=>({u_fog_matrix:new e.ck(t),u_fog_range:new e.cj(t),u_fog_color:new e.d2(t),u_fog_horizon_blend:new e.ci(t),u_fog_vertical_limit:new e.cj(t),u_fog_temporal_offset:new e.ci(t),u_frustum_tl:new e.ch(t),u_frustum_tr:new e.ch(t),u_frustum_br:new e.ch(t),u_frustum_bl:new e.ch(t),u_globe_pos:new e.ch(t),u_globe_radius:new e.ci(t),u_globe_transition:new e.ci(t),u_is_globe:new e.cg(t),u_viewport:new e.cj(t)}))(t)),s.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(t=>({u_cutoff_params:new e.d2(t)}))(t)),s.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(t=>({u_lighting_ambient_color:new e.ch(t),u_lighting_directional_dir:new e.ch(t),u_lighting_directional_color:new e.ch(t),u_ground_radiance:new e.ch(t)}))(t)),s.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(t=>({u_light_matrix_0:new e.ck(t),u_light_matrix_1:new e.ck(t),u_fade_range:new e.cj(t),u_shadow_normal_offset:new e.ch(t),u_shadow_intensity:new e.ci(t),u_shadow_texel_size:new e.ci(t),u_shadow_map_resolution:new e.ci(t),u_shadow_direction:new e.ch(t),u_shadow_bias:new e.ch(t),u_shadowmap_0:new e.cg(t),u_shadowmap_1:new e.cg(t)}))(t)))}getAttributeLocation(e,t){let i=this.attributes[t];return void 0===i&&(i=this.attributes[t]=e.getAttribLocation(this.program,t)),i}setTerrainUniformValues(e,t){if(!this.terrainUniforms)return;const i=this.terrainUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)i[e]&&i[e].set(this.program,e,t[e])}}setGlobeUniformValues(e,t){if(!this.globeUniforms)return;const i=this.globeUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)i[e]&&i[e].set(this.program,e,t[e])}}setFogUniformValues(e,t){if(!this.fogUniforms)return;const i=this.fogUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)i[e].set(this.program,e,t[e])}}setCutoffUniformValues(e,t){if(!this.cutoffUniforms)return;const i=this.cutoffUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)i[e].set(this.program,e,t[e])}}setLightsUniformValues(e,t){if(!this.lightsUniforms)return;const i=this.lightsUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)i[e].set(this.program,e,t[e])}}setShadowUniformValues(e,t){if(this.failedToCreate||!this.shadowUniforms)return;const i=this.shadowUniforms;e.program.set(this.program);for(const e in t)i[e].set(this.program,e,t[e])}_drawDebugWireframe(t,i,n,r,o,s,a,l,c,u){const h=t.options.wireframe;if(!1===h.terrain&&!1===h.layers2D&&!1===h.layers3D)return;const d=t.context;if(!(()=>!(!h.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!h.layers2D||t._terrain&&t._terrain.renderingToTexture||!Kr.includes(this.name))||!(!h.layers3D||!Qr.includes(this.name)))())return;const p=d.gl,f=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,o,d);if(!f)return;const m=[...this.fixedDefines];m.push("DEBUG_WIREFRAME");const g=t.getOrCreateProgram(this.name,{config:this.configuration,defines:m});d.program.set(g.program);const _=(e,t,i)=>{if(t[e]&&i[e])for(const n in t[e])i[e][n]&&i[e][n].set(i.program,n,t[e][n].current)};c&&c.setUniforms(g.program,d,g.binderUniforms,a,{zoom:l}),_("fixedUniforms",this,g),_("terrainUniforms",this,g),_("globeUniforms",this,g),_("fogUniforms",this,g),_("lightsUniforms",this,g),_("shadowUniforms",this,g),f.bind(),d.setColorMode(new $i([p.ONE,p.ONE_MINUS_SRC_ALPHA,p.ZERO,p.ONE],e.ao.transparent,[!0,!0,!0,!1])),d.setDepthMode(new Wi(i.func===p.LESS?p.LEQUAL:i.func,Wi.ReadOnly,i.range)),d.setStencilMode(Xi.disabled);const y=3*s.primitiveLength*2,v=3*s.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const e=u||1;for(let t=0;t<e;++t)g.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",t),p.drawElements(p.LINES,y,p.UNSIGNED_SHORT,v)}else u&&u>1?p.drawElementsInstanced(p.LINES,y,p.UNSIGNED_SHORT,v,u):p.drawElements(p.LINES,y,p.UNSIGNED_SHORT,v);o.bind(),d.program.set(this.program),d.setDepthMode(i),d.setStencilMode(n),d.setColorMode(r)}checkUniforms(e,t,i){if(this.fixedDefines.includes(t))for(const n of Object.keys(i))if(!i[n].initialized)throw new Error(`Program '${this.name}', from draw '${e}': uniform ${n} not set but required by ${t} being defined`)}draw(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m){const g=e.context,_=g.gl;if(this.failedToCreate)return;g.program.set(this.program),g.setDepthMode(i),g.setStencilMode(n),g.setColorMode(r),g.setCullFace(o);for(const e of Object.keys(this.fixedUniforms))this.fixedUniforms[e].set(this.program,e,s[e]);p&&p.setUniforms(this.program,g,this.binderUniforms,h,{zoom:d});const y={[_.POINTS]:1,[_.LINES]:2,[_.TRIANGLES]:3,[_.LINE_STRIP]:1}[t];this.checkUniforms(a,"RENDER_SHADOWS",this.shadowUniforms);const v=m&&m>0?1:void 0;for(const o of u.get()){const s=o.vaos||(o.vaos={});if((s[a]||(s[a]=new Zn)).bind(g,this,l,p?p.getPaintVertexBuffers():[],c,o.vertexOffset,f||[],v),this.forceManualRenderingForInstanceIDShaders){const e=m||1;for(let i=0;i<e;++i)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",i),c?_.drawElements(t,o.primitiveLength*y,_.UNSIGNED_SHORT,o.primitiveOffset*y*2):_.drawArrays(t,o.vertexOffset,o.vertexLength)}else m&&m>1?_.drawElementsInstanced(t,o.primitiveLength*y,_.UNSIGNED_SHORT,o.primitiveOffset*y*2,m):c?_.drawElements(t,o.primitiveLength*y,_.UNSIGNED_SHORT,o.primitiveOffset*y*2):_.drawArrays(t,o.vertexOffset,o.vertexLength);t===_.TRIANGLES&&c&&this._drawDebugWireframe(e,i,n,r,c,o,h,d,p,m)}}}function to(t,i,n=0){const r=Math.pow(2,i.tileID.overscaledZ),o=i.tileSize*Math.pow(2,t.transform.tileZoom)/r,s=o*(i.tileID.canonical.x+i.tileID.wrap*r),a=o*i.tileID.canonical.y;return{u_image:0,u_texsize:i.imageAtlasTexture?i.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/e.ay(i,1,t.transform.tileZoom),u_pixel_coord_upper:[s>>16,a>>16],u_pixel_coord_lower:[65535&s,65535&a],u_pattern_transition:n}}const io={terrain:0,flat:1},no=e.bB(),ro=(t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y)=>{const v=i.style.light,x=v.properties.get("position"),b=[x.x,x.y,x.z],T=e.dN();"viewport"===v.properties.get("anchor")&&(e.dO(T,-i.transform.angle),e.dP(b,b,T));const w=v.properties.get("color").toPremultipliedRenderColor(null),E=i.transform,S={u_matrix:t,u_lightpos:b,u_lightintensity:v.properties.get("intensity"),u_lightcolor:[w.r,w.g,w.b],u_vertical_gradient:+n,u_opacity:r,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:no,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:io[u],u_base_type:io[h],u_ao:o,u_edge_radius:s,u_width_scale:a,u_flood_light_color:m,u_vertical_scale:g,u_flood_light_intensity:_,u_ground_shadow_factor:y};return"globe"===E.projection.name&&(S.u_tile_id=[l.canonical.x,l.canonical.y,1<<l.canonical.z],S.u_zoom_transition=d,S.u_inv_rot_matrix=f,S.u_merc_center=p,S.u_up_dir=E.projection.upVector(new e.cC(0,0,0),p[0]*e.al,p[1]*e.al),S.u_height_lift=c),S},oo=(e,t,i,n,r,o)=>({u_matrix:e,u_edge_radius:t,u_width_scale:i,u_vertical_scale:n,u_height_type:io[r],u_base_type:io[o]}),so=(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_)=>{const y=ro(e,t,i,n,r,o,s,a,c,u,h,d,p,f,m,g,1,[0,0,0]),v={u_height_factor:-Math.pow(2,a.overscaledZ)/l.tileSize/8};return Object.assign(y,to(t,l,_),v)},ao=(e,t,i,n,r,o,s,a,l,c,u)=>({u_matrix:t,u_opacity:i,u_ao_pass:n?1:0,u_meter_to_tile:r,u_ao:o,u_flood_light_intensity:s,u_flood_light_color:a,u_attenuation:l,u_edge_radius:c,u_fb:0,u_fb_size:u,u_dynamic_offset:1}),lo=(e,t,i)=>({u_matrix:e,u_emissive_strength:t,u_ground_shadow_factor:i}),co=(e,t,i,n,r,o=0)=>Object.assign(lo(e,t,r),to(i,n,o)),uo=(e,t,i,n)=>({u_matrix:e,u_world:i,u_emissive_strength:t,u_ground_shadow_factor:n}),ho=(e,t,i,n,r,o,s=0)=>Object.assign(co(e,t,i,n,o,s),{u_world:r}),po=(e,t)=>({u_matrix:e,u_ground_shadow_factor:t}),fo=(e,t,i,n,r)=>({u_matrix:e,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:i,u_height_scale:n,u_reset_depth:r}),mo=(e,t,i,n,r,o,s,a,l)=>({u_matrix:e,u_normal_matrix:t,u_opacity:i,u_faux_facade_ao_intensity:n,u_camera_pos:r,u_tile_to_meter:o,u_facade_emissive_chance:s,u_flood_light_color:a,u_flood_light_intensity:l}),go=e=>({u_matrix:e}),_o=e=>({u_matrix:e}),yo=(t,i,n,r,o,s,a,l)=>{const c=e.al/s.tileSize;return{u_matrix:t,u_inv_rot_matrix:i,u_camera_to_center_distance:n.getCameraToCenterDistance(l),u_extrude_scale:[n.pixelsToGLUnits[0]/c,n.pixelsToGLUnits[1]/c],u_zoom_transition:r,u_tile_id:a,u_merc_center:o}},vo=(e,t,i=1)=>({u_matrix:e,u_color:t,u_overlay:0,u_overlay_scale:i}),xo=e.bB(),bo=(t,i,n,r,o,s,a)=>{const l=t.transform,c="globe"===l.projection.name,u=c?e.dQ(l.zoom,i.canonical)*l._pixelsPerMercatorPixel:e.ay(n,1,s),h={u_matrix:i.projMatrix,u_extrude_scale:u,u_intensity:a,u_inv_rot_matrix:xo,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(c){h.u_inv_rot_matrix=r,h.u_merc_center=o,h.u_tile_id=[i.canonical.x,i.canonical.y,1<<i.canonical.z],h.u_zoom_transition=e.aj(l.zoom);const t=o[0]*e.al,n=o[1]*e.al;h.u_up_dir=l.projection.upVector(new e.cC(0,0,0),t,n)}return h};function To(e,[t,i,n,r],[o,s]){if(o===s)return[0,0,0,0];const a=255*(e-1)/(e*(s-o));return[t*a,i*a,n*a,r*a]}function wo(e,t,[i,n]){return i===n?0:.5/e+(t-i)*(e-1)/(e*(n-i))}const Eo=(t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b)=>({u_matrix:t,u_normalize_matrix:i,u_globe_matrix:n,u_merc_matrix:r,u_grid_matrix:o,u_tl_parent:s,u_scale_parent:u,u_fade_t:h.mix,u_opacity:h.opacity*d.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:d.paint.get("raster-brightness-min"),u_brightness_high:d.paint.get("raster-brightness-max"),u_saturation_factor:e.dS(d.paint.get("raster-saturation")),u_contrast_factor:e.dR(d.paint.get("raster-contrast")),u_spin_weights:So(d.paint.get("raster-hue-rotate")),u_perspective_transform:p,u_raster_elevation:f,u_zoom_transition:a,u_merc_center:l,u_cutoff_params:c,u_colorization_mix:To(e.dT,g,y),u_colorization_offset:wo(e.dT,_,y),u_color_ramp:m,u_texture_offset:[x/(v+2*x),v/(v+2*x)],u_texture_res:[v+2*x,v+2*x],u_emissive_strength:b});function So(e){e*=Math.PI/180;const t=Math.sin(e),i=Math.cos(e);return[(2*i+1)/3,(-Math.sqrt(3)*t-i+1)/3,(Math.sqrt(3)*t-i+1)/3]}const Ao=.05,Mo=(e,t,i,n,r,o,s,a,l,c,u,h)=>({u_matrix:e,u_normalize_matrix:t,u_globe_matrix:i,u_merc_matrix:n,u_grid_matrix:r,u_tl_parent:o,u_scale_parent:c,u_fade_t:u.mix,u_opacity:u.opacity,u_image0:0,u_image1:1,u_raster_elevation:h,u_zoom_transition:s,u_merc_center:a,u_cutoff_params:l}),Io=(e,t,i,n,r,o,s,a,l,c)=>({u_particle_texture:e,u_particle_texture_side_len:t,u_tile_offset:i,u_velocity:n,u_color_ramp:o,u_velocity_res:r,u_max_speed:s,u_uv_offset:a,u_data_scale:[255*l[0],255*l[1]],u_data_offset:c,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ao,Ao]}),Co=(e,t,i,n,r,o,s,a,l,c)=>({u_particle_texture:e,u_particle_texture_side_len:t,u_velocity:i,u_velocity_res:n,u_max_speed:r,u_speed_factor:o,u_reset_rate:s,u_rand_seed:Math.random(),u_uv_offset:a,u_data_scale:[255*l[0],255*l[1]],u_data_offset:c,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ao,Ao]}),Po=e.bB(),Lo=(t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b,T,w,E)=>{const S=o.transform,A={u_is_size_zoom_constant:+("constant"===t||"source"===t),u_is_size_feature_constant:+("constant"===t||"camera"===t),u_size_t:i?i.uSizeT:0,u_size:i?i.uSize:0,u_camera_to_center_distance:S.getCameraToCenterDistance(v),u_rotate_symbol:+n,u_aspect_ratio:S.width/S.height,u_fade_change:o.options.fadeDuration?o.symbolFadeChange:1,u_matrix:s,u_label_plane_matrix:a,u_coord_matrix:l,u_is_text:+u,u_elevation_from_sea:c?1:0,u_pitch_with_map:+r,u_texsize:h,u_texsize_icon:d,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Po,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Po,u_up_vector:[0,-1,0],u_color_adj_mat:T,u_icon_transition:w||0,u_gamma_scale:r?o.transform.getCameraToCenterDistance(v)*Math.cos(o.terrain?0:o.transform._pitch):1,u_device_pixel_ratio:e.o.devicePixelRatio,u_is_halo:1,u_scale_factor:E||1,u_ground_shadow_factor:x,u_inv_matrix:e.bk(e.bB(),a),u_normal_scale:b,u_lutTexture:rn.LUT};return"globe"===v.name&&(A.u_tile_id=[f.canonical.x,f.canonical.y,1<<f.canonical.z],A.u_zoom_transition=m,A.u_inv_rot_matrix=_,A.u_merc_center=g,A.u_camera_forward=S._camera.forward(),A.u_ecef_origin=e.dU(S.globeMatrix,f.toUnwrapped()),A.u_tile_matrix=Float32Array.from(S.globeMatrix),A.u_up_vector=y),A},Ro=(e,t,i,n)=>({u_matrix:e,u_emissive_strength:t,u_opacity:i,u_color:n}),Oo=(t,i,n,r,o,s,a,l,c)=>Object.assign(function(t,i,n,r,o,s){const{width:a,height:l}=r.imageManager.getPixelSize(i),c=Math.pow(2,s.tileID.overscaledZ),u=s.tileSize*Math.pow(2,r.transform.tileZoom)/c,h=u*(s.tileID.canonical.x+s.tileID.wrap*c),d=u*s.tileID.canonical.y;return{u_image:0,u_pattern_tl:n.tl,u_pattern_br:n.br,u_texsize:[a,l],u_pattern_size:n.displaySize,u_pattern_units_to_pixels:o?[r.transform.width,-1*r.transform.height]:[1/e.ay(s,1,r.transform.tileZoom),1/e.ay(s,1,r.transform.tileZoom)],u_pixel_coord_upper:[h>>16,d>>16],u_pixel_coord_lower:[65535&h,65535&d]}}(0,s,a,r,l,c),{u_matrix:t,u_emissive_strength:i,u_opacity:n}),Do=new Float32Array(e.bz([])),Bo=(t,i,n,r,o,s,a,l,c,u,h,d,p,f=[0,0,0],m,g,_)=>{const y=o.style.light,v=y.properties.get("position"),x=[-v.x,-v.y,v.z],b=e.dN();"viewport"===y.properties.get("anchor")&&(e.dO(b,-o.transform.angle),e.dP(x,x,b));const T="MASK"===h.alphaMode,w=y.properties.get("color").toNonPremultipliedRenderColor(null),E=p.paint.get("model-ambient-occlusion-intensity"),S=p.paint.get("model-color").constantOr(e.ao.white).toNonPremultipliedRenderColor(null);return S.a=p.paint.get("model-color-mix-intensity").constantOr(0),_&&(S.r=_[0],S.g=_[1],S.b=_[2],S.a=_[3]),g&&(S.r=g.color.r,S.g=g.color.g,S.b=g.color.b,S.a=g.colorMix,d=g.emissionStrength,s=g.opacity),{u_matrix:t,u_lighting_matrix:i,u_normal_matrix:n,u_node_matrix:r||Do,u_lightpos:x,u_lightintensity:y.properties.get("intensity"),u_lightcolor:[w.r,w.g,w.b],u_camera_pos:f,u_opacity:s,u_baseTextureIsAlpha:0,u_alphaMask:+T,u_alphaCutoff:h.alphaCutoff,u_baseColorFactor:a.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:l.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:c,u_roughnessFactor:u,u_baseColorTexture:rn.BaseColor,u_metallicRoughnessTexture:rn.MetallicRoughness,u_normalTexture:rn.Normal,u_occlusionTexture:rn.Occlusion,u_emissionTexture:rn.Emission,u_lutTexture:rn.LUT,u_color_mix:S.toArray01(),u_aoIntensity:E,u_emissive_strength:d,u_occlusionTextureTransform:m||[0,0,0,0]}},Fo=(e,t=Do,i=Do)=>({u_matrix:e,u_instance:t,u_node_matrix:i}),No={fillExtrusion:t=>({u_matrix:new e.ck(t),u_lightpos:new e.ch(t),u_lightintensity:new e.ci(t),u_lightcolor:new e.ch(t),u_vertical_gradient:new e.ci(t),u_opacity:new e.ci(t),u_edge_radius:new e.ci(t),u_width_scale:new e.ci(t),u_ao:new e.cj(t),u_height_type:new e.cg(t),u_base_type:new e.cg(t),u_tile_id:new e.ch(t),u_zoom_transition:new e.ci(t),u_inv_rot_matrix:new e.ck(t),u_merc_center:new e.cj(t),u_up_dir:new e.ch(t),u_height_lift:new e.ci(t),u_flood_light_color:new e.ch(t),u_vertical_scale:new e.ci(t),u_flood_light_intensity:new e.ci(t),u_ground_shadow_factor:new e.ch(t)}),fillExtrusionDepth:t=>({u_matrix:new e.ck(t),u_edge_radius:new e.ci(t),u_width_scale:new e.ci(t),u_vertical_scale:new e.ci(t),u_height_type:new e.cg(t),u_base_type:new e.cg(t)}),fillExtrusionPattern:t=>({u_matrix:new e.ck(t),u_lightpos:new e.ch(t),u_lightintensity:new e.ci(t),u_lightcolor:new e.ch(t),u_vertical_gradient:new e.ci(t),u_height_factor:new e.ci(t),u_edge_radius:new e.ci(t),u_width_scale:new e.ci(t),u_ao:new e.cj(t),u_height_type:new e.cg(t),u_base_type:new e.cg(t),u_tile_id:new e.ch(t),u_zoom_transition:new e.ci(t),u_inv_rot_matrix:new e.ck(t),u_merc_center:new e.cj(t),u_up_dir:new e.ch(t),u_height_lift:new e.ci(t),u_image:new e.cg(t),u_texsize:new e.cj(t),u_pixel_coord_upper:new e.cj(t),u_pixel_coord_lower:new e.cj(t),u_tile_units_to_pixels:new e.ci(t),u_opacity:new e.ci(t),u_pattern_transition:new e.ci(t)}),fillExtrusionGroundEffect:t=>({u_matrix:new e.ck(t),u_opacity:new e.ci(t),u_ao_pass:new e.ci(t),u_meter_to_tile:new e.ci(t),u_ao:new e.cj(t),u_flood_light_intensity:new e.ci(t),u_flood_light_color:new e.ch(t),u_attenuation:new e.ci(t),u_edge_radius:new e.ci(t),u_fb:new e.cg(t),u_fb_size:new e.ci(t),u_dynamic_offset:new e.ci(t)}),fill:t=>({u_matrix:new e.ck(t),u_emissive_strength:new e.ci(t),u_ground_shadow_factor:new e.ch(t)}),fillPattern:t=>({u_matrix:new e.ck(t),u_emissive_strength:new e.ci(t),u_image:new e.cg(t),u_texsize:new e.cj(t),u_pixel_coord_upper:new e.cj(t),u_pixel_coord_lower:new e.cj(t),u_tile_units_to_pixels:new e.ci(t),u_ground_shadow_factor:new e.ch(t),u_pattern_transition:new e.ci(t)}),fillOutline:t=>({u_matrix:new e.ck(t),u_emissive_strength:new e.ci(t),u_world:new e.cj(t),u_ground_shadow_factor:new e.ch(t)}),fillOutlinePattern:t=>({u_matrix:new e.ck(t),u_emissive_strength:new e.ci(t),u_world:new e.cj(t),u_image:new e.cg(t),u_texsize:new e.cj(t),u_pixel_coord_upper:new e.cj(t),u_pixel_coord_lower:new e.cj(t),u_tile_units_to_pixels:new e.ci(t),u_ground_shadow_factor:new e.ch(t),u_pattern_transition:new e.ci(t)}),building:t=>({u_matrix:new e.ck(t),u_normal_matrix:new e.ck(t),u_opacity:new e.ci(t),u_faux_facade_ao_intensity:new e.ci(t),u_camera_pos:new e.ch(t),u_tile_to_meter:new e.ci(t),u_facade_emissive_chance:new e.ci(t),u_flood_light_color:new e.ch(t),u_flood_light_intensity:new e.ci(t)}),buildingBloom:t=>({u_matrix:new e.ck(t)}),buildingDepth:t=>({u_matrix:new e.ck(t)}),elevatedStructuresDepth:t=>({u_matrix:new e.ck(t),u_depth_bias:new e.ci(t)}),elevatedStructures:t=>({u_matrix:new e.ck(t),u_ground_shadow_factor:new e.ch(t)}),elevatedStructuresDepthReconstruct:t=>({u_matrix:new e.ck(t),u_camera_pos:new e.ch(t),u_depth_bias:new e.ci(t),u_height_scale:new e.ci(t),u_reset_depth:new e.ci(t)}),circle:e.dX,collisionBox:t=>({u_matrix:new e.ck(t),u_inv_rot_matrix:new e.ck(t),u_camera_to_center_distance:new e.ci(t),u_extrude_scale:new e.cj(t),u_zoom_transition:new e.ci(t),u_merc_center:new e.cj(t),u_tile_id:new e.ch(t)}),collisionCircle:t=>({u_matrix:new e.ck(t),u_inv_matrix:new e.ck(t),u_camera_to_center_distance:new e.ci(t),u_viewport_size:new e.cj(t)}),debug:t=>({u_color:new e.dA(t),u_matrix:new e.ck(t),u_overlay:new e.cg(t),u_overlay_scale:new e.ci(t)}),clippingMask:t=>({u_matrix:new e.ck(t)}),heatmap:t=>({u_extrude_scale:new e.ci(t),u_intensity:new e.ci(t),u_matrix:new e.ck(t),u_inv_rot_matrix:new e.ck(t),u_merc_center:new e.cj(t),u_tile_id:new e.ch(t),u_zoom_transition:new e.ci(t),u_up_dir:new e.ch(t)}),heatmapTexture:t=>({u_image:new e.cg(t),u_color_ramp:new e.cg(t),u_opacity:new e.ci(t)}),hillshade:t=>({u_matrix:new e.ck(t),u_image:new e.cg(t),u_latrange:new e.cj(t),u_light:new e.cj(t),u_shadow:new e.dA(t),u_highlight:new e.dA(t),u_emissive_strength:new e.ci(t),u_accent:new e.dA(t)}),hillshadePrepare:t=>({u_matrix:new e.ck(t),u_image:new e.cg(t),u_dimension:new e.cj(t),u_zoom:new e.ci(t)}),line:e.dW,linePattern:e.dV,raster:t=>({u_matrix:new e.ck(t),u_normalize_matrix:new e.ck(t),u_globe_matrix:new e.ck(t),u_merc_matrix:new e.ck(t),u_grid_matrix:new e.dB(t),u_tl_parent:new e.cj(t),u_scale_parent:new e.ci(t),u_fade_t:new e.ci(t),u_opacity:new e.ci(t),u_image0:new e.cg(t),u_image1:new e.cg(t),u_brightness_low:new e.ci(t),u_brightness_high:new e.ci(t),u_saturation_factor:new e.ci(t),u_contrast_factor:new e.ci(t),u_spin_weights:new e.ch(t),u_perspective_transform:new e.cj(t),u_raster_elevation:new e.ci(t),u_zoom_transition:new e.ci(t),u_merc_center:new e.cj(t),u_cutoff_params:new e.d2(t),u_colorization_mix:new e.d2(t),u_colorization_offset:new e.ci(t),u_color_ramp:new e.cg(t),u_texture_offset:new e.cj(t),u_texture_res:new e.cj(t),u_emissive_strength:new e.ci(t)}),rasterParticle:t=>({u_matrix:new e.ck(t),u_normalize_matrix:new e.ck(t),u_globe_matrix:new e.ck(t),u_merc_matrix:new e.ck(t),u_grid_matrix:new e.dB(t),u_tl_parent:new e.cj(t),u_scale_parent:new e.ci(t),u_fade_t:new e.ci(t),u_opacity:new e.ci(t),u_image0:new e.cg(t),u_image1:new e.cg(t),u_raster_elevation:new e.ci(t),u_zoom_transition:new e.ci(t),u_merc_center:new e.cj(t),u_cutoff_params:new e.d2(t)}),rasterParticleTexture:t=>({u_texture:new e.cg(t),u_opacity:new e.ci(t)}),rasterParticleDraw:t=>({u_particle_texture:new e.cg(t),u_particle_texture_side_len:new e.ci(t),u_tile_offset:new e.cj(t),u_velocity:new e.cg(t),u_color_ramp:new e.cg(t),u_velocity_res:new e.cj(t),u_max_speed:new e.ci(t),u_uv_offset:new e.cj(t),u_data_scale:new e.cj(t),u_data_offset:new e.ci(t),u_particle_pos_scale:new e.ci(t),u_particle_pos_offset:new e.cj(t)}),rasterParticleUpdate:t=>({u_particle_texture:new e.cg(t),u_particle_texture_side_len:new e.ci(t),u_velocity:new e.cg(t),u_velocity_res:new e.cj(t),u_max_speed:new e.ci(t),u_speed_factor:new e.ci(t),u_reset_rate:new e.ci(t),u_rand_seed:new e.ci(t),u_uv_offset:new e.cj(t),u_data_scale:new e.cj(t),u_data_offset:new e.ci(t),u_particle_pos_scale:new e.ci(t),u_particle_pos_offset:new e.cj(t)}),symbol:t=>({u_is_size_zoom_constant:new e.cg(t),u_is_size_feature_constant:new e.cg(t),u_size_t:new e.ci(t),u_size:new e.ci(t),u_camera_to_center_distance:new e.ci(t),u_rotate_symbol:new e.cg(t),u_aspect_ratio:new e.ci(t),u_fade_change:new e.ci(t),u_matrix:new e.ck(t),u_label_plane_matrix:new e.ck(t),u_coord_matrix:new e.ck(t),u_is_text:new e.cg(t),u_elevation_from_sea:new e.cg(t),u_pitch_with_map:new e.cg(t),u_texsize:new e.cj(t),u_texsize_icon:new e.cj(t),u_texture:new e.cg(t),u_texture_icon:new e.cg(t),u_gamma_scale:new e.ci(t),u_device_pixel_ratio:new e.ci(t),u_tile_id:new e.ch(t),u_zoom_transition:new e.ci(t),u_inv_rot_matrix:new e.ck(t),u_merc_center:new e.cj(t),u_camera_forward:new e.ch(t),u_tile_matrix:new e.ck(t),u_up_vector:new e.ch(t),u_ecef_origin:new e.ch(t),u_is_halo:new e.cg(t),u_icon_transition:new e.ci(t),u_color_adj_mat:new e.ck(t),u_scale_factor:new e.ci(t),u_ground_shadow_factor:new e.ch(t),u_inv_matrix:new e.ck(t),u_normal_scale:new e.ci(t),u_lutTexture:new e.cg(t)}),background:t=>({u_matrix:new e.ck(t),u_emissive_strength:new e.ci(t),u_opacity:new e.ci(t),u_color:new e.dA(t)}),backgroundPattern:t=>({u_matrix:new e.ck(t),u_emissive_strength:new e.ci(t),u_opacity:new e.ci(t),u_image:new e.cg(t),u_pattern_tl:new e.cj(t),u_pattern_br:new e.cj(t),u_texsize:new e.cj(t),u_pattern_size:new e.cj(t),u_pixel_coord_upper:new e.cj(t),u_pixel_coord_lower:new e.cj(t),u_pattern_units_to_pixels:new e.cj(t)}),terrainRaster:t=>({u_matrix:new e.ck(t),u_image0:new e.cg(t),u_skirt_height:new e.ci(t),u_ground_shadow_factor:new e.ch(t)}),skybox:t=>({u_matrix:new e.ck(t),u_sun_direction:new e.ch(t),u_cubemap:new e.cg(t),u_opacity:new e.ci(t),u_temporal_offset:new e.ci(t)}),skyboxGradient:t=>({u_matrix:new e.ck(t),u_color_ramp:new e.cg(t),u_center_direction:new e.ch(t),u_radius:new e.ci(t),u_opacity:new e.ci(t),u_temporal_offset:new e.ci(t)}),skyboxCapture:t=>({u_matrix_3f:new e.dB(t),u_sun_direction:new e.ch(t),u_sun_intensity:new e.ci(t),u_color_tint_r:new e.d2(t),u_color_tint_m:new e.d2(t),u_luminance:new e.ci(t)}),globeRaster:t=>({u_proj_matrix:new e.ck(t),u_globe_matrix:new e.ck(t),u_normalize_matrix:new e.ck(t),u_merc_matrix:new e.ck(t),u_zoom_transition:new e.ci(t),u_merc_center:new e.cj(t),u_image0:new e.cg(t),u_grid_matrix:new e.dB(t),u_skirt_height:new e.ci(t),u_far_z_cutoff:new e.ci(t),u_frustum_tl:new e.ch(t),u_frustum_tr:new e.ch(t),u_frustum_br:new e.ch(t),u_frustum_bl:new e.ch(t),u_globe_pos:new e.ch(t),u_globe_radius:new e.ci(t),u_viewport:new e.cj(t)}),globeAtmosphere:t=>({u_frustum_tl:new e.ch(t),u_frustum_tr:new e.ch(t),u_frustum_br:new e.ch(t),u_frustum_bl:new e.ch(t),u_horizon:new e.ci(t),u_transition:new e.ci(t),u_fadeout_range:new e.ci(t),u_atmosphere_fog_color:new e.d2(t),u_high_color:new e.d2(t),u_space_color:new e.d2(t),u_temporal_offset:new e.ci(t),u_horizon_angle:new e.ci(t)}),model:t=>({u_matrix:new e.ck(t),u_lighting_matrix:new e.ck(t),u_normal_matrix:new e.ck(t),u_node_matrix:new e.ck(t),u_lightpos:new e.ch(t),u_lightintensity:new e.ci(t),u_lightcolor:new e.ch(t),u_camera_pos:new e.ch(t),u_opacity:new e.ci(t),u_baseColorFactor:new e.d2(t),u_emissiveFactor:new e.d2(t),u_metallicFactor:new e.ci(t),u_roughnessFactor:new e.ci(t),u_baseTextureIsAlpha:new e.cg(t),u_alphaMask:new e.cg(t),u_alphaCutoff:new e.ci(t),u_baseColorTexture:new e.cg(t),u_metallicRoughnessTexture:new e.cg(t),u_normalTexture:new e.cg(t),u_occlusionTexture:new e.cg(t),u_emissionTexture:new e.cg(t),u_lutTexture:new e.cg(t),u_color_mix:new e.d2(t),u_aoIntensity:new e.ci(t),u_emissive_strength:new e.ci(t),u_occlusionTextureTransform:new e.d2(t)}),modelDepth:t=>({u_matrix:new e.ck(t),u_instance:new e.ck(t),u_node_matrix:new e.ck(t)}),groundShadow:t=>({u_matrix:new e.ck(t),u_ground_shadow_factor:new e.ch(t)}),stars:t=>({u_matrix:new e.ck(t),u_up:new e.ch(t),u_right:new e.ch(t),u_intensity_multiplier:new e.ci(t)}),snowParticle:t=>({u_modelview:new e.ck(t),u_projection:new e.ck(t),u_time:new e.ci(t),u_cam_pos:new e.ch(t),u_velocityConeAperture:new e.ci(t),u_velocity:new e.ci(t),u_horizontalOscillationRadius:new e.ci(t),u_horizontalOscillationRate:new e.ci(t),u_boxSize:new e.ci(t),u_billboardSize:new e.ci(t),u_simpleShapeParameters:new e.cj(t),u_screenSize:new e.cj(t),u_thinningCenterPos:new e.cj(t),u_thinningShape:new e.ch(t),u_thinningAffectedRatio:new e.ci(t),u_thinningParticleOffset:new e.ci(t),u_particleColor:new e.d2(t),u_direction:new e.ch(t)}),rainParticle:t=>({u_modelview:new e.ck(t),u_projection:new e.ck(t),u_time:new e.ci(t),u_cam_pos:new e.ch(t),u_texScreen:new e.cg(t),u_velocityConeAperture:new e.ci(t),u_velocity:new e.ci(t),u_boxSize:new e.ci(t),u_rainDropletSize:new e.cj(t),u_distortionStrength:new e.ci(t),u_rainDirection:new e.ch(t),u_color:new e.d2(t),u_screenSize:new e.cj(t),u_thinningCenterPos:new e.cj(t),u_thinningShape:new e.ch(t),u_thinningAffectedRatio:new e.ci(t),u_thinningParticleOffset:new e.ci(t),u_shapeDirectionalPower:new e.ci(t),u_shapeNormalPower:new e.ci(t),u_mode:new e.ci(t)}),vignette:t=>({u_vignetteShape:new e.ch(t),u_vignetteColor:new e.d2(t)}),occlusion:t=>({u_matrix:new e.ck(t),u_anchorPos:new e.ch(t),u_screenSizePx:new e.cj(t),u_occluderSizePx:new e.cj(t),u_color:new e.d2(t)})};class ko{constructor(e,t,i,n){this.id=ko.uniqueIdxCounter,ko.uniqueIdxCounter++,this.context=e;const r=e.gl;this.buffer=r.createBuffer(),this.dynamicDraw=Boolean(i),this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.arrayBuffer,this.dynamicDraw?r.DYNAMIC_DRAW:r.STATIC_DRAW),this.dynamicDraw||n||t.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(e){this.id=ko.uniqueIdxCounter,ko.uniqueIdxCounter++;const t=this.context.gl;this.context.unbindVAO(),this.bind(),t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}ko.uniqueIdxCounter=0;const Uo={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class zo{constructor(e,t,i,n,r,o){this.length=t.length,this.attributes=i,this.itemSize=t.bytesPerElement,this.dynamicDraw=n,this.instanceCount=o,this.context=e;const s=e.gl;this.buffer=s.createBuffer(),e.bindVertexBuffer.set(this.buffer),s.bufferData(s.ARRAY_BUFFER,t.arrayBuffer,this.dynamicDraw?s.DYNAMIC_DRAW:s.STATIC_DRAW),this.dynamicDraw||r||t.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(e){const t=this.context.gl;this.bind(),t.bufferSubData(t.ARRAY_BUFFER,0,e.arrayBuffer)}enableAttributes(e,t){for(let i=0;i<this.attributes.length;i++){const n=t.getAttributeLocation(e,this.attributes[i].name);-1!==n&&e.enableVertexAttribArray(n)}}setVertexAttribPointers(e,t,i){for(let n=0;n<this.attributes.length;n++){const r=this.attributes[n],o=t.getAttributeLocation(e,r.name);-1!==o&&e.vertexAttribPointer(o,r.components,e[Uo[r.type]],!1,this.itemSize,r.offset+this.itemSize*(i||0))}}setVertexAttribDivisor(e,t,i){for(let n=0;n<this.attributes.length;n++){const r=t.getAttributeLocation(e,this.attributes[n].name);-1!==r&&this.instanceCount&&this.instanceCount>0&&e.vertexAttribDivisor(r,i)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Vo{constructor(e,t,i,n,r){this.context=e,this.width=t,this.height=i;const o=this.framebuffer=e.gl.createFramebuffer();n&&(this.colorAttachment=new Dr(e,o)),r&&(this.depthAttachmentType=r,this.depthAttachment="renderbuffer"===r?new Br(e,o):new Fr(e,o))}destroy(){const e=this.context.gl;if(this.colorAttachment){const t=this.colorAttachment.get();t&&e.deleteTexture(t)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const t=this.depthAttachment.get();t&&e.deleteRenderbuffer(t)}else{const t=this.depthAttachment.get();t&&e.deleteTexture(t)}e.deleteFramebuffer(this.framebuffer)}}class Go{constructor(e,t){this.gl=e,this.clearColor=new ir(this),this.clearDepth=new nr(this),this.clearStencil=new rr(this),this.colorMask=new or(this),this.depthMask=new sr(this),this.stencilMask=new ar(this),this.stencilFunc=new lr(this),this.stencilOp=new cr(this),this.stencilTest=new ur(this),this.depthRange=new hr(this),this.depthTest=new dr(this),this.depthFunc=new pr(this),this.blend=new fr(this),this.blendFunc=new mr(this),this.blendColor=new gr(this),this.blendEquation=new _r(this),this.cullFace=new yr(this),this.cullFaceSide=new vr(this),this.frontFace=new xr(this),this.program=new br(this),this.activeTexture=new Tr(this),this.viewport=new wr(this),this.bindFramebuffer=new Er(this),this.bindRenderbuffer=new Sr(this),this.bindTexture=new Ar(this),this.bindVertexBuffer=new Mr(this),this.bindElementBuffer=new Ir(this),this.bindVertexArrayOES=new Cr(this),this.pixelStoreUnpack=new Pr(this),this.pixelStoreUnpackPremultiplyAlpha=new Lr(this),this.pixelStoreUnpackFlipY=new Rr(this),this.options=t?Object.assign({},t):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=e.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=e.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=e.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=t&&!!t.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=e.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=e.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=e.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxPointSize=e.getParameter(e.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(e,t,i){return new ko(this,e,t,i)}createVertexBuffer(e,t,i,n,r){return new zo(this,e,t,i,n,r)}createRenderbuffer(e,t,i){const n=this.gl,r=n.createRenderbuffer();return this.bindRenderbuffer.set(r),n.renderbufferStorage(n.RENDERBUFFER,e,t,i),this.bindRenderbuffer.set(null),r}createFramebuffer(e,t,i,n){return new Vo(this,e,t,i,n)}clear({color:e,depth:t,stencil:i,colorMask:n}){const r=this.gl;let o=0;e&&(o|=r.COLOR_BUFFER_BIT,this.clearColor.set(e.toNonPremultipliedRenderColor(null)),this.colorMask.set(n||[!0,!0,!0,!0])),void 0!==t&&(o|=r.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(t),this.depthMask.set(!0)),void 0!==i&&(o|=r.STENCIL_BUFFER_BIT,this.clearStencil.set(i),this.stencilMask.set(255)),r.clear(o)}setCullFace(e){!1===e.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace))}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1)}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1)}setColorMode(t){e.bx(t.blendFunction,$i.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let jo;function Ho(t,i,n,r,o,s,a){const l=t.context,c=l.gl,u=t.transform,h=[e.aF(u.center.lng),e.aJ(u.center.lat)],d=n.layout.get("symbol-placement"),p=n.layout.get("text-variable-anchor"),f="map"===n.layout.get("icon-rotation-alignment"),m="map"===n.layout.get("text-rotation-alignment"),g="point"!==d,_=[];let y=0,v=0;for(let l=0;l<r.length;l++){const d=r[l],x=i.getTile(d),b=x.getBucket(n);if(!b)continue;const T=b.getProjection().createInversionMatrix(u,d.canonical),w=[],E=Yt(d,b,u),S=!a&&f&&g,A=a&&m&&g,M=p&&b.hasTextData(),I=b.hasIconTextFit()&&M&&b.hasIconData(),C=S||A||a&&M||I,P="globe"===b.projection.name,L=P?e.aj(u.zoom):0;P&&(w.push("PROJECTION_GLOBE_VIEW"),C&&w.push("PROJECTED_POS_ON_VIEWPORT"));const R=t.getOrCreateProgram("collisionBox",{defines:w});let O=E;0===o[0]&&0===o[1]||(O=t.translatePosMatrix(E,x,o,s));const D=a?b.textCollisionBox:b.iconCollisionBox,B=b.collisionCircleArray;if(B.length>0){const t=e.bB(),i=O;e.cO(t,b.placementInvProjMatrix,u.glCoordMatrix),e.cO(t,t,b.placementViewportMatrix),_.push({circleArray:B,circleOffset:v,transform:i,invTransform:t,projection:b.getProjection()}),y+=B.length/4,v=y}if(!D)continue;t.terrain&&t.terrain.setupElevationDraw(x,R);const F=P?[d.canonical.x,d.canonical.y,1<<d.canonical.z]:[0,0,0];R.draw(t,c.LINES,Wi.disabled,Xi.disabled,t.colorModeForRenderPass(),Ji.disabled,yo(O,T,u,L,h,x,F,b.getProjection()),n.id,D.layoutVertexBuffer,D.indexBuffer,D.segments,null,u.zoom,null,[D.collisionVertexBuffer,D.collisionVertexBufferExt])}if(!a||!_.length)return;const x=t.getOrCreateProgram("collisionCircle"),b=new e.dY;b.resize(4*y),b._trim();let T=0;for(const e of _)for(let t=0;t<e.circleArray.length/4;t++){const i=4*t,n=e.circleArray[i+0],r=e.circleArray[i+1],o=e.circleArray[i+2],s=e.circleArray[i+3];b.emplace(T++,n,r,o,s,0),b.emplace(T++,n,r,o,s,1),b.emplace(T++,n,r,o,s,2),b.emplace(T++,n,r,o,s,3)}(!jo||jo.length<2*y)&&(jo=function(t){const i=2*t,n=new e.b0;n.resize(i),n._trim();for(let e=0;e<i;e++){const t=6*e;n.uint16[t+0]=4*e+0,n.uint16[t+1]=4*e+1,n.uint16[t+2]=4*e+2,n.uint16[t+3]=4*e+2,n.uint16[t+4]=4*e+3,n.uint16[t+5]=4*e+0}return n}(y));const w=l.createIndexBuffer(jo,!0),E=l.createVertexBuffer(b,e.dZ.members,!0);for(const i of _){const r={u_matrix:i.transform,u_inv_matrix:i.invTransform,u_camera_to_center_distance:(S=u).getCameraToCenterDistance(i.projection),u_viewport_size:[S.width,S.height]};x.draw(t,c.TRIANGLES,Wi.disabled,Xi.disabled,t.colorModeForRenderPass(),Ji.disabled,r,n.id,E,w,e.bf.simpleSegment(0,2*i.circleOffset,i.circleArray.length,i.circleArray.length/2),null,u.zoom)}var S;E.destroy(),w.destroy()}const $o=e.bB();function Wo(t){const i=t._camera.getWorldToCamera(t.worldSize,1),n=e.aB([],i,t.globeMatrix);e.bk(n,n);const r=[0,0,0],o=[0,1,0,0];return e.aC(o,o,n),r[0]=o[0],r[1]=o[1],r[2]=o[2],e.aw(r,r),r}function qo({width:t,height:i,anchor:n,textOffset:r,textScale:o},s){const{horizontalAlign:a,verticalAlign:l}=e.c0(n),c=-(a-.5)*t,u=-(l-.5)*i,h=e.c1(n,r);return new e.P((c/o+h[0])*s,(u/o+h[1])*s)}function Xo(t,i,n,r,o,s,a,l,c,u){const h=t.text.placedSymbolArray,d=t.text.dynamicLayoutVertexArray,p=t.icon.dynamicLayoutVertexArray,f={},m=t.getProjection(),g=Zt(a,m,o),_=o.elevation,y=m.upVectorScale(a.canonical,o.center.lat,o.worldSize).metersToTile;d.clear();for(let p=0;p<h.length;p++){const v=h.get(p),{tileAnchorX:x,tileAnchorY:b,numGlyphs:T}=v,w=v.hidden||!v.crossTileID||t.allowVerticalPlacement&&!v.placedOrientation?null:r[v.crossTileID];if(w){let r=0,h=0,E=0;const S="road"===t.elevationType;if(_||S){const i=S?t.getElevationFeatureForText(p):null,n=e.bU.getAtTileOffset(a,new e.P(x,b),_,i),[o,s,l]=m.upVector(a.canonical,x,b);r=n*o*y,h=n*s*y,E=n*l*y}let[A,M,I,C]=ri(v.projectedAnchorX+r,v.projectedAnchorY+h,v.projectedAnchorZ+E,n?g:s);const P=oi(o.getCameraToCenterDistance(m),C);let L=e.bL(t.textSizeData,c,v)*P/e.bX;n&&(L*=t.tilePixelRatio/l);const R=qo(w,L);n?(({x:A,y:M,z:I}=m.projectTilePoint(x+R.x,b+R.y,a.canonical)),[A,M,I]=ri(A+r,M+h,I+E,s)):(i&&R._rotate(-o.angle),A+=R.x,M+=R.y,I=0);const O=t.allowVerticalPlacement&&v.placedOrientation===e.bK.vertical?Math.PI/2:0;for(let t=0;t<T;t++)e.bN(d,A,M,I,O);u&&v.associatedIconIndex>=0&&(f[v.associatedIconIndex]={x:A,y:M,z:I,angle:O})}else fi(T,d)}if(u){p.clear();const i=t.icon.placedSymbolArray;for(let t=0;t<i.length;t++){const n=i.get(t),{numGlyphs:r}=n,o=f[t];if(n.hidden||!o)fi(r,p);else{const{x:t,y:i,z:n,angle:s}=o;for(let o=0;o<r;o++)e.bN(p,t,i,n,s)}}t.icon.dynamicLayoutVertexBuffer.updateData(p)}t.text.dynamicLayoutVertexBuffer.updateData(d)}function Yo(t,i,n,r,o,s,a={}){const l=n.paint.get("icon-translate"),c=n.paint.get("text-translate"),u=n.paint.get("icon-translate-anchor"),h=n.paint.get("text-translate-anchor"),d=n.layout.get("icon-rotation-alignment"),p=n.layout.get("text-rotation-alignment"),f=n.layout.get("icon-pitch-alignment"),m=n.layout.get("text-pitch-alignment"),g=n.layout.get("icon-keep-upright"),_=n.layout.get("text-keep-upright"),y=n.paint.get("icon-color-saturation"),v=n.paint.get("icon-color-contrast"),x=n.paint.get("icon-color-brightness-min"),b=n.paint.get("icon-color-brightness-max"),T="sea"===n.layout.get("symbol-elevation-reference"),w="none"===n.layout.get("icon-image-use-theme"),E=t.context,S=E.gl,A=t.transform,M="map"===d,I="map"===p,C="map"===f,P="map"===m,L=void 0!==n.layout.get("symbol-sort-key").constantOr(1);let R=!1;const O=t.depthModeForSublayer(0,Wi.ReadOnly),D=new Wi(t.context.gl.LEQUAL,Wi.ReadOnly,t.depthRangeFor3D),B=[e.aF(A.center.lng),e.aJ(A.center.lat)],F=n.layout.get("text-variable-anchor"),N="globe"===A.projection.name,k=[],U=[0,-1,0];for(const o of r){const r=i.getTile(o),s=r.getBucket(n);if(!s)continue;if("mercator"===s.projection.name&&N)continue;if(s.fullyClipped)continue;const d="globe"===s.projection.name,p=d?e.aj(A.zoom):0,f=Zt(o,s.getProjection(),A),m=A.calculatePixelsToTileUnitsMatrix(r),z=F&&s.hasTextData(),V=s.hasIconTextFit()&&z&&s.hasIconData(),G=s.getProjection().createInversionMatrix(A,o.canonical),j=(1<<r.tileID.canonical.z)*e.al/t.transform.worldSize,H=e=>{let i=[0,0,0];if(e){const e=t.style.directionalLight,n=t.style.ambientLight;e&&n&&(i=mn(t.style,e,n))}return i},$=e=>{A.depthOcclusionForSymbolsAndCircles&&(n.hasOcclusionOpacityProperties||t.terrain)&&(e.push("DEPTH_D24"),e.push("DEPTH_OCCLUSION"))},W=i=>{n.lut&&!w&&(n.lut.texture||(n.lut.texture=new e.d_(t.context,n.lut.image,[n.lut.image.height,n.lut.image.height,n.lut.image.height],E.gl.RGBA8)),E.activeTexture.set(E.gl.TEXTURE0+rn.LUT),n.lut.texture&&n.lut.texture.bind(E.gl.LINEAR,E.gl.CLAMP_TO_EDGE),i.push("APPLY_LUT_ON_GPU"))},q=()=>{const i=M&&"point"!==n.layout.get("symbol-placement"),a=[];$(a),W(a);const c=i||V,h="road"===s.elevationType,_=t.shadowRenderer,w=h&&C&&!!_&&_.enabled,E=H(w),I=h&&C&&!t.terrain?D:O,P=n.paint.get("icon-image-cross-fade");t.terrainRenderModeElevated()&&C&&a.push("PITCH_WITH_MAP_TERRAIN"),d&&(a.push("PROJECTION_GLOBE_VIEW"),c&&a.push("PROJECTED_POS_ON_VIEWPORT")),P>0&&s.hasAnySecondaryIcon&&a.push("ICON_TRANSITION"),!s.icon.zOffsetVertexBuffer||h&&t.terrain||a.push("Z_OFFSET"),0===y&&0===v&&0===x&&1===b||a.push("COLOR_ADJUSTMENT"),s.sdfIcons&&a.push("RENDER_SDF"),w&&a.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),h&&C&&!t.terrain&&s.icon.orientationVertexBuffer&&a.push("ELEVATED_ROADS");const L=s.icon.programConfigurations.get(n.id),R=t.getOrCreateProgram("symbol",{config:L,defines:a}),F=r.imageAtlasTexture?r.imageAtlasTexture.size:[0,0],k=s.iconSizeData,z=e.bJ(k,A.zoom),q=C||!A.isOrthographic,X=ti(f,r.tileID.canonical,C,M,A,s.getProjection(),m),Y=ni(f,r.tileID.canonical,C,M,A,s.getProjection(),m),Z=t.translatePosMatrix(Y,r,l,u,!0),J=t.translatePosMatrix(f,r,l,u),K=c?$o:X,Q=M&&!C&&!i;let ee=U;!N&&!A.mercatorFromTransition||M||(ee=Wo(A));const te=d?ee:U,ie=n.getColorAdjustmentMatrix(y,v,x,b),ne=Lo(k.kind,z,Q,C,t,J,K,Z,T,!1,F,[0,0],0,o,p,B,G,te,s.getProjection(),E,j,ie,P,null),re=r.imageAtlasTexture?r.imageAtlasTexture:null,oe=1!==n.layout.get("icon-size").constantOr(0)||s.iconsNeedLinear,se=s.sdfIcons||t.options.rotating||t.options.zooming||oe||q?S.LINEAR:S.NEAREST,ae=s.sdfIcons&&0!==n.paint.get("icon-halo-width").constantOr(1),le=t.terrain&&C&&i?e.bk(e.bB(),X):$o;if(i&&s.icon){const i=e.bU.getAtTileOffsetFunc(o,A.center.lat,A.worldSize,s.getProjection()),a=ii(f,r.tileID.canonical,C,M,A,s.getProjection(),m),l=n.layout.get("icon-size-scale-range"),c=e.aA(t.scaleFactor,l[0],l[1]);ai(s,f,t,!1,a,Y,C,g,i,o,c)}return{program:R,buffers:s.icon,uniformValues:ne,atlasTexture:re,atlasTextureIcon:null,atlasInterpolation:se,atlasInterpolationIcon:null,isSDF:s.sdfIcons,hasHalo:ae,depthMode:I,tile:r,renderWithShadows:w,labelPlaneMatrixInv:le}},X=()=>{const i=I&&"point"!==n.layout.get("symbol-placement"),a=[],l=i||F||V,u="road"===s.elevationType,g=t.shadowRenderer,y=u&&P&&!!g&&g.enabled,v=H(y),x=u&&P&&!t.terrain?D:O;t.terrainRenderModeElevated()&&P&&a.push("PITCH_WITH_MAP_TERRAIN"),d&&(a.push("PROJECTION_GLOBE_VIEW"),l&&a.push("PROJECTED_POS_ON_VIEWPORT")),!s.text.zOffsetVertexBuffer||u&&t.terrain||a.push("Z_OFFSET"),s.iconsInText&&a.push("RENDER_TEXT_AND_SYMBOL"),a.push("RENDER_SDF"),y&&a.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),u&&P&&!t.terrain&&s.text.orientationVertexBuffer&&a.push("ELEVATED_ROADS"),$(a);const b=s.text.programConfigurations.get(n.id),w=t.getOrCreateProgram("symbol",{config:b,defines:a});let E,M=[0,0],C=null;const L=s.textSizeData;s.iconsInText&&(M=r.imageAtlasTexture?r.imageAtlasTexture.size:[0,0],C=r.imageAtlasTexture?r.imageAtlasTexture:null,E=P||!A.isOrthographic||t.options.rotating||t.options.zooming||"composite"===L.kind||"camera"===L.kind?S.LINEAR:S.NEAREST);const R=r.glyphAtlasTexture?r.glyphAtlasTexture.size:[0,0],k=n.layout.get("text-size-scale-range"),z=e.aA(t.scaleFactor,k[0],k[1]),W=e.bJ(L,A.zoom,z),q=ti(f,r.tileID.canonical,P,I,A,s.getProjection(),m),X=ni(f,r.tileID.canonical,P,I,A,s.getProjection(),m),Y=t.translatePosMatrix(X,r,c,h,!0),Z=t.translatePosMatrix(f,r,c,h),J=l?$o:q,K=I&&!P&&!i;let Q=U;!N&&!A.mercatorFromTransition||I||(Q=Wo(A));const ee=Lo(L.kind,W,K,P,t,Z,J,Y,T,!0,R,M,0,o,p,B,G,d?Q:U,s.getProjection(),v,j,null,null,z),te=r.glyphAtlasTexture?r.glyphAtlasTexture:null,ie=S.LINEAR,ne=0!==n.paint.get("text-halo-width").constantOr(1),re=t.terrain&&P&&i?e.bk(e.bB(),q):$o;if(i&&s.text){const i=e.bU.getAtTileOffsetFunc(o,A.center.lat,A.worldSize,s.getProjection()),n=ii(f,r.tileID.canonical,P,I,A,s.getProjection(),m);ai(s,f,t,!0,n,X,P,_,i,o,z)}return{program:w,buffers:s.text,uniformValues:ee,atlasTexture:te,atlasTextureIcon:C,atlasInterpolation:ie,atlasInterpolationIcon:E,isSDF:!0,hasHalo:ne,depthMode:x,tile:r,renderWithShadows:y,labelPlaneMatrixInv:re}},Y=s.icon.segments.get().length,Z=s.text.segments.get().length,J=Y&&!a.onlyText?q():null,K=Z&&!a.onlyIcons?X():null,Q=n.paint.get("icon-opacity").constantOr(1),ee=n.paint.get("text-opacity").constantOr(1);if(L&&s.canOverlap){R=!0;const t=Q&&!a.onlyText?s.icon.segments.get():[],i=ee&&!a.onlyIcons?s.text.segments.get():[];for(const i of t)k.push({segments:new e.bf([i]),sortKey:i.sortKey,state:J});for(const t of i)k.push({segments:new e.bf([t]),sortKey:t.sortKey,state:K})}else a.onlyText||k.push({segments:Q?s.icon.segments:new e.bf([]),sortKey:0,state:J}),a.onlyIcons||k.push({segments:ee?s.text.segments:new e.bf([]),sortKey:0,state:K})}R&&k.sort(((e,t)=>e.sortKey-t.sortKey));for(const e of k){const i=e.state;if(i)if(t.terrain?t.terrain.setupElevationDraw(i.tile,i.program,{useDepthForOcclusion:A.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:i.labelPlaneMatrixInv}):t.setupDepthForOcclusion(A.depthOcclusionForSymbolsAndCircles,i.program),E.activeTexture.set(S.TEXTURE0),i.atlasTexture&&i.atlasTexture.bind(i.atlasInterpolation,S.CLAMP_TO_EDGE,!0),i.atlasTextureIcon&&(E.activeTexture.set(S.TEXTURE1),i.atlasTextureIcon&&i.atlasTextureIcon.bind(i.atlasInterpolationIcon,S.CLAMP_TO_EDGE,!0)),i.renderWithShadows&&t.shadowRenderer.setupShadows(i.tile.tileID.toUnwrapped(),i.program,"vector-tile"),t.uploadCommonLightUniforms(t.context,i.program),i.hasHalo){const r=i.uniformValues;r.u_is_halo=1,Zo(i.buffers,e.segments,n,t,i.program,i.depthMode,o,s,r,2),r.u_is_halo=0}else{if(i.isSDF){const r=i.uniformValues;i.hasHalo&&(r.u_is_halo=1,Zo(i.buffers,e.segments,n,t,i.program,i.depthMode,o,s,r,1)),r.u_is_halo=0}Zo(i.buffers,e.segments,n,t,i.program,i.depthMode,o,s,i.uniformValues,1)}}}function Zo(e,t,i,n,r,o,s,a,l,c){const u=[e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer,e.iconTransitioningVertexBuffer,e.globeExtVertexBuffer,e.zOffsetVertexBuffer,e.orientationVertexBuffer];r.draw(n,n.context.gl.TRIANGLES,o,s,a,Ji.disabled,l,i.id,e.layoutVertexBuffer,e.indexBuffer,t,i.paint,n.transform.zoom,e.programConfigurations.get(i.id),u,c)}function Jo(t,i){const n=1<<t.canonical.z,r=(i.x*n-t.canonical.x-t.wrap*n)*e.al,o=(i.y*n-t.canonical.y)*e.al,s=e.e7(i.z,i.y);return e.d4(r,o,s)}function Ko(t,i,n,r,o){if(!n.layout||"none"===n.layout.get("fill-elevation-reference")||0===n.paint.get("fill-opacity").constantOr(1))return;const s=t.context.gl,a=new Wi(t.context.gl.LEQUAL,Wi.ReadWrite,t.depthRangeFor3D),l=new Wi(t.context.gl.GREATER,Wi.ReadWrite,t.depthRangeFor3D),c=function(t){let i=.01;return t.isOrthographic&&(i=e.ak(1e-4,i,e.c$(t.pitch>=sn?1:t.pitch/sn))),2*i}(t.transform),u=t.transform.getFreeCameraOptions().position,h="elevatedStructuresDepthReconstruct",d=t.getOrCreateProgram(h,{defines:["DEPTH_RECONSTRUCTION"]}),p=t.getOrCreateProgram(h);for(const e of r){const r=i.getTile(e),h=r.getBucket(n);if(!h)continue;const f=h.elevatedStructures;if(!f)continue;const m=h.elevationBufferData.heightRange,g=Jo(e.toUnwrapped(),u),_=t.translatePosMatrix(e.projMatrix,r,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));let y,v,x,b;if("initialize"===o){if(!m||m.min>=1||0===f.depthSegments.segments[0].primitiveLength)continue;y=fo(_,g,c,1,0),v=a,x=f.depthSegments,b=d}else if("reset"===o){if(!m||m.min>=0||0===f.maskSegments.segments[0].primitiveLength)continue;y=fo(_,g,0,0,1),v=l,x=f.maskSegments,b=d}else if("geometry"===o){if(0===f.depthSegments.segments[0].primitiveLength)continue;y=fo(_,g,c,1,0),v=a,x=f.depthSegments,b=p}b.draw(t,s.TRIANGLES,v,Xi.disabled,$i.disabled,Ji.disabled,y,n.id,f.vertexBuffer,f.indexBuffer,x,n.paint,t.transform.zoom)}}function Qo(t,i,n){const{painter:r,sourceCache:o,layer:s,coords:a,colorMode:l,elevationType:c,terrainEnabled:u,pass:h}=t,d=r.context.gl,p=s.paint.get("fill-pattern"),f=s.paint.get("fill-pattern-cross-fade"),m=p.constantOr(null);let g=c;"road"!==c||i&&!u||(g="none");const _="road"===g,y=t.painter.shadowRenderer,v=_&&!!y&&y.enabled,x=new Wi(r.context.gl.LEQUAL,Wi.ReadOnly,r.depthRangeFor3D);let b=[0,0,0];if(v){const e=r.style.directionalLight,t=r.style.ambientLight;e&&t&&(b=mn(r.style,e,t))}const T=p&&p.constantOr(1),w=(t,h)=>{let p,g,w,E,S;h?(p=T&&!s.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",w=d.LINES):(p=T?"fillPattern":"fill",w=d.TRIANGLES);for(const A of a){const a=o.getTile(A);if(T&&!a.patternsLoaded())continue;const M=a.getBucket(s);if(!M)continue;const I=i?M.elevationBufferData:M.bufferData;if(I.isEmpty())continue;r.prepareDrawTile();const C=I.programConfigurations.get(s.id),P=r.isTileAffectedByFog(A),L=[],R=[];_&&(L.push("ELEVATED_ROADS"),R.push(I.elevatedLayoutVertexBuffer)),v&&L.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),T&&(r.context.activeTexture.set(d.TEXTURE0),a.imageAtlasTexture&&a.imageAtlasTexture.bind(d.LINEAR,d.CLAMP_TO_EDGE),C.updatePaintBuffers());let O=!1;if(m&&a.imageAtlas){const t=a.imageAtlas,i=e.e2.from(m),n=i.getPrimary().scaleSelf(e.o.devicePixelRatio).toString(),r=i.getSecondary(),o=t.patternPositions.get(n),s=r?t.patternPositions.get(r.scaleSelf(e.o.devicePixelRatio).toString()):null;O=!!o&&!!s,o&&C.setConstantPatternPositions(o,s)}f>0&&(O||C.getPatternTransitionVertexBuffer("fill-pattern"))&&L.push("FILL_PATTERN_TRANSITION");const D=r.getOrCreateProgram(p,{config:C,overrideFog:P,defines:L}),B=r.translatePosMatrix(A.projMatrix,a,s.paint.get("fill-translate"),s.paint.get("fill-translate-anchor"));v&&y.setupShadows(a.tileID.toUnwrapped(),D,"vector-tile");const F=s.paint.get("fill-emissive-strength");if(h){E=I.lineIndexBuffer,S=I.lineSegments;const e=r.terrain&&r.terrain.renderingToTexture?r.terrain.drapeBufferSize:[d.drawingBufferWidth,d.drawingBufferHeight];g="fillOutlinePattern"===p&&T?ho(B,F,r,a,e,b,f):uo(B,F,e,b)}else E=I.indexBuffer,S=I.triangleSegments,g=T?co(B,F,r,a,b,f):lo(B,F,b);r.uploadCommonUniforms(r.context,D,A.toUnwrapped());let N=t;("road"===c&&!u||"offset"===c)&&(N=x),D.draw(r,w,N,n||r.stencilModeForClipping(A),l,Ji.disabled,g,s.id,I.layoutVertexBuffer,E,S,s.paint,r.transform.zoom,C,R)}};r.renderPass===h&&w(r.depthModeForSublayer(1,"opaque"===r.renderPass?Wi.ReadWrite:Wi.ReadOnly),!1),"none"===g&&"translucent"===r.renderPass&&s.paint.get("fill-antialias")&&w(r.depthModeForSublayer(s.getPaintProperty("fill-outline-color")?2:0,Wi.ReadOnly),!0)}function es(t,i,n,r,o,s,a,l){n.resetLayerRenderingStats(t);const c=t.context,u=c.gl,h=t.transform,d=n.paint.get("fill-extrusion-pattern"),p=n.paint.get("fill-extrusion-pattern-cross-fade"),f=d.constantOr(null),m=d.constantOr(1),g=n.paint.get("fill-extrusion-opacity"),_=t.style.enable3dLights(),y=n.paint.get(_&&!m?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),v=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),y],x=n.layout.get("fill-extrusion-edge-radius"),b=x>0&&!n.paint.get("fill-extrusion-rounded-roof"),T=b?0:x,w="globe"===h.projection.name?e.ea():0,E="globe"===h.projection.name,S=E?e.aj(h.zoom):0,A=[e.aF(h.center.lng),e.aJ(h.center.lat)],M="none"===n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),I=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(M?null:n.lut).toArray01().slice(0,3),C=n.paint.get("fill-extrusion-flood-light-intensity"),P=n.paint.get("fill-extrusion-vertical-scale"),L=0!==n.paint.get("fill-extrusion-line-width").constantOr(1),R=n.paint.get("fill-extrusion-height-alignment"),O=n.paint.get("fill-extrusion-base-alignment"),D=ln(t,n.paint.get("fill-extrusion-cutoff-fade-range")),B=[];let F;E&&B.push("PROJECTION_GLOBE_VIEW"),v[0]>0&&B.push("FAUX_AO"),b&&B.push("ZERO_ROOF_RADIUS"),l&&B.push("HAS_CENTROID"),C>0&&B.push("FLOOD_LIGHT"),D.shouldRenderCutoff&&B.push("RENDER_CUTOFF"),L&&B.push("RENDER_WALL_MODE");const N="shadow"===t.renderPass,k=t.shadowRenderer,U=N&&!!k,z=N?Ji.disabled:Ji.backCCW;t.shadowRenderer&&(t.shadowRenderer.useNormalOffset=!0);let V=[0,0,0];if(k){const e=t.style.directionalLight,i=t.style.ambientLight;e&&i&&(V=mn(t.style,e,i)),N||(B.push("RENDER_SHADOWS","DEPTH_TEXTURE"),k.useNormalOffset&&B.push("NORMAL_OFFSET")),F=B.concat(["SHADOWS_SINGLE_CASCADE"])}const G=U?"fillExtrusionDepth":m?"fillExtrusionPattern":"fillExtrusion",j=n.getLayerRenderingStats();for(const d of r){const r=i.getTile(d),_=r.getBucket(n);if(!_||_.projection.name!==h.projection.name)continue;let y=!1;k&&(y=0===k.getMaxCascadeForTile(d.toUnwrapped()));const x=t.isTileAffectedByFog(d),b=_.programConfigurations.get(n.id);let M=!1;if(f&&r.imageAtlas){const t=r.imageAtlas,i=e.e2.from(f),n=i.getPrimary().scaleSelf(e.o.devicePixelRatio).toString(),o=i.getSecondary(),s=t.patternPositions.get(n),a=o?t.patternPositions.get(o.scaleSelf(e.o.devicePixelRatio).toString()):null;M=!!s&&!!a,s&&b.setConstantPatternPositions(s,a)}p>0&&(M||b.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&B.push("FILL_EXTRUSION_PATTERN_TRANSITION");const U=t.getOrCreateProgram(G,{config:b,defines:y?F:B,overrideFog:x});if(t.terrain&&t.terrain.setupElevationDraw(r,U,{useMeterToDem:!0}),!_.centroidVertexBuffer){const e=U.getAttributeLocation(u,"a_centroid_pos");-1!==e&&u.vertexAttrib2f(e,0,0)}!N&&k&&k.setupShadows(r.tileID.toUnwrapped(),U,"vector-tile"),m&&(t.context.activeTexture.set(u.TEXTURE0),r.imageAtlasTexture&&r.imageAtlasTexture.bind(u.LINEAR,u.CLAMP_TO_EDGE),b.updatePaintBuffers());const H=n.paint.get("fill-extrusion-vertical-gradient"),$=1/_.tileToMeter;let W;if(N&&k){if(as(r.tileID,_.maxHeight,t))continue;const e=k.calculateShadowPassMatrixFromTile(r.tileID.toUnwrapped());W=oo(e,T,$,P,R,O)}else{const e=t.translatePosMatrix(d.expandedProjMatrix,r,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),i=h.projection.createInversionMatrix(h,d.canonical);W=m?so(e,t,H,g,v,T,$,d,r,w,R,O,S,A,i,I,P,p):ro(e,t,H,g,v,T,$,d,w,R,O,S,A,i,I,P,C,V)}t.uploadCommonUniforms(c,U,d.toUnwrapped(),null,D);let q=_.segments;if("mercator"===h.projection.name&&!N&&(q=_.getVisibleSegments(r.tileID,t.terrain,t.transform.getFrustum(0)),!q.get().length))continue;if(j)if(N)for(const e of q.get())j.numRenderedVerticesInShadowPass+=e.primitiveLength;else for(const e of q.get())j.numRenderedVerticesInTransparentPass+=e.primitiveLength;const X=[];(t.terrain||l)&&X.push(_.centroidVertexBuffer),E&&X.push(_.layoutVertexExtBuffer),L&&X.push(_.wallVertexBuffer),U.draw(t,c.gl.TRIANGLES,o,s,a,z,W,n.id,_.layoutVertexBuffer,_.indexBuffer,q,n.paint,t.transform.zoom,b,X)}t.shadowRenderer&&(t.shadowRenderer.useNormalOffset=!1)}class ts{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function is(t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x){const b=i.context,T=b.gl,w=i.transform,E=i.transform.zoom,S=[],A=t.translate,M=t.translateAnchor,I=t.edgeRadius,C=ln(i,t.cutoffFadeRange);"clear"===h?(S.push("CLEAR_SUBPASS"),x&&(S.push("CLEAR_FROM_TEXTURE"),b.activeTexture.set(T.TEXTURE0),x.bind(T.LINEAR,T.CLAMP_TO_EDGE))):"sdf"===h&&S.push("SDF_SUBPASS"),y&&S.push("HAS_CENTROID"),C.shouldRenderCutoff&&S.push("RENDER_CUTOFF");const P=(e,t,n,o,h)=>{let v=S;null!=t.groundRadiusBuffer&&(v=S.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));const T=t.programConfigurations.get(r.id),w=i.isTileAffectedByFog(e),A=i.getOrCreateProgram("fillExtrusionGroundEffect",{config:T,defines:v,overrideFog:w}),M=ao(i,o,d,u,h,[p,f*h],m,g,_,E>=17?0:I*h,x?x.size[0]:0),P=[];y&&P.push(t.hiddenByLandmarkVertexBuffer),null!=t.groundRadiusBuffer&&P.push(t.groundRadiusBuffer),i.uploadCommonUniforms(b,A,e.toUnwrapped(),null,C),A.draw(i,b.gl.TRIANGLES,s,a,l,c,M,r.id,t.vertexBuffer,t.indexBuffer,n,r.paint,E,T,P)};for(const t of o){const o=n.getTile(t),s=o.getBucket(r);if(!s||s.projection.name!==w.projection.name||!s.groundEffect||s.groundEffect&&!s.groundEffect.hasData())continue;const a=s.groundEffect,l=1/s.tileToMeter;{const e=i.translatePosMatrix(t.projMatrix,o,A,M),n=a.getDefaultSegment();P(t,a,n,e,l)}if(v)for(let s=0;s<4;s++){const a=e.e8[s](t),c=n.getTile(a);if(!c)continue;const u=c.getBucket(r);if(!u||u.projection.name!==w.projection.name||!u.groundEffect||u.groundEffect&&!u.groundEffect.hasData())continue;const h=u.groundEffect;let d,p;0===s?(d=[-e.al,0,0],p=1):1===s?(d=[e.al,0,0],p=0):2===s?(d=[0,-e.al,0],p=3):(d=[0,e.al,0],p=2);const f=h.regionSegments[p];if(!f)continue;const m=new Float32Array(16);e.bq(m,t.projMatrix,d),P(t,h,f,i.translatePosMatrix(m,o,A,M),l)}}}function ns(t,i,n,r,o,s,a){0===r.centroidVertexArray.length&&r.createCentroidsBuffer();const l=s?s.findDEMTileFor(n):null;if(!(l&&l.dem||a))return;s&&l&&l.dem&&r.selfDEMTileTimestamp!==l.dem._timestamp&&(r.borderDoneWithNeighborZ=[-1,-1,-1,-1],r.selfDEMTileTimestamp=l.dem._timestamp);const c=t=>new e.P(Math.ceil((t+e.ec)*e.ed),0),u=e=>{const t=i.getSource().minzoom,n=e=>{const t=i.getTileByID(e);if(t&&t.hasData())return t.getBucket(o)},r=[0,-1,1];for(const i of r){if(e.overscaledZ+i<t)continue;const r=n(e.calculateScaledKey(e.overscaledZ+i));if(r)return r}},h=[0,0,0],d=(t,i)=>(h[0]=Math.min(t.min.y,i.min.y),h[1]=Math.max(t.max.y,i.max.y),h[2]=e.al-i.min.x>t.max.x?i.min.x-e.al:t.max.x,h),p=(t,i)=>(h[0]=Math.min(t.min.x,i.min.x),h[1]=Math.max(t.max.x,i.max.x),h[2]=e.al-i.min.y>t.max.y?i.min.y-e.al:t.max.y,h),f=[(e,t)=>d(e,t),(e,t)=>d(t,e),(e,t)=>p(e,t),(e,t)=>p(t,e)],m=(t,i,r,o,a,c,u)=>{if(!s)return 0;const h=[[c?r:t,c?t:r,0],[c?r:i,c?i:r,0]],d=u<0?e.al+u:u,p=[c?d:(t+i)/2,c?(t+i)/2:d,0];return 0===r&&u<0||0!==r&&u>0?s.getForTilePoints(a,[p],!0,o):h.push(p),s.getForTilePoints(n,h,!0,l),Math.max(h[0][2],h[1][2],p[2])/s.exaggeration()};for(let t=0;t<4;t++){const i=r.borderFeatureIndices[t];if(0===i.length)continue;const o=e.e8[t](n),l=u(o);if(!(l&&l instanceof e.e9))continue;const h=s?s.findDEMTileFor(o):null;if(!(h&&h.dem||a))continue;if(s&&h&&h.dem&&r.borderDEMTileTimestamp[t]!==h.dem._timestamp&&(r.borderDoneWithNeighborZ[t]=-1,r.borderDEMTileTimestamp[t]=h.dem._timestamp),r.borderDoneWithNeighborZ[t]===l.canonical.z)continue;0===l.centroidVertexArray.length&&l.createCentroidsBuffer();const d=(t<2?1:5)-t,p=l.borderDoneWithNeighborZ[d]!==r.canonical.z,y=l.borderFeatureIndices[d];let v=0;if(r.canonical.z!==l.canonical.z){for(const e of i)r.showCentroid(r.featuresOnBorder[e]);if(p)for(const e of y)l.showCentroid(l.featuresOnBorder[e]);r.borderDoneWithNeighborZ[t]=l.canonical.z,l.borderDoneWithNeighborZ[d]=r.canonical.z}for(const n of i){const i=r.featuresOnBorder[n],s=r.centroidData[i.centroidDataIndex],u=i.borders[t];let p;for(;v<y.length;){p=l.featuresOnBorder[y[v]];const e=p.borders[d];if(e[1]>u[0]+3||e[0]>u[0]-3)break;l.showCentroid(p),v++}if(p&&v<y.length){const n=v;let x=0;for(;!(p.borders[d][0]>u[1]-3)&&(x++,++v!==y.length);)p=l.featuresOnBorder[y[v]];p=l.featuresOnBorder[y[n]];let b=!1;if(x>=1){const e=p.borders[d];Math.abs(u[0]-e[0])<3&&Math.abs(u[1]-e[1])<3&&(x=1,b=!0,v=n+1)}else if(0===x){r.showCentroid(i);continue}const T=l.centroidData[p.centroidDataIndex];a&&b&&(((g=s).flags|(_=T).flags)&e.eb?(g.flags|=e.eb,_.flags|=e.eb):(g.flags&=~e.eb,_.flags&=~e.eb));const w=i.intersectsCount()>1||p.intersectsCount()>1;if(x>1)v=n,s.centroidXY=T.centroidXY=new e.P(0,0);else if(h&&h.dem&&!w){const i=f[t](s,T),n=t%2?e.al-1:0,r=m(i[0],Math.min(e.al-1,i[1]),n,h,o,t<2,i[2]);s.centroidXY=T.centroidXY=c(r)}else w?s.centroidXY=T.centroidXY=new e.P(0,0):(s.centroidXY=r.encodeBorderCentroid(i),T.centroidXY=l.encodeBorderCentroid(p));r.writeCentroidToBuffer(s),l.writeCentroidToBuffer(T)}else r.showCentroid(i)}r.borderDoneWithNeighborZ[t]=l.canonical.z,l.borderDoneWithNeighborZ[d]=r.canonical.z}var g,_;(r.needsCentroidUpdate||!r.centroidVertexBuffer&&0!==r.centroidVertexArray.length)&&r.uploadCentroid(t)}const rs=[1,0,0],os=[0,1,0],ss=[0,0,1];function as(t,i,n){const r=n.transform,o=n.shadowRenderer;if(!o)return!0;const s=t.toUnwrapped(),a=r.tileSize*o._cascades[n.currentShadowCascade].scale;let l=i;if(r.elevation){const e=r.elevation.getMinMaxForTile(t);e&&(l+=e.max)}const c=[...o.shadowDirection];c[2]=-c[2];const u=o.computeSimplifiedTileShadowVolume(s,l,a,c);if(!u)return!1;const h=[rs,os,ss,c,[c[0],0,c[2]],[0,c[1],c[2]]],d="globe"===r.projection.name,p=r.scaleZoom(a),f=e.cA.fromInvProjectionMatrix(r.invProjMatrix,r.worldSize,p,!d),m=o.getCurrentCascadeFrustum();return 0===f.intersectsPrecise(u.vertices,u.planes,h)||0===m.intersectsPrecise(u.vertices,u.planes,h)}function ls(t){const{painter:i,source:n,layer:r,coords:o}=t;let s=t.defines;const a=i.context,l="shadow"===i.renderPass,c="light-beam"===i.renderPass,u=i.shadowRenderer,h=e.ee(i.transform.center.lat,i.transform.zoom),d=ln(i,r.paint.get("building-cutoff-fade-range"));d.shouldRenderCutoff&&(s=s.concat("RENDER_CUTOFF")),t.floodLightIntensity>0&&(s=s.concat("FLOOD_LIGHT"));for(const p of o){const o=n.getTile(p),f=o.getBucket(r);if(!f)continue;u&&0===u.getMaxCascadeForTile(p.toUnwrapped())&&(s=s.concat("SHADOWS_SINGLE_CASCADE"));const m=f.programConfigurations.get(r.id);let g,_,y,v=i.translatePosMatrix(p.expandedProjMatrix,o,[0,0],"map");if(v=e.cR(e.bB(),v,[1,1,t.verticalScale]),l&&u){if(as(o.tileID,f.maxHeight*h,i))continue;let n=u.calculateShadowPassMatrixFromTile(o.tileID.toUnwrapped());n=e.cR(e.bB(),n,[1,1,t.verticalScale]),y=_o(n),g=_=i.getOrCreateProgram("buildingDepth",{config:m,defines:s,overrideFog:!1})}else if(c)g=_=i.getOrCreateProgram("buildingBloom",{config:m,defines:s,overrideFog:!1}),y=go(v);else{const n=i.transform.calculatePosMatrix(p.toUnwrapped(),i.transform.worldSize);e.cR(n,n,[1,1,t.verticalScale]);const r=e.bB();e.cR(r,n,[1,-1,1/h]),e.bk(r,r),e.ef(r,r);const o=i.transform.getFreeCameraOptions().position,a=1<<p.canonical.z;if(y=mo(v,r,t.opacity,t.facadeAOIntensity,[((o.x-p.wrap)*a-p.canonical.x)*e.al,(o.y*a-p.canonical.y)*e.al,o.z*a*e.al],f.tileToMeter,t.facadeEmissiveChance,t.floodLightColor,t.floodLightIntensity),_=i.getOrCreateProgram("building",{config:m,defines:s,overrideFog:!1}),!0===t.depthOnly)g=_;else{const e=s.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);g=i.getOrCreateProgram("building",{config:m,defines:e,overrideFog:!1})}u&&(u.setupShadowsFromMatrix(n,_,!0),g!==_&&u.setupShadowsFromMatrix(n,g,!0))}const x=(e,n)=>{if(c){const o=e.entranceBloom;n.draw(i,a.gl.TRIANGLES,t.depthMode,Xi.disabled,t.blendMode,Ji.disabled,y,r.id,o.layoutVertexBuffer,o.indexBuffer,o.segmentsBucket,r.paint,i.transform.zoom,m,[o.layoutAttenuationBuffer,o.layoutColorBuffer])}else{const o=e.segmentsBucket;let s=[e.layoutNormalBuffer,e.layoutCentroidBuffer,e.layoutColorBuffer,e.layoutFloodLightDataBuffer];e.layoutFacadePaintBuffer&&(s=s.concat([e.layoutFacadeDataBuffer,e.layoutFacadeVerticalRangeBuffer,e.layoutFacadePaintBuffer])),n.draw(i,a.gl.TRIANGLES,t.depthMode,Xi.disabled,t.blendMode,l?Ji.disabled:Ji.backCW,y,r.id,e.layoutVertexBuffer,e.indexBuffer,o,r.paint,i.transform.zoom,m,s)}};i.uploadCommonUniforms(a,_,p.toUnwrapped(),null,d),f.buildingWithoutFacade&&x(f.buildingWithoutFacade,_),f.buildingWithFacade&&(g!==_&&i.uploadCommonUniforms(a,g,p.toUnwrapped(),null,d),x(f.buildingWithFacade,g))}}function cs(t,i,n,r,o,s,a,l,c,u,h,d,p){const f=t.context.gl,m=t.depthModeForSublayer(1,Wi.ReadOnly,f.LEQUAL,!0),g=.1*(1-(_=h))+3*_;var _;const y=t._showOverdrawInspector,v=d,x=new ts;y||is(x,t,i,n,r,m,new Xi({func:f.ALWAYS,mask:255},255,255,f.KEEP,f.KEEP,f.REPLACE),new $i([f.ONE,f.ONE,f.ONE,f.ONE],e.ao.transparent,[!1,!1,!1,!0],f.MIN),Ji.disabled,o,"sdf",s,a,l,c,u,g,v,!1);{const h=y?Xi.disabled:new Xi({func:f.EQUAL,mask:255},255,255,f.KEEP,f.DECR,f.DECR),d=y?t.colorModeForRenderPass():new $i([f.ONE_MINUS_DST_ALPHA,f.DST_ALPHA,f.ONE,f.ONE],e.ao.transparent,[!0,!0,!0,!0]);is(x,t,i,n,r,m,h,d,Ji.disabled,o,"color",s,a,l,c,u,g,v,!1)}}function us(t){return[t[0]*e.eg,t[1]*e.eg,t[2]*e.eg,0]}function hs(t,i,n,r,o,s,a,l,c){const u=r.getSource(),h=n.globeSharedBuffers;if(!h)return;let d,p,f;if(i&&(d=r.getTile(i)),u instanceof e.aT?(p=u.texture,f=e.dJ(0,0,n.transform)):d&&i&&(p=d.texture,f=e.dJ(i.canonical.z,i.canonical.x,n.transform)),!p||!f)return;t||(f=e.cR(e.bB(),f,[1,-1,1]));const m=n.context,g=m.gl,_="nearest"===o.paint.get("raster-resampling")?g.NEAREST:g.LINEAR,y=n.colorModeForDrapableLayerRenderPass(s),v=a.defines;v.push("GLOBE_POLES");const x=new Wi(g.LEQUAL,Wi.ReadWrite,n.depthRangeFor3D),b=Float32Array.from(n.transform.expandedFarZProjMatrix),T=Float32Array.from(e.bj(e.dI(new e.cC(0,0,0))));n.terrain&&n.terrain.prepareDrawTile(),m.activeTexture.set(g.TEXTURE0),p.bind(_,g.CLAMP_TO_EDGE),m.activeTexture.set(g.TEXTURE1),p.bind(_,g.CLAMP_TO_EDGE),"useMipmap"in p&&m.extTextureFilterAnisotropic&&n.transform.pitch>20&&g.texParameterf(g.TEXTURE_2D,m.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,m.extTextureFilterAnisotropicMax);const[w,E,S,A]=i?h.getPoleBuffers(i.canonical.z,!1):h.getPoleBuffers(0,!0),M=o.paint.get("raster-elevation");let I;t?(I=w,n.renderDefaultNorthPole=0!==M):(I=E,n.renderDefaultSouthPole=0!==M);const C=us(a.mix),P=((e,t,i,n,r,o,s,a,l,c,u,h,d)=>Eo(e,t,i,new Float32Array(16),new Float32Array(9),[0,0],n,[0,0],[0,0,0,0],1,{opacity:1,mix:0},o,[0,0]||[0,0],a,2,c,u,h,1,0,d))(b,T,f,e.aj(n.transform.zoom),0,o,0,M,0,C,a.offset,a.range,s),L=n.getOrCreateProgram("raster",{defines:v});n.uploadCommonUniforms(m,L,null),L.draw(n,g.TRIANGLES,x,c,y,l,P,o.id,I,S,A)}function ds(e){const t=e._nearZ,i=e.projection.farthestPixelDistance(e),n=i-t,r=.2*e.height,o=t+r;return[t,i,(o-r-t)/n,(o-t)/n]}function ps(e,t,i,n){if(e)return t instanceof ht&&e instanceof Pt?t.getTextureDescriptor(e,i,!0):{texture:e.texture,mix:us(n.mix),offset:n.offset,buffer:0,tileSize:1}}var fs=e.eh([{name:"a_index",type:"Int16",components:1}]);class ms{constructor(t,i,n,r){const o={width:n[0],height:n[1],data:null},s=t.gl;this.targetColorTexture=new e.T(t,o,s.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new e.T(t,o,s.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(i,r),this.lastInvalidatedAt=0}updateParticleTexture(t,i){if(this.particleTextureDimension===i.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const n=this.context.gl,r=i.width*i.height;this.particleTexture0=new e.T(this.context,i,n.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new e.T(this.context,i,n.RGBA8,{premultiply:!1,useMipmap:!1});const o=new e.ei;o.reserve(r);for(let e=0;e<r;e++)o.emplaceBack(e);this.particleIndexBuffer=this.context.createVertexBuffer(o,fs.members,!0),this.particleSegment=e.bf.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=i.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=e.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function gs(t,i,n){if(!t)return null;const r=i.getTextureDescriptor(t,n,!0);if(!r)return null;let{texture:o,mix:s,offset:a,tileSize:l,buffer:c,format:u}=r;if(!o||!u)return null;let h=!1;return"uint32"===u&&(h=!0,s[3]=0,s=To(e.ej,s,[0,n.paint.get("raster-particle-max-speed")]),a=wo(e.ej,a,[0,n.paint.get("raster-particle-max-speed")])),{texture:o,textureOffset:[c/(l+2*c),l/(l+2*c)],tileSize:l,scalarData:h,scale:s,offset:a,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[u]]}}function _s(e){const t=e._nearZ,i=e.projection.farthestPixelDistance(e),n=i-t,r=.2*e.height,o=t+r;return[t,i,(o-r-t)/n,(o-t)/n]}const ys=new e.ao(1,0,0,1),vs=new e.ao(0,1,0,1),xs=new e.ao(0,0,1,1),bs=new e.ao(1,0,1,1),Ts=new e.ao(0,1,1,1);function ws(t,i,n,r,o,s){for(let a=0;a<n.length;a++)if(o){const o=1,l=.8,c=new e.ao(r.r*l,r.g*l,r.b*l,1);Es(t,i,n[a],r,-o,-o,s),Es(t,i,n[a],r,-o,o,s),Es(t,i,n[a],r,o,o,s),Es(t,i,n[a],r,o,-o,s),Es(t,i,n[a],c,0,0,s)}else Es(t,i,n[a],r,0,0,s)}function Es(t,i,n,r,o,s,a){const l=t.context,c=t.transform,u=l.gl,h="globe"===c.projection.name,d=h?["PROJECTION_GLOBE_VIEW"]:[];let p=e.by(n.projMatrix);if(h&&e.aj(c.zoom)>0){const t=e.bi(n.canonical,c),i=e.ek(t);p=e.aB(new Float32Array(16),c.globeMatrix,i),e.aB(p,c.projMatrix,p)}const f=e.bB();f[12]+=2*o/(e.o.devicePixelRatio*c.width),f[13]+=2*s/(e.o.devicePixelRatio*c.height),e.aB(p,f,p);const m=t.getOrCreateProgram("debug",{defines:d}),g=i.getTileByID(n.key);t.terrain&&t.terrain.setupElevationDraw(g,m);const _=Wi.disabled,y=Xi.disabled,v=t.colorModeForRenderPass(),x="$debug";l.activeTexture.set(u.TEXTURE0),t.emptyTexture.bind(u.LINEAR,u.CLAMP_TO_EDGE),h?g._makeGlobeTileDebugBuffers(t.context,c):g._makeDebugTileBoundsBuffers(t.context,c.projection);const b=g._tileDebugBuffer||t.debugBuffer,T=g._tileDebugIndexBuffer||t.debugIndexBuffer,w=g._tileDebugSegments||t.debugSegments;if(m.draw(t,u.LINE_STRIP,_,y,v,Ji.disabled,vo(p,r.toPremultipliedRenderColor(null)),x,b,T,w,null,null,null,[g._globeTileDebugBorderBuffer]),a){const e=g.latestRawTileData,i=Math.floor((e&&e.byteLength||0)/1024);let r=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(r+=` => ${n.overscaledZ}`),r+=` ${g.state}`,r+=` ${i}kb`,function(e,t){e.initDebugOverlayCanvas();const i=e.debugOverlayCanvas,n=e.context.gl,r=e.debugOverlayCanvas.getContext("2d");r.clearRect(0,0,i.width,i.height),r.shadowColor="white",r.shadowBlur=2,r.lineWidth=1.5,r.strokeStyle="white",r.textBaseline="top",r.font="bold 36px Open Sans, sans-serif",r.fillText(t,5,5),r.strokeText(t,5,5),e.debugOverlayTexture.update(i),e.debugOverlayTexture.bind(n.LINEAR,n.CLAMP_TO_EDGE)}(t,r)}const E=i.getTile(n).tileSize,S=512/Math.min(E,512)*(n.overscaledZ/c.zoom)*.5,A=g._tileDebugTextBuffer||t.debugBuffer,M=g._tileDebugTextIndexBuffer||t.quadTriangleIndexBuffer,I=g._tileDebugTextSegments||t.debugSegments;m.draw(t,u.TRIANGLES,_,y,$i.alphaBlended,Ji.disabled,vo(p,e.ao.transparent.toPremultipliedRenderColor(null),S),x,A,M,I,null,null,null,[g._globeTileDebugTextBuffer])}function Ss(e,t,i,n){Ms(e,0,t+i/2,e.transform.width,i,n)}function As(e,t,i,n){Ms(e,t-i/2,0,i,e.transform.height,n)}function Ms(t,i,n,r,o,s){const a=t.context,l=a.gl;l.enable(l.SCISSOR_TEST),l.scissor(i*e.o.devicePixelRatio,n*e.o.devicePixelRatio,r*e.o.devicePixelRatio,o*e.o.devicePixelRatio),a.clear({color:s}),l.disable(l.SCISSOR_TEST)}const Is=e.eh([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Cs}=Is;function Ps(e,t,i,n){e.emplaceBack(t,i,n)}class Ls{constructor(t){this.vertexArray=new e.el,this.indices=new e.b0,Ps(this.vertexArray,-1,-1,1),Ps(this.vertexArray,1,-1,1),Ps(this.vertexArray,-1,1,1),Ps(this.vertexArray,1,1,1),Ps(this.vertexArray,-1,-1,-1),Ps(this.vertexArray,1,-1,-1),Ps(this.vertexArray,-1,1,-1),Ps(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,Cs),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=e.bf.simpleSegment(0,0,36,12)}}function Rs(t,i,n,r,o,s){const a=t.context.gl,l=i.paint.get("sky-atmosphere-color"),c=i.paint.get("sky-atmosphere-halo-color"),u=i.paint.get("sky-atmosphere-sun-intensity"),h=((e,t,i,n,r)=>({u_matrix_3f:e,u_sun_direction:t,u_sun_intensity:i,u_color_tint_r:[n.r,n.g,n.b,n.a],u_color_tint_m:[r.r,r.g,r.b,r.a],u_luminance:5e-5}))(e.en(e.dN(),r),o,u,l.toPremultipliedRenderColor(null),c.toPremultipliedRenderColor(null));a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+s,i.skyboxTexture,0),n.draw(t,a.TRIANGLES,Wi.disabled,Xi.disabled,$i.unblended,Ji.frontCW,h,"skyboxCapture",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}const Os=e.eh([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class Ds{constructor(t){const i=new e.eo;i.emplaceBack(-1,1,1,0,0),i.emplaceBack(1,1,1,1,0),i.emplaceBack(1,-1,1,1,1),i.emplaceBack(-1,-1,1,0,1);const n=new e.b0;n.emplaceBack(0,1,2),n.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(i,Os.members),this.indexBuffer=t.createIndexBuffer(n),this.segments=e.bf.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Bs=e.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Fs{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Ns{constructor(t){this.colorModeAlphaBlendedWriteRGB=new $i([1,Hi,1,Hi],e.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new $i([1,0,1,0],e.ao.transparent,[!1,!1,!1,!0]),this.params=new Fs,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(t){const i=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new Ds(i);const t=this.params.sizeRange,n=this.params.intensityRange,r=function(t){const i=e.eq(30),n=[];for(let r=0;r<t;++r){const t=2*Math.PI*i(),r=Math.acos(1-2*i())-.5*Math.PI;n.push(e.d4(Math.cos(r)*Math.cos(t),Math.cos(r)*Math.sin(t),Math.sin(r)))}return n}(this.params.starsCount),o=e.eq(300),s=new e.ep,a=new e.b0;let l=0;for(let i=0;i<r.length;++i){const c=e.c4([],r[i],200),u=Math.max(0,1+.01*t*(1*o()-.5)),h=Math.max(0,1+.01*n*(1*o()-.5));s.emplaceBack(c[0],c[1],c[2],-1,-1,u,h),s.emplaceBack(c[0],c[1],c[2],1,-1,u,h),s.emplaceBack(c[0],c[1],c[2],1,1,u,h),s.emplaceBack(c[0],c[1],c[2],-1,1,u,h),a.emplaceBack(l+0,l+1,l+2),a.emplaceBack(l+0,l+2,l+3),l+=4}this.starsVx=i.createVertexBuffer(s,Bs.members),this.starsIdx=i.createIndexBuffer(a),this.starsSegments=e.bf.simpleSegment(0,0,s.length,a.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,i){const n=t.context,r=n.gl,o=t.transform,s=new Wi(r.LEQUAL,Wi.ReadOnly,[0,1]),a=e.aj(o.zoom),l=t.style.getLut(i.scope),c="none"===i.properties.get("color-use-theme"),u=i.properties.get("color").toNonPremultipliedRenderColor(c?null:l),h="none"===i.properties.get("high-color-use-theme"),d=i.properties.get("high-color").toNonPremultipliedRenderColor(h?null:l),p="none"===i.properties.get("space-color-use-theme"),f=i.properties.get("space-color").toNonPremultipliedRenderColor(p?null:l),m=5e-4,g=e.er(i.properties.get("horizon-blend"),0,1,m,.25),_=e.dD(t,n,o)&&g===m?o.worldSize/(2*Math.PI*1.025)-1:o.globeRadius,y=t.frameCounter/1e3%1,v=e.ag(o.globeCenterInViewSpace),x=Math.sqrt(Math.pow(v,2)-Math.pow(_,2)),b=Math.acos(x/v),T=e=>{const i="globe"===o.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];e&&i.push("ALPHA_PASS");const l=t.getOrCreateProgram("globeAtmosphere",{defines:i}),c=((e,t,i,n,r,o,s,a,l,c,u,h)=>({u_frustum_tl:e,u_frustum_tr:t,u_frustum_br:i,u_frustum_bl:n,u_horizon:r,u_transition:o,u_fadeout_range:s,u_atmosphere_fog_color:a.toArray01(),u_high_color:l.toArray01(),u_space_color:c.toArray01(),u_temporal_offset:u,u_horizon_angle:h}))(o.frustumCorners.TL,o.frustumCorners.TR,o.frustumCorners.BR,o.frustumCorners.BL,o.frustumCorners.horizon,a,g,u,d,f,y,b);t.uploadCommonUniforms(n,l);const h=this.atmosphereBuffer;h&&l.draw(t,r.TRIANGLES,s,Xi.disabled,e?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Ji.backCW,c,e?"atmosphere_glow_alpha":"atmosphere_glow",h.vertexBuffer,h.indexBuffer,h.segments)};T(!1),T(!0)}drawStars(t,i){const n=e.aA(i.properties.get("star-intensity"),0,1);if(0===n)return;const r=t.context,o=r.gl,s=t.transform,a=t.getOrCreateProgram("stars"),l=e.c6([]);e.c8(l,l,-s._pitch),e.c7(l,l,-s.angle),e.c8(l,l,e.an(s._center.lat)),e.es(l,l,-e.an(s._center.lng));const c=e.cb(new Float32Array(16),l),u=e.aB([],s.starsProjMatrix,c),h=e.en([],c),d=e.et([],h),p=[0,1,0];e.dP(p,p,d),e.c4(p,p,this.params.sizeMultiplier);const f=[1,0,0];e.dP(f,f,d),e.c4(f,f,this.params.sizeMultiplier);const m=(g=p,_=f,y=n,{u_matrix:Float32Array.from(u),u_up:g,u_right:_,u_intensity_multiplier:y});var g,_,y;t.uploadCommonUniforms(r,a),this.starsVx&&this.starsIdx&&a.draw(t,o.TRIANGLES,Wi.disabled,Xi.disabled,this.colorModeAlphaBlendedWriteRGB,Ji.disabled,m,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class ks{constructor(){this.visibleTiles=[]}updateBorders(t,i){const n=[],r=[],o=t._getRenderableCoordinates(!1,!0);for(const e of o){const o=t.getTile(e);if(!o.hasData())continue;const s=o.getBucket(i);s&&(s.isEmpty()||(n.push(e.key),r.push({bucket:s,tileID:e.canonical})))}let s=n.length!==this.visibleTiles.length;if(!s){n.sort();for(let e=0;e<n.length;e++)if(n[e]!==this.visibleTiles[e]){s=!0;break}}if(!s)return;const a=new Set;this.visibleTiles=n,r.sort(((e,t)=>e.tileID.z-t.tileID.z||e.tileID.x-t.tileID.x||e.tileID.y-t.tileID.y));for(const t of r){const i=new Array,n=new Array,r=t.bucket;for(const e of r.featuresOnBorder)a.has(e.featureId)?n.push(e.footprintIndex):(a.add(e.featureId),i.push(e.footprintIndex));r.updateFootprintHiddenFlags(i,e.eu,!1),r.updateFootprintHiddenFlags(n,e.eu,!0)}}}function Us(t,i){const n=[...t],r=i.cameraWorldSizeForFog/i.worldSize,o=e.bz([]);return e.cR(o,o,[r,r,1]),e.aB(n,o,n),e.aB(n,i.worldToFogMatrix,n),n}function zs(t,i,n,r,o){const s=n.material,a=r.context,{baseColorTexture:l,metallicRoughnessTexture:c}=s.pbrMetallicRoughness,{normalTexture:u,occlusionTexture:h,emissionTexture:d}=s;function p(e,i,n){if(e&&(t.push(i),a.activeTexture.set(a.gl.TEXTURE0+n),e.gfxTexture)){const{minFilter:t,magFilter:i,wrapS:n,wrapT:r}=e.sampler;e.gfxTexture.bindExtraParam(t,i,n,r)}}p(l,"HAS_TEXTURE_u_baseColorTexture",rn.BaseColor),p(c,"HAS_TEXTURE_u_metallicRoughnessTexture",rn.MetallicRoughness),p(u,"HAS_TEXTURE_u_normalTexture",rn.Normal),p(h,"HAS_TEXTURE_u_occlusionTexture",rn.Occlusion),p(d,"HAS_TEXTURE_u_emissionTexture",rn.Emission),o&&(o.texture||(o.texture=new e.d_(r.context,o.image,[o.image.height,o.image.height,o.image.height],a.gl.RGBA8)),a.activeTexture.set(a.gl.TEXTURE0+rn.LUT),o.texture&&o.texture.bind(a.gl.LINEAR,a.gl.CLAMP_TO_EDGE),t.push("APPLY_LUT_ON_GPU")),n.texcoordBuffer&&(t.push("HAS_ATTRIBUTE_a_uv_2f"),i.push(n.texcoordBuffer)),n.colorBuffer&&(t.push(12===n.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),i.push(n.colorBuffer)),n.normalBuffer&&(t.push("HAS_ATTRIBUTE_a_normal_3f"),i.push(n.normalBuffer)),n.pbrBuffer&&(t.push("HAS_ATTRIBUTE_a_pbr"),t.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),i.push(n.pbrBuffer)),"OPAQUE"!==s.alphaMode&&"MASK"!==s.alphaMode||t.push("UNPREMULT_TEXTURE_IN_SHADER"),s.defined||t.push("DIFFUSE_SHADED");const f=r.shadowRenderer;f&&(t.push("RENDER_SHADOWS","DEPTH_TEXTURE"),f.useNormalOffset&&t.push("NORMAL_OFFSET"))}function Vs(t,i,n,r,o,s){const a=n.paint.get("model-opacity").constantOr(1),l=i.context,c=new Wi(i.context.gl.LEQUAL,t.isLightMesh?Wi.ReadOnly:Wi.ReadWrite,i.depthRangeFor3D),u=i.transform,h=t.mesh,d=h.material,p=d.pbrMetallicRoughness,f=i.style.fog;let m;m="pixels"===i.transform.projection.zAxisUnit?[...t.nodeModelMatrix]:e.aB([],r.zScaleMatrix,t.nodeModelMatrix),e.aB(m,r.negCameraPosMatrix,m);const g=e.bk([],m);e.ef(g,g);const _="none"===n.paint.get("model-color-use-theme").constantOr("default"),y=n.paint.get("model-emissive-strength").constantOr(0),v=Bo(new Float32Array(t.worldViewProjection),new Float32Array(m),new Float32Array(g),null,i,a,p.baseColorFactor,d.emissiveFactor,p.metallicFactor,p.roughnessFactor,d,y,n,void 0,void 0,t.materialOverride,t.modelColor),x={defines:[]},b=[],T=i.shadowRenderer;T&&(T.useNormalOffset=!1),zs(x.defines,b,h,i,_?null:n.lut);let w=null;if(f){const e=Us(t.nodeModelMatrix,i.transform);if(w=new Float32Array(e),"globe"!==u.projection.name){const t=h.aabb.min,i=h.aabb.max,[n,r]=f.getOpacityForBounds(e,t[0],t[1],i[0],i[1]);x.overrideFog=n>=Ve||r>=Ve}}const E=ln(i,n.paint.get("model-cutoff-fade-range"));E.shouldRenderCutoff&&x.defines.push("RENDER_CUTOFF");const S=i.getOrCreateProgram("model",x);i.uploadCommonUniforms(l,S,null,w,E),"shadow"!==i.renderPass&&T&&T.setupShadowsFromMatrix(t.nodeModelMatrix,S),S.draw(i,l.gl.TRIANGLES,c,o,s,h.material.doubleSided?Ji.disabled:Ji.backCCW,v,n.id,h.vertexBuffer,h.indexBuffer,h.segments,n.paint,i.transform.zoom,void 0,b)}function Gs(e,t,i){return"vector"===e.type?t.scope:i?"basemap":""}function js(t,i,n,r,o,s,a,l,c){const u=t.transform,h=!!i.isGeometryBloom&&i.isGeometryBloom;if(h&&"shadow"===t.renderPass)return;const d="globe"===u.projection.name?e.eC(n,u):[...n];e.aB(d,d,i.globalMatrix);const p=e.aB([],r,d);if(i.meshes)for(const t of i.meshes){const i=l.get(t.material.name);if(i&&i.opacity<=0)continue;if("BLEND"!==t.material.alphaMode){a.push({mesh:t,depth:0,modelIndex:o,worldViewProjection:p,nodeModelMatrix:d,isLightMesh:h,materialOverride:i,modelColor:c});continue}const n=e.af([],t.centroid,p);!u.isOrthographic&&n[2]<=0||s.push({mesh:t,depth:n[2],modelIndex:o,worldViewProjection:p,nodeModelMatrix:d,isLightMesh:h,materialOverride:i,modelColor:c})}if(i.children)for(const e of i.children)js(t,e,n,r,o,s,a,l,c)}function Hs(e,t,i,n){const r=i.shadowRenderer;if(!r)return;const o=r.getShadowPassDepthMode(),s=r.getShadowPassColorMode(),a=r.calculateShadowPassMatrixFromMatrix(t),l=Fo(a);i.getOrCreateProgram("modelDepth",{defines:i._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(i,i.context.gl.TRIANGLES,o,Xi.disabled,s,Ji.disabled,l,n.id,e.vertexBuffer,e.indexBuffer,e.segments,n.paint,i.transform.zoom,void 0,void 0)}function $s(e,t,i,n,r,o){for(const s of r){const r=Object.assign({},n);r.part=s;const a={type:"Unknown",id:t,properties:r},l={orientation:e.paint.get("model-rotation").evaluate(a,i)};o.set(s,l)}}function Ws(e,t,i,n,r,o){for(const s of r){const r=Object.assign({},n);r.part=s;const a={type:"Unknown",id:t,properties:r},l={color:e.paint.get("model-color").evaluate(a,i),colorMix:e.paint.get("model-color-mix-intensity").evaluate(a,i),opacity:e.paint.get("model-opacity").evaluate(a,i),emissionStrength:e.paint.get("model-emissive-strength").evaluate(a,i)};o.set(s,l)}}function qs(e,t,i,n,r,o){if(1===i)for(const i of r)Vs(i,e,t,o[i.modelIndex],Xi.disabled,e.colorModeForRenderPass());else{for(const i of r)Vs(i,e,t,o[i.modelIndex],Xi.disabled,$i.disabled);for(const i of r)Vs(i,e,t,o[i.modelIndex],e.stencilModeFor3D(),e.colorModeForRenderPass());e.resetStencilClippingMasks()}const s=$i.additive;for(const i of n)Vs(i,e,t,o[i.modelIndex],Xi.disabled,i.isLightMesh?s:e.colorModeForRenderPass())}function Xs(t,i,n){const r=i.updateZoomBasedPaintProperties(),o=function(t,i,n){let r,o,s,a=t.terrain?t.terrain.exaggeration():0;if(t.terrain&&a>0){const i=t.terrain,o=i.findDEMTileFor(n);o&&o.dem?r=e.eE.create(i,n,o):a=0}if(0===a&&(i.terrainElevationMin=0,i.terrainElevationMax=0),a===i.validForExaggeration&&(0===a||r&&r._demTile&&r._demTile.tileID===i.validForDEMTile.id&&r._dem._timestamp===i.validForDEMTile.timestamp))return!1;for(const e in i.instancesPerModel){const t=i.instancesPerModel[e];for(let e=0;e<t.instancedDataArray.length;++e){const n=(r?a*r.getElevationAt(0|t.instancedDataArray.float32[16*e],0|t.instancedDataArray.float32[16*e+1],!0,!0):0)+t.instancesEvaluatedElevation[e];t.instancedDataArray.float32[16*e+6]=n,o=o?Math.min(i.terrainElevationMin,n):n,s=s?Math.max(i.terrainElevationMax,n):n}}return i.terrainElevationMin=o||0,i.terrainElevationMax=s||0,i.validForExaggeration=a,i.validForDEMTile=r&&r._demTile?{id:r._demTile.tileID,timestamp:r._dem._timestamp}:{id:void 0,timestamp:0},!0}(t,i,n);(r||o)&&(i.uploaded=!1,i.upload(t.context))}const Ys={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new e.d8([0,0,0],[e.al,e.al,0])};function Zs(t,i){const n=1<<t.canonical.z,r=i.getFreeCameraOptions().position,o=i.elevation,s=t.canonical.x/n,a=(t.canonical.x+1)/n,l=t.canonical.y/n,c=(t.canonical.y+1)/n;let u=i._centerAltitude;if(o){const e=o.getMinMaxForTile(t);e&&e.max>u&&(u=e.max)}const h=e.aA(r.x,s,a)-r.x,d=e.aA(r.y,l,c)-r.y,p=e.ce(u,i.center.lat)-r.z;return i._zoomFromMercatorZ(Math.sqrt(h*h+d*d+p*p))}function Js(e,t,i,n,r,o,s){const a=e.context,l="shadow"===e.renderPass,c=e.shadowRenderer,u=l&&c?c.getShadowPassDepthMode():new Wi(a.gl.LEQUAL,Wi.ReadWrite,e.depthRangeFor3D),h=e.isTileAffectedByFog(o),d="globe"===e.transform.projection.name;if(i.meshes)for(const p of i.meshes){const f=d?[]:["MODEL_POSITION_ON_GPU"],m=[];let g,_,y;const v=!d&&n.instancedDataArray.length>20;v&&f.push("INSTANCED_ARRAYS");const x=ln(e,t.paint.get("model-cutoff-fade-range"));if(x.shouldRenderCutoff&&f.push("RENDER_CUTOFF"),l&&c)g=e.getOrCreateProgram("modelDepth",{defines:f}),_=Fo(s.shadowTileMatrix,s.shadowTileMatrix,Float32Array.from(i.globalMatrix)),y=c.getShadowPassColorMode();else{zs(f,m,p,e,"none"===t.paint.get("model-color-use-theme").constantOr("default")?null:t.lut),g=e.getOrCreateProgram("model",{defines:f,overrideFog:h});const n=p.material,l=n.pbrMetallicRoughness,u=t.paint.get("model-opacity").constantOr(1),d=t.paint.get("model-emissive-strength").constantOr(0);_=Bo(o.expandedProjMatrix,Float32Array.from(i.globalMatrix),new Float32Array(16),null,e,u,l.baseColorFactor,n.emissiveFactor,l.metallicFactor,l.roughnessFactor,n,d,t,r),c&&(s.shadowUniformsInitialized?g.setShadowUniformValues(a,c.getShadowUniformValues()):(c.setupShadows(o.toUnwrapped(),g,"model-tile"),s.shadowUniformsInitialized=!0)),y=x.shouldRenderCutoff||u<1||"OPAQUE"!==n.alphaMode?$i.alphaBlended:$i.unblended}e.uploadCommonUniforms(a,g,o.toUnwrapped(),null,x);const b=p.material.doubleSided?Ji.disabled:Ji.backCCW;if(v)m.push(n.instancedDataBuffer),g.draw(e,a.gl.TRIANGLES,u,Xi.disabled,y,b,_,t.id,p.vertexBuffer,p.indexBuffer,p.segments,t.paint,e.transform.zoom,void 0,m,n.instancedDataArray.length);else{const i=l?"u_instance":"u_normal_matrix";for(let r=0;r<n.instancedDataArray.length;++r)_[i]=new Float32Array(n.instancedDataArray.arrayBuffer,64*r,16),g.draw(e,a.gl.TRIANGLES,u,Xi.disabled,y,b,_,t.id,p.vertexBuffer,p.indexBuffer,p.segments,t.paint,e.transform.zoom,void 0,m)}}if(i.children)for(const a of i.children)Js(e,t,a,n,r,o,s)}const Ks=[1,-1,1];function Qs(t,i,n,r){if(!n.modelManager)return!0;const o=n.modelManager;if(!n.shadowRenderer)return!0;const s=n.shadowRenderer,a=i.aabb;let l=!0,c=t.maxHeight;if(0===c){let e=0;for(const i in t.instancesPerModel){const t=o.getModel(i,r);t?e=Math.max(e,Math.max(Math.max(t.aabb.max[0],t.aabb.max[1]),t.aabb.max[2])):l=!1}c=t.maxScale*e*1.41+t.maxVerticalOffset,l&&(t.maxHeight=c)}a.max[2]=c,a.min[2]+=t.terrainElevationMin,a.max[2]+=t.terrainElevationMax,e.af(a.min,a.min,i.tileMatrix),e.af(a.max,a.max,i.tileMatrix);const u=a.intersects(s.getCurrentCascadeFrustum());return 0===n.currentShadowCascade&&(t.isInsideFirstShadowMapFrustum=2===u),0===u}function ea(t,i){const n=t.uniformValues.u_cutoff_params[0],r=t.uniformValues.u_cutoff_params[1],o=t.uniformValues.u_cutoff_params[2],s=t.uniformValues.u_cutoff_params[3];return r===n||s===o?1:e.aA(((i-n)/(r-n)-o)/(s-o),0,1)}function ta(t,i,n,r){if(i.pitch<20)return 1;const o=i.getWorldToCameraMatrix();e.aB(o,o,t);const s=e.bT(n.min[0],n.min[1],n.min[2],1);let a=e.aC(e.eF(),s,o),l=a,c=a;s[1]=n.max[1],a=e.aC(e.eF(),s,o),l=a[1]<l[1]?a:l,c=a[1]>c[1]?a:c,s[0]=n.max[0],a=e.aC(e.eF(),s,o),l=a[1]<l[1]?a:l,c=a[1]>c[1]?a:c,s[1]=n.min[1],a=e.aC(e.eF(),s,o),l=a[1]<l[1]?a:l,c=a[1]>c[1]?a:c;const u=e.aA(r[0],0,1),h=100*i.pixelsPerMeter*e.aA(r[1],0,1),d=e.aA(r[2],0,1),p=e.eG(e.eF(),l,c,u),f=Math.tan(.5*i.fovX),m=-p[2]*f;if(0===h)return p[1]<-Math.abs(m)?d:1;const g=(-Math.abs(m)-p[1])/h,_=(e,t,i)=>(1-i)*e+i*t,y=e.aA(_(1,d,g),d,1);return _(1,y,e.aA((i.pitch-20)/20,0,1))}class ia{}class na{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,i,n){{const e=this._storage.get(i.id);if(e)return e.lastUsedFrameIdx=t,e.buf}const r=n.gl,o=r.getBufferParameter(r.ELEMENT_ARRAY_BUFFER,r.BUFFER_SIZE),s=new ArrayBuffer(o),a=new Int16Array(s);r.getBufferSubData(r.ELEMENT_ARRAY_BUFFER,0,new Int16Array(s));const l=new e.eI;for(let e=0;e<o/2;e+=3){const t=a[e],i=a[e+1],n=a[e+2];l.emplaceBack(t,i),l.emplaceBack(i,n),l.emplaceBack(n,t)}const c=n.bindVertexArrayOES.current,u=new ia;return u.buf=new ko(n,l),u.lastUsedFrameIdx=t,this._storage.set(i.id,u),n.bindVertexArrayOES.set(c),u.buf}update(e){for(const[t,i]of this._storage)e-i.lastUsedFrameIdx>30&&(i.buf.destroy(),this._storage.delete(t))}destroy(){for(const[e,t]of this._storage)t.buf.destroy(),this._storage.delete(e)}}class ra{constructor(e){this.occluderSize=30,this.depthOffset=-1e-4,e.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),e.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const oa=e.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class sa{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class aa{constructor(e,t){this.revealStart=11,this.revealRange=2,e.registerParameter(this,[...t,"Reveal"],"revealStart",{min:0,max:17,step:.05}),e.registerParameter(this,[...t,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const la=e.eh([{type:"Float32",name:"a_pos_2f",components:2}]);class ca{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,i){const n=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const i=new e.eJ,n=new e.b0;i.emplaceBack(-1,-1),i.emplaceBack(1,-1),i.emplaceBack(1,1),i.emplaceBack(-1,1),n.emplaceBack(0,1,2),n.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(i,la.members),this.vignetteIdx=t.context.createIndexBuffer(n)}const r=e.bf.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,n);const e={u_vignetteShape:(o={vignetteShape:[i.start,i.range,Math.pow(10,i.fadePower)],vignetteColor:[i.color.r,i.color.g,i.color.b,i.color.a*i.strength]}).vignetteShape,u_vignetteColor:o.vignetteColor};n.draw(t,t.context.gl.TRIANGLES,Wi.disabled,Xi.disabled,$i.alphaBlended,Ji.disabled,e,"vignette",this.vignetteVx,this.vignetteIdx,r)}var o}}class ua{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,i){const n=t.getFreeCameraOptions().position,r=n.toAltitude(),o=n.toLngLat(),s=e.an(o.lng),a=e.an(o.lat),l=t.pixelsPerMeter/i,c=s*e.eL,u=e.eL*Math.log(Math.tan(Math.PI/4+a/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const e=-this._offsetYPrev+u,t=-this._elevationPrev+r;this._accumulatedOffsetX+=(-this._offsetXPrev+c)*l,this._accumulatedOffsetY+=e*l,this._accumulatedElevation+=t*l,this._offsetXPrev=c,this._offsetYPrev=u,this._elevationPrev=r}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function ha(e,t){return[-(e[0]-Math.floor(e[0]/t)*t),-(e[1]-Math.floor(e[1]/t)*t),-(e[2]-Math.floor(e[2]/t)*t)]}function da(t){const i=e.eq(1323123451230),n=[];for(let r=0;r<t;++r){const t=2*i()-1,r=2*i()-1,o=2*i()-1;n.push(e.d4(t,r,o))}return n}function pa(t,i,n,r,o){const s=e.aA((o-n)/(r-n),0,1);return(1-s)*t+s*i}class fa{constructor(e){this._movement=new ua,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new ca,this._ppmScaleFactor=e}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,i){const n=t.transform;this._movement.update(n,this._ppmScaleFactor);const r=n.starsProjMatrix,o=e.c6([]);e.c8(o,o,e.an(90)-n._pitch),e.c7(o,o,-n.angle);const s=e.cb(new Float32Array(16),o),a=e.eK(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),l=e.ef([],a),c=e.aB([],l,s),u=Date.now()/1e3;return this._accumulatedTimeFromStart+=(u-this._prevTime)*i,this._prevTime=u,{projectionMatrix:r,modelviewMatrix:c}}}class ma extends fa{constructor(e){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new aa(e.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const i=t.context;if(!this.particlesVx){const t=da(this.particlesCount),n=new e.eM,r=new e.b0;let o=0;const s=e.eq(1323123451230);for(let e=0;e<t.length;++e){const i=t[e],a=[2*s()-1,s(),s(),s()];n.emplaceBack(i[0],i[1],i[2],-1,-1,...a),n.emplaceBack(i[0],i[1],i[2],1,-1,...a),n.emplaceBack(i[0],i[1],i[2],1,1,...a),n.emplaceBack(i[0],i[1],i[2],-1,1,...a),r.emplaceBack(o+0,o+1,o+2),r.emplaceBack(o+0,o+2,o+3),o+=4}this.particlesVx=i.createVertexBuffer(n,oa.members),this.particlesIdx=i.createIndexBuffer(r)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const i=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},n=t.transform.zoom;if(i.revealStart>n)return;const r=pa(0,1,i.revealStart,i.revealStart+i.revealRange,n);if(!this.particlesVx||!this.particlesIdx)return;const o=structuredClone(this._params);let s=[-o.direction.x,o.direction.y,-100];e.aw(s,s);const a=structuredClone(this._vignetteParams);a.strength*=r,o.overrideStyleParameters||(o.intensity=t.style.rain.state.density,o.timeFactor=t.style.rain.state.intensity,o.color=structuredClone(t.style.rain.state.color),s=structuredClone(t.style.rain.state.direction),o.screenThinning.intensity=t.style.rain.state.centerThinning,o.dropletSizeX=t.style.rain.state.dropletSize[0],o.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],o.distortionStrength=100*t.style.rain.state.distortionStrength,a.strength=1,a.color=structuredClone(t.style.rain.state.vignetteColor));const l=this.updateOnRender(t,o.timeFactor),c=t.context,u=c.gl,h=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new e.T(c,{width:t.width,height:t.height,data:null},u.RGBA8)),o.distortionStrength>0&&(c.activeTexture.set(u.TEXTURE0),this.screenTexture.bind(u.LINEAR,u.CLAMP_TO_EDGE),u.copyTexSubImage2D(u.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const d=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(c,d),c.activeTexture.set(u.TEXTURE0),this.screenTexture.bind(u.LINEAR,u.CLAMP_TO_EDGE);const p=[o.color.r,o.color.g,o.color.b,o.color.a],f=(i,n)=>{const r=ha(this._movement.getPosition(),i),a=o.dropletSizeX,c=o.dropletSizeX*o.dropletSizeYScale,f=t.width/2,m=t.height/2,g=pa(0,o.screenThinning.start,0,1,o.screenThinning.intensity),_=pa(.001,o.screenThinning.range,0,1,o.screenThinning.intensity),y=pa(0,o.screenThinning.particleOffset,0,1,o.screenThinning.intensity),v=(x={modelview:l.modelviewMatrix,projection:l.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:r,velocityConeAperture:o.velocityConeAperture,velocity:o.velocity,boxSize:i,rainDropletSize:[a,c],distortionStrength:o.distortionStrength,rainDirection:s,color:p,screenSize:[h.width,h.height],thinningCenterPos:[f,m],thinningShape:[g,_,Math.pow(10,o.screenThinning.fadePower)],thinningAffectedRatio:o.screenThinning.affectedRatio,thinningParticleOffset:y,shapeDirectionalPower:o.shapeDirPower,shapeNormalPower:o.shapeNormalPower,mode:n?0:1},{u_modelview:Float32Array.from(x.modelview),u_projection:Float32Array.from(x.projection),u_time:x.time,u_cam_pos:x.camPos,u_texScreen:0,u_velocityConeAperture:x.velocityConeAperture,u_velocity:x.velocity,u_boxSize:x.boxSize,u_rainDropletSize:x.rainDropletSize,u_distortionStrength:x.distortionStrength,u_rainDirection:x.rainDirection,u_color:x.color,u_screenSize:x.screenSize,u_thinningCenterPos:x.thinningCenterPos,u_thinningShape:x.thinningShape,u_thinningAffectedRatio:x.thinningAffectedRatio,u_thinningParticleOffset:x.thinningParticleOffset,u_shapeDirectionalPower:x.shapeDirectionalPower,u_shapeNormalPower:x.shapeNormalPower,u_mode:x.mode});var x;const b=Math.round(o.intensity*this.particlesCount),T=e.bf.simpleSegment(0,0,4*b,2*b);d.draw(t,u.TRIANGLES,Wi.disabled,Xi.disabled,$i.alphaBlended,Ji.disabled,v,"rain_particles",this.particlesVx,this.particlesIdx,T)};o.distortionStrength>0&&f(o.boxSize,!0),f(o.boxSize,!1),this._vignette.draw(t,a)}}const ga=e.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class _a extends fa{constructor(e){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new aa(e.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const i=t.context;if(!this.particlesVx){const t=da(this.particlesCount),n=new e.eN,r=new e.b0;let o=0;const s=e.eq(1323123451230);for(let e=0;e<t.length;++e){const i=t[e],a=s(),l=s(),c=s(),u=[e/t.length,a,l,c],h=[s(),s()];n.emplaceBack(i[0],i[1],i[2],-1,-1,...u,...h),n.emplaceBack(i[0],i[1],i[2],1,-1,...u,...h),n.emplaceBack(i[0],i[1],i[2],1,1,...u,...h),n.emplaceBack(i[0],i[1],i[2],-1,1,...u,...h),r.emplaceBack(o+0,o+1,o+2),r.emplaceBack(o+0,o+2,o+3),o+=4}this.particlesVx=i.createVertexBuffer(n,ga.members),this.particlesIdx=i.createIndexBuffer(r)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const i=structuredClone(this._params);let n=[-i.direction.x,i.direction.y,-100];e.aw(n,n);const r=structuredClone(this._vignetteParams),o=i.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},s=t.transform.zoom;if(o.revealStart>s)return;const a=pa(0,1,o.revealStart,o.revealStart+o.revealRange,s);r.strength*=a,i.overrideStyleParameters||(i.intensity=t.style.snow.state.density,i.timeFactor=t.style.snow.state.intensity,i.color=structuredClone(t.style.snow.state.color),n=structuredClone(t.style.snow.state.direction),i.screenThinning.intensity=t.style.snow.state.centerThinning,i.billboardSize=2.79*t.style.snow.state.flakeSize,r.strength=1,r.color=structuredClone(t.style.snow.state.vignetteColor));const l=this.updateOnRender(t,i.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const c=t.context,u=c.gl,h=t.transform,d=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(c,d),((i,r,o)=>{const s=ha(this._movement.getPosition(),i),a=h.width/2,c=h.height/2,p=pa(0,o.screenThinning.start,0,1,o.screenThinning.intensity),f=pa(.001,o.screenThinning.range,0,1,o.screenThinning.intensity),m=pa(0,o.screenThinning.particleOffset,0,1,o.screenThinning.intensity),g=(_={modelview:l.modelviewMatrix,projection:l.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:s,velocityConeAperture:o.velocityConeAperture,velocity:o.velocity,horizontalOscillationRadius:o.horizontalOscillationRadius,horizontalOscillationRate:o.horizontalOscillationRate,boxSize:i,billboardSize:1*o.billboardSize,simpleShapeParameters:[o.shapeFadeStart,o.shapeFadePower],screenSize:[h.width,h.height],thinningCenterPos:[a,c],thinningShape:[p,f,Math.pow(10,o.screenThinning.fadePower)],thinningAffectedRatio:o.screenThinning.affectedRatio,thinningParticleOffset:m,color:[o.color.r,o.color.g,o.color.b,o.color.a],direction:n},{u_modelview:Float32Array.from(_.modelview),u_projection:Float32Array.from(_.projection),u_time:_.time,u_cam_pos:_.camPos,u_velocityConeAperture:_.velocityConeAperture,u_velocity:_.velocity,u_horizontalOscillationRadius:_.horizontalOscillationRadius,u_horizontalOscillationRate:_.horizontalOscillationRate,u_boxSize:_.boxSize,u_billboardSize:_.billboardSize,u_simpleShapeParameters:_.simpleShapeParameters,u_screenSize:_.screenSize,u_thinningCenterPos:_.thinningCenterPos,u_thinningShape:_.thinningShape,u_thinningAffectedRatio:_.thinningAffectedRatio,u_thinningParticleOffset:_.thinningParticleOffset,u_particleColor:_.color,u_direction:_.direction});var _;const y=Math.round(o.intensity*this.particlesCount),v=e.bf.simpleSegment(0,0,4*y,2*y);this.particlesVx&&this.particlesIdx&&d.draw(t,u.TRIANGLES,Wi.disabled,Xi.disabled,$i.alphaBlended,Ji.disabled,g,"snow_particles",this.particlesVx,this.particlesIdx,v)})(i.boxSize,0,i),this._vignette.draw(t,r)}}const ya={symbol:function(t,i,n,r,o){if("translucent"!==t.renderPass)return;const s=Xi.disabled,a=t.colorModeForRenderPass(),l=n.layout.get("text-variable-anchor"),c=n.layout.get("text-size-scale-range"),u=e.aA(t.scaleFactor,c[0],c[1]);l&&function(t,i,n,r,o,s,a,l){const c=i.transform,u="map"===o,h="map"===s;for(const i of t){const t=r.getTile(i),o=t.getBucket(n);if(!o||!o.text||!o.text.segments.get().length)continue;const s=e.bJ(o.textSizeData,c.zoom,l),d=Zt(i,o.getProjection(),c),p=c.calculatePixelsToTileUnitsMatrix(t),f=ti(d,t.tileID.canonical,h,u,c,o.getProjection(),p),m=o.hasIconTextFit()&&o.hasIconData();s&&Xo(o,u,h,a,c,f,i,Math.pow(2,c.zoom-t.tileID.overscaledZ),s,m)}}(r,t,n,i,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),o,u);const h=0!==n.paint.get("icon-opacity").constantOr(1),d=0!==n.paint.get("text-opacity").constantOr(1);void 0!==n.layout.get("symbol-sort-key").constantOr(1)&&(h||d)?Yo(t,i,n,r,s,a):(h&&Yo(t,i,n,r,s,a,{onlyIcons:!0}),d&&Yo(t,i,n,r,s,a,{onlyText:!0})),i.map.showCollisionBoxes&&(Ho(t,i,n,r,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),Ho(t,i,n,r,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(t,i,n,r){if("translucent"!==t.renderPass)return;const o=n.paint.get("circle-opacity"),s=n.paint.get("circle-stroke-width"),a=n.paint.get("circle-stroke-opacity"),l=void 0!==n.layout.get("circle-sort-key").constantOr(1),c=n.paint.get("circle-emissive-strength");if(0===o.constantOr(1)&&(0===s.constantOr(1)||0===a.constantOr(1)))return;const u=t.context,h=u.gl,d=t.transform,p=!(!t.terrain||!t.terrain.enabled),f=n.layout.get("circle-elevation-reference"),m=t.depthModeForSublayer(0,Wi.ReadOnly),g=new Wi(t.context.gl.LEQUAL,Wi.ReadOnly,t.depthRangeFor3D),_="none"===f||p?m:g,y=Xi.disabled,v=t.colorModeForDrapableLayerRenderPass(c),x="globe"===d.projection.name,b=[e.aF(d.center.lng),e.aJ(d.center.lat)],T=[];for(let o=0;o<r.length;o++){const s=r[o],a=i.getTile(s),c=a.getBucket(n);if(!c||c.projection.name!==d.projection.name)continue;const u=c.programConfigurations.get(n.id),h=c.layoutVertexBuffer,p=c.globeExtVertexBuffer,f=c.indexBuffer,m=e.d$(n),g=[p],_=t.isTileAffectedByFog(s);x&&m.push("PROJECTION_GLOBE_VIEW"),m.push("DEPTH_D24"),t.terrain&&d.depthOcclusionForSymbolsAndCircles&&m.push("DEPTH_OCCLUSION"),c.hasElevation&&!t.terrain&&(m.push("ELEVATED_ROADS"),g.push(c.elevatedLayoutVertexBuffer));const y=t.getOrCreateProgram("circle",{config:u,defines:m,overrideFog:_}),v=d.projection.createInversionMatrix(d,s.canonical),w={programConfiguration:u,program:y,layoutVertexBuffer:h,dynamicBuffers:g,indexBuffer:f,uniformValues:e.e0(t,s,a,v,b,n),tile:a};if(l){const t=c.segments.get();for(const i of t)T.push({segments:new e.bf([i]),sortKey:i.sortKey,state:w})}else T.push({segments:c.segments,sortKey:0,state:w})}l&&T.sort(((e,t)=>e.sortKey-t.sortKey));const w={useDepthForOcclusion:d.depthOcclusionForSymbolsAndCircles};for(const e of T){const{programConfiguration:i,program:r,layoutVertexBuffer:o,dynamicBuffers:s,indexBuffer:a,uniformValues:l,tile:c}=e.state,p=e.segments;t.terrain&&t.terrain.setupElevationDraw(c,r,w),t.uploadCommonUniforms(u,r,c.tileID.toUnwrapped()),r.draw(t,h.TRIANGLES,_,y,v,Ji.disabled,l,n.id,o,a,p,n.paint,d.zoom,i,s)}},heatmap:function(t,i,n,r){if(0!==n.paint.get("heatmap-opacity"))if("offscreen"===t.renderPass){const o=t.context,s=o.gl,a=Xi.disabled,l=new $i([s.ONE,s.ONE,s.ONE,s.ONE],e.ao.transparent,[!0,!0,!0,!0]);!function(e,t,i,n){const r=e.gl,o=t.width*n,s=t.height*n;e.activeTexture.set(r.TEXTURE1),e.viewport.set([0,0,o,s]);let a=i.heatmapFbo;if(!a||a&&(a.width!==o||a.height!==s)){a&&a.destroy();const t=r.createTexture();r.bindTexture(r.TEXTURE_2D,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),a=i.heatmapFbo=e.createFramebuffer(o,s,!0,null),function(e,t,i,n,r,o){const s=e.gl;s.texImage2D(s.TEXTURE_2D,0,e.extRenderToTextureHalfFloat?s.RGBA16F:s.RGBA,r,o,0,s.RGBA,e.extRenderToTextureHalfFloat?s.HALF_FLOAT:s.UNSIGNED_BYTE,null),n.colorAttachment.set(i)}(e,0,t,a,o,s)}else r.bindTexture(r.TEXTURE_2D,a.colorAttachment.get()),e.bindFramebuffer.set(a.framebuffer)}(o,t,n,"globe"===t.transform.projection.name?.5:.25),o.clear({color:e.ao.transparent});const c=t.transform,u="globe"===c.projection.name,h=u?["PROJECTION_GLOBE_VIEW"]:[],d=u?Ji.frontCCW:Ji.disabled,p=[e.aF(c.center.lng),e.aJ(c.center.lat)];for(let e=0;e<r.length;e++){const f=r[e];if(i.hasRenderableParent(f))continue;const m=i.getTile(f),g=m.getBucket(n);if(!g||g.projection.name!==c.projection.name)continue;const _=t.isTileAffectedByFog(f),y=g.programConfigurations.get(n.id),v=t.getOrCreateProgram("heatmap",{config:y,defines:h,overrideFog:_}),{zoom:x}=t.transform;t.terrain&&t.terrain.setupElevationDraw(m,v),t.uploadCommonUniforms(o,v,f.toUnwrapped());const b=c.projection.createInversionMatrix(c,f.canonical);v.draw(t,s.TRIANGLES,Wi.disabled,a,l,d,bo(t,f,m,b,p,x,n.paint.get("heatmap-intensity")),n.id,g.layoutVertexBuffer,g.indexBuffer,g.segments,n.paint,t.transform.zoom,y,u?[g.globeExtVertexBuffer]:null)}o.viewport.set([0,0,t.width,t.height])}else"translucent"===t.renderPass&&(t.context.setColorMode(t.colorModeForRenderPass()),function(t,i){const n=t.context,r=n.gl,o=i.heatmapFbo;if(!o)return;n.activeTexture.set(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,o.colorAttachment.get()),n.activeTexture.set(r.TEXTURE1);let s=i.colorRampTexture;s||(s=i.colorRampTexture=new e.T(n,i.colorRamp,r.RGBA8)),s.bind(r.LINEAR,r.CLAMP_TO_EDGE),t.getOrCreateProgram("heatmapTexture").draw(t,r.TRIANGLES,Wi.disabled,Xi.disabled,t.colorModeForRenderPass(),Ji.disabled,((e,t)=>({u_image:0,u_color_ramp:1,u_opacity:t.paint.get("heatmap-opacity")}))(0,i),i.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments,i.paint,t.transform.zoom)}(t,n))},line:function(t,i,n,r){if("translucent"!==t.renderPass)return;const o=n.paint.get("line-opacity"),s=n.paint.get("line-width");if(0===o.constantOr(1)||0===s.constantOr(1))return;const a=n.paint.get("line-emissive-strength"),l=n.paint.get("line-occlusion-opacity"),c=n.layout.get("line-elevation-reference"),u="meters"===n.layout.get("line-width-unit"),h="sea"===c,d=!(!t.terrain||!t.terrain.enabled),p=t.context,f=p.gl;if(n.hasElevatedBuckets&&"globe"===t.transform.projection.name)return;const m=n.layout.get("line-cross-slope"),g=void 0!==m,_=m<1,y=t.colorModeForDrapableLayerRenderPass(a),v=t.terrain&&t.terrain.renderingToTexture,x=v?1:e.o.devicePixelRatio,b=n.paint.get("line-dasharray"),T=b.constantOr(1),w=n.layout.get("line-cap"),E=b.constantOr(null),S=w.constantOr(null),A=n.paint.get("line-pattern"),M=A.constantOr(1),I=n.paint.get("line-pattern-cross-fade"),C=A.constantOr(null),P=n.paint.get("line-opacity").constantOr(1);let L=!M&&1!==P||t.depthOcclusion&&l>0&&l<1;const R=n.paint.get("line-gradient"),O=M?"linePattern":"line",D=e.e1(n);let B;if(v&&t.terrain&&t.terrain.clipOrMaskOverlapStencilType()&&(L=!1),0!==l&&t.depthOcclusion){const t=n.paint._values["line-opacity"];t&&t.value&&"constant"===t.value.kind?B=t.value:e.w(`Occlusion opacity for layer ${n.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==s.value.kind&&!1===s.value.isLineProgressConstant&&D.push("VARIABLE_LINE_WIDTH");const F=(r,o,s,a,c,d)=>{for(const m of r){const r=i.getTile(m);if(M&&!r.patternsLoaded())continue;const g=r.getBucket(n);if(!g)continue;if("none"!==g.elevationType&&!c||"none"===g.elevationType&&c)continue;t.prepareDrawTile();const _=[...o],b=t.shadowRenderer,w="road"===g.elevationType&&!!b&&b.enabled;let A=[0,0,0];if(w){const e=t.style.directionalLight,i=t.style.ambientLight;e&&i&&(A=mn(t.style,e,i)),_.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const D=g.programConfigurations.get(n.id);let F=!1;if(C&&r.imageAtlas){const t=e.e2.from(C),i=t.getPrimary().scaleSelf(x).toString(),n=r.imageAtlas.patternPositions.get(i),o=t.getSecondary(),s=o?r.imageAtlas.patternPositions.get(o.scaleSelf(x).toString()):null;F=!!n&&!!s,n&&D.setConstantPatternPositions(n,s)}I>0&&(F||D.getPatternTransitionVertexBuffer("line-pattern"))&&_.push("LINE_PATTERN_TRANSITION");const N=t.isTileAffectedByFog(m),k=t.getOrCreateProgram(O,{config:D,defines:_,overrideFog:N});if(!M&&E&&S&&r.lineAtlas){const e=r.lineAtlas.getDash(E,S);e&&D.setConstantPatternPositions(e)}w&&b.setupShadows(r.tileID.toUnwrapped(),k,"vector-tile");let[U,z]=n.paint.get("line-trim-offset");if("round"===S||"square"===S){const e=1;U!==z&&(0===U&&(U-=e),1===z&&(z+=e))}const V=v?m.projMatrix:null,G=u?1/g.tileToMeter/e.ay(r,1,t.transform.zoom):1,j=u?1/g.tileToMeter/e.ay(r,1,Math.floor(t.transform.zoom)):1,H=M?e.e3(t,r,n,V,x,G,j,[U,z],A,I):e.e4(t,r,n,V,g.lineClipsArray.length,x,G,j,[U,z],A);if(R){const r=g.gradients[n.id];let o=r.texture;if(n.gradientVersion!==r.version){let s=256;if(n.stepInterpolant){const n=i.getSource().maxzoom,r=m.canonical.z===n?Math.ceil(1<<t.transform.maxZoom-m.canonical.z):1;s=e.aA(e.e5(g.maxLineLength/e.al*1024*r),256,p.maxTextureSize)}r.gradient=e.e6({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:s,image:r.gradient||void 0,clips:g.lineClipsArray}),r.texture?r.texture.update(r.gradient):r.texture=new e.T(p,r.gradient,f.RGBA8),r.version=n.gradientVersion,o=r.texture}p.activeTexture.set(f.TEXTURE1),o.bind(n.stepInterpolant?f.NEAREST:f.LINEAR,f.CLAMP_TO_EDGE)}T&&(p.activeTexture.set(f.TEXTURE0),r.lineAtlasTexture&&r.lineAtlasTexture.bind(f.LINEAR,f.REPEAT),D.updatePaintBuffers()),M&&(p.activeTexture.set(f.TEXTURE0),r.imageAtlasTexture&&r.imageAtlasTexture.bind(f.LINEAR,f.CLAMP_TO_EDGE),D.updatePaintBuffers()),c&&!h&&t.terrain.setupElevationDraw(r,k),t.uploadCommonUniforms(p,k,m.toUnwrapped());const $=e=>{null!=B&&(B.value=P*l),k.draw(t,f.TRIANGLES,s,e,y,Ji.disabled,H,n.id,g.layoutVertexBuffer,g.indexBuffer,g.segments,n.paint,t.transform.zoom,D,[g.layoutVertexBuffer2,g.patternVertexBuffer,g.zOffsetVertexBuffer]),null!=B&&(B.value=P)};if(L&&!c){const e=t.stencilModeForClipping(m).ref;0===e&&v&&p.clear({stencil:0});const i={func:f.EQUAL,mask:255};H.u_alpha_discard_threshold=.8,$(new Xi(i,e,255,f.KEEP,f.KEEP,f.INVERT)),H.u_alpha_discard_threshold=0,$(new Xi(i,e,255,f.KEEP,f.KEEP,f.KEEP))}else H.u_alpha_discard_threshold=L&&c&&d?.8:0,$(c?a:t.stencilModeForClipping(m))}};let N=t.depthModeForSublayer(0,Wi.ReadOnly);const k=new Wi(t.depthOcclusion?f.GREATER:f.LEQUAL,Wi.ReadOnly,t.depthRangeFor3D);if(n.hasNonElevatedBuckets){const i=!v&&t.terrain;0!==l&&i?e.w(`Occlusion opacity for layer ${n.id} is supported on terrain only if the layer has line-z-offset enabled.`):i?e.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${n.id}.`):F(r,D,N,Xi.disabled,!1,!0)}if(n.hasElevatedBuckets){"hd-road-markup"===c?d||(N=k,D.push("ELEVATED_ROADS")):(D.push("ELEVATED"),N=k,g&&D.push(_?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),h&&D.push("ELEVATION_REFERENCE_SEA"));const e=L?t.stencilModeFor3D():Xi.disabled;t.forceTerrainMode=!0,F(r,D,N,e,!0,!0),L&&F(r,D,N,e,!0,!1),t.forceTerrainMode=!1}L&&(t.resetStencilClippingMasks(),v&&p.clear({stencil:0})),0===l||t.depthOcclusion||v||t.layersWithOcclusionOpacity.push(t.currentLayer)},fill:function(t,i,n,r){const o=n.paint.get("fill-color"),s=n.paint.get("fill-opacity");if(0===s.constantOr(1))return;const a=n.paint.get("fill-emissive-strength"),l=t.colorModeForDrapableLayerRenderPass(a),c=n.paint.get("fill-pattern"),u=t.opaquePassEnabledForLayer()&&!c.constantOr(1)&&1===o.constantOr(e.ao.transparent).a&&1===s.constantOr(0)?"opaque":"translucent";let h="none";"none"!==n.layout.get("fill-elevation-reference")?h="road":0!==n.paint.get("fill-z-offset").constantOr(1)&&(h="offset");const d=!(!t.terrain||!t.terrain.enabled),p={painter:t,sourceCache:i,layer:n,coords:r,colorMode:l,elevationType:h,terrainEnabled:d,pass:u};if("shadow"!==t.renderPass)if("offset"!==h){if(Qo(p,!1),"road"===h){const e=!d&&"translucent"===t.renderPass;e&&Ko(t,i,n,r,"geometry"),Qo(p,!0,Xi.disabled),e&&function(e){const{painter:t,sourceCache:i,layer:n,coords:r,colorMode:o}=e,s=t.context.gl,a=e.painter.shadowRenderer,l=!!a&&a.enabled,c=new Wi(t.context.gl.LEQUAL,Wi.ReadOnly,t.depthRangeFor3D);let u=[0,0,0];if(l){const e=t.style.directionalLight,i=t.style.ambientLight;e&&i&&(u=mn(t.style,e,i))}const h=e=>{for(const h of r){const r=i.getTile(h),d=r.getBucket(n);if(!d)continue;const p=d.elevatedStructures;if(!p)continue;let f,m;if(e?(f=p.renderableBridgeSegments,m=p.bridgeProgramConfigurations.get(n.id)):(f=p.renderableTunnelSegments,m=p.tunnelProgramConfigurations.get(n.id)),!f||0===f.segments[0].primitiveLength)continue;m.updatePaintBuffers(),t.prepareDrawTile();const g=t.isTileAffectedByFog(h),_=[];l&&_.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const y=t.getOrCreateProgram("elevatedStructures",{config:m,overrideFog:g,defines:_}),v=t.translatePosMatrix(h.projMatrix,r,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));l&&a.setupShadows(r.tileID.toUnwrapped(),y,"vector-tile");const x=po(v,u);t.uploadCommonUniforms(t.context,y,h.toUnwrapped()),y.draw(t,s.TRIANGLES,c,Xi.disabled,o,Ji.backCCW,x,n.id,p.vertexBuffer,p.indexBuffer,f,n.paint,t.transform.zoom,m,[p.vertexBufferNormal])}};h(!0),h(!1)}(p)}}else Qo(p,!1,t.stencilModeFor3D());else t.shadowRenderer&&"road"===h&&!d&&function(e){const{painter:t,sourceCache:i,layer:n,coords:r}=e,o=t.context.gl,s=e.painter.shadowRenderer;for(const e of r){const r=i.getTile(e),a=r.getBucket(n);if(!a)continue;const l=a.elevatedStructures;if(!l)continue;if(!l.shadowCasterSegments||0===l.shadowCasterSegments.segments[0].primitiveLength)continue;t.prepareDrawTile();const c=a.bufferData.programConfigurations.get(n.id),u=t.isTileAffectedByFog(e),h=t.getOrCreateProgram("elevatedStructuresDepth",{config:c,overrideFog:u}),d=s.calculateShadowPassMatrixFromTile(r.tileID.toUnwrapped());t.uploadCommonUniforms(t.context,h,e.toUnwrapped());const p={u_matrix:d,u_depth_bias:0};h.draw(t,o.TRIANGLES,s.getShadowPassDepthMode(),Xi.disabled,s.getShadowPassColorMode(),Ji.disabled,p,n.id,l.vertexBuffer,l.indexBuffer,l.shadowCasterSegments,n.paint,t.transform.zoom,c)}}(p)},"fill-extrusion":function(t,i,n,r){const o=n.paint.get("fill-extrusion-opacity"),s=t.context,a=s.gl,l=t.terrain,c=l&&l.renderingToTexture;if(0===o)return;const u=t.conflationActive&&t.style.isLayerClipped(n,i.getSource()),h=t.style.order.indexOf(n.fqid);if(u&&function(e,t,i,n,r){for(const o of n){const n=t.getTile(o).getBucket(i);n&&(n.updateReplacement(o,e.replacementSource,r),n.uploadCentroid(e.context))}}(t,i,n,r,h),l||u)for(const e of r){const r=i.getTile(e).getBucket(n);r&&ns(t.context,i,e,r,n,l,u)}if("shadow"===t.renderPass&&t.shadowRenderer){const s=t.shadowRenderer;if(l&&o<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof e.ad)return;const a=s.getShadowPassDepthMode(),c=s.getShadowPassColorMode();es(t,i,n,r,a,Xi.disabled,c,u)}else if("translucent"===t.renderPass){const h=!n.paint.get("fill-extrusion-pattern").constantOr(1),d=n.paint.get("fill-extrusion-color").constantOr(e.ao.white);if(!c&&0!==d.a){const e=new Wi(t.context.gl.LEQUAL,Wi.ReadWrite,t.depthRangeFor3D);1===o&&h?es(t,i,n,r,e,Xi.disabled,$i.unblended,u):(es(t,i,n,r,e,Xi.disabled,$i.disabled,u),es(t,i,n,r,e,t.stencilModeFor3D(),t.colorModeForRenderPass(),u),t.resetStencilClippingMasks())}if(t.style.enable3dLights()&&h&&(!l&&"globe"!==t.transform.projection.name||c)){const o=n.paint.get("fill-extrusion-opacity"),h=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),d=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),p=n.paint.get("fill-extrusion-flood-light-intensity"),f="none"===n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),m=n.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(f?null:n.lut).toArray01().slice(0,3),g=h>0&&d>0,_=p>0,y=(e,t,i)=>(1-i)*e+i*t,v=new ts;v.translate=n.paint.get("fill-extrusion-translate"),v.translateAnchor=n.paint.get("fill-extrusion-translate-anchor"),v.edgeRadius=n.layout.get("fill-extrusion-edge-radius"),v.cutoffFadeRange=n.paint.get("fill-extrusion-cutoff-fade-range");const x=s=>{const l=t.depthModeForSublayer(1,Wi.ReadOnly,a.LEQUAL,!0),c=n.paint.get(s?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),f=y(.1,3,c),g=t._showOverdrawInspector;if(!g){const c=new Xi({func:a.ALWAYS,mask:255},255,255,a.KEEP,a.KEEP,a.REPLACE),g=new $i([a.ONE,a.ONE,a.ONE,a.ONE],e.ao.transparent,[!1,!1,!1,!0],a.MIN);is(v,t,i,n,r,l,c,g,Ji.disabled,s,"sdf",o,h,d,p,m,f,u,!1)}{const c=g?Xi.disabled:new Xi({func:a.EQUAL,mask:255},255,255,a.KEEP,a.DECR,a.DECR),_=g?t.colorModeForRenderPass():new $i([a.ONE_MINUS_DST_ALPHA,a.DST_ALPHA,a.ONE,a.ONE],e.ao.transparent,[!0,!0,!0,!0]);is(v,t,i,n,r,l,c,_,Ji.disabled,s,"color",o,h,d,p,m,f,u,!1)}};if(c){const c=(s,l,c)=>{const f=t.depthModeForSublayer(1,Wi.ReadOnly,a.LEQUAL,!1),g=n.paint.get(s?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),_=y(.1,3,g);{const c=new $i([a.ONE,a.ONE,a.ONE,a.ONE],e.ao.transparent,[!1,!1,!1,!0]);is(v,t,i,n,r,f,Xi.disabled,c,Ji.disabled,s,"clear",o,h,d,p,m,_,u,l)}{const c=new Xi({func:a.ALWAYS,mask:255},255,255,a.KEEP,a.KEEP,a.REPLACE),g=new $i([a.ONE,a.ONE,a.ONE,a.ONE],e.ao.transparent,[!1,!1,!1,!0],a.MIN);is(v,t,i,n,r,f,c,g,Ji.disabled,s,"sdf",o,h,d,p,m,_,u,l)}{const c=s?a.ZERO:a.ONE_MINUS_DST_ALPHA,g=new Xi({func:a.EQUAL,mask:255},255,255,a.KEEP,a.DECR,a.DECR),y=new $i([c,a.DST_ALPHA,a.ONE_MINUS_DST_ALPHA,a.ZERO],e.ao.transparent,[!0,!0,!0,!0]);is(v,t,i,n,r,f,g,y,Ji.disabled,s,"color",o,h,d,p,m,_,u,l)}{const g=new $i([a.ONE,a.ONE,a.ONE,s?a.ZERO:a.ONE],e.ao.transparent,[!1,!1,!1,!0],s?a.FUNC_ADD:a.MAX);is(v,t,i,n,r,f,Xi.disabled,g,Ji.disabled,s,"clear",o,h,d,p,m,_,u,l,c)}};if(g||_){let i;if(t.prepareDrawTile(),l){const t=l.drapeBufferSize[0],n=l.drapeBufferSize[1];i=l.framebufferCopyTexture,i&&(!i||i.size[0]===t&&i.size[1]===n)||(i&&i.destroy(),i=l.framebufferCopyTexture=new e.T(s,new e.q({width:t,height:n}),a.RGBA8)),i.bind(a.LINEAR,a.CLAMP_TO_EDGE),a.copyTexSubImage2D(a.TEXTURE_2D,0,0,0,0,0,t,n)}g&&c(!0,!1,i),_&&c(!1,!0,i)}}else g&&x(!0),_&&x(!1),(g||_)&&t.resetStencilClippingMasks()}}},building:function(e,t,i,n){e.currentLayer<e.firstLightBeamLayer&&(e.firstLightBeamLayer=e.currentLayer);const r=i.paint.get("building-ambient-occlusion-ground-intensity"),o=i.paint.get("building-ambient-occlusion-ground-radius"),s=i.paint.get("building-ambient-occlusion-ground-attenuation"),a=i.paint.get("building-opacity");if(a<=0)return;let l=r>0&&o>0,c=!0;const u=i.paint.get("building-vertical-scale");if(u<=0)return;(!e.shadowRenderer||u<1)&&(c=!1);const h=e.conflationActive&&e.style.isLayerClipped(i,t.getSource()),d=e.style.order.indexOf(i.fqid);if(function(e,t,i,n,r,o){for(const s of o){const o=t.getTile(s).getBucket(i);o&&(r&&o.updateReplacement(s,e.replacementSource,n),o.uploadUpdatedIndexBuffer(e.context))}}(e,t,i,d,h,n),function(e,t,i,n){for(const r of n){const n=t.getTile(r).getBucket(i);n&&n.needsEvaluation()&&n.uploadUpdatedColorBuffer(e.context)}}(e,t,i,n),i.resetLayerRenderingStats(e),e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!0),"shadow"===e.renderPass&&e.shadowRenderer){const r=e.shadowRenderer,o=[],s=r.getShadowPassDepthMode();ls({painter:e,source:t,layer:i,coords:n,defines:o,blendMode:r.getShadowPassColorMode(),depthMode:s,opacity:a,verticalScale:u,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if("translucent"===e.renderPass){let d=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];c&&(d=d.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),e.shadowRenderer&&e.shadowRenderer.useNormalOffset&&(d=d.concat("NORMAL_OFFSET"));const p=i.paint.get("building-facade-emissive-chance"),f=i.paint.get("building-ambient-occlusion-intensity"),m=i.paint.get("building-flood-light-intensity"),g="none"===i.paint.get("building-flood-light-color-use-theme").constantOr("default"),_=i.paint.get("building-flood-light-color").toNonPremultipliedRenderColor(g?null:i.lut).toArray01().slice(0,3),y=i.paint.get("building-flood-light-ground-attenuation"),v=m>0,x=new Wi(e.context.gl.LEQUAL,Wi.ReadWrite,e.depthRangeFor3D);a<1&&ls({painter:e,source:t,layer:i,coords:n,defines:d,blendMode:$i.disabled,depthMode:x,opacity:a,verticalScale:u,facadeEmissiveChance:p,facadeAOIntensity:f,floodLightIntensity:m,floodLightColor:_,depthOnly:!0});const b=e.colorModeForRenderPass();ls({painter:e,source:t,layer:i,coords:n,defines:d,blendMode:b,depthMode:x,opacity:a,verticalScale:u,facadeEmissiveChance:p,facadeAOIntensity:f,floodLightIntensity:m,floodLightColor:_}),l&&cs(e,t,i,n,!0,a,r,o,m,_,s,h),v&&cs(e,t,i,n,!1,a,r,o,m,_,y,h)}else if("light-beam"===e.renderPass){const r=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],o=new Wi(e.context.gl.LEQUAL,Wi.ReadOnly,e.depthRangeFor3D);ls({painter:e,source:t,layer:i,coords:n,defines:r,blendMode:$i.alphaBlended,depthMode:o,opacity:a,verticalScale:u,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!1),e.resetStencilClippingMasks()},hillshade:function(e,t,i,n){if("offscreen"!==e.renderPass&&"translucent"!==e.renderPass)return;if(e.style.disableElevatedTerrain)return;const r=e.context,o=e.terrain&&e.terrain.renderingToTexture,[s,a]="translucent"!==e.renderPass||o?[{},n]:e.stencilConfigForOverlap(n);for(const n of a){const r=t.getTile(n);if(r.needsHillshadePrepare&&"offscreen"===e.renderPass)er(e,r,i);else if("translucent"===e.renderPass){const t=e.depthModeForSublayer(0,Wi.ReadOnly),a=i.paint.get("hillshade-emissive-strength"),l=e.colorModeForDrapableLayerRenderPass(a),c=o&&e.terrain?e.terrain.stencilModeForRTTOverlap(n):s[n.overscaledZ];Kn(e,n,r,i,t,c,l)}}r.viewport.set([0,0,e.width,e.height]),e.resetStencilClippingMasks()},raster:function(t,i,n,r,o,s){if("translucent"!==t.renderPass)return;if(0===n.paint.get("raster-opacity"))return;const a="globe"===t.transform.projection.name,l=0!==n.paint.get("raster-elevation"),c=l&&a;if(t.renderElevatedRasterBackface&&!c)return;const u=t.context,h=u.gl,d=i.getSource(),p=function(t,i,n,r){const o=i.paint.get("raster-color"),s="raster-array"===t.type,a=[],l=i.paint.get("raster-resampling"),c=i.paint.get("raster-color-mix");let u=i.paint.get("raster-color-range");const h=[c[0],c[1],c[2],0],d=c[3];let p="nearest"===l?r.NEAREST:r.LINEAR;if(s&&(a.push("RASTER_ARRAY"),o||a.push("RASTER_COLOR"),"linear"===l&&a.push("RASTER_ARRAY_LINEAR"),p=r.NEAREST,!u&&t.rasterLayers)){const e=t.rasterLayers.find((({id:e})=>e===i.sourceLayer));e&&e.fields&&e.fields.range&&(u=e.fields.range)}if(u=u||[0,1],o){a.push("RASTER_COLOR"),n.activeTexture.set(r.TEXTURE2),i.updateColorRamp(u);let t=i.colorRampTexture;t||(t=i.colorRampTexture=new e.T(n,i.colorRamp,r.RGBA8)),t.bind(r.LINEAR,r.CLAMP_TO_EDGE)}return{mix:h,range:u,offset:d,defines:a,resampling:p}}(d,n,u,h);if(d instanceof e.aT&&!r.length&&!a)return;const f=n.paint.get("raster-emissive-strength"),m=t.colorModeForDrapableLayerRenderPass(f),g=t.terrain&&t.terrain.renderingToTexture,_=!t.options.moving,y="nearest"===n.paint.get("raster-resampling")?h.NEAREST:h.LINEAR;if(d instanceof e.aT&&!r.length&&(d.onNorthPole||d.onSouthPole)){const e=l?t.stencilModeFor3D():Xi.disabled;return void hs(!!d.onNorthPole,null,t,i,n,f,p,Ji.disabled,e)}if(!r.length)return;const[v,x]=d instanceof e.aT||g?[{},r]:t.stencilConfigForOverlap(r),b=x[x.length-1].overscaledZ;c&&p.defines.push("PROJECTION_GLOBE_VIEW"),l&&p.defines.push("RENDER_CUTOFF");const T=(r,o,x)=>{for(const T of r){const r=T.toUnwrapped(),w=i.getTile(T);if(g&&(!w||!w.hasData()))continue;u.activeTexture.set(h.TEXTURE0);const E=ps(w,d,n,p);if(!E||!E.texture)continue;const{texture:S,mix:A,offset:M,tileSize:I,buffer:C}=E;let P,L;g?(P=Wi.disabled,L=T.projMatrix):l?(P=new Wi(h.LEQUAL,Wi.ReadWrite,t.depthRangeFor3D),L=a?Float32Array.from(t.transform.expandedFarZProjMatrix):t.transform.calculateProjMatrix(r,_)):(P=t.depthModeForSublayer(T.overscaledZ-b,1===n.paint.get("raster-opacity")?Wi.ReadWrite:Wi.ReadOnly,h.LESS),L=t.transform.calculateProjMatrix(r,_));const R=t.terrain&&g?t.terrain.stencilModeForRTTOverlap(T):v[T.overscaledZ],O=s?0:n.paint.get("raster-fade-duration");w.registerFadeDuration(O);const D=i.findLoadedParent(T,0),B=Wr(w,D,i,t.transform,O);let F,N;!B.isFading&&w.refreshedUponExpiration&&(w.refreshedUponExpiration=!1),t.terrain&&t.terrain.prepareDrawTile(),u.activeTexture.set(h.TEXTURE0),S.bind(y,h.CLAMP_TO_EDGE),u.activeTexture.set(h.TEXTURE1),D?(D.texture&&D.texture.bind(y,h.CLAMP_TO_EDGE),F=Math.pow(2,D.tileID.overscaledZ-w.tileID.overscaledZ),N=[w.tileID.canonical.x*F%1,w.tileID.canonical.y*F%1]):S.bind(y,h.CLAMP_TO_EDGE),"useMipmap"in S&&u.extTextureFilterAnisotropic&&t.transform.pitch>20&&h.texParameterf(h.TEXTURE_2D,u.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,u.extTextureFilterAnisotropicMax);const k=t.transform;let U;const z=l?ds(k):[0,0,0,0];let V,G,j,H,$,W=0;if(c&&d instanceof e.aT&&d.coordinates.length>3)V=Float32Array.from(e.bj(e.dI(new e.cC(0,0,0)))),G=Float32Array.from(k.globeMatrix),j=Float32Array.from(e.dE(k)),H=[e.aF(k.center.lng),e.aJ(k.center.lat)],U=d.elevatedGlobePerspectiveTransform,$=d.elevatedGlobeGridMatrix||new Float32Array(9);else if(c){const t=e.dF(T.canonical);W=e.dG(t.getCenter().lat),V=Float32Array.from(e.bj(e.dI(T.canonical))),G=Float32Array.from(k.globeMatrix),j=Float32Array.from(e.dE(k)),H=[e.aF(k.center.lng),e.aJ(k.center.lat)],U=[0,0],$=Float32Array.from(e.dH(T.canonical,t,W,k.worldSize/k._pixelsPerMercatorPixel))}else U=d instanceof e.aT?d.perspectiveTransform:[0,0],V=new Float32Array(16),G=new Float32Array(9),j=new Float32Array(16),H=[0,0],$=new Float32Array(9);const q=Eo(L,V,G,j,$,N||[0,0],e.aj(t.transform.zoom),H,z,F||1,B,n,U,l?n.paint.get("raster-elevation"):0,2,A,M,p.range,I,C,f),X=t.isTileAffectedByFog(T),Y=t.getOrCreateProgram("raster",{defines:p.defines,overrideFog:X});if(t.uploadCommonUniforms(u,Y,r),d instanceof e.aT){const i=d.elevatedGlobeVertexBuffer,r=d.elevatedGlobeIndexBuffer;if(g||!a)d.boundsBuffer&&d.boundsSegments&&Y.draw(t,h.TRIANGLES,P,Xi.disabled,m,Ji.disabled,q,n.id,d.boundsBuffer,t.quadTriangleIndexBuffer,d.boundsSegments);else if(i&&r){const s=k.zoom<=e.cZ?d.elevatedGlobeSegments:d.getSegmentsForLongitude(k.center.lng);s&&Y.draw(t,h.TRIANGLES,P,Xi.disabled,m,o,q,n.id,i,r,s)}}else if(c){P=new Wi(h.LEQUAL,Wi.ReadOnly,t.depthRangeFor3D);const e=t.globeSharedBuffers;if(e){const[i,r,s]=e.getGridBuffers(W,!1);Y.draw(t,h.TRIANGLES,P,x||R,t.colorModeForRenderPass(),o,q,n.id,i,r,s)}}else{const{tileBoundsBuffer:e,tileBoundsIndexBuffer:i,tileBoundsSegments:r}=t.getTileBoundsBuffers(w);Y.draw(t,h.TRIANGLES,P,R,m,Ji.disabled,q,n.id,e,i,r)}}if(!(d instanceof e.aT)&&c)for(const e of r){const r=e.canonical.y===(1<<e.canonical.z)-1;0===e.canonical.y&&hs(!0,e,t,i,n,f,p,o,x||Xi.disabled),r&&hs(!1,e,t,i,n,f,p,o===Ji.frontCW?Ji.backCW:Ji.frontCW,x||Xi.disabled)}};c?T(x,t.renderElevatedRasterBackface?Ji.backCW:Ji.frontCW,t.stencilModeFor3D()):T(x,Ji.disabled,void 0),t.resetStencilClippingMasks()},"raster-particle":function(t,i,n,r,o,s){"offscreen"===t.renderPass&&function(t,i,n,r){if(!r.length)return;const o=t.context,s=o.gl,a=i.getSource();if(!(a instanceof ht))return;const l=Math.ceil(Math.sqrt(n.paint.get("raster-particle-count")));let c=n.particlePositionRGBAImage;if(!c||c.width!==l){const t=function(e){const t=e*e,i=new Uint8Array(4*t),n=function(e){return e|=0,e=Math.imul(2747636419^e,2654435769),e=Math.imul(e^e>>>16,2654435769),((e=Math.imul(e^e>>>16,2654435769))>>>0)/4294967296},r=1/1.1;for(let e=0;e<t;e++){const t=r*(n(2*e+0)+Ao),o=r*(n(2*e+1)+Ao),s=255*t%1,a=255*o%1,l=s,c=o-a/255,u=a;i[4*e+0]=255*(t-s/255),i[4*e+1]=255*l,i[4*e+2]=255*c,i[4*e+3]=255*u}return i}(l);c=n.particlePositionRGBAImage=new e.q({width:l,height:l},t)}let u=n.particleFramebuffer;u?u.width!==l&&(u.destroy(),u=n.particleFramebuffer=o.createFramebuffer(l,l,!0,null)):u=n.particleFramebuffer=o.createFramebuffer(l,l,!0,null);const h=[];for(const e of r){const t=i.getTile(e);if(!(t instanceof Pt))continue;const r=gs(t,a,n);if(!r)continue;const s=[t.tileSize,t.tileSize];let u=n.tileFramebuffer;u||(u=n.tileFramebuffer=o.createFramebuffer(s[0],s[1],!0,null));let d=t.rasterParticleState;d||(d=t.rasterParticleState=new ms(o,e,s,c));const p=d.update(n.lastInvalidatedAt);d.particleTextureDimension!==l&&d.updateParticleTexture(e,c);const f=d.targetColorTexture;d.targetColorTexture=d.backgroundColorTexture,d.backgroundColorTexture=f;const m=d.particleTexture0;d.particleTexture0=d.particleTexture1,d.particleTexture1=m,h.push([e,r,d,p])}if(0===h.length)return;const d=e.o.now(),p=n.previousDrawTimestamp?.001*(d-n.previousDrawTimestamp):.0167;if(n.previousDrawTimestamp=d,n.hasColorMap()){o.activeTexture.set(s.TEXTURE0+2);let t=n.colorRampTexture;t||(t=n.colorRampTexture=new e.T(o,n.colorRamp,s.RGBA8)),t.bind(s.LINEAR,s.CLAMP_TO_EDGE)}o.bindFramebuffer.set(n.tileFramebuffer.framebuffer),function(t,i,n){const r=t.context,o=r.gl,s=i.tileFramebuffer;r.activeTexture.set(o.TEXTURE0);const a={u_texture:0,u_opacity:1.05*(c=i.paint.get("raster-particle-fade-opacity-factor"))/(c+.05)},l=t.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var c;for(const c of n){const[,,n,u]=c;s.colorAttachment.set(n.targetColorTexture.texture),r.viewport.set([0,0,s.width,s.height]),r.clear({color:e.ao.transparent}),u&&(n.backgroundColorTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE),l.draw(t,o.TRIANGLES,Wi.disabled,Xi.disabled,$i.alphaBlended,Ji.disabled,a,i.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments))}}(t,n,h),function(t,i,n,r){const o=t.context,s=o.gl,a=n.tileFramebuffer,l="globe"===t.transform.projection.name,c=n.paint.get("raster-particle-max-speed");for(const u of r){const[r,h,d]=u;o.activeTexture.set(s.TEXTURE0+0),h.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE),a.colorAttachment.set(d.targetColorTexture.texture);const p=t.getOrCreateProgram("rasterParticleDraw",{defines:h.defines,overrideFog:!1});o.activeTexture.set(s.TEXTURE0+1);const f=h.scalarData?[]:[0,1,2,3].map((t=>e.e8[t](r)));f.push(r);const m=r.canonical.x,g=r.canonical.y;for(const e of f){const o=i.getTile(l?e.wrapped():e);if(!o)continue;const a=o.rasterParticleState;if(!a)continue;const u=e.canonical.x+(1<<e.canonical.z)*(e.wrap-r.wrap),d=e.canonical.y;a.particleTexture0.bind(s.NEAREST,s.CLAMP_TO_EDGE);const f=Io(1,a.particleTexture0.size[0],[u-m,d-g],0,h.texture.size,2,c,h.textureOffset,h.scale,h.offset);p.draw(t,s.POINTS,Wi.disabled,Xi.disabled,$i.alphaBlended,Ji.disabled,f,n.id,a.particleIndexBuffer,void 0,a.particleSegment)}}}(t,i,n,h),o.bindFramebuffer.set(n.particleFramebuffer.framebuffer),function(t,i,n,r){const o=t.context,s=o.gl,a=i.paint.get("raster-particle-max-speed"),l=r*i.paint.get("raster-particle-speed-factor")*.15,c=function(e){return Math.pow(e,6)}(.01+1*i.paint.get("raster-particle-reset-rate-factor")),u=i.particleFramebuffer;o.viewport.set([0,0,u.width,u.height]);for(const r of n){const[,n,h]=r;o.activeTexture.set(s.TEXTURE0+0),n.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE),o.activeTexture.set(s.TEXTURE0+1);const d=h.particleTexture0;d.bind(s.NEAREST,s.CLAMP_TO_EDGE);const p=Co(1,d.size[0],0,n.texture.size,a,l,c,n.textureOffset,n.scale,n.offset);u.colorAttachment.set(h.particleTexture1.texture),o.clear({color:e.ao.transparent}),t.getOrCreateProgram("rasterParticleUpdate",{defines:n.defines}).draw(t,s.TRIANGLES,Wi.disabled,Xi.disabled,$i.unblended,Ji.disabled,p,i.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments)}}(t,n,h,p)}(t,i,n,r),"translucent"===t.renderPass&&(function(t,i,n,r){const o=t.context,s=o.gl,a=i.getSource().tileSize,l=5*(1-e.ah(e.cK,e.cK+1,t.transform.zoom))*a+n.paint.get("raster-particle-elevation"),c=!t.options.moving,u="globe"===t.transform.projection.name;if(!r.length)return;const[h,d]=t.stencilConfigForOverlap(r),p=[];u&&p.push("PROJECTION_GLOBE_VIEW");const f=t.stencilModeFor3D();for(const r of d){const a=r.toUnwrapped(),d=i.getTile(r);if(!d.rasterParticleState)continue;const m=d.rasterParticleState,g=100;d.registerFadeDuration(g);const _=i.findLoadedParent(r,0),y=Wr(d,_,i,t.transform,g);let v,x;t.terrain&&t.terrain.prepareDrawTile(),o.activeTexture.set(s.TEXTURE0),m.targetColorTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE),o.activeTexture.set(s.TEXTURE1),_&&_.rasterParticleState?(_.rasterParticleState.targetColorTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE),v=Math.pow(2,_.tileID.overscaledZ-d.tileID.overscaledZ),x=[d.tileID.canonical.x*v%1,d.tileID.canonical.y*v%1]):m.targetColorTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE);const b=u?Float32Array.from(t.transform.expandedFarZProjMatrix):t.transform.calculateProjMatrix(a,c),T=t.transform,w=_s(T),E=e.dF(r.canonical),S=e.dG(E.getCenter().lat);let A,M,I,C,P;u?(A=Float32Array.from(e.bj(e.dI(r.canonical))),M=Float32Array.from(T.globeMatrix),I=Float32Array.from(e.dE(T)),C=[e.aF(T.center.lng),e.aJ(T.center.lat)],P=Float32Array.from(e.dH(r.canonical,E,S,T.worldSize/T._pixelsPerMercatorPixel))):(A=new Float32Array(16),M=new Float32Array(9),I=new Float32Array(16),C=[0,0],P=new Float32Array(9));const L=Mo(b,A,M,I,P,x||[0,0],e.aj(t.transform.zoom),C,w,v||1,y,l),R=t.isTileAffectedByFog(r),O=t.getOrCreateProgram("rasterParticle",{defines:p,overrideFog:R});if(t.uploadCommonUniforms(o,O,a),u){const e=new Wi(s.LEQUAL,Wi.ReadOnly,t.depthRangeFor3D),i=0,r=t.globeSharedBuffers;if(r){const[o,a,l]=r.getGridBuffers(S,0!==i);O.draw(t,s.TRIANGLES,e,f,$i.alphaBlended,t.renderElevatedRasterBackface?Ji.frontCCW:Ji.backCCW,L,n.id,o,a,l)}}else{const e=t.depthModeForSublayer(0,Wi.ReadOnly),i=h[r.overscaledZ],{tileBoundsBuffer:o,tileBoundsIndexBuffer:a,tileBoundsSegments:l}=t.getTileBoundsBuffers(d);O.draw(t,s.TRIANGLES,e,i,$i.alphaBlended,Ji.disabled,L,n.id,o,a,l)}}t.resetStencilClippingMasks()}(t,i,n,r),t.style.map.triggerRepaint())},background:function(t,i,n,r){const o=n.paint.get("background-color"),s="none"===n.paint.get("background-color-use-theme").constantOr("default"),a=n.paint.get("background-opacity"),l=n.paint.get("background-emissive-strength"),c="viewport"===n.paint.get("background-pitch-alignment");if(0===a)return;const u=t.context,h=u.gl,d=t.transform,p=d.tileSize,f=n.paint.get("background-pattern");let m;if(void 0!==f){if(null===f)return;if(m=t.imageManager.getPattern(e.I.from(f.toString()),n.scope,t.style.getLut(n.scope)),!m)return}const g=!f&&1===o.a&&1===a&&t.opaquePassEnabledForLayer()?"opaque":"translucent";if(t.renderPass!==g)return;const _=Xi.disabled,y=t.depthModeForSublayer(0,"opaque"===g?Wi.ReadWrite:Wi.ReadOnly),v=t.colorModeForDrapableLayerRenderPass(l),x=f?"backgroundPattern":"background";let b,T=r;if(T||(b=t.getBackgroundTiles(),T=Object.values(b).map((e=>e.tileID))),f&&(u.activeTexture.set(h.TEXTURE0),t.imageManager.bind(t.context,n.scope)),c){const i=t.getOrCreateProgram(x,{overrideFog:!1,overrideRtt:!0}),r=new Float32Array(e.bz([])),u=new e.aP(0,0,0,0,0),d=f?Oo(r,l,a,t,0,n.scope,m,c,{tileID:u,tileSize:p}):Ro(r,l,a,o.toPremultipliedRenderColor(s?null:n.lut));i.draw(t,h.TRIANGLES,y,_,v,Ji.disabled,d,n.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments)}else for(const e of T){const g=t.isTileAffectedByFog(e),T=t.getOrCreateProgram(x,{overrideFog:g}),w=e.toUnwrapped(),E=r?e.projMatrix:t.transform.calculateProjMatrix(w);t.prepareDrawTile();const S=i?i.getTile(e):b?b[e.key]:new Ct(e,p,d.zoom,t),A=f?Oo(E,l,a,t,0,n.scope,m,c,{tileID:e,tileSize:p}):Ro(E,l,a,o.toPremultipliedRenderColor(s?null:n.lut));t.uploadCommonUniforms(u,T,w);const{tileBoundsBuffer:M,tileBoundsIndexBuffer:I,tileBoundsSegments:C}=t.getTileBoundsBuffers(S);T.draw(t,h.TRIANGLES,y,_,v,Ji.disabled,A,n.id,M,I,C)}},sky:function(t,i,n){const r=t._atmosphere?e.aj(t.transform.zoom):1,o=n.paint.get("sky-opacity")*r;if(0===o)return;const s=t.context,a=n.paint.get("sky-type"),l=new Wi(s.gl.LEQUAL,Wi.ReadOnly,[0,1]),c=t.frameCounter/1e3%1;"atmosphere"===a?"offscreen"===t.renderPass?n.needsSkyboxCapture(t)&&(function(t,i){const n=t.context,r=n.gl;let o=i.skyboxFbo;if(!o){o=i.skyboxFbo=n.createFramebuffer(32,32,!0,null),i.skyboxGeometry=new Ls(n),i.skyboxTexture=n.gl.createTexture(),r.bindTexture(r.TEXTURE_CUBE_MAP,i.skyboxTexture),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,r.LINEAR);for(let e=0;e<6;++e)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,r.RGBA,32,32,0,r.RGBA,r.UNSIGNED_BYTE,null)}n.bindFramebuffer.set(o.framebuffer),n.viewport.set([0,0,32,32]);const s=i.getCenter(t,!0),a=t.getOrCreateProgram("skyboxCapture"),l=new Float64Array(16);e.bz(l),e.em(l,l,.5*-Math.PI),Rs(t,i,a,l,s,0),e.bz(l),e.em(l,l,.5*Math.PI),Rs(t,i,a,l,s,1),e.bz(l),e.cT(l,l,.5*-Math.PI),Rs(t,i,a,l,s,2),e.bz(l),e.cT(l,l,.5*Math.PI),Rs(t,i,a,l,s,3),e.bz(l),Rs(t,i,a,l,s,4),e.bz(l),e.em(l,l,Math.PI),Rs(t,i,a,l,s,5),n.viewport.set([0,0,t.width,t.height])}(t,n),n.markSkyboxValid(t)):"sky"===t.renderPass&&function(e,t,i,n,r){const o=e.context,s=o.gl,a=e.transform,l=e.getOrCreateProgram("skybox");o.activeTexture.set(s.TEXTURE0),s.bindTexture(s.TEXTURE_CUBE_MAP,t.skyboxTexture);const c=((e,t,i,n,r)=>({u_matrix:e,u_sun_direction:t,u_cubemap:0,u_opacity:n,u_temporal_offset:r}))(a.skyboxMatrix,t.getCenter(e,!1),0,n,r);e.uploadCommonUniforms(o,l),l.draw(e,s.TRIANGLES,i,Xi.disabled,e.colorModeForRenderPass(),Ji.backCW,c,"skybox",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}(t,n,l,o,c):"gradient"===a&&"sky"===t.renderPass&&function(t,i,n,r,o){const s=t.context,a=s.gl,l=t.transform,c=t.getOrCreateProgram("skyboxGradient");i.skyboxGeometry||(i.skyboxGeometry=new Ls(s)),s.activeTexture.set(a.TEXTURE0);let u=i.colorRampTexture;u||(u=i.colorRampTexture=new e.T(s,i.colorRamp,a.RGBA8)),u.bind(a.LINEAR,a.CLAMP_TO_EDGE);const h=((t,i,n,r,o)=>({u_matrix:t,u_color_ramp:0,u_center_direction:i,u_radius:e.an(n),u_opacity:r,u_temporal_offset:o}))(l.skyboxMatrix,i.getCenter(t,!1),i.paint.get("sky-gradient-radius"),r,o);t.uploadCommonUniforms(s,c),c.draw(t,a.TRIANGLES,n,Xi.disabled,t.colorModeForRenderPass(),Ji.backCW,h,"skyboxGradient",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}(t,n,l,o,c)},custom:function(t,i,n,r){const o=t.context,s=n.implementation;if(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes("custom")||t.terrain&&(t.terrain.renderingToTexture||"offscreen"===t.renderPass)&&n.isDraped(i)){if("offscreen"===t.renderPass){const i=s.prerender;if(i){if(t.setCustomLayerDefaults(),o.setColorMode(t.colorModeForRenderPass()),"globe"===t.transform.projection.name){const n=t.transform.pointMerc;i.call(s,o.gl,t.transform.customLayerMatrix(),t.transform.getProjection(),t.transform.globeToMercatorMatrix(),e.aj(t.transform.zoom),[n.x,n.y],t.transform.pixelsPerMeterRatio)}else i.call(s,o.gl,t.transform.customLayerMatrix());o.setDirty(),t.setBaseState()}}else if("translucent"===t.renderPass){if(t.terrain&&t.terrain.renderingToTexture){const e=s.renderToTile;if(e){const i=r[0].canonical,n={x:i.x+r[0].wrap*(s.wrapTileId?0:1<<i.z),y:i.y,z:i.z};o.setDepthMode(Wi.disabled),o.setStencilMode(Xi.disabled),o.setColorMode(t.colorModeForRenderPass()),t.setCustomLayerDefaults(),e.call(s,o.gl,n),o.setDirty(),t.setBaseState()}return}t.setCustomLayerDefaults(),o.setColorMode(t.colorModeForRenderPass()),o.setStencilMode(Xi.disabled);const i="3d"===s.renderingMode?new Wi(t.context.gl.LEQUAL,Wi.ReadWrite,t.depthRangeFor3D):t.depthModeForSublayer(0,Wi.ReadOnly);if(o.setDepthMode(i),"globe"===t.transform.projection.name){const i=t.transform.pointMerc;s.render(o.gl,t.transform.customLayerMatrix(),t.transform.getProjection(),t.transform.globeToMercatorMatrix(),e.aj(t.transform.zoom),[i.x,i.y],t.transform.pixelsPerMeterRatio)}else s.render(o.gl,t.transform.customLayerMatrix());o.setDirty(),t.setBaseState(),o.bindFramebuffer.set(null)}}else e.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(t,i,n,r){if("opaque"===t.renderPass)return;const o=n.paint.get("model-opacity").constantOr(1),s=n.paint.get("model-elevation-reference"),a="ground"===s,l="ground"===s;if(0===o)return;const c=n.paint.get("model-cast-shadows");if("shadow"===t.renderPass){if(!c)return;if(t.terrain&&o<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof e.ad)return}const u=t.shadowRenderer,h=n.paint.get("model-receive-shadows");u&&(u.useNormalOffset=!0,h||(u.enabled=!1));const d=()=>{u&&(u.useNormalOffset=!0,h||(u.enabled=!0))},p=i.getSource();if("light-beam"===t.renderPass&&"batched-model"!==p.type)return;if("vector"===p.type||"geojson"===p.type)return function(t,i,n,r,o){const s=t.transform,a="globe"===s.projection.name,l=s.getFreeCameraOptions().position;if(!t.modelManager)return;const c=t.modelManager;n.modelManager=c;const u=t.shadowRenderer;if(!n._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const h=n._unevaluatedLayout._values["model-id"],d=Object.assign({},n.layout.get("model-id").parameters),p=t.style.order.indexOf(n.fqid);for(const f of r){const r=i.getTile(f).getBucket(n);if(!r||r.projection.name!==s.projection.name)continue;const m=r.getModelUris();if(m&&!r.modelsRequested&&(c.addModelsFromBucket(m,o),r.modelsRequested=!0),a)d.zoom=f.overscaledZ;else{const e=Zs(f,s);d.zoom=e}const g=h.possiblyEvaluate(d);if(Xs(t,r,f),Ys.shadowUniformsInitialized=!1,Ys.useSingleShadowCascade=!!u&&0===u.getMaxCascadeForTile(f.toUnwrapped()),"shadow"===t.renderPass&&u){if(1===t.currentShadowCascade&&r.isInsideFirstShadowMapFrustum)continue;const i=s.calculatePosMatrix(f.toUnwrapped(),s.worldSize);if(Ys.tileMatrix.set(i),Ys.shadowTileMatrix=Float32Array.from(u.calculateShadowPassMatrixFromMatrix(i)),Ys.aabb.min=[0,0,0],Ys.aabb.max[0]=Ys.aabb.max[1]=e.al,Ys.aabb.max[2]=0,Qs(r,Ys,t,n.scope))continue}const _=1<<f.canonical.z,y=[((l.x-f.wrap)*_-f.canonical.x)*e.al,(l.y*_-f.canonical.y)*e.al,l.z*_*e.al];t.conflationActive&&Object.keys(r.instancesPerModel).length>0&&t.style.isLayerClipped(n,i.getSource())&&r.updateReplacement(f,t.replacementSource,p,o)&&(r.uploaded=!1,r.upload(t.context));let v=0;const x=new Array,b=new Array,T=new Array;for(let i in r.instancesPerModel){const s=r.instancesPerModel[i];s.features.length>0&&!a&&(i=g.evaluate(s.features[0].feature,{}));const u=c.getModel(i,o);if(u||c.hasURLBeenRequested(i)||r.modelUris.includes(i)||(r.modelUris.push(i),r.modelsRequested=!1),u&&u.uploaded)if(a){const i=e.c4([],[l.x,l.y,l.z],t.transform.worldSize);e.ev(i,i);for(let n=0;n<s.instancedDataArray.length;++n){const o=[0,0,0],a=[1,1,1],l=e.ew(),c=s.tileCoordinatesForInstance(n),h=s.transformForInstance(n);e.ex(a,h),e.ey(l,h),e.ez(o,l);const d=s.translationForInstance(n),p=new e.aS(0,0);e.eA(r.canonical,p,c.x,c.y);const f=e.bB();e.eB(f,u,t.transform,p,o,a,d,!0,!1,!1);const m=s.colorForInstance(n),g=e.bz([]),_=e.ee(p.lat,t.transform.zoom),y=e.bp([],[1,1,1/_]);e.bq(g,g,i),T.push({zScaleMatrix:y,negCameraPosMatrix:g});for(const e of u.nodes)js(t,e,f,t.transform.expandedFarZProjMatrix,v,x,b,u.materialOverrides,m);++v}}else for(const e of u.nodes)Js(t,n,e,s,y,f,Ys)}if(a)if("shadow"===t.renderPass){for(const e of b)Hs(e.mesh,e.nodeModelMatrix,t,n);for(const e of x)Hs(e.mesh,e.nodeModelMatrix,t,n)}else qs(t,n,1,x,b,T)}}(t,i,n,r,Gs(p,n,t.style._importedAsBasemap)),void d();if(!p.loaded())return;if("batched-model"===p.type)return function(t,i,n,r){n.resetLayerRenderingStats(t);const o=t.context,s=t.transform,a=t.style.fog,l=t.shadowRenderer;if("mercator"!==s.projection.name)return void e.w(`Drawing 3D landmark models for ${s.projection.name} projection is not yet implemented`);const c=t.transform.getFreeCameraOptions().position,u=e.c4([],[c.x,c.y,c.z],t.transform.worldSize),h=e.ev([],u),d=e.bz([]),p=e.ee(s.center.lat,s.zoom),f=e.bp([],[1,1,1/p]);e.bq(d,d,h);const m=n.paint.get("model-opacity").constantOr(1),g=new Wi(o.gl.LEQUAL,Wi.ReadWrite,t.depthRangeFor3D),_=new Wi(o.gl.LEQUAL,Wi.ReadOnly,t.depthRangeFor3D),y=new e.d8([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),v="shadow"===t.renderPass,x=v&&l?l.getCurrentCascadeFrustum():s.getFrustum(s.scaleZoom(s.worldSize)),b=n.paint.get("model-front-cutoff"),T=b[2]<1,w=ln(t,n.paint.get("model-cutoff-fade-range")),E=n.getLayerRenderingStats();(function(e,t,i,n){const r=e.terrain?e.terrain.exaggeration():0,o=e.transform.zoom;for(const s of n){const n=t.getTile(s).getBucket(i);n&&(n.setFilter(i.filter),e.conflationActive&&n.updateReplacement(s,e.replacementSource),n.evaluateTransform(e,i),e.terrain&&r>0&&n.elevationUpdate(e.terrain,r,s,i.source),n.needsReEvaluation(e,o,i)&&n.evaluate(i))}})(t,i,n,r),function(){let c,h,S;T?(c=r.length-1,h=-1,S=-1):(c=0,h=r.length,S=1);const A=new Float64Array(16),M=e.cz(),I=new e.P(0,0);for(let C=c;C!==h;C+=S){const c=r[C],h=i.getTile(c).getBucket(n);if(!h||!h.uploaded)continue;let S=!1;l&&(S=0===l.getMaxCascadeForTile(c.toUnwrapped()));const P=s.calculatePosMatrix(c.toUnwrapped(),s.worldSize),L=h.modelTraits;!v&&T&&(e.bk(A,P),e.af(M,u,A),I.x=M[0],I.y=M[1]);const R=[];h.setFilter(n.filter);for(const i of h.getNodesInfo()){if(i.hiddenByReplacement)continue;if(!i.node.meshes)continue;const n=i.node;let r=0;t.terrain&&n.elevation&&(r=n.elevation*t.terrain.exaggeration());const o=(()=>{const t=i.aabb;return y.min=[...t.min],y.max=[...t.max],y.min[2]+=r,y.max[2]+=r,e.af(y.min,y.min,P),e.af(y.max,y.max,P),y})(),a=i.evaluatedScale;if(a[0]<=1&&a[1]<=1&&a[2]<=1&&0===o.intersects(x))continue;if(!v&&T){const t=1/6;i.cameraCollisionOpacity=u[0]>o.min[0]&&u[0]<o.max[0]&&u[1]>o.min[1]&&u[1]<o.max[1]&&u[2]*p<o.max[2]&&n.footprint&&e.b$(I,n.footprint)?Math.max(i.cameraCollisionOpacity-t,0):Math.min(1,i.cameraCollisionOpacity+t)}const l=[...P],h=1/e.d6(c.canonical),d=n.anchor?n.anchor[0]:0,f=n.anchor?n.anchor[1]:0;e.bq(l,l,[d*(a[0]-1)+i.evaluatedTranslation[0]*h,f*(a[1]-1)+i.evaluatedTranslation[1]*h,r+i.evaluatedTranslation[2]]),e.cp(a,e.eD)||e.cR(l,l,a);const g=e.aB([],l,n.globalMatrix),_=e.aB([],s.expandedFarZProjMatrix,g),E=e.aB([],s.expandedFarZProjMatrix,l),S=e.aC([],[d,f,r,1],_)[2];n.hidden=!1;let A=m;v||(T&&(A*=i.cameraCollisionOpacity,A*=ta(l,s,i.aabb,b)),A*=ea(w,S)),0!==A?R.push({nodeInfo:i,depth:S,opacity:A,wvpForNode:_,wvpForTile:E,nodeModelMatrix:g,tileModelMatrix:l}):n.hidden=!0}v||R.sort(((e,t)=>!T||1===e.opacity&&1===t.opacity?e.depth<t.depth?-1:1:1===e.opacity?-1:1===t.opacity?1:e.depth>t.depth?-1:1));for(const i of R){const r=i.nodeInfo,c=r.node;let u=e.aB([],f,i.tileModelMatrix);e.aB(u,d,u);const h=e.bk([],u);e.ef(h,h),e.cR(h,h,Ks),u=e.aB(u,u,c.globalMatrix);const p="light-beam"===t.renderPass,m="none"===n.paint.get("model-color-use-theme").constantOr("default"),y=L&e.eH.HasMapboxMeshFeatures,x=y?0:r.evaluatedRMEA[0][2];for(let e=0;e<c.meshes.length;++e){const d=c.meshes[e],f=e===c.lightMeshIndex;let b=i.wvpForNode;if(f){if(!p&&!t.terrain&&t.shadowRenderer){t.currentLayer<t.firstLightBeamLayer&&(t.firstLightBeamLayer=t.currentLayer);continue}b=i.wvpForTile}else if(p)continue;const T={defines:[]},w=[];if(!v&&l&&(l.useNormalOffset=!!d.normalBuffer),zs(T.defines,w,d,t,m?null:n.lut),y||T.defines.push("DIFFUSE_SHADED"),S&&T.defines.push("SHADOWS_SINGLE_CASCADE"),E&&(v?E.numRenderedVerticesInShadowPass+=d.vertexArray.length:E.numRenderedVerticesInTransparentPass+=d.vertexArray.length),v){Hs(d,i.nodeModelMatrix,t,n);continue}let A=null;if(a){const e=Us(i.nodeModelMatrix,t.transform);if(A=new Float32Array(e),"globe"!==s.projection.name){const t=d.aabb.min,i=d.aabb.max,[n,r]=a.getOpacityForBounds(e,t[0],t[1],i[0],i[1]);T.overrideFog=n>=Ve||r>=Ve}}const M=d.material;let I;M.occlusionTexture&&M.occlusionTexture.offsetScale&&(I=M.occlusionTexture.offsetScale,T.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const C=t.getOrCreateProgram("model",T);!v&&l&&l.setupShadowsFromMatrix(i.tileModelMatrix,C,l.useNormalOffset),t.uploadCommonUniforms(o,C,null,A);const P=M.pbrMetallicRoughness;P.metallicFactor=.9,P.roughnessFactor=.5;const L=Bo(new Float32Array(b),new Float32Array(u),new Float32Array(h),new Float32Array(c.globalMatrix),t,i.opacity,P.baseColorFactor,M.emissiveFactor,P.metallicFactor,P.roughnessFactor,M,x,n,[0,0,0],I);!f&&(r.hasTranslucentParts||i.opacity<1)&&C.draw(t,o.gl.TRIANGLES,g,Xi.disabled,$i.disabled,Ji.backCCW,L,n.id,d.vertexBuffer,d.indexBuffer,d.segments,n.paint,t.transform.zoom,void 0,w),C.draw(t,o.gl.TRIANGLES,f?_:g,Xi.disabled,f||i.opacity<1||r.hasTranslucentParts?$i.alphaBlended:$i.unblended,Ji.backCCW,L,n.id,d.vertexBuffer,d.indexBuffer,d.segments,n.paint,t.transform.zoom,void 0,w)}}}}()}(t,i,n,r),void d();if("model"!==p.type)return;const f=p.getModels(),m=[],g=t.transform.getFreeCameraOptions().position,_=e.c4([],[g.x,g.y,g.z],t.transform.worldSize);e.ev(_,_);const y=[],v=[];let x=0;for(const r of f){const o=i.getFeatureState("",r.id),s={type:"Unknown",id:r.id,properties:r.featureProperties},c=n.paint.get("model-rotation").evaluate(s,o),u=n.paint.get("model-scale").evaluate(s,o),h=n.paint.get("model-translation").evaluate(s,o);$s(n,r.id,o,r.featureProperties,r.nodeOverrideNames,r.nodeOverrides),Ws(n,r.id,o,r.featureProperties,r.materialOverrideNames,r.materialOverrides),r.nodeOverrides.size>0&&r.computeBoundsAndApplyParent(),r.computeModelMatrix(t,c,u,h,l,a,!1);const d=e.bz([]),p=e.ee(r.position.lat,t.transform.zoom),f=e.bp([],[1,1,1/p]);e.bq(d,d,_),m.push({zScaleMatrix:f,negCameraPosMatrix:d});for(const e of r.nodes)js(t,e,r.matrix,t.transform.expandedFarZProjMatrix,x,y,v,r.materialOverrides);x++}if(y.sort(((e,t)=>t.depth-e.depth)),"shadow"!==t.renderPass)qs(t,n,o,y,v,m),d();else{for(const e of v)Hs(e.mesh,e.nodeModelMatrix,t,n);for(const e of y)Hs(e.mesh,e.nodeModelMatrix,t,n);d()}}},va={line:function(e,t,i){if(e.hasElevatedBuckets=!1,e.hasNonElevatedBuckets=!1,void 0!==e._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==e._unevaluatedLayout.getValue("line-z-offset")){if(t){const i=t.getVisibleCoordinates();for(const n of i){const i=t.getTile(n).getBucket(e);if(i&&("none"!==i.elevationType?e.hasElevatedBuckets=!0:e.hasNonElevatedBuckets=!0,e.hasElevatedBuckets&&e.hasNonElevatedBuckets))break}}}else e.hasNonElevatedBuckets=!0},model:function(e,t,i){const n=t.getSource();if(!n.loaded())return;if("vector"===n.type||"geojson"===n.type){const t=Gs(n,e,i.style._importedAsBasemap);return void(i.modelManager&&i.modelManager.upload(i,t))}if("batched-model"===n.type)return;if("model"!==n.type)return;const r=n.getModels();for(const e of r)e.upload(i.context)},raster:function(e,t,i){const n=t.getSource();if(!(n instanceof ht&&n.loaded()))return;const r=e.sourceLayer||n.rasterLayerIds&&n.rasterLayerIds[0];if(!r)return;const o=e.paint.get("raster-array-band")||n.getInitialBand(r);if(null==o)return;const s=t.getIds().map((e=>t.getTileByID(e)));for(const t of s)t.updateNeeded(e.id,o)&&n.prepareTile(t,r,e.id,o)},"raster-particle":function(e,t,i){const n=t.getSource();if(!(n instanceof ht&&n.loaded()))return;const r=e.sourceLayer||n.rasterLayerIds&&n.rasterLayerIds[0];if(!r)return;const o=e.paint.get("raster-particle-array-band")||n.getInitialBand(r);if(null==o)return;const s=t.getIds().map((e=>t.getTileByID(e)));for(const t of s)t.updateNeeded(e.id,o)&&n.prepareTile(t,r,e.id,o)}},xa={fill:Ko},ba={fill:function(e,t,i,n){if(!i.layout||"none"===i.layout.get("fill-elevation-reference")||0===i.paint.get("fill-opacity").constantOr(1))return;const r=e.context.gl,o=new Wi(r.LEQUAL,Wi.ReadOnly,e.depthRangeFor3D),s=new Xi({func:r.ALWAYS,mask:255},255,255,r.KEEP,r.KEEP,r.REPLACE),a=e.transform.getFreeCameraOptions().position,l=e.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const c of n){const n=t.getTile(c),u=n.getBucket(i);if(!u)continue;const h=u.elevatedStructures;if(!h||0===h.depthSegments.segments[0].primitiveLength)continue;const d=Jo(c.toUnwrapped(),a),p=e.translatePosMatrix(c.projMatrix,n,i.paint.get("fill-translate"),i.paint.get("fill-translate-anchor")),f=fo(p,d,0,1,0);l.draw(e,r.TRIANGLES,o,s,$i.disabled,Ji.disabled,f,i.id,h.vertexBuffer,h.indexBuffer,h.depthSegments,i.paint,e.transform.zoom)}}};class Ta{constructor(t,i,n,r,o,s){this.context=new Go(t,i),this.transform=n,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=o,this._timeStamp=e.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const a=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const e of a)this._debugParams.enabledLayers[e]=!0;o.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),o.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),o.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),o.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),o.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),o.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const e of a)o.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],e);this.occlusionParams=new ra(o),this.setup(),this.numSublayers=Ot.maxUnderzooming+Ot.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new e.eO,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new dn(this),this._wireframeDebugCache=new na,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const l=new e.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new e.T(this.context,l,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=r,this.worldview=s}updateTerrain(e,t){const i=!!e&&!!e.terrain&&this.transform.projection.supportsTerrain;if(!(i||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Zr(this,e));const n=this._terrain;this.transform.elevation=i?n:null,n.update(e,this.transform,t),this.transform.elevation&&!n.enabled&&(this.transform.elevation=null)}_updateFog(e){const t=e.fog;if(!t||"globe"===this.transform.projection.name||t.getOpacity(this.transform.pitch)<1||t.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[i,n]=t.getFovAdjustedRange(this.transform._fov);if(i>n)return void(this.transform.fogCullDistSq=null);const r=i+.78*(n-i);this.transform.fogCullDistSq=r*r}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(e){e&&!this._terrain&&(this._terrain=new Zr(this,this.style)),this._forceTerrainMode=e}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,i){if(this.width=t*e.o.devicePixelRatio,this.height=i*e.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const e of this.style.order)this.style._mergedLayers[e].resize()}setup(){const t=this.context,i=new e.bc;i.emplaceBack(0,0),i.emplaceBack(e.al,0),i.emplaceBack(0,e.al),i.emplaceBack(e.al,e.al),this.tileExtentBuffer=t.createVertexBuffer(i,e.be.members),this.tileExtentSegments=e.bf.simpleSegment(0,0,4,2);const n=new e.bc;n.emplaceBack(0,0),n.emplaceBack(e.al,0),n.emplaceBack(0,e.al),n.emplaceBack(e.al,e.al),this.debugBuffer=t.createVertexBuffer(n,e.be.members),this.debugSegments=e.bf.simpleSegment(0,0,4,5);const r=new e.bc;r.emplaceBack(-1,-1),r.emplaceBack(1,-1),r.emplaceBack(-1,1),r.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(r,e.be.members),this.viewportSegments=e.bf.simpleSegment(0,0,4,2);const o=new e.a$;o.emplaceBack(0,0,0,0),o.emplaceBack(e.al,0,e.al,0),o.emplaceBack(0,e.al,0,e.al),o.emplaceBack(e.al,e.al,e.al,e.al),this.mercatorBoundsBuffer=t.createVertexBuffer(o,e.bh.members),this.mercatorBoundsSegments=e.bf.simpleSegment(0,0,4,2);const s=new e.b0;s.emplaceBack(0,1,2),s.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(s);const a=new e.bd;for(const e of[0,1,3,2,0])a.emplaceBack(e);this.debugIndexBuffer=t.createIndexBuffer(a),this.emptyTexture=new e.T(t,new e.q({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=e.bB();const l=this.context.gl;this.stencilClearMode=new Xi({func:l.ALWAYS,mask:0},0,255,l.ZERO,l.ZERO,l.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(e){return e._makeTileBoundsBuffers(this.context,this.transform.projection),e._tileBoundsBuffer?{tileBoundsBuffer:e._tileBoundsBuffer,tileBoundsIndexBuffer:e._tileBoundsIndexBuffer,tileBoundsSegments:e._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const e=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,e.TRIANGLES,Wi.disabled,this.stencilClearMode,$i.disabled,Ji.disabled,$r(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(e,t,i){if(!t||this.currentStencilSource===t.id||!e.isTileClipped()||!i||0===i.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let e=!1;for(const t of i)if(void 0===this._tileClippingMaskIDs[t.key]){e=!0;break}if(!e)return}this.currentStencilSource=t.id;const n=this.context,r=n.gl;this.nextStencilID+i.length>256&&this.clearStencil(),n.setColorMode($i.disabled),n.setDepthMode(Wi.disabled);const o=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const e of i){const i=t.getTile(e),n=this._tileClippingMaskIDs[e.key]=this.nextStencilID++,{tileBoundsBuffer:s,tileBoundsIndexBuffer:a,tileBoundsSegments:l}=this.getTileBoundsBuffers(i);o.draw(this,r.TRIANGLES,Wi.disabled,new Xi({func:r.ALWAYS,mask:0},n,255,r.KEEP,r.KEEP,r.REPLACE),$i.disabled,Ji.disabled,$r(e.projMatrix),"$clipping",s,a,l)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,t=this.context.gl;return new Xi({func:t.NOTEQUAL,mask:255},e,255,t.KEEP,t.KEEP,t.REPLACE)}stencilModeForClipping(e){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(e);const t=this.context.gl;return new Xi({func:t.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,t.KEEP,t.KEEP,t.REPLACE)}stencilConfigForOverlap(e){const t=this.context.gl,i=e.sort(((e,t)=>t.overscaledZ-e.overscaledZ)),n=i[i.length-1].overscaledZ,r=i[0].overscaledZ-n+1;if(r>1){this.currentStencilSource=void 0,this.nextStencilID+r>256&&this.clearStencil();const e={};for(let i=0;i<r;i++)e[i+n]=new Xi({func:t.GEQUAL,mask:255},i+this.nextStencilID,255,t.KEEP,t.KEEP,t.REPLACE);return this.nextStencilID+=r,[e,i]}return[{[n]:Xi.disabled},i]}colorModeForRenderPass(){const t=this.context.gl;if(this._showOverdrawInspector){const i=1/8;return new $i([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new e.ao(i,i,i,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?$i.unblended:$i.alphaBlended}colorModeForDrapableLayerRenderPass(t){const i=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new $i([i.ONE,i.ONE_MINUS_SRC_ALPHA,i.CONSTANT_ALPHA,i.ONE_MINUS_SRC_ALPHA],new e.ao(0,0,0,void 0===t?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(e,t,i,n=!1){if(this.depthOcclusion)return new Wi(this.context.gl.GREATER,Wi.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!n)return Wi.disabled;const r=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new Wi(i||this.context.gl.LEQUAL,t,[r,r])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,i=Math.ceil(this.width),n=Math.ceil(this.height),r=this.context.bindFramebuffer.get(),o=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===i&&this.depthFBO.height===n||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==i&&0!==n&&(this.depthFBO=new Vo(this.context,i,n,!1,"texture"),this.depthTexture=new e.T(this.context,{width:i,height:n,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(r),t.bindTexture(t.TEXTURE_2D,o),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,i,n,0,0,i,n,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((e,t)=>e+t/this._fpsHistory.length),0))}render(t,i){const n=e.o.now();this._dt=n-this._timeStamp,this._timeStamp=n,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=i;const r=this.style._mergedLayers,o=!(!this.terrain||!this.terrain.enabled),s=()=>this.style._getOrder(o).filter((e=>{const t=r[e];return!(t.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[t.type]}));let a=s(),l=!1,c=!1,u=null;for(const e of a){const t=r[e];"circle"===t.type?l=!0:"building"===t.type?u=t:"symbol"===t.type&&(t.hasOcclusionOpacityProperties?c=!0:l=!0)}let h=a.map((e=>r[e]));const d=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(e.o.now()),this.imageManager.beginFrame();let p=0,f=!1;for(const e in d){const t=d[e];t.used&&(t.prepare(this.context),t.getSource().usedInConflation&&++p)}let m=!1;for(const e of h)e.isHidden(this.transform.zoom)||("clip"===e.type&&(m=!0),this.prepareLayer(e));const g={},_={},y={},v={},x={};for(const e in d){const t=d[e];g[e]=t.getVisibleCoordinates(),_[e]=g[e].slice().reverse(),y[e]=t.getVisibleCoordinates(!0).reverse(),v[e]=t.getShadowCasterCoordinates(),x[e]=t.sortCoordinatesByDistance(g[e])}const b=e=>{const t=this.style.getLayerSourceCache(e);return t&&t.used?t.getSource():null};if(p||m||this._clippingActiveLastFrame){const t=[],i=[];let n=0;for(const e of h)this.isSourceForClippingOrConflation(e,b(e))&&(t.push(e),i.push(n)),n++;if(t&&(m||t.length>1)||this._clippingActiveLastFrame){m=!1;const n=[];for(let r=0;r<t.length;r++){const o=t[r],s=i[r],a=this.style.getLayerSourceCache(o);if(!a||!a.used||!a.getSource().usedInConflation&&"clip"!==o.type&&"building"!==o.type)continue;let l=e.eP,c=e.bZ.None;const u=[];let h=!0;if("building"===o.type)l=e.eR;else if("clip"===o.type){l=s;for(const t of o.layout.get("clip-layer-types"))c|="model"===t?e.bZ.Model:"symbol"===t?e.bZ.Symbol:e.bZ.FillExtrusion;for(const e of o.layout.get("clip-layer-scope"))u.push(e);o.isHidden(this.transform.zoom)?h=!1:m=!0}h&&n.push({layer:o.fqid,cache:a,order:l,clipMask:c,clipScope:u})}this.replacementSource.setSources(n),f=!0}}this._clippingActiveLastFrame=m,f||this.replacementSource.clear(),this.conflationActive=f,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let e=0;e<h.length;e++){const t=h[e],i=t.cutoffRange();if(this.longestCutoffRange=Math.max(i,this.longestCutoffRange),i>0){const e=b(t);e&&(this.minCutoffZoom=Math.max(e.minzoom,this.minCutoffZoom)),t.minzoom&&(this.minCutoffZoom=Math.max(t.minzoom,this.minCutoffZoom))}t.is3D(o)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=e),this._lastOcclusionLayer=e)}const T=this.style&&this.style.fog;T?(this._fogVisible=0!==T.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=T.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(y),this.opaquePassCutoff=0,a=s(),h=a.map((e=>r[e])));const w=this._shadowRenderer;if(w){w.updateShadowParameters(this.transform,this.style.directionalLight);for(const e in d)for(const t of g[e]){let e={min:0,max:0};this.terrain&&(e=this.terrain.getMinMaxForTile(t)||e),w.addShadowReceiver(t.toUnwrapped(),e.min,e.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new e.eQ(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Ns(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const E=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),S=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(E&&!this._snow&&(this._snow=new _a(this)),!E&&this._snow&&(this._snow.destroy(),delete this._snow),S&&!this._rain&&(this._rain=new ma(this)),!S&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),u){this.buildingTileBorderManager||(this.buildingTileBorderManager=new ks);const e=this.style.getLayerSourceCache(u);this.buildingTileBorderManager.updateBorders(e,u)}if(!G.has(this.context.gl))return;this.renderPass="offscreen";for(const e of h){const i=t.getLayerSourceCache(e);if(!e.hasOffscreenPass()||e.isHidden(this.transform.zoom))continue;const n=i?_[i.id]:void 0;("custom"===e.type||"raster"===e.type||"raster-particle"===e.type||e.isSky()||n&&n.length)&&this.renderLayer(this,i,e,n)}this.depthRangeFor3D=[0,1-(h.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,v)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const A="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),M=(()=>{if(i.showOverdrawInspector)return e.ao.black;const t=this.style.fog;if(t&&this.transform.projection.supportsFog){const i=this.style.getLut(t.scope);if(!A){const n="none"===t.properties.get("color-use-theme"),r=t.properties.get("color").toNonPremultipliedRenderColor(n?null:i).toArray01();return new e.ao(...r)}if(A){const n="none"===t.properties.get("space-color-use-theme"),r=t.properties.get("space-color").toNonPremultipliedRenderColor(n?null:i).toArray01();return new e.ao(...r)}}return e.ao.transparent})();if(this.context.clear({color:M,depth:1}),this.clearStencil(),this._showOverdrawInspector=i.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&A&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=a.length-1;this.currentLayer>=0;this.currentLayer--){const e=h[this.currentLayer],i=t.getLayerSourceCache(e);if(e.isSky())continue;const n=i?(e.is3D(o)?x:_)[i.id]:void 0;this._renderTileClippingMasks(e,i,n),this.renderLayer(this,i,e,n)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&A&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||e.aj(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<a.length;this.currentLayer++){const e=h[this.currentLayer],i=t.getLayerSourceCache(e);e.isSky()&&this.renderLayer(this,i,e,i?_[i.id]:void 0)}function I(e,t){let i;return t&&(i=("symbol"===e.type?y:e.is3D(o)?x:_)[t.id]),i}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<a.length;){const e=h[this.currentLayer];if("raster"===e.type||"raster-particle"===e.type){const i=t.getLayerSourceCache(e);this.renderLayer(this,i,e,I(e,i))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let C=0;w&&(C=w.getShadowCastingLayerCount());let P=!1,L=-1;for(let e=0;e<a.length;++e){const t=h[e];t.isHidden(this.transform.zoom)||t.is3D(o)&&(L=e)}c&&-1===L&&(l=!0);let R=!1;for(;this.currentLayer<a.length;){const e=h[this.currentLayer],i=t.getLayerSourceCache(e);if(e.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(e)){if(e.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!R&&e.is3D(o)&&!o){const e=this.currentLayer,t=e=>{for(this.currentLayer=0;this.currentLayer<h.length;this.currentLayer++){const t=h[this.currentLayer];if(xa[t.type]){const i=this.style.getLayerSourceCache(t);xa[t.type](this,i,t,I(t,i),e)}}};t("initialize"),t("reset"),this.currentLayer=e,R=!0}if(l&&!P&&this.terrain&&!this.transform.isOrthographic&&(P=!0,this.blitDepth()),c&&-1!==L&&this.currentLayer===L+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(e,i,i?g[i.id]:void 0),this.renderLayer(this,i,e,I(e,i)),!this.terrain&&w&&C>0&&e.hasShadowPass()&&0==--C){{this.clearStencil(),this.resetStencilClippingMasks();const e=this.currentLayer;for(this.currentLayer=0;this.currentLayer<h.length;this.currentLayer++){const e=h[this.currentLayer];if(ba[e.type]){const t=this.style.getLayerSourceCache(e);ba[e.type](this,t,e,I(e,t))}}this.currentLayer=e}if(w.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const e=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=e;this.currentLayer++){const e=h[this.currentLayer];if(!e.hasLightBeamPass())continue;const i=t.getLayerSourceCache(e);this.renderLayer(this,i,e,i?_[i.id]:void 0)}this.currentLayer=e,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const e=this.currentLayer;this.depthOcclusion=!0;for(const e of this.layersWithOcclusionOpacity){this.currentLayer=e;const i=h[this.currentLayer],n=t.getLayerSourceCache(i),r=n?_[n.id]:void 0;this.terrain||this._renderTileClippingMasks(i,n,n?g[n.id]:void 0),this.renderLayer(this,n,i,r)}this.depthOcclusion=!1,this.currentLayer=e,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let i=null;h.forEach((e=>{const n=t.getLayerSourceCache(e);n&&!e.isHidden(this.transform.zoom)&&n.getVisibleCoordinates().length&&(!i||i.getSource().maxzoom<n.getSource().maxzoom)&&(i=n)})),i&&this.options.showTileBoundaries&&ws(this,i,i.getVisibleCoordinates(),e.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&ws(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new e.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(e){const t=e.transform.padding;Ss(e,e.transform.height-(t.top||0),3,ys),Ss(e,t.bottom||0,3,vs),As(e,t.left||0,3,xs),As(e,e.transform.width-(t.right||0),3,bs);const i=e.transform.centerPoint;!function(e,t,i,n){Ms(e,t-1,i-10,2,20,n),Ms(e,t-10,i-1,20,2,n)}(e,i.x,e.transform.height-i.y,Ts)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),f||(this.conflationActive=!1)}prepareLayer(e){this.gpuTimingStart(e);const{unsupportedLayers:t}=this.transform.projection,i=!t||!t.includes(e.type);if(va[e.type]&&(i||this.terrain&&"custom"===e.type)){const t=this.style.getLayerSourceCache(e);va[e.type](e,t,this)}this.gpuTimingEnd()}renderLayer(e,t,i,n){i.isHidden(this.transform.zoom)||("background"===i.type||"sky"===i.type||"custom"===i.type||"model"===i.type||"raster"===i.type||"raster-particle"===i.type||n&&n.length)&&(this.id=i.id,this.gpuTimingStart(i),e.transform.projection.unsupportedLayers&&e.transform.projection.unsupportedLayers.includes(i.type)&&(!e.terrain||"custom"!==i.type)||"clip"===i.type||ya[i.type](e,t,i,n,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(e){if(!this.options.gpuTiming)return;const t=this.context.extTimerQuery,i=this.context.gl;let n=this.gpuTimers[e.id];n||(n=this.gpuTimers[e.id]={calls:0,cpuTime:0,query:i.createQuery()}),n.calls++,i.beginQuery(t.TIME_ELAPSED_EXT,n.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const e=this.context.extTimerQuery,t=this.context.gl,i=t.createQuery();this.deferredRenderGpuTimeQueries.push(i),t.beginQuery(e.TIME_ELAPSED_EXT,i)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const e=this.gpuTimers;return this.gpuTimers={},e}collectDeferredRenderGpuQueries(){const e=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],e}queryGpuTimers(e){const t={};for(const i in e){const n=e[i],r=this.context.extTimerQuery,o=r.getQueryParameter(n.query,this.context.gl.QUERY_RESULT)/1e6;r.deleteQueryEXT(n.query),t[i]=o}return t}queryGpuTimeDeferredRender(e){if(!this.options.gpuTimingDeferredRender)return 0;const t=this.context.gl;let i=0;for(const n of e)i+=t.getQueryParameter(n,t.QUERY_RESULT)/1e6,t.deleteQuery(n);return i}translatePosMatrix(t,i,n,r,o){if(!n[0]&&!n[1])return t;const s=o?"map"===r?this.transform.angle:0:"viewport"===r?-this.transform.angle:0;if(s){const e=Math.sin(s),t=Math.cos(s);n=[n[0]*t-n[1]*e,n[0]*e+n[1]*t]}const a=[o?n[0]:e.ay(i,n[0],this.transform.zoom),o?n[1]:e.ay(i,n[1],this.transform.zoom),0],l=new Float32Array(16);return e.bq(l,t,a),l}saveTileTexture(e){if(e.context!==this.context)return;const t=e.size[0],i=this._tileTextures[t];i?i.push(e):this._tileTextures[t]=[e]}getTileTexture(e){const t=this._tileTextures[e];return t&&t.length>0?t.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(e,t,i){const n=void 0===i?this.terrain&&this.terrain.renderingToTexture:i,r=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===e||"terrainRaster"===e?(r.push("LIGHTING_3D_MODE"),r.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):n||r.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||r.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(r.push("TERRAIN"),this.linearFloatFilteringSupported()&&r.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&r.push("GLOBE"),!this._fogVisible||n||void 0!==t&&!t||r.push("FOG","FOG_DITHERING"),n&&r.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&r.push("OVERDRAW_INSPECTOR"),r}getOrCreateProgram(e,t){this.cache=this.cache||{};const i=t&&t.defines||[],n=t&&t.config,r=this.currentGlobalDefines(e,t&&t.overrideFog,t&&t.overrideRtt).concat(i),o=eo.cacheKey(qn[e],e,r,n);return this.cache[o]||(this.cache[o]=new eo(this.context,e,qn[e],n,No[e],r)),this.cache[o]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new e.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,i){if(this.style.enable3dLights()){const n=this.style.directionalLight,r=this.style.ambientLight;if(n&&r){const o=((t,i,n)=>{const r=t.properties.get("direction"),o="none"===t.properties.get("color-use-theme"),s=t.properties.get("color").toNonPremultipliedRenderColor(o?null:n.getLut(t.scope)).toArray01(),a=t.properties.get("intensity"),l="none"===i.properties.get("color-use-theme"),c=i.properties.get("color").toNonPremultipliedRenderColor(l?null:n.getLut(i.scope)).toArray01(),u=i.properties.get("intensity"),h=[r.x,r.y,r.z],d=e.dM(c,u),p=e.dM(s,a);return{u_lighting_ambient_color:d,u_lighting_directional_dir:h,u_lighting_directional_color:p,u_ground_radiance:Jr(h,p,d)}})(n,r,this.style);i.setLightsUniformValues(t,o)}}}uploadCommonUniforms(t,i,n,r,o){if(this.uploadCommonLightUniforms(t,i),this.terrain&&this.terrain.renderingToTexture)return;const s=this.style.fog;if(s){const o=s.getOpacity(this.transform.pitch),a=((t,i,n,r,o,s,a,l,c,u,h,d)=>{const p=t.transform,f="none"===i.properties.get("color-use-theme"),m=i.properties.get("color").toNonPremultipliedRenderColor(f?null:t.style.getLut(i.scope)).toArray01();m[3]=r;const g=t.frameCounter/1e3%1,[_,y]=i.properties.get("vertical-range");return{u_fog_matrix:n?p.calculateFogTileMatrix(n):d||t.identityMat,u_fog_range:i.getFovAdjustedRange(p._fov),u_fog_color:m,u_fog_horizon_blend:i.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(_,y),y],u_fog_temporal_offset:g,u_frustum_tl:o,u_frustum_tr:s,u_frustum_br:a,u_frustum_bl:l,u_globe_pos:c,u_globe_radius:u,u_viewport:h,u_globe_transition:e.aj(p.zoom),u_is_globe:+("globe"===p.projection.name)}})(this,s,n,o,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*e.o.devicePixelRatio,this.transform.height*e.o.devicePixelRatio],r);i.setFogUniformValues(t,a)}o&&i.setCutoffUniformValues(t,o.uniformValues)}setTileLoadedFlag(e){this.tileLoaded=e}saveCanvasCopy(){const e=this.canvasCopy();e&&(this.frameCopies.push(e),this.tileLoaded=!1)}canvasCopy(){const e=this.context.gl,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,0,0,e.drawingBufferWidth,e.drawingBufferHeight,0),t}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const e=this.style&&this.style.fog;return!!e&&0!==e.getOpacity(this.transform.pitch)}getBackgroundTiles(){const e=this._backgroundTiles,t=this._backgroundTiles={},i=this.transform.coveringTiles({tileSize:512});for(const n of i)t[n.key]=e[n.key]||new Ct(n,512,this.transform.tileZoom,this,void 0,this.worldview);return t}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(e,t){return!(!e.is3D(!(!this.terrain||!this.terrain.enabled))||"clip"!==e.type&&"building"!==e.type&&(e.minzoom&&e.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==e.sourceLayer&&"procedural_buildings"!==e.sourceLayer)&&(!t||"batched-model"!==t.type)))}isTileAffectedByFog(e){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let t=this._cachedTileFogOpacities[e.key];return t||(this._cachedTileFogOpacities[e.key]=t=this.style.fog.getOpacityForTile(e)),t[0]>=Ve||t[1]>=Ve}setupDepthForOcclusion(e,t,i){const n=this.context,r=n.gl,o=!!i;var s;i||(i={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),n.activeTexture.set(r.TEXTURE3),e&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(r.NEAREST,r.CLAMP_TO_EDGE),i.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],i.u_depth_range_unpack=[2/((s=this.depthRangeFor3D)[1]-s[0]),-1-2*s[0]/(s[1]-s[0])],i.u_occluder_half_size=.5*this.occlusionParams.occluderSize,i.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(r.NEAREST,r.CLAMP_TO_EDGE),n.activeTexture.set(r.TEXTURE0),o||t.setTerrainUniformValues(n,i)}}function wa(e,t){let i=!1,n=null;const r=()=>{n=null,i&&(e(),n=setTimeout(r,t),i=!1)};return()=>(i=!0,n||r(),n)}class Ea{constructor(t){this._hashName=t&&encodeURIComponent(t),e.aX(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=wa(this._updateHashUnthrottled.bind(this),300)}addTo(e){return this._map=e,window.addEventListener("hashchange",this._onHashChange,!1),e.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const e=this._map;if(!e)return"";const t=Sa(e);if(this._hashName){const e=this._hashName;let i=!1;const n=location.hash.slice(1).split("&").map((n=>{const r=n.split("=")[0];return r===e?(i=!0,`${r}=${t}`):n})).filter((e=>e));return i||n.push(`${e}=${t}`),`#${n.join("&")}`}return`#${t}`}_getCurrentHash(){const e=location.hash.replace("#","");if(this._hashName){let t;return e.split("&").map((e=>e.split("="))).forEach((e=>{e[0]===this._hashName&&(t=e)})),(t&&t[1]||"").split("/")}return e.split("/")}_onHashChange(){const e=this._map;if(!e)return!1;const t=this._getCurrentHash();if(t.length>=3&&!t.some((e=>isNaN(Number(e))))){const i=e.dragRotate.isEnabled()&&e.touchZoomRotate.isEnabled()?+(t[3]||0):e.getBearing();return e.jumpTo({center:[+t[2],+t[1]],zoom:+t[0],bearing:i,pitch:+(t[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Sa(e,t){const i=e.getCenter(),n=Math.round(100*e.getZoom())/100,r=Math.ceil((n*Math.LN2+Math.log(512/360/.5))/Math.LN10),o=Math.pow(10,r),s=Math.round(i.lng*o)/o,a=Math.round(i.lat*o)/o,l=e.getBearing(),c=e.getPitch();let u=t?`/${s}/${a}/${n}`:`${n}/${a}/${s}`;return(l||c)&&(u+="/"+Math.round(10*l)/10),c&&(u+=`/${Math.round(c)}`),u}const Aa={linearity:.3,easing:e.eS(0,0,.3,1)},Ma=Object.assign({deceleration:2500,maxSpeed:1400},Aa),Ia=Object.assign({deceleration:20,maxSpeed:1400},Aa),Ca=Object.assign({deceleration:1e3,maxSpeed:360},Aa),Pa=Object.assign({deceleration:1e3,maxSpeed:90},Aa);class La{constructor(e){this._map=e,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:e.o.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,i=e.o.now();for(;t.length>0&&i-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const i={zoom:0,bearing:0,pitch:0,pan:new e.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:e}of this._inertiaBuffer)i.zoom+=e.zoomDelta||0,i.bearing+=e.bearingDelta||0,i.pitch+=e.pitchDelta||0,e.panDelta&&i.pan._add(e.panDelta),e.around&&(i.around=e.around),e.pinchAround&&(i.pinchAround=e.pinchAround);const n=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,r={};if(i.pan.mag()){const e=Oa(i.pan.mag(),n,Object.assign({},Ma,t||{}));r.offset=i.pan.mult(e.amount/i.pan.mag()),r.center=this._map.transform.center,Ra(r,e)}if(i.zoom){const e=Oa(i.zoom,n,Ia);r.zoom=this._map.transform.zoom+e.amount,Ra(r,e)}if(i.bearing){const t=Oa(i.bearing,n,Ca);r.bearing=this._map.transform.bearing+e.aA(t.amount,-179,179),Ra(r,t)}if(i.pitch){const e=Oa(i.pitch,n,Pa);r.pitch=this._map.transform.pitch+e.amount,Ra(r,e)}if(r.zoom||r.bearing){const e=void 0===i.pinchAround?i.around:i.pinchAround;r.around=e?this._map.unproject(e):this._map.getCenter()}return this.clear(),r.noMoveStart=!0,r}}function Ra(e,t){(!e.duration||e.duration<t.duration)&&(e.duration=t.duration,e.easing=t.easing)}function Oa(t,i,n){const{maxSpeed:r,linearity:o,deceleration:s}=n,a=e.aA(t*o/(i/1e3),-r,r),l=Math.abs(a)/(s*o);return{easing:n.easing,duration:1e3*l,amount:a*(l/2)}}class Da extends e.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,t,i,n={}){const r=_(t.getCanvasContainer(),i),o=t.unproject(r);super(e,Object.assign({point:r,lngLat:o,originalEvent:i},n)),this._defaultPrevented=!1,this.target=t}}class Ba extends e.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,i,n){const r="touchend"===t?n.changedTouches:n.touches,o=y(i.getCanvasContainer(),r),s=o.map((e=>i.unproject(e))),a=o.reduce(((e,t,i,n)=>e.add(t.div(n.length))),new e.P(0,0));super(t,{points:o,point:a,lngLats:s,lngLat:i.unproject(a),originalEvent:n}),this._defaultPrevented=!1}}class Fa extends e.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,t){super("wheel",{originalEvent:t}),this._defaultPrevented=!1}}class Na{constructor(e,t){this._map=e,this._clickTolerance=t.clickTolerance}reset(){this._mousedownPos=void 0}wheel(e){return this._firePreventable(new Fa(this._map,e))}mousedown(e,t){return this._mousedownPos=t,this._firePreventable(new Da(e.type,this._map,e))}mouseup(e){this._map.fire(new Da(e.type,this._map,e))}preclick(e){const t=new MouseEvent("preclick",e);this._map.fire(new Da(t.type,this._map,t))}click(e,t){this._mousedownPos&&this._mousedownPos.dist(t)>=this._clickTolerance||(this.preclick(e),this._map.fire(new Da(e.type,this._map,e)))}dblclick(e){return this._firePreventable(new Da(e.type,this._map,e))}mouseover(e){this._map.fire(new Da(e.type,this._map,e))}mouseout(e){this._map.fire(new Da(e.type,this._map,e))}touchstart(e){return this._firePreventable(new Ba(e.type,this._map,e))}touchmove(e){this._map.fire(new Ba(e.type,this._map,e))}touchend(e){this._map.fire(new Ba(e.type,this._map,e))}touchcancel(e){this._map.fire(new Ba(e.type,this._map,e))}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ka{constructor(e){this._map=e}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(e){this._map.fire(new Da(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Da("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._map.fire(new Da(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Ua{constructor(e,t){this._map=e,this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=t.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,t){this.isEnabled()&&e.shiftKey&&0===e.button&&(p(),this._startPos=this._lastPos=t,this._active=!0)}mousemoveWindow(e,t){if(!this._active)return;const i=t,n=this._startPos,r=this._lastPos;if(!n||!r||r.equals(i)||!this._box&&i.dist(n)<this._clickTolerance)return;this._lastPos=i,this._box||(this._box=l("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",e));const o=Math.min(n.x,i.x),s=Math.max(n.x,i.x),a=Math.min(n.y,i.y),c=Math.max(n.y,i.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${o}px,${a}px)`,this._box.style.width=s-o+"px",this._box.style.height=c-a+"px")}))}mouseupWindow(t,i){if(!this._active)return;const n=this._startPos,r=i;if(n&&0===t.button){if(this.reset(),g(),n.x!==r.x||n.y!==r.y)return this._map.fire(new e.z("boxzoomend",{originalEvent:t})),{cameraAnimation:e=>e.fitScreenCoordinates(n,r,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(e){this._active&&27===e.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",e))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),f(),delete this._startPos,delete this._lastPos}_fireEvent(t,i){return this._map.fire(new e.z(t,{originalEvent:i}))}}function za(e,t){const i={};for(let n=0;n<e.length;n++)i[e[n].identifier]=t[n];return i}class Va{constructor(e){this.reset(),this.numTouches=e.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,i,n){(this.centroid||n.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=t.timeStamp),n.length===this.numTouches&&(this.centroid=function(t){const i=new e.P(0,0);for(const e of t)i._add(e);return i.div(t.length)}(i),this.touches=za(n,i)))}touchmove(e,t,i){if(this.aborted||!this.centroid)return;const n=za(i,t);for(const e in this.touches){const t=n[e];(!t||t.dist(this.touches[e])>30)&&(this.aborted=!0)}}touchend(e,t,i){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),0===i.length){const e=!this.aborted&&this.centroid;if(this.reset(),e)return e}}}class Ga{constructor(e){this.singleTap=new Va(e),this.numTaps=e.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(e,t,i){this.singleTap.touchstart(e,t,i)}touchmove(e,t,i){this.singleTap.touchmove(e,t,i)}touchend(e,t,i){const n=this.singleTap.touchend(e,t,i);if(n){const t=e.timeStamp-this.lastTime<500,i=!this.lastTap||this.lastTap.dist(n)<30;if(t&&i||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=n,this.count===this.numTaps)return this.reset(),n}}}class ja{constructor(){this._zoomIn=new Ga({numTouches:1,numTaps:2}),this._zoomOut=new Ga({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,t,i){this._zoomIn.touchstart(e,t,i),this._zoomOut.touchstart(e,t,i)}touchmove(e,t,i){this._zoomIn.touchmove(e,t,i),this._zoomOut.touchmove(e,t,i)}touchend(e,t,i){const n=this._zoomIn.touchend(e,t,i),r=this._zoomOut.touchend(e,t,i);return n?(this._active=!0,e.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:t=>t.easeTo({duration:300,zoom:t.getZoom()+1,around:t.unproject(n)},{originalEvent:e})}):r?(this._active=!0,e.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:t=>t.easeTo({duration:300,zoom:t.getZoom()-1,around:t.unproject(r)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const Ha={0:1,2:2},$a={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Wa{constructor(e){this.reset(),this._clickTolerance=e.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(e,t){return!1}_move(e,t){return{}}mousedown(e,t){if(this._lastPoint)return;const i=v(e);this._correctButton(e,i)&&(this._lastPoint=t,this._eventButton=i)}mousemoveWindow(e,t){const i=this._lastPoint;if(i)if(e.preventDefault(),null!=this._eventButton&&function(e,t){const i=Ha[t];return void 0===e.buttons||(e.buttons&i)!==i}(e,this._eventButton))this.reset();else if(this._moved||!(t.dist(i)<this._clickTolerance))return this._moved=!0,this._lastPoint=t,this._move(i,t)}mouseupWindow(e){this._lastPoint&&v(e)===this._eventButton&&(this._moved&&g(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class qa extends Wa{mousedown(e,t){super.mousedown(e,t),this._lastPoint&&(this._active=!0)}_correctButton(e,t){return 0===t&&!e.ctrlKey}_move(e,t){return{around:t,panDelta:t.sub(e)}}}class Xa extends Wa{constructor(e){super(e),this._pitchRotateKey=e.pitchRotateKey?$a[e.pitchRotateKey]:void 0}_correctButton(e,t){return this._pitchRotateKey?0===t&&e[this._pitchRotateKey]:0===t&&e.ctrlKey||2===t}_move(e,t){const i=.8*(t.x-e.x);if(i)return this._active=!0,{bearingDelta:i}}contextmenu(e){this._pitchRotateKey||e.preventDefault()}}class Ya extends Wa{constructor(e){super(e),this._pitchRotateKey=e.pitchRotateKey?$a[e.pitchRotateKey]:void 0}_correctButton(e,t){return this._pitchRotateKey?0===t&&e[this._pitchRotateKey]:0===t&&e.ctrlKey||2===t}_move(e,t){const i=-.5*(t.y-e.y);if(i)return this._active=!0,{pitchDelta:i}}contextmenu(e){this._pitchRotateKey||e.preventDefault()}}class Za{constructor(t,i){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=i.clickTolerance||1,this.reset(),e.aX(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new e.P(0,0)}touchstart(e,t,i){return this._calculateTransform(e,t,i)}touchmove(t,i,n){if(this._active&&!(n.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===n.length&&!e.eT())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,i,n)}}touchend(e,t,i){this._calculateTransform(e,t,i),this._active&&i.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,i,n){n.length>0&&(this._active=!0);const r=za(n,i),o=new e.P(0,0),s=new e.P(0,0);let a=0;for(const e in r){const t=r[e],i=this._touches[e];i&&(o._add(t),s._add(t.sub(i)),a++,r[e]=t)}if(this._touches=r,a<this._minTouches||!s.mag())return;const l=s.div(a);return this._sum._add(l),this._sum.mag()<this._clickTolerance?void 0:{around:o.div(a),panDelta:l}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class Ja{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(e){}_move(e,t,i){return{}}touchstart(e,t,i){this._firstTwoTouches||i.length<2||(this._firstTwoTouches=[i[0].identifier,i[1].identifier],this._start([t[0],t[1]]))}touchmove(e,t,i){const n=this._firstTwoTouches;if(!n)return;e.preventDefault();const[r,o]=n,s=Ka(i,t,r),a=Ka(i,t,o);if(!s||!a)return;const l=this._aroundCenter?null:s.add(a).div(2);return this._move([s,a],l,e)}touchend(e,t,i){if(!this._firstTwoTouches)return;const[n,r]=this._firstTwoTouches,o=Ka(i,t,n),s=Ka(i,t,r);o&&s||(this._active&&g(),this.reset())}touchcancel(){this.reset()}enable(e){this._enabled=!0,this._aroundCenter=!!e&&"center"===e.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Ka(e,t,i){for(let n=0;n<e.length;n++)if(e[n].identifier===i)return t[n]}function Qa(e,t){return Math.log2(e/t)}class el extends Ja{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(e){this._startDistance=this._distance=e[0].dist(e[1])}_move(e,t){const i=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(Qa(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Qa(this._distance,i),pinchAround:t}}}function tl(e,t){return 180*e.angleWith(t)/Math.PI}class il extends Ja{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1])}_move(e,t){const i=this._vector;if(this._vector=e[0].sub(e[1]),i&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:tl(this._vector,i),pinchAround:t}}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const t=25/(Math.PI*this._minDiameter)*360,i=this._startVector;if(!i)return!1;const n=tl(e,i);return Math.abs(n)<t}}function nl(e){return Math.abs(e.y)>Math.abs(e.x)}class rl extends Ja{constructor(e){super(),this._map=e}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(e){this._lastPoints=e,nl(e[0].sub(e[1]))&&(this._valid=!1)}_move(t,i,n){const r=this._lastPoints;if(!r)return;const o=t[0].sub(r[0]),s=t[1].sub(r[1]);return this._map._cooperativeGestures&&!e.eT()&&n.touches.length<3||(this._valid=this.gestureBeginsVertically(o,s,n.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(o.y+s.y)/2*-.5})}gestureBeginsVertically(e,t,i){if(void 0!==this._valid)return this._valid;const n=e.mag()>=2,r=t.mag()>=2;if(!n&&!r)return;if(!n||!r)return null==this._firstMove&&(this._firstMove=i),i-this._firstMove<100&&void 0;const o=e.y>0==t.y>0;return nl(e)&&nl(t)&&o}}const ol={panStep:100,bearingStep:15,pitchStep:10};class sl{constructor(){const e=ol;this._panStep=e.panStep,this._bearingStep=e.bearingStep,this._pitchStep=e.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let t=0,i=0,n=0,r=0,o=0;switch(e.keyCode){case 61:case 107:case 171:case 187:t=1;break;case 189:case 109:case 173:t=-1;break;case 37:e.shiftKey?i=-1:(e.preventDefault(),r=-1);break;case 39:e.shiftKey?i=1:(e.preventDefault(),r=1);break;case 38:e.shiftKey?n=1:(e.preventDefault(),o=-1);break;case 40:e.shiftKey?n=-1:(e.preventDefault(),o=1);break;default:return}return this._rotationDisabled&&(i=0,n=0),{cameraAnimation:s=>{const a=s.getZoom();s.easeTo({duration:300,easeId:"keyboardHandler",easing:al,zoom:t?Math.round(a)+t*(e.shiftKey?2:1):a,bearing:s.getBearing()+i*this._bearingStep,pitch:s.getPitch()+n*this._pitchStep,offset:[-r*this._panStep,-o*this._panStep],center:s.getCenter()},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function al(e){return e*(2-e)}const ll=4.000244140625,cl=1/450;class ul{constructor(t,i){this._map=t,this._el=t.getCanvasContainer(),this._handler=i,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=cl,e.aX(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(e){this._defaultZoomRate=e}setWheelZoomRate(e){this._wheelZoomRate=e}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&"center"===e.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||e.eT()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let i=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const n=e.o.now(),r=n-(this._lastWheelEventTime||0);this._lastWheelEventTime=n,0!==i&&i%ll==0?this._type="wheel":0!==i&&Math.abs(i)<4?this._type="trackpad":r>400?(this._type=null,this._lastValue=i,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(r*i)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,i+=this._lastValue)),t.shiftKey&&i&&(i/=4),this._type&&(this._lastWheelEvent=t,this._delta-=i,this._active||this._start(t)),t.preventDefault()}_onTimeout(e){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(e)}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const t=_(this._el,e);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:t,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const t=this._map.transform;"wheel"===this._type&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(0!==this._delta){const e="wheel"===this._type&&Math.abs(this._delta)>ll?this._wheelZoomRate:this._defaultZoomRate;let n=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==n&&(n=1/n);const r=i(),o=Math.pow(2,r),s="number"==typeof this._targetZoom?t.zoomScale(this._targetZoom):o;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(s*n))),"wheel"===this._type&&(this._startZoom=r,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const n="number"==typeof this._targetZoom?this._targetZoom:i(),r=this._startZoom,o=this._easing;let s,a=!1;if("wheel"===this._type&&r&&o){const t=Math.min((e.o.now()-this._lastWheelEventTime)/200,1),i=o(t);s=e.ak(r,n,i),t<1?this._frameId||(this._frameId=!0):a=!0}else s=n,a=!0;this._active=!0,a&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let l=s-i();return l*this._lastDelta<0&&(l=0),{noInertia:!0,needsRenderFrame:!a,zoomDelta:l,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let i=e.eU;if(this._prevEase){const t=this._prevEase,n=(e.o.now()-t.start)/t.duration,r=t.easing(n+.01)-t.easing(n),o=.27/Math.sqrt(r*r+1e-4)*.01,s=Math.sqrt(.0729-o*o);i=e.eS(o,s,.25,1)}return this._prevEase={start:e.o.now(),duration:t,easing:i},i}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class hl{constructor(e,t){this._clickZoom=e,this._tapZoom=t}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class dl{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(e,t){return e.preventDefault(),{cameraAnimation:i=>{i.easeTo({duration:300,zoom:i.getZoom()+(e.shiftKey?-1:1),around:i.unproject(t)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class pl{constructor(){this._tap=new Ga({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(e,t,i){this._swipePoint||(this._tapTime&&e.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?i.length>0&&(this._swipePoint=t[0],this._swipeTouch=i[0].identifier):this._tap.touchstart(e,t,i))}touchmove(e,t,i){if(this._tapTime){if(this._swipePoint){if(i[0].identifier!==this._swipeTouch)return;const n=t[0],r=n.y-this._swipePoint.y;return this._swipePoint=n,e.preventDefault(),this._active=!0,{zoomDelta:r/128}}}else this._tap.touchmove(e,t,i)}touchend(e,t,i){this._tapTime?this._swipePoint&&0===i.length&&this.reset():this._tap.touchend(e,t,i)&&(this._tapTime=e.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class fl{constructor(e,t,i){this._el=e,this._mousePan=t,this._touchPan=i}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class ml{constructor(e,t,i){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=t,this._mousePitch=i}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class gl{constructor(e,t,i,n){this._el=e,this._touchZoom=t,this._touchRotate=i,this._tapDragZoom=n,this._rotationDisabled=!1,this._enabled=!0}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const _l=e=>e.zoom||e.drag||e.pitch||e.rotate;class yl extends e.z{}class vl{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,i){const n=e.av([],i,t);this.radius=e.ag(n[2]<0?e.eW([],n,this.constants):[n[0],n[1],0])}projectRay(t){e.eW(t,t,this.constants),e.aw(t,t),e.eX(t,t,this.constants);const i=e.c4([],t,this.radius);if(i[2]>0){const t=e.c4([],[0,0,1],e.bI(i,[0,0,1])),n=e.c4([],e.aw([],[i[0],i[1],0]),this.radius),r=e.d7([],i,e.c4([],e.av([],e.d7([],n,t),i),2));i[0]=r[0],i[1]=r[1]}return i}}function xl(e){return e.panDelta&&e.panDelta.mag()||e.zoomDelta||e.bearingDelta||e.pitchDelta}class bl{constructor(t,i){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new La(t),this._bearingSnap=i.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new vl,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(i),e.aX(["handleEvent","handleWindowEvent"],this);const n=this._el;this._listeners=[[n,"touchstart",{passive:!0}],[n,"touchmove",{passive:!1}],[n,"touchend",void 0],[n,"touchcancel",void 0],[n,"mousedown",void 0],[n,"mousemove",void 0],[n,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[n,"mouseover",void 0],[n,"mouseout",void 0],[n,"dblclick",void 0],[n,"click",void 0],[n,"keydown",{capture:!1}],[n,"keyup",void 0],[n,"wheel",{passive:!1}],[n,"contextmenu",void 0],[window,"blur",void 0]];for(const[e,t,i]of this._listeners){const n=e===document?this.handleWindowEvent:this.handleEvent;e.addEventListener(t,n,i)}}destroy(){for(const[e,t,i]of this._listeners){const n=e===document?this.handleWindowEvent:this.handleEvent;e.removeEventListener(t,n,i)}}_addDefaultHandlers(e){const t=this._map,i=t.getCanvasContainer();this._add("mapEvent",new Na(t,e));const n=t.boxZoom=new Ua(t,e);this._add("boxZoom",n);const r=new ja,o=new dl;t.doubleClickZoom=new hl(o,r),this._add("tapZoom",r),this._add("clickZoom",o);const s=new pl;this._add("tapDragZoom",s);const a=t.touchPitch=new rl(t);this._add("touchPitch",a);const l=new Xa(e),c=new Ya(e);t.dragRotate=new ml(e,l,c),this._add("mouseRotate",l,["mousePitch"]),this._add("mousePitch",c,["mouseRotate"]);const u=new qa(e),h=new Za(t,e);t.dragPan=new fl(i,u,h),this._add("mousePan",u),this._add("touchPan",h,["touchZoom","touchRotate"]);const d=new il,p=new el;t.touchZoomRotate=new gl(i,p,d,s),this._add("touchRotate",d,["touchPan","touchZoom"]),this._add("touchZoom",p,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ka(t));const f=t.scrollZoom=new ul(t,this);this._add("scrollZoom",f,["mousePan"]);const m=t.keyboard=new sl;this._add("keyboard",m);for(const i of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])e.interactive&&e[i]&&t[i].enable(e[i])}_add(e,t,i){this._handlers.push({handlerName:e,handler:t,allowed:i}),this._handlersById[e]=t}stop(e){if(!this._updatingCamera){for(const{handler:e}of this._handlers)e.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!_l(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(e,t,i){for(const n in e)if(n!==i&&(!t||t.indexOf(n)<0))return!0;return!1}handleWindowEvent(e){this.handleEvent(e,`${e.type}Window`)}_getMapTouches(e){const t=[];for(const i of e)this._el.contains(i.target)&&t.push(i);return t}handleEvent(e,t){this._updatingCamera=!0;const i="renderFrame"===e.type,n=i?void 0:e,r={needsRenderFrame:!1},o={},s={},a=e.touches?this._getMapTouches(e.touches):void 0,l=a?y(this._el,a):i?void 0:_(this._el,e);for(const{handlerName:i,handler:c,allowed:u}of this._handlers){if(!c.isEnabled())continue;let h;this._blockedByActive(s,u,i)?c.reset():c[t||e.type]&&(h=c[t||e.type](e,l,a),this.mergeHandlerResult(r,o,h,i,n),h&&h.needsRenderFrame&&this._triggerRenderFrame()),(h||c.isActive())&&(s[i]=c)}const c={};for(const e in this._previousActiveHandlers)s[e]||(c[e]=n);this._previousActiveHandlers=s,(Object.keys(c).length||xl(r))&&(this._changes.push([r,o,c]),this._triggerRenderFrame()),(Object.keys(s).length||xl(r))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:u}=r;u&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],u(this._map))}mergeHandlerResult(e,t,i,n,r){if(!i)return;Object.assign(e,i);const o={handlerName:n,originalEvent:i.originalEvent||r};void 0!==i.zoomDelta&&(t.zoom=o),void 0!==i.panDelta&&(t.drag=o),void 0!==i.pitchDelta&&(t.pitch=o),void 0!==i.bearingDelta&&(t.rotate=o)}_applyChanges(){const t={},i={},n={};for(const[r,o,s]of this._changes)r.panDelta&&(t.panDelta=(t.panDelta||new e.P(0,0))._add(r.panDelta)),r.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+r.zoomDelta),r.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+r.bearingDelta),r.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+r.pitchDelta),void 0!==r.around&&(t.around=r.around),void 0!==r.aroundCoord&&(t.aroundCoord=r.aroundCoord),void 0!==r.pinchAround&&(t.pinchAround=r.pinchAround),r.noInertia&&(t.noInertia=r.noInertia),Object.assign(i,o),Object.assign(n,s);this._updateMapTransform(t,i,n),this._changes=[]}_updateMapTransform(t,i,n){const r=this._map,o=r.transform,s=e=>[e.x,e.y,e.z];if((()=>{const e=this._eventsInProgress.drag;return e&&!this._handlersById[e.handlerName].isActive()})()&&!xl(t)){const e=o.zoom;o.cameraElevationReference="sea",null!=this._originalZoom&&o._orthographicProjectionAtLowPitch&&"globe"!==o.projection.name&&0===o.pitch?(o.cameraElevationReference="ground",o.zoom=this._originalZoom):(o.recenterOnTerrain(),o.cameraElevationReference="ground"),e!==o.zoom&&this._map._update(!0)}if(o._isCameraConstrained&&r._stop(!0),!xl(t))return void this._fireEvents(i,n,!0);let{panDelta:a,zoomDelta:l,bearingDelta:c,pitchDelta:u,around:h,aroundCoord:d,pinchAround:p}=t;o._isCameraConstrained&&(l>0&&(l=0),o._isCameraConstrained=!1),void 0!==p&&(h=p),(l||(e=>i[e]&&!this._eventsInProgress[e])("drag"))&&h&&(this._dragOrigin=s(o.pointCoordinate3D(h)),this._originalZoom=o.zoom,this._trackingEllipsoid.setup(o._camera.position,this._dragOrigin)),o.cameraElevationReference="sea",r._stop(!0),h=h||r.transform.centerPoint,c&&(o.bearing+=c),u&&(o.pitch+=u),o._updateCameraState();const f=[0,0,0];if(a)if("mercator"===o.projection.name){const e=this._trackingEllipsoid.projectRay(o.screenPointToMercatorRay(h).dir),t=this._trackingEllipsoid.projectRay(o.screenPointToMercatorRay(h.sub(a)).dir);f[0]=t[0]-e[0],f[1]=t[1]-e[1]}else{const t=o.pointCoordinate(h);if("globe"===o.projection.name){a=a.rotate(-o.angle);const i=o._pixelsPerMercatorPixel/o.worldSize;f[0]=-a.x*e.eV(e.a_(t.y))*i,f[1]=-a.y*e.eV(o.center.lat)*i}else{const e=o.pointCoordinate(h.sub(a));t&&e&&(f[0]=e.x-t.x,f[1]=e.y-t.y)}}const m=o.zoom,g=[0,0,0];if(l){const t=s(d||o.pointCoordinate3D(h)),i={dir:e.aw([],e.av([],t,o._camera.position))};if(i.dir[2]<0){const n=o.zoomDeltaToMovement(t,l);e.c4(g,i.dir,n)}}const _=e.d7(f,f,g);o._translateCameraConstrained(_),l&&Math.abs(o.zoom-m)>1e-4&&o.recenterOnTerrain(),o.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(i,n,!0)}_fireEvents(t,i,n){const r=_l(this._eventsInProgress),o=_l(t),s={};for(const e in t){const{originalEvent:i}=t[e];this._eventsInProgress[e]||(s[`${e}start`]=i),this._eventsInProgress[e]=t[e]}!r&&o&&this._fireEvent("movestart",o.originalEvent);for(const e in s)this._fireEvent(e,s[e]);o&&this._fireEvent("move",o.originalEvent);for(const e in t){const{originalEvent:i}=t[e];this._fireEvent(e,i)}const a={};let l;for(const e in this._eventsInProgress){const{handlerName:t,originalEvent:n}=this._eventsInProgress[e];this._handlersById[t].isActive()||(delete this._eventsInProgress[e],l=i[t]||n,a[`${e}end`]=l)}for(const e in a)this._fireEvent(e,a[e]);const c=_l(this._eventsInProgress);if(n&&(r||o)&&!c){this._updatingCamera=!0;const t=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=e=>0!==e&&-this._bearingSnap<e&&e<this._bearingSnap;t?(i(t.bearing||this._map.getBearing())&&(t.bearing=0),this._map.easeTo(t,{originalEvent:l})):(this._map.fire(new e.z("moveend",{originalEvent:l})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,i){this._map.fire(new e.z(t,i?{originalEvent:i}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((e=>{this._frameId=void 0,this.handleEvent(new yl("renderFrame",{timeStamp:e})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Tl="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class wl extends e.E{constructor(t,i){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=i.bearingSnap,this._respectPrefersReducedMotion=!1!==i.respectPrefersReducedMotion,e.aX(["_renderFrameCallback"],this)}getCenter(){return new e.aS(this.transform.center.lng,this.transform.center.lat)}setCenter(e,t){return this.jumpTo({center:e},t)}panBy(t,i,n){return t=e.P.convert(t).mult(-1),this.panTo(this.transform.center,Object.assign({offset:t},i),n)}panTo(e,t,i){return this.easeTo(Object.assign({center:e},t),i)}getZoom(){return this.transform.zoom}setZoom(e,t){return this.jumpTo({zoom:e},t),this}zoomTo(e,t,i){return this.easeTo(Object.assign({zoom:e},t),i)}zoomIn(e,t){return this.zoomTo(this.getZoom()+1,e,t),this}zoomOut(e,t){return this.zoomTo(this.getZoom()-1,e,t),this}getBearing(){return this.transform.bearing}setBearing(e,t){return this.jumpTo({bearing:e},t),this}getPadding(){return this.transform.padding}setPadding(e,t){return this.jumpTo({padding:e},t),this}rotateTo(e,t,i){return this.easeTo(Object.assign({bearing:e},t),i)}resetNorth(e,t){return this.rotateTo(0,Object.assign({duration:1e3},e),t),this}resetNorthPitch(e,t){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},e),t),this}snapToNorth(e,t){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,t):this}getPitch(){return this.transform.pitch}setPitch(e,t){return this.jumpTo({pitch:e},t),this}cameraForBounds(t,i){t=e.aI.convert(t);const n=i&&i.bearing||0,r=i&&i.pitch||0,o=t.getNorthWest(),s=t.getSouthEast();return this._cameraForBounds(this.transform,o,s,n,r,i)}_extendPadding(e){const t={top:0,right:0,bottom:0,left:0};return null==e?Object.assign({},t,this.transform.padding):"number"==typeof e?{top:e,bottom:e,right:e,left:e}:Object.assign({},t,e)}_extendCameraOptions(e){return(e=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},e)).padding=this._extendPadding(e.padding),e}_minimumAABBFrustumDistance(e,t){const i=t.max[0]-t.min[0],n=t.max[1]-t.min[1];return i/n>e.aspect?i/(2*Math.tan(.5*e.fovX)*e.aspect):n/(2*Math.tan(.5*e.fovY)*e.aspect)}_cameraForBoundsOnGlobe(t,i,n,r,o,s){const a=t.clone(),l=this._extendCameraOptions(s);a.bearing=r,a.pitch=o;const c=e.aS.convert(i),u=e.aS.convert(n),h=.5*(c.lat+u.lat),d=.5*(c.lng+u.lng),p=e.eY(h,d),f=e.aw([],p),m=e.aw([],e.bH([],f,[0,1,0])),g=e.bH([],m,f),_=[m[0],m[1],m[2],0,g[0],g[1],g[2],0,f[0],f[1],f[2],0,0,0,0,1],y=[p,e.eY(c.lat,c.lng),e.eY(u.lat,c.lng),e.eY(u.lat,u.lng),e.eY(c.lat,u.lng),e.eY(h,c.lng),e.eY(h,u.lng),e.eY(c.lat,d),e.eY(u.lat,d)];let v=e.d8.fromPoints(y.map((t=>[e.bI(m,t),e.bI(g,t),e.bI(f,t)])));const x=e.af([],v.center,_);0===e.eZ(x)&&e.e_(x,0,0,1),e.aw(x,x),e.c4(x,x,e.aD),a.center=e.e$(x);const b=a.getWorldToCameraMatrix(),T=e.bk(new Float64Array(16),b);v=e.d8.applyTransform(v,e.aB([],b,_));const w=this._extendAABB(v,a,l,r);if(!w)return void e.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");v=w,e.af(x,x,b);const E=.5*(v.max[2]-v.min[2]),S=this._minimumAABBFrustumDistance(a,v),A=e.c4([],[0,0,1],E),M=e.d7(A,x,A),I=S+(0===a.pitch?0:e.bF(x,M)),C=a.globeCenterInViewSpace,P=e.av([],x,[C[0],C[1],C[2]]);e.aw(P,P),e.c4(P,P,I);const L=e.d7([],x,P);e.af(L,L,T);const R=e.eL/e.aD,O=e.ag(L),D=e.ce(Math.max(O*R-e.eL,Number.EPSILON),0),B=Math.min(a.zoomFromMercatorZAdjusted(D),l.maxZoom);return B>.5*(e.cZ+e.cK)?(a.setProjection({name:"mercator"}),a.zoom=B,this._cameraForBounds(a,i,n,r,o,s)):{center:a.center,zoom:B,bearing:r,pitch:o}}_extendAABB(t,i,n,r){const o=.5*((n.padding.left||0)+(n.padding.right||0)),s=.5*((n.padding.top||0)+(n.padding.bottom||0)),a=s,l=o,c=o,u=s,h=i.width-(l+c),d=i.height-(a+u),p=e.av([],t.max,t.min),f=Math.min(h/p[0],d/p[1]),m=Math.min(i.scaleZoom(i.scale*f),n.maxZoom);if(isNaN(m))return null;const g=i.scale/i.zoomScale(m),_=new e.d8([t.min[0]-l*g,t.min[1]-u*g,t.min[2]],[t.max[0]+c*g,t.max[1]+a*g,t.max[2]]),y=("number"==typeof n.offset.x&&"number"==typeof n.offset.y?new e.P(n.offset.x,n.offset.y):e.P.convert(n.offset)).rotate(-e.an(r));return _.center[0]-=y.x*g,_.center[1]+=y.y*g,_}queryTerrainElevation(t,i){const n=this.transform.elevation;return n?(i=Object.assign({},{exaggerated:!0},i),n.getAtPoint(e.ae.fromLngLat(t),null,i.exaggerated)):null}_cameraForBounds(t,i,n,r,o,s){if("globe"===t.projection.name)return this._cameraForBoundsOnGlobe(t,i,n,r,o,s);const a=t.clone(),l=this._extendCameraOptions(s);a.bearing=r,a.pitch=o;const c=e.aS.convert(i),u=e.aS.convert(n),h=new e.aS(c.lng,u.lat),d=new e.aS(u.lng,c.lat),p=a.project(c),f=a.project(u),m=this.queryTerrainElevation(c),g=this.queryTerrainElevation(u),_=this.queryTerrainElevation(h),y=this.queryTerrainElevation(d),v=[[p.x,p.y,Math.min(m||0,g||0,_||0,y||0)],[f.x,f.y,Math.max(m||0,g||0,_||0,y||0)]];let x=e.d8.fromPoints(v);const b=a.getWorldToCameraMatrix(),T=e.bk(new Float64Array(16),b);x=e.d8.applyTransform(x,b);const w=this._extendAABB(x,a,l,r);if(!w)return void e.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");x=w;const E=.5*e.av([],x.max,x.min)[2],S=this._minimumAABBFrustumDistance(a,x),A=[0,0,1,0];e.aC(A,A,b),e.f0(A,A);const M=e.c4([],A,S+E),I=e.d7([],x.center,M);e.af(x.center,x.center,T),e.af(I,I,T);const C=a.unproject(new e.P(x.center[0],x.center[1])),P=e.f1(a.projection,C),L=Math.pow(2,P),R=Math.min(a._zoomFromMercatorZ(I[2]*a.pixelsPerMeter*L/a.worldSize),l.maxZoom);return a.mercatorFromTransition&&R<.5*(e.cZ+e.cK)?(a.setProjection({name:"globe"}),a.zoom=R,this._cameraForBounds(a,i,n,r,o,s)):{center:C,zoom:R,bearing:r,pitch:o}}fitBounds(e,t,i){const n=this.cameraForBounds(e,t);return this._fitInternal(n,t,i)}fitScreenCoordinates(t,i,n,r,o){const s=e.P.convert(t),a=e.P.convert(i),l=new e.P(Math.min(s.x,a.x),Math.min(s.y,a.y)),c=new e.P(Math.max(s.x,a.x),Math.max(s.y,a.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(s,a))return this;const u=this.transform.pointLocation3D(l),h=this.transform.pointLocation3D(c),d=this.transform.pointLocation3D(new e.P(l.x,c.y)),p=this.transform.pointLocation3D(new e.P(c.x,l.y)),f=[Math.min(u.lng,h.lng,d.lng,p.lng),Math.min(u.lat,h.lat,d.lat,p.lat)],m=[Math.max(u.lng,h.lng,d.lng,p.lng),Math.max(u.lat,h.lat,d.lat,p.lat)],g=r&&r.pitch?r.pitch:this.getPitch(),_=this._cameraForBounds(this.transform,f,m,n,g,r);return this._fitInternal(_,r,o)}_fitInternal(e,t,i){return e?(t=Object.assign(e,t)).linear?this.easeTo(t,i):this.flyTo(t,i):this}jumpTo(t,i){this.stop();const n=t.preloadOnly?this.transform.clone():this.transform;let r=!1,o=!1,s=!1;"zoom"in t&&n.zoom!==+t.zoom&&(r=!0,n.zoom=+t.zoom),void 0!==t.center&&(n.center=e.aS.convert(t.center)),"bearing"in t&&n.bearing!==+t.bearing&&(o=!0,n.bearing=+t.bearing),"pitch"in t&&n.pitch!==+t.pitch&&(s=!0,n.pitch=+t.pitch);const a="number"==typeof t.padding?this._extendPadding(t.padding):t.padding;if(null!=t.padding&&!n.isPaddingEqual(a))if(!1===t.retainPadding){const e=n.clone();e.padding=a,n.setLocationAtPoint(n.center,e.centerPoint)}else n.padding=a;return t.preloadOnly?(this._preloadTiles(n),this):(this.fire(new e.z("movestart",i)).fire(new e.z("move",i)),r&&this.fire(new e.z("zoomstart",i)).fire(new e.z("zoom",i)).fire(new e.z("zoomend",i)),o&&this.fire(new e.z("rotatestart",i)).fire(new e.z("rotate",i)).fire(new e.z("rotateend",i)),s&&this.fire(new e.z("pitchstart",i)).fire(new e.z("pitch",i)).fire(new e.z("pitchend",i)),this.fire(new e.z("moveend",i)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||e.w(Tl),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,i){const n=this.transform;if(!n.projection.supportsFreeCamera)return e.w(Tl),this;this.stop();const r=n.zoom,o=n.pitch,s=n.bearing;n.setFreeCameraOptions(t);const a=r!==n.zoom,l=o!==n.pitch,c=s!==n.bearing;return this.fire(new e.z("movestart",i)).fire(new e.z("move",i)),a&&this.fire(new e.z("zoomstart",i)).fire(new e.z("zoom",i)).fire(new e.z("zoomend",i)),c&&this.fire(new e.z("rotatestart",i)).fire(new e.z("rotate",i)).fire(new e.z("rotateend",i)),l&&this.fire(new e.z("pitchstart",i)).fire(new e.z("pitch",i)).fire(new e.z("pitchend",i)),this.fire(new e.z("moveend",i)),this}easeTo(t,i){this._stop(!1,t.easeId),(!1===(t=Object.assign({offset:[0,0],duration:500,easing:e.eU},t)).animate||this._prefersReducedMotion(t))&&(t.duration=0);const n=this.transform,r=this.getZoom(),o=this.getBearing(),s=this.getPitch(),a=this.getPadding(),l="zoom"in t?+t.zoom:r,c="bearing"in t?this._normalizeBearing(t.bearing,o):o,u="pitch"in t?+t.pitch:s,h=this._extendPadding(t.padding),d=e.P.convert(t.offset);let p,f,m;if("globe"===n.projection.name){const i=e.ae.fromLngLat(n.center),r=d.rotate(-n.angle);i.x+=r.x/n.worldSize,i.y+=r.y/n.worldSize;const o=i.toLngLat(),s=e.aS.convert(t.center||o);this._normalizeCenter(s),p=n.centerPoint.add(r),f=new e.P(i.x,i.y).mult(n.worldSize),m=new e.P(e.aF(s.lng),e.aJ(s.lat)).mult(n.worldSize).sub(f)}else{p=n.centerPoint.add(d);const i=n.pointLocation(p),r=e.aS.convert(t.center||i);this._normalizeCenter(r),f=n.project(i),m=n.project(r).sub(f)}const g=n.zoomScale(l-r);let _,y;t.around&&(_=e.aS.convert(t.around),y=n.locationPoint(_));const v=this._zooming||l!==r,x=this._rotating||o!==c,b=this._pitching||u!==s,T=!n.isPaddingEqual(h),w=!1===t.retainPadding?n.clone():n,E=n=>E=>{if(v&&(n.zoom=e.ak(r,l,E)),x&&(n.bearing=e.ak(o,c,E)),b&&(n.pitch=e.ak(s,u,E)),T&&(w.interpolatePadding(a,h,E),p=w.centerPoint.add(d)),_)n.setLocationAtPoint(_,y);else{const e=n.zoomScale(n.zoom-r),t=l>r?Math.min(2,g):Math.max(.5,g),i=Math.pow(t,1-E),o=n.unproject(f.add(m.mult(E*i)).mult(e));n.setLocationAtPoint(n.renderWorldCopies?o.wrap():o,p)}return t.preloadOnly||this._fireMoveEvents(i),n};if(t.preloadOnly){const e=this._emulate(E,t.duration,n);return this._preloadTiles(e),this}const S={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=v,this._rotating=x,this._pitching=b,this._padding=T,this._easeId=t.easeId,this._prepareEase(i,t.noMoveStart,S),this._ease(E(n),(e=>{"sea"===n.cameraElevationReference&&n.recenterOnTerrain(),this._afterEase(i,e)}),t),this}_prepareEase(t,i,n={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),i||n.moving||this.fire(new e.z("movestart",t)),this._zooming&&!n.zooming&&this.fire(new e.z("zoomstart",t)),this._rotating&&!n.rotating&&this.fire(new e.z("rotatestart",t)),this._pitching&&!n.pitching&&this.fire(new e.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new e.z("move",t)),this._zooming&&this.fire(new e.z("zoom",t)),this._rotating&&this.fire(new e.z("rotate",t)),this._pitching&&this.fire(new e.z("pitch",t))}_afterEase(t,i){if(this._easeId&&i&&this._easeId===i)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const n=this._zooming,r=this._rotating,o=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,n&&this.fire(new e.z("zoomend",t)),r&&this.fire(new e.z("rotateend",t)),o&&this.fire(new e.z("pitchend",t)),this.fire(new e.z("moveend",t))}flyTo(t,i){if(this._prefersReducedMotion(t)){const n=e.aH(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(n,i)}this.stop(),t=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:e.eU},t);const n=this.transform,r=this.getZoom(),o=this.getBearing(),s=this.getPitch(),a=this.getPadding(),l="zoom"in t?e.aA(+t.zoom,n.minZoom,n.maxZoom):r,c="bearing"in t?this._normalizeBearing(t.bearing,o):o,u="pitch"in t?+t.pitch:s,h=this._extendPadding(t.padding),d=n.zoomScale(l-r),p=e.P.convert(t.offset);let f=n.centerPoint.add(p);const m=n.pointLocation(f),g=e.aS.convert(t.center||m);this._normalizeCenter(g);const _=n.project(m),y=n.project(g).sub(_);let v=t.curve;const x=Math.max(n.width,n.height),b=x/d,T=y.mag();if("minZoom"in t){const i=e.aA(Math.min(t.minZoom,r,l),n.minZoom,n.maxZoom),o=x/n.zoomScale(i-r);v=Math.sqrt(o/T*2)}const w=v*v;function E(e){const t=(b*b-x*x+(e?-1:1)*w*w*T*T)/(2*(e?b:x)*w*T);return Math.log(Math.sqrt(t*t+1)-t)}function S(e){return(Math.exp(e)-Math.exp(-e))/2}function A(e){return(Math.exp(e)+Math.exp(-e))/2}const M=E(0);let I=function(e){return A(M)/A(M+v*e)},C=function(e){return x*((A(M)*(S(t=M+v*e)/A(t))-S(M))/w)/T;var t},P=(E(1)-M)/v;if(Math.abs(T)<1e-6||!isFinite(P)){if(Math.abs(x-b)<1e-6)return this.easeTo(t,i);const e=b<x?-1:1;P=Math.abs(Math.log(b/x))/v,C=function(){return 0},I=function(t){return Math.exp(e*v*t)}}t.duration="duration"in t?+t.duration:1e3*P/("screenSpeed"in t?+t.screenSpeed/v:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const L=o!==c,R=u!==s,O=!n.isPaddingEqual(h),D=!1===t.retainPadding?n.clone():n,B=n=>d=>{const m=d*P,v=1/I(m);n.zoom=1===d?l:r+n.scaleZoom(v),L&&(n.bearing=e.ak(o,c,d)),R&&(n.pitch=e.ak(s,u,d)),O&&(D.interpolatePadding(a,h,d),f=D.centerPoint.add(p));const x=1===d?g:n.unproject(_.add(y.mult(C(m))).mult(v));return n.setLocationAtPoint(n.renderWorldCopies?x.wrap():x,f),n._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(i),n};if(t.preloadOnly){const e=this._emulate(B,t.duration,n);return this._preloadTiles(e),this}return this._zooming=!0,this._rotating=L,this._pitching=R,this._padding=O,this._prepareEase(i,!1),this._ease(B(n),(()=>this._afterEase(i)),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(e){}_cancelRenderFrame(e){}_stop(e,t){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const e=this._onEaseEnd;this._onEaseEnd=void 0,e.call(this,t)}if(!e){const e=this.handlers;e&&e.stop(!1)}return this}_ease(t,i,n){!1===n.animate||0===n.duration?(t(1),i()):(this._easeStart=e.o.now(),this._easeOptions=n,this._onEaseFrame=t,this._onEaseEnd=i,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((e.o.now()-this._easeStart)/this._easeOptions.duration,1),i=this._onEaseFrame;i&&i(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,i){t=e.bS(t,-180,180);const n=Math.abs(t-i);return Math.abs(t-360-i)<n&&(t-=360),Math.abs(t+360-i)<n&&(t+=360),t}_normalizeCenter(e){const t=this.transform;if(t.maxBounds)return;if("globe"!==t.projection.name&&!t.renderWorldCopies)return;const i=e.lng-t.center.lng;e.lng+=i>180?-360:i<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&e.o.prefersReducedMotion&&!(t&&t.essential)}_emulate(e,t,i){const n=Math.ceil(15*t/1e3),r=[],o=e(i.clone());for(let e=0;e<=n;e++){const t=o(e/n);r.push(t.clone())}return r}_preloadTiles(e,t){}}class El{constructor(t={}){this.options=t,e.aX(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(e){const t=this.options&&this.options.compact,i=e._getUIString("AttributionControl.ToggleAttribution");this._map=e,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=l("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",i);const n=l("span","mapboxgl-ctrl-icon",this._compactButton);return n.setAttribute("aria-hidden","true"),n.setAttribute("title",i),this._innerContainer=l("div","mapboxgl-ctrl-attrib-inner",this._container),t&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===t&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const i=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||e.e.ACCESS_TOKEN}];if(t){const n=i.reduce(((e,t,n)=>(t.value&&(e+=`${t.key}=${t.value}${n<i.length-1?"&":""}`),e)),"?");t.href=`${e.e.FEEDBACK_URL}/${n}#${Sa(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(e){!e||("source"!==e.dataType||"metadata"!==e.sourceDataType&&"visibility"!==e.sourceDataType)&&"style"!==e.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let e=[];if(this._map.style.stylesheet){const e=this._map.style.stylesheet;this.styleOwner=e.owner,this.styleId=e.id}const t=this._map.style._mergedSourceCaches;for(const i in t){const n=t[i];if(n.used){const t=n.getSource();t.attribution&&e.indexOf(t.attribution)<0&&e.push(t.attribution)}}e.sort(((e,t)=>e.length-t.length)),e=e.filter(((t,i)=>{for(let n=i+1;n<e.length;n++)if(e[n].indexOf(t)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=[...this.options.customAttribution,...e]:e.unshift(this.options.customAttribution));const i=e.join(" | ");i!==this._attribHTML&&(this._attribHTML=i,e.length?(this._innerContainer.innerHTML=i,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Sl{constructor(){e.aX(["_updateLogo","_updateCompact"],this)}onAdd(e){this._map=e,this._container=l("div","mapboxgl-ctrl");const t=l("a","mapboxgl-ctrl-logo");return t.target="_blank",t.rel="noopener nofollow",t.href="https://www.mapbox.com/",t.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),t.setAttribute("rel","noopener nofollow"),this._container.appendChild(t),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(e){e&&"metadata"!==e.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const e=this._map.style._sourceCaches;if(0===Object.entries(e).length)return!0;for(const t in e){const i=e[t].getSource();if(i.hasOwnProperty("mapbox_logo")&&!i.mapbox_logo)return!1}return!0}_updateCompact(){const e=this._container.children;if(e.length){const t=e[0];this._map.getCanvasContainer().offsetWidth<250?t.classList.add("mapboxgl-compact"):t.classList.remove("mapboxgl-compact")}}}class Al{constructor(){e.aX(["_onIndoorUpdate"],this)}onAdd(e){return this._map=e,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("selector-update",(e=>this._onIndoorUpdate(e))),this._container}_createButton(e,t){const i=l("button",e,this._container);return i.type="button",i.addEventListener("click",t),i}_createSeparator(){return l("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(e,t){this._map&&(e.setAttribute("aria-label",t),e.textContent=t)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(e){if(!e||!e.floors)return this._model=e,void(this._container.style.display="none");const t=this._model;this._model=e,this._container.style.display="inline-block",this._container.style.borderRadius="8px",t&&Array.from(this._container.children).forEach((e=>e.remove())),e.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(e.floors,e.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){const e=this._createButton("mapboxgl-ctrl-buildings-toggle",(()=>{const e=this._map;this._model&&e&&e._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)}));l("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&e.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(e),this._createSeparator()}_updateBuildingsButtonState(){const e=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");e&&this._model&&(this._model.activeFloorsVisible?e.classList.remove("mapboxgl-ctrl-level-button-selected"):e.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(e,t){for(let i=0;i<e.length;i++){const n=e[i],r=this._createButton("mapboxgl-ctrl-level-button",(()=>{this._map._selectIndoorFloor(n.id)}));this._setButtonTitle(r,n.zIndex.toString()),this._model&&n.id===this._model.selectedFloorId&&t&&r.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(r),i<e.length-1&&this._createSeparator()}}}class Ml{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(e){const t=++this._id;return this._queue.push({callback:e,id:t,cancelled:!1}),t}remove(e){const t=this._currentlyRunning,i=t?this._queue.concat(t):this._queue;for(const t of i)if(t.id===e)return void(t.cancelled=!0)}run(e=0){const t=this._currentlyRunning=this._queue;this._queue=[];for(const i of t)if(!i.cancelled&&(i.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class Il{constructor(e){this.jumpTo(e)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const i=e.dC((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-i)+this._end*i}isEasing(e){return e>=this._startTime&&e<=this._endTime}jumpTo(e){this._startTime=-1/0,this._endTime=-1/0,this._start=e,this._end=e}easeTo(e,t,i){this._start=this.getValue(t),this._end=e,this._startTime=t,this._endTime=t+i}}const Cl={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class Pl extends e.z{constructor(e,t,i,n){const{point:r,lngLat:o,originalEvent:s,target:a}=e;super(e.type,{point:r,lngLat:o,originalEvent:s,target:a}),this.preventDefault=()=>{e.preventDefault()},this.id=t,this.interaction=i,this.feature=n}}class Ll{constructor(e){this.map=e,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,i){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const n=i.filter;let r=i.type;n&&this.filters.set(t,e.b5(n)),"mouseover"===r&&(r="mouseenter"),"mouseout"===r&&(r="mouseleave");const o=this.interactionsByType.get(r)||new Map;"mouseenter"===r||"mouseleave"===r?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,i)):0===o.size&&this.map.on(r,this.handleType),0===o.size&&this.interactionsByType.set(r,o),o.set(t,i),this.typeById.set(t,r)}get(e){const t=this.typeById.get(e);if(!t)return;const i=this.interactionsByType.get(t);return i?i.get(e):void 0}remove(e){const t=this.typeById.get(e);if(!t)return;this.typeById.delete(e),this.filters.delete(e);const i=this.interactionsByType.get(t);i&&(i.delete(e),"mouseenter"===t||"mouseleave"===t?(this.delegatedInteractions.delete(e),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===i.size&&this.map.off(t,this.handleType))}queryTargets(e,t){const i=[];for(const[e,n]of t)n.target&&i.push({targetId:e,target:n.target,filter:this.filters.get(e)});return this.map.style.queryRenderedTargets(e,i,this.map.transform)}handleMove(e){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const t=this.queryTargets(e.point,Array.from(this.delegatedInteractions).reverse());t.length&&(e.type="mouseenter",this.handleType(e,t));const i=new Map;for(const[e,{feature:t}]of this.prevHoveredFeatures)this.hoveredFeatures.has(e)||i.set(t.id,t);i.size&&(e.type="mouseleave",this.handleType(e,Array.from(i.values())))}handleOut(e){const t=Array.from(this.hoveredFeatures.values()).map((({feature:e})=>e));t.length&&(e.type="mouseleave",this.handleType(e,t)),this.hoveredFeatures.clear()}handleType(t,i){const n="mouseenter"===t.type;if(n&&!this.interactionsByType.has(t.type))return void e.w("mouseenter interaction required for mouseleave to work.");const r=Array.from(this.interactionsByType.get(t.type)).reverse(),o=!!i;i=i||this.queryTargets(t.point,r);let s=!1;const a=new Set;for(const l of i){for(const[i,c]of r){if(!c.target)continue;const r=l.variants?l.variants[i]:null;if(r){for(const u of r){if(mt(u,l,a,i))continue;const r=new e.dw(l,u),h=ft(u,l,i);o&&void 0!==r.id&&(r.state=this.map.getFeatureState(r));const d=n?this.prevHoveredFeatures.get(h):null,p=new Pl(t,i,c,r),f=d?d.stop:c.handler(p);if(n&&this.hoveredFeatures.set(h,{feature:l,stop:f}),!1!==f){s=!0;break}}if(s)break}}if(s)break}if(!s)for(const[e,i]of r){const{handler:n,target:r}=i;if(!r&&!1!==n(new Pl(t,e,i,null)))break}}}function Rl(t,i){if(Array.isArray(t)&&Array.isArray(i)){const e=new Set(t),n=new Set(i);return e.size===n.size&&t.every((e=>n.has(e)))}return e.bx(t,i)}const Ol={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Dl={showCompass:!0,showZoom:!0,visualizePitch:!1};class Bl{constructor(t,i,n=!1){this._clickTolerance=10,this.element=i,this.mouseRotate=new Xa({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,n&&(this.mousePitch=new Ya({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),e.aX(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),i.addEventListener("mousedown",this.mousedown),i.addEventListener("touchstart",this.touchstart,{passive:!1}),i.addEventListener("touchmove",this.touchmove),i.addEventListener("touchend",this.touchend),i.addEventListener("touchcancel",this.reset)}down(e,t){this.mouseRotate.mousedown(e,t),this.mousePitch&&this.mousePitch.mousedown(e,t),p()}move(e,t){const i=this.map,n=this.mouseRotate.mousemoveWindow(e,t),r=n&&n.bearingDelta;if(r&&i.setBearing(i.getBearing()+r),this.mousePitch){const n=this.mousePitch.mousemoveWindow(e,t),r=n&&n.pitchDelta;r&&i.setPitch(i.getPitch()+r)}}off(){const e=this.element;e.removeEventListener("mousedown",this.mousedown),e.removeEventListener("touchstart",this.touchstart),e.removeEventListener("touchmove",this.touchmove),e.removeEventListener("touchend",this.touchend),e.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){f(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(e){this.down(Object.assign({},e,{ctrlKey:!0,preventDefault:()=>e.preventDefault()}),_(this.element,e)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(e){this.move(e,_(this.element,e))}mouseup(e){this.mouseRotate.mouseupWindow(e),this.mousePitch&&this.mousePitch.mouseupWindow(e),this.offTemp()}touchstart(e){1!==e.targetTouches.length?this.reset():(this._startPos=this._lastPos=y(this.element,e.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>e.preventDefault()},this._startPos))}touchmove(e){1!==e.targetTouches.length?this.reset():(this._lastPos=y(this.element,e.targetTouches)[0],this.move({preventDefault:()=>e.preventDefault()},this._lastPos))}touchend(e){0===e.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Fl(t,i,n){if(t=new e.aS(t.lng,t.lat),i){const r=new e.aS(t.lng-360,t.lat),o=new e.aS(t.lng+360,t.lat),s=360*Math.ceil(Math.abs(t.lng-n.center.lng)/360),a=n.locationPoint3D(t).distSqr(i),l=i.x<0||i.y<0||i.x>n.width||i.y>n.height;n.locationPoint3D(r).distSqr(i)<a&&(l||Math.abs(r.lng-n.center.lng)<s)?t=r:n.locationPoint3D(o).distSqr(i)<a&&(l||Math.abs(o.lng-n.center.lng)<s)&&(t=o)}for(;Math.abs(t.lng-n.center.lng)>180;){const e=n.locationPoint3D(t);if(e.x>=0&&e.y>=0&&e.x<=n.width&&e.y<=n.height)break;t.lng>n.center.lng?t.lng-=360:t.lng+=360}return t}const Nl={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},kl={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class Ul extends e.E{constructor(t,i){super(),(t instanceof HTMLElement||i)&&(t=Object.assign({element:t},i)),e.aX(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:n="center",color:r="#3FB1CE",scale:o=1,draggable:s=!1,clickTolerance:a=0,rotation:l=kl.rotation,rotationAlignment:c=kl.rotationAlignment,pitchAlignment:u=kl.pitchAlignment,occludedOpacity:h=kl.occludedOpacity,altitude:d=kl.altitude}=t||{};this._anchor=n,this._color=r,this._scale=o,this._draggable=s,this._clickTolerance=a,this._rotation=l,this._rotationAlignment=c,this._pitchAlignment=u,this._occludedOpacity=h,this._altitude=d,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=e.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=e.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(e=>{e.preventDefault()})),this._element.addEventListener("mousedown",(e=>{e.preventDefault()}));const p=this._element.classList;for(const e in Nl)p.remove(`mapboxgl-marker-anchor-${e}`);p.add(`mapboxgl-marker-anchor-${this._anchor}`);const f=t&&t.className?t.className.trim().split(/\s+/):[];p.add(...f),this._popup=null}_createDefaultMarker(){const e=l("div"),t=c("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},e);if(0===this._altitude){const e=c("radialGradient",{id:"shadowGradient"},c("defs",{},t));c("stop",{offset:"10%","stop-opacity":.4},e),c("stop",{offset:"100%","stop-opacity":.05},e),c("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},t)}return c("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},t),c("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},t),c("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},t),e}addTo(e){return e===this._map||(this.remove(),this._map=e,e.getCanvasContainer().appendChild(this._element),e.on("move",this._updateMoving),e.on("moveend",this._update),e.on("remove",this._clearFadeTimer),e._addMarker(this),this.setDraggable(this._draggable),this._update(),e.on("click",this._onMapClick)),this}remove(){const e=this._map;return e&&(e.off("click",this._onMapClick),e.off("move",this._updateMoving),e.off("moveend",this._update),e.off("mousedown",this._addDragHandler),e.off("touchstart",this._addDragHandler),e.off("mouseup",this._onUp),e.off("touchend",this._onUp),e.off("mousemove",this._onMove),e.off("touchmove",this._onMove),e.off("remove",this._clearFadeTimer),e._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=e.aS.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(e){return e===this._altitude||(this._defaultMarker&&(0===this._altitude&&0!==e||0!==this._altitude&&0===e)&&(this._element=this._createDefaultMarker()),this._altitude=e||kl.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const t=38.1,i=13.5,n=Math.sqrt(Math.pow(i,2)/2);e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-t],"bottom-left":[n,-1*(t-i+n)],"bottom-right":[-n,-1*(t-i+n)],left:[i,-1*(t-i)],right:[-i,-1*(t-i)]}:this._offset}this._popup=e,e._marker=this,e._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(e){const t=e.code,i=e.charCode||e.keyCode;"Space"!==t&&"Enter"!==t&&32!==i&&13!==i||this.togglePopup()}_onMapClick(e){const t=e.originalEvent.target,i=this._element;this._popup&&(t===i||i.contains(t))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const e=this._popup;return e?(e.isOpen()?(e.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(e.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const e=this._map,t=this._pos;if(!e||!t)return!1;const i=e.unproject(t,this._altitude),n=e.getFreeCameraOptions();if(!n.position)return!1;const r=n.position.toLngLat();return r.distanceTo(i)<.9*r.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const i=this._pos;if(!i||i.x<0||i.x>t.transform.width||i.y<0||i.y>t.transform.height)return void this._clearFadeTimer();const n=t.unproject(i,this._altitude);let r;t._showingGlobe()&&e.f4(t.transform,this._lngLat)?r=0:(r=1-t._queryFogOpacity(n),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(r*=this._occludedOpacity)),this._element.style.opacity=`${r}`,this._element.style.pointerEvents=r>0?"auto":"none",this._popup&&this._popup._setOpacity(r),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const e=this._pos;if(!e||!this._map)return;const t=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${e.x}px,${e.y}px)\n            ${Nl[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${t.x}px,${t.y}px)\n        `}_calculateXYTransform(){const t=this._pos,i=this._map,n=this.getPitchAlignment();if(!i||!t||"map"!==n)return"";if(!i._showingGlobe()){const e=i.getPitch();return e?`rotateX(${e}deg)`:""}const r=e.cW(e.f5(i.transform,this._lngLat)),o=t.sub(e.f6(i.transform)),s=Math.abs(o.x)+Math.abs(o.y);if(0===s)return"";const a=r/s;return`rotateX(${-o.y*a}deg) rotateY(${o.x*a}deg)`}_calculateZTransform(){const t=this._pos,i=this._map;if(!i||!t)return"";let n=0;const r=this.getRotationAlignment();if("map"===r)if(i._showingGlobe()){const t=i.project(new e.aS(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),r=i.project(new e.aS(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(t);n=e.cW(Math.atan2(r.y,r.x))-90}else n=-i.getBearing();else if("horizon"===r){const r=e.ah(4,6,i.getZoom()),o=e.f6(i.transform);o.y+=r*i.transform.height;const s=t.sub(o),a=e.cW(Math.atan2(s.y,s.x));n=(a>90?a-270:a+90)*(1-r)}return n+=this._rotation,n?`rotateZ(${n}deg)`:""}_update(e){cancelAnimationFrame(this._updateFrameId);const t=this._map;t&&(t.transform.renderWorldCopies&&(this._lngLat=Fl(this._lngLat,this._pos,t.transform)),this._pos=t.project(this._lngLat,this._altitude),!0===e?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),t._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(t._showingGlobe()||t.getTerrain()||t.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(t){return this._offset=e.P.convert(t),this._update(),this}addClassName(e){return this._element.classList.add(e),this}removeClassName(e){return this._element.classList.remove(e),this}toggleClassName(e){return this._element.classList.toggle(e)}_onMove(t){const i=this._map;if(!i)return;const n=this._pointerdownPos,r=this._positionDelta;if(n&&r){if(!this._isDragging){const e=this._clickTolerance||i._clickTolerance;if(t.point.dist(n)<e)return;this._isDragging=!0}this._pos=t.point.sub(r),this._lngLat=i.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new e.z("dragstart"))),this.fire(new e.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new e.z("dragend")),this._state="inactive"}_addDragHandler(e){const t=this._map,i=this._pos;t&&i&&this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(i),this._pointerdownPos=e.point,this._state="pending",t.on("mousemove",this._onMove),t.on("touchmove",this._onMove),t.once("mouseup",this._onUp),t.once("touchend",this._onUp))}setDraggable(e){this._draggable=!!e;const t=this._map;return t&&(e?(t.on("mousedown",this._addDragHandler),t.on("touchstart",this._addDragHandler)):(t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(e){return this._rotation=e||kl.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(e){return this._rotationAlignment=e||kl.rotationAlignment,this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(e){return this._pitchAlignment=e||kl.pitchAlignment,this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(e){return this._occludedOpacity=e||kl.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const zl={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Vl={maxWidth:100,unit:"metric"},Gl={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},jl={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},Hl=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function $l(t=new e.P(0,0),i="bottom"){if("number"==typeof t){const n=Math.round(Math.sqrt(.5*Math.pow(t,2)));switch(i){case"top":return new e.P(0,t);case"top-left":return new e.P(n,n);case"top-right":return new e.P(-n,n);case"bottom":return new e.P(0,-t);case"bottom-left":return new e.P(n,-n);case"bottom-right":return new e.P(-n,-n);case"left":return new e.P(t,0);case"right":return new e.P(-t,0)}return new e.P(0,0)}return t instanceof e.P||Array.isArray(t)?e.P.convert(t):e.P.convert(t[i]||[0,0])}const Wl={version:t,supported:a.supported,setRTLTextPlugin:e.fa,getRTLTextPluginStatus:e.f9,Map:class extends wl{constructor(t){n.mark(i.create);const r=t;if(null!=(t=Object.assign({},Ol,t)).minZoom&&null!=t.maxZoom&&t.minZoom>t.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=t.minPitch&&null!=t.maxPitch&&t.minPitch>t.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=t.minPitch&&t.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=t.maxPitch&&t.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(t.antialias&&e.f2(window)&&(t.antialias=!1,e.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new an(t.minZoom,t.maxZoom,t.minPitch,t.maxPitch,t.renderWorldCopies,null,null),t),this._repaint=!!t.repaint,this._interactive=t.interactive,this._minTileCacheSize=t.minTileCacheSize,this._maxTileCacheSize=t.maxTileCacheSize,this._failIfMajorPerformanceCaveat=t.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=t.preserveDrawingBuffer,this._antialias=t.antialias,this._trackResize=t.trackResize,this._bearingSnap=t.bearingSnap,this._refreshExpiredTiles=t.refreshExpiredTiles,this._fadeDuration=t.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=t.crossSourceCollisions,this._collectResourceTiming=t.collectResourceTiming,this._language=this._parseLanguage(t.language),this._worldview=t.worldview,this._renderTaskQueue=new Ml,this._domRenderTaskQueue=new Ml,this._controls=[],this._markers=[],this._popups=[],this._mapId=e.b1(),this._locale=Object.assign({},Cl,t.locale),this._clickTolerance=t.clickTolerance,this._cooperativeGestures=t.cooperativeGestures,this._performanceMetricsCollection=t.performanceMetricsCollection,this._tessellationStep=t.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=t.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Il(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=t.scaleFactor,this._requestManager=new w(t.transformRequest,t.accessToken,t.testMode),this._silenceAuthErrors=!!t.testMode,this._contextCreateOptions=t.contextCreateOptions?Object.assign({},t.contextCreateOptions):{},"string"==typeof t.container){const e=document.getElementById(t.container);if(!e)throw new Error(`Container '${t.container.toString()}' not found.`);this._container=e}else{if(!(t.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=t.container}if(this._container.childNodes.length>0&&e.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),t.maxBounds&&this.setMaxBounds(t.maxBounds),this._spriteFormat=t.spriteFormat,e.aX(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new sa),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},(()=>{this.setScaleFactor(this._scaleFactor)})),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new bl(this,t),this._localFontFamily=t.localFontFamily,this._localIdeographFontFamily=t.localIdeographFontFamily,(t.style||!t.testMode)&&this.setStyle(t.style||e.e.DEFAULT_STYLE,{config:t.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),t.projection&&this.setProjection(t.projection),t.hash&&(this._hash=new Ea("string"==typeof t.hash&&t.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==r.center&&null==r.zoom||(this.transform._unmodified=!1),this.jumpTo({center:t.center,zoom:t.zoom,bearing:t.bearing,pitch:t.pitch});const e=t.bounds;e&&(this.resize(),this.fitBounds(e,Object.assign({},t.fitBoundsOptions,{duration:0})))}this.resize(),t.attributionControl&&this.addControl(new El({customAttribution:t.customAttribution})),this._logoControl=new Sl,this.addControl(this._logoControl,t.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent(),this._setupIndoor()})),this.on("data",(t=>{this._update("style"===t.dataType),this.fire(new e.z(`${t.dataType}data`,t))})),this.on("dataloading",(t=>{this.fire(new e.z(`${t.dataType}dataloading`,t))})),this._interactions=new Ll(this)}_getMapId(){return this._mapId}addControl(t,i){if(void 0===i&&(i=t.getDefaultPosition?t.getDefaultPosition():"top-right"),!t||!t.onAdd)return this.fire(new e.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=t.onAdd(this);this._controls.push(t);const r=this._controlPositions[i];return-1!==i.indexOf("bottom")?r.insertBefore(n,r.firstChild):r.appendChild(n),this}removeControl(t){if(!t||!t.onRemove)return this.fire(new e.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const i=this._controls.indexOf(t);return i>-1&&this._controls.splice(i,1),t.onRemove(this),this}hasControl(e){return this._controls.indexOf(e)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(t){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const i=!this._moving;return i&&this.fire(new e.z("movestart",t)).fire(new e.z("move",t)),this.fire(new e.z("resize",t)),i&&this.fire(new e.z("moveend",t)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(t){return this.transform.setMaxBounds(e.aI.convert(t)),this._update()}setMinZoom(t){if((t=t??-2)>=-2&&t<=this.transform.maxZoom)return this.transform.minZoom=t,this._update(),this.getZoom()<t?this.setZoom(t):this.fire(new e.z("zoomstart")).fire(new e.z("zoom")).fire(new e.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(t){if((t=t??22)>=this.transform.minZoom)return this.transform.maxZoom=t,this._update(),this.getZoom()>t?this.setZoom(t):this.fire(new e.z("zoomstart")).fire(new e.z("zoom")).fire(new e.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(t){if((t=t??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(t>=0&&t<=this.transform.maxPitch)return this.transform.minPitch=t,this._update(),this.getPitch()<t?this.setPitch(t):this.fire(new e.z("pitchstart")).fire(new e.z("pitch")).fire(new e.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(t){if((t=t??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(t>=this.transform.minPitch)return this.transform.maxPitch=t,this._update(),this.getPitch()>t?this.setPitch(t):this.fire(new e.z("pitchstart")).fire(new e.z("pitch")).fire(new e.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(e){return this._scaleFactor=e,this.painter.scaleFactor=e,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers((e=>"symbol"===e.type)),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(e){return this.transform.renderWorldCopies=e,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(e){return"auto"===e?navigator.language:Array.isArray(e)?0===e.length?void 0:e.map((e=>"auto"===e?navigator.language:e)):e}setLanguage(e){const t=this._parseLanguage(e);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const e of this._controls)e._setLanguage&&e._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(e){return this.style&&e!==this._worldview?(this._worldview=e,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(e){return this._lazyInitEmptyStyle(),e?"string"==typeof e&&(e={name:e}):e=null,this._useExplicitProjection=!!e,this._prioritizeAndUpdateProjection(e,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const t=this.transform,i=t.projection.name;let n;"globe"===i&&t.zoom>=e.cK?(t.setMercatorFromTransition(),n=!0):"mercator"===i&&t.zoom<e.cK&&(t.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(e,t){return this._updateProjection(e||t||{name:"mercator"})}_updateProjection(t){let i;const n=this.transform.mercatorFromTransition;i="globe"===t.name&&this.transform.zoom>=e.cK?this.transform.setMercatorFromTransition():this.transform.setProjection(t),this.style.applyProjectionUpdate();const r="mercator"===this.transform.getProjection().name&&n!==this.transform.mercatorFromTransition;return(i||r)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(t,i){return this.transform.locationPoint3D(e.aS.convert(t),i)}unproject(t,i){return this.transform.pointLocation3D(e.P.convert(t),i)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(e,t,i){const n=e=>{let i=[];if(Array.isArray(t)){const n=t.filter((e=>this.getLayer(e)));i=n.length?this.queryRenderedFeatures(e,{layers:n}):[]}else i=this.queryRenderedFeatures(e,{target:t});return i};if("mouseenter"===e||"mouseover"===e){let r=!1;const o=t=>{const o=n(t.point);o.length?r||(r=!0,i.call(this,new Da(e,this,t.originalEvent,{features:o}))):r=!1};return{listener:i,targets:t,delegates:{mousemove:o,mouseout:()=>{r=!1}}}}if("mouseleave"===e||"mouseout"===e){let r=!1;const o=t=>{n(t.point).length?r=!0:r&&(r=!1,i.call(this,new Da(e,this,t.originalEvent)))},s=t=>{r&&(r=!1,i.call(this,new Da(e,this,t.originalEvent)))};return{listener:i,targets:t,delegates:{mousemove:o,mouseout:s}}}{const r=e=>{const t=n(e.point);t.length&&(e.features=t,i.call(this,e),delete e.features)};return{listener:i,targets:t,delegates:{[e]:r}}}}on(e,t,i){if("function"==typeof t||void 0===i)return super.on(e,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const n=this._createDelegatedListener(e,t,i);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(n);for(const e in n.delegates)this.on(e,n.delegates[e]);return this}once(e,t,i){if("function"==typeof t||void 0===i)return super.once(e,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const n=this._createDelegatedListener(e,t,i);for(const e in n.delegates)this.once(e,n.delegates[e]);return this}off(e,t,i){if("function"==typeof t||void 0===i)return super.off(e,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const n=this._delegatedListeners?this._delegatedListeners[e]:void 0;return n&&(e=>{for(let n=0;n<e.length;n++){const r=e[n];if(r.listener===i&&Rl(r.targets,t)){for(const e in r.delegates)this.off(e,r.delegates[e]);return e.splice(n,1),this}}})(n),this}queryRenderedFeatures(t,i){if(!this.style)return[];if(void 0===t||t instanceof e.P||Array.isArray(t)||void 0!==i||(i=t,t=void 0),t=t||[[0,0],[this.transform.width,this.transform.height]],!i){const e=this.style.queryRenderedFeatures(t,void 0,this.transform),i=this.style.queryRenderedFeatureset(t,void 0,this.transform);return e.concat(i)}let n=!0;if(i.target&&(n=this._isTargetValid(i.target),n&&!i.layers))return this.style.queryRenderedFeatureset(t,i,this.transform);let r=!0;if(i.layers&&Array.isArray(i.layers)){for(const e of i.layers)if(!this._isValidId(e)){r=!1;break}if(r&&!i.target)return this.style.queryRenderedFeatures(t,i,this.transform)}let o=[];return r&&(o=o.concat(this.style.queryRenderedFeatures(t,i,this.transform))),n&&(o=o.concat(this.style.queryRenderedFeatureset(t,i,this.transform))),o}querySourceFeatures(e,t){return!e||"string"==typeof e&&!this._isValidId(e)?[]:this.style.querySourceFeatures(e,t)}queryRasterValue(e,t,i){return this._isValidId(e)?this.style.queryRasterValue(e,t,i):Promise.resolve(null)}isPointOnSurface(t){const{name:i}=this.transform.projection;return"globe"!==i&&"mercator"!==i&&e.w(`${i} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(e.P.convert(t))}addInteraction(e,t){return this._interactions.add(e,t),this}removeInteraction(e){return this._interactions.remove(e),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(e){return this._cooperativeGestures=e,this}setStyle(t,i){return i=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},i),this.style&&t&&!1!==i.diff&&i.localFontFamily===this._localFontFamily&&i.localIdeographFontFamily===this._localIdeographFontFamily&&!i.config?(this.style._diffStyle(t,((n,r)=>{if(n){const r="string"==typeof n?n:n instanceof Error?n.message:n.error;e.w(`Unable to perform style diff: ${r}. Rebuilding the style from scratch.`),this._updateStyle(t,i)}else r&&this._update(!0)}),(()=>this._postStyleLoadEvent())),this):(this._localIdeographFontFamily=i.localIdeographFontFamily,this._localFontFamily=i.localFontFamily,this._updateStyle(t,i))}_getUIString(e){const t=this._locale[e];if(null==t)throw new Error(`Missing UI string '${e}'`);return t}_updateStyle(e,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),e){const i=Object.assign({},t);t&&t.config&&(i.initialConfig=t.config,delete i.config),this.style=new Cn(this,i).load(e),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Cn(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(e.w("There is no style added to the map."),!1)}_isValidId(t){return null==t?(this.fire(new e.y(new Error("IDs can't be empty."))),!1):!e.dq(t)||(this.fire(new e.y(new Error(`IDs can't contain special symbols: "${t}".`))),!1)}_isTargetValid(e){return"featuresetId"in e?this._isValidId("importId"in e?e.importId:e.featuresetId):"layerId"in e&&this._isValidId(e.layerId)}_areTargetsValid(e){if(Array.isArray(e)){for(const t of e)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(e)}addSource(e,t){return this._isValidId(e)?(this._lazyInitEmptyStyle(),this.style.addSource(e,t),this._update(!0)):this}isSourceLoaded(e){return!!this._isValidId(e)&&!!this.style&&this.style._isSourceCacheLoaded(e)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(e,t,i){this._lazyInitEmptyStyle(),this.style.addSourceType(e,t,i)}removeSource(e){return this._isValidId(e)?(this.style.removeSource(e),this._updateTerrain(),this._update(!0)):this}getSource(e){return this._isValidId(e)?this.style.getOwnSource(e):null}addImage(t,i,{pixelRatio:n=1,sdf:r=!1,stretchX:o,stretchY:s,content:a}={}){this._lazyInitEmptyStyle();const l=e.I.from(t);if(i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap){const{width:t,height:c,data:u}=e.o.getImageData(i);this.style.addImage(l,{data:new e.q({width:t,height:c},u),pixelRatio:n,stretchX:o,stretchY:s,content:a,sdf:r,version:0,usvg:!1})}else if(void 0===i.width||void 0===i.height)this.fire(new e.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:c,height:u}=i,h=i;this.style.addImage(l,{data:new e.q({width:c,height:u},new Uint8Array(h.data)),pixelRatio:n,stretchX:o,stretchY:s,content:a,sdf:r,usvg:!1,version:0,userImage:h}),h.onAdd&&h.onAdd(this,t)}}updateImage(t,i){this._lazyInitEmptyStyle();const n=e.I.from(t),r=this.style.getImage(n);if(!r)return void this.fire(new e.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const o=i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap?e.o.getImageData(i):i,{width:s,height:a,data:l}=o;if(void 0===s||void 0===a)return void this.fire(new e.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(s!==(r.usvg?r.icon.usvg_tree.width:r.data.width)||a!==(r.usvg?r.icon.usvg_tree.height:r.data.height))return void this.fire(new e.y(new Error(`The width and height of the updated image (${s}, ${a})\n                must be that same as the previous version of the image\n                (${r.data.width}, ${r.data.height})`)));const c=!(i instanceof HTMLImageElement||ImageBitmap&&i instanceof ImageBitmap);let u=!1;r.usvg?(r.data=new e.q({width:s,height:a},new Uint8Array(l)),r.usvg=!1,r.icon=void 0,u=!0):r.data.replace(l,c),this.style.updateImage(n,r,u)}hasImage(t){return t?!!this.style&&!!this.style.getImage(e.I.from(t)):(this.fire(new e.y(new Error("Missing required image id"))),!1)}removeImage(t){this.style.removeImage(e.I.from(t))}loadImage(t,i){e.n(this._requestManager.transformRequest(t,e.R.Image),((t,n)=>{i(t,n instanceof HTMLImageElement?e.o.getImageData(n):n)}))}listImages(){return this.style.listImages().map((e=>e.name))}addModel(e,t){this._lazyInitEmptyStyle(),this.style.addModel(e,t)}hasModel(t){return t?this.style.hasModel(t):(this.fire(new e.y(new Error("Missing required model id"))),!1)}removeModel(e){this.style.removeModel(e)}listModels(){return this.style.listModels()}addLayer(e,t){return this._isValidId(e.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(e,t),this._update(!0)):this}getSlot(e){const t=this.getLayer(e);return t&&t.slot||null}setSlot(e,t){return this.style.setSlot(e,t),this.style.mergeLayers(),this._update(!0)}addImport(t,i){return this.style.addImport(t,i).catch((t=>this.fire(new e.y(new Error("Failed to add import",t))))),this}updateImport(e,t){return"string"!=typeof t&&t.id!==e?(this.removeImport(e),this.addImport(t)):(this.style.updateImport(e,t),this._update(!0))}removeImport(e){return this.style.removeImport(e),this}moveImport(e,t){return this.style.moveImport(e,t),this._update(!0)}moveLayer(e,t){return this._isValidId(e)?(this.style.moveLayer(e,t),this._update(!0)):this}removeLayer(e){return this._isValidId(e)?(this.style.removeLayer(e),this._update(!0)):this}getLayer(e){if(!this._isValidId(e))return null;const t=this.style.getOwnLayer(e);return t?"custom"===t.type?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(e,t,i){return this._isValidId(e)?(this.style.setLayerZoomRange(e,t,i),this._update(!0)):this}setFilter(e,t,i={}){return this._isValidId(e)?(this.style.setFilter(e,t,i),this._update(!0)):this}getFilter(e){return this._isValidId(e)?this.style.getFilter(e):null}setPaintProperty(e,t,i,n={}){return this._isValidId(e)?(this.style.setPaintProperty(e,t,i,n),this._update(!0)):this}getPaintProperty(e,t){return this._isValidId(e)?this.style.getPaintProperty(e,t):null}setLayoutProperty(e,t,i,n={}){return this._isValidId(e)?(this.style.setLayoutProperty(e,t,i,n),this._update(!0)):this}getLayoutProperty(e,t){return this._isValidId(e)?this.style.getLayoutProperty(e,t):null}setLayerProperty(e,t,i,n={}){return this._isValidId(e)?(this.style.setLayerProperty(e,t,i,n),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(e){return this.style.setGlyphsUrl(e),this._update(!0)}getSchema(e){return this.style.getSchema(e)}setSchema(e,t){return this.style.setSchema(e,t),this._update(!0)}getConfig(e){return this.style.getConfig(e)}setConfig(e,t){return this.style.setConfig(e,t),this._update(!0)}getConfigProperty(e,t){return this.style.getConfigProperty(e,t)}setConfigProperty(e,t,i){return this.style.setConfigProperty(e,t,i),this._update(!0)}getFeaturesetDescriptors(e){return this.style.getFeaturesetDescriptors(e)}setLights(e){if(this._lazyInitEmptyStyle(),e&&1===e.length&&"flat"===e[0].type){const t=e[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(e),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const e=this.style.getLights()||[];return 0===e.length&&e.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),e}setLight(e,t={}){return this.setLights([{id:"flat",type:"flat",properties:e}])}getLight(){return this.style.getFlatLight()}setTerrain(e){return this._lazyInitEmptyStyle(),!e&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(e),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(e){return this._lazyInitEmptyStyle(),this.style.setFog(e),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(e){return this._lazyInitEmptyStyle(),this.style.setSnow(e),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(e){return this._lazyInitEmptyStyle(),this.style.setRain(e),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(e){return this._lazyInitEmptyStyle(),this.style.setColorTheme(e),this._update(!0)}setImportColorTheme(e,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(e,t),this._update(!0)}setCamera(e){return this.style.setCamera(e),this._triggerCameraUpdate(e)}_triggerCameraUpdate(e){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===e["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(t){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(e.aS.convert(t),this.transform):0}setFeatureState(e,t){return e.source&&!this._isValidId(e.source)?this:(this.style.setFeatureState(e,t),this._update())}removeFeatureState(e,t){return e.source&&!this._isValidId(e.source)?this:(this.style.removeFeatureState(e,t),this._update())}getFeatureState(e){return e.source&&!this._isValidId(e.source)?null:this.style.getFeatureState(e)}_selectIndoorFloor(e){this.indoor.selectFloor(e)}_setIndoorActiveFloorsVisibility(e){this.indoor.setActiveFloorsVisibility(e)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new Al),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const e=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let i,n,r,o=this._container;for(;o&&(!n||!r);){const e=window.getComputedStyle(o).transform;e&&"none"!==e&&(i=e.match(/matrix.*\((.+)\)/)[1].split(", "),i[0]&&"0"!==i[0]&&"1"!==i[0]&&(n=i[0]),i[3]&&"0"!==i[3]&&"1"!==i[3]&&(r=i[3])),o=o.parentElement}this._containerWidth=n?Math.abs(e/n):e,this._containerHeight=r?Math.abs(t/r):t}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&e.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupIndoor(){this.style.isIndoorEnabled()&&(this.indoor=new Pn(this.style),this.on("load",(()=>{this._addIndoorControl(),this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds()),this.on("move",(()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())})),this.on("idle",(()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())}))})))}_setupContainer(){const e=this._container;e.classList.add("mapboxgl-map"),(this._missingCSSCanary=l("div","mapboxgl-canary",e)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=l("div","mapboxgl-canvas-container",e);this._canvas=l("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const i=this._controlContainer=l("div","mapboxgl-control-container",e),n=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((e=>{n[e]=l("div",`mapboxgl-ctrl-${e}`,i)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(t,i){const n=e.o.devicePixelRatio||1;this._canvas.width=n*Math.ceil(t),this._canvas.height=n*Math.ceil(i),this._canvas.style.width=`${t}px`,this._canvas.style.height=`${i}px`}_addMarker(e){this._markers.push(e)}_removeMarker(e){const t=this._markers.indexOf(e);-1!==t&&this._markers.splice(t,1)}_addPopup(e){this._popups.push(e)}_removePopup(e){const t=this._popups.indexOf(e);-1!==t&&this._popups.splice(t,1)}_setupPainter(){const t=Object.assign({},a.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),i=this._canvas.getContext("webgl2",t);i?(j(i,!0),this.painter=new Ta(i,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",(e=>{"source"===e.dataType&&this.painter.setTileLoadedFlag(!0)})),e.k.testSupport(i)):this.fire(new e.y(new Error("Failed to initialize WebGL")))}_contextLost(t){t.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new e.z("webglcontextlost",{originalEvent:t}))}_contextRestored(t){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new e.z("webglcontextrestored",{originalEvent:t}))}_onMapScroll(e){if(e.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(e){return this.style?(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(e){return this._update(),this._renderTaskQueue.add(e)}_cancelRenderFrame(e){this._renderTaskQueue.remove(e)}_requestDomTask(e){!this.loaded()||this.loaded()&&!this.isMoving()?e():this._domRenderTaskQueue.add(e)}_render(t){let r;this.fire(new e.z("renderstart")),++this._frameId;const o=this.painter.context.extTimerQuery,s=e.o.now(),a=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(r=a.createQuery(),a.beginQuery(o.TIME_ELAPSED_EXT,r)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(t),this._domRenderTaskQueue.run(t),this._removed)return;this._updateProjectionTransition();const l=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const t=this.transform.zoom,i=this.transform.pitch,n=e.o.now(),r=new e.ac(t,{now:n,fadeDuration:l,pitch:i,transition:this.style.transition,worldview:this._worldview});this.style.update(r)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let c=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),c=this._updateAverageElevation(s),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):c=this._updateAverageElevation(s);const u=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,l,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),u&&(this._placementDirty=u.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:l,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new e.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,n.mark(i.load),this.fire(new e.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),r){const t=e.o.now()-s;a.endQuery(o.TIME_ELAPSED_EXT),setTimeout((()=>{const i=a.getQueryParameter(r,a.QUERY_RESULT)/1e6;a.deleteQuery(r),this.fire(new e.z("gpu-timing-frame",{cpuTime:t,gpuTime:i}))}),50)}if(this.listens("gpu-timing-layer")){const t=this.painter.collectGpuTimers();setTimeout((()=>{const i=this.painter.queryGpuTimers(t);this.fire(new e.z("gpu-timing-layer",{layerTimes:i}))}),50)}if(this.listens("gpu-timing-deferred-render")){const t=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const i=this.painter.queryGpuTimeDeferredRender(t);this.fire(new e.z("gpu-timing-deferred-render",{gpuTime:i}))}),50)}const h=this._sourcesDirty||this._styleDirty||this._placementDirty||c;if(h||this._repaint)this.triggerRepaint();else{const t=this.idle();if(t&&(c=this._updateAverageElevation(s,!0)),c)this.triggerRepaint();else if(this._triggerFrame(!1),t&&(this.fire(new e.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const t=this._calculateSpeedIndex();this.fire(new e.z("speedindexcompleted",{speedIndex:t})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||h||(this._fullyLoaded=!0,n.mark(i.fullLoad),this._performanceMetricsCollection&&U(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(e){for(const t of this._markers)e&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!e||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(e,t=!1){const i=e=>(this.transform.averageElevation=e,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const n=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(n||(t||e-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(e)){const t=this.transform.averageElevation;let r=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(r)?r=0:this._averageElevationLastSampledAt=e;const o=Math.abs(t-r);if(o>1){if(this._isInitialLoad||n)return this._averageElevation.jumpTo(r),i(r);this._averageElevation.easeTo(r,e,300)}else if(o>1e-4)return this._averageElevation.jumpTo(r),i(r)}return!!this._averageElevation.isEasing(e)&&i(this._averageElevation.getValue(e))}_authenticate(){V(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(t=>{if(t&&(t.message===T||401===t.status)){const t=this.painter.context.gl;j(t,!1),this._logoControl instanceof Sl&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new e.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),O(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&B(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&N(this._requestManager._customAccessToken)}_updateTerrain(){const e=this._isDragging();this.painter.updateTerrain(this.style,e)}_calculateSpeedIndex(){const e=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const i=this.painter.context.gl,n=i.createFramebuffer();function r(e){i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e,0);const t=new Uint8Array(i.drawingBufferWidth*i.drawingBufferHeight*4);return i.readPixels(0,0,i.drawingBufferWidth,i.drawingBufferHeight,i.RGBA,i.UNSIGNED_BYTE,t),t}return i.bindFramebuffer(i.FRAMEBUFFER,n),this._canvasPixelComparison(r(e),t.canvasCopies.map(r),t.timeStamps)}_canvasPixelComparison(e,t,i){let n=i[1]-i[0];const r=e.length/4;for(let o=0;o<t.length;o++){const s=t[o];let a=0;for(let t=0;t<s.length;t+=4)s[t]===e[t]&&s[t+1]===e[t+1]&&s[t+2]===e[t+2]&&s[t+3]===e[t+3]&&(a+=1);n+=(i[o+2]-i[o+1])*(1-a/r)}return n}remove(){this._hash&&this._hash.remove();for(const e of this._controls)e.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor&&this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const t=this.painter.context.gl.getExtension("WEBGL_lose_context");t&&t.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),G.delete(this.painter.context.gl),z.remove(),R.remove(),this._removed=!0,this.fire(new e.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(t){this._renderNextFrame=this._renderNextFrame||t,this.style&&!this._frame&&(this._frame=e.o.frame((e=>{const t=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,t&&this._render(e)})))}_preloadTiles(t){const i=this.style?this.style.getSourceCaches():[];return e.bv(i,((e,i)=>e._preloadTiles(t,i)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(e){this._trackResize&&this.resize({originalEvent:e})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(e){this._showParseStatus!==e&&(this._showParseStatus=e,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(e){this._showTerrainWireframe!==e&&(this._showTerrainWireframe=e,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(e){this._showLayers2DWireframe!==e&&(this._showLayers2DWireframe=e,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(e){this._showLayers3DWireframe!==e&&(this._showLayers3DWireframe=e,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(e){this._speedIndexTiming!==e&&(this._speedIndexTiming=e,this._update())}get showPadding(){return!!this._showPadding}set showPadding(e){this._showPadding!==e&&(this._showPadding=e,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,this._tp.refreshUI(),e?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(e){this._repaint!==e&&(this._repaint=e,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(e){this._vertices=e,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(e){this._showTileAABBs!==e&&(this._showTileAABBs=e,this._tp.refreshUI(),e&&this._update())}_setCacheLimits(t,i){e.f3(t,i)}get version(){return t}},NavigationControl:class{constructor(t={}){this.options=Object.assign({},Dl,t),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(e=>e.preventDefault())),this.options.showZoom&&(e.aX(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(e=>{this._map&&this._map.zoomIn({},{originalEvent:e})})),l("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(e=>{this._map&&this._map.zoomOut({},{originalEvent:e})})),l("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(e.aX(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(e=>{const t=this._map;t&&(this.options.visualizePitch?t.resetNorthPitch({},{originalEvent:e}):t.resetNorth({},{originalEvent:e}))})),this._compassIcon=l("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const e=this._map;if(!e)return;const t=e.getZoom(),i=t===e.getMaxZoom(),n=t===e.getMinZoom();this._zoomInButton.disabled=i,this._zoomOutButton.disabled=n,this._zoomInButton.setAttribute("aria-disabled",i.toString()),this._zoomOutButton.setAttribute("aria-disabled",n.toString())}_rotateCompassArrow(){const e=this._map;if(!e)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(e.transform.pitch*(Math.PI/180)),.5)}) rotateX(${e.transform.pitch}deg) rotateZ(${e.transform.angle*(180/Math.PI)}deg)`:`rotate(${e.transform.angle*(180/Math.PI)}deg)`;e._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=t)}))}onAdd(e){return this._map=e,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),e.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&e.on("pitch",this._rotateCompassArrow),e.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Bl(e,this._compass,this.options.visualizePitch)),this._container}onRemove(){const e=this._map;e&&(this._container.remove(),this.options.showZoom&&e.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&e.off("pitch",this._rotateCompassArrow),e.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(e,t){const i=l("button",e,this._container);return i.type="button",i.addEventListener("click",t),i}_setButtonTitle(e,t){if(!this._map)return;const i=this._map._getUIString(`NavigationControl.${t}`);e.setAttribute("aria-label",i),e.firstElementChild&&e.firstElementChild.setAttribute("title",i)}},GeolocateControl:class extends e.E{constructor(t={}){super();const i=navigator.geolocation;this.options=Object.assign({geolocation:i},zl,t),e.aX(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=wa(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(e){return this._map=e,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(e){const t=(t=!!this.options.geolocation)=>{this._supportsGeolocation=t,e(t)};void 0!==this._supportsGeolocation?e(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((e=>t("denied"!==e.state))).catch((()=>t())):t()}_isOutOfMapMaxBounds(e){const t=this._map.getMaxBounds(),i=e.coords;return!!t&&(i.longitude<t.getWest()||i.longitude>t.getEast()||i.latitude<t.getSouth()||i.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(t){if(this._map){if(this._isOutOfMapMaxBounds(t))return this._setErrorState(),this.fire(new e.z("outofmaxbounds",t)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(t),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(t),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new e.z("geolocate",Object.assign({coords:t.coords,timestamp:t.timestamp},t.toJSON?{toJSON:t.toJSON.bind(t)}:{}))),this._finish()}}_updateCamera(t){const i=new e.aS(t.coords.longitude,t.coords.latitude),n=t.coords.accuracy,r=this._map.getBearing(),o=Object.assign({bearing:r},this.options.fitBoundsOptions);this._map.fitBounds(i.toBounds(n),o,{geolocateSource:!0})}_updateMarker(t){if(t){const i=new e.aS(t.coords.longitude,t.coords.latitude);this._accuracyCircleMarker.setLngLat(i).addTo(this._map),this._userLocationDotMarker.setLngLat(i).addTo(this._map),this._accuracy=t.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const t=this._map.transform,i=e.ce(1,t._center.lat)*t.worldSize,n=Math.ceil(2*this._accuracy*i);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(t){if(this._map){if(this.options.trackUserLocation)if(1===t.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===t.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new e.z("error",t)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(t){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(e=>e.preventDefault())),this._geolocateButton=l("button","mapboxgl-ctrl-geolocate",this._container),l("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===t){e.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const e=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=l("div","mapboxgl-user-location"),this._dotElement.appendChild(l("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(l("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Ul({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=l("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ul({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(t=>{t.geolocateSource||"ACTIVE_LOCK"!==this._watchState||t.originalEvent&&"resize"===t.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new e.z("trackuserlocationend")))}))}}_onDeviceOrientation(e){this._userLocationDotMarker&&(e.webkitCompassHeading?this._heading=e.webkitCompassHeading:!0===e.absolute&&(this._heading=-1*e.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return e.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new e.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new e.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new e.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let e;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(e={maximumAge:6e5,timeout:0},this._noTimeout=!0):(e=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,e),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((t=>{"granted"===t&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:El,ScaleControl:class{constructor(t={}){this.options=Object.assign({},Vl,t),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(e){return!1}}(),e.aX(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const e=this.options.maxWidth||100,t=this._map,i=t._containerHeight/2,n=t._containerWidth/2-e/2,r=t.unproject([n,i]),o=t.unproject([n+e,i]),s=r.distanceTo(o);if("imperial"===this.options.unit){const t=3.2808*s;t>5280?this._setScale(e,t/5280,"mile"):this._setScale(e,t,"foot")}else"nautical"===this.options.unit?this._setScale(e,s/1852,"nautical-mile"):s>=1e3?this._setScale(e,s/1e3,"kilometer"):this._setScale(e,s,"meter")}_setScale(e,t,i){this._map._requestDomTask((()=>{const n=function(e){const t=Math.pow(10,`${Math.floor(e)}`.length-1);let i=e/t;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:i>=1?1:function(e){const t=Math.pow(10,Math.ceil(-Math.log(e)/Math.LN10));return Math.round(e*t)/t}(i),t*i}(t),r=n/t;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==i?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:i}).format(n):`${n}&nbsp;${Gl[i]}`,this._container.style.width=e*r+"px"}))}onAdd(e){return this._map=e,this._language=e.getLanguage(),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-scale",e.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(e){this._language=e,this._update()}setUnit(e){this.options.unit=e,this._update()}},FullscreenControl:class{constructor(t={}){this._fullscreen=!1,t&&t.container&&(t.container instanceof HTMLElement?this._container=t.container:e.w("Full screen control 'container' must be a DOM element.")),e.aX(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(t){return this._map=t,this._container||(this._container=this._map.getContainer()),this._controlContainer=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",e.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=l("button","mapboxgl-ctrl-fullscreen",this._controlContainer);l("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const e=this._getTitle();this._fullscreenButton.setAttribute("aria-label",e),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",e)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:Al,Popup:class extends e.E{constructor(t){super(),this.options=Object.assign(Object.create(jl),t),this._altitude=this.options.altitude,e.aX(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(t&&t.className?t.className.trim().split(/\s+/):[])}addTo(t){return this._map&&this.remove(),this._map=t,this.options.closeOnClick&&t.on("preclick",this._onClose),this.options.closeOnMove&&t.on("move",this._onClose),t.on("remove",this.remove),this._update(),t._addPopup(this),this._focusFirstElement(),this._trackPointer?(t.on("mousemove",this._onMouseEvent),t.on("mouseup",this._onMouseEvent),t._canvasContainer.classList.add("mapboxgl-track-pointer")):t.on("move",this._update),this.fire(new e.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const t=this._map;return t&&(t.off("move",this._update),t.off("move",this._onClose),t.off("preclick",this._onClose),t.off("click",this._onClose),t.off("remove",this.remove),t.off("mousemove",this._onMouseEvent),t.off("mouseup",this._onMouseEvent),t.off("drag",this._onMouseEvent),t._canvasContainer&&t._canvasContainer.classList.remove("mapboxgl-track-pointer"),t._removePopup(this),this._map=void 0),this.fire(new e.z("close")),this}getLngLat(){return this._lngLat}setLngLat(t){this._lngLat=e.aS.convert(t),this._pos=null,this._trackPointer=!1,this._update();const i=this._map;return i&&(i.on("move",this._update),i.off("mousemove",this._onMouseEvent),i._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(e){return this._altitude=e,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const e=this._map;return e&&(e.off("move",this._update),e.on("mousemove",this._onMouseEvent),e.on("drag",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(document.createTextNode(e))}setHTML(e){const t=document.createDocumentFragment(),i=document.createElement("body");let n;for(i.innerHTML=e;n=i.firstChild,n;)t.appendChild(n);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(e){return this.options.maxWidth=e,this._update(),this}setDOMContent(e){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=l("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(e),this.options.closeButton){const e=this._closeButton=l("button","mapboxgl-popup-close-button",t);e.type="button",e.setAttribute("aria-label","Close popup"),e.innerHTML='<span aria-hidden="true">&#215;</span>',e.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(e){return this._classList.add(e),this._updateClassList(),this}removeClassName(e){return this._classList.delete(e),this._updateClassList(),this}setOffset(e){return this.options.offset=e,this._update(),this}toggleClassName(e){let t;return this._classList.delete(e)?t=!1:(this._classList.add(e),t=!0),this._updateClassList(),t}_onMouseEvent(e){this._update(e.point)}_getAnchor(e){if(this.options.anchor)return this.options.anchor;const t=this._map,i=this._container,n=this._pos;if(!t||!i||!n)return"bottom";const r=i.offsetWidth,o=i.offsetHeight,s=n.x<r/2,a=n.x>t.transform.width-r/2;if(n.y+e<o)return s?"top-left":a?"top-right":"top";if(n.y>t.transform.height-o){if(s)return"bottom-left";if(a)return"bottom-right"}return s?"left":a?"right":"bottom"}_updateClassList(){const e=this._container;if(!e)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),e.className=t.join(" ")}_update(t){const i=this._map,n=this._content;if(!i||!this._lngLat&&!this._trackPointer||!n)return;let r=this._container;if(r||(r=this._container=l("div","mapboxgl-popup",i.getContainer()),this._tip=l("div","mapboxgl-popup-tip",r),r.appendChild(n)),this.options.maxWidth&&r.style.maxWidth!==this.options.maxWidth&&(r.style.maxWidth=this.options.maxWidth),i.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Fl(this._lngLat,this._pos,i.transform)),!this._trackPointer||t){const n=this._pos=this._trackPointer&&t instanceof e.P?t:i.project(this._lngLat,this._altitude),r=$l(this.options.offset),o=this._anchor=this._getAnchor(r.y),s=$l(this.options.offset,o),a=n.add(s).round();i._requestDomTask((()=>{this._container&&o&&(this._container.style.transform=`${Nl[o]} translate(${a.x}px,${a.y}px)`)}))}if(!this._marker&&i._showingGlobe()){const t=e.f4(i.transform,this._lngLat)?0:1;this._setOpacity(t)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const e=this._container.querySelector(Hl);e&&e.focus()}_onClose(){this.remove()}_setOpacity(e){this._container&&(this._container.style.opacity=`${e}`),this._content&&(this._content.style.pointerEvents=e?"auto":"none")}},Marker:Ul,Style:Cn,LngLat:e.aS,LngLatBounds:e.aI,Point:e.P,MercatorCoordinate:e.ae,FreeCameraOptions:tn,Evented:e.E,config:e.e,prewarm:e.f8,clearPrewarmedResources:e.f7,get accessToken(){return e.e.ACCESS_TOKEN},set accessToken(t){e.e.ACCESS_TOKEN=t},get baseApiUrl(){return e.e.API_URL},set baseApiUrl(t){e.e.API_URL=t},get workerCount(){return e.fh.workerCount},set workerCount(t){e.fh.workerCount=t},get maxParallelImageRequests(){return e.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(t){e.e.MAX_PARALLEL_IMAGE_REQUESTS=t},clearStorage(t){e.fg(t)},get workerUrl(){return e.ff.workerUrl},set workerUrl(t){e.ff.workerUrl=t},get workerClass(){return e.ff.workerClass},set workerClass(t){e.ff.workerClass=t},get workerParams(){return e.ff.workerParams},set workerParams(t){e.ff.workerParams=t},get dracoUrl(){return e.fe()},set dracoUrl(t){e.fd(t)},get meshoptUrl(){return e.fc()},set meshoptUrl(t){e.fb(t)},setNow:e.o.setNow,restoreNow:e.o.restoreNow};return Wl}));var r=i;return r}()}(mapboxGl$1)),mapboxGl$1.exports}var mapboxGlExports=requireMapboxGl(),mapboxgl=getDefaultExportFromCjs(mapboxGlExports);class Marker extends mapboxGlExports.Evented{constructor(e){super();const t=this,i=document.createElement("div"),n=e.element;n.style.transition="opacity 300ms",t._element=i.appendChild(n),t._marker=new mapboxGlExports.Marker({element:i}),t._minZoom=e.minZoom||0,t._visible=!0,bindAll(["_onClick","_onMouseEnter","_onMouseLeave","_onZoom"],t)}addTo(e){const t=this,i=t._element;return t._map=e,t._zoom=e.getZoom(),t._setVisibility(t._zoom>=t._minZoom),t._marker.addTo(e.map),e.on("zoom",t._onZoom),i.addEventListener("click",t._onClick),i.addEventListener("mouseenter",t._onMouseEnter),i.addEventListener("mouseleave",t._onMouseLeave),i.addEventListener("mousemove",t._onMouseMove),t}remove(){const e=this,t=e._element;return t.removeEventListener("click",e._onClick),t.removeEventListener("mouseenter",e._onMouseEnter),t.removeEventListener("mouseleave",e._onMouseLeave),t.removeEventListener("mousemove",e._onMouseMove),e._map.off("zoom",e._onZoom),e._marker.remove(),e}setLngLat(e){return this._marker.setLngLat(e),this}setActivity(e){const t=this._element.classList;return e?t.add("active"):t.remove("active"),this}setVisibility(e){const t=this,i=t._visible;return t._visible=e,t._zoom>=t._minZoom&&(!i&&e?t._setVisibility(!0):i&&!e&&t._setVisibility(!1)),t}_setVisibility(e){const t=this,i=t._element.style;e?(i.opacity=1,i.pointerEvents="auto"):(i.opacity=0,i.pointerEvents="none",t._hover&&t._onMouseLeave())}_onClick(e){this.fire({type:"click"}),e.stopPropagation()}_onMouseEnter(){this._hover=!0,this.fire({type:"mouseenter"})}_onMouseLeave(){delete this._hover,this.fire({type:"mouseleave"})}_onMouseMove(e){e.stopPropagation()}_onZoom(){const e=this,t=e._zoom,i=e._zoom=e._map.getZoom(),n=e._minZoom;e._visible&&(t<n&&i>=n?e._setVisibility(!0):t>=n&&i<n&&e._setVisibility(!1))}}var earthRadius=6371008.8,factors={meters:earthRadius,metres:earthRadius,millimeters:1e3*earthRadius,millimetres:1e3*earthRadius,centimeters:100*earthRadius,centimetres:100*earthRadius,kilometers:earthRadius/1e3,kilometres:earthRadius/1e3,miles:earthRadius/1609.344,nauticalmiles:earthRadius/1852,inches:39.37*earthRadius,yards:earthRadius/1.0936,feet:3.28084*earthRadius,radians:1,degrees:earthRadius/111325};function feature(e,t,i){if(!isObject$5(i=i||{}))throw new Error("options is invalid");var n=i.bbox,r=i.id;if(void 0===e)throw new Error("geometry is required");if(t&&t.constructor!==Object)throw new Error("properties must be an Object");n&&validateBBox(n),r&&validateId(r);var o={type:"Feature"};return r&&(o.id=r),n&&(o.bbox=n),o.properties=t||{},o.geometry=e,o}function point(e,t,i){if(!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!isNumber(e[0])||!isNumber(e[1]))throw new Error("coordinates must contain numbers");return feature({type:"Point",coordinates:e},t,i)}function polygon(e,t,i){if(!e)throw new Error("coordinates is required");for(var n=0;n<e.length;n++){var r=e[n];if(r.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var o=0;o<r[r.length-1].length;o++){if(0===n&&0===o&&!isNumber(r[0][0])||!isNumber(r[0][1]))throw new Error("coordinates must contain numbers");if(r[r.length-1][o]!==r[0][o])throw new Error("First and last Position are not equivalent.")}}return feature({type:"Polygon",coordinates:e},t,i)}function lineString(e,t,i){if(!e)throw new Error("coordinates is required");if(e.length<2)throw new Error("coordinates must be an array of two or more positions");if(!isNumber(e[0][1])||!isNumber(e[0][1]))throw new Error("coordinates must contain numbers");return feature({type:"LineString",coordinates:e},t,i)}function featureCollection(e,t){if(!isObject$5(t=t||{}))throw new Error("options is invalid");var i=t.bbox,n=t.id;if(!e)throw new Error("No features passed");if(!Array.isArray(e))throw new Error("features must be an Array");i&&validateBBox(i),n&&validateId(n);var r={type:"FeatureCollection"};return n&&(r.id=n),i&&(r.bbox=i),r.features=e,r}function radiansToLength(e,t){if(null==e)throw new Error("radians is required");if(t&&"string"!=typeof t)throw new Error("units must be a string");var i=factors[t||"kilometers"];if(!i)throw new Error(t+" units is invalid");return e*i}function lengthToRadians(e,t){if(null==e)throw new Error("distance is required");if(t&&"string"!=typeof t)throw new Error("units must be a string");var i=factors[t||"kilometers"];if(!i)throw new Error(t+" units is invalid");return e/i}function radiansToDegrees(e){if(null==e)throw new Error("radians is required");return 180*(e%(2*Math.PI))/Math.PI}function degreesToRadians(e){if(null==e)throw new Error("degrees is required");return e%360*Math.PI/180}function isNumber(e){return!isNaN(e)&&null!==e&&!Array.isArray(e)}function isObject$5(e){return!!e&&e.constructor===Object}function validateBBox(e){if(!e)throw new Error("bbox is required");if(!Array.isArray(e))throw new Error("bbox must be an Array");if(4!==e.length&&6!==e.length)throw new Error("bbox must be an Array of 4 or 6 numbers");e.forEach((function(e){if(!isNumber(e))throw new Error("bbox must only contain numbers")}))}function validateId(e){if(!e)throw new Error("id is required");if(-1===["string","number"].indexOf(typeof e))throw new Error("id must be a number or a string")}function coordEach(e,t,i){if(null!==e)for(var n,r,o,s,a,l,c,u,h=0,d=0,p=e.type,f="FeatureCollection"===p,m="Feature"===p,g=f?e.features.length:1,_=0;_<g;_++){a=(u=!!(c=f?e.features[_].geometry:m?e.geometry:e)&&"GeometryCollection"===c.type)?c.geometries.length:1;for(var y=0;y<a;y++){var v=0,x=0;if(null!==(s=u?c.geometries[y]:c)){l=s.coordinates;var b=s.type;switch(h=!i||"Polygon"!==b&&"MultiPolygon"!==b?0:1,b){case null:break;case"Point":if(!1===t(l,d,_,v,x))return!1;d++,v++;break;case"LineString":case"MultiPoint":for(n=0;n<l.length;n++){if(!1===t(l[n],d,_,v,x))return!1;d++,"MultiPoint"===b&&v++}"LineString"===b&&v++;break;case"Polygon":case"MultiLineString":for(n=0;n<l.length;n++){for(r=0;r<l[n].length-h;r++){if(!1===t(l[n][r],d,_,v,x))return!1;d++}"MultiLineString"===b&&v++,"Polygon"===b&&x++}"Polygon"===b&&v++;break;case"MultiPolygon":for(n=0;n<l.length;n++){for("MultiPolygon"===b&&(x=0),r=0;r<l[n].length;r++){for(o=0;o<l[n][r].length-h;o++){if(!1===t(l[n][r][o],d,_,v,x))return!1;d++}x++}v++}break;case"GeometryCollection":for(n=0;n<s.geometries.length;n++)if(!1===coordEach(s.geometries[n],t,i))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function featureEach(e,t){if("Feature"===e.type)t(e,0);else if("FeatureCollection"===e.type)for(var i=0;i<e.features.length&&!1!==t(e.features[i],i);i++);}function geomEach(e,t){var i,n,r,o,s,a,l,c,u,h,d=0,p="FeatureCollection"===e.type,f="Feature"===e.type,m=p?e.features.length:1;for(i=0;i<m;i++){for(c=p?e.features[i].properties:f?e.properties:{},u=p?e.features[i].bbox:f?e.bbox:void 0,h=p?e.features[i].id:f?e.id:void 0,s=(l=!!(a=p?e.features[i].geometry:f?e.geometry:e)&&"GeometryCollection"===a.type)?a.geometries.length:1,r=0;r<s;r++)if(null!==(o=l?a.geometries[r]:a))switch(o.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===t(o,d,c,u,h))return!1;break;case"GeometryCollection":for(n=0;n<o.geometries.length;n++)if(!1===t(o.geometries[n],d,c,u,h))return!1;break;default:throw new Error("Unknown Geometry Type")}else if(!1===t(null,d,c,u,h))return!1;d++}}function flattenEach(e,t){geomEach(e,(function(e,i,n,r,o){var s,a=null===e?null:e.type;switch(a){case null:case"Point":case"LineString":case"Polygon":return!1!==t(feature(e,n,{bbox:r,id:o}),i,0)&&void 0}switch(a){case"MultiPoint":s="Point";break;case"MultiLineString":s="LineString";break;case"MultiPolygon":s="Polygon"}for(var l=0;l<e.coordinates.length;l++){if(!1===t(feature({type:s,coordinates:e.coordinates[l]},n),i,l))return!1}}))}var mapboxGlAnimatedPopup$1={exports:{}},mapboxGlAnimatedPopup=mapboxGlAnimatedPopup$1.exports,hasRequiredMapboxGlAnimatedPopup;
/*!
 * Mapbox GL JS Animated Popup v0.4.0
 * https://nagix.github.io/mapbox-gl-animated-popup
 * (c) 2020-2022 Akihiko Kusanagi
 * Released under the MIT license
 */function requireMapboxGlAnimatedPopup(){return hasRequiredMapboxGlAnimatedPopup||(hasRequiredMapboxGlAnimatedPopup=1,function(e){e.exports=function(e){const t=e.version.split(".").map((e=>+e)),i={linear:e=>e,easeInQuad:e=>e*e,easeOutQuad:e=>-e*(e-2),easeInOutQuad:e=>(e/=.5)<1?.5*e*e:-.5*(--e*(e-2)-1),easeInCubic:e=>e*e*e,easeOutCubic:e=>(e-=1)*e*e+1,easeInOutCubic:e=>(e/=.5)<1?.5*e*e*e:.5*((e-=2)*e*e+2),easeInQuart:e=>e*e*e*e,easeOutQuart:e=>-((e-=1)*e*e*e-1),easeInOutQuart:e=>(e/=.5)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2),easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>(e-=1)*e*e*e*e+1,easeInOutQuint:e=>(e/=.5)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2),easeInSine:e=>1-Math.cos(e*(Math.PI/2)),easeOutSine:e=>Math.sin(e*(Math.PI/2)),easeInOutSine:e=>-.5*(Math.cos(Math.PI*e)-1),easeInExpo:e=>0===e?0:Math.pow(2,10*(e-1)),easeOutExpo:e=>1===e?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>0===e?0:1===e?1:(e/=.5)<1?.5*Math.pow(2,10*(e-1)):.5*(2-Math.pow(2,-10*--e)),easeInCirc:e=>e>=1?e:-(Math.sqrt(1-e*e)-1),easeOutCirc:e=>Math.sqrt(1-(e-=1)*e),easeInOutCirc:e=>(e/=.5)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1),easeInElastic(e){let t=1.70158,i=0,n=1;return 0===e?0:1===e?1:(i||(i=.3),t=i/(2*Math.PI)*Math.asin(1/n),-n*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i))},easeOutElastic(e){let t=1.70158,i=0,n=1;return 0===e?0:1===e?1:(i||(i=.3),t=i/(2*Math.PI)*Math.asin(1/n),n*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/i)+1)},easeInOutElastic(e){let t=1.70158,i=0,n=1;return 0===e?0:2==(e/=.5)?1:(i||(i=.45),t=i/(2*Math.PI)*Math.asin(1/n),e<1?n*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/i)*.5+1)},easeInBack(e){const t=1.70158;return e*e*((t+1)*e-t)},easeOutBack(e){const t=1.70158;return(e-=1)*e*((t+1)*e+t)+1},easeInOutBack(e){let t=1.70158;return(e/=.5)<1?e*e*((1+(t*=1.525))*e-t)*.5:.5*((e-=2)*e*((1+(t*=1.525))*e+t)+2)},easeInBounce:e=>1-i.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?.5*i.easeInBounce(2*e):.5*i.easeOutBounce(2*e-1)+.5},n={scale:(e,t,i)=>{e.transform=`scale(${i?1-t:t})`},opacity:(e,t,i)=>{e.opacity=i?1-t:t}};function r(e,t,r,o,s,a){let l;const c="string"==typeof a?n[a]||n.scale:a,u=performance.now(),h=()=>{if(l)return;const n=performance.now()-u,a=0===r?1:Math.min(n/r,1),d=i[t](a);c(e,d,o),a<1?requestAnimationFrame(h):s&&s()};return h(),()=>{l=!0}}function o(e,...t){for(const i of t)for(const t in i)"object"==typeof i[t]?(e[t]||(e[t]={}),o(e[t],i[t])):e[t]=i[t];return e}function s(e){for(const t of e.values()){const e=t.match(/mapboxgl-popup-anchor-(.+)/);if(e)return e[1].replace("-"," ")}}const a={openingAnimation:{transform:"scale",duration:1e3,easing:"easeOutElastic"},closingAnimation:{transform:"scale",duration:300,easing:"easeInBack"}};class l extends e.Popup{constructor(e){super(e),o(this.options,o({},a,e))}addTo(...e){return this._map&&this._remove(),super.addTo(...e)}_remove(){const e=this._wrapperContainer;this._cancelAnimation&&this._cancelAnimation(),e&&e.parentNode&&(e.parentNode.removeChild(e),delete this._wrapperContainer),super.remove()}remove(){if(this._wrapperContainer){const{easing:e,duration:t,transform:i}=this.options.closingAnimation;this._cancelAnimation&&this._cancelAnimation(),this._cancelAnimation=r(this._container.style,e,t,!0,(()=>{this._remove()}),i)}else super.remove();return this}_update(...e){if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;const i=this._map._requestDomTask;let n,o=this._wrapperContainer,a=this._container;Object.defineProperty(this,"_container",{configurable:!0,get:()=>a,set:e=>{const{easing:t,duration:i,transform:n}=this.options.openingAnimation;o=this._wrapperContainer=document.createElement("div"),o.className="mapboxgl-popup-wrapper",o.style.position="absolute",o.style.willChange="transform",o.style.pointerEvents="none",a=e,a.style.position="relative",this._map.getContainer().appendChild(o),o.appendChild(a),this._cancelAnimation=r(a.style,t,i,!1,null,n)}}),t[0]>=2&&t[1]>=3||t[0]>=3?this._map._requestDomTask=e=>{i.call(this._map,(()=>{n=a?a.style.transform:"scale(0)",e(),o.style.transform=a.style.transform,a.style.transform=n,a.style.transformOrigin=this._anchor?this._anchor.replace("-"," "):s(a.classList)}))}:n=a?a.style.transform:"scale(0)",super._update(...e),delete this._container,this._container=a,t[0]>=2&&t[1]>=3||t[0]>=3?this._map._requestDomTask=i:(o.style.transform=a.style.transform,a.style.transform=n,a.style.transformOrigin=s(a.classList))}}return l}(requireMapboxGl())}(mapboxGlAnimatedPopup$1)),mapboxGlAnimatedPopup$1.exports}var mapboxGlAnimatedPopupExports=requireMapboxGlAnimatedPopup(),Popup$1=getDefaultExportFromCjs(mapboxGlAnimatedPopupExports);const animation={instances:{},count:0,initialized:!1,init(){animation.initialized||(animation.initialized=!0,function e(){const t=animation.instances,i=Object.keys(t),n=i.length,r=performance.now();for(let e=0;e<n;e++){const n=i[e],o=t[n];if(o){const e=o.nextFrame||0;if(e<=r){const{clock:t,duration:i,frameRate:s=1/0}=o,a=t?t.getHighResTime():r,l=a-(o.start=o.start||a);o.callback&&o.callback(Math.min(l,i),i),o.nextFrame=Math.max(e+1e3/s,r),l>=i&&(o.complete&&o.complete(),animation.stop(n))}}}requestAnimationFrame(e)}())},isActive:e=>e in animation.instances,start:e=>(e.duration=valueOrDefault(e.duration,1/0),animation.instances[animation.count]=e,animation.count++),stop(e){const t=animation.instances;t[e]&&delete t[e]},setFrameRate(e,t){const i=animation.instances[e];i&&(t>0?i.frameRate=t:delete i.frameRate)}};var japaneseHolidays$2={exports:{}},japaneseHolidays$1=japaneseHolidays$2.exports,hasRequiredJapaneseHolidays$1,japaneseHolidays,hasRequiredJapaneseHolidays;function requireJapaneseHolidays$1(){return hasRequiredJapaneseHolidays$1||(hasRequiredJapaneseHolidays$1=1,function(e){(function(){var t,i,n,r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b,T,w,E,S;_=function(e,t,i,n,r,o,s,a){var l;return(l=new Date(2e3,0,1)).setTime(e.getTime()+1e3*(60*(60*(24*(null!=n?n:0)+(null!=r?r:0))+(null!=o?o:0))+(null!=s?s:0))+(null!=a?a:0)),l.setFullYear(l.getFullYear()+(null!=t?t:0)+Math.floor((l.getMonth()+(null!=i?i:0))/12)),l.setMonth(((l.getMonth()+(null!=i?i:0))%12+12)%12),l},E=function(e){return _(e,0,0,0,9)},p=function(e){return _(e,0,0,0,-9)},S=function(e,t,i){return new Date(Date.UTC(e,t,i))},f=function(e,t,i){return p(S(e,t,i))},o=function(e){return E(e).getUTCDay()},r=function(e){return E(e).getUTCDate()},c=function(e){return E(e).getUTCMonth()},s=function(e){return E(e).getUTCFullYear()},a=function(e){return E(e).getUTCHours()},l=function(e){return E(e).getUTCMinutes()},u=function(e,t){return function(i){var n;return n=f(i,e-1,1),_(n,0,0,(7-(o(n)-1))%7+7*(t-1))}},b=function(e){return new Date(31556940400*(e-1949)-6558667e5)},x=function(e){var t;return t=b(e),f(e,c(t),r(t))},v=function(e){var t;return(t={1603:23,2074:23,2355:23,2384:22}[e])?f(e,8,t):new Date(3155691e4*(e-1948)-67131691e4)},y=function(e){var t;return t=v(e),f(e,c(t),r(t))},t=[["元日",(T=function(e,t){return function(i){return f(i,e-1,t)}})(1,1),1949],["成人の日",T(1,15),1949,1999],["成人の日",u(1,2),2e3],["建国記念の日",T(2,11),1967],["天皇誕生日",T(2,23),2020],["昭和天皇の大喪の礼",T(2,24),1989,1989],["春分の日",x,1949],["皇太子明仁親王の結婚の儀",T(4,10),1959,1959],["天皇誕生日",T(4,29),1949,1988],["みどりの日",T(4,29),1989,2006],["昭和の日",T(4,29),2007],["即位の日",T(5,1),2019,2019],["憲法記念日",T(5,3),1949],["みどりの日",T(5,4),2007],["こどもの日",T(5,5),1949],["皇太子徳仁親王の結婚の儀",T(6,9),1993,1993],["海の日",T(7,20),1996,2002],["海の日",u(7,3),2003,2019],["海の日",T(7,23),2020,2020],["海の日",T(7,22),2021,2021],["海の日",u(7,3),2022],["山の日",T(8,11),2016,2019],["山の日",T(8,10),2020,2020],["山の日",T(8,8),2021,2021],["山の日",T(8,11),2022],["敬老の日",T(9,15),1966,2002],["敬老の日",u(9,3),2003],["秋分の日",y,1948],["体育の日",T(10,10),1966,1999],["体育の日",u(10,2),2e3,2019],["スポーツの日",T(7,24),2020,2020],["スポーツの日",T(7,23),2021,2021],["スポーツの日",u(10,2),2022],["即位礼正殿の儀",T(10,22),2019,2019],["文化の日",T(11,3),1948],["即位礼正殿の儀",T(11,12),1990,1990],["勤労感謝の日",T(11,23),1948],["天皇誕生日",T(12,23),1989,2018]],i=function(e){var t;if(e<f(1973,3,29)||0!==o(e))return null;if(t=_(e,0,0,1),!d(t,!1))return t;if(e<f(2007,0,1))return null;for(;;)if(t=_(t,0,0,1),!d(t,!1))return t},m=function(e){var t;return s(e)<1988?null:d(_(e,0,0,2),!1)?(t=_(e,0,0,1),d(t,!1)||0===o(t)||1===o(t)?null:t):null},h={true:{},false:{}},n=function(e,n){var o,s,a,l,u,d,p,g,_,y,v,x,b;if(null!=(o=h[n=!(null!=n&&!n)][e]))return o;for(b={},u=0,g=t.length;u<g;u++)null!=(a=t[u])[2]&&e<a[2]||null!=a[3]&&a[3]<e||null!=(l=a[1](e))&&(b[[y=c(l)+1,s=r(l)]]=a[0]);for(v in h[!1][e]=b,p=[],b)v=v.split(","),null!=(l=m(f(e,v[0]-1,v[1])))&&(y=c(l)+1,s=r(l),p.push([y,s]));for(d=0,_=p.length;d<_;d++)b[l=p[d]]="国民の休日";for(v in x={},b)x[v]=b[v],v=v.split(","),null!=(l=i(f(e,v[0]-1,v[1])))&&(x[[y=c(l)+1,s=r(l)]]="振替休日");return h[!0][e]=x,h[n][e]},(w=null!=(g=null!==e?e.exports:void 0)?g:this.JapaneseHolidays={}).getHolidaysOf=function(e,t){var i,r,o,s;for(i in s=[],o=n(e,t))r=o[i],s.push({month:parseInt(i.split(",")[0]),date:parseInt(i.split(",")[1]),name:r});return s.sort((function(e,t){return e.month-t.month||e.date-t.date})),s},d=function(e,t){return n(s(e),t)[[c(e)+1,r(e)]]},w.isHoliday=function(e,t){return n(e.getFullYear(),t)[[e.getMonth()+1,e.getDate()]]},w.isHolidayAt=d,w.shiftDate=_,w.u2j=E,w.j2u=p,w.jDate=f,w.uDate=S,w.getJDay=o,w.getJDate=r,w.getJMonth=c,w.getJFullYear=s,w.getJHours=a,w.getJMinutes=l,w.__forTest={shunbunWithTime:b,shubunWithTime:v}}).call(japaneseHolidays$1)}(japaneseHolidays$2)),japaneseHolidays$2.exports}function requireJapaneseHolidays(){if(hasRequiredJapaneseHolidays)return japaneseHolidays;hasRequiredJapaneseHolidays=1;var e=requireJapaneseHolidays$1();return japaneseHolidays=e}var japaneseHolidaysExports=requireJapaneseHolidays(),JapaneseHolidays=getDefaultExportFromCjs(japaneseHolidaysExports);class Clock$1{constructor(e,t,i=-540){this.reset().setTimezoneOffset(i).setDate(e).setSpeed(t)}reset(){const e=this;return e.baseTime=0,e.baseHighResTime=0,e.speed=1,e}setSpeed(e){const t=this;return isNaN(e)||(t.baseTime=t.getTime()-Date.now()*e,t.baseHighResTime=t.getHighResTime()-performance.now()*e,t.speed=e),t}setDate(e){const t=this;if(!(e instanceof Date))return t;const i=t.baseTime,n=-t.getLocalTimezoneOffset(),r=t.baseTime=e.getTime()+n-Date.now()*t.speed;return t.baseHighResTime+=r-i,t}setTimezoneOffset(e){return this.timezoneOffset=e,this}getDate(e){const t=this.getLocalTimezoneOffset();return new Date(valueOrDefault(e,this.getTime())+t)}getTime(e){const t=this;if(!e)return t.baseTime+Date.now()*t.speed;const i=t.getDate(),n=e.split(":"),r=+n[0],o=+n[1],s=-t.getLocalTimezoneOffset()+864e5*((i.getHours()<3?-1:0)+(r<3?1:0));return i.setHours(r,o,0,0)+s+configs.minDelay}getString(e){const t=this.getDate(e);return`${t.getFullYear()}-${`0${t.getMonth()+1}`.slice(-2)}-${`0${t.getDate()}`.slice(-2)} ${`0${t.getHours()}`.slice(-2)}:${`0${t.getMinutes()}`.slice(-2)}:${`0${t.getSeconds()}`.slice(-2)}`}getTimeString(e){const t=this.getDate(e);return`${`0${t.getHours()}`.slice(-2)}:${`0${t.getMinutes()}`.slice(-2)}`}getTimeOffset(){return this.getTime()-this.getTime("03:00")}getHighResTime(){return this.baseHighResTime+performance.now()*this.speed}getTimezoneOffset(){return this.timezoneOffset}getLocalTimezoneOffset(){return 6e4*((new Date).getTimezoneOffset()-this.timezoneOffset)}getCalendar(){const e=this.getDate(),t=e.getHours();t<3&&e.setHours(t-24);const i=e.getDay(),n=e.getMonth(),r=e.getDate();return 0===i||JapaneseHolidays.isHoliday(e)||11===n&&r>=30||0===n&&r<=3?"Holiday":6===i?"Saturday":"Weekday"}}const DATE_FORMAT={year:"numeric",month:"short",day:"numeric",weekday:"short"},DATE_COMPONENTS=[{id:"year",fn:"FullYear",digits:4,extra:0},{id:"month",fn:"Month",digits:2,extra:1},{id:"day",fn:"Date",digits:2,extra:0},{id:"hour",fn:"Hours",digits:2,extra:0},{id:"minute",fn:"Minutes",digits:2,extra:0},{id:"second",fn:"Seconds",digits:2,extra:0}];class ClockControl extends mapboxGlExports.Evented{constructor(e){super();const t=this;t._lang=e.lang,t._dict=e.dict,t._clock=e.clock,t._mode=e.mode||"realtime"}getDefaultPosition(){return"top-left"}onAdd(e){const t=this;return t._map=e,t._container=createElement$1("div",{className:"mapboxgl-ctrl ctrl-group"}),t._element=createElement$1("div",{className:"clock-ctrl"},t._container),t._update(),function e(){const i=t._clock.getTime();Math.floor(i/1e3)!==Math.floor(t._lastRefresh/1e3)&&(t._refresh(),t._lastRefresh=i),t._container&&requestAnimationFrame(e)}(),t._container}onRemove(){const e=this,t=e._container;t.parentNode.removeChild(t),delete e._container,delete e._map}setMode(e){const t=this;t._mode=e,delete t._tempDate,t._editing=!1,t._update()}_onChange(){this.fire({type:"change",clock:this._clock})}_update(){const e=this,t=e._element,i=e._dict,n=e._clock,r=e._mode,o=e._editing;if(t.innerHTML=["realtime"!==r&&o?"":'<span id="date"></span><br><span id="time"></span><br>',"playback"!==r||o?"":['<div class="clock-button">',`<span><button id="edit-time-button">${i["edit-date-time"]}</button></span>`,"</div>"].join(""),"playback"===r&&o?['<div class="clock-controller">',DATE_COMPONENTS.slice(0,3).map((({id:e})=>['<span class="spin-box">',`<div><button id="${e}-increase-button" class="top-button"><span class="increase-icon"></span></button></div>`,`<div id="${e}"></div>`,`<div><button id="${e}-decrease-button" class="bottom-button"><span class="decrease-icon"></span></button></div>`,"</span>"].join(""))).join('<span class="clock-controller-separator">-</span>'),'<span class="clock-controller-separator"></span>',DATE_COMPONENTS.slice(-3).map((({id:e})=>['<span class="spin-box">',`<div><button id="${e}-increase-button" class="top-button"><span class="increase-icon"></span></button></div>`,`<div id="${e}"></div>`,`<div><button id="${e}-decrease-button" class="bottom-button"><span class="decrease-icon"></span></button></div>`,"</span>"].join(""))).join('<span class="clock-controller-separator">:</span>'),"</div>",'<div class="clock-button">',`<span><button id="edit-time-cancel-button">${i.cancel}</button></span>`,'<span class="clock-controller-separator"></span>',`<span><button id="edit-time-ok-button" disabled>${i.ok}</button></span>`,"</div>"].join(""):"","playback"===r?['<div class="speed-controller">','<span><button id="speed-decrease-button" class="left-button"',1===n.speed?" disabled":"",'><span class="decrease-icon"></span></button></span>',`<span id="clock-speed">${n.speed}${i["x-speed"]}</span>`,'<span><button id="speed-increase-button" class="right-button"',600===n.speed?" disabled":"",'><span class="increase-icon"></span></button></span>',"</div>"].join(""):""].join(""),e._refresh(),"playback"===r&&o&&(t.querySelector("#edit-time-cancel-button").addEventListener("click",(()=>{delete e._tempDate,e._editing=!1,e._update()})),t.querySelector("#edit-time-ok-button").addEventListener("click",(()=>{const t=e._tempDate;t&&(n.setDate(t),e._onChange(),delete e._tempDate),e._editing=!1,e._update()}))),"playback"!==r||o||t.querySelector("#edit-time-button").addEventListener("click",(()=>{e._editing=!0,e._update()})),"playback"===r&&o)for(const{id:i,fn:r}of DATE_COMPONENTS)t.querySelector(`#${i}-increase-button`).addEventListener("click",(()=>{const t=e._tempDate=e._tempDate||n.getDate();t[`set${r}`](t[`get${r}`]()+1),e._refresh()})),t.querySelector(`#${i}-decrease-button`).addEventListener("click",(()=>{const t=e._tempDate=e._tempDate||n.getDate();t[`set${r}`](t[`get${r}`]()-1),e._refresh()}));"playback"===r&&(t.querySelector("#speed-increase-button").addEventListener("click",(e=>{let r=n.speed;r+=r<10?1:r<100?10:100,n.setSpeed(r),e.currentTarget.disabled=600===r,t.querySelector("#speed-decrease-button").disabled=!1,t.querySelector("#clock-speed").innerHTML=r+i["x-speed"]})),t.querySelector("#speed-decrease-button").addEventListener("click",(e=>{let r=n.speed;r-=r<=10?1:r<=100?10:100,n.setSpeed(r),e.currentTarget.disabled=1===r,t.querySelector("#speed-increase-button").disabled=!1,t.querySelector("#clock-speed").innerHTML=r+i["x-speed"]})))}_refresh(){const e=this,t=e._element;let i=e._clock.getDate();if(e._editing){const n=e._tempDate;if(n){i=n;for(const{id:e}of DATE_COMPONENTS)t.querySelector(`#${e}`).classList.add("desc-caution");t.querySelector("#edit-time-ok-button").disabled=!1}for(const{id:e,fn:n,digits:r,extra:o}of DATE_COMPONENTS)t.querySelector(`#${e}`).innerHTML=`0${i[`get${n}`]()+o}`.slice(-r)}else{const n=e._lang;let r=i.toLocaleDateString(n,DATE_FORMAT);"ja"===n&&JapaneseHolidays.isHoliday(i)&&(r=r.replace(/\(.+\)/,"(祝)")),t.querySelector("#date").innerHTML=r,t.querySelector("#time").innerHTML=i.toLocaleTimeString(n)}}}class MapboxGLButtonControl{constructor(e){this._options=e.map((e=>({className:e.className||"",title:e.title||"",eventHandler:e.eventHandler})))}onAdd(e){const t=this;return t._map=e,t._container=createElement$1("div",{className:"mapboxgl-ctrl mapboxgl-ctrl-group"}),t._buttons=t._options.map((e=>{const i=e.title,n=createElement$1("button",{className:e.className,type:"button",title:i,onclick:e.eventHandler},t._container),r=createElement$1("span",{className:"mapboxgl-ctrl-icon"},n);return n.setAttribute("aria-label",i),r.setAttribute("aria-hidden",!0),n})),t._container}onRemove(){const e=this._container;e.parentNode.removeChild(e),delete this._map}}class SearchControl{constructor(e){const t=this;t._title=e.title,t._placeholder=e.placeholder,t._list=e.list,t._eventHandler=e.eventHandler}onAdd(e){const t=this;t._map=e;const i=t._container=createElement$1("div",{className:"mapboxgl-ctrl mapboxgl-ctrl-group"}),n=()=>{t._button.classList.remove("expanded"),t._searchBox.classList.add("disabled")},r=t._button=createElement$1("button",{className:"mapboxgl-ctrl-search",type:"button",title:t._title,onmousedown:()=>{t._searchBox.removeEventListener("blur",n)},onmouseup:()=>{t._searchBox.addEventListener("blur",n)},onclick:()=>{const e=t._searchBox;e.classList.toggle("disabled"),t._button.classList.toggle("expanded")?(e.value="",e.focus()):t._eventHandler({value:e.value})}},i),o=createElement$1("span",{className:"mapboxgl-ctrl-icon"},r);r.setAttribute("aria-label",t._title),o.setAttribute("aria-hidden",!0);const s=t._searchBox=createElement$1("input",{className:"search-box disabled",type:"text",list:t._list,placeholder:t._placeholder},r);return s.addEventListener("blur",n),s.addEventListener("change",(()=>{document.activeElement===s&&t._eventHandler({value:s.value})&&s.blur()})),s.addEventListener("keydown",(e=>{isTouchDevice()&&"Enter"===e.code&&t._eventHandler({value:s.value})&&s.blur()})),s.addEventListener("click",(e=>{e.stopPropagation()})),s.addEventListener("keyup",(e=>{"Space"===e.code&&e.preventDefault()})),i}onRemove(){const e=this._container;e.parentNode.removeChild(e),delete this._map}}class Dataset{constructor(e,t,i){const n=this;if(n.DataClass=e,n.lookup=new Map,t)for(const r of t)n.lookup.set(r.id,new e(r,i))}load(e,t){const i=this,n=i.lookup;for(const r of e){const e=r.id;n.has(e)?n.get(e).update(r,t):n.set(e,new i.DataClass(r,t))}}get(e){return this.lookup.get(e)}getOrAdd(e){const t=this.lookup;if(t.has(e))return t.get(e);const i=new this.DataClass;return t.set(e,i),i}getAll(){return this.lookup.values()}}class Airport{constructor(e){const t=this;t.id=e.id,t.title=e.title,t.direction=e.direction}}class Bus{constructor(e){const t=this;t.type="bus",t.id=e.id,t.gtfsId=e.gtfsId,t.trip=e.trip,t.feature=e.feature,t.offsets=e.offsets,t.offset=e.offset}}class Flight{constructor(e,t){const i=this,{s:n,dp:r,ds:o,adt:s,edt:a,sdt:l,ar:c,or:u,aat:h,eat:d,sat:p}=e;i.type="flight",i.id=e.id,i.n=e.n,i.a=t.operators.get(e.a),n&&(i.s=t.flightStatuses.get(n)),r&&(i.dp=t.airports.get(r)),o&&(i.ds=t.airports.get(o)),s&&(i.adt=getTimeOffset(s)),a&&(i.edt=getTimeOffset(a)),l&&(i.sdt=getTimeOffset(l)),c&&(i.ar=t.airports.get(c)),u&&(i.or=t.airports.get(u)),h&&(i.aat=getTimeOffset(h)),d&&(i.eat=getTimeOffset(d)),p&&(i.sat=getTimeOffset(p))}update(e,t){const i=this,{s:n,adt:r,edt:o,sdt:s,aat:a,eat:l,sat:c}=e;n&&(i.s=t.flightStatuses.get(n)),r&&(i.adt=getTimeOffset(r)),o&&(i.edt=getTimeOffset(o)),s&&(i.sdt=getTimeOffset(s)),a&&(i.aat=getTimeOffset(a)),l&&(i.eat=getTimeOffset(l)),c&&(i.sat=getTimeOffset(c))}}class FlightStatus{constructor(e){this.id=e.id,this.title=e.title}}class GTFSRoute{constructor(e){const t=this,{shortName:i,longName:n,color:r,textColor:o}=e;t.id=e.id,i&&(t.shortName=i),n&&(t.longName=n),r&&(t.color=r),o&&(t.textColor=o),t.shapes=e.shapes}}class GTFSStop{constructor(e){const t=this;t.id=e.id,t.name=e.name,t.coord=e.coord}}class GTFSTrip{constructor(e){const t=this;t.id=e.id,t.route=e.route,t.shape=e.shape,t.departureTimes=e.departureTimes,t.stops=e.stops,t.stopSequences=e.stopSequences,t.headsigns=e.headsigns}}class Operator{constructor(e){const t=this;t.id=e.id,t.title=e.title,t.color=e.color,t.tailcolor=e.tailcolor}}class POI{constructor(e){const t=this,{uptime:i,facilities:n}=e;t.id=e.id,t.coord=e.coord,t.title=e.title,t.description=e.description,i&&(t.uptime=i.map((({open:e,close:t,calendar:i})=>{const n={open:getTimeOffset(e),close:getTimeOffset(t)};return i&&(n.calendar=i),n}))),n&&(t.facilities=n)}}class RailDirection{constructor(e){this.id=e.id,this.title=e.title}}class Railway{constructor(e,t){const i=this,{dynamic:n,altitude:r}=e;i.id=e.id,i.title=e.title,i.stations=e.stations.map((e=>t.stations.getOrAdd(e))),i.ascending=t.railDirections.get(e.ascending),i.descending=t.railDirections.get(e.descending),r&&(i.altitude=r),i.color=e.color,i.carComposition=e.carComposition,n&&(i.dynamic=n)}}class Station{constructor(e,t){e&&this.update(e,t)}update(e,t){const i=this,{railway:n,coord:r,utitle:o,thumbnail:s,exit:a,altitude:l,alternate:c,ascending:u,descending:h,group:d}=e;i.id=e.id,n&&(i.railway=t.railways.get(n)),r&&(i.coord=r),i.title=e.title,o&&(i.utitle=o),s&&(i.thumbnail=s),a&&(i.exit=a.map((e=>t.pois.get(e)))),l&&(i.altitude=l),c&&(i.alternate=t.stations.getOrAdd(c)),void 0!==u&&(i.ascending=u?t.railDirections.get(u):null),void 0!==h&&(i.descending=h?t.railDirections.get(h):null),d&&(i.group=d)}}class TrainTimetable{constructor(e,t){if(!e)return;const i=this,{os:n,ds:r,tt:o,nm:s,v:a}=e,l=t.stations;i.id=e.id,i.t=e.t,i.r=t.railways.get(e.r),i.n=e.n,i.y=t.trainTypes.get(e.y),i.d=t.railDirections.get(e.d),n&&(i.os=n.map((e=>l.get(e)))),r&&(i.ds=r.map((e=>l.get(e)))),i.stations=o.map((({s:e})=>l.get(e))),i.arrivalTimes=o.map((({a:e})=>e?getTimeOffset(e):void 0)),i.departureTimes=o.map((({d:e})=>e?getTimeOffset(e):void 0)),s&&(i.nm=s),a&&(i.v=t.trainVehicleTypes.get(a));const c=i.arrivalTimes.concat(i.departureTimes).filter((e=>!isNaN(e)));i.start=Math.min(...c)-configs.standingDuration,i.end=Math.max(...c)}update(e,t){const i=this,{pt:n,nt:r}=e,o=t.timetables,s=configs.standingDuration;if(n)for(const e of n){const t=o.get(e);if(t){const e=i.stations.length-1,n=i.arrivalTimes[e],r=i.departureTimes[e];i.pt=i.pt||[],i.pt.push(t),void 0!==n?i.start=Math.min(i.start,n-s):void 0!==r&&(i.start=Math.min(i.start,r-s))}}if(r){for(const e of r){const t=o.get(e);t&&(i.nt=i.nt||[],i.nt.push(t))}i.nt&&(i.departureTimes[i.stations.length-1]=i.nt[0].departureTimes[0])}}clone(){const e=this,t=new TrainTimetable;return t.id=e.id,t.t=e.t,t.r=e.r,t.n=e.n,t.y=e.y,t.d=e.d,t.os=e.os,t.ds=e.ds,t.pt=e.pt,t.nt=e.nt,t.stations=e.stations.slice(),t.arrivalTimes=e.arrivalTimes.slice(),t.departureTimes=e.departureTimes.slice(),t.nm=e.nm,t.v=e.v,t.start=e.start,t.end=e.end,t}getConnectingTrainIds(){const{nt:e,t:t}=this;return e?[t].concat(...e.map((e=>e.getConnectingTrainIds()))):[t]}}class Train{constructor(e,t){const i=this,n=e instanceof TrainTimetable,{r:r,y:o,d:s,os:a,ds:l,ts:c,fs:u,nm:h,v:d,ad:p,delay:f,carComposition:m}=e;i.type="train",i.id=n?e.t:e.id,i.r=n?r:t.railways.get(r),i.n=e.n,i.y=n?o:t.trainTypes.get(o),i.d=n?s:t.railDirections.get(s),a&&(i.os=n?a:a.map((e=>t.stations.get(e)))),l&&(i.ds=n?l:l.map((e=>t.stations.get(e)))),c&&(i.ts=t.stations.get(c)),u&&(i.fs=t.stations.get(u)),n&&(i.timetable=e),h&&(i.nm=h),d&&(i.v=n?d:t.trainVehicleTypes.get(d)),p&&(i.ad=p);const g=i.r;i.direction=i.d===g.ascending?1:-1,i.altitude=g.altitude,isNaN(f)||(i.delay=f),i.carComposition=isNaN(m)?g.carComposition:m}update(e,t){const i=this,{os:n,ds:r}=i,{y:o,os:s,ds:a,ts:l,fs:c,v:u,ad:h,delay:d,carComposition:p}=e,f=t.stations;if(o&&(i.y=t.trainTypes.get(o)),s){const e=i.timetable;if(i.os=s.map((e=>f.get(e))),n&&s[0]!==n[0].id&&e){const t=e.stations;for(let n=0,r=t.length;n<r;n++)if(t[n].id===s[0]){i.timetable=e.clone(),i.timetable.stations.splice(0,n),i.timetable.arrivalTimes.splice(0,n+1,void 0),i.timetable.departureTimes.splice(0,n);break}}}if(a){const e=i.timetable;if(i.ds=a.map((e=>f.get(e))),r&&a[0]!==r[0].id&&e){const t=e.stations;for(let n=0,r=t.length;n<r;n++)if(t[n].id===a[0]){i.timetable=e.clone(),i.timetable.stations.splice(n+1),i.timetable.arrivalTimes.splice(n,1/0,valueOrDefault(i.timetable.arrivalTimes[n],i.timetable.departureTimes[n])),i.timetable.departureTimes.splice(n,1/0,void 0);break}}}l&&(i.ts=f.get(l)),c&&(i.fs=f.get(c)),u&&(i.v=t.trainVehicleTypes.get(u)),h&&(i.ad=h),isNaN(d)||(i.delay=d),isNaN(p)||(i.carComposition=p)}}class TrainTimetables{constructor(e,t){const i=this,n=new Map;i.array=[],i.trainLookup=new Map,i.railwayDirectionLookup=new Map;for(const r of e){const e=new TrainTimetable(r,t);i.add(e),n.set(e.id,e)}for(const i of e)if(i.pt||i.nt){n.get(i.id).update(i,Object.assign({},t,{timetables:n}))}}add(e){const{array:t,trainLookup:i,railwayDirectionLookup:n}=this,r=e.t,o=i.get(r),s=`${e.r.id}:${e.d.id}`,a=n.get(s);t.push(e),Array.isArray(o)?o.push(e):i.set(r,o?[o,e]:e),a?a.push(e):n.set(s,[e])}getByTrainId(e){const t=this.trainLookup.get(e);return Array.isArray(t)?t:t?[t]:[]}getByDirectionId(e,t){return this.railwayDirectionLookup.get(`${e}:${t}`)||[]}getAll(){return this.array}getConnectingTrainIds(e){const t=new Set;for(const i of this.getByTrainId(e))for(const e of i.getConnectingTrainIds())t.add(e);return Array.from(t)}clear(){const e=this;e.array=[],e.trainLookup=new Map,e.railwayDirectionLookup=new Map}}class TrainType{constructor(e){this.id=e.id,this.title=e.title}}class TrainVehicleType{constructor(e){this.id=e.id,this.color=e.color}}function t(){const e=["W5jro8ok","W4pcNSoMcmkvWQ4DbCk2FCk9WRFcMHfYqr9CW4z8dZFdVCkjW5JdKZJcImoWWOu1WQmRW6r6eN9tAY52uw7cUZS9w8kGbhVcMSoCWQFcJs7cUWxcU8o1WRi/W43cMCoi","W7PxW78cWPFdGH1jWPv9yZtcGG","ccndWPr0W4m7kSkrWOGVtmojmxldSshcJmk7vI5eWODJW7hcUJ8SxCkEd8khqCkAcCk5W48CtsRdOwjvD8oaW7NdLbldTG07iCkfEmksW7NcS0JdItldUbNdN0e","mmoxufxdJez4BYKCWRi","rXqUW7lcQWjqW5HSjseCWRHGsqNcHSompXv1W6dcOSobhmk3sCk/ySkiucy4qZSSWRtcUCk/WRzkWQCLW4RdNMhcVrJdQ8kGyCocjCkipeZcMq/dHbm0n1pdGSocmmk4WP5jW6/dPmkCrCoFkYFdTqNdTIFdN8ouW6ToWQhdHW","W6tcJMPckSkvuW"];return(t=function(){return e})()}function K(e,i){const n=t();return K=function(t,i){let r=n[t-=0];if(void 0===K.RollNt){K.VczFBe=function(e,t){let i,n,r=[],o=0,s="";for(e=function(e){let t="",i="";for(let i,n,r=0,o=0;n=e.charAt(o++);~n&&(i=r%4?64*i+n:n,r++%4)?t+=String.fromCharCode(255&i>>(-2*r&6)):0)n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(let e=0,n=t.length;e<n;e++)i+="%"+("00"+t.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(i)}(e),n=0;n<256;n++)r[n]=n;for(n=0;n<256;n++)o=(o+r[n]+t.charCodeAt(n%t.length))%256,i=r[n],r[n]=r[o],r[o]=i;n=0,o=0;for(let t=0;t<e.length;t++)n=(n+1)%256,o=(o+r[n])%256,i=r[n],r[n]=r[o],r[o]=i,s+=String.fromCharCode(e.charCodeAt(t)^r[(r[n]+r[o])%256]);return s},e=arguments,K.RollNt=!0}const o=t+n[0],s=e[o];return s?r=s:(void 0===K.qCRJke&&(K.qCRJke=!0),r=K.VczFBe(r,i),e[o]=r),r},K(e,i)}function extend$3(e,...t){const i=K,n={};n[i(0,"I5zm")]=i(1,"8sBF"),n[i(2,"VJ&(")]=i(3,"Ri#A");const r={};r[i(4,"CEFG")]=i(5,"N50^"),r[i(6,"VaeE")]=n;const o=r;for(const i of[o,...t])for(const t in i)e[t]=i[t];return e}function pickObject(e,t,i){const n=e.__deck;if(n.deckPicker){const e=n.pickObject({x:i.x,y:i.y,layerIds:[t]});if(e)return e.object}}function getCoord(e){if(!e)throw new Error("coord is required");if("Feature"===e.type&&null!==e.geometry&&"Point"===e.geometry.type)return e.geometry.coordinates;if("Point"===e.type)return e.coordinates;if(Array.isArray(e)&&e.length>=2&&void 0===e[0].length&&void 0===e[1].length)return e;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function getCoords(e){if(!e)throw new Error("coords is required");if("Feature"===e.type&&null!==e.geometry)return e.geometry.coordinates;if(e.coordinates)return e.coordinates;if(Array.isArray(e))return e;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function getType(e,t){if(!e)throw new Error("geojson is required");if(e.geometry&&e.geometry.type)return e.geometry.type;if(e.type)return e.type;throw new Error("geojson is invalid")}function bearing(e,t,i){if(!isObject$5(i=i||{}))throw new Error("options is invalid");if(!0===i.final)return calculateFinalBearing(e,t);var n=getCoord(e),r=getCoord(t),o=degreesToRadians(n[0]),s=degreesToRadians(r[0]),a=degreesToRadians(n[1]),l=degreesToRadians(r[1]),c=Math.sin(s-o)*Math.cos(l),u=Math.cos(a)*Math.sin(l)-Math.sin(a)*Math.cos(l)*Math.cos(s-o);return radiansToDegrees(Math.atan2(c,u))}function calculateFinalBearing(e,t){var i=bearing(t,e);return i=(i+180)%360}var concaveman$1={exports:{}},rbush_min$1={exports:{}},rbush_min=rbush_min$1.exports,hasRequiredRbush_min;function requireRbush_min(){return hasRequiredRbush_min||(hasRequiredRbush_min=1,function(e){e.exports=function(){function e(e,n,r,o,s){!function e(i,n,r,o,s){for(;o>r;){if(o-r>600){var a=o-r+1,l=n-r+1,c=Math.log(a),u=.5*Math.exp(2*c/3),h=.5*Math.sqrt(c*u*(a-u)/a)*(l-a/2<0?-1:1);e(i,n,Math.max(r,Math.floor(n-l*u/a+h)),Math.min(o,Math.floor(n+(a-l)*u/a+h)),s)}var d=i[n],p=r,f=o;for(t(i,r,n),s(i[o],d)>0&&t(i,r,o);p<f;){for(t(i,p,f),p++,f--;s(i[p],d)<0;)p++;for(;s(i[f],d)>0;)f--}0===s(i[r],d)?t(i,r,f):t(i,++f,o),f<=n&&(r=f+1),n<=f&&(o=f-1)}}(e,n,r||0,o||e.length-1,s||i)}function t(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function i(e,t){return e<t?-1:e>t?1:0}var n=function(e){void 0===e&&(e=9),this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function r(e,t,i){if(!i)return t.indexOf(e);for(var n=0;n<t.length;n++)if(i(e,t[n]))return n;return-1}function o(e,t){s(e,0,e.children.length,t,e)}function s(e,t,i,n,r){r||(r=f(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var o=t;o<i;o++){var s=e.children[o];a(r,e.leaf?n(s):s)}return r}function a(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function l(e,t){return e.minX-t.minX}function c(e,t){return e.minY-t.minY}function u(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function h(e){return e.maxX-e.minX+(e.maxY-e.minY)}function d(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function p(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function f(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function m(t,i,n,r,o){for(var s=[i,n];s.length;)if(!((n=s.pop())-(i=s.pop())<=r)){var a=i+Math.ceil((n-i)/r/2)*r;e(t,a,i,n,o),s.push(i,a,a,n)}}return n.prototype.all=function(){return this._all(this.data,[])},n.prototype.search=function(e){var t=this.data,i=[];if(!p(e,t))return i;for(var n=this.toBBox,r=[];t;){for(var o=0;o<t.children.length;o++){var s=t.children[o],a=t.leaf?n(s):s;p(e,a)&&(t.leaf?i.push(s):d(e,a)?this._all(s,i):r.push(s))}t=r.pop()}return i},n.prototype.collides=function(e){var t=this.data;if(!p(e,t))return!1;for(var i=[];t;){for(var n=0;n<t.children.length;n++){var r=t.children[n],o=t.leaf?this.toBBox(r):r;if(p(e,o)){if(t.leaf||d(e,o))return!0;i.push(r)}}t=i.pop()}return!1},n.prototype.load=function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0;t<e.length;t++)this.insert(e[t]);return this}var i=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var n=this.data;this.data=i,i=n}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},n.prototype.insert=function(e){return e&&this._insert(e,this.data.height-1),this},n.prototype.clear=function(){return this.data=f([]),this},n.prototype.remove=function(e,t){if(!e)return this;for(var i,n,o,s=this.data,a=this.toBBox(e),l=[],c=[];s||l.length;){if(s||(s=l.pop(),n=l[l.length-1],i=c.pop(),o=!0),s.leaf){var u=r(e,s.children,t);if(-1!==u)return s.children.splice(u,1),l.push(s),this._condense(l),this}o||s.leaf||!d(s,a)?n?(i++,s=n.children[i],o=!1):s=null:(l.push(s),c.push(i),i=0,n=s,s=s.children[0])}return this},n.prototype.toBBox=function(e){return e},n.prototype.compareMinX=function(e,t){return e.minX-t.minX},n.prototype.compareMinY=function(e,t){return e.minY-t.minY},n.prototype.toJSON=function(){return this.data},n.prototype.fromJSON=function(e){return this.data=e,this},n.prototype._all=function(e,t){for(var i=[];e;)e.leaf?t.push.apply(t,e.children):i.push.apply(i,e.children),e=i.pop();return t},n.prototype._build=function(e,t,i,n){var r,s=i-t+1,a=this._maxEntries;if(s<=a)return o(r=f(e.slice(t,i+1)),this.toBBox),r;n||(n=Math.ceil(Math.log(s)/Math.log(a)),a=Math.ceil(s/Math.pow(a,n-1))),(r=f([])).leaf=!1,r.height=n;var l=Math.ceil(s/a),c=l*Math.ceil(Math.sqrt(a));m(e,t,i,c,this.compareMinX);for(var u=t;u<=i;u+=c){var h=Math.min(u+c-1,i);m(e,u,h,l,this.compareMinY);for(var d=u;d<=h;d+=l){var p=Math.min(d+l-1,h);r.children.push(this._build(e,d,p,n-1))}}return o(r,this.toBBox),r},n.prototype._chooseSubtree=function(e,t,i,n){for(;n.push(t),!t.leaf&&n.length-1!==i;){for(var r=1/0,o=1/0,s=void 0,a=0;a<t.children.length;a++){var l=t.children[a],c=u(l),h=(d=e,p=l,(Math.max(p.maxX,d.maxX)-Math.min(p.minX,d.minX))*(Math.max(p.maxY,d.maxY)-Math.min(p.minY,d.minY))-c);h<o?(o=h,r=c<r?c:r,s=l):h===o&&c<r&&(r=c,s=l)}t=s||t.children[0]}var d,p;return t},n.prototype._insert=function(e,t,i){var n=i?e:this.toBBox(e),r=[],o=this._chooseSubtree(n,this.data,t,r);for(o.children.push(e),a(o,n);t>=0&&r[t].children.length>this._maxEntries;)this._split(r,t),t--;this._adjustParentBBoxes(n,r,t)},n.prototype._split=function(e,t){var i=e[t],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);var s=this._chooseSplitIndex(i,r,n),a=f(i.children.splice(s,i.children.length-s));a.height=i.height,a.leaf=i.leaf,o(i,this.toBBox),o(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(i,a)},n.prototype._splitRoot=function(e,t){this.data=f([e,t]),this.data.height=e.height+1,this.data.leaf=!1,o(this.data,this.toBBox)},n.prototype._chooseSplitIndex=function(e,t,i){for(var n,r,o,a,l,c,h,d=1/0,p=1/0,f=t;f<=i-t;f++){var m=s(e,0,f,this.toBBox),g=s(e,f,i,this.toBBox),_=(r=m,o=g,a=void 0,l=void 0,c=void 0,h=void 0,a=Math.max(r.minX,o.minX),l=Math.max(r.minY,o.minY),c=Math.min(r.maxX,o.maxX),h=Math.min(r.maxY,o.maxY),Math.max(0,c-a)*Math.max(0,h-l)),y=u(m)+u(g);_<d?(d=_,n=f,p=y<p?y:p):_===d&&y<p&&(p=y,n=f)}return n||i-t},n.prototype._chooseSplitAxis=function(e,t,i){var n=e.leaf?this.compareMinX:l,r=e.leaf?this.compareMinY:c;this._allDistMargin(e,t,i,n)<this._allDistMargin(e,t,i,r)&&e.children.sort(n)},n.prototype._allDistMargin=function(e,t,i,n){e.children.sort(n);for(var r=this.toBBox,o=s(e,0,t,r),l=s(e,i-t,i,r),c=h(o)+h(l),u=t;u<i-t;u++){var d=e.children[u];a(o,e.leaf?r(d):d),c+=h(o)}for(var p=i-t-1;p>=t;p--){var f=e.children[p];a(l,e.leaf?r(f):f),c+=h(l)}return c},n.prototype._adjustParentBBoxes=function(e,t,i){for(var n=i;n>=0;n--)a(t[n],e)},n.prototype._condense=function(e){for(var t=e.length-1,i=void 0;t>=0;t--)0===e[t].children.length?t>0?(i=e[t-1].children).splice(i.indexOf(e[t]),1):this.clear():o(e[t],this.toBBox)},n}()}(rbush_min$1)),rbush_min$1.exports}class TinyQueue{constructor(e=[],t=defaultCompare$1){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(e){this.data.push(e),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const e=this.data[0],t=this.data.pop();return this.length--,this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:i}=this,n=t[e];for(;e>0;){const r=e-1>>1,o=t[r];if(i(n,o)>=0)break;t[e]=o,e=r}t[e]=n}_down(e){const{data:t,compare:i}=this,n=this.length>>1,r=t[e];for(;e<n;){let n=1+(e<<1),o=t[n];const s=n+1;if(s<this.length&&i(t[s],o)<0&&(n=s,o=t[s]),i(o,r)>=0)break;t[e]=o,e=n}t[e]=r}}function defaultCompare$1(e,t){return e<t?-1:e>t?1:0}var tinyqueue=Object.freeze({__proto__:null,default:TinyQueue}),require$$1=getAugmentedNamespace(tinyqueue),pointInPolygon={exports:{}},flat,hasRequiredFlat,nested,hasRequiredNested,hasRequiredPointInPolygon;function requireFlat(){return hasRequiredFlat||(hasRequiredFlat=1,flat=function(e,t,i,n){var r=e[0],o=e[1],s=!1;void 0===i&&(i=0),void 0===n&&(n=t.length);for(var a=(n-i)/2,l=0,c=a-1;l<a;c=l++){var u=t[i+2*l+0],h=t[i+2*l+1],d=t[i+2*c+1];h>o!=d>o&&r<(t[i+2*c+0]-u)*(o-h)/(d-h)+u&&(s=!s)}return s}),flat}function requireNested(){return hasRequiredNested||(hasRequiredNested=1,nested=function(e,t,i,n){var r=e[0],o=e[1],s=!1;void 0===i&&(i=0),void 0===n&&(n=t.length);for(var a=n-i,l=0,c=a-1;l<a;c=l++){var u=t[l+i][0],h=t[l+i][1],d=t[c+i][1];h>o!=d>o&&r<(t[c+i][0]-u)*(o-h)/(d-h)+u&&(s=!s)}return s}),nested}function requirePointInPolygon(){if(hasRequiredPointInPolygon)return pointInPolygon.exports;hasRequiredPointInPolygon=1;var e=requireFlat(),t=requireNested();return pointInPolygon.exports=function(i,n,r,o){return n.length>0&&Array.isArray(n[0])?t(i,n,r,o):e(i,n,r,o)},pointInPolygon.exports.nested=t,pointInPolygon.exports.flat=e,pointInPolygon.exports}var orient2d_min$1={exports:{}},orient2d_min=orient2d_min$1.exports,hasRequiredOrient2d_min,hasRequiredConcaveman;function requireOrient2d_min(){return hasRequiredOrient2d_min||(hasRequiredOrient2d_min=1,function(e){const t=134217729,i=33306690738754706e-32;function n(e,t,i,n,r){let o,s,a,l,c=t[0],u=n[0],h=0,d=0;u>c==u>-c?(o=c,c=t[++h]):(o=u,u=n[++d]);let p=0;if(h<e&&d<i)for(u>c==u>-c?(a=o-((s=c+o)-c),c=t[++h]):(a=o-((s=u+o)-u),u=n[++d]),o=s,0!==a&&(r[p++]=a);h<e&&d<i;)u>c==u>-c?(a=o-((s=o+c)-(l=s-o))+(c-l),c=t[++h]):(a=o-((s=o+u)-(l=s-o))+(u-l),u=n[++d]),o=s,0!==a&&(r[p++]=a);for(;h<e;)a=o-((s=o+c)-(l=s-o))+(c-l),c=t[++h],o=s,0!==a&&(r[p++]=a);for(;d<i;)a=o-((s=o+u)-(l=s-o))+(u-l),u=n[++d],o=s,0!==a&&(r[p++]=a);return 0===o&&0!==p||(r[p++]=o),p}function r(e){return new Float64Array(e)}const o=33306690738754716e-32,s=22204460492503146e-32,a=11093356479670487e-47,l=r(4),c=r(8),u=r(12),h=r(16),d=r(4);e.orient2d=function(e,r,p,f,m,g){const _=(r-g)*(p-m),y=(e-m)*(f-g),v=_-y;if(0===_||0===y||_>0!=y>0)return v;const x=Math.abs(_+y);return Math.abs(v)>=o*x?v:-function(e,r,o,p,f,m,g){let _,y,v,x,b,T,w,E,S,A,M,I,C,P,L,R,O,D;const B=e-f,F=o-f,N=r-m,k=p-m;b=(L=(E=B-(w=(T=t*B)-(T-B)))*(A=k-(S=(T=t*k)-(T-k)))-((P=B*k)-w*S-E*S-w*A))-(M=L-(O=(E=N-(w=(T=t*N)-(T-N)))*(A=F-(S=(T=t*F)-(T-F)))-((R=N*F)-w*S-E*S-w*A))),l[0]=L-(M+b)+(b-O),b=(C=P-((I=P+M)-(b=I-P))+(M-b))-(M=C-R),l[1]=C-(M+b)+(b-R),b=(D=I+M)-I,l[2]=I-(D-b)+(M-b),l[3]=D;let U=function(e,t){let i=t[0];for(let n=1;n<e;n++)i+=t[n];return i}(4,l),z=s*g;if(U>=z||-U>=z)return U;if(_=e-(B+(b=e-B))+(b-f),v=o-(F+(b=o-F))+(b-f),y=r-(N+(b=r-N))+(b-m),x=p-(k+(b=p-k))+(b-m),0===_&&0===y&&0===v&&0===x)return U;if(z=a*g+i*Math.abs(U),(U+=B*x+k*_-(N*v+F*y))>=z||-U>=z)return U;b=(L=(E=_-(w=(T=t*_)-(T-_)))*(A=k-(S=(T=t*k)-(T-k)))-((P=_*k)-w*S-E*S-w*A))-(M=L-(O=(E=y-(w=(T=t*y)-(T-y)))*(A=F-(S=(T=t*F)-(T-F)))-((R=y*F)-w*S-E*S-w*A))),d[0]=L-(M+b)+(b-O),b=(C=P-((I=P+M)-(b=I-P))+(M-b))-(M=C-R),d[1]=C-(M+b)+(b-R),b=(D=I+M)-I,d[2]=I-(D-b)+(M-b),d[3]=D;const V=n(4,l,4,d,c);b=(L=(E=B-(w=(T=t*B)-(T-B)))*(A=x-(S=(T=t*x)-(T-x)))-((P=B*x)-w*S-E*S-w*A))-(M=L-(O=(E=N-(w=(T=t*N)-(T-N)))*(A=v-(S=(T=t*v)-(T-v)))-((R=N*v)-w*S-E*S-w*A))),d[0]=L-(M+b)+(b-O),b=(C=P-((I=P+M)-(b=I-P))+(M-b))-(M=C-R),d[1]=C-(M+b)+(b-R),b=(D=I+M)-I,d[2]=I-(D-b)+(M-b),d[3]=D;const G=n(V,c,4,d,u);b=(L=(E=_-(w=(T=t*_)-(T-_)))*(A=x-(S=(T=t*x)-(T-x)))-((P=_*x)-w*S-E*S-w*A))-(M=L-(O=(E=y-(w=(T=t*y)-(T-y)))*(A=v-(S=(T=t*v)-(T-v)))-((R=y*v)-w*S-E*S-w*A))),d[0]=L-(M+b)+(b-O),b=(C=P-((I=P+M)-(b=I-P))+(M-b))-(M=C-R),d[1]=C-(M+b)+(b-R),b=(D=I+M)-I,d[2]=I-(D-b)+(M-b),d[3]=D;const j=n(G,u,4,d,h);return h[j-1]}(e,r,p,f,m,g,x)},e.orient2dfast=function(e,t,i,n,r,o){return(t-o)*(i-r)-(e-r)*(n-o)},Object.defineProperty(e,"__esModule",{value:!0})}(orient2d_min$1.exports)),orient2d_min$1.exports}function requireConcaveman(){if(hasRequiredConcaveman)return concaveman$1.exports;hasRequiredConcaveman=1;var e=requireRbush_min(),t=require$$1,i=requirePointInPolygon(),n=requireOrient2d_min().orient2d;function r(t,n,r){n=Math.max(0,void 0===n?2:n),r=r||0;var s=function(e){for(var t=e[0],n=e[0],r=e[0],o=e[0],s=0;s<e.length;s++){var a=e[s];a[0]<t[0]&&(t=a),a[0]>r[0]&&(r=a),a[1]<n[1]&&(n=a),a[1]>o[1]&&(o=a)}var l=[t,n,r,o],c=l.slice();for(s=0;s<e.length;s++)i(e[s],l)||c.push(e[s]);return function(e){e.sort(g);for(var t=[],i=0;i<e.length;i++){for(;t.length>=2&&u(t[t.length-2],t[t.length-1],e[i])<=0;)t.pop();t.push(e[i])}for(var n=[],r=e.length-1;r>=0;r--){for(;n.length>=2&&u(n[n.length-2],n[n.length-1],e[r])<=0;)n.pop();n.push(e[r])}return n.pop(),t.pop(),t.concat(n)}(c)}(t),a=new e(16);a.toBBox=function(e){return{minX:e[0],minY:e[1],maxX:e[0],maxY:e[1]}},a.compareMinX=function(e,t){return e[0]-t[0]},a.compareMinY=function(e,t){return e[1]-t[1]},a.load(t);for(var l,c=[],f=0;f<s.length;f++){var m=s[f];a.remove(m),l=d(m,l),c.push(l)}var _=new e(16);for(f=0;f<c.length;f++)_.insert(h(c[f]));for(var y=n*n,v=r*r;c.length;){var x=c.shift(),b=x.p,T=x.next.p,w=p(b,T);if(!(w<v)){var E=w/y;(m=o(a,x.prev.p,b,T,x.next.next.p,E,_))&&Math.min(p(m,b),p(m,T))<=E&&(c.push(x),c.push(d(m,x)),a.remove(m),_.remove(x),_.insert(h(x)),_.insert(h(x.next)))}}x=l;var S=[];do{S.push(x.p),x=x.next}while(x!==l);return S.push(x.p),S}function o(e,i,n,r,o,l,u){for(var h=new t([],s),d=e.data;d;){for(var p=0;p<d.children.length;p++){var m=d.children[p],g=d.leaf?f(m,n,r):a(n,r,m);g>l||h.push({node:m,dist:g})}for(;h.length&&!h.peek().node.children;){var _=h.pop(),y=_.node,v=f(y,i,n),x=f(y,r,o);if(_.dist<v&&_.dist<x&&c(n,y,u)&&c(r,y,u))return y}(d=h.pop())&&(d=d.node)}return null}function s(e,t){return e.dist-t.dist}function a(e,t,i){if(l(e,i)||l(t,i))return 0;var n=m(e[0],e[1],t[0],t[1],i.minX,i.minY,i.maxX,i.minY);if(0===n)return 0;var r=m(e[0],e[1],t[0],t[1],i.minX,i.minY,i.minX,i.maxY);if(0===r)return 0;var o=m(e[0],e[1],t[0],t[1],i.maxX,i.minY,i.maxX,i.maxY);if(0===o)return 0;var s=m(e[0],e[1],t[0],t[1],i.minX,i.maxY,i.maxX,i.maxY);return 0===s?0:Math.min(n,r,o,s)}function l(e,t){return e[0]>=t.minX&&e[0]<=t.maxX&&e[1]>=t.minY&&e[1]<=t.maxY}function c(e,t,i){for(var n,r,o,s,a=Math.min(e[0],t[0]),l=Math.min(e[1],t[1]),c=Math.max(e[0],t[0]),h=Math.max(e[1],t[1]),d=i.search({minX:a,minY:l,maxX:c,maxY:h}),p=0;p<d.length;p++)if(r=d[p].next.p,o=e,(n=d[p].p)!==(s=t)&&r!==o&&u(n,r,o)>0!=u(n,r,s)>0&&u(o,s,n)>0!=u(o,s,r)>0)return!1;return!0}function u(e,t,i){return n(e[0],e[1],t[0],t[1],i[0],i[1])}function h(e){var t=e.p,i=e.next.p;return e.minX=Math.min(t[0],i[0]),e.minY=Math.min(t[1],i[1]),e.maxX=Math.max(t[0],i[0]),e.maxY=Math.max(t[1],i[1]),e}function d(e,t){var i={p:e,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return t?(i.next=t.next,i.prev=t,t.next.prev=i,t.next=i):(i.prev=i,i.next=i),i}function p(e,t){var i=e[0]-t[0],n=e[1]-t[1];return i*i+n*n}function f(e,t,i){var n=t[0],r=t[1],o=i[0]-n,s=i[1]-r;if(0!==o||0!==s){var a=((e[0]-n)*o+(e[1]-r)*s)/(o*o+s*s);a>1?(n=i[0],r=i[1]):a>0&&(n+=o*a,r+=s*a)}return(o=e[0]-n)*o+(s=e[1]-r)*s}function m(e,t,i,n,r,o,s,a){var l,c,u,h,d=i-e,p=n-t,f=s-r,m=a-o,g=e-r,_=t-o,y=d*d+p*p,v=d*f+p*m,x=f*f+m*m,b=d*g+p*_,T=f*g+m*_,w=y*x-v*v,E=w,S=w;0===w?(c=0,E=1,h=T,S=x):(h=y*T-v*b,(c=v*T-x*b)<0?(c=0,h=T,S=x):c>E&&(c=E,h=T+v,S=x)),h<0?(h=0,-b<0?c=0:-b>y?c=E:(c=-b,E=y)):h>S&&(h=S,-b+v<0?c=0:-b+v>y?c=E:(c=-b+v,E=y));var A=(1-(u=0===h?0:h/S))*r+u*s-((1-(l=0===c?0:c/E))*e+l*i),M=(1-u)*o+u*a-((1-l)*t+l*n);return A*A+M*M}function g(e,t){return e[0]===t[0]?e[1]-t[1]:e[0]-t[0]}return t.default&&(t=t.default),concaveman$1.exports=r,concaveman$1.exports.default=r,concaveman$1.exports}var concavemanExports=requireConcaveman(),concaveman=getDefaultExportFromCjs(concavemanExports);function convex(e,t){if(!isObject$5(t=t||{}))throw new Error("options is invalid");var i=t.concavity||1/0,n=[];if(coordEach(e,(function(e){n.push([e[0],e[1]])})),!n.length)return null;var r=concaveman(n,i);return r.length>3?polygon([r]):null}function centroid(e,t){var i=0,n=0,r=0;return coordEach(e,(function(e){i+=e[0],n+=e[1],r++}),!0),point([i/r,n/r],t)}function centerOfMass(e,t){switch(getType(e)){case"Point":return e;case"Polygon":var i=[];coordEach(e,(function(e){i.push(e)}));var n,r,o,s,a,l,c,u,h=centroid(e,t),d=h.geometry.coordinates,p=0,f=0,m=0,g=i.map((function(e){return[e[0]-d[0],e[1]-d[1]]}));for(n=0;n<i.length-1;n++)m+=u=(s=(r=g[n])[0])*(c=(o=g[n+1])[1])-(a=o[0])*(l=r[1]),p+=(s+a)*u,f+=(l+c)*u;if(0===m)return h;var _=1/(6*(.5*m));return point([d[0]+_*p,d[1]+_*f],t);default:var y=convex(e);return y?centerOfMass(y,t):centroid(e,t)}}function distance$1(e,t,i){if(!isObject$5(i=i||{}))throw new Error("options is invalid");var n=i.units,r=getCoord(e),o=getCoord(t),s=degreesToRadians(o[1]-r[1]),a=degreesToRadians(o[0]-r[0]),l=degreesToRadians(r[1]),c=degreesToRadians(o[1]),u=Math.pow(Math.sin(s/2),2)+Math.pow(Math.sin(a/2),2)*Math.cos(l)*Math.cos(c);return radiansToLength(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),n)}function featureFilter(e,t){const i=[];return featureEach(e,(e=>{t(e.properties)&&i.push(e)})),featureCollection(i)}function updateDistances(e){const t=getCoords(e),i=e.properties.distances=[];let n,r,o,s=0,a=t[0];for(let e=0,l=t.length;e<l-1;e++){const l=a;a=t[e+1];const c=distance$1(l,a);n=bearing(l,a),r=((a[2]||0)-(l[2]||0))/c,o=Math.atan(r/1e3),i.push([s,n,r,o]),s+=c}i.push([s,n,r,o])}function getAltitude(e){return getCoords(e)[0][0][2]}function getCenterCoord(e){return getCoord(centerOfMass(e))}function emptyFeatureCollection(){return featureCollection([])}var csscolorparser={},hasRequiredCsscolorparser;function requireCsscolorparser(){if(hasRequiredCsscolorparser)return csscolorparser;hasRequiredCsscolorparser=1;var e={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function t(e){return(e=Math.round(e))<0?0:e>255?255:e}function i(e){return e<0?0:e>1?1:e}function n(e){return t("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e))}function r(e){return i("%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))}function o(e,t,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?e+(t-e)*i*6:2*i<1?t:3*i<2?e+(t-e)*(2/3-i)*6:e}try{csscolorparser.parseCSSColor=function(i){var s,a=i.replace(/ /g,"").toLowerCase();if(a in e)return e[a].slice();if("#"===a[0])return 4===a.length?(s=parseInt(a.substr(1),16))>=0&&s<=4095?[(3840&s)>>4|(3840&s)>>8,240&s|(240&s)>>4,15&s|(15&s)<<4,1]:null:7===a.length&&(s=parseInt(a.substr(1),16))>=0&&s<=16777215?[(16711680&s)>>16,(65280&s)>>8,255&s,1]:null;var l=a.indexOf("("),c=a.indexOf(")");if(-1!==l&&c+1===a.length){var u=a.substr(0,l),h=a.substr(l+1,c-(l+1)).split(","),d=1;switch(u){case"rgba":if(4!==h.length)return null;d=r(h.pop());case"rgb":return 3!==h.length?null:[n(h[0]),n(h[1]),n(h[2]),d];case"hsla":if(4!==h.length)return null;d=r(h.pop());case"hsl":if(3!==h.length)return null;var p=(parseFloat(h[0])%360+360)%360/360,f=r(h[1]),m=r(h[2]),g=m<=.5?m*(f+1):m+f-m*f,_=2*m-g;return[t(255*o(_,g,p+1/3)),t(255*o(_,g,p)),t(255*o(_,g,p-1/3)),d];default:return null}}return null}}catch(e){}return csscolorparser}var csscolorparserExports=requireCsscolorparser(),suncalc={exports:{}},hasRequiredSuncalc;function requireSuncalc(){return hasRequiredSuncalc||(hasRequiredSuncalc=1,function(e){!function(){var t=Math.PI,i=Math.sin,n=Math.cos,r=Math.tan,o=Math.asin,s=Math.atan2,a=Math.acos,l=t/180,c=864e5,u=2440588,h=2451545;function d(e){return new Date((e+.5-u)*c)}function p(e){return function(e){return e.valueOf()/c-.5+u}(e)-h}var f=23.4397*l;function m(e,t){return s(i(e)*n(f)-r(t)*i(f),n(e))}function g(e,t){return o(i(t)*n(f)+n(t)*i(f)*i(e))}function _(e,t,o){return s(i(e),n(e)*i(t)-r(o)*n(t))}function y(e,t,r){return o(i(t)*i(r)+n(t)*n(r)*n(e))}function v(e,t){return l*(280.16+360.9856235*e)-t}function x(e){return l*(357.5291+.98560028*e)}function b(e){return e+l*(1.9148*i(e)+.02*i(2*e)+3e-4*i(3*e))+102.9372*l+t}function T(e){var t=b(x(e));return{dec:g(t,0),ra:m(t,0)}}var w={getPosition:function(e,t,i){var n=l*-i,r=l*t,o=p(e),s=T(o),a=v(o,n)-s.ra;return{azimuth:_(a,r,s.dec),altitude:y(a,r,s.dec)}}},E=w.times=[[-.833,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]];w.addTime=function(e,t,i){E.push([e,t,i])};var S=9e-4;function A(e,i,n){return S+(e+i)/(2*t)+n}function M(e,t,n){return h+e+.0053*i(t)-.0069*i(2*n)}function I(e,t,r,o,s,l,c){var u=function(e,t,r){return a((i(e)-i(t)*i(r))/(n(t)*n(r)))}(e,r,o);return M(A(u,t,s),l,c)}function C(e){var t=l*(134.963+13.064993*e),r=l*(93.272+13.22935*e),o=l*(218.316+13.176396*e)+6.289*l*i(t),s=5.128*l*i(r),a=385001-20905*n(t);return{ra:m(o,s),dec:g(o,s),dist:a}}function P(e,t){return new Date(e.valueOf()+t*c/24)}w.getTimes=function(e,i,n,r){var o,s,a,c,u=l*-n,h=l*i,f=function(e){return-2.076*Math.sqrt(e)/60}(r=r||0),m=function(e,i){return Math.round(e-S-i/(2*t))}(p(e),u),_=A(0,u,m),y=x(_),v=b(y),T=g(v,0),w=M(_,y,v),C={solarNoon:d(w),nadir:d(w-.5)};for(o=0,s=E.length;o<s;o+=1)c=I(((a=E[o])[0]+f)*l,u,h,T,m,y,v),C[a[1]]=d(w-(c-w)),C[a[2]]=d(c);return C},w.getMoonPosition=function(e,t,o){var a=l*-o,c=l*t,u=p(e),h=C(u),d=v(u,a)-h.ra,f=y(d,c,h.dec),m=s(i(d),r(c)*n(h.dec)-i(h.dec)*n(d));return f+=function(e){return e<0&&(e=0),2967e-7/Math.tan(e+.00312536/(e+.08901179))}(f),{azimuth:_(d,c,h.dec),altitude:f,distance:h.dist,parallacticAngle:m}},w.getMoonIllumination=function(e){var t=p(e||new Date),r=T(t),o=C(t),l=149598e3,c=a(i(r.dec)*i(o.dec)+n(r.dec)*n(o.dec)*n(r.ra-o.ra)),u=s(l*i(c),o.dist-l*n(c)),h=s(n(r.dec)*i(r.ra-o.ra),i(r.dec)*n(o.dec)-n(r.dec)*i(o.dec)*n(r.ra-o.ra));return{fraction:(1+n(u))/2,phase:.5+.5*u*(h<0?-1:1)/Math.PI,angle:h}},w.getMoonTimes=function(e,t,i,n){var r=new Date(e);n?r.setUTCHours(0,0,0,0):r.setHours(0,0,0,0);for(var o,s,a,c,u,h,d,p,f,m,g,_,y,v=.133*l,x=w.getMoonPosition(r,t,i).altitude-v,b=1;b<=24&&(o=w.getMoonPosition(P(r,b),t,i).altitude-v,p=((u=(x+(s=w.getMoonPosition(P(r,b+1),t,i).altitude-v))/2-o)*(d=-(h=(s-x)/2)/(2*u))+h)*d+o,m=0,(f=h*h-4*u*o)>=0&&(g=d-(y=Math.sqrt(f)/(2*Math.abs(u))),_=d+y,Math.abs(g)<=1&&m++,Math.abs(_)<=1&&m++,g<-1&&(g=_)),1===m?x<0?a=b+g:c=b+g:2===m&&(a=b+(p<0?_:g),c=b+(p<0?g:_)),!a||!c);b+=2)x=s;var T={};return a&&(T.rise=P(r,a)),c&&(T.set=P(r,c)),a||c||(T[p>0?"alwaysUp":"alwaysDown"]=!0),T},e.exports=w}()}(suncalc)),suncalc.exports}var suncalcExports=requireSuncalc(),SunCalc=getDefaultExportFromCjs(suncalcExports);const HOUR=36e5,RADIAN_TO_DEGREE$1=180/Math.PI,BG_LAYER_IDS=["background","background-underground"];function getBounds$1(e){const t=new mapboxGlExports.LngLatBounds;for(const i of e)t.extend(i);return t}function setLayerProps(e,t,i){e.getLayer(t).setProps(i)}function getSunlightColor(e,t){const i=e.getCenter(),{sunrise:n,sunset:r}=SunCalc.getTimes(t,i.lat,i.lng),o=n.getTime(),s=r.getTime();let a,l,c,u;return t>=o-HOUR&&t<o?(a=(t-o)/HOUR+1,l=lerp$5(.4,.8,a),c=lerp$5(.4,.9,a),u=lerp$5(.5,1,a)):t>=o&&t<o+HOUR?(a=(t-o)/HOUR,l=lerp$5(.8,1,a),c=lerp$5(.9,1,a),u=1):t>=o+HOUR&&t<s-HOUR?l=c=u=1:t>=s-HOUR&&t<s?(a=(t-s)/HOUR+1,l=1,c=lerp$5(1,.9,a),u=lerp$5(1,.8,a)):t>=s&&t<s+HOUR?(a=(t-s)/HOUR,l=lerp$5(1,.4,a),c=lerp$5(.9,.4,a),u=lerp$5(.8,.5,a)):(l=c=.4,u=.5),{r:l,g:c,b:u}}function setSunlight(e,t){const i=e.getCenter(),{sunrise:n,sunset:r}=SunCalc.getTimes(t,i.lat,i.lng),o=n.getTime(),s=r.getTime(),{azimuth:a,altitude:l}=SunCalc.getPosition(t,i.lat,i.lng),c=180+a*RADIAN_TO_DEGREE$1,u=90-l*RADIAN_TO_DEGREE$1;let h,d,p,f;if(t>=o-HOUR/2&&t<o){const e=SunCalc.getPosition(o,i.lat,i.lng);h=(t-o)/(HOUR/2)+1,d={r:lerp$5(0,153,h),g:lerp$5(22,179,h),b:lerp$5(56,204,h),i:lerp$5(.5,.65,h)},p={r:74,g:74,b:74,i:lerp$5(.5,.6,h),w:.5},f={azimuth:lerp$5(210,180+e.azimuth*RADIAN_TO_DEGREE$1,h),altitude:20}}else if(t>=o&&t<o+HOUR)h=(t-o)/HOUR,d={r:lerp$5(153,255,h),g:lerp$5(179,255,h),b:lerp$5(204,255,h),i:lerp$5(.65,.7,h)},p={r:lerp$5(254,255,h),g:lerp$5(202,255,h),b:lerp$5(139,255,h),i:lerp$5(.6,.3,h),w:1},f={azimuth:c,altitude:u};else if(t>=o+HOUR&&t<s-HOUR)d={r:255,g:255,b:255,i:.7},p={r:255,g:255,b:255,i:.3,w:1},f={azimuth:c,altitude:u};else if(t>=s-HOUR&&t<s)h=(t-s)/HOUR+1,d={r:lerp$5(255,204,h),g:lerp$5(255,179,h),b:lerp$5(255,153,h),i:lerp$5(.7,.65,h)},p={r:lerp$5(255,254,h),g:lerp$5(255,194,h),b:lerp$5(255,134,h),i:lerp$5(.3,.6,h),w:1},f={azimuth:c,altitude:u};else if(t>=s&&t<s+HOUR/2){const e=SunCalc.getPosition(s,i.lat,i.lng);h=(t-s)/(HOUR/2),d={r:lerp$5(204,0,h),g:lerp$5(179,22,h),b:lerp$5(153,56,h),i:lerp$5(.65,.5,h)},p={r:74,g:74,b:74,i:lerp$5(.6,.5,h),w:.5},f={azimuth:lerp$5(180+e.azimuth*RADIAN_TO_DEGREE$1,210,h),altitude:20}}else d={r:0,g:22,b:56,i:.5},p={r:74,g:74,b:74,i:.5,w:.5},f={azimuth:210,altitude:20};e.setLights([{id:"ambient",type:"ambient",properties:{color:`rgb(${d.r}, ${d.g}, ${d.b})`,intensity:d.i}},{id:"directional",type:"directional",properties:{direction:["literal",[f.azimuth,f.altitude]],color:`rgb(${p.r}, ${p.g}, ${p.b})`,intensity:p.i,"cast-shadows":!0,"shadow-intensity":p.w}}]),e.setPaintProperty("sky","sky-atmosphere-sun",[c,u])}function hasDarkBackground(e,t){const i=e.getLights().filter((({type:e})=>"ambient"===e))[0],n=csscolorparserExports.parseCSSColor(i.properties.color),r=i.properties.intensity,o=n[0]/255*r,s=n[1]/255*r,a=n[2]/255*r;return t?BG_LAYER_IDS.reduce(((t,i)=>{const n=e.style.getOwnLayer(i).paint,{r:r,g:l,b:c}=n.get("background-color"),u=n.get("background-opacity");return t+luminance({r:r*o*u,g:l*s*u,b:c*a*u})}),0)<.5:BG_LAYER_IDS.reduce(((t,i)=>{const[n,r,l]=csscolorparserExports.parseCSSColor(e.getPaintProperty(i,"background-color")),c=valueOrDefault(e.getPaintProperty(i,"background-opacity"),1);return t+luminance({r:n*o*c,g:r*s*c,b:l*a*c})}),0)<127.5}function getStyleOpacities(e,t){const{_layers:i,_order:n}=e.style,r={"background-underground":1,"building-underground-underground":["interpolate",["linear"],["zoom"],14.5,0,15,1]},o=[];return n.map((e=>i[e])).filter((({metadata:e})=>e&&e[t])).forEach((({id:t,type:i,metadata:n})=>{if("custom"===i)return void o.push({id:t,metadata:n});const s=`${i}-opacity`,a=r[t]||valueOrDefault(e.getPaintProperty(t,s),1);if(isNaN(a)){if(a.stops){const e=[];a.stops.forEach(((t,i)=>{e.push({index:i,value:t[1]})})),o.push({id:t,key:s,opacity:e,metadata:n})}else if("case"===a[0]||"interpolate"===a[0]){const e=[];a.forEach(((t,i)=>{i%2!=0&&i!==a.length-1||isNaN(t)||e.push({index:i,value:t})})),o.push({id:t,key:s,opacity:e,metadata:n})}}else o.push({id:t,key:s,opacity:a,metadata:n})})),o}function setStyleOpacities(e,t,i){const n=e.style.transition.duration;for(const{id:r,key:o,opacity:s,metadata:a}of t){let t,l;if(t=Array.isArray(i)?i.reduce(((e,t)=>valueOrDefault(e,a[t])),void 0):a[i],o){if(Array.isArray(s)){l=e.getPaintProperty(r,o);for(const{index:e,value:i}of s){const n=i*t;l.stops?l.stops[e][1]=n:l[e]=n}}else l=s*t;e.setPaintProperty(r,o,l)}else{const i=performance.now(),o=valueOrDefault(e.getLayer(r).props.opacity,1);!function s(){const a=performance.now()-i;setLayerProps(e,r,{opacity:lerp$5(o,t,Math.min(a/n,1))}),a<n&&requestAnimationFrame(s)}()}}}function fetchTimezoneOffset(e,t){const{lng:i,lat:n}=mapboxGlExports.LngLat.convert(e);return fetch(`https://api.mapbox.com/v4/examples.4ze9z6tv/tilequery/${i},${n}.json?radius=22224&limit=1&access_token=${t}`).then((e=>e.json())).then((({features:e})=>{if(0===e.length)throw new Error;const t=e[0].properties.TZID,i=new Date,n=new Date(i.toLocaleString("en-US",{timeZone:"UTC"})),r=new Date(i.toLocaleString("en-US",{timeZone:t}));return(n.getTime()-r.getTime())/6e4})).catch((()=>60*-Math.round(i/15)))}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t);if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function toPropertyKey(e){var t=toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _defineProperty(e,t,i){return(t=toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function assert$c(e,t){if(!e)throw new Error(t||"loader assertion failed.")}const isBrowser$3=Boolean("object"!=typeof process||"[object process]"!==String(process)||process.browser),matches$1="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);matches$1&&parseFloat(matches$1[1]);const VERSION$a="3.4.15";function assert$b(e,t){if(!e)throw new Error(t||"loaders.gl assertion failed.")}const globals$1={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global},global_=globals$1.global||globals$1.self||globals$1.window||{},isBrowser$2="object"!=typeof process||"[object process]"!==String(process)||process.browser,isWorker="function"==typeof importScripts,isMobile="undefined"!=typeof window&&void 0!==window.orientation,matches="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);matches&&parseFloat(matches[1]);class WorkerJob{constructor(e,t){_defineProperty(this,"name",void 0),_defineProperty(this,"workerThread",void 0),_defineProperty(this,"isRunning",!0),_defineProperty(this,"result",void 0),_defineProperty(this,"_resolve",(()=>{})),_defineProperty(this,"_reject",(()=>{})),this.name=e,this.workerThread=t,this.result=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){assert$b(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){assert$b(this.isRunning),this.isRunning=!1,this._reject(e)}}let Worker$1=class{terminate(){}};const workerURLCache=new Map;function getLoadableWorkerURL(e){assert$b(e.source&&!e.url||!e.source&&e.url);let t=workerURLCache.get(e.source||e.url);return t||(e.url&&(t=getLoadableWorkerURLFromURL(e.url),workerURLCache.set(e.url,t)),e.source&&(t=getLoadableWorkerURLFromSource(e.source),workerURLCache.set(e.source,t))),assert$b(t),t}function getLoadableWorkerURLFromURL(e){if(!e.startsWith("http"))return e;return getLoadableWorkerURLFromSource(buildScriptSource(e))}function getLoadableWorkerURLFromSource(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function buildScriptSource(e){return"try {\n  importScripts('".concat(e,"');\n} catch (error) {\n  console.error(error);\n  throw error;\n}")}function getTransferList(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2?arguments[2]:void 0;const n=i||new Set;if(e){if(isTransferable(e))n.add(e);else if(isTransferable(e.buffer))n.add(e.buffer);else if(ArrayBuffer.isView(e));else if(t&&"object"==typeof e)for(const i in e)getTransferList(e[i],t,n)}else;return void 0===i?Array.from(n):[]}function isTransferable(e){return!!e&&(e instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&e instanceof MessagePort||("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)))}const NOOP$1=()=>{};class WorkerThread{static isSupported(){return"undefined"!=typeof Worker&&isBrowser$2||void 0!==Worker$1&&!isBrowser$2}constructor(e){_defineProperty(this,"name",void 0),_defineProperty(this,"source",void 0),_defineProperty(this,"url",void 0),_defineProperty(this,"terminated",!1),_defineProperty(this,"worker",void 0),_defineProperty(this,"onMessage",void 0),_defineProperty(this,"onError",void 0),_defineProperty(this,"_loadableURL","");const{name:t,source:i,url:n}=e;assert$b(i||n),this.name=t,this.source=i,this.url=n,this.onMessage=NOOP$1,this.onError=e=>{},this.worker=isBrowser$2?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=NOOP$1,this.onError=NOOP$1,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||getTransferList(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=getLoadableWorkerURL({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},e.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},e.onmessageerror=e=>{},e}_createNodeWorker(){let e;if(this.url){const t=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new Worker$1(t,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new Worker$1(this.source,{eval:!0})}return e.on("message",(e=>{this.onMessage(e)})),e.on("error",(e=>{this.onError(e)})),e.on("exit",(e=>{})),e}}class WorkerPool{static isSupported(){return WorkerThread.isSupported()}constructor(e){_defineProperty(this,"name","unnamed"),_defineProperty(this,"source",void 0),_defineProperty(this,"url",void 0),_defineProperty(this,"maxConcurrency",1),_defineProperty(this,"maxMobileConcurrency",1),_defineProperty(this,"onDebug",(()=>{})),_defineProperty(this,"reuseWorkers",!0),_defineProperty(this,"props",{}),_defineProperty(this,"jobQueue",[]),_defineProperty(this,"idleQueue",[]),_defineProperty(this,"count",0),_defineProperty(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach((e=>e.destroy())),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(e,t,i)=>e.done(i),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>e.error(t);const n=new Promise((n=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:n}),this)));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const i=new WorkerJob(t.name,e);e.onMessage=e=>t.onMessage(i,e.type,e.payload),e.onError=e=>t.onError(i,e),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new WorkerThread({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return isMobile?this.maxMobileConcurrency:this.maxConcurrency}}const DEFAULT_PROPS$4={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class WorkerFarm{static isSupported(){return WorkerThread.isSupported()}static getWorkerFarm(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return WorkerFarm._workerFarm=WorkerFarm._workerFarm||new WorkerFarm({}),WorkerFarm._workerFarm.setProps(e),WorkerFarm._workerFarm}constructor(e){_defineProperty(this,"props",void 0),_defineProperty(this,"workerPools",new Map),this.props={...DEFAULT_PROPS$4},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:i,url:n}=e;let r=this.workerPools.get(t);return r||(r=new WorkerPool({name:t,source:i,url:n}),r.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,r)),r}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}_defineProperty(WorkerFarm,"_workerFarm",void 0);const NPM_TAG="latest";function getWorkerURL(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=t[e.id]||{},n="".concat(e.id,"-worker.js");let r=i.workerUrl;if(r||"compression"!==e.id||(r=t.workerUrl),"test"===t._workerType&&(r="modules/".concat(e.module,"/dist/").concat(n)),!r){let t=e.version;"latest"===t&&(t=NPM_TAG);const i=t?"@".concat(t):"";r="https://unpkg.com/@loaders.gl/".concat(e.module).concat(i,"/dist/").concat(n)}return assert$b(r),r}function validateWorkerVersion(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:VERSION$a;assert$b(e,"no worker provided");return!(!t||!e.version)}const readFileAsArrayBuffer=null,readFileAsText=null,requireFromFile=null,requireFromString=null;var node=Object.freeze({__proto__:null,readFileAsArrayBuffer:readFileAsArrayBuffer,readFileAsText:readFileAsText,requireFromFile:requireFromFile,requireFromString:requireFromString});const VERSION$9="3.4.15",loadLibraryPromises={};async function loadLibrary(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return t&&(e=getLibraryUrl(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:{})),loadLibraryPromises[e]=loadLibraryPromises[e]||loadLibraryFromFile(e),await loadLibraryPromises[e]}function getLibraryUrl(e,t,i){if(e.startsWith("http"))return e;const n=i.modules||{};return n[e]?n[e]:isBrowser$2?i.CDN?(assert$b(i.CDN.startsWith("http")),"".concat(i.CDN,"/").concat(t,"@").concat(VERSION$9,"/dist/libs/").concat(e)):isWorker?"../src/libs/".concat(e):"modules/".concat(t,"/src/libs/").concat(e):"modules/".concat(t,"/dist/libs/").concat(e)}async function loadLibraryFromFile(e){if(e.endsWith("wasm")){const t=await fetch(e);return await t.arrayBuffer()}if(!isBrowser$2)try{return node&&requireFromFile&&await requireFromFile(e)}catch(e){return null}if(isWorker)return importScripts(e);const t=await fetch(e);return loadLibraryFromString(await t.text(),e)}function loadLibraryFromString(e,t){if(!isBrowser$2)return requireFromString;if(isWorker)return eval.call(global_,e),null;const i=document.createElement("script");i.id=t;try{i.appendChild(document.createTextNode(e))}catch(t){i.text=e}return document.body.appendChild(i),null}function canParseWithWorker(e,t){return!!WorkerFarm.isSupported()&&(!!(isBrowser$2||null!=t&&t._nodeWorkers)&&(e.worker&&(null==t?void 0:t.worker)))}async function parseWithWorker(e,t,i,n,r){const o=e.id,s=getWorkerURL(e,i),a=WorkerFarm.getWorkerFarm(i).getWorkerPool({name:o,url:s});i=JSON.parse(JSON.stringify(i)),n=JSON.parse(JSON.stringify(n||{}));const l=await a.startJob("process-on-worker",onMessage.bind(null,r));l.postMessage("process",{input:t,options:i,context:n});const c=await l.result;return await c.result}async function onMessage(e,t,i,n){switch(i){case"done":t.done(n);break;case"error":t.error(new Error(n.error));break;case"process":const{id:i,input:r,options:o}=n;try{const n=await e(r,o);t.postMessage("done",{id:i,result:n})}catch(e){const n=e instanceof Error?e.message:"unknown error";t.postMessage("error",{id:i,error:n})}}}function getFirstCharacters$1(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return getMagicString$3(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer){return getMagicString$3(e,0,t)}return""}function getMagicString$3(e,t,i){if(e.byteLength<=t+i)return"";const n=new DataView(e);let r="";for(let e=0;e<i;e++)r+=String.fromCharCode(n.getUint8(t+e));return r}function parseJSON(e){try{return JSON.parse(e)}catch(t){throw new Error('Failed to parse JSON from data starting with "'.concat(getFirstCharacters$1(e),'"'))}}function compareArrayBuffers(e,t,i){if(e.byteLength<(i=i||e.byteLength)||t.byteLength<i)return!1;const n=new Uint8Array(e),r=new Uint8Array(t);for(let e=0;e<n.length;++e)if(n[e]!==r[e])return!1;return!0}function concatenateArrayBuffers(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=t.map((e=>e instanceof ArrayBuffer?new Uint8Array(e):e)),r=n.reduce(((e,t)=>e+t.byteLength),0),o=new Uint8Array(r);let s=0;for(const e of n)o.set(e,s),s+=e.byteLength;return o.buffer}function sliceArrayBuffer(e,t,i){const n=void 0!==i?new Uint8Array(e).subarray(t,t+i):new Uint8Array(e).subarray(t);return new Uint8Array(n).buffer}function padToNBytes(e,t){return assert$c(e>=0),assert$c(t>0),e+(t-1)&-4}function copyToArray(e,t,i){let n;if(e instanceof ArrayBuffer)n=new Uint8Array(e);else{n=new Uint8Array(e.buffer||e.arrayBuffer,e.byteOffset,e.byteLength)}return t.set(n,i),i+padToNBytes(n.byteLength,4)}async function concatenateArrayBuffersAsync(e){const t=[];for await(const i of e)t.push(i);return concatenateArrayBuffers(...t)}function getHiResTimestamp$1(){let e;if("undefined"!=typeof window&&window.performance)e=window.performance.now();else if("undefined"!=typeof process&&process.hrtime){const t=process.hrtime();e=1e3*t[0]+t[1]/1e6}else e=Date.now();return e}class Stat{constructor(e,t){_defineProperty(this,"name",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"sampleSize",1),_defineProperty(this,"time",void 0),_defineProperty(this,"count",void 0),_defineProperty(this,"samples",void 0),_defineProperty(this,"lastTiming",void 0),_defineProperty(this,"lastSampleTime",void 0),_defineProperty(this,"lastSampleCount",void 0),_defineProperty(this,"_count",0),_defineProperty(this,"_time",0),_defineProperty(this,"_samples",0),_defineProperty(this,"_startTime",0),_defineProperty(this,"_timerPending",!1),this.name=e,this.type=t,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=getHiResTimestamp$1(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(getHiResTimestamp$1()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class Stats{constructor(e){_defineProperty(this,"id",void 0),_defineProperty(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){return this._getOrCreate({name:e,type:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"count"})}get size(){return Object.keys(this.stats).length}reset(){for(const e in this.stats)this.stats[e].reset();return this}forEach(e){for(const t in this.stats)e(this.stats[t])}getTable(){const e={};return this.forEach((t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}})),e}_initializeStats(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((e=>this._getOrCreate(e)))}_getOrCreate(e){if(!e||!e.name)return null;const{name:t,type:i}=e;return this.stats[t]||(this.stats[t]=e instanceof Stat?e:new Stat(t,i)),this.stats[t]}}const STAT_QUEUED_REQUESTS="Queued Requests",STAT_ACTIVE_REQUESTS="Active Requests",STAT_CANCELLED_REQUESTS="Cancelled Requests",STAT_QUEUED_REQUESTS_EVER="Queued Requests Ever",STAT_ACTIVE_REQUESTS_EVER="Active Requests Ever",DEFAULT_PROPS$3={id:"request-scheduler",throttleRequests:!0,maxRequests:6};class RequestScheduler{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_defineProperty(this,"props",void 0),_defineProperty(this,"stats",void 0),_defineProperty(this,"activeRequestCount",0),_defineProperty(this,"requestQueue",[]),_defineProperty(this,"requestMap",new Map),_defineProperty(this,"deferredUpdate",null),this.props={...DEFAULT_PROPS$3,...e},this.stats=new Stats({id:this.props.id}),this.stats.get(STAT_QUEUED_REQUESTS),this.stats.get(STAT_ACTIVE_REQUESTS),this.stats.get(STAT_CANCELLED_REQUESTS),this.stats.get(STAT_QUEUED_REQUESTS_EVER),this.stats.get(STAT_ACTIVE_REQUESTS_EVER)}scheduleRequest(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>0;if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);const i={handle:e,priority:0,getPriority:t},n=new Promise((e=>(i.resolve=e,i)));return this.requestQueue.push(i),this.requestMap.set(e,n),this._issueNewRequests(),n}_issueRequest(e){const{handle:t,resolve:i}=e;let n=!1;const r=()=>{n||(n=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,i?i({done:r}):Promise.resolve({done:r})}_issueNewRequests(){this.deferredUpdate||(this.deferredUpdate=setTimeout((()=>this._issueNewRequestsAsync()),0))}_issueNewRequestsAsync(){this.deferredUpdate=null;const e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(0!==e){this._updateAllRequests();for(let t=0;t<e;++t){const e=this.requestQueue.shift();e&&this._issueRequest(e)}}}_updateAllRequests(){const e=this.requestQueue;for(let t=0;t<e.length;++t){const i=e[t];this._updateRequest(i)||(e.splice(t,1),this.requestMap.delete(i.handle),t--)}e.sort(((e,t)=>e.priority-t.priority))}_updateRequest(e){return e.priority=e.getPriority(e.handle),!(e.priority<0)||(e.resolve(null),!1)}}let pathPrefix$1="";const fileAliases={};function resolvePath(e){for(const t in fileAliases)if(e.startsWith(t)){e=e.replace(t,fileAliases[t])}return e.startsWith("http://")||e.startsWith("https://")||(e="".concat(pathPrefix$1).concat(e)),e}function toArrayBuffer$1(e){return e}function isBuffer$1(e){return e&&"object"==typeof e&&e.isBuffer}function toArrayBuffer(e){if(isBuffer$1(e))return toArrayBuffer$1(e);if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);if("string"==typeof e){const t=e;return(new TextEncoder).encode(t).buffer}if(e&&"object"==typeof e&&e._toArrayBuffer)return e._toArrayBuffer();throw new Error("toArrayBuffer")}function filename(e){const t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(t+1):""}function dirname(e){const t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(0,t):""}const isBoolean=e=>"boolean"==typeof e,isFunction=e=>"function"==typeof e,isObject$4=e=>null!==e&&"object"==typeof e,isPureObject=e=>isObject$4(e)&&e.constructor==={}.constructor,isIterable=e=>e&&"function"==typeof e[Symbol.iterator],isAsyncIterable$1=e=>e&&"function"==typeof e[Symbol.asyncIterator],isResponse=e=>"undefined"!=typeof Response&&e instanceof Response||e&&e.arrayBuffer&&e.text&&e.json,isBlob=e=>"undefined"!=typeof Blob&&e instanceof Blob,isBuffer=e=>e&&"object"==typeof e&&e.isBuffer,isReadableDOMStream=e=>"undefined"!=typeof ReadableStream&&e instanceof ReadableStream||isObject$4(e)&&isFunction(e.tee)&&isFunction(e.cancel)&&isFunction(e.getReader),isReadableNodeStream=e=>isObject$4(e)&&isFunction(e.read)&&isFunction(e.pipe)&&isBoolean(e.readable),isReadableStream=e=>isReadableDOMStream(e)||isReadableNodeStream(e),DATA_URL_PATTERN=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,MIME_TYPE_PATTERN=/^([-\w.]+\/[-\w.+]+)/;function parseMIMEType(e){const t=MIME_TYPE_PATTERN.exec(e);return t?t[1]:e}function parseMIMETypeFromURL(e){const t=DATA_URL_PATTERN.exec(e);return t?t[1]:""}const QUERY_STRING_PATTERN=/\?.*/;function extractQueryString(e){const t=e.match(QUERY_STRING_PATTERN);return t&&t[0]}function stripQueryString(e){return e.replace(QUERY_STRING_PATTERN,"")}function getResourceUrl(e){if(isResponse(e)){return e.url}if(isBlob(e)){return e.name||""}return"string"==typeof e?e:""}function getResourceMIMEType(e){if(isResponse(e)){const t=e,i=t.headers.get("content-type")||"",n=stripQueryString(t.url);return parseMIMEType(i)||parseMIMETypeFromURL(n)}if(isBlob(e)){return e.type||""}return"string"==typeof e?parseMIMETypeFromURL(e):""}function getResourceContentLength(e){if(isResponse(e)){return e.headers["content-length"]||-1}if(isBlob(e)){return e.size}return"string"==typeof e?e.length:e instanceof ArrayBuffer||ArrayBuffer.isView(e)?e.byteLength:-1}async function makeResponse(e){if(isResponse(e))return e;const t={},i=getResourceContentLength(e);i>=0&&(t["content-length"]=String(i));const n=getResourceUrl(e),r=getResourceMIMEType(e);r&&(t["content-type"]=r);const o=await getInitialDataUrl(e);o&&(t["x-first-bytes"]=o),"string"==typeof e&&(e=(new TextEncoder).encode(e));const s=new Response(e,{headers:t});return Object.defineProperty(s,"url",{value:n}),s}async function checkResponse(e){if(!e.ok){const t=await getResponseError(e);throw new Error(t)}}async function getResponseError(e){let t="Failed to fetch resource ".concat(e.url," (").concat(e.status,"): ");try{const i=e.headers.get("Content-Type");let n=e.statusText;i.includes("application/json")&&(n+=" ".concat(await e.text())),t+=n,t=t.length>60?"".concat(t.slice(0,60),"..."):t}catch(e){}return t}async function getInitialDataUrl(e){if("string"==typeof e)return"data:,".concat(e.slice(0,5));if(e instanceof Blob){const t=e.slice(0,5);return await new Promise((e=>{const i=new FileReader;i.onload=t=>{var i;return e(null==t||null===(i=t.target)||void 0===i?void 0:i.result)},i.readAsDataURL(t)}))}if(e instanceof ArrayBuffer){const t=arrayBufferToBase64(e.slice(0,5));return"data:base64,".concat(t)}return null}function arrayBufferToBase64(e){let t="";const i=new Uint8Array(e);for(let e=0;e<i.byteLength;e++)t+=String.fromCharCode(i[e]);return btoa(t)}async function fetchFile(e,t){if("string"==typeof e){e=resolvePath(e);let i=t;return null!=t&&t.fetch&&"function"!=typeof(null==t?void 0:t.fetch)&&(i=t.fetch),await fetch(e,i)}return await makeResponse(e)}function isElectron(e){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return!0;const t="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function isBrowser$1(){return!("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||isElectron()}const globals={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,process:"object"==typeof process&&process},window_$1=globals.window||globals.self||globals.global,process_=globals.process||{},VERSION$8="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source";isBrowser$1();const window$1=globalThis;function getBrowser$1(e){if(!isBrowser$1())return"Node";if(isElectron())return"Electron";const t=("undefined"!=typeof navigator?navigator:{}).userAgent||"";if(t.indexOf("Edge")>-1)return"Edge";const i=-1!==t.indexOf("MSIE "),n=-1!==t.indexOf("Trident/");return i||n?"IE":window$1.chrome?"Chrome":window$1.safari?"Safari":window$1.mozInnerScreenX?"Firefox":"Unknown"}function getStorage(e){try{const t=window[e],i="__storage_test__";return t.setItem(i,i),t.removeItem(i),t}catch(e){return null}}class LocalStorage{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sessionStorage";_defineProperty(this,"storage",void 0),_defineProperty(this,"id",void 0),_defineProperty(this,"config",void 0),this.storage=getStorage(i),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function formatTime(e){let t;return t=e<10?"".concat(e.toFixed(2),"ms"):e<100?"".concat(e.toFixed(1),"ms"):e<1e3?"".concat(e.toFixed(0),"ms"):"".concat((e/1e3).toFixed(2),"s"),t}function leftPad(e){const t=Math.max((arguments.length>1&&void 0!==arguments[1]?arguments[1]:8)-e.length,0);return"".concat(" ".repeat(t)).concat(e)}function formatImage(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:600;const r=e.src.replace(/\(/g,"%28").replace(/\)/g,"%29");e.width>n&&(i=Math.min(i,n/e.width));const o=e.width*i,s=e.height*i,a=["font-size:1px;","padding:".concat(Math.floor(s/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(s,"px;"),"background:url(".concat(r,");"),"background-size:".concat(o,"px ").concat(s,"px;"),"color:transparent;"].join("");return["".concat(t," %c+"),a]}let COLOR;function getColor(e){return"string"==typeof e?COLOR[e.toUpperCase()]||COLOR.WHITE:e}function addColor(e,t,i){return isBrowser$1||"string"!=typeof e||(t&&(t=getColor(t),e="[".concat(t,"m").concat(e,"[39m")),i&&(t=getColor(i),e="[".concat(i+10,"m").concat(e,"[49m"))),e}function autobind(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["constructor"];const i=Object.getPrototypeOf(e),n=Object.getOwnPropertyNames(i);for(const i of n)"function"==typeof e[i]&&(t.find((e=>i===e))||(e[i]=e[i].bind(e)))}function assert$a(e,t){if(!e)throw new Error(t||"Assertion failed")}function getHiResTimestamp(){let e;var t,i;if(isBrowser$1&&"performance"in window_$1)e=null==window_$1||null===(t=window_$1.performance)||void 0===t||null===(i=t.now)||void 0===i?void 0:i.call(t);else if("hrtime"in process_){var n;const t=null==process_||null===(n=process_.hrtime)||void 0===n?void 0:n.call(process_);e=1e3*t[0]+t[1]/1e6}else e=Date.now();return e}!function(e){e[e.BLACK=30]="BLACK",e[e.RED=31]="RED",e[e.GREEN=32]="GREEN",e[e.YELLOW=33]="YELLOW",e[e.BLUE=34]="BLUE",e[e.MAGENTA=35]="MAGENTA",e[e.CYAN=36]="CYAN",e[e.WHITE=37]="WHITE",e[e.BRIGHT_BLACK=90]="BRIGHT_BLACK",e[e.BRIGHT_RED=91]="BRIGHT_RED",e[e.BRIGHT_GREEN=92]="BRIGHT_GREEN",e[e.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",e[e.BRIGHT_BLUE=94]="BRIGHT_BLUE",e[e.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",e[e.BRIGHT_CYAN=96]="BRIGHT_CYAN",e[e.BRIGHT_WHITE=97]="BRIGHT_WHITE"}(COLOR||(COLOR={}));const originalConsole={debug:isBrowser$1&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},DEFAULT_SETTINGS={enabled:!0,level:0};function noop$3(){}const cache$1={},ONCE={once:!0};class Log{constructor(){let{id:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:""};_defineProperty(this,"id",void 0),_defineProperty(this,"VERSION",VERSION$8),_defineProperty(this,"_startTs",getHiResTimestamp()),_defineProperty(this,"_deltaTs",getHiResTimestamp()),_defineProperty(this,"_storage",void 0),_defineProperty(this,"userData",{}),_defineProperty(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this.userData={},this._storage=new LocalStorage("__probe-".concat(this.id,"__"),DEFAULT_SETTINGS),this.timeStamp("".concat(this.id," started")),autobind(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((getHiResTimestamp()-this._startTs).toPrecision(10))}getDelta(){return Number((getHiResTimestamp()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){return this._storage.setConfiguration({enabled:!(arguments.length>0&&void 0!==arguments[0])||arguments[0]}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){}assert(e,t){assert$a(e,t)}warn(e){return this._getLogFunction(0,e,originalConsole.warn,arguments,ONCE)}error(e){return this._getLogFunction(0,e,originalConsole.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,originalConsole.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,originalConsole.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return this._getLogFunction(e,t,originalConsole.debug||originalConsole.info,arguments,ONCE)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||noop$3,i&&[i],{tag:getTableHeader(t)}):noop$3}image(e){let{logLevel:t,priority:i,image:n,message:r="",scale:o=1}=e;return this._shouldLog(t||i)?isBrowser$1?logImageInBrowser({image:n,message:r,scale:o}):logImageInNode():noop$3}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||noop$3)}group(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{collapsed:!1};const n=normalizeArguments({logLevel:e,message:t,opts:i}),{collapsed:r}=i;return n.method=(r?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t){return this.group(e,t,Object.assign({},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||noop$3)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=normalizeLogLevel(e)}_getLogFunction(e,t,i,n,r){if(this._shouldLog(e)){r=normalizeArguments({logLevel:e,message:t,args:n,opts:r}),assert$a(i=i||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=getHiResTimestamp();const o=r.tag||r.message;if(r.once){if(cache$1[o])return noop$3;cache$1[o]=getHiResTimestamp()}return t=decorateMessage(this.id,r.message,r),i.bind(console,t,...r.args)}return noop$3}}function normalizeLogLevel(e){if(!e)return 0;let t;switch(typeof e){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return assert$a(Number.isFinite(t)&&t>=0),t}function normalizeArguments(e){const{logLevel:t,message:i}=e;e.logLevel=normalizeLogLevel(t);const n=e.args?Array.from(e.args):[];for(;n.length&&n.shift()!==i;);switch(typeof t){case"string":case"function":void 0!==i&&n.unshift(i),e.message=t;break;case"object":Object.assign(e,t)}"function"==typeof e.message&&(e.message=e.message());const r=typeof e.message;return assert$a("string"===r||"object"===r),Object.assign(e,{args:n},e.opts)}function decorateMessage(e,t,i){if("string"==typeof t){const n=i.time?leftPad(formatTime(i.total)):"";t=addColor(t=i.time?"".concat(e,": ").concat(n,"  ").concat(t):"".concat(e,": ").concat(t),i.color,i.background)}return t}function logImageInNode(e){return noop$3}function logImageInBrowser(e){let{image:t,message:i="",scale:n=1}=e;if("string"==typeof t){const e=new Image;return e.onload=()=>{formatImage(e,i,n)},e.src=t,noop$3}const r=t.nodeName||"";if("img"===r.toLowerCase())return noop$3;if("canvas"===r.toLowerCase()){const e=new Image;return e.onload=()=>{},e.src=t.toDataURL(),noop$3}return noop$3}function getTableHeader(e){for(const t in e)for(const i in e[t])return i||"untitled";return"empty"}_defineProperty(Log,"VERSION",VERSION$8);const probeLog=new Log({id:"loaders.gl"});class NullLog{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class ConsoleLog{constructor(){_defineProperty(this,"console",void 0),this.console=console}log(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return this.console.log.bind(this.console,...t)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return this.console.info.bind(this.console,...t)}warn(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return this.console.warn.bind(this.console,...t)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return this.console.error.bind(this.console,...t)}}const DEFAULT_LOADER_OPTIONS={fetch:null,mimeType:void 0,nothrow:!1,log:new ConsoleLog,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:isBrowser$3,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},REMOVED_LOADER_OPTIONS={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function getGlobalLoaderState(){globalThis.loaders=globalThis.loaders||{};const{loaders:e}=globalThis;return e._state=e._state||{},e._state}const getGlobalLoaderOptions=()=>{const e=getGlobalLoaderState();return e.globalOptions=e.globalOptions||{...DEFAULT_LOADER_OPTIONS},e.globalOptions};function normalizeOptions(e,t,i,n){return i=i||[],validateOptions(e,i=Array.isArray(i)?i:[i]),normalizeOptionsInternal(t,e,n)}function validateOptions(e,t){validateOptionsObject(e,null,DEFAULT_LOADER_OPTIONS,REMOVED_LOADER_OPTIONS,t);for(const i of t){validateOptionsObject(e&&e[i.id]||{},i.id,i.options&&i.options[i.id]||{},i.deprecatedOptions&&i.deprecatedOptions[i.id]||{},t)}}function validateOptionsObject(e,t,i,n,r){const o=t||"Top level",s=t?"".concat(t,"."):"";for(const a in e){const l=!t&&isObject$4(e[a]);if(!(a in i)&&!("baseUri"===a&&!t)&&!("workerUrl"===a&&t))if(a in n)probeLog.warn("".concat(o," loader option '").concat(s).concat(a,"' no longer supported, use '").concat(n[a],"'"))();else if(!l){const e=findSimilarOption(a,r);probeLog.warn("".concat(o," loader option '").concat(s).concat(a,"' not recognized. ").concat(e))()}}}function findSimilarOption(e,t){const i=e.toLowerCase();let n="";for(const r of t)for(const t in r.options){if(e===t)return"Did you mean '".concat(r.id,".").concat(t,"'?");const o=t.toLowerCase();(i.startsWith(o)||o.startsWith(i))&&(n=n||"Did you mean '".concat(r.id,".").concat(t,"'?"))}return n}function normalizeOptionsInternal(e,t,i){const n={...e.options||{}};return addUrlOptions(n,i),null===n.log&&(n.log=new NullLog),mergeNestedFields(n,getGlobalLoaderOptions()),mergeNestedFields(n,t),n}function mergeNestedFields(e,t){for(const i in t)if(i in t){e[i]=isPureObject(t[i])&&isPureObject(e[i])?{...e[i],...t[i]}:t[i]}}function addUrlOptions(e,t){t&&!("baseUri"in e)&&(e.baseUri=t)}function isLoaderObject(e){var t;if(!e)return!1;Array.isArray(e)&&(e=e[0]);return Array.isArray(null===(t=e)||void 0===t?void 0:t.extensions)}function normalizeLoader(e){var t,i;let n;return assert$c(e,"null loader"),assert$c(isLoaderObject(e),"invalid loader"),Array.isArray(e)&&(n=e[1],e=e[0],e={...e,options:{...e.options,...n}}),(null!==(t=e)&&void 0!==t&&t.parseTextSync||null!==(i=e)&&void 0!==i&&i.parseText)&&(e.text=!0),e.text||(e.binary=!0),e}const getGlobalLoaderRegistry=()=>{const e=getGlobalLoaderState();return e.loaderRegistry=e.loaderRegistry||[],e.loaderRegistry};function registerLoaders(e){const t=getGlobalLoaderRegistry();e=Array.isArray(e)?e:[e];for(const i of e){const e=normalizeLoader(i);t.find((t=>e===t))||t.unshift(e)}}function getRegisteredLoaders(){return getGlobalLoaderRegistry()}const log$4=new Log({id:"loaders.gl"}),EXT_PATTERN=/\.([^.]+)$/;async function selectLoader(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;if(!validHTTPResponse(e))return null;let r=selectLoaderSync(e,t,{...i,nothrow:!0},n);if(r)return r;if(isBlob(e)&&(r=selectLoaderSync(e=await e.slice(0,10).arrayBuffer(),t,i,n)),!(r||null!=i&&i.nothrow))throw new Error(getNoValidLoaderMessage(e));return r}function selectLoaderSync(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;if(!validHTTPResponse(e))return null;if(t&&!Array.isArray(t))return normalizeLoader(t);let r=[];t&&(r=r.concat(t)),null!=i&&i.ignoreRegisteredLoaders||r.push(...getRegisteredLoaders()),normalizeLoaders(r);const o=selectLoaderInternal(e,r,i,n);if(!(o||null!=i&&i.nothrow))throw new Error(getNoValidLoaderMessage(e));return o}function selectLoaderInternal(e,t,i,n){const r=getResourceUrl(e),o=getResourceMIMEType(e),s=stripQueryString(r)||(null==n?void 0:n.url);let a=null,l="";var c;(null!=i&&i.mimeType&&(a=findLoaderByMIMEType(t,null==i?void 0:i.mimeType),l="match forced by supplied MIME type ".concat(null==i?void 0:i.mimeType)),a=a||findLoaderByUrl(t,s),l=l||(a?"matched url ".concat(s):""),a=a||findLoaderByMIMEType(t,o),l=l||(a?"matched MIME type ".concat(o):""),a=a||findLoaderByInitialBytes(t,e),l=l||(a?"matched initial data ".concat(getFirstCharacters(e)):""),a=a||findLoaderByMIMEType(t,null==i?void 0:i.fallbackMimeType),l=l||(a?"matched fallback MIME type ".concat(o):""),l)&&log$4.log(1,"selectLoader selected ".concat(null===(c=a)||void 0===c?void 0:c.name,": ").concat(l,"."));return a}function validHTTPResponse(e){return!(e instanceof Response&&204===e.status)}function getNoValidLoaderMessage(e){const t=getResourceUrl(e),i=getResourceMIMEType(e);let n="No valid loader found (";n+=t?"".concat(filename(t),", "):"no url provided, ",n+="MIME type: ".concat(i?'"'.concat(i,'"'):"not provided",", ");const r=e?getFirstCharacters(e):"";return n+=r?' first bytes: "'.concat(r,'"'):"first bytes: not available",n+=")",n}function normalizeLoaders(e){for(const t of e)normalizeLoader(t)}function findLoaderByUrl(e,t){const i=t&&EXT_PATTERN.exec(t),n=i&&i[1];return n?findLoaderByExtension(e,n):null}function findLoaderByExtension(e,t){t=t.toLowerCase();for(const i of e)for(const e of i.extensions)if(e.toLowerCase()===t)return i;return null}function findLoaderByMIMEType(e,t){for(const i of e){if(i.mimeTypes&&i.mimeTypes.includes(t))return i;if(t==="application/x.".concat(i.id))return i}return null}function findLoaderByInitialBytes(e,t){if(!t)return null;for(const i of e)if("string"==typeof t){if(testDataAgainstText(t,i))return i}else if(ArrayBuffer.isView(t)){if(testDataAgainstBinary(t.buffer,t.byteOffset,i))return i}else if(t instanceof ArrayBuffer){if(testDataAgainstBinary(t,0,i))return i}return null}function testDataAgainstText(e,t){if(t.testText)return t.testText(e);return(Array.isArray(t.tests)?t.tests:[t.tests]).some((t=>e.startsWith(t)))}function testDataAgainstBinary(e,t,i){return(Array.isArray(i.tests)?i.tests:[i.tests]).some((n=>testBinary(e,t,i,n)))}function testBinary(e,t,i,n){if(n instanceof ArrayBuffer)return compareArrayBuffers(n,e,n.byteLength);switch(typeof n){case"function":return n(e,i);case"string":return n===getMagicString$2(e,t,n.length);default:return!1}}function getFirstCharacters(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return getMagicString$2(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer){return getMagicString$2(e,0,t)}return""}function getMagicString$2(e,t,i){if(e.byteLength<t+i)return"";const n=new DataView(e);let r="";for(let e=0;e<i;e++)r+=String.fromCharCode(n.getUint8(t+e));return r}const DEFAULT_CHUNK_SIZE$2=262144;function*makeStringIterator(e,t){const i=(null==t?void 0:t.chunkSize)||DEFAULT_CHUNK_SIZE$2;let n=0;const r=new TextEncoder;for(;n<e.length;){const t=Math.min(e.length-n,i),o=e.slice(n,n+t);n+=t,yield r.encode(o)}}const DEFAULT_CHUNK_SIZE$1=262144;function makeArrayBufferIterator(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function*(){const{chunkSize:i=DEFAULT_CHUNK_SIZE$1}=t;let n=0;for(;n<e.byteLength;){const t=Math.min(e.byteLength-n,i),r=new ArrayBuffer(t),o=new Uint8Array(e,n,t);new Uint8Array(r).set(o),n+=t,yield r}}()}const DEFAULT_CHUNK_SIZE=1048576;async function*makeBlobIterator(e,t){const i=(null==t?void 0:t.chunkSize)||DEFAULT_CHUNK_SIZE;let n=0;for(;n<e.size;){const t=n+i,r=await e.slice(n,t).arrayBuffer();n=t,yield r}}function makeStreamIterator(e,t){return isBrowser$3?makeBrowserStreamIterator(e,t):makeNodeStreamIterator(e)}async function*makeBrowserStreamIterator(e,t){const i=e.getReader();let n;try{for(;;){const e=n||i.read();null!=t&&t._streamReadAhead&&(n=i.read());const{done:r,value:o}=await e;if(r)return;yield toArrayBuffer(o)}}catch(e){i.releaseLock()}}async function*makeNodeStreamIterator(e,t){for await(const t of e)yield toArrayBuffer(t)}function makeIterator(e,t){if("string"==typeof e)return makeStringIterator(e,t);if(e instanceof ArrayBuffer)return makeArrayBufferIterator(e,t);if(isBlob(e))return makeBlobIterator(e,t);if(isReadableStream(e))return makeStreamIterator(e,t);if(isResponse(e)){return makeStreamIterator(e.body,t)}throw new Error("makeIterator")}const ERR_DATA="Cannot convert supplied data type";function getArrayBufferOrStringFromDataSync(e,t,i){if(t.text&&"string"==typeof e)return e;if(isBuffer(e)&&(e=e.buffer),e instanceof ArrayBuffer){const i=e;if(t.text&&!t.binary){return new TextDecoder("utf8").decode(i)}return i}if(ArrayBuffer.isView(e)){if(t.text&&!t.binary){return new TextDecoder("utf8").decode(e)}let i=e.buffer;const n=e.byteLength||e.length;return 0===e.byteOffset&&n===i.byteLength||(i=i.slice(e.byteOffset,e.byteOffset+n)),i}throw new Error(ERR_DATA)}async function getArrayBufferOrStringFromData(e,t,i){const n=e instanceof ArrayBuffer||ArrayBuffer.isView(e);if("string"==typeof e||n)return getArrayBufferOrStringFromDataSync(e,t);if(isBlob(e)&&(e=await makeResponse(e)),isResponse(e)){const i=e;return await checkResponse(i),t.binary?await i.arrayBuffer():await i.text()}if(isReadableStream(e)&&(e=makeIterator(e,i)),isIterable(e)||isAsyncIterable$1(e))return concatenateArrayBuffersAsync(e);throw new Error(ERR_DATA)}function getFetchFunction(e,t){const i=getGlobalLoaderOptions(),n=e||i;return"function"==typeof n.fetch?n.fetch:isObject$4(n.fetch)?e=>fetchFile(e,n):null!=t&&t.fetch?null==t?void 0:t.fetch:fetchFile}function getLoaderContext(e,t,i){if(i)return i;const n={fetch:getFetchFunction(t,e),...e};if(n.url){const e=stripQueryString(n.url);n.baseUrl=e,n.queryString=extractQueryString(n.url),n.filename=filename(e),n.baseUrl=dirname(e)}return Array.isArray(n.loaders)||(n.loaders=null),n}function getLoadersFromContext(e,t){if(!t&&e&&!Array.isArray(e))return e;let i;if(e&&(i=Array.isArray(e)?e:[e]),t&&t.loaders){const e=Array.isArray(t.loaders)?t.loaders:[t.loaders];i=i?[...i,...e]:e}return i&&i.length?i:null}async function parse$3(e,t,i,n){assert$b(!n||"object"==typeof n),!t||Array.isArray(t)||isLoaderObject(t)||(n=void 0,i=t,t=void 0),i=i||{};const r=getResourceUrl(e=await e),o=getLoadersFromContext(t,n),s=await selectLoader(e,o,i);return s?(n=getLoaderContext({url:r,parse:parse$3,loaders:o},i=normalizeOptions(i,s,o,r),n||null),await parseWithLoader(s,e,i,n)):null}async function parseWithLoader(e,t,i,n){if(validateWorkerVersion(e),isResponse(t)){const e=t,{ok:i,redirected:r,status:o,statusText:s,type:a,url:l}=e,c=Object.fromEntries(e.headers.entries());n.response={headers:c,ok:i,redirected:r,status:o,statusText:s,type:a,url:l}}if(t=await getArrayBufferOrStringFromData(t,e,i),e.parseTextSync&&"string"==typeof t)return i.dataType="text",e.parseTextSync(t,i,n,e);if(canParseWithWorker(e,i))return await parseWithWorker(e,t,i,n,parse$3);if(e.parseText&&"string"==typeof t)return await e.parseText(t,i,n,e);if(e.parse)return await e.parse(t,i,n,e);throw assert$b(!e.parseSync),new Error("".concat(e.id," loader - no parser found and worker is disabled"))}async function load(e,t,i,n){Array.isArray(t)||isLoaderObject(t)||(i=t,t=void 0);const r=getFetchFunction(i);let o=e;return"string"==typeof e&&(o=await r(e)),isBlob(e)&&(o=await r(e)),await parse$3(o,t,i)}const VERSION$7="3.4.15",{_parseImageNode:_parseImageNode}=globalThis,IMAGE_SUPPORTED="undefined"!=typeof Image,IMAGE_BITMAP_SUPPORTED="undefined"!=typeof ImageBitmap,NODE_IMAGE_SUPPORTED=Boolean(_parseImageNode),DATA_SUPPORTED=!!isBrowser$3||NODE_IMAGE_SUPPORTED;function isImageTypeSupported(e){switch(e){case"auto":return IMAGE_BITMAP_SUPPORTED||IMAGE_SUPPORTED||DATA_SUPPORTED;case"imagebitmap":return IMAGE_BITMAP_SUPPORTED;case"image":return IMAGE_SUPPORTED;case"data":return DATA_SUPPORTED;default:throw new Error("@loaders.gl/images: image ".concat(e," not supported in this environment"))}}function getDefaultImageType(){if(IMAGE_BITMAP_SUPPORTED)return"imagebitmap";if(IMAGE_SUPPORTED)return"image";if(DATA_SUPPORTED)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function getImageType(e){const t=getImageTypeOrNull(e);if(!t)throw new Error("Not an image");return t}function getImageData(e){switch(getImageType(e)){case"data":return e;case"image":case"imagebitmap":const t=document.createElement("canvas"),i=t.getContext("2d");if(!i)throw new Error("getImageData");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height);default:throw new Error("getImageData")}}function getImageTypeOrNull(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?"imagebitmap":"undefined"!=typeof Image&&e instanceof Image?"image":e&&"object"==typeof e&&e.data&&e.width&&e.height?"data":null}const SVG_DATA_URL_PATTERN=/^data:image\/svg\+xml/,SVG_URL_PATTERN=/\.svg((\?|#).*)?$/;function isSVG(e){return e&&(SVG_DATA_URL_PATTERN.test(e)||SVG_URL_PATTERN.test(e))}function getBlobOrSVGDataUrl(e,t){if(isSVG(t)){let t=(new TextDecoder).decode(e);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(t=unescape(encodeURIComponent(t)))}catch(e){throw new Error(e.message)}return"data:image/svg+xml;base64,".concat(btoa(t))}return getBlob(e,t)}function getBlob(e,t){if(isSVG(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(e)])}async function parseToImage(e,t,i){const n=getBlobOrSVGDataUrl(e,i),r=self.URL||self.webkitURL,o="string"!=typeof n&&r.createObjectURL(n);try{return await loadToImage(o||n,t)}finally{o&&r.revokeObjectURL(o)}}async function loadToImage(e,t){const i=new Image;return i.src=e,t.image&&t.image.decode&&i.decode?(await i.decode(),i):await new Promise(((t,n)=>{try{i.onload=()=>t(i),i.onerror=t=>n(new Error("Could not load image ".concat(e,": ").concat(t)))}catch(e){n(e)}}))}const EMPTY_OBJECT={};let imagebitmapOptionsSupported=!0;async function parseToImageBitmap(e,t,i){let n;if(isSVG(i)){n=await parseToImage(e,t,i)}else n=getBlob(e,i);const r=t&&t.imagebitmap;return await safeCreateImageBitmap(n,r)}async function safeCreateImageBitmap(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!isEmptyObject(t)&&imagebitmapOptionsSupported||(t=null),t)try{return await createImageBitmap(e,t)}catch(e){imagebitmapOptionsSupported=!1}return await createImageBitmap(e)}function isEmptyObject(e){for(const t in e||EMPTY_OBJECT)return!1;return!0}function getISOBMFFMediaType(e){return checkString(e,"ftyp",4)&&96&e[8]?decodeMajorBrand(e):null}function decodeMajorBrand(e){switch(getUTF8String(e,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function getUTF8String(e,t,i){return String.fromCharCode(...e.slice(t,i))}function stringToBytes(e){return[...e].map((e=>e.charCodeAt(0)))}function checkString(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=stringToBytes(t);for(let t=0;t<n.length;++t)if(n[t]!==e[t+i])return!1;return!0}const BIG_ENDIAN=!1,LITTLE_ENDIAN=!0;function getBinaryImageMetadata(e){const t=toDataView(e);return getPngMetadata(t)||getJpegMetadata(t)||getGifMetadata(t)||getBmpMetadata(t)||getISOBMFFMetadata(t)}function getISOBMFFMetadata(e){const t=getISOBMFFMediaType(new Uint8Array(e instanceof DataView?e.buffer:e));return t?{mimeType:t.mimeType,width:0,height:0}:null}function getPngMetadata(e){const t=toDataView(e);return t.byteLength>=24&&2303741511===t.getUint32(0,BIG_ENDIAN)?{mimeType:"image/png",width:t.getUint32(16,BIG_ENDIAN),height:t.getUint32(20,BIG_ENDIAN)}:null}function getGifMetadata(e){const t=toDataView(e);return t.byteLength>=10&&1195984440===t.getUint32(0,BIG_ENDIAN)?{mimeType:"image/gif",width:t.getUint16(6,LITTLE_ENDIAN),height:t.getUint16(8,LITTLE_ENDIAN)}:null}function getBmpMetadata(e){const t=toDataView(e);return t.byteLength>=14&&16973===t.getUint16(0,BIG_ENDIAN)&&t.getUint32(2,LITTLE_ENDIAN)===t.byteLength?{mimeType:"image/bmp",width:t.getUint32(18,LITTLE_ENDIAN),height:t.getUint32(22,LITTLE_ENDIAN)}:null}function getJpegMetadata(e){const t=toDataView(e);if(!(t.byteLength>=3&&65496===t.getUint16(0,BIG_ENDIAN)&&255===t.getUint8(2)))return null;const{tableMarkers:i,sofMarkers:n}=getJpegMarkers();let r=2;for(;r+9<t.byteLength;){const e=t.getUint16(r,BIG_ENDIAN);if(n.has(e))return{mimeType:"image/jpeg",height:t.getUint16(r+5,BIG_ENDIAN),width:t.getUint16(r+7,BIG_ENDIAN)};if(!i.has(e))return null;r+=2,r+=t.getUint16(r,BIG_ENDIAN)}return null}function getJpegMarkers(){const e=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)e.add(t);return{tableMarkers:e,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function toDataView(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw new Error("toDataView")}async function parseToNodeImage(e,t){const{mimeType:i}=getBinaryImageMetadata(e)||{},n=globalThis._parseImageNode;return assert$c(n),await n(e,i)}async function parseImage(e,t,i){const n=((t=t||{}).image||{}).type||"auto",{url:r}=i||{};let o;switch(getLoadableImageType(n)){case"imagebitmap":o=await parseToImageBitmap(e,t,r);break;case"image":o=await parseToImage(e,t,r);break;case"data":o=await parseToNodeImage(e);break;default:assert$c(!1)}return"data"===n&&(o=getImageData(o)),o}function getLoadableImageType(e){switch(e){case"auto":case"data":return getDefaultImageType();default:return isImageTypeSupported(e),e}}const EXTENSIONS$2=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],MIME_TYPES$1=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],DEFAULT_IMAGE_LOADER_OPTIONS={image:{type:"auto",decode:!0}},ImageLoader$1={id:"image",module:"images",name:"Images",version:VERSION$7,mimeTypes:MIME_TYPES$1,extensions:EXTENSIONS$2,parse:parseImage,tests:[e=>Boolean(getBinaryImageMetadata(new DataView(e)))],options:DEFAULT_IMAGE_LOADER_OPTIONS},MIME_TYPES=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/tiff","image/svg","image/svg+xml","image/bmp","image/vnd.microsoft.icon"];async function getSupportedImageFormats(){const e=new Set;for(const t of MIME_TYPES){(isBrowser$3?await checkBrowserImageFormatSupportAsync(t):checkNodeImageFormatSupport(t))&&e.add(t)}return e}function checkNodeImageFormatSupport(e){const t=["image/png","image/jpeg","image/gif"],{_parseImageNode:i,_imageFormatsNode:n=t}=globalThis;return Boolean(i)&&n.includes(e)}const TEST_IMAGE={"image/avif":"data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A=","image/webp":"data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA"};async function checkBrowserImageFormatSupportAsync(e){const t=TEST_IMAGE[e];return!t||await testBrowserImageFormatSupportAsync(t)}async function testBrowserImageFormatSupportAsync(e){return new Promise((t=>{const i=new Image;i.src=e,i.onload=()=>t(i.height>0),i.onerror=()=>t(!1)}))}var log$3=new Log({id:"deck"});let loggers={};function register(e){loggers=e}function debug(e,t,i,n){log$3.level>0&&loggers[e]&&loggers[e].call(null,t,i,n)}function isJSON(e){const t=e[0],i=e[e.length-1];return"{"===t&&"}"===i||"["===t&&"]"===i}var jsonLoader={id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:isJSON,parseTextSync:JSON.parse};function checkVersion(){const e="8.9.36",t=globalThis.deck&&globalThis.deck.VERSION;if(t&&t!==e)throw new Error("deck.gl - multiple versions detected: ".concat(t," vs ").concat(e));return t||(log$3.log(1,"deck.gl ".concat(e))(),globalThis.deck={...globalThis.deck,VERSION:e,version:e,log:log$3,_registerLoggers:register},registerLoaders([jsonLoader,[ImageLoader$1,{imagebitmap:{premultiplyAlpha:"none"}}]])),e}const VERSION$6=checkVersion(),COORDINATE_SYSTEM={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(COORDINATE_SYSTEM,"IDENTITY",{get:()=>(log$3.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const PROJECTION_MODE={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},UNIT={common:0,meters:1,pixels:2},EVENTS={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},log$2=new Log({id:"luma.gl"});function assert$9(e,t){if(!e)throw new Error(t||"luma.gl: assertion failed.")}const ERR_CONTEXT="Invalid WebGLRenderingContext",ERR_WEBGL2="Requires WebGL2";function isWebGL(e){return"undefined"!=typeof WebGLRenderingContext&&e instanceof WebGLRenderingContext||("undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||Boolean(e&&Number.isFinite(e._version)))}function isWebGL2$1(e){return"undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||Boolean(e&&2===e._version)}function getWebGL2Context(e){return isWebGL2$1(e)?e:null}function assertWebGLContext(e){return assert$9(isWebGL(e),ERR_CONTEXT),e}function assertWebGL2Context(e){return assert$9(isWebGL2$1(e),ERR_WEBGL2),e}const glErrorShadow={};function error$1(e){globalThis.console&&globalThis.console.error&&globalThis.console.error(e)}function log$1(e){globalThis.console&&globalThis.console.log&&globalThis.console.log(e)}function synthesizeGLError(e,t){glErrorShadow[e]=!0,error$1(t)}function wrapGLError(e){const t=e.getError;e.getError=function(){let i;do{i=t.apply(e),0!==i&&(glErrorShadow[i]=!0)}while(0!==i);for(i in glErrorShadow)if(glErrorShadow[i])return delete glErrorShadow[i],parseInt(i,10);return 0}}const WebGLVertexArrayObjectOES=function e(t){const i=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(let t=0;t<this.attribs.length;t++){const n=new e.VertexAttrib(i);this.attribs[t]=n}this.maxAttrib=0};WebGLVertexArrayObjectOES.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()},WebGLVertexArrayObjectOES.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};const OESVertexArrayObject=function(e){const t=this;this.gl=e,wrapGLError(e);const i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(e){return e===t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject===t.defaultVertexArrayObject?null:t.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(e){const n=t.currentVertexArrayObject;n.maxAttrib=Math.max(n.maxAttrib,e);return n.attribs[e].enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(e){const n=t.currentVertexArrayObject;n.maxAttrib=Math.max(n.maxAttrib,e);return n.attribs[e].enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(e,n){switch(e){case 34962:t.currentArrayBuffer=n;break;case 34963:t.currentVertexArrayObject.elementArrayBuffer=n}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(e,n){const r=t.currentVertexArrayObject.attribs[e];switch(n){case 34975:return r.buffer;case 34338:return r.enabled;case 34339:return r.size;case 34340:return r.stride;case 34341:return r.type;case 34922:return r.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(e,n,r,o,s,a){const l=t.currentVertexArrayObject;l.maxAttrib=Math.max(l.maxAttrib,e);const c=l.attribs[e];return c.buffer=t.currentArrayBuffer,c.size=n,c.type=r,c.normalized=o,c.stride=s,c.offset=a,c.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",(()=>{log$1("OESVertexArrayObject emulation library context restored"),t.reset_()}),!0),this.reset_()};function polyfillVertexArrayObject(e){if("function"==typeof e.createVertexArray)return;const t=e.getSupportedExtensions;e.getSupportedExtensions=function(){const e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};const i=e.getExtension;e.getExtension=function(t){const n=i.call(this,t);return n||("OES_vertex_array_object"!==t?null:(e.__OESVertexArrayObject||(this.__OESVertexArrayObject=new OESVertexArrayObject(this)),this.__OESVertexArrayObject))}}OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=34229,OESVertexArrayObject.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(let e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;this.maxVertexAttribs=this.gl.getParameter(34921),this.defaultVertexArrayObject=new WebGLVertexArrayObjectOES(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.createVertexArrayOES=function(){const e=new WebGLVertexArrayObjectOES(this);return this.vertexArrayObjects.push(e),e},OESVertexArrayObject.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof WebGLVertexArrayObjectOES&&e.hasBeenBound&&e.ext===this)},OESVertexArrayObject.prototype.bindVertexArrayOES=function(e){const t=this.gl;if(e&&!e.isAlive)return void synthesizeGLError(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");const i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;const r=this.currentVertexArrayObject;if(n===r)return;n&&r.elementArrayBuffer===n.elementArrayBuffer||i.bindBuffer.call(t,34963,r.elementArrayBuffer);let o=this.currentArrayBuffer;const s=Math.max(n?n.maxAttrib:0,r.maxAttrib);for(let e=0;e<=s;e++){const s=r.attribs[e],a=n?n.attribs[e]:null;if(n&&s.enabled===a.enabled||(s.enabled?i.enableVertexAttribArray.call(t,e):i.disableVertexAttribArray.call(t,e)),s.enabled){let r=!1;n&&s.buffer===a.buffer||(o!==s.buffer&&(i.bindBuffer.call(t,34962,s.buffer),o=s.buffer),r=!0),(r||s.cached!==a.cached)&&i.vertexAttribPointer.call(t,e,s.size,s.type,s.normalized,s.stride,s.offset)}}this.currentArrayBuffer!==o&&i.bindBuffer.call(t,34962,this.currentArrayBuffer)};const OES_element_index="OES_element_index",WEBGL_draw_buffers$1="WEBGL_draw_buffers",EXT_disjoint_timer_query$1="EXT_disjoint_timer_query",EXT_disjoint_timer_query_webgl2="EXT_disjoint_timer_query_webgl2",EXT_texture_filter_anisotropic$1="EXT_texture_filter_anisotropic",WEBGL_debug_renderer_info="WEBGL_debug_renderer_info",GL_FRAGMENT_SHADER_DERIVATIVE_HINT=35723,GL_DONT_CARE=4352,GL_GPU_DISJOINT_EXT$1=36795,GL_MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047,GL_UNMASKED_VENDOR_WEBGL=37445,GL_UNMASKED_RENDERER_WEBGL=37446,getWebGL2ValueOrZero=e=>isWebGL2$1(e)?void 0:0,WEBGL_PARAMETERS={3074:e=>isWebGL2$1(e)?void 0:36064,[GL_FRAGMENT_SHADER_DERIVATIVE_HINT]:e=>isWebGL2$1(e)?void 0:GL_DONT_CARE,35977:getWebGL2ValueOrZero,32937:getWebGL2ValueOrZero,[GL_GPU_DISJOINT_EXT$1]:(e,t)=>{const i=isWebGL2$1(e)?e.getExtension(EXT_disjoint_timer_query_webgl2):e.getExtension(EXT_disjoint_timer_query$1);return i&&i.GPU_DISJOINT_EXT?t(i.GPU_DISJOINT_EXT):0},[GL_UNMASKED_VENDOR_WEBGL]:(e,t)=>{const i=e.getExtension(WEBGL_debug_renderer_info);return t(i&&i.UNMASKED_VENDOR_WEBGL||7936)},[GL_UNMASKED_RENDERER_WEBGL]:(e,t)=>{const i=e.getExtension(WEBGL_debug_renderer_info);return t(i&&i.UNMASKED_RENDERER_WEBGL||7937)},[GL_MAX_TEXTURE_MAX_ANISOTROPY_EXT]:(e,t)=>{const i=e.luma.extensions[EXT_texture_filter_anisotropic$1];return i?t(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},32883:getWebGL2ValueOrZero,35071:getWebGL2ValueOrZero,37447:getWebGL2ValueOrZero,36063:(e,t)=>{if(!isWebGL2$1(e)){const i=e.getExtension(WEBGL_draw_buffers$1);return i?t(i.MAX_COLOR_ATTACHMENTS_WEBGL):0}},35379:getWebGL2ValueOrZero,35374:getWebGL2ValueOrZero,35377:getWebGL2ValueOrZero,34852:e=>{if(!isWebGL2$1(e)){const t=e.getExtension(WEBGL_draw_buffers$1);return t?t.MAX_DRAW_BUFFERS_WEBGL:0}},36203:e=>e.getExtension(OES_element_index)?2147483647:65535,33001:e=>e.getExtension(OES_element_index)?16777216:65535,33e3:e=>16777216,37157:getWebGL2ValueOrZero,35373:getWebGL2ValueOrZero,35657:getWebGL2ValueOrZero,36183:getWebGL2ValueOrZero,37137:getWebGL2ValueOrZero,34045:getWebGL2ValueOrZero,35978:getWebGL2ValueOrZero,35979:getWebGL2ValueOrZero,35968:getWebGL2ValueOrZero,35376:getWebGL2ValueOrZero,35375:getWebGL2ValueOrZero,35659:getWebGL2ValueOrZero,37154:getWebGL2ValueOrZero,35371:getWebGL2ValueOrZero,35658:getWebGL2ValueOrZero,35076:getWebGL2ValueOrZero,35077:getWebGL2ValueOrZero,35380:getWebGL2ValueOrZero};function getParameterPolyfill(e,t,i){const n=WEBGL_PARAMETERS[i],r="function"==typeof n?n(e,t,i):n;return void 0!==r?r:t(i)}const OES_vertex_array_object="OES_vertex_array_object",ANGLE_instanced_arrays="ANGLE_instanced_arrays",WEBGL_draw_buffers="WEBGL_draw_buffers",EXT_disjoint_timer_query="EXT_disjoint_timer_query",EXT_texture_filter_anisotropic="EXT_texture_filter_anisotropic",ERR_VAO_NOT_SUPPORTED="VertexArray requires WebGL2 or OES_vertex_array_object extension";function getExtensionData(e,t){return{webgl2:isWebGL2$1(e),ext:e.getExtension(t)}}const WEBGL2_CONTEXT_POLYFILLS={[OES_vertex_array_object]:{meta:{suffix:"OES"},createVertexArray:()=>{assert$9(!1,ERR_VAO_NOT_SUPPORTED)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[ANGLE_instanced_arrays]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(e,t){assert$9(0===t,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[WEBGL_draw_buffers]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{assert$9(!1)}},[EXT_disjoint_timer_query]:{meta:{suffix:"EXT"},createQuery:()=>{assert$9(!1)},deleteQuery:()=>{assert$9(!1)},beginQuery:()=>{assert$9(!1)},endQuery:()=>{},getQuery(e,t){return this.getQueryObject(e,t)},getQueryParameter(e,t){return this.getQueryObject(e,t)},getQueryObject:()=>{}}},WEBGL2_CONTEXT_OVERRIDES={readBuffer:(e,t,i)=>{isWebGL2$1(e)&&t(i)},getVertexAttrib:(e,t,i,n)=>{const{webgl2:r,ext:o}=getExtensionData(e,ANGLE_instanced_arrays);let s;switch(n){case 35069:s=!!r&&void 0;break;case 35070:s=r||o?void 0:0}return void 0!==s?s:t(i,n)},getProgramParameter:(e,t,i,n)=>{if(!isWebGL2$1(e))switch(n){case 35967:return 35981;case 35971:case 35382:return 0}return t(i,n)},getInternalformatParameter:(e,t,i,n,r)=>isWebGL2$1(e)||32937!==r?e.getInternalformatParameter(i,n,r):new Int32Array([0]),getTexParameter(e,t,i,n){if(34046===n){const{extensions:t}=e.luma,i=t[EXT_texture_filter_anisotropic];n=i&&i.TEXTURE_MAX_ANISOTROPY_EXT||34046}return t(i,n)},getParameter:getParameterPolyfill,hint:(e,t,i,n)=>t(i,n)};function polyfillContext(e){e.luma=e.luma||{};const{luma:t}=e;return t.polyfilled||(polyfillVertexArrayObject(e),initializeExtensions(e),installPolyfills(e,WEBGL2_CONTEXT_POLYFILLS),installOverrides(e,{target:t,target2:e}),t.polyfilled=!0),e}function initializeExtensions(e){e.luma.extensions={};const t=e.getSupportedExtensions()||[];for(const i of t)e.luma[i]=e.getExtension(i)}function installOverrides(e,t){let{target:i,target2:n}=t;Object.keys(WEBGL2_CONTEXT_OVERRIDES).forEach((t=>{if("function"==typeof WEBGL2_CONTEXT_OVERRIDES[t]){const r=e[t]?e[t].bind(e):()=>{},o=WEBGL2_CONTEXT_OVERRIDES[t].bind(null,e,r);i[t]=o,n[t]=o}}))}function installPolyfills(e,t){for(const i of Object.getOwnPropertyNames(t))"overrides"!==i&&polyfillExtension(e,{extension:i,target:e.luma,target2:e})}function polyfillExtension(e,t){let{extension:i,target:n,target2:r}=t;const o=WEBGL2_CONTEXT_POLYFILLS[i];assert$9(o);const{meta:s={}}=o,{suffix:a=""}=s,l=e.getExtension(i);for(const t of Object.keys(o)){const i="".concat(t).concat(a);let s=null;"meta"===t||"function"==typeof e[t]||(l&&"function"==typeof l[i]?s=function(){return l[i](...arguments)}:"function"==typeof o[t]&&(s=o[t].bind(n))),s&&(n[t]=s,r[t]=s)}}globalThis.polyfillContext=polyfillContext;const GL_PARAMETER_DEFAULTS={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,36006:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],3333:4,3317:4,37440:!1,37441:!1,37443:37444,35723:4352,36010:null,35977:!1,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},enable=(e,t,i)=>t?e.enable(i):e.disable(i),hint=(e,t,i)=>e.hint(i,t),pixelStorei=(e,t,i)=>e.pixelStorei(i,t),drawFramebuffer=(e,t)=>{const i=isWebGL2$1(e)?36009:36160;return e.bindFramebuffer(i,t)},readFramebuffer=(e,t)=>e.bindFramebuffer(36008,t);function isArray$2(e){return Array.isArray(e)||ArrayBuffer.isView(e)}const GL_PARAMETER_SETTERS={3042:enable,32773:(e,t)=>e.blendColor(...t),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(e,t)=>e.clearColor(...t),3107:(e,t)=>e.colorMask(...t),2884:enable,2885:(e,t)=>e.cullFace(t),2929:enable,2931:(e,t)=>e.clearDepth(t),2932:(e,t)=>e.depthFunc(t),2928:(e,t)=>e.depthRange(...t),2930:(e,t)=>e.depthMask(t),3024:enable,35723:hint,36006:drawFramebuffer,2886:(e,t)=>e.frontFace(t),33170:hint,2849:(e,t)=>e.lineWidth(t),32823:enable,32824:"polygonOffset",10752:"polygonOffset",35977:enable,32938:"sampleCoverage",32939:"sampleCoverage",3089:enable,3088:(e,t)=>e.scissor(...t),2960:enable,2961:(e,t)=>e.clearStencil(t),2968:(e,t)=>e.stencilMaskSeparate(1028,t),36005:(e,t)=>e.stencilMaskSeparate(1029,t),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(e,t)=>e.viewport(...t),3333:pixelStorei,3317:pixelStorei,37440:pixelStorei,37441:pixelStorei,37443:pixelStorei,3330:pixelStorei,3332:pixelStorei,3331:pixelStorei,36010:readFramebuffer,3314:pixelStorei,32878:pixelStorei,3316:pixelStorei,3315:pixelStorei,32877:pixelStorei,framebuffer:(e,t)=>e.bindFramebuffer(36160,t&&"handle"in t?t.handle:t),blend:(e,t)=>t?e.enable(3042):e.disable(3042),blendColor:(e,t)=>e.blendColor(...t),blendEquation:(e,t)=>{t=isArray$2(t)?t:[t,t],e.blendEquationSeparate(...t)},blendFunc:(e,t)=>{t=isArray$2(t)&&2===t.length?[...t,...t]:t,e.blendFuncSeparate(...t)},clearColor:(e,t)=>e.clearColor(...t),clearDepth:(e,t)=>e.clearDepth(t),clearStencil:(e,t)=>e.clearStencil(t),colorMask:(e,t)=>e.colorMask(...t),cull:(e,t)=>t?e.enable(2884):e.disable(2884),cullFace:(e,t)=>e.cullFace(t),depthTest:(e,t)=>t?e.enable(2929):e.disable(2929),depthFunc:(e,t)=>e.depthFunc(t),depthMask:(e,t)=>e.depthMask(t),depthRange:(e,t)=>e.depthRange(...t),dither:(e,t)=>t?e.enable(3024):e.disable(3024),derivativeHint:(e,t)=>{e.hint(35723,t)},frontFace:(e,t)=>e.frontFace(t),mipmapHint:(e,t)=>e.hint(33170,t),lineWidth:(e,t)=>e.lineWidth(t),polygonOffsetFill:(e,t)=>t?e.enable(32823):e.disable(32823),polygonOffset:(e,t)=>e.polygonOffset(...t),sampleCoverage:(e,t)=>e.sampleCoverage(...t),scissorTest:(e,t)=>t?e.enable(3089):e.disable(3089),scissor:(e,t)=>e.scissor(...t),stencilTest:(e,t)=>t?e.enable(2960):e.disable(2960),stencilMask:(e,t)=>{t=isArray$2(t)?t:[t,t];const[i,n]=t;e.stencilMaskSeparate(1028,i),e.stencilMaskSeparate(1029,n)},stencilFunc:(e,t)=>{t=isArray$2(t)&&3===t.length?[...t,...t]:t;const[i,n,r,o,s,a]=t;e.stencilFuncSeparate(1028,i,n,r),e.stencilFuncSeparate(1029,o,s,a)},stencilOp:(e,t)=>{t=isArray$2(t)&&3===t.length?[...t,...t]:t;const[i,n,r,o,s,a]=t;e.stencilOpSeparate(1028,i,n,r),e.stencilOpSeparate(1029,o,s,a)},viewport:(e,t)=>e.viewport(...t)};function getValue(e,t,i){return void 0!==t[e]?t[e]:i[e]}const GL_COMPOSITE_PARAMETER_SETTERS={blendEquation:(e,t,i)=>e.blendEquationSeparate(getValue(32777,t,i),getValue(34877,t,i)),blendFunc:(e,t,i)=>e.blendFuncSeparate(getValue(32969,t,i),getValue(32968,t,i),getValue(32971,t,i),getValue(32970,t,i)),polygonOffset:(e,t,i)=>e.polygonOffset(getValue(32824,t,i),getValue(10752,t,i)),sampleCoverage:(e,t,i)=>e.sampleCoverage(getValue(32938,t,i),getValue(32939,t,i)),stencilFuncFront:(e,t,i)=>e.stencilFuncSeparate(1028,getValue(2962,t,i),getValue(2967,t,i),getValue(2963,t,i)),stencilFuncBack:(e,t,i)=>e.stencilFuncSeparate(1029,getValue(34816,t,i),getValue(36003,t,i),getValue(36004,t,i)),stencilOpFront:(e,t,i)=>e.stencilOpSeparate(1028,getValue(2964,t,i),getValue(2965,t,i),getValue(2966,t,i)),stencilOpBack:(e,t,i)=>e.stencilOpSeparate(1029,getValue(34817,t,i),getValue(34818,t,i),getValue(34819,t,i))},GL_HOOKED_SETTERS={enable:(e,t)=>e({[t]:!0}),disable:(e,t)=>e({[t]:!1}),pixelStorei:(e,t,i)=>e({[t]:i}),hint:(e,t,i)=>e({[t]:i}),bindFramebuffer:(e,t,i)=>{switch(t){case 36160:return e({36006:i,36010:i});case 36009:return e({36006:i});case 36008:return e({36010:i});default:return null}},blendColor:(e,t,i,n,r)=>e({32773:new Float32Array([t,i,n,r])}),blendEquation:(e,t)=>e({32777:t,34877:t}),blendEquationSeparate:(e,t,i)=>e({32777:t,34877:i}),blendFunc:(e,t,i)=>e({32969:t,32968:i,32971:t,32970:i}),blendFuncSeparate:(e,t,i,n,r)=>e({32969:t,32968:i,32971:n,32970:r}),clearColor:(e,t,i,n,r)=>e({3106:new Float32Array([t,i,n,r])}),clearDepth:(e,t)=>e({2931:t}),clearStencil:(e,t)=>e({2961:t}),colorMask:(e,t,i,n,r)=>e({3107:[t,i,n,r]}),cullFace:(e,t)=>e({2885:t}),depthFunc:(e,t)=>e({2932:t}),depthRange:(e,t,i)=>e({2928:new Float32Array([t,i])}),depthMask:(e,t)=>e({2930:t}),frontFace:(e,t)=>e({2886:t}),lineWidth:(e,t)=>e({2849:t}),polygonOffset:(e,t,i)=>e({32824:t,10752:i}),sampleCoverage:(e,t,i)=>e({32938:t,32939:i}),scissor:(e,t,i,n,r)=>e({3088:new Int32Array([t,i,n,r])}),stencilMask:(e,t)=>e({2968:t,36005:t}),stencilMaskSeparate:(e,t,i)=>e({[1028===t?2968:36005]:i}),stencilFunc:(e,t,i,n)=>e({2962:t,2967:i,2963:n,34816:t,36003:i,36004:n}),stencilFuncSeparate:(e,t,i,n,r)=>e({[1028===t?2962:34816]:i,[1028===t?2967:36003]:n,[1028===t?2963:36004]:r}),stencilOp:(e,t,i,n)=>e({2964:t,2965:i,2966:n,34817:t,34818:i,34819:n}),stencilOpSeparate:(e,t,i,n,r)=>e({[1028===t?2964:34817]:i,[1028===t?2965:34818]:n,[1028===t?2966:34819]:r}),viewport:(e,t,i,n,r)=>e({2978:[t,i,n,r]})},isEnabled=(e,t)=>e.isEnabled(t),GL_PARAMETER_GETTERS={3042:isEnabled,2884:isEnabled,2929:isEnabled,3024:isEnabled,32823:isEnabled,32926:isEnabled,32928:isEnabled,3089:isEnabled,2960:isEnabled,35977:isEnabled};function isObjectEmpty$1(e){for(const t in e)return!1;return!0}function deepArrayEqual(e,t){if(e===t)return!0;const i=Array.isArray(e)||ArrayBuffer.isView(e),n=Array.isArray(t)||ArrayBuffer.isView(t);if(i&&n&&e.length===t.length){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}return!1}function installGetterOverride(e,t){const i=e[t].bind(e);e[t]=function(){const t=arguments.length<=0?void 0:arguments[0];return t in e.state.cache&&e.state.enable?e.state.cache[t]:i(...arguments)},Object.defineProperty(e[t],"name",{value:"".concat(t,"-from-cache"),configurable:!1})}function installSetterSpy(e,t,i){const n=e[t].bind(e);e[t]=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];const{valueChanged:s,oldValue:a}=i(e.state._updateCache,...r);return s&&n(...r),a},Object.defineProperty(e[t],"name",{value:"".concat(t,"-to-cache"),configurable:!1})}function installProgramSpy(e){const t=e.useProgram.bind(e);e.useProgram=function(i){e.state.program!==i&&(t(i),e.state.program=i)}}class GLState{constructor(e){let{copyState:t=!1,log:i=()=>{}}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=t?getParameters(e):Object.assign({},GL_PARAMETER_DEFAULTS),this.log=i,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){this.stateStack.push({})}pop(){assert$9(this.stateStack.length>0);setParameters(this.gl,this.stateStack[this.stateStack.length-1]),this.stateStack.pop()}_updateCache(e){let t,i=!1;const n=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(const r in e){assert$9(void 0!==r);const o=e[r],s=this.cache[r];deepArrayEqual(o,s)||(i=!0,t=s,n&&!(r in n)&&(n[r]=s),this.cache[r]=o)}return{valueChanged:i,oldValue:t}}}function trackContextState(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{enable:i=!0,copyState:n}=t;if(assert$9(void 0!==n),!e.state){const{polyfillContext:t}=globalThis;t&&t(e),e.state=new GLState(e,{copyState:n}),installProgramSpy(e);for(const t in GL_HOOKED_SETTERS){installSetterSpy(e,t,GL_HOOKED_SETTERS[t])}installGetterOverride(e,"getParameter"),installGetterOverride(e,"isEnabled")}return e.state.enable=i,e}function pushContextState(e){e.state||trackContextState(e,{copyState:!1}),e.state.push()}function popContextState(e){assert$9(e.state),e.state.pop()}function setParameters(e,t){if(assert$9(isWebGL(e),"setParameters requires a WebGL context"),isObjectEmpty$1(t))return;const i={};for(const n in t){const r=Number(n),o=GL_PARAMETER_SETTERS[n];o&&("string"==typeof o?i[o]=!0:o(e,t[n],r))}const n=e.state&&e.state.cache;if(n)for(const r in i){(0,GL_COMPOSITE_PARAMETER_SETTERS[r])(e,t,n)}}function getParameters(e,t){if("number"==typeof(t=t||GL_PARAMETER_DEFAULTS)){const i=t,n=GL_PARAMETER_GETTERS[i];return n?n(e,i):e.getParameter(i)}const i=Array.isArray(t)?t:Object.keys(t),n={};for(const t of i){const i=GL_PARAMETER_GETTERS[t];n[t]=i?i(e,Number(t)):e.getParameter(Number(t))}return n}function resetParameters(e){setParameters(e,GL_PARAMETER_DEFAULTS)}function withParameters(e,t,i){if(isObjectEmpty$1(t))return i(e);const{nocatch:n=!0}=t;let r;if(pushContextState(e),setParameters(e,t),n)r=i(e),popContextState(e);else try{r=i(e)}finally{popContextState(e)}return r}function cssToDeviceRatio(e){const{luma:t}=e;if(e.canvas&&t){const i=t.canvasSizeInfo,n="clientWidth"in i?i.clientWidth:e.canvas.clientWidth;return n?e.drawingBufferWidth/n:1}return 1}function cssToDevicePixels(e,t){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return scalePixels$1(t,cssToDeviceRatio(e),e.drawingBufferWidth,e.drawingBufferHeight,i)}function getDevicePixelRatio(e){const t="undefined"==typeof window?1:window.devicePixelRatio||1;return Number.isFinite(e)?e<=0?1:e:e?t:1}function scalePixels$1(e,t,i,n,r){const o=scaleX(e[0],t,i);let s=scaleY(e[1],t,n,r),a=scaleX(e[0]+1,t,i);const l=a===i-1?a:a-1;let c;return a=scaleY(e[1]+1,t,n,r),r?(a=0===a?a:a+1,c=s,s=a):c=a===n-1?a:a-1,{x:o,y:s,width:Math.max(l-o+1,1),height:Math.max(c-s+1,1)}}function scaleX(e,t,i){return Math.min(Math.round(e*t),i-1)}function scaleY(e,t,i,n){return n?Math.max(0,i-1-Math.round(e*t)):Math.min(Math.round(e*t),i-1)}const isBrowser=isBrowser$1(),isPage$1=isBrowser&&"undefined"!=typeof document,CONTEXT_DEFAULTS={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function createGLContext(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};assert$9(isBrowser,"createGLContext only available in the browser.\nCreate your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils"),e=Object.assign({},CONTEXT_DEFAULTS,e);const{width:t,height:i}=e;function n(t){if(e.throwOnError)throw new Error(t);return null}let r;e.onError=n;const{canvas:o}=e;return r=createBrowserContext(getCanvas({canvas:o,width:t,height:i,onError:n}),e),r?(r=instrumentGLContext(r,e),logInfo(r),r):null}function instrumentGLContext(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e||e._instrumented)return e;e._version=e._version||getVersion(e),e.luma=e.luma||{},e.luma.canvasSizeInfo=e.luma.canvasSizeInfo||{},t=Object.assign({},CONTEXT_DEFAULTS,t);const{manageState:i,debug:n}=t;return i&&trackContextState(e,{copyState:!1,log:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return log$2.log(1,...t)()}}),isBrowser&&n&&(globalThis.makeDebugContext?(e=globalThis.makeDebugContext(e,t),log$2.level=Math.max(log$2.level,1)):log$2.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),e._instrumented=!0,e}function getContextDebugInfo(e){const t=e.getParameter(7936),i=e.getParameter(7937),n=e.getExtension("WEBGL_debug_renderer_info");return{vendor:n&&e.getParameter(n.UNMASKED_VENDOR_WEBGL||7936)||t,renderer:n&&e.getParameter(n.UNMASKED_RENDERER_WEBGL||7937)||i,vendorMasked:t,rendererMasked:i,version:e.getParameter(7938),shadingLanguageVersion:e.getParameter(35724)}}function resizeGLContext(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.canvas){return void setDevicePixelRatio(e,getDevicePixelRatio(t.useDevicePixels),t)}const i=e.getExtension("STACKGL_resize_drawingbuffer");i&&"width"in t&&"height"in t&&i.resize(t.width,t.height)}function createBrowserContext(e,t){const{onError:i}=t;let n=null;const r=e=>n=e.statusMessage||n;e.addEventListener("webglcontextcreationerror",r,!1);const{webgl1:o=!0,webgl2:s=!0}=t;let a=null;return s&&(a=a||e.getContext("webgl2",t),a=a||e.getContext("experimental-webgl2",t)),o&&(a=a||e.getContext("webgl",t),a=a||e.getContext("experimental-webgl",t)),e.removeEventListener("webglcontextcreationerror",r,!1),a?(t.onContextLost&&e.addEventListener("webglcontextlost",t.onContextLost,!1),t.onContextRestored&&e.addEventListener("webglcontextrestored",t.onContextRestored,!1),a):i("Failed to create ".concat(s&&!o?"WebGL2":"WebGL"," context: ").concat(n||"Unknown error"))}function getCanvas(e){let t,{canvas:i,width:n=800,height:r=600,onError:o}=e;if("string"==typeof i){isPage$1&&"complete"===document.readyState||o("createGLContext called on canvas '".concat(i,"' before page was loaded")),t=document.getElementById(i)}else i?t=i:(t=document.createElement("canvas"),t.id="lumagl-canvas",t.style.width=Number.isFinite(n)?"".concat(n,"px"):"100%",t.style.height=Number.isFinite(r)?"".concat(r,"px"):"100%",document.body.insertBefore(t,document.body.firstChild));return t}function logInfo(e){const t=isWebGL2$1(e)?"WebGL2":"WebGL1",i=getContextDebugInfo(e),n=i?"(".concat(i.vendor,",").concat(i.renderer,")"):"",r=e.debug?" debug":"";log$2.info(1,"".concat(t).concat(r," context ").concat(n))()}function getVersion(e){return"undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext?2:1}function setDevicePixelRatio(e,t,i){let n="width"in i?i.width:e.canvas.clientWidth,r="height"in i?i.height:e.canvas.clientHeight;n&&r||(log$2.log(1,"Canvas clientWidth/clientHeight is 0")(),t=1,n=e.canvas.width||1,r=e.canvas.height||1),e.luma=e.luma||{},e.luma.canvasSizeInfo=e.luma.canvasSizeInfo||{};const o=e.luma.canvasSizeInfo;if(o.clientWidth!==n||o.clientHeight!==r||o.devicePixelRatio!==t){let i=t;const o=Math.floor(n*i),s=Math.floor(r*i);e.canvas.width=o,e.canvas.height=s,e.drawingBufferWidth===o&&e.drawingBufferHeight===s||(log$2.warn("Device pixel ratio clamped")(),i=Math.min(e.drawingBufferWidth/n,e.drawingBufferHeight/r),e.canvas.width=Math.floor(n*i),e.canvas.height=Math.floor(r*i)),Object.assign(e.luma.canvasSizeInfo,{clientWidth:n,clientHeight:r,devicePixelRatio:t})}}const VERSION$5="8.5.21",STARTUP_MESSAGE="set luma.log.level=1 (or higher) to trace rendering";class StatsManager{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new Stats({id:e})),this.stats.get(e)}}const lumaStats=new StatsManager;if(globalThis.luma&&globalThis.luma.VERSION!==VERSION$5)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(VERSION$5));function requestAnimationFrame$1(e){return"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(e):setTimeout(e,1e3/60)}function cancelAnimationFrame$1(e){return"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(e):clearTimeout(e)}function assert$8(e,t){if(!e)throw new Error(t||"luma.gl: assertion failed.")}function getKeyValue(e,t){if("string"!=typeof t)return t;const i=Number(t);if(!isNaN(i))return i;const n=e[t=t.replace(/^.*\./,"")];return assert$8(void 0!==n,"Accessing undefined constant GL.".concat(t)),n}function getKey(e,t){t=Number(t);for(const i in e)if(e[i]===t)return"GL.".concat(i);return String(t)}globalThis.luma||(isBrowser$1()&&log$2.log(1,"luma.gl ".concat(VERSION$5," - ").concat(STARTUP_MESSAGE))(),globalThis.luma=globalThis.luma||{VERSION:VERSION$5,version:VERSION$5,log:log$2,stats:lumaStats,globals:{modules:{},nodeIO:{}}});const uidCounters={};function uid(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"id";uidCounters[e]=uidCounters[e]||1;const t=uidCounters[e]++;return"".concat(e,"-").concat(t)}function isPowerOfTwo$1(e){return assert$8("number"==typeof e,"Input must be a number"),e&&!(e&e-1)}function isObjectEmpty(e){let t=!0;for(const i in e){t=!1;break}return t}function stubRemovedMethods(e,t,i,n){const r="See luma.gl ".concat(i," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),o=Object.getPrototypeOf(e);n.forEach((e=>{o.methodName||(o[e]=()=>{throw log$2.removed("Calling removed method ".concat(t,".").concat(e,": "),r)(),new Error(e)})}))}const ERR_RESOURCE_METHOD_UNDEFINED="Resource subclass must define virtual methods";let Resource$1=class{get[Symbol.toStringTag](){return"Resource"}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};assertWebGLContext(e);const{id:i,userData:n={}}=t;this.gl=e,this.gl2=e,this.id=i||uid(this[Symbol.toStringTag]),this.userData=n,this._bound=!1,this._handle=t.handle,void 0===this._handle&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach((e=>e.delete())),this}bind(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.handle;return"function"!=typeof t?(this._bindHandle(t),this):(this._bound?e=t():(this._bindHandle(this.handle),this._bound=!0,e=t(),this._bound=!1,this._bindHandle(null)),e)}unbind(){this.bind(null)}getParameter(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};assert$8(e=getKeyValue(this.gl,e));const i=(this.constructor.PARAMETERS||{})[e];if(i){const e=isWebGL2$1(this.gl);if(!((!("webgl2"in i)||e)&&(!("extension"in i)||this.gl.getExtension(i.extension)))){return e?"webgl2"in i?i.webgl2:i.webgl1:i.webgl1}}return this._getParameter(e,t)}getParameters(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{parameters:t,keys:i}=e,n=this.constructor.PARAMETERS||{},r=isWebGL2$1(this.gl),o={},s=t||Object.keys(n);for(const t of s){const s=n[t];if(s&&(!("webgl2"in s)||r)&&(!("extension"in s)||this.gl.getExtension(s.extension))){const n=i?getKey(this.gl,t):t;o[n]=this.getParameter(t,e),i&&"GLenum"===s.type&&(o[n]=getKey(this.gl,o[n]))}}return o}setParameter(e,t){assert$8(e=getKeyValue(this.gl,e));const i=(this.constructor.PARAMETERS||{})[e];if(i){const e=isWebGL2$1(this.gl);if(!((!("webgl2"in i)||e)&&(!("extension"in i)||this.gl.getExtension(i.extension))))throw new Error("Parameter not available on this platform");"GLenum"===i.type&&(t=getKeyValue(t))}return this._setParameter(e,t),this}setParameters(e){for(const t in e)this.setParameter(t,e[t]);return this}stubRemovedMethods(e,t,i){return stubRemovedMethods(this,e,t,i)}initialize(e){}_createHandle(){throw new Error(ERR_RESOURCE_METHOD_UNDEFINED)}_deleteHandle(){throw new Error(ERR_RESOURCE_METHOD_UNDEFINED)}_bindHandle(e){throw new Error(ERR_RESOURCE_METHOD_UNDEFINED)}_getOptsFromHandle(){throw new Error(ERR_RESOURCE_METHOD_UNDEFINED)}_getParameter(e,t){throw new Error(ERR_RESOURCE_METHOD_UNDEFINED)}_setParameter(e,t){throw new Error(ERR_RESOURCE_METHOD_UNDEFINED)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){const e=this[Symbol.toStringTag],t=lumaStats.get("Resource Counts");t.get("Resources Created").incrementCount(),t.get("".concat(e,"s Created")).incrementCount(),t.get("".concat(e,"s Active")).incrementCount()}_removeStats(){const e=this[Symbol.toStringTag];lumaStats.get("Resource Counts").get("".concat(e,"s Active")).decrementCount()}_trackAllocatedMemory(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this[Symbol.toStringTag];this._trackAllocatedMemoryForContext(e,t),this._trackAllocatedMemoryForContext(e,t,this.gl.canvas&&this.gl.canvas.id),this.byteLength=e}_trackAllocatedMemoryForContext(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this[Symbol.toStringTag];const i=lumaStats.get("Memory Usage".concat(arguments.length>2&&void 0!==arguments[2]?arguments[2]:""));i.get("GPU Memory").addCount(e),i.get("".concat(t," Memory")).addCount(e)}_trackDeallocatedMemory(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this[Symbol.toStringTag];this._trackDeallocatedMemoryForContext(e),this._trackDeallocatedMemoryForContext(e,this.gl.canvas&&this.gl.canvas.id),this.byteLength=0}_trackDeallocatedMemoryForContext(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this[Symbol.toStringTag];const t=lumaStats.get("Memory Usage".concat(arguments.length>1&&void 0!==arguments[1]?arguments[1]:""));t.get("GPU Memory").subtractCount(this.byteLength),t.get("".concat(e," Memory")).subtractCount(this.byteLength)}};const ERR_TYPE_DEDUCTION="Failed to deduce GL constant from typed array";function getGLTypeFromTypedArray(e){switch(ArrayBuffer.isView(e)?e.constructor:e){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(ERR_TYPE_DEDUCTION)}}function getTypedArrayFromGLType(e){let{clamped:t=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(e){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function flipRows(e){let{data:t,width:i,height:n,bytesPerPixel:r=4,temp:o}=e;const s=i*r;o=o||new Uint8Array(s);for(let e=0;e<n/2;++e){const i=e*s,r=(n-e-1)*s;o.set(t.subarray(i,i+s)),t.copyWithin(i,r,r+s),t.set(o,r)}}function scalePixels(e){let{data:t,width:i,height:n}=e;const r=Math.round(i/2),o=Math.round(n/2),s=new Uint8Array(r*o*4);for(let e=0;e<o;e++)for(let n=0;n<r;n++)for(let o=0;o<4;o++)s[4*(e*r+n)+o]=t[4*(2*e*i+2*n)+o];return{data:s,width:r,height:o}}function checkProps(e,t,i){const{removedProps:n={},deprecatedProps:r={},replacedProps:o={}}=i;for(const i in n)if(i in t){const t=n[i]?"".concat(e,".").concat(n[i]):"N/A";log$2.removed("".concat(e,".").concat(i),t)()}for(const i in r)if(i in t){const t=r[i];log$2.deprecated("".concat(e,".").concat(i),"".concat(e,".").concat(t))()}let s=null;for(const i in o)if(i in t){const n=o[i];log$2.deprecated("".concat(e,".").concat(i),"".concat(e,".").concat(n))(),s=s||Object.assign({},t),s[n]=t[i],delete s[i]}return s||t}const DEFAULT_ACCESSOR_VALUES={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},PROP_CHECKS={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class Accessor{static getBytesPerElement(e){return getTypedArrayFromGLType(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){assert$8(e.size);return getTypedArrayFromGLType(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return new Accessor(...[DEFAULT_ACCESSOR_VALUES,...t])}constructor(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach((e=>this._assign(e))),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return Accessor.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return Accessor.getBytesPerVertex(this)}_assign(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e=checkProps("Accessor",e,PROP_CHECKS),void 0!==e.type&&(this.type=e.type,5124!==e.type&&5125!==e.type||(this.integer=!0)),void 0!==e.size&&(this.size=e.size),void 0!==e.offset&&(this.offset=e.offset),void 0!==e.stride&&(this.stride=e.stride),void 0!==e.normalized&&(this.normalized=e.normalized),void 0!==e.integer&&(this.integer=e.integer),void 0!==e.divisor&&(this.divisor=e.divisor),void 0!==e.buffer&&(this.buffer=e.buffer),void 0!==e.index&&(this.index="boolean"==typeof e.index?e.index?1:0:e.index),void 0!==e.instanced&&(this.divisor=e.instanced?1:0),void 0!==e.isInstanced&&(this.divisor=e.isInstanced?1:0),this}}const DEBUG_DATA_LENGTH=10,DEPRECATED_PROPS={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},PROP_CHECKS_INITIALIZE={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:DEPRECATED_PROPS},PROP_CHECKS_SET_PROPS={removedProps:DEPRECATED_PROPS};class Buffer extends Resource$1{get[Symbol.toStringTag](){return"Buffer"}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(e,t),this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=t.target||(this.gl.webgl2?36662:34962),this.initialize(t),Object.seal(this)}getElementCount(){return Math.round(this.byteLength/Accessor.getBytesPerElement(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.accessor))}getVertexCount(){return Math.round(this.byteLength/Accessor.getBytesPerVertex(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.accessor))}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=checkProps("Buffer",e,PROP_CHECKS_INITIALIZE),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return"accessor"in(e=checkProps("Buffer",e,PROP_CHECKS_SET_PROPS))&&this.setAccessor(e.accessor),this}setAccessor(e){return delete(e=Object.assign({},e)).buffer,this.accessor=new Accessor(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});const{data:t,offset:i=0,srcOffset:n=0}=e,r=e.byteLength||e.length;assert$8(t);const o=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(o,this.handle),0!==n||void 0!==r?(assertWebGL2Context(this.gl),this.gl.bufferSubData(this.target,i,t,n,r)):this.gl.bufferSubData(o,i,t),this.gl.bindBuffer(o,null),this.debugData=null,this._inferType(t),this}copyData(e){let{sourceBuffer:t,readOffset:i=0,writeOffset:n=0,size:r}=e;const{gl:o}=this;return assertWebGL2Context(o),o.bindBuffer(36662,t.handle),o.bindBuffer(36663,this.handle),o.copyBufferSubData(36662,36663,i,n,r),o.bindBuffer(36662,null),o.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:e=null,srcByteOffset:t=0,dstOffset:i=0,length:n=0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};assertWebGL2Context(this.gl);const r=getTypedArrayFromGLType(this.accessor.type||5126,{clamped:!1}),o=this._getAvailableElementCount(t),s=i;let a,l;e?(l=e.length,a=l-s):(a=Math.min(o,n||o),l=s+a);const c=Math.min(o,a);return n=n||c,assert$8(n<=c),e=e||new r(l),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,e,i,n),this.gl.bindBuffer(36662,null),e}bind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index,offset:i=0,size:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return 35345===e||35982===e?void 0!==n?this.gl.bindBufferRange(e,t,this.handle,i,n):(assert$8(0===i),this.gl.bindBufferBase(e,t,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return 35345===e||35982===e?this.gl.bindBufferBase(e,t,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(DEBUG_DATA_LENGTH,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.byteLength+t;assert$8(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();const n=this._getTarget();this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,this.usage),this.gl.bufferSubData(n,t,e),this.gl.bindBuffer(n,null),this.debugData=e.slice(0,DEBUG_DATA_LENGTH),this.bytesUsed=i,this._trackAllocatedMemory(i);const r=getGLTypeFromTypedArray(e);return assert$8(r),this.setAccessor(new Accessor(this.accessor,{type:r})),this}_setByteLength(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.usage;assert$8(e>=0),this._trackDeallocatedMemory();let i=e;0===e&&(i=new Float32Array(0));const n=this._getTarget();return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,t),this.gl.bindBuffer(n,null),this.usage=t,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){const t=e/getTypedArrayFromGLType(this.accessor.type||5126,{clamped:!1}).BYTES_PER_ELEMENT;return this.getElementCount()-t}_inferType(e){this.accessor.type||this.setAccessor(new Accessor(this.accessor,{type:getGLTypeFromTypedArray(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);const t=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),t}get type(){return log$2.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return log$2.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return log$2.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return log$2.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new Accessor(this.accessor,e),this}}const TEXTURE_FORMATS={6407:{dataFormat:6407,types:[5121,33635]},6408:{dataFormat:6408,types:[5121,32819,32820]},6406:{dataFormat:6406,types:[5121]},6409:{dataFormat:6409,types:[5121]},6410:{dataFormat:6410,types:[5121]},33326:{dataFormat:6403,types:[5126],gl2:!0},33328:{dataFormat:33319,types:[5126],gl2:!0},34837:{dataFormat:6407,types:[5126],gl2:!0},34836:{dataFormat:6408,types:[5126],gl2:!0}},DATA_FORMAT_CHANNELS={6403:1,36244:1,33319:2,33320:2,6407:3,36248:3,6408:4,36249:4,6402:1,34041:1,6406:1,6409:1,6410:2},TYPE_SIZES={5126:4,5125:4,5124:4,5123:2,5122:2,5131:2,5120:1,5121:1};function isFormatSupported$1(e,t){const i=TEXTURE_FORMATS[t];if(!i)return!1;if(void 0===i.gl1&&void 0===i.gl2)return!0;const n=isWebGL2$1(e)&&i.gl2||i.gl1;return"string"==typeof n?e.getExtension(n):n}function isLinearFilteringSupported(e,t){const i=TEXTURE_FORMATS[t];switch(i&&i.types[0]){case 5126:return e.getExtension("OES_texture_float_linear");case 5131:return e.getExtension("OES_texture_half_float_linear");default:return!0}}const NPOT_MIN_FILTERS=[9729,9728],WebGLBuffer=globalThis.WebGLBuffer||function(){};let Texture$1=class extends Resource$1{get[Symbol.toStringTag](){return"Texture"}static isSupported(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{format:i,linearFiltering:n}=t;let r=!0;return i&&(r=r&&isFormatSupported$1(e,i),r=r&&(!n||isLinearFilteringSupported(e,i))),r}constructor(e,t){const{id:i=uid("texture"),handle:n,target:r}=t;super(e,{id:i,handle:n}),this.target=r,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.data;if(t instanceof Promise)return t.then((t=>this.initialize(Object.assign({},e,{pixels:t,data:t})))),this;const i="undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement;if(i&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",(()=>this.initialize(e))),this;const{pixels:n=null,format:r=6408,border:o=0,recreate:s=!1,parameters:a={},pixelStore:l={},textureUnit:c}=e;t||(t=n);let{width:u,height:h,dataFormat:d,type:p,compressed:f=!1,mipmaps:m=!0}=e;const{depth:g=0}=e;return({width:u,height:h,compressed:f,dataFormat:d,type:p}=this._deduceParameters({format:r,type:p,dataFormat:d,compressed:f,data:t,width:u,height:h})),this.width=u,this.height=h,this.depth=g,this.format=r,this.type=p,this.dataFormat=d,this.border=o,this.textureUnit=c,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),m&&this._isNPOT()&&(log$2.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),m=!1,this._updateForNPOT(a)),this.mipmaps=m,this.setImageData({data:t,width:u,height:h,depth:g,format:r,type:p,dataFormat:d,border:o,mipmaps:m,parameters:l,compressed:f}),m&&this.generateMipmap(),this.setParameters(a),s&&(this.data=t),i&&(this._video={video:t,parameters:a,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}update(){if(this._video){const{video:e,parameters:t,lastTime:i}=this._video;if(i===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize(e){let{height:t,width:i,mipmaps:n=!1}=e;return i!==this.width||t!==this.height?this.initialize({width:i,height:t,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:n}):this}generateMipmap(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._isNPOT()?(log$2.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),withParameters(this.gl,e,(()=>{this.gl.generateMipmap(this.target)})),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");const{target:t=this.target,pixels:i=null,level:n=0,format:r=this.format,border:o=this.border,offset:s=0,parameters:a={}}=e;let{data:l=null,type:c=this.type,width:u=this.width,height:h=this.height,dataFormat:d=this.dataFormat,compressed:p=!1}=e;l||(l=i),({type:c,dataFormat:d,compressed:p,width:u,height:h}=this._deduceParameters({format:r,type:c,dataFormat:d,compressed:p,data:l,width:u,height:h}));const{gl:f}=this;f.bindTexture(this.target,this.handle);let m,g=null;({data:l,dataType:g}=this._getDataType({data:l,compressed:p}));let _=0;if(withParameters(this.gl,a,(()=>{switch(g){case"null":f.texImage2D(t,n,r,u,h,o,d,c,l);break;case"typed-array":f.texImage2D(t,n,r,u,h,o,d,c,l,s);break;case"buffer":m=assertWebGL2Context(f),m.bindBuffer(35052,l.handle||l),m.texImage2D(t,n,r,u,h,o,d,c,s),m.bindBuffer(35052,null);break;case"browser-object":isWebGL2$1(f)?f.texImage2D(t,n,r,u,h,o,d,c,l):f.texImage2D(t,n,r,d,c,l);break;case"compressed":for(const[e,i]of l.entries())f.compressedTexImage2D(t,e,i.format,i.width,i.height,o,i.data),_+=i.levelSize;break;default:assert$8(!1,"Unknown image data type")}})),"compressed"===g)this._trackAllocatedMemory(_,"Texture");else if(l&&l.byteLength)this._trackAllocatedMemory(l.byteLength,"Texture");else{this._trackAllocatedMemory(this.width*this.height*(DATA_FORMAT_CHANNELS[this.dataFormat]||4)*(TYPE_SIZES[this.type]||1),"Texture")}return this.loaded=!0,this}setSubImageData(e){let{target:t=this.target,pixels:i=null,data:n=null,x:r=0,y:o=0,width:s=this.width,height:a=this.height,level:l=0,format:c=this.format,type:u=this.type,dataFormat:h=this.dataFormat,compressed:d=!1,offset:p=0,border:f=this.border,parameters:m={}}=e;if(({type:u,dataFormat:h,compressed:d,width:s,height:a}=this._deduceParameters({format:c,type:u,dataFormat:h,compressed:d,data:n,width:s,height:a})),assert$8(0===this.depth,"texSubImage not supported for 3D textures"),n||(n=i),n&&n.data){const e=n;n=e.data,s=e.shape[0],a=e.shape[1]}n instanceof Buffer&&(n=n.handle),this.gl.bindTexture(this.target,this.handle),withParameters(this.gl,m,(()=>{if(d)this.gl.compressedTexSubImage2D(t,l,r,o,s,a,c,n);else if(null===n)this.gl.texSubImage2D(t,l,r,o,s,a,h,u,null);else if(ArrayBuffer.isView(n))this.gl.texSubImage2D(t,l,r,o,s,a,h,u,n,p);else if(n instanceof WebGLBuffer){const e=assertWebGL2Context(this.gl);e.bindBuffer(35052,n),e.texSubImage2D(t,l,r,o,s,a,h,u,p),e.bindBuffer(35052,null)}else if(isWebGL2$1(this.gl)){assertWebGL2Context(this.gl).texSubImage2D(t,l,r,o,s,a,h,u,n)}else this.gl.texSubImage2D(t,l,r,o,h,u,n)})),this.gl.bindTexture(this.target,null)}copyFramebuffer(){return null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.textureUnit;const{gl:t}=this;return void 0!==e&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.textureUnit;const{gl:t}=this;return void 0!==e&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType(e){let{data:t,compressed:i=!1}=e;return i?{data:t,dataType:"compressed"}:null===t?{data:t,dataType:"null"}:ArrayBuffer.isView(t)?{data:t,dataType:"typed-array"}:t instanceof Buffer?{data:t.handle,dataType:"buffer"}:t instanceof WebGLBuffer?{data:t,dataType:"buffer"}:{data:t,dataType:"browser-object"}}_deduceParameters(e){const{format:t,data:i}=e;let{width:n,height:r,dataFormat:o,type:s,compressed:a}=e;const l=TEXTURE_FORMATS[t];return o=o||l&&l.dataFormat,s=s||l&&l.types[0],a=a||l&&l.compressed,({width:n,height:r}=this._deduceImageSize(i,n,r)),{dataFormat:o,type:s,compressed:a,width:n,height:r,format:t,data:i}}_deduceImageSize(e,t,i){let n;return n="undefined"!=typeof ImageData&&e instanceof ImageData?{width:e.width,height:e.height}:"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?{width:e.naturalWidth,height:e.naturalHeight}:"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?{width:e.width,height:e.height}:"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e?{width:t,height:i}:{width:t>=0?t:1,height:i>=0?i:1},assert$8(n,"Could not deduced texture size"),assert$8(void 0===t||n.width===t,"Deduced texture width does not match supplied width"),assert$8(void 0===i||n.height===i,"Deduced texture height does not match supplied height"),n}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);const t=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),t}}_setParameter(e,t){switch(this.gl.bindTexture(this.target,this.handle),t=this._getNPOTParam(e,t),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,t);break;case 4096:case 4097:assert$8(!1);break;default:this.gl.texParameteri(this.target,e,t)}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return!isWebGL2$1(this.gl)&&(!(!this.width||!this.height)&&(!isPowerOfTwo$1(this.width)||!isPowerOfTwo$1(this.height)))}_updateForNPOT(e){void 0===e[this.gl.TEXTURE_MIN_FILTER]&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),void 0===e[this.gl.TEXTURE_WRAP_S]&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),void 0===e[this.gl.TEXTURE_WRAP_T]&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,t){if(this._isNPOT())switch(e){case 10241:-1===NPOT_MIN_FILTERS.indexOf(t)&&(t=9729);break;case 10242:case 10243:33071!==t&&(t=33071)}return t}},pathPrefix="";function loadImage$1(e,t){return assert$8("string"==typeof e),e=pathPrefix+e,new Promise(((i,n)=>{try{const r=new Image;r.onload=()=>i(r),r.onerror=()=>n(new Error("Could not load image ".concat(e,"."))),r.crossOrigin=t&&t.crossOrigin||"anonymous",r.src=e}catch(e){n(e)}}))}class Texture2D extends Texture$1{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(e,t){return Texture$1.isSupported(e,t)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};assertWebGLContext(e),(t instanceof Promise||"string"==typeof t)&&(t={data:t}),"string"==typeof t.data&&(t=Object.assign({},t,{data:loadImage$1(t.data)})),super(e,Object.assign({},t,{target:3553})),this.initialize(t),Object.seal(this)}}const FACES=[34069,34070,34071,34072,34073,34074];class TextureCube extends Texture$1{get[Symbol.toStringTag](){return"TextureCube"}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};assertWebGLContext(e),super(e,Object.assign({},t,{target:34067})),this.initialize(t),Object.seal(this)}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{mipmaps:t=!0,parameters:i={}}=e;return this.opts=e,this.setCubeMapImageData(e).then((()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setParameters(i)})),this}subImage(e){let{face:t,data:i,x:n=0,y:r=0,mipmapLevel:o=0}=e;return this._subImage({target:t,data:i,x:n,y:r,mipmapLevel:o})}async setCubeMapImageData(e){let{width:t,height:i,pixels:n,data:r,border:o=0,format:s=6408,type:a=5121}=e;const{gl:l}=this,c=n||r,u=await Promise.all(FACES.map((e=>{const t=c[e];return Promise.all(Array.isArray(t)?t:[t])})));this.bind(),FACES.forEach(((e,n)=>{u[n].length>1&&!1!==this.opts.mipmaps&&log$2.warn("".concat(this.id," has mipmap and multiple LODs."))(),u[n].forEach(((n,r)=>{t&&i?l.texImage2D(e,r,s,t,i,o,s,a,n):l.texImage2D(e,r,s,s,a,n)}))})),this.unbind()}setImageDataForFace(e){const{face:t,width:i,height:n,pixels:r,data:o,border:s=0,format:a=6408,type:l=5121}=e,{gl:c}=this,u=r||o;return this.bind(),u instanceof Promise?u.then((i=>this.setImageDataForFace(Object.assign({},e,{face:t,data:i,pixels:i})))):this.width||this.height?c.texImage2D(t,0,a,i,n,s,a,l,u):c.texImage2D(t,0,a,a,l,u),this}}TextureCube.FACES=FACES;class Texture3D extends Texture$1{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(e){return isWebGL2$1(e)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};assertWebGL2Context(e),t=Object.assign({depth:1},t,{target:32879,unpackFlipY:!1}),super(e,t),this.initialize(t),Object.seal(this)}setImageData(e){let{level:t=0,dataFormat:i=6408,width:n,height:r,depth:o=1,border:s=0,format:a,type:l=5121,offset:c=0,data:u,parameters:h={}}=e;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),withParameters(this.gl,h,(()=>{ArrayBuffer.isView(u)&&this.gl.texImage3D(this.target,t,i,n,r,o,s,a,l,u),u instanceof Buffer&&(this.gl.bindBuffer(35052,u.handle),this.gl.texImage3D(this.target,t,i,n,r,o,s,a,l,c))})),u&&u.byteLength)this._trackAllocatedMemory(u.byteLength,"Texture");else{this._trackAllocatedMemory(this.width*this.height*this.depth*(DATA_FORMAT_CHANNELS[this.dataFormat]||4)*(TYPE_SIZES[this.type]||1),"Texture")}return this.loaded=!0,this}}const EXT_FLOAT_WEBGL2="EXT_color_buffer_float";var RENDERBUFFER_FORMATS={33189:{bpp:2},33190:{gl2:!0,bpp:3},36012:{gl2:!0,bpp:4},36168:{bpp:1},34041:{bpp:4},35056:{gl2:!0,bpp:4},36013:{gl2:!0,bpp:5},32854:{bpp:2},36194:{bpp:2},32855:{bpp:2},33321:{gl2:!0,bpp:1},33330:{gl2:!0,bpp:1},33329:{gl2:!0,bpp:1},33332:{gl2:!0,bpp:2},33331:{gl2:!0,bpp:2},33334:{gl2:!0,bpp:4},33333:{gl2:!0,bpp:4},33323:{gl2:!0,bpp:2},33336:{gl2:!0,bpp:2},33335:{gl2:!0,bpp:2},33338:{gl2:!0,bpp:4},33337:{gl2:!0,bpp:4},33340:{gl2:!0,bpp:8},33339:{gl2:!0,bpp:8},32849:{gl2:!0,bpp:3},32856:{gl2:!0,bpp:4},32857:{gl2:!0,bpp:4},36220:{gl2:!0,bpp:4},36238:{gl2:!0,bpp:4},36975:{gl2:!0,bpp:4},36214:{gl2:!0,bpp:8},36232:{gl2:!0,bpp:8},36226:{gl2:!0,bpp:16},36208:{gl2:!0,bpp:16},33325:{gl2:EXT_FLOAT_WEBGL2,bpp:2},33327:{gl2:EXT_FLOAT_WEBGL2,bpp:4},34842:{gl2:EXT_FLOAT_WEBGL2,bpp:8},33326:{gl2:EXT_FLOAT_WEBGL2,bpp:4},33328:{gl2:EXT_FLOAT_WEBGL2,bpp:8},34836:{gl2:EXT_FLOAT_WEBGL2,bpp:16},35898:{gl2:EXT_FLOAT_WEBGL2,bpp:4}};function isFormatSupported(e,t,i){const n=i[t];if(!n)return!1;const r=isWebGL2$1(e)&&n.gl2||n.gl1;return"string"==typeof r?e.getExtension(r):r}class Renderbuffer extends Resource$1{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(e){let{format:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{format:null};return!t||isFormatSupported(e,t,RENDERBUFFER_FORMATS)}static getSamplesForFormat(e,t){let{format:i}=t;return e.getInternalformatParameter(36161,i,32937)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(e,t),this.initialize(t),Object.seal(this)}initialize(e){let{format:t,width:i=1,height:n=1,samples:r=0}=e;return assert$8(t,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),0!==r&&isWebGL2$1(this.gl)?this.gl.renderbufferStorageMultisample(36161,r,t,i,n):this.gl.renderbufferStorage(36161,t,i,n),this.format=t,this.width=i,this.height=n,this.samples=r,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*RENDERBUFFER_FORMATS[this.format].bpp),this}resize(e){let{width:t,height:i}=e;return t!==this.width||i!==this.height?this.initialize({width:t,height:i,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){this.gl.bindRenderbuffer(36161,this.handle);return this.gl.getRenderbufferParameter(36161,e)}}const GL_DEPTH_BUFFER_BIT=256,GL_STENCIL_BUFFER_BIT=1024,GL_COLOR_BUFFER_BIT=16384,GL_COLOR=6144,GL_DEPTH=6145,GL_STENCIL=6146,GL_DEPTH_STENCIL=34041,ERR_ARGUMENTS="clear: bad arguments";function clear(e){let{framebuffer:t=null,color:i=null,depth:n=null,stencil:r=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const o={};t&&(o.framebuffer=t);let s=0;i&&(s|=GL_COLOR_BUFFER_BIT,!0!==i&&(o.clearColor=i)),n&&(s|=GL_DEPTH_BUFFER_BIT,!0!==n&&(o.clearDepth=n)),r&&(s|=GL_STENCIL_BUFFER_BIT,!0!==n&&(o.clearStencil=n)),assert$8(0!==s,ERR_ARGUMENTS),withParameters(e,o,(()=>{e.clear(s)}))}function clearBuffer(e){let{framebuffer:t=null,buffer:i=GL_COLOR,drawBuffer:n=0,value:r=[0,0,0,0]}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};assertWebGL2Context(e),withParameters(e,{framebuffer:t},(()=>{switch(i){case GL_COLOR:switch(r.constructor){case Int32Array:e.clearBufferiv(i,n,r);break;case Uint32Array:e.clearBufferuiv(i,n,r);break;case Float32Array:default:e.clearBufferfv(i,n,r)}break;case GL_DEPTH:e.clearBufferfv(GL_DEPTH,0,[r]);break;case GL_STENCIL:e.clearBufferiv(GL_STENCIL,0,[r]);break;case GL_DEPTH_STENCIL:const[t,o]=r;e.clearBufferfi(GL_DEPTH_STENCIL,0,t,o);break;default:assert$8(!1,ERR_ARGUMENTS)}}))}function glFormatToComponents(e){switch(e){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return assert$8(!1),0}}function readPixelsToArray(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{sourceX:i=0,sourceY:n=0,sourceFormat:r=6408}=t;let{sourceAttachment:o=36064,target:s=null,sourceWidth:a,sourceHeight:l,sourceType:c}=t;const{framebuffer:u,deleteFramebuffer:h}=getFramebuffer$1(e);assert$8(u);const{gl:d,handle:p,attachments:f}=u;a=a||u.width,l=l||u.height,36064===o&&null===p&&(o=1028),assert$8(f[o]),c=c||f[o].type,s=getPixelArray(s,c,r,a,l),c=c||getGLTypeFromTypedArray(s);const m=d.bindFramebuffer(36160,p);return d.readPixels(i,n,a,l,r,c,s),d.bindFramebuffer(36160,m||null),h&&u.delete(),s}function copyToDataUrl(e){let{sourceAttachment:t=36064,targetMaxHeight:i=Number.MAX_SAFE_INTEGER}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=readPixelsToArray(e,{sourceAttachment:t}),{width:r,height:o}=e;for(;o>i;)({data:n,width:r,height:o}=scalePixels({data:n,width:r,height:o}));flipRows({data:n,width:r,height:o});const s=document.createElement("canvas");s.width=r,s.height=o;const a=s.getContext("2d"),l=a.createImageData(r,o);return l.data.set(n),a.putImageData(l,0,0),s.toDataURL()}function copyToTexture(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{sourceX:n=0,sourceY:r=0,targetMipmaplevel:o=0,targetInternalFormat:s=6408}=i;let{targetX:a,targetY:l,targetZ:c,width:u,height:h}=i;const{framebuffer:d,deleteFramebuffer:p}=getFramebuffer$1(e);assert$8(d);const{gl:f,handle:m}=d,g=void 0!==a||void 0!==l||void 0!==c;a=a||0,l=l||0,c=c||0;const _=f.bindFramebuffer(36160,m);assert$8(t);let y=null;if(t instanceof Texture$1&&(y=t,u=Number.isFinite(u)?u:y.width,h=Number.isFinite(h)?h:y.height,y.bind(0),t=y.target),g)switch(t){case 3553:case 34067:f.copyTexSubImage2D(t,o,a,l,n,r,u,h);break;case 35866:case 32879:assertWebGL2Context(f).copyTexSubImage3D(t,o,a,l,c,n,r,u,h)}else f.copyTexImage2D(t,o,s,n,r,u,h,0);return y&&y.unbind(),f.bindFramebuffer(36160,_||null),p&&d.delete(),y}function getFramebuffer$1(e){return e instanceof Framebuffer?{framebuffer:e,deleteFramebuffer:!1}:{framebuffer:toFramebuffer(e),deleteFramebuffer:!0}}function getPixelArray(e,t,i,n,r){if(e)return e;return new(getTypedArrayFromGLType(t=t||5121,{clamped:!1}))(n*r*glFormatToComponents(i))}const FEATURES$1={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function checkFloat32ColorAttachment(e){const t=new Texture2D(e,{format:6408,type:5126,dataFormat:6408}),i=new Framebuffer(e,{id:"test-framebuffer",check:!1,attachments:{36064:t}}),n=i.getStatus();return t.delete(),i.delete(),36053===n}var WEBGL_FEATURES$1={[FEATURES$1.WEBGL2]:[!1,!0],[FEATURES$1.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[FEATURES$1.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[FEATURES$1.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[FEATURES$1.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[FEATURES$1.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[FEATURES$1.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[FEATURES$1.FLOAT_BLEND]:["EXT_float_blend"],[FEATURES$1.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[FEATURES$1.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[FEATURES$1.TEXTURE_FLOAT]:["OES_texture_float",!0],[FEATURES$1.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[FEATURES$1.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[FEATURES$1.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[FEATURES$1.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[FEATURES$1.COLOR_ATTACHMENT_RGBA32F]:[checkFloat32ColorAttachment,"EXT_color_buffer_float"],[FEATURES$1.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[FEATURES$1.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[FEATURES$1.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[FEATURES$1.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[FEATURES$1.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[FEATURES$1.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};const LOG_UNSUPPORTED_FEATURE=2;function hasFeature(e,t){return hasFeatures$1(e,t)}function hasFeatures$1(e,t){return(t=Array.isArray(t)?t:[t]).every((t=>isFeatureSupported(e,t)))}function getFeatures(e){e.luma=e.luma||{},e.luma.caps=e.luma.caps||{};for(const t in WEBGL_FEATURES$1)void 0===e.luma.caps[t]&&(e.luma.caps[t]=isFeatureSupported(e,t));return e.luma.caps}function isFeatureSupported(e,t){return e.luma=e.luma||{},e.luma.caps=e.luma.caps||{},void 0===e.luma.caps[t]&&(e.luma.caps[t]=queryFeature(e,t)),e.luma.caps[t]||log$2.log(LOG_UNSUPPORTED_FEATURE,"Feature: ".concat(t," not supported"))(),e.luma.caps[t]}function queryFeature(e,t){const i=WEBGL_FEATURES$1[t];let n;assert$8(i,t);const r=isWebGL2$1(e)&&i[1]||i[0];if("function"==typeof r)n=r(e);else if(Array.isArray(r)){n=!0;for(const t of r)n=n&&Boolean(e.getExtension(t))}else"string"==typeof r?n=Boolean(e.getExtension(r)):"boolean"==typeof r?n=r:assert$8(!1);return n}const ERR_MULTIPLE_RENDERTARGETS="Multiple render targets not supported";class Framebuffer extends Resource$1{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{colorBufferFloat:i,colorBufferHalfFloat:n}=t;let r=!0;return i&&(r=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),n&&(r=r&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),r}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new Framebuffer(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){const e=assertWebGL2Context(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){const e=assertWebGL2Context(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(e,t),this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(t),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(e){let{width:t=1,height:i=1,attachments:n=null,color:r=!0,depth:o=!0,stencil:s=!1,check:a=!0,readBuffer:l,drawBuffers:c}=e;if(assert$8(t>=0&&i>=0,"Width and height need to be integers"),this.width=t,this.height=i,n)for(const e in n){const r=n[e];(Array.isArray(r)?r[0]:r).resize({width:t,height:i})}else n=this._createDefaultAttachments(r,o,s,t,i);this.update({clearAttachments:!0,attachments:n,readBuffer:l,drawBuffers:c}),n&&a&&this.checkStatus()}delete(){for(const e of this.ownResources)e.delete();return super.delete(),this}update(e){let{attachments:t={},readBuffer:i,drawBuffers:n,clearAttachments:r=!1,resizeAttachments:o=!0}=e;this.attach(t,{clearAttachments:r,resizeAttachments:o});const{gl:s}=this,a=s.bindFramebuffer(36160,this.handle);return i&&this._setReadBuffer(i),n&&this._setDrawBuffers(n),s.bindFramebuffer(36160,a||null),this}resize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{width:t,height:i}=e;if(null===this.handle)return assert$8(void 0===t&&void 0===i),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;void 0===t&&(t=this.gl.drawingBufferWidth),void 0===i&&(i=this.gl.drawingBufferHeight),t!==this.width&&i!==this.height&&log$2.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(t,"x").concat(i))();for(const e in this.attachments)this.attachments[e].resize({width:t,height:i});return this.width=t,this.height=i,this}attach(e){let{clearAttachments:t=!1,resizeAttachments:i=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n={};t&&Object.keys(this.attachments).forEach((e=>{n[e]=null})),Object.assign(n,e);const r=this.gl.bindFramebuffer(36160,this.handle);for(const e in n){assert$8(void 0!==e,"Misspelled framebuffer binding point?");const t=Number(e),r=n[t];let o=r;if(o)if(o instanceof Renderbuffer)this._attachRenderbuffer({attachment:t,renderbuffer:o});else if(Array.isArray(r)){const[e,i=0,n=0]=r;o=e,this._attachTexture({attachment:t,texture:e,layer:i,level:n})}else this._attachTexture({attachment:t,texture:o,layer:0,level:0});else this._unattach(t);i&&o&&o.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,r||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter((e=>!this.attachments[e])).forEach((e=>{delete this.attachments[e]}))}checkStatus(){const e=this.getStatus();if(36053!==e)throw new Error(_getFrameBufferStatus(e));return this}getStatus(){const{gl:e}=this,t=e.bindFramebuffer(36160,this.handle),i=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,t||null),i}clear(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{color:t,depth:i,stencil:n,drawBuffers:r=[]}=e,o=this.gl.bindFramebuffer(36160,this.handle);return(t||i||n)&&clear(this.gl,{color:t,depth:i,stencil:n}),r.forEach(((e,t)=>{clearBuffer(this.gl,{drawBuffer:t,value:e})})),this.gl.bindFramebuffer(36160,o||null),this}readPixels(){return null}readPixelsToBuffer(){return null}copyToDataUrl(){return null}copyToImage(){return null}copyToTexture(){return null}blit(){return null}invalidate(e){let{attachments:t=[],x:i=0,y:n=0,width:r,height:o}=e;const s=assertWebGL2Context(this.gl),a=s.bindFramebuffer(36008,this.handle);return 0===i&&0===n&&void 0===r&&void 0===o?s.invalidateFramebuffer(36008,t):s.invalidateFramebuffer(36008,t,i,n,r,o),s.bindFramebuffer(36008,a),this}getAttachmentParameter(e,t,i){let n=this._getAttachmentParameterFallback(t);return null===n&&(this.gl.bindFramebuffer(36160,this.handle),n=this.gl.getFramebufferAttachmentParameter(36160,e,t),this.gl.bindFramebuffer(36160,null)),i&&n>1e3&&(n=getKey(this.gl,n)),n}getAttachmentParameters(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:36064,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[];const n={};for(const r of i){n[t?getKey(this.gl,r):r]=this.getAttachmentParameter(e,r,t)}return n}getParameters(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=Object.keys(this.attachments),i={};for(const n of t){const t=Number(n);i[e?getKey(this.gl,t):t]=this.getAttachmentParameters(t,e)}return i}show(){return"undefined"!=typeof window&&window.open(copyToDataUrl(this),"luma-debug-texture"),this}log(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(e>log$2.level||"undefined"==typeof window)return this;t=t||"Framebuffer ".concat(this.id);const i=copyToDataUrl(this,{targetMaxHeight:100});return log$2.image({logLevel:e,message:t,image:i},t)(),this}bind(){let{target:e=36160}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.gl.bindFramebuffer(e,this.handle),this}unbind(){let{target:e=36160}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,t,i,n,r){let o=null;return e&&(o=o||{},o[36064]=new Texture2D(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:n,height:r,mipmaps:!1,parameters:{10241:9729,10240:9729,10242:33071,10243:33071}}),this.ownResources.push(o[36064])),t&&i?(o=o||{},o[33306]=new Renderbuffer(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:n,height:111}),this.ownResources.push(o[33306])):t?(o=o||{},o[36096]=new Renderbuffer(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:n,height:r}),this.ownResources.push(o[36096])):i&&assert$8(!1),o}_unattach(e){const t=this.attachments[e];t&&(t instanceof Renderbuffer?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer(e){let{attachment:t=36064,renderbuffer:i}=e;const{gl:n}=this;n.framebufferRenderbuffer(36160,t,36161,i.handle),this.attachments[t]=i}_attachTexture(e){let{attachment:t=36064,texture:i,layer:n,level:r}=e;const{gl:o}=this;switch(o.bindTexture(i.target,i.handle),i.target){case 35866:case 32879:assertWebGL2Context(o).framebufferTextureLayer(36160,t,i.target,r,n);break;case 34067:const e=mapIndexToCubeMapFace(n);o.framebufferTexture2D(36160,t,e,i.handle,r);break;case 3553:o.framebufferTexture2D(36160,t,3553,i.handle,r);break;default:assert$8(!1,"Illegal texture type")}o.bindTexture(i.target,null),this.attachments[t]=i}_setReadBuffer(e){const t=getWebGL2Context(this.gl);t?t.readBuffer(e):assert$8(36064===e||1029===e,ERR_MULTIPLE_RENDERTARGETS),this.readBuffer=e}_setDrawBuffers(e){const{gl:t}=this,i=assertWebGL2Context(t);if(i)i.drawBuffers(e);else{const i=t.getExtension("WEBGL_draw_buffers");i?i.drawBuffersWEBGL(e):assert$8(1===e.length&&(36064===e[0]||1029===e[0]),ERR_MULTIPLE_RENDERTARGETS)}this.drawBuffers=e}_getAttachmentParameterFallback(e){const t=getFeatures(this.gl);switch(e){case 36052:return t.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return t.WEBGL2?null:8;case 33297:return t.WEBGL2?null:5125;case 33296:return t.WEBGL2||t.EXT_sRGB?null:9729;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}}function mapIndexToCubeMapFace(e){return e<34069?e+34069:e}function _getFrameBufferStatus(e){return(Framebuffer.STATUS||{})[e]||"Framebuffer error ".concat(e)}const FRAMEBUFFER_ATTACHMENT_PARAMETERS=[36049,36048,33296,33298,33299,33300,33301,33302,33303];function cloneTextureFrom(e,t){assert$8(e instanceof Texture2D||e instanceof TextureCube||e instanceof Texture3D);const i=e.constructor,{gl:n,width:r,height:o,format:s,type:a,dataFormat:l,border:c,mipmaps:u}=e;return new i(n,Object.assign({width:r,height:o,format:s,type:a,dataFormat:l,border:c,mipmaps:u},t))}function toFramebuffer(e,t){const{gl:i,width:n,height:r,id:o}=e;return new Framebuffer(i,Object.assign({},t,{id:"framebuffer-for-".concat(o),width:n,height:r,attachments:{36064:e}}))}function getShaderName$1(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"unnamed";const i=e.match(/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/);return i?i[1]:t}Framebuffer.ATTACHMENT_PARAMETERS=FRAMEBUFFER_ATTACHMENT_PARAMETERS;const GL_FRAGMENT_SHADER=35632,GL_VERTEX_SHADER=35633;function getShaderTypeName(e){switch(e){case GL_FRAGMENT_SHADER:return"fragment";case GL_VERTEX_SHADER:return"vertex";default:return"unknown type"}}function parseGLSLCompilerError(e,t,i,n){const r=e.split(/\r?\n/),o={},s={},a=n||getShaderName$1(t)||"(unnamed)",l="".concat(getShaderTypeName(i)," shader ").concat(a);for(let t=0;t<r.length;t++){const i=r[t];if(i.length<=1)continue;const n=i.split(":"),a=n[0],c=parseInt(n[2],10);if(isNaN(c))throw new Error("GLSL compilation error in ".concat(l,": ").concat(e));"WARNING"!==a?o[c]=i:s[c]=i}const c=addLineNumbers(t);return{shaderName:l,errors:formatErrors(o,c),warnings:formatErrors(s,c)}}function formatErrors(e,t){let i="";for(let n=0;n<t.length;n++){if((e[n+3]||e[n+2]||e[n+1])&&(i+="".concat(t[n],"\n"),e[n+1])){const t=e[n+1],r=t.split(":",3),o=r[0],s=parseInt(r[1],10)||0,a=t.substring(r.join(":").length+1).trim();i+=padLeft("^^^ ".concat(o,": ").concat(a,"\n\n"),s)}}return i}function addLineNumbers(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:": ";const n=e.split(/\r?\n/),r=String(n.length+t-1).length;return n.map(((e,n)=>{const o=String(n+t);return padLeft(o,r-o.length)+i+e}))}function padLeft(e,t){let i="";for(let e=0;e<t;++e)i+=" ";return"".concat(i).concat(e)}function getShaderVersion(e){let t=100;const i=e.match(/[^\s]+/g);if(i.length>=2&&"#version"===i[0]){const e=parseInt(i[1],10);Number.isFinite(e)&&(t=e)}return t}const ERR_SOURCE="Shader: GLSL source code must be a JavaScript string";class Shader extends Resource$1{get[Symbol.toStringTag](){return"Shader"}static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return assert$8(!1),"unknown"}}constructor(e,t){assertWebGLContext(e),assert$8("string"==typeof t.source,ERR_SOURCE);super(e,{id:getShaderName$1(t.source,null)||t.id||uid("unnamed ".concat(Shader.getTypeName(t.shaderType)))}),this.shaderType=t.shaderType,this.source=t.source,this.initialize(t)}initialize(e){let{source:t}=e;const i=getShaderName$1(t,null);i&&(this.id=uid(i)),this._compile(t)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return"".concat(Shader.getTypeName(this.shaderType),":").concat(this.id)}getName(){return getShaderName$1(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){const e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.source;e.startsWith("#version ")||(e="#version 100\n".concat(e)),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle);if(!this.getParameter(35713)){const e=this.gl.getShaderInfoLog(this.handle),{shaderName:t,warnings:i}=parseGLSLCompilerError(e,this.source,this.shaderType,this.id);throw log$2.warn("GLSL compilation warnings in ".concat(t,"\n").concat(i))(),new Error("GLSL compilation errors in ".concat(t))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}}class VertexShader extends Shader{get[Symbol.toStringTag](){return"VertexShader"}constructor(e,t){"string"==typeof t&&(t={source:t}),super(e,Object.assign({},t,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}}class FragmentShader extends Shader{get[Symbol.toStringTag](){return"FragmentShader"}constructor(e,t){"string"==typeof t&&(t={source:t}),super(e,Object.assign({},t,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}}const UNIFORM_SETTERS={5126:getArraySetter.bind(null,"uniform1fv",toFloatArray,1,setVectorUniform),35664:getArraySetter.bind(null,"uniform2fv",toFloatArray,2,setVectorUniform),35665:getArraySetter.bind(null,"uniform3fv",toFloatArray,3,setVectorUniform),35666:getArraySetter.bind(null,"uniform4fv",toFloatArray,4,setVectorUniform),5124:getArraySetter.bind(null,"uniform1iv",toIntArray,1,setVectorUniform),35667:getArraySetter.bind(null,"uniform2iv",toIntArray,2,setVectorUniform),35668:getArraySetter.bind(null,"uniform3iv",toIntArray,3,setVectorUniform),35669:getArraySetter.bind(null,"uniform4iv",toIntArray,4,setVectorUniform),35670:getArraySetter.bind(null,"uniform1iv",toIntArray,1,setVectorUniform),35671:getArraySetter.bind(null,"uniform2iv",toIntArray,2,setVectorUniform),35672:getArraySetter.bind(null,"uniform3iv",toIntArray,3,setVectorUniform),35673:getArraySetter.bind(null,"uniform4iv",toIntArray,4,setVectorUniform),35674:getArraySetter.bind(null,"uniformMatrix2fv",toFloatArray,4,setMatrixUniform),35675:getArraySetter.bind(null,"uniformMatrix3fv",toFloatArray,9,setMatrixUniform),35676:getArraySetter.bind(null,"uniformMatrix4fv",toFloatArray,16,setMatrixUniform),35678:getSamplerSetter,35680:getSamplerSetter,5125:getArraySetter.bind(null,"uniform1uiv",toUIntArray,1,setVectorUniform),36294:getArraySetter.bind(null,"uniform2uiv",toUIntArray,2,setVectorUniform),36295:getArraySetter.bind(null,"uniform3uiv",toUIntArray,3,setVectorUniform),36296:getArraySetter.bind(null,"uniform4uiv",toUIntArray,4,setVectorUniform),35685:getArraySetter.bind(null,"uniformMatrix2x3fv",toFloatArray,6,setMatrixUniform),35686:getArraySetter.bind(null,"uniformMatrix2x4fv",toFloatArray,8,setMatrixUniform),35687:getArraySetter.bind(null,"uniformMatrix3x2fv",toFloatArray,6,setMatrixUniform),35688:getArraySetter.bind(null,"uniformMatrix3x4fv",toFloatArray,12,setMatrixUniform),35689:getArraySetter.bind(null,"uniformMatrix4x2fv",toFloatArray,8,setMatrixUniform),35690:getArraySetter.bind(null,"uniformMatrix4x3fv",toFloatArray,12,setMatrixUniform),35678:getSamplerSetter,35680:getSamplerSetter,35679:getSamplerSetter,35682:getSamplerSetter,36289:getSamplerSetter,36292:getSamplerSetter,36293:getSamplerSetter,36298:getSamplerSetter,36299:getSamplerSetter,36300:getSamplerSetter,36303:getSamplerSetter,36306:getSamplerSetter,36307:getSamplerSetter,36308:getSamplerSetter,36311:getSamplerSetter},FLOAT_ARRAY={},INT_ARRAY={},UINT_ARRAY={},array1=[0];function toTypedArray$1(e,t,i,n){1===t&&"boolean"==typeof e&&(e=e?1:0),Number.isFinite(e)&&(array1[0]=e,e=array1);const r=e.length;if(r%t&&log$2.warn("Uniform size should be multiples of ".concat(t),e)(),e instanceof i)return e;let o=n[r];o||(o=new i(r),n[r]=o);for(let t=0;t<r;t++)o[t]=e[t];return o}function toFloatArray(e,t){return toTypedArray$1(e,t,Float32Array,FLOAT_ARRAY)}function toIntArray(e,t){return toTypedArray$1(e,t,Int32Array,INT_ARRAY)}function toUIntArray(e,t){return toTypedArray$1(e,t,Uint32Array,UINT_ARRAY)}function getUniformSetter(e,t,i){const n=UNIFORM_SETTERS[i.type];if(!n)throw new Error("Unknown GLSL uniform type ".concat(i.type));return n().bind(null,e,t)}function parseUniformName(e){if("]"!==e[e.length-1])return{name:e,length:1,isArray:!1};const t=e.match(/([^[]*)(\[[0-9]+\])?/);if(!t||t.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(e));return{name:t[1],length:t[2]||1,isArray:Boolean(t[2])}}function checkUniformValues(e,t,i){for(const n in e){const r=e[n];if((!i||Boolean(i[n]))&&!checkUniformValue(r))throw t=t?"".concat(t," "):"",new Error("".concat(t," Bad uniform ").concat(n))}return!0}function checkUniformValue(e){return Array.isArray(e)||ArrayBuffer.isView(e)?checkUniformArray(e):!!isFinite(e)||(!0===e||!1===e||(e instanceof Texture$1||(e instanceof Renderbuffer||e instanceof Framebuffer&&Boolean(e.texture))))}function copyUniform(e,t,i){if(Array.isArray(i)||ArrayBuffer.isView(i))if(e[t]){const n=e[t];for(let e=0,t=i.length;e<t;++e)n[e]=i[e]}else e[t]=i.slice();else e[t]=i}function checkUniformArray(e){if(0===e.length)return!1;const t=Math.min(e.length,16);for(let i=0;i<t;++i)if(!Number.isFinite(e[i]))return!1;return!0}function getSamplerSetter(){let e=null;return(t,i,n)=>{const r=e!==n;return r&&(t.uniform1i(i,n),e=n),r}}function getArraySetter(e,t,i,n){let r=null,o=null;return(s,a,l)=>{const c=t(l,i),u=c.length;let h=!1;if(null===r)r=new Float32Array(u),o=u,h=!0;else{assert$8(o===u,"Uniform length cannot change.");for(let e=0;e<u;++e)if(c[e]!==r[e]){h=!0;break}}return h&&(n(s,e,a,c),r.set(c)),h}}function setVectorUniform(e,t,i,n){e[t](i,n)}function setMatrixUniform(e,t,i,n){e[t](i,!1,n)}const GL_BYTE=5120,GL_UNSIGNED_BYTE=5121,GL_SHORT=5122,GL_UNSIGNED_SHORT=5123,GL_POINTS=0,GL_LINES=1,GL_LINE_LOOP=2,GL_LINE_STRIP=3,GL_TRIANGLES=4,GL_TRIANGLE_STRIP=5,GL_TRIANGLE_FAN=6,GL_FLOAT=5126,GL_FLOAT_VEC2=35664,GL_FLOAT_VEC3=35665,GL_FLOAT_VEC4=35666,GL_INT=5124,GL_INT_VEC2=35667,GL_INT_VEC3=35668,GL_INT_VEC4=35669,GL_UNSIGNED_INT=5125,GL_UNSIGNED_INT_VEC2=36294,GL_UNSIGNED_INT_VEC3=36295,GL_UNSIGNED_INT_VEC4=36296,GL_BOOL=35670,GL_BOOL_VEC2=35671,GL_BOOL_VEC3=35672,GL_BOOL_VEC4=35673,GL_FLOAT_MAT2=35674,GL_FLOAT_MAT3=35675,GL_FLOAT_MAT4=35676,GL_FLOAT_MAT2x3=35685,GL_FLOAT_MAT2x4=35686,GL_FLOAT_MAT3x2=35687,GL_FLOAT_MAT3x4=35688,GL_FLOAT_MAT4x2=35689,GL_FLOAT_MAT4x3=35690,COMPOSITE_GL_TYPES={[GL_FLOAT]:[GL_FLOAT,1,"float"],[GL_FLOAT_VEC2]:[GL_FLOAT,2,"vec2"],[GL_FLOAT_VEC3]:[GL_FLOAT,3,"vec3"],[GL_FLOAT_VEC4]:[GL_FLOAT,4,"vec4"],[GL_INT]:[GL_INT,1,"int"],[GL_INT_VEC2]:[GL_INT,2,"ivec2"],[GL_INT_VEC3]:[GL_INT,3,"ivec3"],[GL_INT_VEC4]:[GL_INT,4,"ivec4"],[GL_UNSIGNED_INT]:[GL_UNSIGNED_INT,1,"uint"],[GL_UNSIGNED_INT_VEC2]:[GL_UNSIGNED_INT,2,"uvec2"],[GL_UNSIGNED_INT_VEC3]:[GL_UNSIGNED_INT,3,"uvec3"],[GL_UNSIGNED_INT_VEC4]:[GL_UNSIGNED_INT,4,"uvec4"],[GL_BOOL]:[GL_FLOAT,1,"bool"],[GL_BOOL_VEC2]:[GL_FLOAT,2,"bvec2"],[GL_BOOL_VEC3]:[GL_FLOAT,3,"bvec3"],[GL_BOOL_VEC4]:[GL_FLOAT,4,"bvec4"],[GL_FLOAT_MAT2]:[GL_FLOAT,8,"mat2"],[GL_FLOAT_MAT2x3]:[GL_FLOAT,8,"mat2x3"],[GL_FLOAT_MAT2x4]:[GL_FLOAT,8,"mat2x4"],[GL_FLOAT_MAT3]:[GL_FLOAT,12,"mat3"],[GL_FLOAT_MAT3x2]:[GL_FLOAT,12,"mat3x2"],[GL_FLOAT_MAT3x4]:[GL_FLOAT,12,"mat3x4"],[GL_FLOAT_MAT4]:[GL_FLOAT,16,"mat4"],[GL_FLOAT_MAT4x2]:[GL_FLOAT,16,"mat4x2"],[GL_FLOAT_MAT4x3]:[GL_FLOAT,16,"mat4x3"]};function getPrimitiveDrawMode(e){switch(e){case GL_POINTS:return GL_POINTS;case GL_LINES:case GL_LINE_STRIP:case GL_LINE_LOOP:return GL_LINES;case GL_TRIANGLES:case GL_TRIANGLE_STRIP:case GL_TRIANGLE_FAN:return GL_TRIANGLES;default:return assert$8(!1),0}}function decomposeCompositeGLType(e){const t=COMPOSITE_GL_TYPES[e];if(!t)return null;const[i,n]=t;return{type:i,components:n}}function getCompositeGLType(e,t){switch(e){case GL_BYTE:case GL_UNSIGNED_BYTE:case GL_SHORT:case GL_UNSIGNED_SHORT:e=GL_FLOAT}for(const i in COMPOSITE_GL_TYPES){const[n,r,o]=COMPOSITE_GL_TYPES[i];if(n===e&&r===t)return{glType:i,name:o}}return null}class ProgramConfiguration{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){const t=Number(e);return Number.isFinite(t)?this.attributeInfosByLocation[t]:this.attributeInfosByName[e]||null}getAttributeLocation(e){const t=this.getAttributeInfo(e);return t?t.location:-1}getAttributeAccessor(e){const t=this.getAttributeInfo(e);return t?t.accessor:null}getVaryingInfo(e){const t=Number(e);return Number.isFinite(t)?this.varyingInfos[t]:this.varyingInfosByName[e]||null}getVaryingIndex(e){const t=this.getVaryingInfo();return t?t.location:-1}getVaryingAccessor(e){const t=this.getVaryingInfo();return t?t.accessor:null}_readAttributesFromProgram(e){const{gl:t}=e,i=t.getProgramParameter(e.handle,35721);for(let n=0;n<i;n++){const{name:i,type:r,size:o}=t.getActiveAttrib(e.handle,n),s=t.getAttribLocation(e.handle,i);s>=0&&this._addAttribute(s,i,r,o)}this.attributeInfos.sort(((e,t)=>e.location-t.location))}_readVaryingsFromProgram(e){const{gl:t}=e;if(!isWebGL2$1(t))return;const i=t.getProgramParameter(e.handle,35971);for(let n=0;n<i;n++){const{name:i,type:r,size:o}=t.getTransformFeedbackVarying(e.handle,n);this._addVarying(n,i,r,o)}this.varyingInfos.sort(((e,t)=>e.location-t.location))}_addAttribute(e,t,i,n){const{type:r,components:o}=decomposeCompositeGLType(i),s={type:r,size:n*o};this._inferProperties(e,t,s);const a={location:e,name:t,accessor:new Accessor(s)};this.attributeInfos.push(a),this.attributeInfosByLocation[e]=a,this.attributeInfosByName[a.name]=a}_inferProperties(e,t,i){/instance/i.test(t)&&(i.divisor=1)}_addVarying(e,t,i,n){const{type:r,components:o}=decomposeCompositeGLType(i),s={location:e,name:t,accessor:new Accessor({type:r,size:n*o})};this.varyingInfos.push(s),this.varyingInfosByName[s.name]=s}}const LOG_PROGRAM_PERF_PRIORITY=4,GL_SEPARATE_ATTRIBS=35981,V6_DEPRECATED_METHODS=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"];class Program extends Resource$1{get[Symbol.toStringTag](){return"Program"}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(e,t),this.stubRemovedMethods("Program","v6.0",V6_DEPRECATED_METHODS),this._isCached=!1,this.initialize(t),Object.seal(this),this._setId(t.id)}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{hash:t,vs:i,fs:n,varyings:r,bufferMode:o=GL_SEPARATE_ATTRIBS}=e;return this.hash=t||"",this.vs="string"==typeof i?new VertexShader(this.gl,{id:"".concat(e.id,"-vs"),source:i}):i,this.fs="string"==typeof n?new FragmentShader(this.gl,{id:"".concat(e.id,"-fs"),source:n}):n,assert$8(this.vs instanceof VertexShader),assert$8(this.fs instanceof FragmentShader),this.uniforms={},this._textureUniforms={},r&&r.length>0&&(assertWebGL2Context(this.gl),this.varyings=r,this.gl2.transformFeedbackVaryings(this.handle,r,o)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new ProgramConfiguration(this),this.setProps(e)}delete(){return this._isCached?this:super.delete(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw(e){let{logPriority:t,drawMode:i=4,vertexCount:n,offset:r=0,start:o,end:s,isIndexed:a=!1,indexType:l=5123,instanceCount:c=0,isInstanced:u=c>0,vertexArray:h=null,transformFeedback:d,framebuffer:p,parameters:f={},uniforms:m,samplers:g}=e;if((m||g)&&(log$2.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(m||{})),log$2.priority>=t){const e=p?p.id:"default",r="mode=".concat(getKey(this.gl,i)," verts=").concat(n," ")+"instances=".concat(c," indexType=").concat(getKey(this.gl,l)," ")+"isInstanced=".concat(u," isIndexed=").concat(a," ")+"Framebuffer=".concat(e);log$2.log(t,r)()}return assert$8(h),this.gl.useProgram(this.handle),!(!this._areTexturesRenderable()||0===n||u&&0===c)&&(h.bindForDraw(n,c,(()=>{if(void 0!==p&&(f=Object.assign({},f,{framebuffer:p})),d){const e=getPrimitiveDrawMode(i);d.begin(e)}this._bindTextures(),withParameters(this.gl,f,(()=>{a&&u?this.gl2.drawElementsInstanced(i,n,l,r,c):a&&isWebGL2$1(this.gl)&&!isNaN(o)&&!isNaN(s)?this.gl2.drawRangeElements(i,o,s,n,l,r):a?this.gl.drawElements(i,n,l,r):u?this.gl2.drawArraysInstanced(i,r,n,c):this.gl.drawArrays(i,r,n)})),d&&d.end()})),!0)}setUniforms(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};log$2.priority>=2&&checkUniformValues(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(const t in e){const i=e[t],n=this._uniformSetters[t];if(n){let e=i,r=!1;if(e instanceof Framebuffer&&(e=e.texture),e instanceof Texture$1)if(r=this.uniforms[t]!==i,r){void 0===n.textureIndex&&(n.textureIndex=this._textureIndexCounter++);const i=e,{textureIndex:r}=n;i.bind(r),e=r,this._textureUniforms[t]=i}else e=n.textureIndex;else this._textureUniforms[t]&&delete this._textureUniforms[t];(n(e)||r)&&copyUniform(this.uniforms,t,i)}}return this}_areTexturesRenderable(){let e=!0;for(const t in this._textureUniforms){const i=this._textureUniforms[t];i.update(),e=e&&i.loaded}return e}_bindTextures(){for(const e in this._textureUniforms){this._textureUniforms[e].bind(this._uniformSetters[e].textureIndex)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){const t=this.gl.getAttachedShaders(e),i={};for(const e of t){switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:i.vs=new VertexShader({handle:e});break;case 35632:i.fs=new FragmentShader({handle:e})}}return i}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){const e=this._getName();this.id=uid(e)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?"".concat(e,"-program"):"program",e}_compileAndLink(){const{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),log$2.time(LOG_PROGRAM_PERF_PRIORITY,"linkProgram for ".concat(this._getName()))(),e.linkProgram(this.handle),log$2.timeEnd(LOG_PROGRAM_PERF_PRIORITY,"linkProgram for ".concat(this._getName()))(),e.debug||log$2.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(e.getProgramInfoLog(this.handle)));e.validateProgram(this.handle);if(!e.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(e.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){const{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let t=0;t<this._uniformCount;t++){const i=this.gl.getActiveUniform(this.handle,t),{name:n}=parseUniformName(i.name);let r=e.getUniformLocation(this.handle,n);if(this._uniformSetters[n]=getUniformSetter(e,r,i),i.size>1)for(let t=0;t<i.size;t++)r=e.getUniformLocation(this.handle,"".concat(n,"[").concat(t,"]")),this._uniformSetters["".concat(n,"[").concat(t,"]")]=getUniformSetter(e,r,i)}this._textureIndexCounter=0}getActiveUniforms(e,t){return this.gl2.getActiveUniforms(this.handle,e,t)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,t){return this.gl2.getActiveUniformBlockParameter(this.handle,e,t)}uniformBlockBinding(e,t){this.gl2.uniformBlockBinding(this.handle,e,t)}}const GL_QUERY_RESULT=34918,GL_QUERY_RESULT_AVAILABLE=34919,GL_TIME_ELAPSED_EXT=35007,GL_GPU_DISJOINT_EXT=36795,GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976,GL_ANY_SAMPLES_PASSED=35887,GL_ANY_SAMPLES_PASSED_CONSERVATIVE=36202;class Query extends Resource$1{get[Symbol.toStringTag](){return"Query"}static isSupported(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const i=isWebGL2$1(e),n=hasFeatures$1(e,FEATURES$1.TIMER_QUERY);let r=i||n;for(const e of t)switch(e){case"queries":r=r&&i;break;case"timers":r=r&&n;break;default:assert$8(!1)}return r}constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}),this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(GL_TIME_ELAPSED_EXT)}beginOcclusionQuery(){let{conservative:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.begin(e?GL_ANY_SAMPLES_PASSED_CONSERVATIVE:GL_ANY_SAMPLES_PASSED)}beginTransformFeedbackQuery(){return this.begin(GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN)}begin(e){return this._queryPending||(this.target=e,this.gl2.beginQuery(this.target,this.handle)),this}end(){return this._queryPending||this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this}isResultAvailable(){if(!this._queryPending)return!1;const e=this.gl2.getQueryParameter(this.handle,GL_QUERY_RESULT_AVAILABLE);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.gl2.getParameter(GL_GPU_DISJOINT_EXT)}getResult(){return this.gl2.getQueryParameter(this.handle,GL_QUERY_RESULT)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Number.POSITIVE_INFINITY;if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise(((i,n)=>{const r=()=>{this.isResultAvailable()?(i(this.getResult()),this._pollingPromise=null):t++>e?(n("Timed out"),this._pollingPromise=null):requestAnimationFrame(r)};requestAnimationFrame(r)})),this._pollingPromise}_createHandle(){return Query.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}}class TransformFeedback extends Resource$1{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(e){return isWebGL2$1(e)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};assertWebGL2Context(e),super(e,t),this.initialize(t),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,isObjectEmpty(this.buffers)||this.bind((()=>this._unbindBuffers())),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.bind((()=>{for(const t in e)this.setBuffer(t,e[t])})),this}setBuffer(e,t){const i=this._getVaryingIndex(e),{buffer:n,byteSize:r,byteOffset:o}=this._getBufferParams(t);return i<0?(this.unused[e]=n,log$2.warn("".concat(this.id," unused varying buffer ").concat(e))(),this):(this.buffers[i]=t,this.bindOnUse||this._bindBuffer(i,n,o,r),this)}begin(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let t,i,n;return e instanceof Buffer==!1?(n=e.buffer,i=e.byteSize,t=e.byteOffset):n=e,void 0===t&&void 0===i||(t=t||0,i=i||n.byteLength-t),{buffer:n,byteOffset:t,byteSize:i}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;const t=Number(e);return Number.isFinite(t)?t:-1}_bindBuffers(){if(this.bindOnUse)for(const e in this.buffers){const{buffer:t,byteSize:i,byteOffset:n}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,t,n,i)}}_unbindBuffers(){if(this.bindOnUse)for(const e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,t){let i=arguments.length>3?arguments[3]:void 0;const n=t&&t.handle;return n&&void 0!==i?this.gl.bindBufferRange(35982,e,n,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i):this.gl.bindBufferBase(35982,e,n),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}}let arrayBuffer=null;function getScratchArrayBuffer(e){return(!arrayBuffer||arrayBuffer.byteLength<e)&&(arrayBuffer=new ArrayBuffer(e)),arrayBuffer}function getScratchArray(e,t){return new e(getScratchArrayBuffer(e.BYTES_PER_ELEMENT*t),0,t)}function fillArray$1(e){let{target:t,source:i,start:n=0,count:r=1}=e;const o=i.length,s=r*o;let a=0;for(let e=n;a<o;a++)t[e++]=i[a];for(;a<s;)a<s-a?(t.copyWithin(n+a,n,n+a),a*=2):(t.copyWithin(n+a,n,n+s-a),a=s);return t}const ERR_ELEMENTS="elements must be GL.ELEMENT_ARRAY_BUFFER";class VertexArrayObject extends Resource$1{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(e){return!(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).constantAttributeZero||(isWebGL2$1(e)||"Chrome"===getBrowser$1())}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new VertexArrayObject(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return VertexArrayObject.MAX_ATTRIBUTES=VertexArrayObject.MAX_ATTRIBUTES||e.getParameter(34921),VertexArrayObject.MAX_ATTRIBUTES}static setConstant(e,t,i){switch(i.constructor){case Float32Array:VertexArrayObject._setConstantFloatArray(e,t,i);break;case Int32Array:VertexArrayObject._setConstantIntArray(e,t,i);break;case Uint32Array:VertexArrayObject._setConstantUintArray(e,t,i);break;default:assert$8(!1)}}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(e,Object.assign({},t,{id:t.id||t.program&&t.program.id})),this.buffer=null,this.bufferValue=null,this.isDefaultArray=t.isDefaultArray||!1,this.gl2=e,this.initialize(t),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return VertexArrayObject.getMaxAttributes(this.gl)}initialize(){return this.setProps(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}setProps(e){return this}setElementBuffer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return assert$8(!e||34963===e.target,ERR_ELEMENTS),this.bind((()=>{this.gl.bindBuffer(34963,e?e.handle:null)})),this}setBuffer(e,t,i){if(34963===t.target)return this.setElementBuffer(t,i);const{size:n,type:r,stride:o,offset:s,normalized:a,integer:l,divisor:c}=i,{gl:u,gl2:h}=this;return e=Number(e),this.bind((()=>{u.bindBuffer(34962,t.handle),l?(assert$8(isWebGL2$1(u)),h.vertexAttribIPointer(e,n,r,o,s)):u.vertexAttribPointer(e,n,r,a,o,s),u.enableVertexAttribArray(e),h.vertexAttribDivisor(e,c||0)})),this}enable(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return!t&&0===e&&!VertexArrayObject.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind((()=>t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e)))),this}getConstantBuffer(e,t){const i=this._normalizeConstantArrayValue(t),n=i.byteLength*e,r=i.length*e;let o=!this.buffer;if(this.buffer=this.buffer||new Buffer(this.gl,n),o=o||this.buffer.reallocate(n),o=o||!this._compareConstantArrayValues(i,this.bufferValue),o){const e=getScratchArray(t.constructor,r);fillArray$1({target:e,source:i,start:0,count:r}),this.buffer.subData(e),this.bufferValue=t}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}static _setConstantFloatArray(e,t,i){switch(i.length){case 1:e.vertexAttrib1fv(t,i);break;case 2:e.vertexAttrib2fv(t,i);break;case 3:e.vertexAttrib3fv(t,i);break;case 4:e.vertexAttrib4fv(t,i);break;default:assert$8(!1)}}static _setConstantIntArray(e,t,i){switch(assert$8(isWebGL2$1(e)),i.length){case 1:e.vertexAttribI1iv(t,i);break;case 2:e.vertexAttribI2iv(t,i);break;case 3:e.vertexAttribI3iv(t,i);break;case 4:e.vertexAttribI4iv(t,i);break;default:assert$8(!1)}}static _setConstantUintArray(e,t,i){switch(assert$8(isWebGL2$1(e)),i.length){case 1:e.vertexAttribI1uiv(t,i);break;case 2:e.vertexAttribI2uiv(t,i);break;case 3:e.vertexAttribI3uiv(t,i);break;case 4:e.vertexAttribI4uiv(t,i);break;default:assert$8(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,t){let{location:i}=t;return assert$8(Number.isFinite(i)),this.bind((()=>34373===e?this.gl.getVertexAttribOffset(i,e):this.gl.getVertexAttrib(i,e)))}}const ERR_ATTRIBUTE_TYPE="VertexArray: attributes must be Buffers or constants (i.e. typed array)",MULTI_LOCATION_ATTRIBUTE_REGEXP=/^(.+)__LOCATION_([0-9]+)$/,DEPRECATIONS_V6=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"];class VertexArray{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.id=t.id||t.program&&t.program.id,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new VertexArrayObject(e),stubRemovedMethods(this,"VertexArray","v6.0",DEPRECATIONS_V6),this.initialize(t),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;const{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind((()=>{for(const t in e){this._setAttribute(t,e[t])}this.gl.bindBuffer(34962,null)})),this}setElementBuffer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.elements=e,this.elementsAccessor=t,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,t),this}setBuffer(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(34963===t.target)return this.setElementBuffer(t,i);const{location:n,accessor:r}=this._resolveLocationAndAccessor(e,t,t.accessor,i);return n>=0&&(this.values[n]=t,this.accessors[n]=r,this.clearDrawParams(),this.vertexArrayObject.setBuffer(n,t,r)),this}setConstant(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{location:n,accessor:r}=this._resolveLocationAndAccessor(e,t,Object.assign({size:t.length},i));return n>=0&&(t=this.vertexArrayObject._normalizeConstantArrayValue(t),this.values[n]=t,this.accessors[n]=r,this.clearDrawParams(),this.vertexArrayObject.enable(n,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind((()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new Buffer(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof Buffer&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))})),this}bindBuffers(){return this.vertexArrayObject.bind((()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){const t=this.values[e];t instanceof Buffer&&this.setBuffer(e,t)}})),this}bindForDraw(e,t,i){let n;return this.vertexArrayObject.bind((()=>{this._setConstantAttributes(e,t),n=i()})),n}_resolveLocationAndAccessor(e,t,i,n){const r={location:-1,accessor:null},{location:o,name:s}=this._getAttributeIndex(e);if(!Number.isFinite(o)||o<0)return this.unused[e]=t,log$2.once(3,(()=>"unused value ".concat(e," in ").concat(this.id)))(),r;const a=this._getAttributeInfo(s||o);if(!a)return r;const l=Accessor.resolve(a.accessor,this.accessors[o]||{},i,n),{size:c,type:u}=l;return assert$8(Number.isFinite(c)&&Number.isFinite(u)),{location:o,accessor:l}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){const t=Number(e);if(Number.isFinite(t))return{location:t};const i=MULTI_LOCATION_ATTRIBUTE_REGEXP.exec(e),n=i?i[1]:e,r=i?Number(i[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(n)+r,name:n}:{location:-1}}_setAttribute(e,t){if(t instanceof Buffer)this.setBuffer(e,t);else if(Array.isArray(t)&&t.length&&t[0]instanceof Buffer){this.setBuffer(e,t[0],t[1])}else if(ArrayBuffer.isView(t)||Array.isArray(t)){this.setConstant(e,t)}else{if(!(t.buffer instanceof Buffer))throw new Error(ERR_ATTRIBUTE_TYPE);this.setBuffer(e,t.buffer,t)}}_setConstantAttributes(e,t){const i=Math.max(0|e,0|t);let n=this.values[0];ArrayBuffer.isView(n)&&this._setConstantAttributeZero(n,i);for(let e=1;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)n=this.values[e],ArrayBuffer.isView(n)&&this._setConstantAttribute(e,n)}_setConstantAttributeZero(e,t){if(VertexArrayObject.isSupported(this.gl,{constantAttributeZero:!0}))return void this._setConstantAttribute(0,e);const i=this.vertexArrayObject.getConstantBuffer(t,e);this.vertexArrayObject.setBuffer(0,i,this.accessors[0])}_setConstantAttribute(e,t){VertexArrayObject.setConstant(this.gl,e,t)}_updateDrawParams(){const e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this._updateDrawParamsForLocation(e,t);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,t){const i=this.values[t],n=this.accessors[t];if(!i)return;const{divisor:r}=n,o=r>0;if(e.isInstanced=e.isInstanced||o,i instanceof Buffer){const t=i;if(o){const i=t.getVertexCount(n);e.instanceCount=Math.min(e.instanceCount,i)}else{const i=t.getVertexCount(n);e.vertexCount=Math.min(e.vertexCount,i)}}}setElements(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return log$2.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,t)}}function formatArrayValue(e,t){const{maxElts:i=16,size:n=1}=t;let r="[";for(let o=0;o<e.length&&o<i;++o)o>0&&(r+=",".concat(o%n==0?" ":"")),r+=formatValue$1(e[o],t);const o=e.length>i?"...":"]";return"".concat(r).concat(o)}function formatValue$1(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{isInteger:i=!1}=t;if(Array.isArray(e)||ArrayBuffer.isView(e))return formatArrayValue(e,t);if(!Number.isFinite(e))return String(e);if(Math.abs(e)<1e-16)return i?"0":"0.";if(i)return e.toFixed(0);if(Math.abs(e)>100&&Math.abs(e)<1e4)return e.toFixed(0);const n=e.toPrecision(2);return n.indexOf(".0")===n.length-2?n.slice(0,-1):n}function getDebugTableForUniforms(e){let{header:t="Uniforms",program:i,uniforms:n,undefinedOnly:r=!1}=e;assert$8(i);const o=".*Matrix",s={},a=Object.keys(i._uniformSetters).sort();let l=0;for(const e of a)e.match(".*_.*")||e.match(o)||addUniformToTable({table:s,header:t,uniforms:n,uniformName:e,undefinedOnly:r})&&l++;for(const e of a)e.match(o)&&addUniformToTable({table:s,header:t,uniforms:n,uniformName:e,undefinedOnly:r})&&l++;for(const e of a)s[e]||addUniformToTable({table:s,header:t,uniforms:n,uniformName:e,undefinedOnly:r})&&l++;let c=0;const u={};if(!r)for(const e in n){const i=n[e];s[e]||(c++,u[e]={Type:"NOT USED: ".concat(i),[t]:formatValue$1(i)})}return{table:s,count:l,unusedTable:u,unusedCount:c}}function addUniformToTable(e){let{table:t,header:i,uniforms:n,uniformName:r,undefinedOnly:o}=e;const s=n[r],a=isUniformDefined(s);return(!o||!a)&&(t[r]={[i]:a?formatValue$1(s):"N/A","Uniform Type":a?s:"NOT PROVIDED"},!0)}function isUniformDefined(e){return null!=e}function getDebugTableForVertexArray(e){let{vertexArray:t,header:i="Attributes"}=e;if(!t.configuration)return{};const n={};t.elements&&(n.ELEMENT_ARRAY_BUFFER=getDebugTableRow(t,t.elements,null,i));const r=t.values;for(const e in r){const o=t._getAttributeInfo(e);if(o){let s="".concat(e,": ").concat(o.name);const a=t.accessors[o.location];a&&(s="".concat(e,": ").concat(getGLSLDeclaration$1(o.name,a))),n[s]=getDebugTableRow(t,r[e],a,i)}}return n}function getDebugTableRow(e,t,i,n){const{gl:r}=e;if(!t)return{[n]:"null","Format ":"N/A"};let o,s,a,l="NOT PROVIDED",c=1,u=0,h=0;if(i&&(l=i.type,c=i.size,l=String(l).replace("Array",""),o=-1!==l.indexOf("nt")),t instanceof Buffer){const e=t,{data:d,changed:p}=e.getDebugData();let f;if(s=p?"*":"",a=d,h=e.byteLength,u=h/d.BYTES_PER_ELEMENT/c,i){f="".concat(i.divisor>0?"I ":"P "," ").concat(u," (x").concat(c,"=").concat(h," bytes ").concat(getKey(r,l),")")}else o=!0,f="".concat(h," bytes");return{[n]:"".concat(s).concat(formatValue$1(a,{size:c,isInteger:o})),"Format ":f}}return a=t,c=t.length,l=String(t.constructor.name).replace("Array",""),o=-1!==l.indexOf("nt"),{[n]:"".concat(formatValue$1(a,{size:c,isInteger:o})," (constant)"),"Format ":"".concat(c,"x").concat(l," (constant)")}}function getGLSLDeclaration$1(e,t){const{type:i,size:n}=t,r=getCompositeGLType(i,n);return r?"".concat(e," (").concat(r.name,")"):e}function getDebugTableForProgramConfiguration(e){const t={},i="Accessors for ".concat(e.id);for(const n of e.attributeInfos)if(n){const e=getGLSLDeclaration(n);t["in ".concat(e)]={[i]:JSON.stringify(n.accessor)}}for(const n of e.varyingInfos)if(n){const e=getGLSLDeclaration(n);t["out ".concat(e)]={[i]:JSON.stringify(n.accessor)}}return t}function getGLSLDeclaration(e){const{type:t,size:i}=e.accessor,n=getCompositeGLType(t,i);return n?"".concat(n.name," ").concat(e.name):e.name}const isPage=isBrowser$1()&&"undefined"!=typeof document;let statIdCounter=0;class AnimationLoop{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{onCreateContext:t=e=>createGLContext(e),onAddHTML:i=null,onInitialize:n=()=>{},onRender:r=()=>{},onFinalize:o=()=>{},onError:s,gl:a=null,glOptions:l={},debug:c=!1,createFramebuffer:u=!1,autoResizeViewport:h=!0,autoResizeDrawingBuffer:d=!0,stats:p=lumaStats.get("animation-loop-".concat(statIdCounter++))}=e;let{useDevicePixels:f=!0}=e;"useDevicePixelRatio"in e&&(log$2.deprecated("useDevicePixelRatio","useDevicePixels")(),f=e.useDevicePixelRatio),this.props={onCreateContext:t,onAddHTML:i,onInitialize:n,onRender:r,onFinalize:o,onError:s,gl:a,glOptions:l,debug:c,createFramebuffer:u},this.gl=a,this.needsRedraw=null,this.timeline=null,this.stats=p,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:h,autoResizeDrawingBuffer:d,useDevicePixels:f}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(e){return assert$8("string"==typeof e),this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.autoResizeViewport=e.autoResizeViewport),"autoResizeDrawingBuffer"in e&&(this.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer),"useDevicePixels"in e&&(this.useDevicePixels=e.useDevicePixels),this}start(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._running)return this;this._running=!0;const t=this._getPageLoadPromise().then((()=>!this._running||this._initialized?null:(this._createWebGLContext(e),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=Query.isSupported(this.gl,["timers"])?new Query(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps)))).then((e=>{this._running&&(this._addCallbackData(e||{}),!1!==e&&this._startLoop())}));return this.props.onError&&t.catch(this.props.onError),this}redraw(){return this.isContextLost()||(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers()),this}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise((e=>{this._resolveNextFrame=e}))),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(){return this.props.onCreateContext(...arguments)}onInitialize(){return this.props.onInitialize(...arguments)}onRender(){return this.props.onRender(...arguments)}onFinalize(){return this.props.onFinalize(...arguments)}getHTMLControlValue(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const i=document.getElementById(e);return i?Number(i.value):t}setViewParameters(){return log$2.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){const e=()=>{this._running&&(this.redraw(),this._animationFrameId=this._requestAnimationFrame(e))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(e)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=isPage?new Promise(((e,t)=>{isPage&&"complete"===document.readyState?e(document):window.addEventListener("load",(()=>{e(document)}))})):Promise.resolve({})),this._pageLoadPromise}_setDisplay(e){this.display&&(this.display.delete(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_cancelAnimationFrame(e){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(e):cancelAnimationFrame$1(e)}_requestAnimationFrame(e){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(e):requestAnimationFrame$1(e)}_renderFrame(){this.display?this.display._renderFrame(...arguments):this.onRender(...arguments)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){const{width:e,height:t,aspect:i}=this._getSizeAndAspect();e===this.animationProps.width&&t===this.animationProps.height||this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(e){"object"==typeof e&&null!==e&&(this.animationProps=Object.assign({},this.animationProps,e))}_createWebGLContext(e){if(this.offScreen=e.canvas&&"undefined"!=typeof OffscreenCanvas&&e.canvas instanceof OffscreenCanvas,e=Object.assign({},e,this.props.glOptions),this.gl=this.props.gl?instrumentGLContext(this.props.gl,e):this.onCreateContext(e),!isWebGL(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");resetParameters(this.gl),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",e.appendChild(this.gl.canvas),e.appendChild(t);const i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){const e=this.gl.drawingBufferWidth,t=this.gl.drawingBufferHeight;let i=1;const{canvas:n}=this.gl;return n&&n.clientHeight?i=n.clientWidth/n.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&resizeGLContext(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new Framebuffer(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){const{canvas:e}=this.gl;e&&(e.addEventListener("mousemove",this._onMousemove),e.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(e){this.animationProps._mousePosition=[e.offsetX,e.offsetY]}_onMouseleave(e){this.animationProps._mousePosition=null}}const VERTEX_SHADER$1="vs",FRAGMENT_SHADER$1="fs";function assert$7(e,t){if(!e)throw new Error(t||"shadertools: assertion failed.")}const TYPE_DEFINITIONS$1={number:{validate:(e,t)=>Number.isFinite(e)&&(!("max"in t)||e<=t.max)&&(!("min"in t)||e>=t.min)},array:{validate:(e,t)=>Array.isArray(e)||ArrayBuffer.isView(e)}};function parsePropTypes$1(e){const t={};for(const i in e){const n=parsePropType$1(e[i]);t[i]=n}return t}function parsePropType$1(e){let t=getTypeOf$1(e);return"object"===t?e?"type"in e?Object.assign({},e,TYPE_DEFINITIONS$1[e.type]):"value"in e?(t=getTypeOf$1(e.value),Object.assign({type:t},e,TYPE_DEFINITIONS$1[t])):{type:"object",value:e}:{type:"object",value:null}:Object.assign({type:t,value:e},TYPE_DEFINITIONS$1[t])}function getTypeOf$1(e){return Array.isArray(e)||ArrayBuffer.isView(e)?"array":typeof e}const VERTEX_SHADER="vs",FRAGMENT_SHADER="fs";class ShaderModule{constructor(e){let{name:t,vs:i,fs:n,dependencies:r=[],uniforms:o,getUniforms:s,deprecations:a=[],defines:l={},inject:c={},vertexShader:u,fragmentShader:h}=e;assert$7("string"==typeof t),this.name=t,this.vs=i||u,this.fs=n||h,this.getModuleUniforms=s,this.dependencies=r,this.deprecations=this._parseDeprecationDefinitions(a),this.defines=l,this.injections=normalizeInjections(c),o&&(this.uniforms=parsePropTypes$1(o))}getModuleSource(e){let t;switch(e){case VERTEX_SHADER:t=this.vs||"";break;case FRAGMENT_SHADER:t=this.fs||"";break;default:assert$7(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),"\n").concat(t,"// END MODULE_").concat(this.name,"\n\n")}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach((i=>{i.regex.test(e)&&(i.deprecated?t.deprecated(i.old,i.new)():t.removed(i.old,i.new)())}))}_parseDeprecationDefinitions(e){return e.forEach((e=>{if("function"===e.type)e.regex=new RegExp("\\b".concat(e.old,"\\("));else e.regex=new RegExp("".concat(e.type," ").concat(e.old,";"))})),e}_defaultGetUniforms(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t={},i=this.uniforms;for(const n in i){const r=i[n];n in e&&!r.private?(r.validate&&assert$7(r.validate(e[n],r),"".concat(this.name,": invalid ").concat(n)),t[n]=e[n]):t[n]=r.value}return t}}function normalizeInjections(e){const t={vs:{},fs:{}};for(const i in e){let n=e[i];"string"==typeof n&&(n={order:0,injection:n}),t[i.slice(0,2)][i]=n}return t}function resolveModules(e){return getShaderDependencies(instantiateModules(e))}function getShaderDependencies(e){const t={},i={};return getDependencyGraph({modules:e,level:0,moduleMap:t,moduleDepth:i}),Object.keys(i).sort(((e,t)=>i[t]-i[e])).map((e=>t[e]))}function getDependencyGraph(e){let{modules:t,level:i,moduleMap:n,moduleDepth:r}=e;if(i>=5)throw new Error("Possible loop in shader dependency graph");for(const e of t)n[e.name]=e,(void 0===r[e.name]||r[e.name]<i)&&(r[e.name]=i);for(const e of t)e.dependencies&&getDependencyGraph({modules:e.dependencies,level:i+1,moduleMap:n,moduleDepth:r})}function instantiateModules(e,t){return e.map((e=>(e instanceof ShaderModule||(assert$7("string"!=typeof e,"Shader module use by name is deprecated. Import shader module '".concat(e,"' and use it directly.")),assert$7(e.name,"shader module has no name"),(e=new ShaderModule(e)).dependencies=instantiateModules(e.dependencies)),e)))}function isOldIE(){const e="undefined"!=typeof window&&window.navigator||{},t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).userAgent||e.userAgent||"",i=-1!==t.indexOf("MSIE "),n=-1!==t.indexOf("Trident/");return i||n}const GL_VENDOR=7936,GL_RENDERER=7937,GL_VERSION=7938,GL_SHADING_LANGUAGE_VERSION=35724,WEBGL_FEATURES={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},FEATURES={};function isWebGL2(e){return"undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||Boolean(e&&2===e._version)}function getContextInfo(e){const t=e.getExtension("WEBGL_debug_renderer_info"),i=e.getParameter(t&&t.UNMASKED_VENDOR_WEBGL||GL_VENDOR),n=e.getParameter(t&&t.UNMASKED_RENDERER_WEBGL||GL_RENDERER);return{gpuVendor:identifyGPUVendor(i,n),vendor:i,renderer:n,version:e.getParameter(GL_VERSION),shadingLanguageVersion:e.getParameter(GL_SHADING_LANGUAGE_VERSION)}}function identifyGPUVendor(e,t){return e.match(/NVIDIA/i)||t.match(/NVIDIA/i)?"NVIDIA":e.match(/INTEL/i)||t.match(/INTEL/i)?"INTEL":e.match(/AMD/i)||t.match(/AMD/i)||e.match(/ATI/i)||t.match(/ATI/i)?"AMD":"UNKNOWN GPU"}Object.keys(WEBGL_FEATURES).forEach((e=>{FEATURES[e]=e}));const compiledGlslExtensions={};function canCompileGLGSExtension(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const n=WEBGL_FEATURES[t];if(assert$7(n,t),!isOldIE(i))return!0;if(t in compiledGlslExtensions)return compiledGlslExtensions[t];const r=i.behavior||"enable",o="#extension GL_".concat(n[0]," : ").concat(r,"\nvoid main(void) {}"),s=e.createShader(35633);e.shaderSource(s,o),e.compileShader(s);const a=e.getShaderParameter(s,35713);return e.deleteShader(s),compiledGlslExtensions[t]=a,a}function getFeature(e,t){const i=WEBGL_FEATURES[t];assert$7(i,t);const n=isWebGL2(e)&&i[1]||i[0],r="string"==typeof n?Boolean(e.getExtension(n)):n;return assert$7(!1===r||!0===r),r}function hasFeatures(e,t){return(t=Array.isArray(t)?t:[t]).every((t=>getFeature(e,t)))}function getPlatformShaderDefines(e){switch(getContextInfo(e).gpuVendor.toLowerCase()){case"nvidia":return"#define NVIDIA_GPU\n// Nvidia optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n";case"intel":return"#define INTEL_GPU\n// Intel optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Intel's built-in 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n";case"amd":return"#define AMD_GPU\n";default:return"#define DEFAULT_GPU\n// Prevent driver from optimizing away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Intel's built-in 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n"}}function getVersionDefines(e,t,i){let n="#if (__VERSION__ > 120)\n\n# define FEATURE_GLSL_DERIVATIVES\n# define FEATURE_GLSL_DRAW_BUFFERS\n# define FEATURE_GLSL_FRAG_DEPTH\n# define FEATURE_GLSL_TEXTURE_LOD\n\n// DEPRECATED FLAGS, remove in v9\n# define FRAG_DEPTH\n# define DERIVATIVES\n# define DRAW_BUFFERS\n# define TEXTURE_LOD\n\n#endif // __VERSION\n";return hasFeatures(e,FEATURES.GLSL_FRAG_DEPTH)&&(n+="\n// FRAG_DEPTH => gl_FragDepth is available\n#ifdef GL_EXT_frag_depth\n#extension GL_EXT_frag_depth : enable\n# define FEATURE_GLSL_FRAG_DEPTH\n# define FRAG_DEPTH\n# define gl_FragDepth gl_FragDepthEXT\n#endif\n"),hasFeatures(e,FEATURES.GLSL_DERIVATIVES)&&canCompileGLGSExtension(e,FEATURES.GLSL_DERIVATIVES)&&(n+="\n// DERIVATIVES => dxdF, dxdY and fwidth are available\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n# define FEATURE_GLSL_DERIVATIVES\n# define DERIVATIVES\n#endif\n"),hasFeatures(e,FEATURES.GLSL_FRAG_DATA)&&canCompileGLGSExtension(e,FEATURES.GLSL_FRAG_DATA,{behavior:"require"})&&(n+="\n// DRAW_BUFFERS => gl_FragData[] is available\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers : require\n#define FEATURE_GLSL_DRAW_BUFFERS\n#define DRAW_BUFFERS\n#endif\n"),hasFeatures(e,FEATURES.GLSL_TEXTURE_LOD)&&(n+="// TEXTURE_LOD => texture2DLod etc are available\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod : enable\n\n# define FEATURE_GLSL_TEXTURE_LOD\n# define TEXTURE_LOD\n\n#endif\n"),n}const MODULE_INJECTORS_VS="#ifdef MODULE_LOGDEPTH\n  logdepth_adjustPosition(gl_Position);\n#endif\n",MODULE_INJECTORS_FS="#ifdef MODULE_MATERIAL\n  gl_FragColor = material_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_LIGHTING\n  gl_FragColor = lighting_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_FOG\n  gl_FragColor = fog_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_PICKING\n  gl_FragColor = picking_filterHighlightColor(gl_FragColor);\n  gl_FragColor = picking_filterPickingColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_LOGDEPTH\n  logdepth_setFragDepth();\n#endif\n",MODULE_INJECTORS={[VERTEX_SHADER$1]:MODULE_INJECTORS_VS,[FRAGMENT_SHADER$1]:MODULE_INJECTORS_FS},DECLARATION_INJECT_MARKER="__LUMA_INJECT_DECLARATIONS__",REGEX_START_OF_MAIN$1=/void\s+main\s*\([^)]*\)\s*\{\n?/,REGEX_END_OF_MAIN=/}\n?[^{}]*$/,fragments=[];function injectShader(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=t===VERTEX_SHADER$1;for(const t in i){const n=i[t];n.sort(((e,t)=>e.order-t.order)),fragments.length=n.length;for(let e=0,t=n.length;e<t;++e)fragments[e]=n[e].injection;const o="".concat(fragments.join("\n"),"\n");switch(t){case"vs:#decl":r&&(e=e.replace(DECLARATION_INJECT_MARKER,o));break;case"vs:#main-start":r&&(e=e.replace(REGEX_START_OF_MAIN$1,(e=>e+o)));break;case"vs:#main-end":r&&(e=e.replace(REGEX_END_OF_MAIN,(e=>o+e)));break;case"fs:#decl":r||(e=e.replace(DECLARATION_INJECT_MARKER,o));break;case"fs:#main-start":r||(e=e.replace(REGEX_START_OF_MAIN$1,(e=>e+o)));break;case"fs:#main-end":r||(e=e.replace(REGEX_END_OF_MAIN,(e=>o+e)));break;default:e=e.replace(t,(e=>e+o))}}return e=e.replace(DECLARATION_INJECT_MARKER,""),n&&(e=e.replace(/\}\s*$/,(e=>e+MODULE_INJECTORS[t]))),e}function combineInjects(e){const t={};return assert$7(Array.isArray(e)&&e.length>1),e.forEach((e=>{for(const i in e)t[i]=t[i]?"".concat(t[i],"\n").concat(e[i]):e[i]})),t}function testVariable(e){return new RegExp("\\b".concat(e,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}const ES300_REPLACEMENTS=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,"#version 300 es\n"],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],ES300_VERTEX_REPLACEMENTS=[...ES300_REPLACEMENTS,[testVariable("attribute"),"in $1"],[testVariable("varying"),"out $1"]],ES300_FRAGMENT_REPLACEMENTS=[...ES300_REPLACEMENTS,[testVariable("varying"),"in $1"]],ES100_REPLACEMENTS=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],ES100_VERTEX_REPLACEMENTS=[...ES100_REPLACEMENTS,[testVariable("in"),"attribute $1"],[testVariable("out"),"varying $1"]],ES100_FRAGMENT_REPLACEMENTS=[...ES100_REPLACEMENTS,[testVariable("in"),"varying $1"]],ES100_FRAGMENT_OUTPUT_NAME="gl_FragColor",ES300_FRAGMENT_OUTPUT_REGEX=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,REGEX_START_OF_MAIN=/void\s+main\s*\([^)]*\)\s*\{\n?/;function transpileShader(e,t,i){switch(t){case 300:return i?convertShader(e,ES300_VERTEX_REPLACEMENTS):convertFragmentShaderTo300(e);case 100:return i?convertShader(e,ES100_VERTEX_REPLACEMENTS):convertFragmentShaderTo100(e);default:throw new Error("unknown GLSL version ".concat(t))}}function convertShader(e,t){for(const[i,n]of t)e=e.replace(i,n);return e}function convertFragmentShaderTo300(e){const t=(e=convertShader(e,ES300_FRAGMENT_REPLACEMENTS)).match(ES300_FRAGMENT_OUTPUT_REGEX);if(t){const i=t[1];e=e.replace(new RegExp("\\b".concat(ES100_FRAGMENT_OUTPUT_NAME,"\\b"),"g"),i)}else{const t="fragmentColor";e=e.replace(REGEX_START_OF_MAIN,(e=>"out vec4 ".concat(t,";\n").concat(e))).replace(new RegExp("\\b".concat(ES100_FRAGMENT_OUTPUT_NAME,"\\b"),"g"),t)}return e}function convertFragmentShaderTo100(e){const t=(e=convertShader(e,ES100_FRAGMENT_REPLACEMENTS)).match(ES300_FRAGMENT_OUTPUT_REGEX);if(t){const i=t[1];e=e.replace(ES300_FRAGMENT_OUTPUT_REGEX,"").replace(new RegExp("\\b".concat(i,"\\b"),"g"),ES100_FRAGMENT_OUTPUT_NAME)}return e}const INJECT_SHADER_DECLARATIONS="\n\n".concat(DECLARATION_INJECT_MARKER,"\n\n"),SHADER_TYPE={[VERTEX_SHADER$1]:"vertex",[FRAGMENT_SHADER$1]:"fragment"},FRAGMENT_SHADER_PROLOGUE="precision highp float;\n\n";function assembleShaders(e,t){const{vs:i,fs:n}=t,r=resolveModules(t.modules||[]);return{gl:e,vs:assembleShader(e,Object.assign({},t,{source:i,type:VERTEX_SHADER$1,modules:r})),fs:assembleShader(e,Object.assign({},t,{source:n,type:FRAGMENT_SHADER$1,modules:r})),getUniforms:assembleGetUniforms(r)}}function assembleShader(e,t){let{id:i,source:n,type:r,modules:o,defines:s={},hookFunctions:a=[],inject:l={},transpileToGLSL100:c=!1,prologue:u=!0,log:h}=t;assert$7("string"==typeof n,"shader source must be a string");const d=r===VERTEX_SHADER$1,p=n.split("\n");let f=100,m="",g=n;0===p[0].indexOf("#version ")?(f=300,m=p[0],g=p.slice(1).join("\n")):m="#version ".concat(f);const _={};o.forEach((e=>{Object.assign(_,e.getDefines())})),Object.assign(_,s);let y=u?"".concat(m,"\n").concat(getShaderName({id:i,source:n,type:r}),"\n").concat(getShaderType({type:r}),"\n").concat(getPlatformShaderDefines(e),"\n").concat(getVersionDefines(e),"\n").concat(getApplicationDefines(_),"\n").concat(d?"":FRAGMENT_SHADER_PROLOGUE,"\n"):"".concat(m,"\n");const v=normalizeHookFunctions(a),x={},b={},T={};for(const e in l){const t="string"==typeof l[e]?{injection:l[e],order:0}:l[e],i=e.match(/^(v|f)s:(#)?([\w-]+)$/);if(i){i[2]?"decl"===i[3]?b[e]=[t]:T[e]=[t]:x[e]=[t]}else T[e]=[t]}for(const e of o){h&&e.checkDeprecations(g,h);y+=e.getModuleSource(r,f);const t=e.injections[r];for(const e in t){const i=e.match(/^(v|f)s:#([\w-]+)$/);if(i){const n="decl"===i[2]?b:T;n[e]=n[e]||[],n[e].push(t[e])}else x[e]=x[e]||[],x[e].push(t[e])}}return y+=INJECT_SHADER_DECLARATIONS,y=injectShader(y,r,b),y+=getHookFunctions(v[r],x),y+=g,y=injectShader(y,r,T),y=transpileShader(y,c?100:f,d),y}function assembleGetUniforms(e){return function(t){const i={};for(const n of e){const e=n.getUniforms(t,i);Object.assign(i,e)}return i}}function getShaderType(e){let{type:t}=e;return"\n#define SHADER_TYPE_".concat(SHADER_TYPE[t].toUpperCase(),"\n")}function getShaderName(e){let{id:t,source:i,type:n}=e;return t&&"string"==typeof t&&-1===i.indexOf("SHADER_NAME")?"\n#define SHADER_NAME ".concat(t,"_").concat(SHADER_TYPE[n],"\n\n"):""}function getApplicationDefines(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=0,i="";for(const n in e){0===t&&(i+="\n// APPLICATION DEFINES\n"),t++;const r=e[n];(r||Number.isFinite(r))&&(i+="#define ".concat(n.toUpperCase()," ").concat(e[n],"\n"))}return 0===t&&(i+="\n"),i}function getHookFunctions(e,t){let i="";for(const n in e){const r=e[n];if(i+="void ".concat(r.signature," {\n"),r.header&&(i+="  ".concat(r.header)),t[n]){const e=t[n];e.sort(((e,t)=>e.order-t.order));for(const t of e)i+="  ".concat(t.injection,"\n")}r.footer&&(i+="  ".concat(r.footer)),i+="}\n"}return i}function normalizeHookFunctions(e){const t={vs:{},fs:{}};return e.forEach((e=>{let i;"string"!=typeof e?(i=e,e=i.hook):i={},e=e.trim();const[n,r]=e.split(":"),o=e.replace(/\(.+/,"");t[n][o]=Object.assign(i,{signature:r})})),t}const FS100="void main() {gl_FragColor = vec4(0);}",FS_GLES="out vec4 transform_output;\nvoid main() {\n  transform_output = vec4(0);\n}",FS300="#version 300 es\n".concat(FS_GLES);function getQualifierDetails(e,t){t=Array.isArray(t)?t:[t];const i=e.replace(/^\s+/,"").split(/\s+/),[n,r,o]=i;if(!t.includes(n)||!r||!o)return null;return{qualifier:n,type:r,name:o.split(";")[0]}}function getPassthroughFS(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{version:t=100,input:i,inputType:n,output:r}=e;if(!i)return 300===t?FS300:t>300?"#version ".concat(t,"\n").concat(FS_GLES):FS100;const o=convertToVec4(i,n);return t>=300?"#version ".concat(t," ").concat(300===t?"es":"","\nin ").concat(n," ").concat(i,";\nout vec4 ").concat(r,";\nvoid main() {\n  ").concat(r," = ").concat(o,";\n}"):"varying ".concat(n," ").concat(i,";\nvoid main() {\n  gl_FragColor = ").concat(o,";\n}")}function typeToChannelSuffix(e){switch(e){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return assert$7(!1),null}}function typeToChannelCount(e){switch(e){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return assert$7(!1),null}}function convertToVec4(e,t){switch(t){case"float":return"vec4(".concat(e,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(e,", 0.0, 1.0)");case"vec3":return"vec4(".concat(e,", 1.0)");case"vec4":return e;default:return assert$7(!1),null}}const fp32shader="#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND\nconst float TWO_PI = 6.2831854820251465;\nconst float PI_2 = 1.5707963705062866;\nconst float PI_16 = 0.1963495463132858;\n\nconst float SIN_TABLE_0 = 0.19509032368659973;\nconst float SIN_TABLE_1 = 0.3826834261417389;\nconst float SIN_TABLE_2 = 0.5555702447891235;\nconst float SIN_TABLE_3 = 0.7071067690849304;\n\nconst float COS_TABLE_0 = 0.9807852506637573;\nconst float COS_TABLE_1 = 0.9238795042037964;\nconst float COS_TABLE_2 = 0.8314695954322815;\nconst float COS_TABLE_3 = 0.7071067690849304;\n\nconst float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;\nconst float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;\nconst float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;\nconst float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;\n\nfloat sin_taylor_fp32(float a) {\n  float r, s, t, x;\n\n  if (a == 0.0) {\n    return 0.0;\n  }\n\n  x = -a * a;\n  s = a;\n  r = a;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_3;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_5;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_7;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_9;\n  s = s + t;\n\n  return s;\n}\n\nvoid sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {\n  if (a == 0.0) {\n    sin_t = 0.0;\n    cos_t = 1.0;\n  }\n  sin_t = sin_taylor_fp32(a);\n  cos_t = sqrt(1.0 - sin_t * sin_t);\n}\n\nfloat tan_taylor_fp32(float a) {\n    float sin_a;\n    float cos_a;\n\n    if (a == 0.0) {\n        return 0.0;\n    }\n    float z = floor(a / TWO_PI);\n    float r = a - TWO_PI * z;\n\n    float t;\n    float q = floor(r / PI_2 + 0.5);\n    int j = int(q);\n\n    if (j < -2 || j > 2) {\n        return 1.0 / 0.0;\n    }\n\n    t = r - PI_2 * q;\n\n    q = floor(t / PI_16 + 0.5);\n    int k = int(q);\n    int abs_k = int(abs(float(k)));\n\n    if (abs_k > 4) {\n        return 1.0 / 0.0;\n    } else {\n        t = t - PI_16 * q;\n    }\n\n    float u = 0.0;\n    float v = 0.0;\n\n    float sin_t, cos_t;\n    float s, c;\n    sincos_taylor_fp32(t, sin_t, cos_t);\n\n    if (k == 0) {\n        s = sin_t;\n        c = cos_t;\n    } else {\n        if (abs(float(abs_k) - 1.0) < 0.5) {\n            u = COS_TABLE_0;\n            v = SIN_TABLE_0;\n        } else if (abs(float(abs_k) - 2.0) < 0.5) {\n            u = COS_TABLE_1;\n            v = SIN_TABLE_1;\n        } else if (abs(float(abs_k) - 3.0) < 0.5) {\n            u = COS_TABLE_2;\n            v = SIN_TABLE_2;\n        } else if (abs(float(abs_k) - 4.0) < 0.5) {\n            u = COS_TABLE_3;\n            v = SIN_TABLE_3;\n        }\n        if (k > 0) {\n            s = u * sin_t + v * cos_t;\n            c = u * cos_t - v * sin_t;\n        } else {\n            s = u * sin_t - v * cos_t;\n            c = u * cos_t + v * sin_t;\n        }\n    }\n\n    if (j == 0) {\n        sin_a = s;\n        cos_a = c;\n    } else if (j == 1) {\n        sin_a = c;\n        cos_a = -s;\n    } else if (j == -1) {\n        sin_a = -c;\n        cos_a = s;\n    } else {\n        sin_a = -s;\n        cos_a = -c;\n    }\n    return sin_a / cos_a;\n}\n#endif\n\nfloat tan_fp32(float a) {\n#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND\n  return tan_taylor_fp32(a);\n#else\n  return tan(a);\n#endif\n}\n",fp32={name:"fp32",vs:fp32shader,fs:null};function assert$6(e,t){if(!e)throw new Error("math.gl assertion ".concat(t))}const RADIANS_TO_DEGREES$1=1/Math.PI*180,DEGREES_TO_RADIANS$4=1/180*Math.PI,config={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function formatValue(e,{precision:t=config.precision}={}){return e=round(e),"".concat(parseFloat(e.toPrecision(t)))}function isArray$1(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}function toRadians(e){return radians(e)}function toDegrees(e){return degrees(e)}function radians(e,t){return map(e,(e=>e*DEGREES_TO_RADIANS$4),t)}function degrees(e,t){return map(e,(e=>e*RADIANS_TO_DEGREES$1),t)}function clamp$2(e,t,i){return map(e,(e=>Math.max(t,Math.min(i,e))))}function lerp$4(e,t,i){return isArray$1(e)?e.map(((e,n)=>lerp$4(e,t[n],i))):i*t+(1-i)*e}function equals$1(e,t,i){const n=config.EPSILON;i&&(config.EPSILON=i);try{if(e===t)return!0;if(isArray$1(e)&&isArray$1(t)){if(e.length!==t.length)return!1;for(let i=0;i<e.length;++i)if(!equals$1(e[i],t[i]))return!1;return!0}return e&&e.equals?e.equals(t):t&&t.equals?t.equals(e):"number"==typeof e&&"number"==typeof t&&Math.abs(e-t)<=config.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}finally{config.EPSILON=n}}function round(e){return Math.round(e/config.EPSILON)*config.EPSILON}function duplicateArray(e){return e.clone?e.clone():new Array(e.length)}function map(e,t,i){if(isArray$1(e)){const n=e;i=i||duplicateArray(n);for(let r=0;r<i.length&&r<n.length;++r)i[r]=t(e[r],r,i);return i}return t(e)}function _extendableBuiltin(e){function t(){var t=Reflect.construct(e,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return t.prototype=Object.create(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e,t}class MathArray extends(_extendableBuiltin(Array)){clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:isArray$1(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(config)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+formatValue(this[i],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!equals$1(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(void 0===i)return this.lerp(this,e,t);for(let n=0;n<this.ELEMENTS;++n){const r=e[n];this[n]=r+i*(t[n]-r)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]+=t[e];return this.check()}subtract(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]-=t[e];return this.check()}scale(e){if("number"==typeof e)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(config.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}}function validateVector(e,t){if(e.length!==t)return!1;for(let t=0;t<e.length;++t)if(!Number.isFinite(e[t]))return!1;return!0}function checkNumber(e){if(!Number.isFinite(e))throw new Error("Invalid number ".concat(e));return e}function checkVector(e,t,i=""){if(config.debug&&!validateVector(e,t))throw new Error("math.gl: ".concat(i," some fields set to invalid numbers'"));return e}class Vector extends MathArray{get x(){return this[0]}set x(e){this[0]=checkNumber(e)}get y(){return this[1]}set y(e){this[1]=checkNumber(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){const n=this[i]-e[i];t+=n*n}return checkNumber(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return checkNumber(t)}normalize(){const e=this.magnitude();if(0!==e)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]*=t[e];return this.check()}divide(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t[e];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return assert$6(e>=0&&e<this.ELEMENTS,"index is out of range"),checkNumber(this[e])}setComponent(e,t){return assert$6(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}var EPSILON$1=1e-6,ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array,vec;function create$4(){var e=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e}function add$3(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function negate$1(e,t){return e[0]=-t[0],e[1]=-t[1],e}function lerp$3(e,t,i,n){var r=t[0],o=t[1];return e[0]=r+n*(i[0]-r),e[1]=o+n*(i[1]-o),e}function transformMat2(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r,e[1]=i[1]*n+i[3]*r,e}function transformMat2d(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r+i[4],e[1]=i[1]*n+i[3]*r+i[5],e}function transformMat3$1(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[3]*r+i[6],e[1]=i[1]*n+i[4]*r+i[7],e}function transformMat4$2(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[4]*r+i[12],e[1]=i[1]*n+i[5]*r+i[13],e}function vec2_transformMat4AsVector(e,t,i){const n=t[0],r=t[1],o=i[3]*n+i[7]*r||1;return e[0]=(i[0]*n+i[4]*r)/o,e[1]=(i[1]*n+i[5]*r)/o,e}function vec3_transformMat4AsVector(e,t,i){const n=t[0],r=t[1],o=t[2],s=i[3]*n+i[7]*r+i[11]*o||1;return e[0]=(i[0]*n+i[4]*r+i[8]*o)/s,e[1]=(i[1]*n+i[5]*r+i[9]*o)/s,e[2]=(i[2]*n+i[6]*r+i[10]*o)/s,e}function vec3_transformMat2(e,t,i){const n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r,e[1]=i[1]*n+i[3]*r,e[2]=t[2],e}function vec4_transformMat2(e,t,i){const n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r,e[1]=i[1]*n+i[3]*r,e[2]=t[2],e[3]=t[3],e}function vec4_transformMat3(e,t,i){const n=t[0],r=t[1],o=t[2];return e[0]=i[0]*n+i[3]*r+i[6]*o,e[1]=i[1]*n+i[4]*r+i[7]*o,e[2]=i[2]*n+i[5]*r+i[8]*o,e[3]=t[3],e}vec=create$4();let Vector2$1=class extends Vector{constructor(e=0,t=0){super(2),isArray$1(e)&&1===arguments.length?this.copy(e):(config.debug&&(checkNumber(e),checkNumber(t)),this[0]=e,this[1]=t)}set(e,t){return this[0]=e,this[1]=t,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this.check()}fromObject(e){return config.debug&&(checkNumber(e.x),checkNumber(e.y)),this[0]=e.x,this[1]=e.y,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return transformMat4$2(this,this,e),this.check()}transformAsVector(e){return vec2_transformMat4AsVector(this,this,e),this.check()}transformByMatrix3(e){return transformMat3$1(this,this,e),this.check()}transformByMatrix2x3(e){return transformMat2d(this,this,e),this.check()}transformByMatrix2(e){return transformMat2(this,this,e),this.check()}};function create$3(){var e=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function length$2(e){var t=e[0],i=e[1],n=e[2];return Math.sqrt(t*t+i*i+n*n)}function fromValues(e,t,i){var n=new ARRAY_TYPE(3);return n[0]=e,n[1]=t,n[2]=i,n}function subtract(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function negate(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function normalize$4(e,t){var i=t[0],n=t[1],r=t[2],o=i*i+n*n+r*r;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function dot$2(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function cross(e,t,i){var n=t[0],r=t[1],o=t[2],s=i[0],a=i[1],l=i[2];return e[0]=r*l-o*a,e[1]=o*s-n*l,e[2]=n*a-r*s,e}function transformMat4$1(e,t,i){var n=t[0],r=t[1],o=t[2],s=i[3]*n+i[7]*r+i[11]*o+i[15];return e[0]=(i[0]*n+i[4]*r+i[8]*o+i[12])/(s=s||1),e[1]=(i[1]*n+i[5]*r+i[9]*o+i[13])/s,e[2]=(i[2]*n+i[6]*r+i[10]*o+i[14])/s,e}function transformMat3(e,t,i){var n=t[0],r=t[1],o=t[2];return e[0]=n*i[0]+r*i[3]+o*i[6],e[1]=n*i[1]+r*i[4]+o*i[7],e[2]=n*i[2]+r*i[5]+o*i[8],e}function transformQuat$1(e,t,i){var n=i[0],r=i[1],o=i[2],s=i[3],a=t[0],l=t[1],c=t[2],u=r*c-o*l,h=o*a-n*c,d=n*l-r*a;return e[0]=a+s*(u+=u)+r*(d+=d)-o*(h+=h),e[1]=l+s*h+o*u-n*d,e[2]=c+s*d+n*h-r*u,e}function rotateX$2(e,t,i,n){var r=[],o=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[0],o[1]=r[1]*Math.cos(n)-r[2]*Math.sin(n),o[2]=r[1]*Math.sin(n)+r[2]*Math.cos(n),e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2],e}function rotateY$2(e,t,i,n){var r=[],o=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[2]*Math.sin(n)+r[0]*Math.cos(n),o[1]=r[1],o[2]=r[2]*Math.cos(n)-r[0]*Math.sin(n),e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2],e}function rotateZ$2(e,t,i,n){var r=[],o=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[0]*Math.cos(n)-r[1]*Math.sin(n),o[1]=r[0]*Math.sin(n)+r[1]*Math.cos(n),o[2]=r[2],e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2],e}function angle(e,t){var i=e[0],n=e[1],r=e[2],o=t[0],s=t[1],a=t[2],l=Math.sqrt((i*i+n*n+r*r)*(o*o+s*s+a*a)),c=l&&dot$2(e,t)/l;return Math.acos(Math.min(Math.max(c,-1),1))}var sub=subtract,len=length$2;!function(){var e=create$3()}();const ORIGIN=[0,0,0];let ZERO$3,Vector3$1=class e extends Vector{static get ZERO(){return ZERO$3||(ZERO$3=new e(0,0,0),Object.freeze(ZERO$3)),ZERO$3}constructor(e=0,t=0,i=0){super(-0,-0,-0),1===arguments.length&&isArray$1(e)?this.copy(e):(config.debug&&(checkNumber(e),checkNumber(t),checkNumber(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return config.debug&&(checkNumber(e.x),checkNumber(e.y),checkNumber(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=checkNumber(e)}angle(e){return angle(this,e)}cross(e){return cross(this,this,e),this.check()}rotateX({radians:e,origin:t=ORIGIN}){return rotateX$2(this,this,t,e),this.check()}rotateY({radians:e,origin:t=ORIGIN}){return rotateY$2(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=ORIGIN}){return rotateZ$2(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return transformMat4$1(this,this,e),this.check()}transformAsVector(e){return vec3_transformMat4AsVector(this,this,e),this.check()}transformByMatrix3(e){return transformMat3(this,this,e),this.check()}transformByMatrix2(e){return vec3_transformMat2(this,this,e),this.check()}transformByQuaternion(e){return transformQuat$1(this,this,e),this.check()}},ZERO$2,Vector4$1=class e extends Vector{static get ZERO(){return ZERO$2||(ZERO$2=new e(0,0,0,0),Object.freeze(ZERO$2)),ZERO$2}constructor(e=0,t=0,i=0,n=0){super(-0,-0,-0,-0),isArray$1(e)&&1===arguments.length?this.copy(e):(config.debug&&(checkNumber(e),checkNumber(t),checkNumber(i),checkNumber(n)),this[0]=e,this[1]=t,this[2]=i,this[3]=n)}set(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return config.debug&&(checkNumber(e.x),checkNumber(e.y),checkNumber(e.z),checkNumber(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=checkNumber(e)}get w(){return this[3]}set w(e){this[3]=checkNumber(e)}transform(e){return transformMat4$1(this,this,e),this.check()}transformByMatrix3(e){return vec4_transformMat3(this,this,e),this.check()}transformByMatrix2(e){return vec4_transformMat2(this,this,e),this.check()}transformByQuaternion(e){return transformQuat$1(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}};class Matrix extends MathArray{toString(){let e="[";if(config.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=" ".concat(this[i*this.RANK+t])}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=" ".concat(this[t])}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=checkNumber(i),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const i=e*this.RANK;for(let e=0;e<this.RANK;++e)t[e]=this[i+e];return t}setColumn(e,t){const i=e*this.RANK;for(let e=0;e<this.RANK;++e)this[i+e]=t[e];return this}}function create$2(){var e=new ARRAY_TYPE(9);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function transpose$1(e,t){if(e===t){var i=t[1],n=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=n,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function invert$2(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=u*s-a*c,d=-u*o+a*l,p=c*o-s*l,f=i*h+n*d+r*p;return f?(e[0]=h*(f=1/f),e[1]=(-u*n+r*c)*f,e[2]=(a*n-r*s)*f,e[3]=d*f,e[4]=(u*i-r*l)*f,e[5]=(-a*i+r*o)*f,e[6]=p*f,e[7]=(-c*i+n*l)*f,e[8]=(s*i-n*o)*f,e):null}function determinant$1(e){var t=e[3],i=e[4],n=e[5],r=e[6],o=e[7],s=e[8];return e[0]*(s*i-n*o)+e[1]*(-s*t+n*r)+e[2]*(o*t-i*r)}function multiply$2(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=i[0],p=i[1],f=i[2],m=i[3],g=i[4],_=i[5],y=i[6],v=i[7],x=i[8];return e[0]=d*n+p*s+f*c,e[1]=d*r+p*a+f*u,e[2]=d*o+p*l+f*h,e[3]=m*n+g*s+_*c,e[4]=m*r+g*a+_*u,e[5]=m*o+g*l+_*h,e[6]=y*n+v*s+x*c,e[7]=y*r+v*a+x*u,e[8]=y*o+v*l+x*h,e}function translate$2(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=i[0],p=i[1];return e[0]=n,e[1]=r,e[2]=o,e[3]=s,e[4]=a,e[5]=l,e[6]=d*n+p*s+c,e[7]=d*r+p*a+u,e[8]=d*o+p*l+h,e}function rotate$1(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=Math.sin(i),p=Math.cos(i);return e[0]=p*n+d*s,e[1]=p*r+d*a,e[2]=p*o+d*l,e[3]=p*s-d*n,e[4]=p*a-d*r,e[5]=p*l-d*o,e[6]=c,e[7]=u,e[8]=h,e}function scale$3(e,t,i){var n=i[0],r=i[1];return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=r*t[3],e[4]=r*t[4],e[5]=r*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function fromQuat$1(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i+i,a=n+n,l=r+r,c=i*s,u=n*s,h=n*a,d=r*s,p=r*a,f=r*l,m=o*s,g=o*a,_=o*l;return e[0]=1-h-f,e[3]=u-_,e[6]=d+g,e[1]=u+_,e[4]=1-c-f,e[7]=p-m,e[2]=d-g,e[5]=p+m,e[8]=1-c-h,e}var INDICES$1;!function(e){e[e.COL0ROW0=0]="COL0ROW0",e[e.COL0ROW1=1]="COL0ROW1",e[e.COL0ROW2=2]="COL0ROW2",e[e.COL1ROW0=3]="COL1ROW0",e[e.COL1ROW1=4]="COL1ROW1",e[e.COL1ROW2=5]="COL1ROW2",e[e.COL2ROW0=6]="COL2ROW0",e[e.COL2ROW1=7]="COL2ROW1",e[e.COL2ROW2=8]="COL2ROW2"}(INDICES$1||(INDICES$1={}));const IDENTITY_MATRIX$2=Object.freeze([1,0,0,0,1,0,0,0,1]);let Matrix3$1=class extends Matrix{static get IDENTITY(){return getIdentityMatrix$1()}static get ZERO(){return getZeroMatrix$1()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return INDICES$1}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(IDENTITY_MATRIX$2)}fromObject(e){return this.check()}fromQuaternion(e){return fromQuat$1(this,e),this.check()}set(e,t,i,n,r,o,s,a,l){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=r,this[5]=o,this[6]=s,this[7]=a,this[8]=l,this.check()}setRowMajor(e,t,i,n,r,o,s,a,l){return this[0]=e,this[1]=n,this[2]=s,this[3]=t,this[4]=r,this[5]=a,this[6]=i,this[7]=o,this[8]=l,this.check()}determinant(){return determinant$1(this)}transpose(){return transpose$1(this,this),this.check()}invert(){return invert$2(this,this),this.check()}multiplyLeft(e){return multiply$2(this,e,this),this.check()}multiplyRight(e){return multiply$2(this,this,e),this.check()}rotate(e){return rotate$1(this,this,e),this.check()}scale(e){return Array.isArray(e)?scale$3(this,this,e):scale$3(this,this,[e,e]),this.check()}translate(e){return translate$2(this,this,e),this.check()}transform(e,t){let i;switch(e.length){case 2:i=transformMat3$1(t||[-0,-0],e,this);break;case 3:i=transformMat3(t||[-0,-0,-0],e,this);break;case 4:i=vec4_transformMat3(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return checkVector(i,e.length),i}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}},ZERO_MATRIX3,IDENTITY_MATRIX3;function getZeroMatrix$1(){return ZERO_MATRIX3||(ZERO_MATRIX3=new Matrix3$1([0,0,0,0,0,0,0,0,0]),Object.freeze(ZERO_MATRIX3)),ZERO_MATRIX3}function getIdentityMatrix$1(){return IDENTITY_MATRIX3||(IDENTITY_MATRIX3=new Matrix3$1,Object.freeze(IDENTITY_MATRIX3)),IDENTITY_MATRIX3}function identity$2(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function transpose(e,t){if(e===t){var i=t[1],n=t[2],r=t[3],o=t[6],s=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=o,e[11]=t[14],e[12]=r,e[13]=s,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function invert$1(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=t[9],d=t[10],p=t[11],f=t[12],m=t[13],g=t[14],_=t[15],y=i*a-n*s,v=i*l-r*s,x=i*c-o*s,b=n*l-r*a,T=n*c-o*a,w=r*c-o*l,E=u*m-h*f,S=u*g-d*f,A=u*_-p*f,M=h*g-d*m,I=h*_-p*m,C=d*_-p*g,P=y*C-v*I+x*M+b*A-T*S+w*E;return P?(e[0]=(a*C-l*I+c*M)*(P=1/P),e[1]=(r*I-n*C-o*M)*P,e[2]=(m*w-g*T+_*b)*P,e[3]=(d*T-h*w-p*b)*P,e[4]=(l*A-s*C-c*S)*P,e[5]=(i*C-r*A+o*S)*P,e[6]=(g*x-f*w-_*v)*P,e[7]=(u*w-d*x+p*v)*P,e[8]=(s*I-a*A+c*E)*P,e[9]=(n*A-i*I-o*E)*P,e[10]=(f*T-m*x+_*y)*P,e[11]=(h*x-u*T-p*y)*P,e[12]=(a*S-s*M-l*E)*P,e[13]=(i*M-n*S+r*E)*P,e[14]=(m*v-f*b-g*y)*P,e[15]=(u*b-h*v+d*y)*P,e):null}function determinant(e){var t=e[0],i=e[1],n=e[2],r=e[4],o=e[5],s=e[6],a=e[8],l=e[9],c=e[10],u=e[12],h=e[13],d=e[14],p=t*o-i*r,f=t*s-n*r,m=i*s-n*o,g=a*h-l*u,_=a*d-c*u,y=l*d-c*h;return e[7]*(t*y-i*_+n*g)-e[3]*(r*y-o*_+s*g)+e[15]*(a*m-l*f+c*p)-e[11]*(u*m-h*f+d*p)}function multiply$1(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],p=t[10],f=t[11],m=t[12],g=t[13],_=t[14],y=t[15],v=i[0],x=i[1],b=i[2],T=i[3];return e[0]=v*n+x*a+b*h+T*m,e[1]=v*r+x*l+b*d+T*g,e[2]=v*o+x*c+b*p+T*_,e[3]=v*s+x*u+b*f+T*y,e[4]=(v=i[4])*n+(x=i[5])*a+(b=i[6])*h+(T=i[7])*m,e[5]=v*r+x*l+b*d+T*g,e[6]=v*o+x*c+b*p+T*_,e[7]=v*s+x*u+b*f+T*y,e[8]=(v=i[8])*n+(x=i[9])*a+(b=i[10])*h+(T=i[11])*m,e[9]=v*r+x*l+b*d+T*g,e[10]=v*o+x*c+b*p+T*_,e[11]=v*s+x*u+b*f+T*y,e[12]=(v=i[12])*n+(x=i[13])*a+(b=i[14])*h+(T=i[15])*m,e[13]=v*r+x*l+b*d+T*g,e[14]=v*o+x*c+b*p+T*_,e[15]=v*s+x*u+b*f+T*y,e}function translate$1(e,t,i){var n,r,o,s,a,l,c,u,h,d,p,f,m=i[0],g=i[1],_=i[2];return t===e?(e[12]=t[0]*m+t[4]*g+t[8]*_+t[12],e[13]=t[1]*m+t[5]*g+t[9]*_+t[13],e[14]=t[2]*m+t[6]*g+t[10]*_+t[14],e[15]=t[3]*m+t[7]*g+t[11]*_+t[15]):(r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],p=t[10],f=t[11],e[0]=n=t[0],e[1]=r,e[2]=o,e[3]=s,e[4]=a,e[5]=l,e[6]=c,e[7]=u,e[8]=h,e[9]=d,e[10]=p,e[11]=f,e[12]=n*m+a*g+h*_+t[12],e[13]=r*m+l*g+d*_+t[13],e[14]=o*m+c*g+p*_+t[14],e[15]=s*m+u*g+f*_+t[15]),e}function scale$2(e,t,i){var n=i[0],r=i[1],o=i[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function rotate(e,t,i,n){var r,o,s,a,l,c,u,h,d,p,f,m,g,_,y,v,x,b,T,w,E,S,A,M,I=n[0],C=n[1],P=n[2],L=Math.sqrt(I*I+C*C+P*P);return L<EPSILON$1?null:(I*=L=1/L,C*=L,P*=L,r=Math.sin(i),o=Math.cos(i),l=t[1],c=t[2],u=t[3],d=t[5],p=t[6],f=t[7],g=t[9],_=t[10],y=t[11],T=I*C*(s=1-o)-P*r,w=C*C*s+o,E=P*C*s+I*r,S=I*P*s+C*r,A=C*P*s-I*r,M=P*P*s+o,e[0]=(a=t[0])*(v=I*I*s+o)+(h=t[4])*(x=C*I*s+P*r)+(m=t[8])*(b=P*I*s-C*r),e[1]=l*v+d*x+g*b,e[2]=c*v+p*x+_*b,e[3]=u*v+f*x+y*b,e[4]=a*T+h*w+m*E,e[5]=l*T+d*w+g*E,e[6]=c*T+p*w+_*E,e[7]=u*T+f*w+y*E,e[8]=a*S+h*A+m*M,e[9]=l*S+d*A+g*M,e[10]=c*S+p*A+_*M,e[11]=u*S+f*A+y*M,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function rotateX$1(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[4],s=t[5],a=t[6],l=t[7],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*r+c*n,e[5]=s*r+u*n,e[6]=a*r+h*n,e[7]=l*r+d*n,e[8]=c*r-o*n,e[9]=u*r-s*n,e[10]=h*r-a*n,e[11]=d*r-l*n,e}function rotateY$1(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[0],s=t[1],a=t[2],l=t[3],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r-c*n,e[1]=s*r-u*n,e[2]=a*r-h*n,e[3]=l*r-d*n,e[8]=o*n+c*r,e[9]=s*n+u*r,e[10]=a*n+h*r,e[11]=l*n+d*r,e}function rotateZ$1(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[0],s=t[1],a=t[2],l=t[3],c=t[4],u=t[5],h=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r+c*n,e[1]=s*r+u*n,e[2]=a*r+h*n,e[3]=l*r+d*n,e[4]=c*r-o*n,e[5]=u*r-s*n,e[6]=h*r-a*n,e[7]=d*r-l*n,e}function getScaling(e,t){var i=t[0],n=t[1],r=t[2],o=t[4],s=t[5],a=t[6],l=t[8],c=t[9],u=t[10];return e[0]=Math.sqrt(i*i+n*n+r*r),e[1]=Math.sqrt(o*o+s*s+a*a),e[2]=Math.sqrt(l*l+c*c+u*u),e}function fromQuat(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i+i,a=n+n,l=r+r,c=i*s,u=n*s,h=n*a,d=r*s,p=r*a,f=r*l,m=o*s,g=o*a,_=o*l;return e[0]=1-h-f,e[1]=u+_,e[2]=d-g,e[3]=0,e[4]=u-_,e[5]=1-c-f,e[6]=p+m,e[7]=0,e[8]=d+g,e[9]=p-m,e[10]=1-c-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function frustum(e,t,i,n,r,o,s){var a=1/(i-t),l=1/(r-n),c=1/(o-s);return e[0]=2*o*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o*l,e[6]=0,e[7]=0,e[8]=(i+t)*a,e[9]=(r+n)*l,e[10]=(s+o)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=s*o*2*c,e[15]=0,e}function perspectiveNO(e,t,i,n,r){var o=1/Math.tan(t/2);if(e[0]=o/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0){var s=1/(n-r);e[10]=(r+n)*s,e[14]=2*r*n*s}else e[10]=-1,e[14]=-2*n;return e}var perspective=perspectiveNO;function orthoNO(e,t,i,n,r,o,s){var a=1/(t-i),l=1/(n-r),c=1/(o-s);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*a,e[13]=(r+n)*l,e[14]=(s+o)*c,e[15]=1,e}var ortho=orthoNO,INDICES;function lookAt(e,t,i,n){var r,o,s,a,l,c,u,h,d,p,f=t[0],m=t[1],g=t[2],_=n[0],y=n[1],v=n[2],x=i[0],b=i[1],T=i[2];return Math.abs(f-x)<EPSILON$1&&Math.abs(m-b)<EPSILON$1&&Math.abs(g-T)<EPSILON$1?identity$2(e):(u=f-x,h=m-b,d=g-T,r=y*(d*=p=1/Math.sqrt(u*u+h*h+d*d))-v*(h*=p),o=v*(u*=p)-_*d,s=_*h-y*u,(p=Math.sqrt(r*r+o*o+s*s))?(r*=p=1/p,o*=p,s*=p):(r=0,o=0,s=0),a=h*s-d*o,l=d*r-u*s,c=u*o-h*r,(p=Math.sqrt(a*a+l*l+c*c))?(a*=p=1/p,l*=p,c*=p):(a=0,l=0,c=0),e[0]=r,e[1]=a,e[2]=u,e[3]=0,e[4]=o,e[5]=l,e[6]=h,e[7]=0,e[8]=s,e[9]=c,e[10]=d,e[11]=0,e[12]=-(r*f+o*m+s*g),e[13]=-(a*f+l*m+c*g),e[14]=-(u*f+h*m+d*g),e[15]=1,e)}function create$1(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function add$2(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function scale$1(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function length$1(e){var t=e[0],i=e[1],n=e[2],r=e[3];return Math.sqrt(t*t+i*i+n*n+r*r)}function squaredLength$1(e){var t=e[0],i=e[1],n=e[2],r=e[3];return t*t+i*i+n*n+r*r}function normalize$3(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i*i+n*n+r*r+o*o;return s>0&&(s=1/Math.sqrt(s)),e[0]=i*s,e[1]=n*s,e[2]=r*s,e[3]=o*s,e}function dot$1(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function lerp$2(e,t,i,n){var r=t[0],o=t[1],s=t[2],a=t[3];return e[0]=r+n*(i[0]-r),e[1]=o+n*(i[1]-o),e[2]=s+n*(i[2]-s),e[3]=a+n*(i[3]-a),e}function transformMat4(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3];return e[0]=i[0]*n+i[4]*r+i[8]*o+i[12]*s,e[1]=i[1]*n+i[5]*r+i[9]*o+i[13]*s,e[2]=i[2]*n+i[6]*r+i[10]*o+i[14]*s,e[3]=i[3]*n+i[7]*r+i[11]*o+i[15]*s,e}function transformQuat(e,t,i){var n=i[0],r=i[1],o=i[2],s=i[3],a=t[0],l=t[1],c=t[2],u=r*c-o*l,h=o*a-n*c,d=n*l-r*a;return e[0]=a+s*(u+=u)+r*(d+=d)-o*(h+=h),e[1]=l+s*h+o*u-n*d,e[2]=c+s*d+n*h-r*u,e[3]=t[3],e}!function(){var e=create$1()}(),function(e){e[e.COL0ROW0=0]="COL0ROW0",e[e.COL0ROW1=1]="COL0ROW1",e[e.COL0ROW2=2]="COL0ROW2",e[e.COL0ROW3=3]="COL0ROW3",e[e.COL1ROW0=4]="COL1ROW0",e[e.COL1ROW1=5]="COL1ROW1",e[e.COL1ROW2=6]="COL1ROW2",e[e.COL1ROW3=7]="COL1ROW3",e[e.COL2ROW0=8]="COL2ROW0",e[e.COL2ROW1=9]="COL2ROW1",e[e.COL2ROW2=10]="COL2ROW2",e[e.COL2ROW3=11]="COL2ROW3",e[e.COL3ROW0=12]="COL3ROW0",e[e.COL3ROW1=13]="COL3ROW1",e[e.COL3ROW2=14]="COL3ROW2",e[e.COL3ROW3=15]="COL3ROW3"}(INDICES||(INDICES={}));const DEFAULT_FOVY=45*Math.PI/180,DEFAULT_ASPECT=1,DEFAULT_NEAR=.1,DEFAULT_FAR=500,IDENTITY_MATRIX$1=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);let Matrix4$1=class extends Matrix{static get IDENTITY(){return getIdentityMatrix()}static get ZERO(){return getZeroMatrix()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return INDICES}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=r,this[5]=o,this[6]=s,this[7]=a,this[8]=l,this[9]=c,this[10]=u,this[11]=h,this[12]=d,this[13]=p,this[14]=f,this[15]=m,this.check()}setRowMajor(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m){return this[0]=e,this[1]=r,this[2]=l,this[3]=d,this[4]=t,this[5]=o,this[6]=c,this[7]=p,this[8]=i,this[9]=s,this[10]=u,this[11]=f,this[12]=n,this[13]=a,this[14]=h,this[15]=m,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(IDENTITY_MATRIX$1)}fromObject(e){return this.check()}fromQuaternion(e){return fromQuat(this,e),this.check()}frustum(e){const{left:t,right:i,bottom:n,top:r,near:o=DEFAULT_NEAR,far:s=DEFAULT_FAR}=e;return s===1/0?computeInfinitePerspectiveOffCenter(this,t,i,n,r,o):frustum(this,t,i,n,r,o,s),this.check()}lookAt(e){const{eye:t,center:i=[0,0,0],up:n=[0,1,0]}=e;return lookAt(this,t,i,n),this.check()}ortho(e){const{left:t,right:i,bottom:n,top:r,near:o=DEFAULT_NEAR,far:s=DEFAULT_FAR}=e;return ortho(this,t,i,n,r,o,s),this.check()}orthographic(e){const{fovy:t=DEFAULT_FOVY,aspect:i=DEFAULT_ASPECT,focalDistance:n=1,near:r=DEFAULT_NEAR,far:o=DEFAULT_FAR}=e;checkRadians(t);const s=n*Math.tan(t/2),a=s*i;return this.ortho({left:-a,right:a,bottom:-s,top:s,near:r,far:o})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:i=1,near:n=.1,far:r=500}=e;return checkRadians(t),perspective(this,t,i,n,r),this.check()}determinant(){return determinant(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0];const i=this.getScale(t=t||[-0,-0,-0]),n=1/i[0],r=1/i[1],o=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*r,e[2]=this[2]*o,e[3]=0,e[4]=this[4]*n,e[5]=this[5]*r,e[6]=this[6]*o,e[7]=0,e[8]=this[8]*n,e[9]=this[9]*r,e[10]=this[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0];const i=this.getScale(t=t||[-0,-0,-0]),n=1/i[0],r=1/i[1],o=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*r,e[2]=this[2]*o,e[3]=this[4]*n,e[4]=this[5]*r,e[5]=this[6]*o,e[6]=this[8]*n,e[7]=this[9]*r,e[8]=this[10]*o,e}transpose(){return transpose(this,this),this.check()}invert(){return invert$1(this,this),this.check()}multiplyLeft(e){return multiply$1(this,e,this),this.check()}multiplyRight(e){return multiply$1(this,this,e),this.check()}rotateX(e){return rotateX$1(this,this,e),this.check()}rotateY(e){return rotateY$1(this,this,e),this.check()}rotateZ(e){return rotateZ$1(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return rotate(this,this,e,t),this.check()}scale(e){return scale$2(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return translate$1(this,this,e),this.check()}transform(e,t){return 4===e.length?(checkVector(t=transformMat4(t||[-0,-0,-0,-0],e,this),4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:i}=e;let n;switch(i){case 2:n=transformMat4$2(t||[-0,-0],e,this);break;case 3:n=transformMat4$1(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return checkVector(n,e.length),n}transformAsVector(e,t){let i;switch(e.length){case 2:i=vec2_transformMat4AsVector(t||[-0,-0],e,this);break;case 3:i=vec3_transformMat4AsVector(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return checkVector(i,e.length),i}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}},ZERO$1,IDENTITY$1;function getZeroMatrix(){return ZERO$1||(ZERO$1=new Matrix4$1([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(ZERO$1)),ZERO$1}function getIdentityMatrix(){return IDENTITY$1||(IDENTITY$1=new Matrix4$1,Object.freeze(IDENTITY$1)),IDENTITY$1}function checkRadians(e){if(e>2*Math.PI)throw Error("expected radians")}function computeInfinitePerspectiveOffCenter(e,t,i,n,r,o){const s=2*o/(r-n),a=(i+t)/(i-t),l=(r+n)/(r-n),c=-2*o;return e[0]=2*o/(i-t),e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=a,e[9]=l,e[10]=-1,e[11]=-1,e[12]=0,e[13]=0,e[14]=c,e[15]=0,e}function create(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function identity$1(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function setAxisAngle(e,t,i){i*=.5;var n=Math.sin(i);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(i),e}function multiply(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=i[0],l=i[1],c=i[2],u=i[3];return e[0]=n*u+s*a+r*c-o*l,e[1]=r*u+s*l+o*a-n*c,e[2]=o*u+s*c+n*l-r*a,e[3]=s*u-n*a-r*l-o*c,e}function rotateX(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l+s*a,e[1]=r*l+o*a,e[2]=o*l-r*a,e[3]=s*l-n*a,e}function rotateY(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l-o*a,e[1]=r*l+s*a,e[2]=o*l+n*a,e[3]=s*l-r*a,e}function rotateZ(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l+r*a,e[1]=r*l-n*a,e[2]=o*l+s*a,e[3]=s*l-o*a,e}function calculateW(e,t){var i=t[0],n=t[1],r=t[2];return e[0]=i,e[1]=n,e[2]=r,e[3]=Math.sqrt(Math.abs(1-i*i-n*n-r*r)),e}function slerp(e,t,i,n){var r,o,s,a,l,c=t[0],u=t[1],h=t[2],d=t[3],p=i[0],f=i[1],m=i[2],g=i[3];return(o=c*p+u*f+h*m+d*g)<0&&(o=-o,p=-p,f=-f,m=-m,g=-g),1-o>EPSILON$1?(r=Math.acos(o),s=Math.sin(r),a=Math.sin((1-n)*r)/s,l=Math.sin(n*r)/s):(a=1-n,l=n),e[0]=a*c+l*p,e[1]=a*u+l*f,e[2]=a*h+l*m,e[3]=a*d+l*g,e}function invert(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i*i+n*n+r*r+o*o,a=s?1/s:0;return e[0]=-i*a,e[1]=-n*a,e[2]=-r*a,e[3]=o*a,e}function conjugate(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function fromMat3(e,t){var i,n=t[0]+t[4]+t[8];if(n>0)i=Math.sqrt(n+1),e[3]=.5*i,e[0]=(t[5]-t[7])*(i=.5/i),e[1]=(t[6]-t[2])*i,e[2]=(t[1]-t[3])*i;else{var r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);var o=(r+1)%3,s=(r+2)%3;i=Math.sqrt(t[3*r+r]-t[3*o+o]-t[3*s+s]+1),e[r]=.5*i,e[3]=(t[3*o+s]-t[3*s+o])*(i=.5/i),e[o]=(t[3*o+r]+t[3*r+o])*i,e[s]=(t[3*s+r]+t[3*r+s])*i}return e}var add$1=add$2,scale=scale$1,dot=dot$1,lerp$1=lerp$2,length=length$1,squaredLength=squaredLength$1,normalize$2=normalize$3,rotationTo=(tmpvec3=create$3(),xUnitVec3=fromValues(1,0,0),yUnitVec3=fromValues(0,1,0),function(e,t,i){var n=dot$2(t,i);return n<-.999999?(cross(tmpvec3,xUnitVec3,t),len(tmpvec3)<1e-6&&cross(tmpvec3,yUnitVec3,t),normalize$4(tmpvec3,tmpvec3),setAxisAngle(e,tmpvec3,Math.PI),e):n>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(cross(tmpvec3,t,i),e[0]=tmpvec3[0],e[1]=tmpvec3[1],e[2]=tmpvec3[2],e[3]=1+n,normalize$2(e,e))}),tmpvec3,xUnitVec3,yUnitVec3,temp1,temp2,matr;temp1=create(),temp2=create(),matr=create$2();const IDENTITY_QUATERNION=[0,0,0,1];let Quaternion$1=class extends MathArray{constructor(e=0,t=0,i=0,n=1){super(-0,-0,-0,-0),Array.isArray(e)&&1===arguments.length?this.copy(e):this.set(e,t,i,n)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return fromMat3(this,e),this.check()}fromAxisRotation(e,t){return setAxisAngle(this,e,t),this.check()}identity(){return identity$1(this),this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=checkNumber(e)}get y(){return this[1]}set y(e){this[1]=checkNumber(e)}get z(){return this[2]}set z(e){this[2]=checkNumber(e)}get w(){return this[3]}set w(e){this[3]=checkNumber(e)}len(){return length(this)}lengthSquared(){return squaredLength(this)}dot(e){return dot(this,e)}rotationTo(e,t){return rotationTo(this,e,t),this.check()}add(e){return add$1(this,this,e),this.check()}calculateW(){return calculateW(this,this),this.check()}conjugate(){return conjugate(this,this),this.check()}invert(){return invert(this,this),this.check()}lerp(e,t,i){return void 0===i?this.lerp(this,e,t):(lerp$1(this,e,t,i),this.check())}multiplyRight(e){return multiply(this,this,e),this.check()}multiplyLeft(e){return multiply(this,e,this),this.check()}normalize(){const e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,0===e&&(this[3]=1),this.check()}rotateX(e){return rotateX(this,this,e),this.check()}rotateY(e){return rotateY(this,this,e),this.check()}rotateZ(e){return rotateZ(this,this,e),this.check()}scale(e){return scale(this,this,e),this.check()}slerp(e,t,i){let n,r,o;switch(arguments.length){case 1:({start:n=IDENTITY_QUATERNION,target:r,ratio:o}=e);break;case 2:n=this,r=e,o=t;break;default:n=e,r=t,o=i}return slerp(this,n,r,o),this.check()}transformVector4(e,t=new Vector4$1){return transformQuat(t,e,this),checkVector(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}};var _MathUtils={EPSILON1:.1,EPSILON12:1e-12,EPSILON15:1e-15,EPSILON20:1e-20},lightingShader$1="#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))\n\nstruct AmbientLight {\n vec3 color;\n};\n\nstruct PointLight {\n vec3 color;\n vec3 position;\n vec3 attenuation;\n};\n\nstruct DirectionalLight {\n  vec3 color;\n  vec3 direction;\n};\n\nuniform AmbientLight lighting_uAmbientLight;\nuniform PointLight lighting_uPointLight[MAX_LIGHTS];\nuniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];\nuniform int lighting_uPointLightCount;\nuniform int lighting_uDirectionalLightCount;\n\nuniform bool lighting_uEnabled;\n\nfloat getPointLightAttenuation(PointLight pointLight, float distance) {\n  return pointLight.attenuation.x\n       + pointLight.attenuation.y * distance\n       + pointLight.attenuation.z * distance * distance;\n}\n\n#endif\n";const INITIAL_MODULE_OPTIONS$2={lightSources:{}};function convertColor(){let{color:e=[0,0,0],intensity:t=1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.map((e=>e*t/255))}function getLightSourceUniforms(e){let{ambientLight:t,pointLights:i=[],directionalLights:n=[]}=e;const r={};return r["lighting_uAmbientLight.color"]=t?convertColor(t):[0,0,0],i.forEach(((e,t)=>{r["lighting_uPointLight[".concat(t,"].color")]=convertColor(e),r["lighting_uPointLight[".concat(t,"].position")]=e.position,r["lighting_uPointLight[".concat(t,"].attenuation")]=e.attenuation||[1,0,0]})),r.lighting_uPointLightCount=i.length,n.forEach(((e,t)=>{r["lighting_uDirectionalLight[".concat(t,"].color")]=convertColor(e),r["lighting_uDirectionalLight[".concat(t,"].direction")]=e.direction})),r.lighting_uDirectionalLightCount=n.length,r}function getUniforms$3(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:INITIAL_MODULE_OPTIONS$2;if("lightSources"in e){const{ambientLight:t,pointLights:i,directionalLights:n}=e.lightSources||{};return t||i&&i.length>0||n&&n.length>0?Object.assign({},getLightSourceUniforms({ambientLight:t,pointLights:i,directionalLights:n}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in e){const t={pointLights:[],directionalLights:[]};for(const i of e.lights||[])switch(i.type){case"ambient":t.ambientLight=i;break;case"directional":t.directionalLights.push(i);break;case"point":t.pointLights.push(i)}return getUniforms$3({lightSources:t})}return{}}const lights={name:"lights",vs:lightingShader$1,fs:lightingShader$1,getUniforms:getUniforms$3,defines:{MAX_LIGHTS:3}},DEFAULT_HIGHLIGHT_COLOR=new Uint8Array([0,255,255,255]),DEFAULT_MODULE_OPTIONS={pickingSelectedColor:null,pickingHighlightColor:DEFAULT_HIGHLIGHT_COLOR,pickingActive:!1,pickingAttribute:!1};function getUniforms$2(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:DEFAULT_MODULE_OPTIONS;const t={};if(void 0!==e.pickingSelectedColor)if(e.pickingSelectedColor){const i=e.pickingSelectedColor.slice(0,3);t.picking_uSelectedColorValid=1,t.picking_uSelectedColor=i}else t.picking_uSelectedColorValid=0;if(e.pickingHighlightColor){const i=Array.from(e.pickingHighlightColor,(e=>e/255));Number.isFinite(i[3])||(i[3]=1),t.picking_uHighlightColor=i}return void 0!==e.pickingActive&&(t.picking_uActive=Boolean(e.pickingActive),t.picking_uAttribute=Boolean(e.pickingAttribute)),t}const vs$f="uniform bool picking_uActive;\nuniform bool picking_uAttribute;\nuniform vec3 picking_uSelectedColor;\nuniform bool picking_uSelectedColorValid;\n\nout vec4 picking_vRGBcolor_Avalid;\n\nconst float COLOR_SCALE = 1. / 255.;\n\nbool picking_isColorValid(vec3 color) {\n  return dot(color, vec3(1.0)) > 0.001;\n}\n\nbool isVertexPicked(vec3 vertexColor) {\n  return\n    picking_uSelectedColorValid &&\n    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));\n}\n\nvoid picking_setPickingColor(vec3 pickingColor) {\n  if (picking_uActive) {\n    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));\n\n    if (!picking_uAttribute) {\n      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;\n    }\n  } else {\n    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));\n  }\n}\n\nvoid picking_setPickingAttribute(float value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.r = value;\n  }\n}\nvoid picking_setPickingAttribute(vec2 value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.rg = value;\n  }\n}\nvoid picking_setPickingAttribute(vec3 value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.rgb = value;\n  }\n}\n",fs$e="uniform bool picking_uActive;\nuniform vec3 picking_uSelectedColor;\nuniform vec4 picking_uHighlightColor;\n\nin vec4 picking_vRGBcolor_Avalid;\nvec4 picking_filterHighlightColor(vec4 color) {\n  if (picking_uActive) {\n    return color;\n  }\n  bool selected = bool(picking_vRGBcolor_Avalid.a);\n\n  if (selected) {\n    float highLightAlpha = picking_uHighlightColor.a;\n    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);\n    float highLightRatio = highLightAlpha / blendedAlpha;\n\n    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);\n    return vec4(blendedRGB, blendedAlpha);\n  } else {\n    return color;\n  }\n}\nvec4 picking_filterPickingColor(vec4 color) {\n  if (picking_uActive) {\n    if (picking_vRGBcolor_Avalid.a == 0.0) {\n      discard;\n    }\n    return picking_vRGBcolor_Avalid;\n  }\n  return color;\n}\nvec4 picking_filterColor(vec4 color) {\n  vec4 highightColor = picking_filterHighlightColor(color);\n  return picking_filterPickingColor(highightColor);\n}\n\n",picking$1={name:"picking",vs:vs$f,fs:fs$e,getUniforms:getUniforms$2};var lightingShader="\nuniform float lighting_uAmbient;\nuniform float lighting_uDiffuse;\nuniform float lighting_uShininess;\nuniform vec3  lighting_uSpecularColor;\n\nvec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {\n    vec3 halfway_direction = normalize(light_direction + view_direction);\n    float lambertian = dot(light_direction, normal_worldspace);\n    float specular = 0.0;\n    if (lambertian > 0.0) {\n      float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);\n      specular = pow(specular_angle, lighting_uShininess);\n    }\n    lambertian = max(lambertian, 0.0);\n    return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;\n}\n\nvec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {\n  vec3 lightColor = surfaceColor;\n\n  if (lighting_uEnabled) {\n    vec3 view_direction = normalize(cameraPosition - position_worldspace);\n    lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uPointLightCount) {\n        break;\n      }\n      PointLight pointLight = lighting_uPointLight[i];\n      vec3 light_position_worldspace = pointLight.position;\n      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);\n      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n    }\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uDirectionalLightCount) {\n        break;\n      }\n      DirectionalLight directionalLight = lighting_uDirectionalLight[i];\n      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n    }\n  }\n  return lightColor;\n}\n\nvec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {\n  vec3 lightColor = vec3(0, 0, 0);\n  vec3 surfaceColor = vec3(0, 0, 0);\n\n  if (lighting_uEnabled) {\n    vec3 view_direction = normalize(cameraPosition - position_worldspace);\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uPointLightCount) {\n        break;\n      }\n      PointLight pointLight = lighting_uPointLight[i];\n      vec3 light_position_worldspace = pointLight.position;\n      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);\n      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n    }\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uDirectionalLightCount) {\n        break;\n      }\n      DirectionalLight directionalLight = lighting_uDirectionalLight[i];\n      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n    }\n  }\n  return lightColor;\n}\n";const INITIAL_MODULE_OPTIONS$1={};function getMaterialUniforms(e){const{ambient:t=.35,diffuse:i=.6,shininess:n=32,specularColor:r=[30,30,30]}=e;return{lighting_uAmbient:t,lighting_uDiffuse:i,lighting_uShininess:n,lighting_uSpecularColor:r.map((e=>e/255))}}function getUniforms$1(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:INITIAL_MODULE_OPTIONS$1;if(!("material"in e))return{};const{material:t}=e;return t?getMaterialUniforms(t):{lighting_uEnabled:!1}}const gouraudLighting={name:"gouraud-lighting",dependencies:[lights],vs:lightingShader,defines:{LIGHTING_VERTEX:1},getUniforms:getUniforms$1},phongLighting={name:"phong-lighting",dependencies:[lights],fs:lightingShader,defines:{LIGHTING_FRAGMENT:1},getUniforms:getUniforms$1};var vs$e="uniform mat4 u_MVPMatrix;\nuniform mat4 u_ModelMatrix;\nuniform mat4 u_NormalMatrix;\n\nvarying vec3 pbr_vPosition;\nvarying vec2 pbr_vUV;\n\n#ifdef HAS_NORMALS\n# ifdef HAS_TANGENTS\nvarying mat3 pbr_vTBN;\n# else\nvarying vec3 pbr_vNormal;\n# endif\n#endif\n\nvoid pbr_setPositionNormalTangentUV(vec4 position, vec4 normal, vec4 tangent, vec2 uv)\n{\n  vec4 pos = u_ModelMatrix * position;\n  pbr_vPosition = vec3(pos.xyz) / pos.w;\n\n#ifdef HAS_NORMALS\n#ifdef HAS_TANGENTS\n  vec3 normalW = normalize(vec3(u_NormalMatrix * vec4(normal.xyz, 0.0)));\n  vec3 tangentW = normalize(vec3(u_ModelMatrix * vec4(tangent.xyz, 0.0)));\n  vec3 bitangentW = cross(normalW, tangentW) * tangent.w;\n  pbr_vTBN = mat3(tangentW, bitangentW, normalW);\n#else\n  pbr_vNormal = normalize(vec3(u_ModelMatrix * vec4(normal.xyz, 0.0)));\n#endif\n#endif\n\n#ifdef HAS_UV\n  pbr_vUV = uv;\n#else\n  pbr_vUV = vec2(0.,0.);\n#endif\n}\n",fs$d="#if defined(USE_TEX_LOD) && !defined(FEATURE_GLSL_TEXTURE_LOD)\n# error PBR fragment shader: Texture LOD is not available\n#endif\n\n#if !defined(HAS_TANGENTS) && !defined(FEATURE_GLSL_DERIVATIVES)\n# error PBR fragment shader: Derivatives are not available\n#endif\n\n\n#if (__VERSION__ < 300)\n  #define SMART_FOR(INIT, WEBGL1COND, WEBGL2COND, INCR) for (INIT; WEBGL1COND; INCR)\n#else\n  #define SMART_FOR(INIT, WEBGL1COND, WEBGL2COND, INCR) for (INIT; WEBGL2COND; INCR)\n#endif\n\nprecision highp float;\n\nuniform bool pbr_uUnlit;\n\n#ifdef USE_IBL\nuniform samplerCube u_DiffuseEnvSampler;\nuniform samplerCube u_SpecularEnvSampler;\nuniform sampler2D u_brdfLUT;\nuniform vec2 u_ScaleIBLAmbient;\n#endif\n\n#ifdef HAS_BASECOLORMAP\nuniform sampler2D u_BaseColorSampler;\n#endif\n#ifdef HAS_NORMALMAP\nuniform sampler2D u_NormalSampler;\nuniform float u_NormalScale;\n#endif\n#ifdef HAS_EMISSIVEMAP\nuniform sampler2D u_EmissiveSampler;\nuniform vec3 u_EmissiveFactor;\n#endif\n#ifdef HAS_METALROUGHNESSMAP\nuniform sampler2D u_MetallicRoughnessSampler;\n#endif\n#ifdef HAS_OCCLUSIONMAP\nuniform sampler2D u_OcclusionSampler;\nuniform float u_OcclusionStrength;\n#endif\n\n#ifdef ALPHA_CUTOFF\nuniform float u_AlphaCutoff;\n#endif\n\nuniform vec2 u_MetallicRoughnessValues;\nuniform vec4 u_BaseColorFactor;\n\nuniform vec3 u_Camera;\n#ifdef PBR_DEBUG\nuniform vec4 u_ScaleDiffBaseMR;\nuniform vec4 u_ScaleFGDSpec;\n#endif\n\nvarying vec3 pbr_vPosition;\n\nvarying vec2 pbr_vUV;\n\n#ifdef HAS_NORMALS\n#ifdef HAS_TANGENTS\nvarying mat3 pbr_vTBN;\n#else\nvarying vec3 pbr_vNormal;\n#endif\n#endif\n\n\nstruct PBRInfo\n{\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float LdotH;\n  float VdotH;\n  float perceptualRoughness;\n  float metalness;\n  vec3 reflectance0;\n  vec3 reflectance90;\n  float alphaRoughness;\n  vec3 diffuseColor;\n  vec3 specularColor;\n  vec3 n;\n  vec3 v;\n};\n\nconst float M_PI = 3.141592653589793;\nconst float c_MinRoughness = 0.04;\n\nvec4 SRGBtoLINEAR(vec4 srgbIn)\n{\n#ifdef MANUAL_SRGB\n#ifdef SRGB_FAST_APPROXIMATION\n  vec3 linOut = pow(srgbIn.xyz,vec3(2.2));\n#else\n  vec3 bLess = step(vec3(0.04045),srgbIn.xyz);\n  vec3 linOut = mix( srgbIn.xyz/vec3(12.92), pow((srgbIn.xyz+vec3(0.055))/vec3(1.055),vec3(2.4)), bLess );\n#endif\n  return vec4(linOut,srgbIn.w);;\n#else\n  return srgbIn;\n#endif\n}\n\nvec3 getNormal()\n{\n#ifndef HAS_TANGENTS\n  vec3 pos_dx = dFdx(pbr_vPosition);\n  vec3 pos_dy = dFdy(pbr_vPosition);\n  vec3 tex_dx = dFdx(vec3(pbr_vUV, 0.0));\n  vec3 tex_dy = dFdy(vec3(pbr_vUV, 0.0));\n  vec3 t = (tex_dy.t * pos_dx - tex_dx.t * pos_dy) / (tex_dx.s * tex_dy.t - tex_dy.s * tex_dx.t);\n\n#ifdef HAS_NORMALS\n  vec3 ng = normalize(pbr_vNormal);\n#else\n  vec3 ng = cross(pos_dx, pos_dy);\n#endif\n\n  t = normalize(t - ng * dot(ng, t));\n  vec3 b = normalize(cross(ng, t));\n  mat3 tbn = mat3(t, b, ng);\n#else\n  mat3 tbn = pbr_vTBN;\n#endif\n\n#ifdef HAS_NORMALMAP\n  vec3 n = texture2D(u_NormalSampler, pbr_vUV).rgb;\n  n = normalize(tbn * ((2.0 * n - 1.0) * vec3(u_NormalScale, u_NormalScale, 1.0)));\n#else\n  vec3 n = normalize(tbn[2].xyz);\n#endif\n\n  return n;\n}\n\n\n#ifdef USE_IBL\nvec3 getIBLContribution(PBRInfo pbrInputs, vec3 n, vec3 reflection)\n{\n  float mipCount = 9.0;\n  float lod = (pbrInputs.perceptualRoughness * mipCount);\n  vec3 brdf = SRGBtoLINEAR(texture2D(u_brdfLUT,\n    vec2(pbrInputs.NdotV, 1.0 - pbrInputs.perceptualRoughness))).rgb;\n  vec3 diffuseLight = SRGBtoLINEAR(textureCube(u_DiffuseEnvSampler, n)).rgb;\n\n#ifdef USE_TEX_LOD\n  vec3 specularLight = SRGBtoLINEAR(textureCubeLod(u_SpecularEnvSampler, reflection, lod)).rgb;\n#else\n  vec3 specularLight = SRGBtoLINEAR(textureCube(u_SpecularEnvSampler, reflection)).rgb;\n#endif\n\n  vec3 diffuse = diffuseLight * pbrInputs.diffuseColor;\n  vec3 specular = specularLight * (pbrInputs.specularColor * brdf.x + brdf.y);\n  diffuse *= u_ScaleIBLAmbient.x;\n  specular *= u_ScaleIBLAmbient.y;\n\n  return diffuse + specular;\n}\n#endif\n\n\nvec3 diffuse(PBRInfo pbrInputs)\n{\n  return pbrInputs.diffuseColor / M_PI;\n}\n\nvec3 specularReflection(PBRInfo pbrInputs)\n{\n  return pbrInputs.reflectance0 +\n    (pbrInputs.reflectance90 - pbrInputs.reflectance0) *\n    pow(clamp(1.0 - pbrInputs.VdotH, 0.0, 1.0), 5.0);\n}\n\n\n\nfloat geometricOcclusion(PBRInfo pbrInputs)\n{\n  float NdotL = pbrInputs.NdotL;\n  float NdotV = pbrInputs.NdotV;\n  float r = pbrInputs.alphaRoughness;\n\n  float attenuationL = 2.0 * NdotL / (NdotL + sqrt(r * r + (1.0 - r * r) * (NdotL * NdotL)));\n  float attenuationV = 2.0 * NdotV / (NdotV + sqrt(r * r + (1.0 - r * r) * (NdotV * NdotV)));\n  return attenuationL * attenuationV;\n}\n\n\n\n\n\nfloat microfacetDistribution(PBRInfo pbrInputs)\n{\n  float roughnessSq = pbrInputs.alphaRoughness * pbrInputs.alphaRoughness;\n  float f = (pbrInputs.NdotH * roughnessSq - pbrInputs.NdotH) * pbrInputs.NdotH + 1.0;\n  return roughnessSq / (M_PI * f * f);\n}\n\nvoid PBRInfo_setAmbientLight(inout PBRInfo pbrInputs) {\n  pbrInputs.NdotL = 1.0;\n  pbrInputs.NdotH = 0.0;\n  pbrInputs.LdotH = 0.0;\n  pbrInputs.VdotH = 1.0;\n}\n\nvoid PBRInfo_setDirectionalLight(inout PBRInfo pbrInputs, vec3 lightDirection) {\n  vec3 n = pbrInputs.n;\n  vec3 v = pbrInputs.v;\n  vec3 l = normalize(lightDirection);\n  vec3 h = normalize(l+v);\n\n  pbrInputs.NdotL = clamp(dot(n, l), 0.001, 1.0);\n  pbrInputs.NdotH = clamp(dot(n, h), 0.0, 1.0);\n  pbrInputs.LdotH = clamp(dot(l, h), 0.0, 1.0);\n  pbrInputs.VdotH = clamp(dot(v, h), 0.0, 1.0);\n}\n\nvoid PBRInfo_setPointLight(inout PBRInfo pbrInputs, PointLight pointLight) {\n  vec3 light_direction = normalize(pointLight.position - pbr_vPosition);\n  PBRInfo_setDirectionalLight(pbrInputs, light_direction);\n}\n\nvec3 calculateFinalColor(PBRInfo pbrInputs, vec3 lightColor) {\n  vec3 F = specularReflection(pbrInputs);\n  float G = geometricOcclusion(pbrInputs);\n  float D = microfacetDistribution(pbrInputs);\n  vec3 diffuseContrib = (1.0 - F) * diffuse(pbrInputs);\n  vec3 specContrib = F * G * D / (4.0 * pbrInputs.NdotL * pbrInputs.NdotV);\n  return pbrInputs.NdotL * lightColor * (diffuseContrib + specContrib);\n}\n\nvec4 pbr_filterColor(vec4 colorUnused)\n{\n#ifdef HAS_BASECOLORMAP\n  vec4 baseColor = SRGBtoLINEAR(texture2D(u_BaseColorSampler, pbr_vUV)) * u_BaseColorFactor;\n#else\n  vec4 baseColor = u_BaseColorFactor;\n#endif\n\n#ifdef ALPHA_CUTOFF\n  if (baseColor.a < u_AlphaCutoff) {\n    discard;\n  }\n#endif\n\n  vec3 color = vec3(0, 0, 0);\n\n  if(pbr_uUnlit){\n    color.rgb = baseColor.rgb;\n  }\n  else{\n\n\n    float perceptualRoughness = u_MetallicRoughnessValues.y;\n    float metallic = u_MetallicRoughnessValues.x;\n#ifdef HAS_METALROUGHNESSMAP\n\n    vec4 mrSample = texture2D(u_MetallicRoughnessSampler, pbr_vUV);\n    perceptualRoughness = mrSample.g * perceptualRoughness;\n    metallic = mrSample.b * metallic;\n#endif\n    perceptualRoughness = clamp(perceptualRoughness, c_MinRoughness, 1.0);\n    metallic = clamp(metallic, 0.0, 1.0);\n\n    float alphaRoughness = perceptualRoughness * perceptualRoughness;\n\n    vec3 f0 = vec3(0.04);\n    vec3 diffuseColor = baseColor.rgb * (vec3(1.0) - f0);\n    diffuseColor *= 1.0 - metallic;\n    vec3 specularColor = mix(f0, baseColor.rgb, metallic);\n    float reflectance = max(max(specularColor.r, specularColor.g), specularColor.b);\n\n\n\n    float reflectance90 = clamp(reflectance * 25.0, 0.0, 1.0);\n    vec3 specularEnvironmentR0 = specularColor.rgb;\n    vec3 specularEnvironmentR90 = vec3(1.0, 1.0, 1.0) * reflectance90;\n\n    vec3 n = getNormal();\n    vec3 v = normalize(u_Camera - pbr_vPosition);\n\n    float NdotV = clamp(abs(dot(n, v)), 0.001, 1.0);\n    vec3 reflection = -normalize(reflect(v, n));\n\n    PBRInfo pbrInputs = PBRInfo(\n      0.0,\n      NdotV,\n      0.0,\n      0.0,\n      0.0,\n      perceptualRoughness,\n      metallic,\n      specularEnvironmentR0,\n      specularEnvironmentR90,\n      alphaRoughness,\n      diffuseColor,\n      specularColor,\n      n,\n      v\n    );\n\n#ifdef USE_LIGHTS\n    PBRInfo_setAmbientLight(pbrInputs);\n    color += calculateFinalColor(pbrInputs, lighting_uAmbientLight.color);\n    SMART_FOR(int i = 0, i < MAX_LIGHTS, i < lighting_uDirectionalLightCount, i++) {\n      if (i < lighting_uDirectionalLightCount) {\n        PBRInfo_setDirectionalLight(pbrInputs, lighting_uDirectionalLight[i].direction);\n        color += calculateFinalColor(pbrInputs, lighting_uDirectionalLight[i].color);\n      }\n    }\n    SMART_FOR(int i = 0, i < MAX_LIGHTS, i < lighting_uPointLightCount, i++) {\n      if (i < lighting_uPointLightCount) {\n        PBRInfo_setPointLight(pbrInputs, lighting_uPointLight[i]);\n        float attenuation = getPointLightAttenuation(lighting_uPointLight[i], distance(lighting_uPointLight[i].position, pbr_vPosition));\n        color += calculateFinalColor(pbrInputs, lighting_uPointLight[i].color / attenuation);\n      }\n    }\n#endif\n#ifdef USE_IBL\n    color += getIBLContribution(pbrInputs, n, reflection);\n#endif\n#ifdef HAS_OCCLUSIONMAP\n    float ao = texture2D(u_OcclusionSampler, pbr_vUV).r;\n    color = mix(color, color * ao, u_OcclusionStrength);\n#endif\n\n#ifdef HAS_EMISSIVEMAP\n    vec3 emissive = SRGBtoLINEAR(texture2D(u_EmissiveSampler, pbr_vUV)).rgb * u_EmissiveFactor;\n    color += emissive;\n#endif\n\n#ifdef PBR_DEBUG\n\n\n\n\n\n    color = mix(color, baseColor.rgb, u_ScaleDiffBaseMR.y);\n    color = mix(color, vec3(metallic), u_ScaleDiffBaseMR.z);\n    color = mix(color, vec3(perceptualRoughness), u_ScaleDiffBaseMR.w);\n#endif\n\n  }\n\n  return vec4(pow(color,vec3(1.0/2.2)), baseColor.a);\n}\n";const pbr={name:"pbr",vs:vs$e,fs:fs$d,defines:{LIGHTING_FRAGMENT:1},dependencies:[lights]},vs$d="attribute float transform_elementID;\nvec2 transform_getPixelSizeHalf(vec2 size) {\n  return vec2(1.) / (2. * size);\n}\n\nvec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {\n  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);\n  float xIndex = transform_elementID - (yIndex * texSize[0]);\n  return vec2(xIndex, yIndex);\n}\nvec2 transform_getTexCoord(vec2 size) {\n  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);\n  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);\n  vec2 coord = indices / size + pixelSizeHalf;\n  return coord;\n}\nvec2 transform_getPos(vec2 size) {\n  vec2 texCoord = transform_getTexCoord(size);\n  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);\n  return pos;\n}\nvec4 transform_getInput(sampler2D texSampler, vec2 size) {\n  vec2 texCoord = transform_getTexCoord(size);\n  vec4 textureColor = texture2D(texSampler, texCoord);\n  return textureColor;\n}\n",transform={name:"transform",vs:vs$d,fs:null};class ProgramManager{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new ProgramManager(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find((t=>t.name===e.name))||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){const t="string"==typeof e?e:e.name;this._defaultModules=this._defaultModules.filter((e=>e.name!==t)),this.stateHash++}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{vs:t="",fs:i="",defines:n={},inject:r={},varyings:o=[],bufferMode:s=35981,transpileToGLSL100:a=!1}=e,l=this._getModuleList(e.modules),c=this._getHash(t),u=this._getHash(i),h=l.map((e=>this._getHash(e.name))).sort(),d=o.map((e=>this._getHash(e))),p=Object.keys(n).sort(),f=Object.keys(r).sort(),m=[],g=[];for(const e of p)m.push(this._getHash(e)),m.push(this._getHash(n[e]));for(const e of f)g.push(this._getHash(e)),g.push(this._getHash(r[e]));const _="".concat(c,"/").concat(u,"D").concat(m.join("/"),"M").concat(h.join("/"),"I").concat(g.join("/"),"V").concat(d.join("/"),"H").concat(this.stateHash,"B").concat(s).concat(a?"T":"");if(!this._programCache[_]){const e=assembleShaders(this.gl,{vs:t,fs:i,modules:l,inject:r,defines:n,hookFunctions:this._hookFunctions,transpileToGLSL100:a});this._programCache[_]=new Program(this.gl,{hash:_,vs:e.vs,fs:e.fs,varyings:o,bufferMode:s}),this._getUniforms[_]=e.getUniforms||(e=>{}),this._useCounts[_]=0}return this._useCounts[_]++,this._programCache[_]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){const t=e.hash;this._useCounts[t]--,0===this._useCounts[t]&&(this._programCache[t].delete(),delete this._programCache[t],delete this._getUniforms[t],delete this._useCounts[t])}_getHash(e){return void 0===this._hashes[e]&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const t=new Array(this._defaultModules.length+e.length),i={};let n=0;for(let e=0,r=this._defaultModules.length;e<r;++e){const r=this._defaultModules[e],o=r.name;t[n++]=r,i[o]=!0}for(let r=0,o=e.length;r<o;++r){const o=e[r],s=o.name;i[s]||(t[n++]=o,i[s]=!0)}return t.length=n,t}}const GLTF_TO_LUMA_ATTRIBUTE_MAP={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function getBuffersFromGeometry(e,t,i){const n={};let r=t.indices;for(const i in t.attributes){const o=t.attributes[i],s=mapAttributeName(i);if("indices"===i)r=o;else if(o.constant)n[s]=o.value;else{const t=o.value,r={...o};delete r.value,n[s]=[new Buffer(e,t),r],inferAttributeAccessor(i,r)}}if(r){const t=r.value||r;assert$8(t instanceof Uint16Array||t instanceof Uint32Array,'attribute array for "indices" must be of integer type');const i={size:1,isIndexed:void 0===r.isIndexed||r.isIndexed};n.indices=[new Buffer(e,{data:t,target:34963}),i]}return n}function mapAttributeName(e,t){const{attributeMap:i=GLTF_TO_LUMA_ATTRIBUTE_MAP}={};return i&&i[e]||e}function inferAttributeAccessor(e,t){let i;switch(e){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":i="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":i="vectors"}switch(i){case"vectors":t.size=t.size||3;break;case"uvs":t.size=t.size||2}assert$8(Number.isFinite(t.size),"attribute ".concat(e," needs size"))}const LOG_DRAW_PRIORITY=2,LOG_DRAW_TIMEOUT=1e4,ERR_MODEL_PARAMS="Model needs drawMode and vertexCount",NOOP=()=>{},DRAW_PARAMS={};class Model{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{id:i=uid("model")}=t;assert$8(isWebGL(e)),this.id=i,this.gl=e,this.id=t.id||uid("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(t)}initialize(e){this.props={},this.programManager=e.programManager||ProgramManager.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;const{program:t=null,vs:i,fs:n,modules:r,defines:o,inject:s,varyings:a,bufferMode:l,transpileToGLSL100:c}=e;this.programProps={program:t,vs:i,fs:n,modules:r,defines:o,inject:s,varyings:a,bufferMode:l,transpileToGLSL100:c},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=void 0!==e.drawMode?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},assert$8(void 0!==this.drawMode&&Number.isFinite(this.vertexCount),ERR_MODEL_PARAMS)}setProps(e){this._setModelProps(e)}delete(){for(const e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){const{program:t,vs:i,fs:n,modules:r,defines:o,inject:s,varyings:a,bufferMode:l,transpileToGLSL100:c}=e;this.programProps={program:t,vs:i,fs:n,modules:r,defines:o,inject:s,varyings:a,bufferMode:l,transpileToGLSL100:c},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return assert$8(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return assert$8(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=getBuffersFromGeometry(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(isObjectEmpty(e))return this;const t={};for(const i in e){const n=e[i];t[i]=n.getValue?n.getValue():n}return this.vertexArray.setAttributes(t),this}setUniforms(){return Object.assign(this.uniforms,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),this}getModuleUniforms(e){this._checkProgram();const t=this.programManager.getUniforms(this.program);return t?t(e):{}}updateModuleSettings(e){const t=this.getModuleUniforms(e||{});return this.setUniforms(t)}clear(e){return clear(this.program.gl,e),this}draw(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._checkProgram();const{moduleSettings:t=null,framebuffer:i,uniforms:n={},attributes:r={},transformFeedback:o=this.transformFeedback,parameters:s={},vertexArray:a=this.vertexArray}=e;let l;this.setAttributes(r),this.updateModuleSettings(t),this.setUniforms(n),log$2.priority>=LOG_DRAW_PRIORITY&&(l=this._logDrawCallStart(LOG_DRAW_PRIORITY));const c=this.vertexArray.getDrawParams(),{isIndexed:u=c.isIndexed,indexType:h=c.indexType,indexOffset:d=c.indexOffset,vertexArrayInstanced:p=c.isInstanced}=this.props;p&&!this.isInstanced&&log$2.warn("Found instanced attributes on non-instanced model",this.id)();const{isInstanced:f,instanceCount:m}=this,{onBeforeRender:g=NOOP,onAfterRender:_=NOOP}=this.props;g(),this.program.setUniforms(this.uniforms);const y=this.program.draw(Object.assign(DRAW_PARAMS,e,{logPriority:l,uniforms:null,framebuffer:i,parameters:s,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:a,transformFeedback:o,isIndexed:u,indexType:h,isInstanced:f,instanceCount:m,offset:u?d:0}));return _(),log$2.priority>=LOG_DRAW_PRIORITY&&this._logDrawCallEnd(l,a,i),y}transform(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{discard:t=!0,feedbackBuffers:i,unbindModels:n=[]}=e;let{parameters:r}=e;i&&this._setFeedbackBuffers(i),t&&(r=Object.assign({},r,{35977:t})),n.forEach((e=>e.vertexArray.unbindBuffers()));try{this.draw(Object.assign({},e,{parameters:r}))}finally{n.forEach((e=>e.vertexArray.bindBuffers()))}return this}render(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return log$2.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:e}=this.programProps;if(e)this._managedProgram=!1;else{const{vs:t,fs:i,modules:n,inject:r,defines:o,varyings:s,bufferMode:a,transpileToGLSL100:l}=this.programProps;e=this.programManager.get({vs:t,fs:i,modules:n,inject:r,defines:o,varyings:s,bufferMode:a,transpileToGLSL100:l}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}assert$8(e instanceof Program,"Model needs a program"),this._programDirty=!1,e!==this.program&&(this.program=e,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new VertexArray(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(const e in this.geometryBuffers){const t=this.geometryBuffers[e][0]||this.geometryBuffers[e];t instanceof Buffer&&t.delete()}}_setAnimationProps(e){this.animated&&assert$8(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(isObjectEmpty(e))return this;const{gl:t}=this.program;return this.transformFeedback=this.transformFeedback||new TransformFeedback(t,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){const t=e>3?0:LOG_DRAW_TIMEOUT;if(!(Date.now()-this.lastLogTime<t))return this.lastLogTime=Date.now(),log$2.group(LOG_DRAW_PRIORITY,">>> DRAWING MODEL ".concat(this.id),{collapsed:log$2.level<=2})(),e}_logDrawCallEnd(e,t,i,n){if(void 0===e)return;const r=getDebugTableForVertexArray({vertexArray:t,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:o,unusedTable:s,unusedCount:a}=getDebugTableForUniforms({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i)}),{table:l,count:c}=getDebugTableForUniforms({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i),undefinedOnly:!0});c>0&&log$2.log("MISSING UNIFORMS",Object.keys(l))(),a>0&&log$2.log("UNUSED UNIFORMS",Object.keys(s))();const u=getDebugTableForProgramConfiguration(this.vertexArray.configuration);log$2.table(e,r)(),log$2.table(e,o)(),log$2.table(e+1,u)(),n&&n.log({logLevel:LOG_DRAW_PRIORITY,message:"Rendered to ".concat(n.id)}),log$2.groupEnd(LOG_DRAW_PRIORITY)()}}class BufferTransform{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}setupResources(e){for(const t of this.bindings)this._setupTransformFeedback(t,e)}updateModelProps(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{varyings:t}=this;return t.length>0&&(e=Object.assign({},e,{varyings:t})),e}getDrawOptions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this.bindings[this.currentIndex],{sourceBuffers:i,transformFeedback:n}=t;return{attributes:Object.assign({},i,e.attributes),transformFeedback:n}}swap(){return!!this.feedbackMap&&(this.currentIndex=this._getNextIndex(),!0)}update(){this._setupBuffers(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}getBuffer(e){const{feedbackBuffers:t}=this.bindings[this.currentIndex],i=e?t[e]:null;return i?i instanceof Buffer?i:i.buffer:null}getData(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{varyingName:t}=e,i=this.getBuffer(t);return i?i.getData():null}delete(){for(const e in this.resources)this.resources[e].delete()}_initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&assert$8(isWebGL2$1(this.gl))}_getFeedbackBuffers(e){const{sourceBuffers:t={}}=e,i={};if(this.bindings[this.currentIndex]&&Object.assign(i,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(const e in this.feedbackMap){e in t&&(i[this.feedbackMap[e]]=e)}Object.assign(i,e.feedbackBuffers);for(const e in i){const n=i[e];if("string"==typeof n){const r=t[n],{byteLength:o,usage:s,accessor:a}=r;i[e]=this._createNewBuffer(e,{byteLength:o,usage:s,accessor:a})}}return i}_setupBuffers(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:t=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);const i=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:t,feedbackBuffers:i})}_setupTransformFeedback(e,t){let{model:i}=t;const{program:n}=i;e.transformFeedback=new TransformFeedback(this.gl,{program:n,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){const{sourceBuffers:e,feedbackBuffers:t}=this._swapBuffers(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceBuffers:e,feedbackBuffers:t})}}_updateBinding(e,t){return e?(Object.assign(e.sourceBuffers,t.sourceBuffers),Object.assign(e.feedbackBuffers,t.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},t.sourceBuffers),feedbackBuffers:Object.assign({},t.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;const t=Object.assign({},e.sourceBuffers),i=Object.assign({},e.feedbackBuffers);for(const n in this.feedbackMap){const r=this.feedbackMap[n];t[n]=e.feedbackBuffers[r],i[r]=e.sourceBuffers[n],assert$8(i[r]instanceof Buffer)}return{sourceBuffers:t,feedbackBuffers:i}}_createNewBuffer(e,t){const i=new Buffer(this.gl,t);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=i,i}_getNextIndex(){return(this.currentIndex+1)%2}}const SAMPLER_UNIFORM_PREFIX="transform_uSampler_",SIZE_UNIFORM_PREFIX="transform_uSize_",VS_POS_VARIABLE="transform_position";function updateForTextures(e){let{vs:t,sourceTextureMap:i,targetTextureVarying:n,targetTexture:r}=e;let o=Object.keys(i).length,s=null;const a={};let l=t,c={};if(o>0||n){const e=l.split("\n"),t=e.slice();if(e.forEach(((e,r,l)=>{if(o>0){const n=processAttributeDefinition(e,i);if(n){const{updatedLine:e,inject:i}=n;t[r]=e,c=combineInjects([c,i]),Object.assign(a,n.samplerTextureMap),o--}}n&&!s&&(s=getVaryingType(e,n))})),n){assert$8(r);const e="".concat(SIZE_UNIFORM_PREFIX).concat(n),t="uniform vec2 ".concat(e,";\n"),i="     vec2 ".concat(VS_POS_VARIABLE," = transform_getPos(").concat(e,");\n     gl_Position = vec4(").concat(VS_POS_VARIABLE,", 0, 1.);\n");c=combineInjects([c,{"vs:#decl":t,"vs:#main-start":i}])}l=t.join("\n")}return{vs:l,targetTextureType:s,inject:c,samplerTextureMap:a}}function getSizeUniforms(e){let{sourceTextureMap:t,targetTextureVarying:i,targetTexture:n}=e;const r={};let o,s;i&&(({width:o,height:s}=n),r["".concat(SIZE_UNIFORM_PREFIX).concat(i)]=[o,s]);for(const e in t)({width:o,height:s}=t[e]),r["".concat(SIZE_UNIFORM_PREFIX).concat(e)]=[o,s];return r}function getAttributeDefinition(e){return getQualifierDetails(e,["attribute","in"])}function getSamplerDeclerations(e){const t="".concat(SAMPLER_UNIFORM_PREFIX).concat(e),i="".concat(SIZE_UNIFORM_PREFIX).concat(e);return{samplerName:t,sizeName:i,uniformDeclerations:"  uniform sampler2D ".concat(t,";\n  uniform vec2 ").concat(i,";")}}function getVaryingType(e,t){const i=getQualifierDetails(e,["varying","out"]);return i&&i.name===t?i.type:null}function processAttributeDefinition(e,t){const i={},n=getAttributeDefinition(e);if(!n)return null;const{type:r,name:o}=n;if(o&&t[o]){const t="// ".concat(e," => Replaced by Transform with a sampler"),{samplerName:n,sizeName:s,uniformDeclerations:a}=getSamplerDeclerations(o),l=typeToChannelSuffix(r),c="  ".concat(r," ").concat(o," = transform_getInput(").concat(n,", ").concat(s,").").concat(l,";\n");i[n]=o;return{updatedLine:t,inject:{"vs:#decl":a,"vs:#main-start":c},samplerTextureMap:i}}return null}const SRC_TEX_PARAMETER_OVERRIDES={10241:9728,10240:9728,10242:33071,10243:33071},FS_OUTPUT_VARIABLE="transform_output";class TextureTransform{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}updateModelProps(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this._processVertexShader(e);return Object.assign({},e,t)}getDrawOptions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:t,sourceTextures:i,framebuffer:n,targetTexture:r}=this.bindings[this.currentIndex],o=Object.assign({},t,e.attributes),s=Object.assign({},e.uniforms),a=Object.assign({},e.parameters);let l=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){o.transform_elementID=this.elementIDBuffer;for(const e in this.samplerTextureMap){s[e]=i[this.samplerTextureMap[e]]}this._setSourceTextureParameters();const e=getSizeUniforms({sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:r});Object.assign(s,e)}return this.hasTargetTexture&&(l=!1,a.viewport=[0,0,n.width,n.height]),{attributes:o,framebuffer:n,uniforms:s,discard:l,parameters:a}}swap(){return!!this._swapTexture&&(this.currentIndex=this._getNextIndex(),!0)}update(){this._setupTextures(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}getTargetTexture(){const{targetTexture:e}=this.bindings[this.currentIndex];return e}getData(){let{packed:e=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{framebuffer:t}=this.bindings[this.currentIndex],i=readPixelsToArray(t);if(!e)return i;const n=i.constructor,r=typeToChannelCount(this.targetTextureType),o=new n(i.length*r/4);let s=0;for(let e=0;e<i.length;e+=4)for(let t=0;t<r;t++)o[s++]=i[e+t];return o}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{_targetTextureVarying:t,_swapTexture:i}=e;this._swapTexture=i,this.targetTextureVarying=t,this.hasTargetTexture=t,this._setupTextures(e)}_createTargetTexture(e){const{sourceTextures:t,textureOrReference:i}=e;if(i instanceof Texture2D)return i;const n=t[i];return n?(this._targetRefTexName=i,this._createNewTexture(n)):null}_setupTextures(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:t,_sourceTextures:i={},_targetTexture:n}=e,r=this._createTargetTexture({sourceTextures:i,textureOrReference:n});this.hasSourceTextures=this.hasSourceTextures||i&&Object.keys(i).length>0,this._updateBindings({sourceBuffers:t,sourceTextures:i,targetTexture:r}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if("number"!=typeof e||this.elementCount>=e)return;const t=new Float32Array(e);t.forEach(((e,t,i)=>{i[t]=t})),this.elementIDBuffer?this.elementIDBuffer.setData({data:t}):this.elementIDBuffer=new Buffer(this.gl,{data:t,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){const{sourceTextures:e,targetTexture:t}=this._swapTextures(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceTextures:e,targetTexture:t})}}_updateBinding(e,t){const{sourceBuffers:i,sourceTextures:n,targetTexture:r}=t;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,n),Object.assign(e.sourceBuffers,i),r){e.targetTexture=r;const{width:t,height:i}=r,{framebuffer:n}=e;n?(n.update({attachments:{36064:r},resizeAttachments:!1}),n.resize({width:t,height:i})):e.framebuffer=new Framebuffer(this.gl,{id:"transform-framebuffer",width:t,height:i,attachments:{36064:r}})}return e}_setSourceTextureParameters(){const e=this.currentIndex,{sourceTextures:t}=this.bindings[e];for(const e in t)t[e].setParameters(SRC_TEX_PARAMETER_OVERRIDES)}_swapTextures(e){if(!this._swapTexture)return null;const t=Object.assign({},e.sourceTextures);t[this._swapTexture]=e.targetTexture;return{sourceTextures:t,targetTexture:e.sourceTextures[this._swapTexture]}}_createNewTexture(e){const t=cloneTextureFrom(e,{parameters:{10241:9728,10240:9728,10242:33071,10243:33071},pixelStore:{37440:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=t,t}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceTextures:t,targetTexture:i}=this.bindings[this.currentIndex],{vs:n,uniforms:r,targetTextureType:o,inject:s,samplerTextureMap:a}=updateForTextures({vs:e.vs,sourceTextureMap:t,targetTextureVarying:this.targetTextureVarying,targetTexture:i}),l=combineInjects([e.inject||{},s]);this.targetTextureType=o,this.samplerTextureMap=a;return{vs:n,fs:e._fs||getPassthroughFS({version:getShaderVersion(n),input:this.targetTextureVarying,inputType:o,output:FS_OUTPUT_VARIABLE}),modules:this.hasSourceTextures||this.targetTextureVarying?[transform].concat(e.modules||[]):e.modules,uniforms:r,inject:l}}}class Transform{static isSupported(e){return isWebGL2$1(e)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(t),Object.seal(this)}delete(){const{model:e,bufferTransform:t,textureTransform:i}=this;e&&e.delete(),t&&t.delete(),i&&i.delete()}run(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{clearRenderTarget:t=!0}=e,i=this._updateDrawOptions(e);t&&i.framebuffer&&i.framebuffer.clear({color:!0}),this.model.transform(i)}swap(){let e=!1;const t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of t)e=e||i.swap();assert$8(e,"Nothing to swap")}getBuffer(){return this.bufferTransform&&this.bufferTransform.getBuffer(arguments.length>0&&void 0!==arguments[0]?arguments[0]:null)}getData(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of t){const t=i.getData(e);if(t)return t}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"elementCount"in e&&this.model.setVertexCount(e.elementCount);const t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of t)i.update(e)}_initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{gl:t}=this;this._buildResourceTransforms(t,e),e=this._updateModelProps(e),this.model=new Model(t,Object.assign({},e,{fs:e.fs||getPassthroughFS({version:getShaderVersion(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let t=Object.assign({},e);const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const e of i)t=e.updateModelProps(t);return t}_buildResourceTransforms(e,t){canCreateBufferTransform(t)&&(this.bufferTransform=new BufferTransform(e,t)),canCreateTextureTransform(t)&&(this.textureTransform=new TextureTransform(e,t)),assert$8(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let t=Object.assign({},e);const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const e of i)t=Object.assign(t,e.getDrawOptions(t));return t}}function canCreateBufferTransform(e){return!(isObjectEmpty(e.feedbackBuffers)&&isObjectEmpty(e.feedbackMap)&&!(e.varyings&&e.varyings.length>0))}function canCreateTextureTransform(e){return!(isObjectEmpty(e._sourceTextures)&&!e._targetTexture&&!e._targetTextureVarying)}const DRAW_MODE={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class Geometry{static get DRAW_MODE(){return DRAW_MODE}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{id:t=uid("geometry"),drawMode:i=DRAW_MODE.TRIANGLES,attributes:n={},indices:r=null,vertexCount:o=null}=e;this.id=t,this.drawMode=0|i,this.attributes={},this.userData={},this._setAttributes(n,r),this.vertexCount=o||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return"Geometry ".concat(this.id," attribute ").concat(e)}_setAttributes(e,t){t&&(this.indices=ArrayBuffer.isView(t)?{value:t,size:1}:t);for(const t in e){let i=e[t];i=ArrayBuffer.isView(i)?{value:i}:i,assert$8(ArrayBuffer.isView(i.value),"".concat(this._print(t),": must be typed array or object with value as typed array")),"POSITION"!==t&&"positions"!==t||i.size||(i.size=3),"indices"===t?(assert$8(!this.indices),this.indices=i):this.attributes[t]=i}return this.indices&&void 0!==this.indices.isIndexed&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(const t in e){const n=e[t],{value:r,size:o,constant:s}=n;!s&&r&&o>=1&&(i=Math.min(i,r.length/o))}return assert$8(Number.isFinite(i)),i}}let channelHandles=1,animationHandles=1;class Timeline{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(e){const{delay:t=0,duration:i=Number.POSITIVE_INFINITY,rate:n=1,repeat:r=1}=e,o=channelHandles++,s={time:0,delay:t,duration:i,rate:n,repeat:r};return this._setChannelTime(s,this.time),this.channels.set(o,s),o}removeChannel(e){this.channels.delete(e);for(const[t,i]of this.animations)i.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return void 0!==t&&this.time>=t.delay+t.duration*t.repeat}getTime(e){if(void 0===e)return this.time;const t=this.channels.get(e);return void 0===t?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const e of t)this._setChannelTime(e,this.time);const i=this.animations.values();for(const e of i){const{animation:t,channel:i}=e;t.setTime(this.getTime(i))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const i=animationHandles++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(-1===this.lastEngineTime&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const i=t-e.delay;i>=e.duration*e.repeat?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}}const DEFAULT_LIGHT_COLOR$1=[255,255,255],DEFAULT_LIGHT_INTENSITY$1=1;let idCount$1=0,AmbientLight$1=class{constructor(e={}){_defineProperty(this,"id",void 0),_defineProperty(this,"color",void 0),_defineProperty(this,"intensity",void 0),_defineProperty(this,"type","ambient");const{color:t=DEFAULT_LIGHT_COLOR$1}=e,{intensity:i=DEFAULT_LIGHT_INTENSITY$1}=e;this.id=e.id||"ambient-".concat(idCount$1++),this.color=t,this.intensity=i}};const DEFAULT_LIGHT_COLOR=[255,255,255],DEFAULT_LIGHT_INTENSITY=1,DEFAULT_LIGHT_DIRECTION=[0,0,-1];let idCount=0,DirectionalLight$1=class{constructor(e={}){_defineProperty(this,"id",void 0),_defineProperty(this,"color",void 0),_defineProperty(this,"intensity",void 0),_defineProperty(this,"type","directional"),_defineProperty(this,"direction",void 0),_defineProperty(this,"shadow",void 0);const{color:t=DEFAULT_LIGHT_COLOR}=e,{intensity:i=DEFAULT_LIGHT_INTENSITY}=e,{direction:n=DEFAULT_LIGHT_DIRECTION}=e,{_shadow:r=!1}=e;this.id=e.id||"directional-".concat(idCount++),this.color=t,this.intensity=i,this.type="directional",this.direction=new Vector3$1(n).normalize().toArray(),this.shadow=r}getProjectedLight(e){return this}};class Pass{constructor(e,t={id:"pass"}){_defineProperty(this,"id",void 0),_defineProperty(this,"gl",void 0),_defineProperty(this,"props",void 0);const{id:i}=t;this.id=i,this.gl=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class LayersPass extends Pass{constructor(...e){super(...e),_defineProperty(this,"_lastRenderIndex",-1)}render(e){return setParameters(this.gl,{framebuffer:e.target}),this._drawLayers(e)}_drawLayers(e){const{target:t,moduleParameters:i,viewports:n,views:r,onViewportActive:o,clearStack:s=!0,clearCanvas:a=!0}=e;e.pass=e.pass||"unknown";const l=this.gl;a&&clearGLCanvas(l,t),s&&(this._lastRenderIndex=-1);const c=[];for(const s of n){const n=r&&r[s.id];null==o||o(s);const a=this._getDrawLayerParams(s,e),u=s.subViewports||[s];for(const r of u){const o=this._drawLayersInViewport(l,{target:t,moduleParameters:i,viewport:r,view:n,pass:e.pass,layers:e.layers},a);c.push(o)}}return c}_getDrawLayerParams(e,{layers:t,pass:i,isPicking:n=!1,layerFilter:r,cullRect:o,effects:s,moduleParameters:a},l=!1){const c=[],u=layerIndexResolver(this._lastRenderIndex+1),h={layer:t[0],viewport:e,isPicking:n,renderPass:i,cullRect:o},d={};for(let n=0;n<t.length;n++){const o=t[n],p=this._shouldDrawLayer(o,h,r,d),f={shouldDrawLayer:p};p&&!l&&(f.layerRenderIndex=u(o,p),f.moduleParameters=this._getModuleParameters(o,s,i,a),f.layerParameters=this.getLayerParameters(o,n,e)),c[n]=f}return c}_drawLayersInViewport(e,{layers:t,moduleParameters:i,pass:n,target:r,viewport:o,view:s},a){const l=getGLViewport(e,{moduleParameters:i,target:r,viewport:o});if(s&&s.props.clear){const t=!0===s.props.clear?{color:!0,depth:!0}:s.props.clear;withParameters(e,{scissorTest:!0,scissor:l},(()=>clear(e,t)))}const c={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};setParameters(e,{viewport:l});for(let e=0;e<t.length;e++){const i=t[e],{shouldDrawLayer:r,layerRenderIndex:s,moduleParameters:l,layerParameters:u}=a[e];if(r&&i.props.pickable&&c.pickableCount++,i.isComposite)c.compositeCount++;else if(r){c.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,s),l.viewport=o;try{i._drawLayer({moduleParameters:l,uniforms:{layerIndex:s},parameters:u})}catch(e){i.raiseError(e,"drawing ".concat(i," to ").concat(n))}}}return c}shouldDrawLayer(e){return!0}getModuleParameters(e,t){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,n){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let r=e.parent;for(;r;){if(!r.props.visible||!r.filterSubLayer(t))return!1;t.layer=r,r=r.parent}if(i){const e=t.layer.id;if(e in n||(n[e]=i(t)),!n[e])return!1}return e.activateViewport(t.viewport),!0}_getModuleParameters(e,t,i,n){var r;const o=Object.assign(Object.create((null===(r=e.internalState)||void 0===r?void 0:r.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,pickingActive:0,devicePixelRatio:cssToDeviceRatio(this.gl)});if(t)for(const i of t){var s;Object.assign(o,null===(s=i.getModuleParameters)||void 0===s?void 0:s.call(i,e))}return Object.assign(o,this.getModuleParameters(e,t),n)}}function layerIndexResolver(e=0,t={}){const i={},n=(r,o)=>{const s=r.props._offset,a=r.id,l=r.parent&&r.parent.id;let c;if(l&&!(l in t)&&n(r.parent,!1),l in i){const e=i[l]=i[l]||layerIndexResolver(t[l],t);c=e(r,o),i[a]=e}else Number.isFinite(s)?(c=s+(t[l]||0),i[a]=null):c=e;return o&&c>=e&&(e=c+1),t[a]=c,c};return n}function getGLViewport(e,{moduleParameters:t,target:i,viewport:n}){const r=i&&"default-framebuffer"!==i.id,o=t&&t.devicePixelRatio||cssToDeviceRatio(e);return[n.x*o,(r?i.height:e.drawingBufferHeight)-(n.y+n.height)*o,n.width*o,n.height*o]}function clearGLCanvas(e,t){setParameters(e,{viewport:[0,0,t?t.width:e.drawingBufferWidth,t?t.height:e.drawingBufferHeight]}),e.clear(16640)}class ShadowPass extends LayersPass{constructor(e,t){super(e,t),_defineProperty(this,"shadowMap",void 0),_defineProperty(this,"depthBuffer",void 0),_defineProperty(this,"fbo",void 0),this.shadowMap=new Texture2D(e,{width:1,height:1,parameters:{10241:9729,10240:9729,10242:33071,10243:33071}}),this.depthBuffer=new Renderbuffer(e,{format:33189,width:1,height:1}),this.fbo=new Framebuffer(e,{id:"shadowmap",width:1,height:1,attachments:{36064:this.shadowMap,36096:this.depthBuffer}})}render(e){const t=this.fbo;withParameters(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},(()=>{const i=e.viewports[0],n=cssToDeviceRatio(this.gl),r=i.width*n,o=i.height*n;r===t.width&&o===t.height||t.resize({width:r,height:o}),super.render({...e,target:t,pass:"shadow"})}))}shouldDrawLayer(e){return!1!==e.props.shadowEnabled}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}}const defines="#define SMOOTH_EDGE_RADIUS 0.5",vs$c="\n".concat(defines,"\n\nstruct VertexGeometry {\n  vec4 position;\n  vec3 worldPosition;\n  vec3 worldPositionAlt;\n  vec3 normal;\n  vec2 uv;\n  vec3 pickingColor;\n} geometry = VertexGeometry(\n  vec4(0.0, 0.0, 1.0, 0.0),\n  vec3(0.0),\n  vec3(0.0),\n  vec3(0.0),\n  vec2(0.0),\n  vec3(0.0)\n);\n"),fs$c="\n".concat(defines,"\n\nstruct FragmentGeometry {\n  vec2 uv;\n} geometry;\n\nfloat smoothedge(float edge, float x) {\n  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);\n}\n");var geometry={name:"geometry",vs:vs$c,fs:fs$c};const COORDINATE_SYSTEM_GLSL_CONSTANTS=Object.keys(COORDINATE_SYSTEM).map((e=>"const int COORDINATE_SYSTEM_".concat(e," = ").concat(COORDINATE_SYSTEM[e],";"))).join(""),PROJECTION_MODE_GLSL_CONSTANTS=Object.keys(PROJECTION_MODE).map((e=>"const int PROJECTION_MODE_".concat(e," = ").concat(PROJECTION_MODE[e],";"))).join(""),UNIT_GLSL_CONSTANTS=Object.keys(UNIT).map((e=>"const int UNIT_".concat(e.toUpperCase()," = ").concat(UNIT[e],";"))).join("");var projectShader="".concat(COORDINATE_SYSTEM_GLSL_CONSTANTS,"\n").concat(PROJECTION_MODE_GLSL_CONSTANTS,"\n").concat(UNIT_GLSL_CONSTANTS,"\n\nuniform int project_uCoordinateSystem;\nuniform int project_uProjectionMode;\nuniform float project_uScale;\nuniform bool project_uWrapLongitude;\nuniform vec3 project_uCommonUnitsPerMeter;\nuniform vec3 project_uCommonUnitsPerWorldUnit;\nuniform vec3 project_uCommonUnitsPerWorldUnit2;\nuniform vec4 project_uCenter;\nuniform mat4 project_uModelMatrix;\nuniform mat4 project_uViewProjectionMatrix;\nuniform vec2 project_uViewportSize;\nuniform float project_uDevicePixelRatio;\nuniform float project_uFocalDistance;\nuniform vec3 project_uCameraPosition;\nuniform vec3 project_uCoordinateOrigin;\nuniform vec3 project_uCommonOrigin;\nuniform bool project_uPseudoMeters;\n\nconst float TILE_SIZE = 512.0;\nconst float PI = 3.1415926536;\nconst float WORLD_SCALE = TILE_SIZE / (PI * 2.0);\nconst vec3 ZERO_64_LOW = vec3(0.0);\nconst float EARTH_RADIUS = 6370972.0;\nconst float GLOBE_RADIUS = 256.0;\nfloat project_size_at_latitude(float lat) {\n  float y = clamp(lat, -89.9, 89.9);\n  return 1.0 / cos(radians(y));\n}\n\nfloat project_size() {\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&\n    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&\n    project_uPseudoMeters == false) {\n    \n    if (geometry.position.w == 0.0) {\n      return project_size_at_latitude(geometry.worldPosition.y);\n    }\n  \n    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;\n    float y2 = y * y;\n    float y4 = y2 * y2;\n    float y6 = y4 * y2;\n    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;\n  }\n  return 1.0;\n}\n\nfloat project_size_at_latitude(float meters, float lat) {\n  return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);\n}\nfloat project_size(float meters) {\n  return meters * project_uCommonUnitsPerMeter.z * project_size();\n}\n\nvec2 project_size(vec2 meters) {\n  return meters * project_uCommonUnitsPerMeter.xy * project_size();\n}\n\nvec3 project_size(vec3 meters) {\n  return meters * project_uCommonUnitsPerMeter * project_size();\n}\n\nvec4 project_size(vec4 meters) {\n  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);\n}\nmat3 project_get_orientation_matrix(vec3 up) {\n  vec3 uz = normalize(up);\n  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));\n  vec3 uy = cross(uz, ux);\n  return mat3(ux, uy, uz);\n}\n\nbool project_needs_rotation(vec3 commonPosition, out mat3 transform) {\n  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {\n    transform = project_get_orientation_matrix(commonPosition);\n    return true;\n  }\n  return false;\n}\nvec3 project_normal(vec3 vector) {\n  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);\n  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);\n  mat3 rotation;\n  if (project_needs_rotation(geometry.position.xyz, rotation)) {\n    n = rotation * n;\n  }\n  return n;\n}\n\nvec4 project_offset_(vec4 offset) {\n  float dy = offset.y;\n  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;\n  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);\n}\nvec2 project_mercator_(vec2 lnglat) {\n  float x = lnglat.x;\n  if (project_uWrapLongitude) {\n    x = mod(x + 180., 360.0) - 180.;\n  }\n  float y = clamp(lnglat.y, -89.9, 89.9);\n  return vec2(\n    radians(x) + PI,\n    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))\n  ) * WORLD_SCALE;\n}\n\nvec3 project_globe_(vec3 lnglatz) {\n  float lambda = radians(lnglatz.x);\n  float phi = radians(lnglatz.y);\n  float cosPhi = cos(phi);\n  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;\n\n  return vec3(\n    sin(lambda) * cosPhi,\n    -cos(lambda) * cosPhi,\n    sin(phi)\n  ) * D;\n}\nvec4 project_position(vec4 position, vec3 position64Low) {\n  vec4 position_world = project_uModelMatrix * position;\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      return vec4(\n        project_mercator_(position_world.xy),\n        project_size_at_latitude(position_world.z, position_world.y),\n        position_world.w\n      );\n    }\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {\n      position_world.xyz += project_uCoordinateOrigin;\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      return vec4(\n        project_globe_(position_world.xyz),\n        position_world.w\n      );\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {\n        return vec4(\n          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,\n          project_size(position_world.z),\n          position_world.w\n        );\n      }\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||\n    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&\n    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\n     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {\n    position_world.xyz -= project_uCoordinateOrigin;\n  }\n  return project_offset_(position_world) + project_offset_(project_uModelMatrix * vec4(position64Low, 0.0));\n}\n\nvec4 project_position(vec4 position) {\n  return project_position(position, ZERO_64_LOW);\n}\n\nvec3 project_position(vec3 position, vec3 position64Low) {\n  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);\n  return projected_position.xyz;\n}\n\nvec3 project_position(vec3 position) {\n  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);\n  return projected_position.xyz;\n}\n\nvec2 project_position(vec2 position) {\n  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);\n  return projected_position.xy;\n}\n\nvec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {\n  return viewProjectionMatrix * position + center;\n}\nvec4 project_common_position_to_clipspace(vec4 position) {\n  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);\n}\nvec2 project_pixel_size_to_clipspace(vec2 pixels) {\n  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;\n  return offset * project_uFocalDistance;\n}\n\nfloat project_size_to_pixel(float meters) {\n  return project_size(meters) * project_uScale;\n}\nfloat project_size_to_pixel(float size, int unit) {\n  if (unit == UNIT_METERS) return project_size_to_pixel(size);\n  if (unit == UNIT_COMMON) return size * project_uScale;\n  return size;\n}\nfloat project_pixel_size(float pixels) {\n  return pixels / project_uScale;\n}\nvec2 project_pixel_size(vec2 pixels) {\n  return pixels / project_uScale;\n}\n");function isEqual(e,t){if(e===t)return!0;if(Array.isArray(e)){const i=e.length;if(!t||t.length!==i)return!1;for(let n=0;n<i;n++)if(e[n]!==t[n])return!1;return!0}return!1}function memoize(e){let t,i={};return n=>{for(const r in n)if(!isEqual(n[r],i[r])){t=e(n),i=n;break}return t}}const ZERO_VECTOR$1=[0,0,0,0],VECTOR_TO_POINT_MATRIX$1=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],IDENTITY_MATRIX=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],DEFAULT_PIXELS_PER_UNIT2=[0,0,0],DEFAULT_COORDINATE_ORIGIN$1=[0,0,0],getMemoizedViewportUniforms=memoize(calculateViewportUniforms);function getOffsetOrigin(e,t,i=DEFAULT_COORDINATE_ORIGIN$1){i.length<3&&(i=[i[0],i[1],0]);let n,r=i,o=!0;switch(n=t===COORDINATE_SYSTEM.LNGLAT_OFFSETS||t===COORDINATE_SYSTEM.METER_OFFSETS?i:e.isGeospatial?[Math.fround(e.longitude),Math.fround(e.latitude),0]:null,e.projectionMode){case PROJECTION_MODE.WEB_MERCATOR:t!==COORDINATE_SYSTEM.LNGLAT&&t!==COORDINATE_SYSTEM.CARTESIAN||(n=[0,0,0],o=!1);break;case PROJECTION_MODE.WEB_MERCATOR_AUTO_OFFSET:t===COORDINATE_SYSTEM.LNGLAT?r=n:t===COORDINATE_SYSTEM.CARTESIAN&&(r=[Math.fround(e.center[0]),Math.fround(e.center[1]),0],n=e.unprojectPosition(r),r[0]-=i[0],r[1]-=i[1],r[2]-=i[2]);break;case PROJECTION_MODE.IDENTITY:r=e.position.map(Math.fround),r[2]=r[2]||0;break;case PROJECTION_MODE.GLOBE:o=!1,n=null;break;default:o=!1}return{geospatialOrigin:n,shaderCoordinateOrigin:r,offsetMode:o}}function calculateMatrixAndOffset(e,t,i){const{viewMatrixUncentered:n,projectionMatrix:r}=e;let{viewMatrix:o,viewProjectionMatrix:s}=e,a=ZERO_VECTOR$1,l=ZERO_VECTOR$1,c=e.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:d}=getOffsetOrigin(e,t,i);return d&&(l=e.projectPosition(u||h),c=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],l[3]=1,a=transformMat4([],l,s),o=n||o,s=multiply$1([],r,o),s=multiply$1([],s,VECTOR_TO_POINT_MATRIX$1)),{viewMatrix:o,viewProjectionMatrix:s,projectionCenter:a,originCommon:l,cameraPosCommon:c,shaderCoordinateOrigin:h,geospatialOrigin:u}}function getUniformsFromViewport({viewport:e,devicePixelRatio:t=1,modelMatrix:i=null,coordinateSystem:n=COORDINATE_SYSTEM.DEFAULT,coordinateOrigin:r=DEFAULT_COORDINATE_ORIGIN$1,autoWrapLongitude:o=!1}){n===COORDINATE_SYSTEM.DEFAULT&&(n=e.isGeospatial?COORDINATE_SYSTEM.LNGLAT:COORDINATE_SYSTEM.CARTESIAN);const s=getMemoizedViewportUniforms({viewport:e,devicePixelRatio:t,coordinateSystem:n,coordinateOrigin:r});return s.project_uWrapLongitude=o,s.project_uModelMatrix=i||IDENTITY_MATRIX,s}function calculateViewportUniforms({viewport:e,devicePixelRatio:t,coordinateSystem:i,coordinateOrigin:n}){const{projectionCenter:r,viewProjectionMatrix:o,originCommon:s,cameraPosCommon:a,shaderCoordinateOrigin:l,geospatialOrigin:c}=calculateMatrixAndOffset(e,i,n),u=e.getDistanceScales(),h=[e.width*t,e.height*t],d=transformMat4([],[0,0,-e.focalDistance,1],e.projectionMatrix)[3]||1,p={project_uCoordinateSystem:i,project_uProjectionMode:e.projectionMode,project_uCoordinateOrigin:l,project_uCommonOrigin:s.slice(0,3),project_uCenter:r,project_uPseudoMeters:Boolean(e._pseudoMeters),project_uViewportSize:h,project_uDevicePixelRatio:t,project_uFocalDistance:d,project_uCommonUnitsPerMeter:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:DEFAULT_PIXELS_PER_UNIT2,project_uScale:e.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:o,project_uModelMatrix:IDENTITY_MATRIX,project_uCameraPosition:a};if(c){const t=e.getDistanceScales(c);switch(i){case COORDINATE_SYSTEM.METER_OFFSETS:p.project_uCommonUnitsPerWorldUnit=t.unitsPerMeter,p.project_uCommonUnitsPerWorldUnit2=t.unitsPerMeter2;break;case COORDINATE_SYSTEM.LNGLAT:case COORDINATE_SYSTEM.LNGLAT_OFFSETS:e._pseudoMeters||(p.project_uCommonUnitsPerMeter=t.unitsPerMeter),p.project_uCommonUnitsPerWorldUnit=t.unitsPerDegree,p.project_uCommonUnitsPerWorldUnit2=t.unitsPerDegree2;break;case COORDINATE_SYSTEM.CARTESIAN:p.project_uCommonUnitsPerWorldUnit=[1,1,t.unitsPerMeter[2]],p.project_uCommonUnitsPerWorldUnit2=[0,0,t.unitsPerMeter2[2]]}}return p}const INITIAL_MODULE_OPTIONS={};function getUniforms(e=INITIAL_MODULE_OPTIONS){return"viewport"in e?getUniformsFromViewport(e):{}}var project={name:"project",dependencies:[fp32,geometry],vs:projectShader,getUniforms:getUniforms};function createMat4$1(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function transformVector(e,t){const i=transformMat4([],t,e);return scale$1(i,i,1/i[3]),i}function mod(e,t){const i=e%t;return i<0?t+i:i}function clamp$1(e,t,i){return e<t?t:e>i?i:e}function ieLog2(e){return Math.log(e)*Math.LOG2E}const log2=Math.log2||ieLog2;function assert$5(e,t){if(!e)throw new Error(t||"@math.gl/web-mercator: assertion failed.")}const PI=Math.PI,PI_4=PI/4,DEGREES_TO_RADIANS$3=PI/180,RADIANS_TO_DEGREES=180/PI,TILE_SIZE$2=512,EARTH_CIRCUMFERENCE=4003e4,MAX_LATITUDE=85.051129,DEFAULT_ALTITUDE=1.5;function scaleToZoom(e){return log2(e)}function lngLatToWorld(e){const[t,i]=e;assert$5(Number.isFinite(t)),assert$5(Number.isFinite(i)&&i>=-90&&i<=90,"invalid latitude");return[TILE_SIZE$2*(t*DEGREES_TO_RADIANS$3+PI)/(2*PI),TILE_SIZE$2*(PI+Math.log(Math.tan(PI_4+.5*(i*DEGREES_TO_RADIANS$3))))/(2*PI)]}function worldToLngLat(e){const[t,i]=e,n=t/TILE_SIZE$2*(2*PI)-PI,r=2*(Math.atan(Math.exp(i/TILE_SIZE$2*(2*PI)-PI))-PI_4);return[n*RADIANS_TO_DEGREES,r*RADIANS_TO_DEGREES]}function getMeterZoom(e){const{latitude:t}=e;assert$5(Number.isFinite(t));const i=Math.cos(t*DEGREES_TO_RADIANS$3);return scaleToZoom(EARTH_CIRCUMFERENCE*i)-9}function unitsPerMeter(e){const t=Math.cos(e*DEGREES_TO_RADIANS$3);return TILE_SIZE$2/EARTH_CIRCUMFERENCE/t}function getDistanceScales(e){const{latitude:t,longitude:i,highPrecision:n=!1}=e;assert$5(Number.isFinite(t)&&Number.isFinite(i));const r=TILE_SIZE$2,o=Math.cos(t*DEGREES_TO_RADIANS$3),s=r/360,a=s/o,l=r/EARTH_CIRCUMFERENCE/o,c={unitsPerMeter:[l,l,l],metersPerUnit:[1/l,1/l,1/l],unitsPerDegree:[s,a,l],degreesPerUnit:[1/s,1/a,1/l]};if(n){const e=DEGREES_TO_RADIANS$3*Math.tan(t*DEGREES_TO_RADIANS$3)/o,i=r/EARTH_CIRCUMFERENCE*e,n=i/a*l;c.unitsPerDegree2=[0,s*e/2,i],c.unitsPerMeter2=[n,0,n]}return c}function addMetersToLngLat(e,t){const[i,n,r]=e,[o,s,a]=t,{unitsPerMeter:l,unitsPerMeter2:c}=getDistanceScales({longitude:i,latitude:n,highPrecision:!0}),u=lngLatToWorld(e);u[0]+=o*(l[0]+c[0]*s),u[1]+=s*(l[1]+c[1]*s);const h=worldToLngLat(u),d=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[h[0],h[1],d]:h}function getViewMatrix(e){const{height:t,pitch:i,bearing:n,altitude:r,scale:o,center:s}=e,a=createMat4$1();translate$1(a,a,[0,0,-r]),rotateX$1(a,a,-i*DEGREES_TO_RADIANS$3),rotateZ$1(a,a,n*DEGREES_TO_RADIANS$3);const l=o/t;return scale$2(a,a,[l,l,l]),s&&translate$1(a,a,negate([],s)),a}function getProjectionParameters(e){const{width:t,height:i,altitude:n,pitch:r=0,offset:o,center:s,scale:a,nearZMultiplier:l=1,unitsPerMeter:c}=e;let{fovy:u=altitudeToFovy(DEFAULT_ALTITUDE)}=e;void 0!==n&&(u=altitudeToFovy(n));const h=u*DEGREES_TO_RADIANS$3,d=r*DEGREES_TO_RADIANS$3,p=fovyToAltitude(u);let f=p;s&&(f+=s[2]*a/Math.cos(d)/i);return{fov:h,aspect:t/i,focalDistance:p,near:l,far:Math.max(10*f,f+1e3*c/Math.cos(d))}}function altitudeToFovy(e){return 2*Math.atan(.5/e)*RADIANS_TO_DEGREES}function fovyToAltitude(e){return.5/Math.tan(.5*e*DEGREES_TO_RADIANS$3)}function worldToPixels(e,t){const[i,n,r=0]=e;return assert$5(Number.isFinite(i)&&Number.isFinite(n)&&Number.isFinite(r)),transformVector(t,[i,n,r,1])}function pixelsToWorld(e,t,i=0){const[n,r,o]=e;if(assert$5(Number.isFinite(n)&&Number.isFinite(r),"invalid pixel coordinate"),Number.isFinite(o)){return transformVector(t,[n,r,o,1])}const s=transformVector(t,[n,r,0,1]),a=transformVector(t,[n,r,1,1]),l=s[2],c=a[2];return lerp$3([],s,a,l===c?0:((i||0)-l)/(c-l))}function fitBounds(e){const{width:t,height:i,bounds:n,minExtent:r=0,maxZoom:o=24,offset:s=[0,0]}=e,[[a,l],[c,u]]=n,h=getPaddingObject(e.padding),d=lngLatToWorld([a,clamp$1(u,-MAX_LATITUDE,MAX_LATITUDE)]),p=lngLatToWorld([c,clamp$1(l,-MAX_LATITUDE,MAX_LATITUDE)]),f=[Math.max(Math.abs(p[0]-d[0]),r),Math.max(Math.abs(p[1]-d[1]),r)],m=[t-h.left-h.right-2*Math.abs(s[0]),i-h.top-h.bottom-2*Math.abs(s[1])];assert$5(m[0]>0&&m[1]>0);const g=m[0]/f[0],_=m[1]/f[1],y=worldToLngLat([(p[0]+d[0])/2+(h.right-h.left)/2/g,(p[1]+d[1])/2+(h.top-h.bottom)/2/_]),v=Math.min(o,log2(Math.abs(Math.min(g,_))));return assert$5(Number.isFinite(v)),{longitude:y[0],latitude:y[1],zoom:v}}function getPaddingObject(e=0){return"number"==typeof e?{top:e,bottom:e,left:e,right:e}:(assert$5(Number.isFinite(e.top)&&Number.isFinite(e.bottom)&&Number.isFinite(e.left)&&Number.isFinite(e.right)),e)}const DEGREES_TO_RADIANS$2=Math.PI/180;function getBounds(e,t=0){const{width:i,height:n,unproject:r}=e,o={targetZ:t},s=r([0,n],o),a=r([i,n],o);let l,c;return(e.fovy?.5*e.fovy*DEGREES_TO_RADIANS$2:Math.atan(.5/e.altitude))>(90-e.pitch)*DEGREES_TO_RADIANS$2-.01?(l=unprojectOnFarPlane(e,0,t),c=unprojectOnFarPlane(e,i,t)):(l=r([0,0],o),c=r([i,0],o)),[s,a,c,l]}function unprojectOnFarPlane(e,t,i){const{pixelUnprojectionMatrix:n}=e,r=transformVector(n,[t,0,1,1]),o=transformVector(n,[t,e.height,1,1]),s=worldToLngLat(lerp$3([],r,o,(i*e.distanceScales.unitsPerMeter[2]-r[2])/(o[2]-r[2])));return s.push(i),s}const TILE_SIZE$1=512;function normalizeViewportProps(e){const{width:t,height:i,pitch:n=0}=e;let{longitude:r,latitude:o,zoom:s,bearing:a=0}=e;(r<-180||r>180)&&(r=mod(r+180,360)-180),(a<-180||a>180)&&(a=mod(a+180,360)-180);const l=log2(i/TILE_SIZE$1);if(s<=l)s=l,o=0;else{const e=i/2/Math.pow(2,s),t=worldToLngLat([0,e])[1];if(o<t)o=t;else{const t=worldToLngLat([0,TILE_SIZE$1-e])[1];o>t&&(o=t)}}return{width:t,height:i,longitude:r,latitude:o,zoom:s,pitch:n,bearing:a}}const vs$b="\nconst int max_lights = 2;\nuniform mat4 shadow_uViewProjectionMatrices[max_lights];\nuniform vec4 shadow_uProjectCenters[max_lights];\nuniform bool shadow_uDrawShadowMap;\nuniform bool shadow_uUseShadowMap;\nuniform int shadow_uLightId;\nuniform float shadow_uLightCount;\n\nvarying vec3 shadow_vPosition[max_lights];\n\nvec4 shadow_setVertexPosition(vec4 position_commonspace) {\n  if (shadow_uDrawShadowMap) {\n    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);\n  }\n  if (shadow_uUseShadowMap) {\n    for (int i = 0; i < max_lights; i++) {\n      if(i < int(shadow_uLightCount)) {\n        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);\n        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;\n      }\n    }\n  }\n  return gl_Position;\n}\n",fs$b="\nconst int max_lights = 2;\nuniform bool shadow_uDrawShadowMap;\nuniform bool shadow_uUseShadowMap;\nuniform sampler2D shadow_uShadowMap0;\nuniform sampler2D shadow_uShadowMap1;\nuniform vec4 shadow_uColor;\nuniform float shadow_uLightCount;\n\nvarying vec3 shadow_vPosition[max_lights];\n\nconst vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);\nconst vec4 bitUnpackShift = 1.0 / bitPackShift;\nconst vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);\n\nfloat shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {\n  vec4 rgbaDepth = texture2D(shadowMap, position.xy);\n\n  float z = dot(rgbaDepth, bitUnpackShift);\n  return smoothstep(0.001, 0.01, position.z - z);\n}\n\nvec4 shadow_filterShadowColor(vec4 color) {\n  if (shadow_uDrawShadowMap) {\n    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);\n    rgbaDepth -= rgbaDepth.gbaa * bitMask;\n    return rgbaDepth;\n  }\n  if (shadow_uUseShadowMap) {\n    float shadowAlpha = 0.0;\n    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);\n    if(shadow_uLightCount > 1.0) {\n      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);\n    }\n    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;\n    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);\n\n    return vec4(\n      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),\n      blendedAlpha\n    );\n  }\n  return color;\n}\n",getMemoizedViewportCenterPosition=memoize(getViewportCenterPosition),getMemoizedViewProjectionMatrices=memoize(getViewProjectionMatrices),DEFAULT_SHADOW_COLOR$1=[0,0,0,1],VECTOR_TO_POINT_MATRIX=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function screenToCommonSpace(e,t){const[i,n,r]=e,o=pixelsToWorld([i,n,r],t);return Number.isFinite(r)?o:[o[0],o[1],0]}function getViewportCenterPosition({viewport:e,center:t}){return new Matrix4$1(e.viewProjectionMatrix).invert().transform(t)}function getViewProjectionMatrices({viewport:e,shadowMatrices:t}){const i=[],n=e.pixelUnprojectionMatrix,r=e.isGeospatial?void 0:1,o=[[0,0,r],[e.width,0,r],[0,e.height,r],[e.width,e.height,r],[0,0,-1],[e.width,0,-1],[0,e.height,-1],[e.width,e.height,-1]].map((e=>screenToCommonSpace(e,n)));for(const n of t){const t=n.clone().translate(new Vector3$1(e.center).negate()),r=o.map((e=>t.transform(e))),s=(new Matrix4$1).ortho({left:Math.min(...r.map((e=>e[0]))),right:Math.max(...r.map((e=>e[0]))),bottom:Math.min(...r.map((e=>e[1]))),top:Math.max(...r.map((e=>e[1]))),near:Math.min(...r.map((e=>-e[2]))),far:Math.max(...r.map((e=>-e[2])))});i.push(s.multiplyRight(n))}return i}function createShadowUniforms(e,t){const{shadowEnabled:i=!0}=e;if(!i||!e.shadowMatrices||!e.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1};const n={shadow_uDrawShadowMap:Boolean(e.drawToShadowMap),shadow_uUseShadowMap:!!e.shadowMaps&&e.shadowMaps.length>0,shadow_uColor:e.shadowColor||DEFAULT_SHADOW_COLOR$1,shadow_uLightId:e.shadowLightId||0,shadow_uLightCount:e.shadowMatrices.length},r=getMemoizedViewportCenterPosition({viewport:e.viewport,center:t.project_uCenter}),o=[],s=getMemoizedViewProjectionMatrices({shadowMatrices:e.shadowMatrices,viewport:e.viewport}).slice();for(let i=0;i<e.shadowMatrices.length;i++){const n=s[i],a=n.clone().translate(new Vector3$1(e.viewport.center).negate());t.project_uCoordinateSystem===COORDINATE_SYSTEM.LNGLAT&&t.project_uProjectionMode===PROJECTION_MODE.WEB_MERCATOR?(s[i]=a,o[i]=r):(s[i]=n.clone().multiplyRight(VECTOR_TO_POINT_MATRIX),o[i]=a.transform(r))}for(let t=0;t<s.length;t++)n["shadow_uViewProjectionMatrices[".concat(t,"]")]=s[t],n["shadow_uProjectCenters[".concat(t,"]")]=o[t],n["shadow_uShadowMap".concat(t)]=e.shadowMaps&&e.shadowMaps.length>0?e.shadowMaps[t]:e.dummyShadowMap;return n}var shadow={name:"shadow",dependencies:[project],vs:vs$b,fs:fs$b,inject:{"vs:DECKGL_FILTER_GL_POSITION":"\n    position = shadow_setVertexPosition(geometry.position);\n    ","fs:DECKGL_FILTER_COLOR":"\n    color = shadow_filterShadowColor(color);\n    "},getUniforms:(e={},t={})=>"viewport"in e&&(e.drawToShadowMap||e.shadowMaps&&e.shadowMaps.length>0)?createShadowUniforms(e,t):{}};const DEFAULT_AMBIENT_LIGHT_PROPS={color:[255,255,255],intensity:1},DEFAULT_DIRECTIONAL_LIGHT_PROPS=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],DEFAULT_SHADOW_COLOR=[0,0,0,200/255];class LightingEffect{constructor(e={}){_defineProperty(this,"id","lighting-effect"),_defineProperty(this,"props",void 0),_defineProperty(this,"shadowColor",DEFAULT_SHADOW_COLOR),_defineProperty(this,"shadow",void 0),_defineProperty(this,"ambientLight",void 0),_defineProperty(this,"directionalLights",void 0),_defineProperty(this,"pointLights",void 0),_defineProperty(this,"shadowPasses",[]),_defineProperty(this,"shadowMaps",[]),_defineProperty(this,"dummyShadowMap",null),_defineProperty(this,"programManager",void 0),_defineProperty(this,"shadowMatrices",void 0),this.setProps(e)}setProps(e){this.ambientLight=null,this.directionalLights=[],this.pointLights=[];for(const t in e){const i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i)}}this._applyDefaultLights(),this.shadow=this.directionalLights.some((e=>e.shadow)),this.props=e}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:r,views:o}){if(this.shadow){this.shadowMatrices=this._calculateMatrices(),0===this.shadowPasses.length&&this._createShadowPasses(e),this.programManager||(this.programManager=ProgramManager.getDefaultProgramManager(e),shadow&&this.programManager.addDefaultModule(shadow)),this.dummyShadowMap||(this.dummyShadowMap=new Texture2D(e,{width:1,height:1}));for(let e=0;e<this.shadowPasses.length;e++){this.shadowPasses[e].render({layers:t,layerFilter:i,viewports:n,onViewportActive:r,views:o,moduleParameters:{shadowLightId:e,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}}getModuleParameters(e){const t=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return t.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map((t=>t.getProjectedLight({layer:e}))),pointLights:this.pointLights.map((t=>t.getProjectedLight({layer:e})))},t}cleanup(){for(const e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(shadow),this.programManager=null)}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const i=(new Matrix4$1).lookAt({eye:new Vector3$1(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const i=new ShadowPass(e);this.shadowPasses[t]=i,this.shadowMaps[t]=i.shadowMap}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:i}=this;e||0!==t.length||0!==i.length||(this.ambientLight=new AmbientLight$1(DEFAULT_AMBIENT_LIGHT_PROPS),this.directionalLights.push(new DirectionalLight$1(DEFAULT_DIRECTIONAL_LIGHT_PROPS[0]),new DirectionalLight$1(DEFAULT_DIRECTIONAL_LIGHT_PROPS[1])))}}class TypedArrayManager{constructor(e={}){_defineProperty(this,"_pool",[]),_defineProperty(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:i=1,type:n,padding:r=0,copy:o=!1,initialize:s=!1,maxCount:a}){const l=n||e&&e.constructor||Float32Array,c=t*i+r;if(ArrayBuffer.isView(e)){if(c<=e.length)return e;if(c*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new l(e.buffer,0,c)}let u=1/0;a&&(u=a*i+r);const h=this._allocate(l,c,s,u);return e&&o?h.set(e):s||h.fill(0,0,4),this._release(e),h}release(e){this._release(e)}_allocate(e,t,i,n){let r=Math.max(Math.ceil(t*this.opts.overAlloc),1);r>n&&(r=n);const o=this._pool,s=e.BYTES_PER_ELEMENT*r,a=o.findIndex((e=>e.byteLength>=s));if(a>=0){const t=new e(o.splice(a,1)[0],0,r);return i&&t.fill(0),t}return new e(r)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:i}=e,{byteLength:n}=i,r=t.findIndex((e=>e.byteLength>=n));r<0?t.push(i):(r>0||t.length<this.opts.poolSize)&&t.splice(r,0,i),t.length>this.opts.poolSize&&t.shift()}}var defaultTypedArrayManager=new TypedArrayManager;function createMat4(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function getCameraPosition(e){return[e[12],e[13],e[14]]}function getFrustumPlanes(e){return{left:getFrustumPlane(e[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]),right:getFrustumPlane(e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]),bottom:getFrustumPlane(e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]),top:getFrustumPlane(e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]),near:getFrustumPlane(e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]),far:getFrustumPlane(e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14])}}const scratchVector$7=new Vector3$1;function getFrustumPlane(e,t,i,n){scratchVector$7.set(e,t,i);const r=scratchVector$7.len();return{distance:n/r,normal:new Vector3$1(-e/r,-t/r,-i/r)}}function fp64LowPart(e){return e-Math.fround(e)}let scratchArray;function toDoublePrecisionArray(e,t){const{size:i=1,startIndex:n=0}=t,r=void 0!==t.endIndex?t.endIndex:e.length,o=(r-n)/i;scratchArray=defaultTypedArrayManager.allocate(scratchArray,o,{type:Float32Array,size:2*i});let s=n,a=0;for(;s<r;){for(let t=0;t<i;t++){const n=e[s++];scratchArray[a+t]=n,scratchArray[a+t+i]=fp64LowPart(n)}a+=2*i}return scratchArray.subarray(0,o*i*2)}function mergeBounds(e){let t=null,i=!1;for(const n of e)n&&(t?(i||(t=[[t[0][0],t[0][1]],[t[1][0],t[1][1]]],i=!0),t[0][0]=Math.min(t[0][0],n[0][0]),t[0][1]=Math.min(t[0][1],n[0][1]),t[1][0]=Math.max(t[1][0],n[1][0]),t[1][1]=Math.max(t[1][1],n[1][1])):t=n);return t}const DEGREES_TO_RADIANS$1=Math.PI/180,IDENTITY=createMat4(),ZERO_VECTOR=[0,0,0],DEFAULT_DISTANCE_SCALES={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function createProjectionMatrix({width:e,height:t,orthographic:i,fovyRadians:n,focalDistance:r,padding:o,near:s,far:a}){const l=e/t,c=i?(new Matrix4$1).orthographic({fovy:n,aspect:l,focalDistance:r,near:s,far:a}):(new Matrix4$1).perspective({fovy:n,aspect:l,near:s,far:a});if(o){const{left:i=0,right:n=0,top:r=0,bottom:s=0}=o,a=clamp$2((i+e-n)/2,0,e)-e/2,l=clamp$2((r+t-s)/2,0,t)-t/2;c[8]-=2*a/e,c[9]+=2*l/t}return c}class Viewport{constructor(e={}){_defineProperty(this,"id",void 0),_defineProperty(this,"x",void 0),_defineProperty(this,"y",void 0),_defineProperty(this,"width",void 0),_defineProperty(this,"height",void 0),_defineProperty(this,"padding",void 0),_defineProperty(this,"isGeospatial",void 0),_defineProperty(this,"zoom",void 0),_defineProperty(this,"focalDistance",void 0),_defineProperty(this,"position",void 0),_defineProperty(this,"modelMatrix",void 0),_defineProperty(this,"distanceScales",void 0),_defineProperty(this,"scale",void 0),_defineProperty(this,"center",void 0),_defineProperty(this,"cameraPosition",void 0),_defineProperty(this,"projectionMatrix",void 0),_defineProperty(this,"viewMatrix",void 0),_defineProperty(this,"viewMatrixUncentered",void 0),_defineProperty(this,"viewMatrixInverse",void 0),_defineProperty(this,"viewProjectionMatrix",void 0),_defineProperty(this,"pixelProjectionMatrix",void 0),_defineProperty(this,"pixelUnprojectionMatrix",void 0),_defineProperty(this,"resolution",void 0),_defineProperty(this,"_frustumPlanes",{}),this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||DEFAULT_DISTANCE_SCALES,this.focalDistance=e.focalDistance||1,this.position=e.position||ZERO_VECTOR,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?PROJECTION_MODE.WEB_MERCATOR:PROJECTION_MODE.WEB_MERCATOR_AUTO_OFFSET:PROJECTION_MODE.IDENTITY}equals(e){return e instanceof Viewport&&(this===e||e.width===this.width&&e.height===this.height&&e.scale===this.scale&&equals$1(e.projectionMatrix,this.projectionMatrix)&&equals$1(e.viewMatrix,this.viewMatrix))}project(e,{topLeft:t=!0}={}){const i=worldToPixels(this.projectPosition(e),this.pixelProjectionMatrix),[n,r]=i,o=t?r:this.height-r;return 2===e.length?[n,o]:[n,o,i[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){const[n,r,o]=e,s=pixelsToWorld([n,t?r:this.height-r,o],this.pixelUnprojectionMatrix,i&&i*this.distanceScales.unitsPerMeter[2]),[a,l,c]=this.unprojectPosition(s);return Number.isFinite(o)?[a,l,c]:Number.isFinite(i)?[a,l,i]:[a,l]}projectPosition(e){const[t,i]=this.projectFlat(e);return[t,i,(e[2]||0)*this.distanceScales.unitsPerMeter[2]]}unprojectPosition(e){const[t,i]=this.unprojectFlat(e);return[t,i,(e[2]||0)*this.distanceScales.metersPerUnit[2]]}projectFlat(e){if(this.isGeospatial){const t=lngLatToWorld(e);return t[1]=clamp$2(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?worldToLngLat(e):e}getBounds(e={}){const t={targetZ:e.z||0},i=this.unproject([0,0],t),n=this.unproject([this.width,0],t),r=this.unproject([0,this.height],t),o=this.unproject([this.width,this.height],t);return[Math.min(i[0],n[0],r[0],o[0]),Math.min(i[1],n[1],r[1],o[1]),Math.max(i[0],n[0],r[0],o[0]),Math.max(i[1],n[1],r[1],o[1])]}getDistanceScales(e){return e?getDistanceScales({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:n=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+n}getFrustumPlanes(){return this._frustumPlanes.near||Object.assign(this._frustumPlanes,getFrustumPlanes(this.viewProjectionMatrix)),this._frustumPlanes}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=getMeterZoom({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||getDistanceScales({latitude:i,longitude:t}));const n=Math.pow(2,this.zoom);this.scale=n;const{position:r,modelMatrix:o}=e;let s=ZERO_VECTOR;if(r&&(s=o?new Matrix4$1(o).transformAsVector(r,[]):r),this.isGeospatial){const e=this.projectPosition([t,i,0]);this.center=new Vector3$1(s).scale(this.distanceScales.unitsPerMeter).add(e)}else this.center=this.projectPosition(s)}_initMatrices(e){const{viewMatrix:t=IDENTITY,projectionMatrix:i=null,orthographic:n=!1,fovyRadians:r,fovy:o=75,near:s=.1,far:a=1e3,padding:l=null,focalDistance:c=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=(new Matrix4$1).multiplyRight(t).translate(new Vector3$1(this.center).negate()),this.projectionMatrix=i||createProjectionMatrix({width:this.width,height:this.height,orthographic:n,fovyRadians:r||o*DEGREES_TO_RADIANS$1,focalDistance:c,padding:l,near:s,far:a});const u=createMat4();multiply$1(u,u,this.projectionMatrix),multiply$1(u,u,this.viewMatrix),this.viewProjectionMatrix=u,this.viewMatrixInverse=invert$1([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=getCameraPosition(this.viewMatrixInverse);const h=createMat4(),d=createMat4();scale$2(h,h,[this.width/2,-this.height/2,1]),translate$1(h,h,[1,-1,0]),multiply$1(d,h,this.viewProjectionMatrix),this.pixelProjectionMatrix=d,this.pixelUnprojectionMatrix=invert$1(createMat4(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||log$3.warn("Pixel project matrix not invertible")()}}_defineProperty(Viewport,"displayName","Viewport");class WebMercatorViewport extends Viewport{constructor(e={}){const{latitude:t=0,longitude:i=0,zoom:n=0,pitch:r=0,bearing:o=0,nearZMultiplier:s=.1,farZMultiplier:a=1.01,nearZ:l,farZ:c,orthographic:u=!1,projectionMatrix:h,repeat:d=!1,worldOffset:p=0,position:f,padding:m,legacyMeterSizes:g=!1}=e;let{width:_,height:y,altitude:v=1.5}=e;const x=Math.pow(2,n);let b;_=_||1,y=y||1;let T=null;if(h)v=h[5]/2,b=altitudeToFovy(v);else{let i;if(e.fovy?(b=e.fovy,v=fovyToAltitude(b)):b=altitudeToFovy(v),m){const{top:e=0,bottom:t=0}=m;i=[0,clamp$2((e+y-t)/2,0,y)-y/2]}T=getProjectionParameters({width:_,height:y,scale:x,center:f&&[0,0,f[2]*unitsPerMeter(t)],offset:i,pitch:r,fovy:b,nearZMultiplier:s,unitsPerMeter:x*unitsPerMeter(t)/y}),Number.isFinite(l)&&(T.near=l),Number.isFinite(c)&&(T.far=c)}let w=getViewMatrix({height:y,pitch:r,bearing:o,scale:x,altitude:v});if(p){w=(new Matrix4$1).translate([512*p,0,0]).multiplyLeft(w)}super({...e,width:_,height:y,viewMatrix:w,longitude:i,latitude:t,zoom:n,...T,fovy:b,focalDistance:v}),_defineProperty(this,"longitude",void 0),_defineProperty(this,"latitude",void 0),_defineProperty(this,"pitch",void 0),_defineProperty(this,"bearing",void 0),_defineProperty(this,"altitude",void 0),_defineProperty(this,"fovy",void 0),_defineProperty(this,"orthographic",void 0),_defineProperty(this,"_subViewports",void 0),_defineProperty(this,"_pseudoMeters",void 0),this.latitude=t,this.longitude=i,this.zoom=n,this.pitch=r,this.bearing=o,this.altitude=v,this.fovy=b,this.orthographic=u,this._subViewports=d?[]:null,this._pseudoMeters=g,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let e=t;e<=i;e++){const t=e?new WebMercatorViewport({...this,worldOffset:e}):this;this._subViewports.push(t)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,i]=this.projectFlat(e);return[t,i,(e[2]||0)*unitsPerMeter(e[1])]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,i]=this.unprojectFlat(e);return[t,i,(e[2]||0)/unitsPerMeter(i)]}addMetersToLngLat(e,t){return addMetersToLngLat(e,t)}panByPosition(e,t){const i=pixelsToWorld(t,this.pixelUnprojectionMatrix),n=add$3([],this.projectFlat(e),negate$1([],i)),r=add$3([],this.center,n),[o,s]=this.unprojectFlat(r);return{longitude:o,latitude:s}}getBounds(e={}){const t=getBounds(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:i,height:n}=this,{longitude:r,latitude:o,zoom:s}=fitBounds({width:i,height:n,bounds:e,...t});return new WebMercatorViewport({width:i,height:n,longitude:r,latitude:o,zoom:s})}}_defineProperty(WebMercatorViewport,"displayName","WebMercatorViewport");const DEFAULT_COORDINATE_ORIGIN=[0,0,0];function lngLatZToWorldPosition(e,t,i=!1){const n=t.projectPosition(e);if(i&&t instanceof WebMercatorViewport){const[i,r,o=0]=e,s=t.getDistanceScales([i,r]);n[2]=o*s.unitsPerMeter[2]}return n}function normalizeParameters(e){const{viewport:t,modelMatrix:i,coordinateOrigin:n}=e;let{coordinateSystem:r,fromCoordinateSystem:o,fromCoordinateOrigin:s}=e;return r===COORDINATE_SYSTEM.DEFAULT&&(r=t.isGeospatial?COORDINATE_SYSTEM.LNGLAT:COORDINATE_SYSTEM.CARTESIAN),void 0===o&&(o=r),void 0===s&&(s=n),{viewport:t,coordinateSystem:r,coordinateOrigin:n,modelMatrix:i,fromCoordinateSystem:o,fromCoordinateOrigin:s}}function getWorldPosition(e,{viewport:t,modelMatrix:i,coordinateSystem:n,coordinateOrigin:r,offsetMode:o}){let[s,a,l=0]=e;switch(i&&([s,a,l]=transformMat4([],[s,a,l,1],i)),n){case COORDINATE_SYSTEM.LNGLAT:return lngLatZToWorldPosition([s,a,l],t,o);case COORDINATE_SYSTEM.LNGLAT_OFFSETS:return lngLatZToWorldPosition([s+r[0],a+r[1],l+(r[2]||0)],t,o);case COORDINATE_SYSTEM.METER_OFFSETS:return lngLatZToWorldPosition(addMetersToLngLat(r,[s,a,l]),t,o);default:return t.isGeospatial?[s+r[0],a+r[1],l+r[2]]:t.projectPosition([s,a,l])}}function projectPosition(e,t){const{viewport:i,coordinateSystem:n,coordinateOrigin:r,modelMatrix:o,fromCoordinateSystem:s,fromCoordinateOrigin:a}=normalizeParameters(t),{autoOffset:l=!0}=t,{geospatialOrigin:c=DEFAULT_COORDINATE_ORIGIN,shaderCoordinateOrigin:u=DEFAULT_COORDINATE_ORIGIN,offsetMode:h=!1}=l?getOffsetOrigin(i,n,r):{},d=getWorldPosition(e,{viewport:i,modelMatrix:o,coordinateSystem:s,coordinateOrigin:a,offsetMode:h});if(h){const e=i.projectPosition(c||u);sub(d,d,e)}return d}const PICKING_PARAMETERS={blendFunc:[1,0,32771,0],blendEquation:32774};class PickLayersPass extends LayersPass{constructor(...e){super(...e),_defineProperty(this,"pickZ",void 0),_defineProperty(this,"_colorEncoderState",null)}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:r,pickingFBO:o,deviceRect:{x:s,y:a,width:l,height:c},cullRect:u,effects:h,pass:d="picking",pickZ:p,moduleParameters:f}){const m=this.gl;this.pickZ=p;const g=this._resetColorEncoder(p),_=withParameters(m,{scissorTest:!0,scissor:[s,a,l,c],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0],...PICKING_PARAMETERS,blend:!p},(()=>super.render({target:o,layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:r,cullRect:u,effects:null==h?void 0:h.filter((e=>e.useInPicking)),pass:d,isPicking:!0,moduleParameters:f})));this._colorEncoderState=null;return{decodePickingColor:g&&decodeColor.bind(null,g),stats:_}}shouldDrawLayer(e){const{pickable:t,operation:i}=e.props;return t&&i.includes("draw")||i.includes("terrain")||i.includes("mask")}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(e,t,i){const n={...e.props.parameters},{pickable:r,operation:o}=e.props;return this._colorEncoderState?r&&o.includes("draw")&&(Object.assign(n,PICKING_PARAMETERS),n.blend=!0,n.blendColor=encodeColor(this._colorEncoderState,e,i)):n.blend=!1,o.includes("terrain")&&(n.blend=!1),n}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function encodeColor(e,t,i){const{byLayer:n,byAlpha:r}=e;let o,s=n.get(t);return s?(s.viewports.push(i),o=s.a):(o=n.size+1,o<=255?(s={a:o,layer:t,viewports:[i]},n.set(t,s),r[o]=s):(log$3.warn("Too many pickable layers, only picking the first 255")(),o=0)),[0,0,0,o/255]}function decodeColor(e,t){const i=e.byAlpha[t[3]];return i&&{pickedLayer:i.layer,pickedViewports:i.viewports,pickedObjectIndex:i.layer.decodePickingColor(t)}}const LIFECYCLE={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},COMPONENT_SYMBOL=Symbol.for("component"),PROP_TYPES_SYMBOL=Symbol.for("propTypes"),DEPRECATED_PROPS_SYMBOL=Symbol.for("deprecatedProps"),ASYNC_DEFAULTS_SYMBOL=Symbol.for("asyncPropDefaults"),ASYNC_ORIGINAL_SYMBOL=Symbol.for("asyncPropOriginal"),ASYNC_RESOLVED_SYMBOL=Symbol.for("asyncPropResolved");function flatten$1(e,t=()=>!0){return Array.isArray(e)?flattenArray(e,t,[]):t(e)?[e]:[]}function flattenArray(e,t,i){let n=-1;for(;++n<e.length;){const r=e[n];Array.isArray(r)?flattenArray(r,t,i):t(r)&&i.push(r)}return i}function fillArray({target:e,source:t,start:i=0,count:n=1}){const r=t.length,o=n*r;let s=0;for(let n=i;s<r;s++)e[n++]=t[s];for(;s<o;)s<o-s?(e.copyWithin(i+s,i,i+s),s*=2):(e.copyWithin(i+s,i,i+o-s),s=o);return e}class Resource{constructor(e,t,i){_defineProperty(this,"id",void 0),_defineProperty(this,"context",void 0),_defineProperty(this,"isLoaded",void 0),_defineProperty(this,"persistent",void 0),_defineProperty(this,"_loadCount",0),_defineProperty(this,"_subscribers",new Set),_defineProperty(this,"_data",void 0),_defineProperty(this,"_loader",void 0),_defineProperty(this,"_error",void 0),_defineProperty(this,"_content",void 0),this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then((()=>this.getData()))}setData(e,t){if(e===this._data&&!t)return;this._data=e;const i=++this._loadCount;let n=e;"string"==typeof e&&(n=load(e)),n instanceof Promise?(this.isLoaded=!1,this._loader=n.then((e=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=e)})).catch((e=>{this._loadCount===i&&(this.isLoaded=!0,this._error=e||!0)}))):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const e of this._subscribers)e.onChange(this.getData())}}class ResourceManager{constructor({gl:e,protocol:t}){_defineProperty(this,"protocol",void 0),_defineProperty(this,"_context",void 0),_defineProperty(this,"_resources",void 0),_defineProperty(this,"_consumers",void 0),_defineProperty(this,"_pruneRequest",void 0),this.protocol=t||"resource://",this._context={gl:e,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return!!e.startsWith(this.protocol)||e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:n=!0}){let r=this._resources[e];r?r.setData(t,i):(r=new Resource(e,t,this._context),this._resources[e]=r),r.persistent=n}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const e in t){const i=t[e],n=this._resources[i.resourceId];n&&n.unsubscribe(i)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:n="default"}){const{_resources:r,protocol:o}=this;e.startsWith(o)&&(r[e=e.replace(o,"")]||this.add({resourceId:e,data:null,persistent:!1}));const s=r[e];if(this._track(i,n,s,t),s)return s.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout((()=>this._prune()),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,i,n){const r=this._consumers,o=r[e]=r[e]||{},s=o[t]||{},a=s.resourceId&&this._resources[s.resourceId];a&&(a.unsubscribe(s),this.prune()),i&&(o[t]=s,s.onChange=n,s.resourceId=i.id,i.subscribe(s))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];t.persistent||t.inUse()||(t.delete(),delete this._resources[e])}}}const vs$a="\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition\n) {\n  vec3 projectedPosition = project_position(position, position64Low);\n  mat3 rotation;\n  if (project_needs_rotation(projectedPosition, rotation)) {\n    // offset is specified as ENU\n    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe\n    offset = rotation * offset;\n  }\n  commonPosition = vec4(projectedPosition + offset, 1.0);\n  return project_common_position_to_clipspace(commonPosition);\n}\n\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset\n) {\n  vec4 commonPosition;\n  return project_position_to_clipspace(position, position64Low, offset, commonPosition);\n}\n";var project32={name:"project32",dependencies:[project],vs:vs$a},picking={inject:{"vs:DECKGL_FILTER_GL_POSITION":"\n    // for picking depth values\n    picking_setPickingAttribute(position.z / position.w);\n  ","vs:DECKGL_FILTER_COLOR":"\n  picking_setPickingColor(geometry.pickingColor);\n  ","fs:#decl":"\nuniform bool picking_uAttribute;\n  ","fs:DECKGL_FILTER_COLOR":{order:99,injection:"\n  // use highlight color if this fragment belongs to the selected object.\n  color = picking_filterHighlightColor(color);\n\n  // use picking color if rendering to picking FBO.\n  color = picking_filterPickingColor(color);\n    "}},...picking$1};const DEFAULT_MODULES=[project],SHADER_HOOKS=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function createProgramManager(e){const t=ProgramManager.getDefaultProgramManager(e);for(const e of DEFAULT_MODULES)t.addDefaultModule(e);for(const e of SHADER_HOOKS)t.addShaderHook(e);return t}const TRACE_SET_LAYERS="layerManager.setLayers",TRACE_ACTIVATE_VIEWPORT="layerManager.activateViewport";class LayerManager{constructor(e,{deck:t,stats:i,viewport:n,timeline:r}={}){_defineProperty(this,"layers",void 0),_defineProperty(this,"context",void 0),_defineProperty(this,"resourceManager",void 0),_defineProperty(this,"_lastRenderedLayers",[]),_defineProperty(this,"_needsRedraw",!1),_defineProperty(this,"_needsUpdate",!1),_defineProperty(this,"_nextLayers",null),_defineProperty(this,"_debug",!1),_defineProperty(this,"activateViewport",(e=>{debug(TRACE_ACTIVATE_VIEWPORT,this,e),e&&(this.context.viewport=e)})),this.layers=[],this.resourceManager=new ResourceManager({gl:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,gl:e,deck:t,programManager:e&&createProgramManager(e),stats:i||new Stats({id:"deck.gl"}),viewport:n||new Viewport({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:r||new Timeline,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const i of this.layers){const n=i.getNeedsRedraw(e);t=t||n}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter((t=>e.find((e=>0===t.id.indexOf(e))))):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){debug(TRACE_SET_LAYERS,this,t,e),this._lastRenderedLayers=e;const i=flatten$1(e,Boolean);for(const e of i)e.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw("updating layers: ".concat(e)),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}_handleError(e,t,i){i.raiseError(t,"".concat(e," of ").concat(i))}_updateLayers(e,t){const i={};for(const t of e)i[t.id]?log$3.warn("Multiple old layers with same id ".concat(t.id))():i[t.id]=t;const n=[];this._updateSublayersRecursively(t,i,n),this._finalizeOldLayers(i);let r=!1;for(const e of n)if(e.hasUniformTransition()){r="Uniform transition in ".concat(e);break}this._needsUpdate=r,this.layers=n}_updateSublayersRecursively(e,t,i){for(const n of e){n.context=this.context;const e=t[n.id];null===e&&log$3.warn("Multiple new layers with same id ".concat(n.id))(),t[n.id]=null;let r=null;try{this._debug&&e!==n&&n.validateProps(),e?(this._transferLayerState(e,n),this._updateLayer(n)):this._initializeLayer(n),i.push(n),r=n.isComposite?n.getSubLayers():null}catch(e){this._handleError("matching",e,n)}r&&this._updateSublayersRecursively(r,t,i)}}_finalizeOldLayers(e){for(const t in e){const i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=LIFECYCLE.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=LIFECYCLE.MATCHED,t!==e&&(e.lifecycle=LIFECYCLE.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||"finalized ".concat(e),e.lifecycle=LIFECYCLE.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=LIFECYCLE.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}function deepEqual(e,t,i){if(e===t)return!0;if(!i||!e||!t)return!1;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!deepEqual(e[n],t[n],i-1))return!1;return!0}if(Array.isArray(t))return!1;if("object"==typeof e&&"object"==typeof t){const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n){if(!t.hasOwnProperty(r))return!1;if(!deepEqual(e[r],t[r],i-1))return!1}return!0}return!1}class ViewManager{constructor(e){_defineProperty(this,"width",void 0),_defineProperty(this,"height",void 0),_defineProperty(this,"views",void 0),_defineProperty(this,"viewState",void 0),_defineProperty(this,"controllers",void 0),_defineProperty(this,"timeline",void 0),_defineProperty(this,"_viewports",void 0),_defineProperty(this,"_viewportMap",void 0),_defineProperty(this,"_isUpdating",void 0),_defineProperty(this,"_needsRedraw",void 0),_defineProperty(this,"_needsUpdate",void 0),_defineProperty(this,"_eventManager",void 0),_defineProperty(this,"_eventCallbacks",void 0),this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter((t=>t.containsPixel(e))):this._viewports}getViews(){const e={};return this.views.forEach((t=>{e[t.id]=t})),e}getView(e){return this.views.find((t=>t.id===e))}getViewState(e){const t="string"==typeof e?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){const i=this.getViewports(),n={x:e[0],y:e[1]};for(let r=i.length-1;r>=0;--r){const o=i[r];if(o.containsPixel(n)){const i=e.slice();return i[0]-=o.x,i[1]-=o.y,o.unproject(i,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){e===this.width&&t===this.height||(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=flatten$1(e,Boolean);this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){if(e){!deepEqual(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e}else log$3.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(e,t){this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange({...t,viewId:e})}_createController(e,t){return new(0,t.type)({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,t.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:t=>{var i;return null===(i=this.getView(e.id))||void 0===i?void 0:i.makeViewport({viewState:t,width:this.width,height:this.height})}})}_updateController(e,t,i,n){const r=e.controller;if(r&&i){const o={...t,...r,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return n&&n.constructor===r.type||(n=this._createController(e,o)),n&&n.setProps(o),n}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let n=e.length;n--;){const r=e[n],o=this.getViewState(r),s=r.makeViewport({viewState:o,width:this.width,height:this.height});let a=t[r.id];const l=Boolean(r.controller);l&&!a&&(i=!0),!i&&l||!a||(a.finalize(),a=null),this.controllers[r.id]=this._updateController(r,o,s,a),s&&this._viewports.unshift(s)}for(const e in t){const i=t[e];i&&!this.controllers[e]&&i.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach((e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)}))}_diffViews(e,t){return e.length!==t.length||e.some(((i,n)=>!e[n].equals(t[n])))}}const PERCENT_OR_PIXELS_REGEX=/([0-9]+\.?[0-9]*)(%|px)/;function parsePosition(e){switch(typeof e){case"number":return{position:e,relative:!1};case"string":const t=PERCENT_OR_PIXELS_REGEX.exec(e);if(t&&t.length>=3){const e="%"===t[2],i=parseFloat(t[1]);return{position:e?i/100:i,relative:e}}default:throw new Error("Could not parse position string ".concat(e))}}function getPosition(e,t){return e.relative?Math.round(e.position*t):e.position}function assert$4(e,t){if(!e)throw new Error(t||"deck.gl: assertion failed.")}class View{constructor(e){_defineProperty(this,"id",void 0),_defineProperty(this,"viewportInstance",void 0),_defineProperty(this,"_x",void 0),_defineProperty(this,"_y",void 0),_defineProperty(this,"_width",void 0),_defineProperty(this,"_height",void 0),_defineProperty(this,"_padding",void 0),_defineProperty(this,"props",void 0);const{id:t,x:i=0,y:n=0,width:r="100%",height:o="100%",padding:s=null,viewportInstance:a}=e||{};assert$4(!a||a instanceof Viewport),this.viewportInstance=a,this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=parsePosition(i),this._y=parsePosition(n),this._width=parsePosition(r),this._height=parsePosition(o),this._padding=s&&{left:parsePosition(s.left||0),right:parsePosition(s.right||0),top:parsePosition(s.top||0),bottom:parsePosition(s.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e||(this.viewportInstance?!!e.viewportInstance&&this.viewportInstance.equals(e.viewportInstance):this.ViewportType===e.ViewportType&&deepEqual(this.props,e.props,2))}makeViewport({width:e,height:t,viewState:i}){if(this.viewportInstance)return this.viewportInstance;i=this.filterViewState(i);const n=this.getDimensions({width:e,height:t});return n.height&&n.width?new this.ViewportType({...i,...this.props,...n}):null}getViewStateId(){const{viewState:e}=this.props;return"string"==typeof e?e:(null==e?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&"object"==typeof this.props.viewState){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const e in this.props.viewState)"id"!==e&&(t[e]=this.props.viewState[e]);return t}return e}getDimensions({width:e,height:t}){const i={x:getPosition(this._x,e),y:getPosition(this._y,t),width:getPosition(this._width,e),height:getPosition(this._height,t)};return this._padding&&(i.padding={left:getPosition(this._padding.left,e),top:getPosition(this._padding.top,t),right:getPosition(this._padding.right,e),bottom:getPosition(this._padding.bottom,t)}),i}get controller(){const e=this.props.controller;return e?!0===e?{type:this.ControllerType}:"function"==typeof e?{type:e}:{type:this.ControllerType,...e}:null}}class Transition{constructor(e){_defineProperty(this,"_inProgress",void 0),_defineProperty(this,"_handle",void 0),_defineProperty(this,"_timeline",void 0),_defineProperty(this,"time",void 0),_defineProperty(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=e,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(e){var t,i;this.cancel(),this.settings=e,this._inProgress=!0,null===(t=(i=this.settings).onStart)||void 0===t||t.call(i,this)}end(){var e,t;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,null===(e=(t=this.settings).onEnd)||void 0===e||e.call(t,this))}cancel(){var e,t;this._inProgress&&(null===(e=(t=this.settings).onInterrupt)||void 0===e||e.call(t,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var e,t;if(!this._inProgress)return!1;if(null===this._handle){const{_timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),null===(e=(t=this.settings).onUpdate)||void 0===e||e.call(t,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const noop$2=()=>{},TRANSITION_EVENTS={BREAK:1,SNAP_TO_END:2,IGNORE:3},DEFAULT_EASING=e=>e,DEFAULT_INTERRUPTION=TRANSITION_EVENTS.BREAK;class TransitionManager{constructor(e){_defineProperty(this,"getControllerState",void 0),_defineProperty(this,"props",void 0),_defineProperty(this,"propsInTransition",void 0),_defineProperty(this,"transition",void 0),_defineProperty(this,"onViewStateChange",void 0),_defineProperty(this,"onStateChange",void 0),_defineProperty(this,"_onTransitionUpdate",(e=>{const{time:t,settings:{interpolator:i,startProps:n,endProps:r,duration:o,easing:s}}=e,a=s(t/o),l=i.interpolateProps(n,r,a);this.propsInTransition=this.getControllerState({...this.props,...l}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})})),this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new Transition(e.timeline),this.onViewStateChange=e.onViewStateChange||noop$2,this.onStateChange=e.onStateChange||noop$2}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let n=i;if(this.transition.inProgress){const{interruption:e,endProps:t}=this.transition.settings;n={...i,...e===TRANSITION_EVENTS.SNAP_TO_END?t:this.propsInTransition||i}}this._triggerTransition(n,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||"auto"===t)&&Boolean(i)}_isUpdateDueToCurrentTransition(e){return!(!this.transition.inProgress||!this.propsInTransition)&&this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition)}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===TRANSITION_EVENTS.IGNORE||this._isUpdateDueToCurrentTransition(t):!this._isTransitionEnabled(t)||t.transitionInterpolator.arePropsEqual(e,t)}_triggerTransition(e,t){const i=this.getControllerState(e),n=this.getControllerState(t).shortestPathFrom(i),r=t.transitionInterpolator,o=r.getDuration?r.getDuration(e,t):t.transitionDuration;if(0===o)return;const s=r.initializeProps(e,n);this.propsInTransition={};const a={duration:o,easing:t.transitionEasing||DEFAULT_EASING,interpolator:r,interruption:t.transitionInterruption||DEFAULT_INTERRUPTION,startProps:s.start,endProps:s.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(a),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),null==e||e(t)}}}class TransitionInterpolator{constructor(e){_defineProperty(this,"_propsToCompare",void 0),_defineProperty(this,"_propsToExtract",void 0),_defineProperty(this,"_requiredProps",void 0);const{compare:t,extract:i,required:n}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=n}arePropsEqual(e,t){for(const i of this._propsToCompare)if(!(i in e)||!(i in t)||!equals$1(e[i],t[i]))return!1;return!0}initializeProps(e,t){const i={},n={};for(const r of this._propsToExtract)(r in e||r in t)&&(i[r]=e[r],n[r]=t[r]);return this._checkRequiredProps(i),this._checkRequiredProps(n),{start:i,end:n}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach((t=>{const i=e[t];assert$4(Number.isFinite(i)||Array.isArray(i),"".concat(t," is required for transition"))}))}}const DEFAULT_PROPS$2=["longitude","latitude","zoom","bearing","pitch"],DEFAULT_REQUIRED_PROPS=["longitude","latitude","zoom"];class LinearInterpolator extends TransitionInterpolator{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:DEFAULT_PROPS$2,required:DEFAULT_REQUIRED_PROPS},super(i.transitionProps),_defineProperty(this,"opts",void 0),this.opts=i}initializeProps(e,t){const i=super.initializeProps(e,t),{makeViewport:n,around:r}=this.opts;if(n&&r){const o=n(e),s=n(t),a=o.unproject(r);i.start.around=r,Object.assign(i.end,{around:s.project(a),aroundPosition:a,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){const n={};for(const r of this._propsToExtract)n[r]=lerp$4(e[r]||0,t[r]||0,i);if(t.aroundPosition&&this.opts.makeViewport){const r=this.opts.makeViewport({...t,...n});Object.assign(n,r.panByPosition(t.aroundPosition,lerp$4(e.around,t.around,i)))}return n}}const NO_TRANSITION_PROPS={transitionDuration:0},DEFAULT_INERTIA=300,INERTIA_EASING=e=>1-(1-e)*(1-e),EVENT_TYPES={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},pinchEventWorkaround={};class Controller{constructor(e){_defineProperty(this,"props",void 0),_defineProperty(this,"state",{}),_defineProperty(this,"transitionManager",void 0),_defineProperty(this,"eventManager",void 0),_defineProperty(this,"onViewStateChange",void 0),_defineProperty(this,"onStateChange",void 0),_defineProperty(this,"makeViewport",void 0),_defineProperty(this,"_controllerState",void 0),_defineProperty(this,"_events",{}),_defineProperty(this,"_interactionState",{isDragging:!1}),_defineProperty(this,"_customEvents",[]),_defineProperty(this,"_eventStartBlocked",null),_defineProperty(this,"_panMove",!1),_defineProperty(this,"invertPan",!1),_defineProperty(this,"dragMode","rotate"),_defineProperty(this,"inertia",0),_defineProperty(this,"scrollZoom",!0),_defineProperty(this,"dragPan",!0),_defineProperty(this,"dragRotate",!0),_defineProperty(this,"doubleClickZoom",!0),_defineProperty(this,"touchZoom",!0),_defineProperty(this,"touchRotate",!1),_defineProperty(this,"keyboard",!0),this.transitionManager=new TransitionManager({...e,getControllerState:e=>new this.ControllerState(e),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(const t in this._events){var e;if(this._events[t])null===(e=this.eventManager)||void 0===e||e.off(t,this.handleEvent)}this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return!t&&this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return!t&&this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return!t&&this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"doubletap":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:i}=this.props,{offsetCenter:n}=e;return[n.x-t,n.y-i]}isPointInBounds(e,t){const{width:i,height:n}=this.props;if(t&&t.handled)return!1;const r=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=n;return r&&t&&t.stopPropagation(),r}isFunctionKeyPressed(e){const{srcEvent:t}=e;return Boolean(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout((()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)}),e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:!0===t?DEFAULT_INERTIA:0;const{scrollZoom:i=!0,dragPan:n=!0,dragRotate:r=!0,doubleClickZoom:o=!0,touchZoom:s=!0,touchRotate:a=!1,keyboard:l=!0}=e,c=Boolean(this.onViewStateChange);this.toggleEvents(EVENT_TYPES.WHEEL,c&&i),this.toggleEvents(EVENT_TYPES.PAN,c),this.toggleEvents(EVENT_TYPES.PINCH,c&&(s||a)),this.toggleEvents(EVENT_TYPES.TRIPLE_PAN,c&&a),this.toggleEvents(EVENT_TYPES.DOUBLE_TAP,c&&o),this.toggleEvents(EVENT_TYPES.KEYBOARD,c&&l),this.scrollZoom=i,this.dragPan=n,this.dragRotate=r,this.doubleClickZoom=o,this.touchZoom=s,this.touchRotate=a,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach((e=>{this._events[e]!==t&&(this._events[e]=t,t?this.eventManager.on(e,this.handleEvent):this.eventManager.off(e,this.handleEvent))}))}updateViewport(e,t=null,i={}){const n={...e.getViewportProps(),...t},r=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),r){const e=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:n,interactionState:this._interactionState,oldViewState:e})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||"pan"===this.dragMode)&&(i=!i);const n=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(n,NO_TRANSITION_PROPS,{isDragging:!0}),!0}_onPan(e){return!!this.isDragging()&&(this._panMove?this._onPanMove(e):this._onPanRotate(e))}_onPanEnd(e){return!!this.isDragging()&&(this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e))}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,NO_TRANSITION_PROPS,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const i=this.getCenter(e),n=this.controllerState.pan({pos:[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2]}).panEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:INERTIA_EASING},{isDragging:!1,isPanning:!0})}else{const e=this.controllerState.panEnd();this.updateViewport(e,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,NO_TRANSITION_PROPS,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const i=this.getCenter(e),n=this.controllerState.rotate({pos:[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2]}).rotateEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:INERTIA_EASING},{isDragging:!1,isRotating:!0})}else{const e=this.controllerState.rotateEnd();this.updateViewport(e,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:i=.01,smooth:n=!1}=!0===this.scrollZoom?{}:this.scrollZoom,{delta:r}=e;let o=2/(1+Math.exp(-Math.abs(r*i)));r<0&&0!==o&&(o=1/o);const s=this.controllerState.zoom({pos:t,scale:o});return this.updateViewport(s,{...this._getTransitionProps({around:t}),transitionDuration:n?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,NO_TRANSITION_PROPS,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate)return!1;if(!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const i=this.controllerState.rotate({pos:t});return this.updateViewport(i,NO_TRANSITION_PROPS,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const i=this.getCenter(e),n=[i[0],i[1]+=e.velocityY*t/2],r=this.controllerState.rotate({pos:n});this.updateViewport(r,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:INERTIA_EASING},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const e=this.controllerState.rotateEnd();this.updateViewport(e,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return pinchEventWorkaround._startPinchRotation=e.rotation,pinchEventWorkaround._lastPinchEvent=e,this.updateViewport(i,NO_TRANSITION_PROPS,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate)return!1;if(!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:i}=e,n=this.getCenter(e);t=t.zoom({pos:n,scale:i})}if(this.touchRotate){const{rotation:i}=e;t=t.rotate({deltaAngleX:pinchEventWorkaround._startPinchRotation-i})}return this.updateViewport(t,NO_TRANSITION_PROPS,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),pinchEventWorkaround._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:i}=pinchEventWorkaround;if(this.touchZoom&&t&&i&&e.scale!==i.scale){const n=this.getCenter(e);let r=this.controllerState.rotateEnd();const o=Math.log2(e.scale),s=(o-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),a=Math.pow(2,o+s*t/2);r=r.zoom({pos:n,scale:a}).zoomEnd(),this.updateViewport(r,{...this._getTransitionProps({around:n}),transitionDuration:t,transitionEasing:INERTIA_EASING},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const e=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(e,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return pinchEventWorkaround._startPinchRotation=null,pinchEventWorkaround._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.isFunctionKeyPressed(e),n=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(n,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:i,moveSpeed:n,rotateSpeedX:r,rotateSpeedY:o}=!0===this.keyboard?{}:this.keyboard,{controllerState:s}=this;let a;const l={};switch(e.srcEvent.code){case"Minus":a=t?s.zoomOut(i).zoomOut(i):s.zoomOut(i),l.isZooming=!0;break;case"Equal":a=t?s.zoomIn(i).zoomIn(i):s.zoomIn(i),l.isZooming=!0;break;case"ArrowLeft":t?(a=s.rotateLeft(r),l.isRotating=!0):(a=s.moveLeft(n),l.isPanning=!0);break;case"ArrowRight":t?(a=s.rotateRight(r),l.isRotating=!0):(a=s.moveRight(n),l.isPanning=!0);break;case"ArrowUp":t?(a=s.rotateUp(o),l.isRotating=!0):(a=s.moveUp(n),l.isPanning=!0);break;case"ArrowDown":t?(a=s.rotateDown(o),l.isRotating=!0):(a=s.moveDown(n),l.isPanning=!0);break;default:return!1}return this.updateViewport(a,this._getTransitionProps(),l),!0}_getTransitionProps(e){const{transition:t}=this;return t&&t.transitionInterpolator?e?{...t,transitionInterpolator:new LinearInterpolator({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t:NO_TRANSITION_PROPS}}class ViewState{constructor(e,t){_defineProperty(this,"_viewportProps",void 0),_defineProperty(this,"_state",void 0),this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const PITCH_MOUSE_THRESHOLD=5,PITCH_ACCEL=1.2;class MapState extends ViewState{constructor(e){const{width:t,height:i,latitude:n,longitude:r,zoom:o,bearing:s=0,pitch:a=0,altitude:l=1.5,position:c=[0,0,0],maxZoom:u=20,minZoom:h=0,maxPitch:d=60,minPitch:p=0,startPanLngLat:f,startZoomLngLat:m,startRotatePos:g,startBearing:_,startPitch:y,startZoom:v,normalize:x=!0}=e;assert$4(Number.isFinite(r)),assert$4(Number.isFinite(n)),assert$4(Number.isFinite(o)),super({width:t,height:i,latitude:n,longitude:r,zoom:o,bearing:s,pitch:a,altitude:l,maxZoom:u,minZoom:h,maxPitch:d,minPitch:p,normalize:x,position:c},{startPanLngLat:f,startZoomLngLat:m,startRotatePos:g,startBearing:_,startPitch:y,startZoom:v}),_defineProperty(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;const n=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(n)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){const{startRotatePos:n,startBearing:r,startPitch:o}=this.getState();if(!n||void 0===r||void 0===o)return this;let s;return s=e?this._getNewRotation(e,n,o,r):{bearing:r+t,pitch:o+i},this._getUpdatedState(s)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomLngLat:r}=this.getState();if(r||(n=this.getViewportProps().zoom,r=this._unproject(t)||this._unproject(e)),!r)return this;const{maxZoom:o,minZoom:s}=this.getViewportProps();let a=n+Math.log2(i);a=clamp$2(a,s,o);const l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(r,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:n,longitude:r}=i;return Math.abs(n-t.bearing)>180&&(i.bearing=n<0?n+360:n-360),Math.abs(r-t.longitude)>180&&(i.longitude=r<0?r+360:r-360),i}applyConstraints(e){const{maxZoom:t,minZoom:i,zoom:n}=e;e.zoom=clamp$2(n,i,t);const{maxPitch:r,minPitch:o,pitch:s}=e;e.pitch=clamp$2(s,o,r);const{normalize:a=!0}=e;return a&&Object.assign(e,normalizeViewportProps(e)),e}_zoomFromCenter(e){const{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){const{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,n){const r=e[0]-t[0],o=e[1]-t[1],s=e[1],a=t[1],{width:l,height:c}=this.getViewportProps(),u=r/l;let h=0;o>0?Math.abs(c-a)>PITCH_MOUSE_THRESHOLD&&(h=o/(a-c)*PITCH_ACCEL):o<0&&a>PITCH_MOUSE_THRESHOLD&&(h=1-s/a),h=clamp$2(h,-1,1);const{minPitch:d,maxPitch:p}=this.getViewportProps();let f=i;return h>0?f=i+h*(p-i):h<0&&(f=i-h*(d-i)),{pitch:f,bearing:n+180*u}}}class MapController extends Controller{constructor(...e){super(...e),_defineProperty(this,"ControllerState",MapState),_defineProperty(this,"transition",{transitionDuration:300,transitionInterpolator:new LinearInterpolator({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})}),_defineProperty(this,"dragMode","pan")}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e);(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class MapView extends View{get ViewportType(){return WebMercatorViewport}get ControllerType(){return MapController}}_defineProperty(MapView,"displayName","MapView");const DEFAULT_LIGHTING_EFFECT=new LightingEffect;function compareEffects(e,t){var i,n;return(null!==(i=e.order)&&void 0!==i?i:1/0)-(null!==(n=t.order)&&void 0!==n?n:1/0)}class EffectManager{constructor(){_defineProperty(this,"effects",void 0),_defineProperty(this,"_resolvedEffects",[]),_defineProperty(this,"_defaultEffects",[]),_defineProperty(this,"_needsRedraw",void 0),this.effects=[],this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find((t=>t.id===e.id))){const i=t.findIndex((t=>compareEffects(t,e)>0));i<0?t.push(e):t.splice(i,0,e),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(deepEqual(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const e of this.effects)t[e.id]=e;const i=[];for(const n of e){const e=t[n.id];e&&e!==n?e.setProps?(e.setProps(n.props),i.push(e)):(e.cleanup(),i.push(n)):i.push(n),delete t[n.id]}for(const e in t)t[e].cleanup();this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),e.some((e=>e instanceof LightingEffect))||this._resolvedEffects.push(DEFAULT_LIGHTING_EFFECT),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup();this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class DrawLayersPass extends LayersPass{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const TRACE_RENDER_LAYERS$1="deckRenderer.renderLayers";class DeckRenderer{constructor(e){_defineProperty(this,"gl",void 0),_defineProperty(this,"layerFilter",void 0),_defineProperty(this,"drawPickingColors",void 0),_defineProperty(this,"drawLayersPass",void 0),_defineProperty(this,"pickLayersPass",void 0),_defineProperty(this,"renderCount",void 0),_defineProperty(this,"_needsRedraw",void 0),_defineProperty(this,"renderBuffers",void 0),_defineProperty(this,"lastPostProcessEffect",void 0),this.gl=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new DrawLayersPass(e),this.pickLayersPass=new PickLayersPass(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e,target:e.target||Framebuffer.getDefaultFramebuffer(this.gl)};i.effects&&this._preRender(i.effects,i);const n=this.lastPostProcessEffect?this.renderBuffers[0]:i.target,r=t.render({...i,target:n});i.effects&&this._postRender(i.effects,i),this.renderCount++,debug(TRACE_RENDER_LAYERS$1,this,r,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const i of e)t.preRenderStats[i.id]=i.preRender(this.gl,t),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this;0===e.length&&e.push(new Framebuffer(this.gl),new Framebuffer(this.gl));for(const t of e)t.resize()}_postRender(e,t){const{renderBuffers:i}=this,n={...t,inputBuffer:i[0],swapBuffer:i[1],target:null};for(const r of e)if(r.postRender){if(r.id===this.lastPostProcessEffect){n.target=t.target,r.postRender(this.gl,n);break}const e=r.postRender(this.gl,n);n.inputBuffer=e,n.swapBuffer=e===i[0]?i[1]:i[0]}}}const NO_PICKED_OBJECT={pickedColor:null,pickedObjectIndex:-1};function getClosestObject({pickedColors:e,decodePickingColor:t,deviceX:i,deviceY:n,deviceRadius:r,deviceRect:o}){const{x:s,y:a,width:l,height:c}=o;let u=r*r,h=-1,d=0;for(let t=0;t<c;t++){const r=t+a-n,o=r*r;if(o>u)d+=4*l;else for(let t=0;t<l;t++){if(e[d+3]-1>=0){const e=t+s-i,n=e*e+o;n<=u&&(u=n,h=d)}d+=4}}if(h>=0){const i=e.slice(h,h+4),n=t(i);if(n){const e=Math.floor(h/4/l),t=h/4-e*l;return{...n,pickedColor:i,pickedX:s+t,pickedY:a+e}}}return NO_PICKED_OBJECT}function getUniqueObjects({pickedColors:e,decodePickingColor:t}){const i=new Map;if(e)for(let n=0;n<e.length;n+=4){if(e[n+3]-1>=0){const r=e.slice(n,n+4),o=r.join(",");if(!i.has(o)){const e=t(r);e&&i.set(o,{...e,color:r})}}}return Array.from(i.values())}function getEmptyPickingInfo({pickInfo:e,viewports:t,pixelRatio:i,x:n,y:r,z:o}){let s,a=t[0];if(t.length>1&&(a=getViewportFromCoordinates((null==e?void 0:e.pickedViewports)||t,{x:n,y:r})),a){const e=[n-a.x,r-a.y];void 0!==o&&(e[2]=o),s=a.unproject(e)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:n,y:r,pixel:[n,r],coordinate:s,devicePixel:e&&"pickedX"in e?[e.pickedX,e.pickedY]:void 0,pixelRatio:i}}function processPickInfo(e){const{pickInfo:t,lastPickedInfo:i,mode:n,layers:r}=e,{pickedColor:o,pickedLayer:s,pickedObjectIndex:a}=t,l=s?[s]:[];if("hover"===n){const e=i.layerId,t=s?s.props.id:null;if(t!==e||a!==i.index){if(t!==e){const t=r.find((t=>t.props.id===e));t&&l.unshift(t)}i.layerId=t,i.index=a,i.info=null}}const c=getEmptyPickingInfo(e),u=new Map;return u.set(null,c),l.forEach((e=>{let t={...c};e===s&&(t.color=o,t.index=a,t.picked=!0),t=getLayerPickingInfo({layer:e,info:t,mode:n});const r=t.layer;e===s&&"hover"===n&&(i.info=t),u.set(r.id,t),"hover"===n&&r.updateAutoHighlight(t)})),u}function getLayerPickingInfo({layer:e,info:t,mode:i}){for(;e&&t;){const n=t.layer||null;t.sourceLayer=n,t.layer=e,t=e.getPickingInfo({info:t,mode:i,sourceLayer:n}),e=e.parent}return t}function getViewportFromCoordinates(e,t){for(let i=e.length-1;i>=0;i--){const n=e[i];if(n.containsPixel(t))return n}return e[0]}class DeckPicker{constructor(e){_defineProperty(this,"gl",void 0),_defineProperty(this,"pickingFBO",void 0),_defineProperty(this,"depthFBO",void 0),_defineProperty(this,"pickLayersPass",void 0),_defineProperty(this,"layerFilter",void 0),_defineProperty(this,"lastPickedInfo",void 0),_defineProperty(this,"_pickable",!0),this.gl=e,this.pickLayersPass=new PickLayersPass(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:n},r=this.lastPickedInfo.info){const o=r&&r.layer&&r.layer.id,s=r&&r.viewport&&r.viewport.id,a=o?i.find((e=>e.id===o)):null,l=s&&n.find((e=>e.id===s))||n[0],c=l&&l.unproject([e-l.x,t-l.y]),u={x:e,y:t,viewport:l,coordinate:c,layer:a};return{...r,...u}}_resizeBuffer(){var e,t;const{gl:i}=this;if(!this.pickingFBO&&(this.pickingFBO=new Framebuffer(i),Framebuffer.isSupported(i,{colorBufferFloat:!0}))){const e=new Framebuffer(i);e.attach({36064:new Texture2D(i,{format:isWebGL2$1(i)?34836:6408,type:5126})}),this.depthFBO=e}null===(e=this.pickingFBO)||void 0===e||e.resize({width:i.canvas.width,height:i.canvas.height}),null===(t=this.depthFBO)||void 0===t||t.resize({width:i.canvas.width,height:i.canvas.height})}_getPickable(e){if(!1===this._pickable)return null;const t=e.filter((e=>this.pickLayersPass.shouldDrawLayer(e)&&!e.isComposite));return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:i,x:n,y:r,radius:o=0,depth:s=1,mode:a="query",unproject3D:l,onViewportActive:c,effects:u}){const h=this._getPickable(e),d=cssToDeviceRatio(this.gl);if(!h)return{result:[],emptyInfo:getEmptyPickingInfo({viewports:i,x:n,y:r,pixelRatio:d})};this._resizeBuffer();const p=cssToDevicePixels(this.gl,[n,r],!0),f=[p.x+Math.floor(p.width/2),p.y+Math.floor(p.height/2)],m=Math.round(o*d),{width:g,height:_}=this.pickingFBO,y=this._getPickingRect({deviceX:f[0],deviceY:f[1],deviceRadius:m,deviceWidth:g,deviceHeight:_}),v={x:n-o,y:r-o,width:2*o+1,height:2*o+1};let x;const b=[],T=new Set;for(let e=0;e<s;e++){let o,p;if(y){o=getClosestObject({...this._drawAndSample({layers:h,views:t,viewports:i,onViewportActive:c,deviceRect:y,cullRect:v,effects:u,pass:"picking:".concat(a)}),deviceX:f[0],deviceY:f[1],deviceRadius:m,deviceRect:y})}else o={pickedColor:null,pickedObjectIndex:-1};if(o.pickedLayer&&l&&this.depthFBO){const{pickedColors:e}=this._drawAndSample({layers:[o.pickedLayer],views:t,viewports:i,onViewportActive:c,deviceRect:{x:o.pickedX,y:o.pickedY,width:1,height:1},cullRect:v,effects:u,pass:"picking:".concat(a,":z")},!0);e[3]&&(p=e[0])}o.pickedLayer&&e+1<s&&(T.add(o.pickedLayer),o.pickedLayer.disablePickingIndex(o.pickedObjectIndex)),x=processPickInfo({pickInfo:o,lastPickedInfo:this.lastPickedInfo,mode:a,layers:h,viewports:i,x:n,y:r,z:p,pixelRatio:d});for(const e of x.values())e.layer&&b.push(e);if(!o.pickedColor)break}for(const e of T)e.restorePickingColors();return{result:b,emptyInfo:x.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:i,x:n,y:r,width:o=1,height:s=1,mode:a="query",maxObjects:l=null,onViewportActive:c,effects:u}){const h=this._getPickable(e);if(!h)return[];this._resizeBuffer();const d=cssToDeviceRatio(this.gl),p=cssToDevicePixels(this.gl,[n,r],!0),f=p.x,m=p.y+p.height,g=cssToDevicePixels(this.gl,[n+o,r+s],!0),_=g.y,y=getUniqueObjects(this._drawAndSample({layers:h,views:t,viewports:i,onViewportActive:c,deviceRect:{x:f,y:_,width:g.x+g.width-f,height:m-_},cullRect:{x:n,y:r,width:o,height:s},effects:u,pass:"picking:".concat(a)})),v=new Map,x=Number.isFinite(l);for(let e=0;e<y.length;e++){var b;if(x&&l&&v.size>=l)break;const t=y[e];let i={color:t.pickedColor,layer:null,index:t.pickedObjectIndex,picked:!0,x:n,y:r,pixelRatio:d};i=getLayerPickingInfo({layer:t.pickedLayer,info:i,mode:a});const o=null!==(b=i.object)&&void 0!==b?b:"".concat(i.layer.id,"[").concat(i.index,"]");v.has(o)||v.set(o,i)}return Array.from(v.values())}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:n,deviceRect:r,cullRect:o,effects:s,pass:a},l=!1){const c=l?this.depthFBO:this.pickingFBO,u={layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:n,pickingFBO:c,deviceRect:r,cullRect:o,effects:s,pass:a,pickZ:l,preRenderStats:{}};for(const e of s)e.useInPicking&&(u.preRenderStats[e.id]=e.preRender(this.gl,u));const{decodePickingColor:h}=this.pickLayersPass.render(u),{x:d,y:p,width:f,height:m}=r,g=new(l?Float32Array:Uint8Array)(f*m*4);return readPixelsToArray(c,{sourceX:d,sourceY:p,sourceWidth:f,sourceHeight:m,target:g}),{pickedColors:g,decodePickingColor:h}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:n,deviceHeight:r}){const o=Math.max(0,e-i),s=Math.max(0,t-i),a=Math.min(n,e+i+1)-o,l=Math.min(r,t+i+1)-s;return a<=0||l<=0?null:{x:o,y:s,width:a,height:l}}}const defaultStyle={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class Tooltip{constructor(e){_defineProperty(this,"el",null),_defineProperty(this,"isVisible",!1);const t=e.parentElement;t&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,defaultStyle),t.appendChild(this.el))}setTooltip(e,t,i){const n=this.el;if(n){if("string"==typeof e)n.innerText=e;else{if(!e)return this.isVisible=!1,void(n.style.display="none");e.text&&(n.innerText=e.text),e.html&&(n.innerHTML=e.html),e.className&&(n.className=e.className)}this.isVisible=!0,n.style.display="block",n.style.transform="translate(".concat(t,"px, ").concat(i,"px)"),e&&"object"==typeof e&&"style"in e&&Object.assign(n.style,e.style)}}remove(){this.el&&(this.el.remove(),this.el=null)}}var hammer={exports:{}},hasRequiredHammer;
/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */function requireHammer(){return hasRequiredHammer||(hasRequiredHammer=1,function(e){!function(t,i,n,r){var o,s=["","webkit","Moz","MS","ms","o"],a=i.createElement("div"),l=Math.round,c=Math.abs,u=Date.now;function h(e,t,i){return setTimeout(y(e,i),t)}function d(e,t,i){return!!Array.isArray(e)&&(p(e,i[t],i),!0)}function p(e,t,i){var n;if(e)if(e.forEach)e.forEach(t,i);else if(e.length!==r)for(n=0;n<e.length;)t.call(i,e[n],n,e),n++;else for(n in e)e.hasOwnProperty(n)&&t.call(i,e[n],n,e)}function f(e,i,n){var r="DEPRECATED METHOD: "+i+"\n"+n+" AT \n";return function(){var i=new Error("get-stack-trace"),n=i&&i.stack?i.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",o=t.console&&(t.console.warn||t.console.log);return o&&o.call(t.console,r,n),e.apply(this,arguments)}}o="function"!=typeof Object.assign?function(e){if(e===r||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),i=1;i<arguments.length;i++){var n=arguments[i];if(n!==r&&null!==n)for(var o in n)n.hasOwnProperty(o)&&(t[o]=n[o])}return t}:Object.assign;var m=f((function(e,t,i){for(var n=Object.keys(t),o=0;o<n.length;)(!i||i&&e[n[o]]===r)&&(e[n[o]]=t[n[o]]),o++;return e}),"extend","Use `assign`."),g=f((function(e,t){return m(e,t,!0)}),"merge","Use `assign`.");function _(e,t,i){var n,r=t.prototype;(n=e.prototype=Object.create(r)).constructor=e,n._super=r,i&&o(n,i)}function y(e,t){return function(){return e.apply(t,arguments)}}function v(e,t){return"function"==typeof e?e.apply(t&&t[0]||r,t):e}function x(e,t){return e===r?t:e}function b(e,t,i){p(S(t),(function(t){e.addEventListener(t,i,!1)}))}function T(e,t,i){p(S(t),(function(t){e.removeEventListener(t,i,!1)}))}function w(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1}function E(e,t){return e.indexOf(t)>-1}function S(e){return e.trim().split(/\s+/g)}function A(e,t,i){if(e.indexOf&&!i)return e.indexOf(t);for(var n=0;n<e.length;){if(i&&e[n][i]==t||!i&&e[n]===t)return n;n++}return-1}function M(e){return Array.prototype.slice.call(e,0)}function I(e,t,i){for(var n=[],r=[],o=0;o<e.length;){var s=e[o][t];A(r,s)<0&&n.push(e[o]),r[o]=s,o++}return n=n.sort((function(e,i){return e[t]>i[t]})),n}function C(e,t){for(var i,n,o=t[0].toUpperCase()+t.slice(1),a=0;a<s.length;){if((n=(i=s[a])?i+o:t)in e)return n;a++}return r}var P=1;function L(e){var i=e.ownerDocument||e;return i.defaultView||i.parentWindow||t}var R="ontouchstart"in t,O=C(t,"PointerEvent")!==r,D=R&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),B="touch",F="mouse",N=24,k=["x","y"],U=["clientX","clientY"];function z(e,t){var i=this;this.manager=e,this.callback=t,this.element=e.element,this.target=e.options.inputTarget,this.domHandler=function(t){v(e.options.enable,[e])&&i.handler(t)},this.init()}function V(e,t,i){var n=i.pointers.length,o=i.changedPointers.length,s=1&t&&n-o==0,a=12&t&&n-o==0;i.isFirst=!!s,i.isFinal=!!a,s&&(e.session={}),i.eventType=t,function(e,t){var i=e.session,n=t.pointers,o=n.length;i.firstInput||(i.firstInput=G(t));o>1&&!i.firstMultiple?i.firstMultiple=G(t):1===o&&(i.firstMultiple=!1);var s=i.firstInput,a=i.firstMultiple,l=a?a.center:s.center,h=t.center=j(n);t.timeStamp=u(),t.deltaTime=t.timeStamp-s.timeStamp,t.angle=q(l,h),t.distance=W(l,h),function(e,t){var i=t.center,n=e.offsetDelta||{},r=e.prevDelta||{},o=e.prevInput||{};1!==t.eventType&&4!==o.eventType||(r=e.prevDelta={x:o.deltaX||0,y:o.deltaY||0},n=e.offsetDelta={x:i.x,y:i.y});t.deltaX=r.x+(i.x-n.x),t.deltaY=r.y+(i.y-n.y)}(i,t),t.offsetDirection=$(t.deltaX,t.deltaY);var d=H(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=d.x,t.overallVelocityY=d.y,t.overallVelocity=c(d.x)>c(d.y)?d.x:d.y,t.scale=a?(p=a.pointers,f=n,W(f[0],f[1],U)/W(p[0],p[1],U)):1,t.rotation=a?function(e,t){return q(t[1],t[0],U)+q(e[1],e[0],U)}(a.pointers,n):0,t.maxPointers=i.prevInput?t.pointers.length>i.prevInput.maxPointers?t.pointers.length:i.prevInput.maxPointers:t.pointers.length,function(e,t){var i,n,o,s,a=e.lastInterval||t,l=t.timeStamp-a.timeStamp;if(8!=t.eventType&&(l>25||a.velocity===r)){var u=t.deltaX-a.deltaX,h=t.deltaY-a.deltaY,d=H(l,u,h);n=d.x,o=d.y,i=c(d.x)>c(d.y)?d.x:d.y,s=$(u,h),e.lastInterval=t}else i=a.velocity,n=a.velocityX,o=a.velocityY,s=a.direction;t.velocity=i,t.velocityX=n,t.velocityY=o,t.direction=s}(i,t);var p,f;var m=e.element;w(t.srcEvent.target,m)&&(m=t.srcEvent.target);t.target=m}(e,i),e.emit("hammer.input",i),e.recognize(i),e.session.prevInput=i}function G(e){for(var t=[],i=0;i<e.pointers.length;)t[i]={clientX:l(e.pointers[i].clientX),clientY:l(e.pointers[i].clientY)},i++;return{timeStamp:u(),pointers:t,center:j(t),deltaX:e.deltaX,deltaY:e.deltaY}}function j(e){var t=e.length;if(1===t)return{x:l(e[0].clientX),y:l(e[0].clientY)};for(var i=0,n=0,r=0;r<t;)i+=e[r].clientX,n+=e[r].clientY,r++;return{x:l(i/t),y:l(n/t)}}function H(e,t,i){return{x:t/e||0,y:i/e||0}}function $(e,t){return e===t?1:c(e)>=c(t)?e<0?2:4:t<0?8:16}function W(e,t,i){i||(i=k);var n=t[i[0]]-e[i[0]],r=t[i[1]]-e[i[1]];return Math.sqrt(n*n+r*r)}function q(e,t,i){return i||(i=k),180*Math.atan2(t[i[1]]-e[i[1]],t[i[0]]-e[i[0]])/Math.PI}z.prototype={handler:function(){},init:function(){this.evEl&&b(this.element,this.evEl,this.domHandler),this.evTarget&&b(this.target,this.evTarget,this.domHandler),this.evWin&&b(L(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&T(this.element,this.evEl,this.domHandler),this.evTarget&&T(this.target,this.evTarget,this.domHandler),this.evWin&&T(L(this.element),this.evWin,this.domHandler)}};var X={mousedown:1,mousemove:2,mouseup:4},Y="mousedown",Z="mousemove mouseup";function J(){this.evEl=Y,this.evWin=Z,this.pressed=!1,z.apply(this,arguments)}_(J,z,{handler:function(e){var t=X[e.type];1&t&&0===e.button&&(this.pressed=!0),2&t&&1!==e.which&&(t=4),this.pressed&&(4&t&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:F,srcEvent:e}))}});var K={pointerdown:1,pointermove:2,pointerup:4,pointercancel:8,pointerout:8},Q={2:B,3:"pen",4:F,5:"kinect"},ee="pointerdown",te="pointermove pointerup pointercancel";function ie(){this.evEl=ee,this.evWin=te,z.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}t.MSPointerEvent&&!t.PointerEvent&&(ee="MSPointerDown",te="MSPointerMove MSPointerUp MSPointerCancel"),_(ie,z,{handler:function(e){var t=this.store,i=!1,n=e.type.toLowerCase().replace("ms",""),r=K[n],o=Q[e.pointerType]||e.pointerType,s=o==B,a=A(t,e.pointerId,"pointerId");1&r&&(0===e.button||s)?a<0&&(t.push(e),a=t.length-1):12&r&&(i=!0),a<0||(t[a]=e,this.callback(this.manager,r,{pointers:t,changedPointers:[e],pointerType:o,srcEvent:e}),i&&t.splice(a,1))}});var ne={touchstart:1,touchmove:2,touchend:4,touchcancel:8};function re(){this.evTarget="touchstart",this.evWin="touchstart touchmove touchend touchcancel",this.started=!1,z.apply(this,arguments)}function oe(e,t){var i=M(e.touches),n=M(e.changedTouches);return 12&t&&(i=I(i.concat(n),"identifier")),[i,n]}_(re,z,{handler:function(e){var t=ne[e.type];if(1===t&&(this.started=!0),this.started){var i=oe.call(this,e,t);12&t&&i[0].length-i[1].length==0&&(this.started=!1),this.callback(this.manager,t,{pointers:i[0],changedPointers:i[1],pointerType:B,srcEvent:e})}}});var se={touchstart:1,touchmove:2,touchend:4,touchcancel:8},ae="touchstart touchmove touchend touchcancel";function le(){this.evTarget=ae,this.targetIds={},z.apply(this,arguments)}function ce(e,t){var i=M(e.touches),n=this.targetIds;if(3&t&&1===i.length)return n[i[0].identifier]=!0,[i,i];var r,o,s=M(e.changedTouches),a=[],l=this.target;if(o=i.filter((function(e){return w(e.target,l)})),1===t)for(r=0;r<o.length;)n[o[r].identifier]=!0,r++;for(r=0;r<s.length;)n[s[r].identifier]&&a.push(s[r]),12&t&&delete n[s[r].identifier],r++;return a.length?[I(o.concat(a),"identifier"),a]:void 0}_(le,z,{handler:function(e){var t=se[e.type],i=ce.call(this,e,t);i&&this.callback(this.manager,t,{pointers:i[0],changedPointers:i[1],pointerType:B,srcEvent:e})}});function ue(){z.apply(this,arguments);var e=y(this.handler,this);this.touch=new le(this.manager,e),this.mouse=new J(this.manager,e),this.primaryTouch=null,this.lastTouches=[]}function he(e,t){1&e?(this.primaryTouch=t.changedPointers[0].identifier,de.call(this,t)):12&e&&de.call(this,t)}function de(e){var t=e.changedPointers[0];if(t.identifier===this.primaryTouch){var i={x:t.clientX,y:t.clientY};this.lastTouches.push(i);var n=this.lastTouches;setTimeout((function(){var e=n.indexOf(i);e>-1&&n.splice(e,1)}),2500)}}function pe(e){for(var t=e.srcEvent.clientX,i=e.srcEvent.clientY,n=0;n<this.lastTouches.length;n++){var r=this.lastTouches[n],o=Math.abs(t-r.x),s=Math.abs(i-r.y);if(o<=25&&s<=25)return!0}return!1}_(ue,z,{handler:function(e,t,i){var n=i.pointerType==F;if(!(n&&i.sourceCapabilities&&i.sourceCapabilities.firesTouchEvents)){if(i.pointerType==B)he.call(this,t,i);else if(n&&pe.call(this,i))return;this.callback(e,t,i)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var fe=C(a.style,"touchAction"),me=fe!==r,ge="compute",_e="auto",ye="manipulation",ve="none",xe="pan-x",be="pan-y",Te=function(){if(!me)return!1;var e={},i=t.CSS&&t.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach((function(n){e[n]=!i||t.CSS.supports("touch-action",n)})),e}();function we(e,t){this.manager=e,this.set(t)}we.prototype={set:function(e){e==ge&&(e=this.compute()),me&&this.manager.element.style&&Te[e]&&(this.manager.element.style[fe]=e),this.actions=e.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var e=[];return p(this.manager.recognizers,(function(t){v(t.options.enable,[t])&&(e=e.concat(t.getTouchAction()))})),function(e){if(E(e,ve))return ve;var t=E(e,xe),i=E(e,be);if(t&&i)return ve;if(t||i)return t?xe:be;if(E(e,ye))return ye;return _e}(e.join(" "))},preventDefaults:function(e){var t=e.srcEvent,i=e.offsetDirection;if(this.manager.session.prevented)t.preventDefault();else{var n=this.actions,r=E(n,ve)&&!Te[ve],o=E(n,be)&&!Te[be],s=E(n,xe)&&!Te[xe];if(r)if(1===e.pointers.length&&e.distance<2&&e.deltaTime<250)return;if(!s||!o)return r||o&&6&i||s&&i&N?this.preventSrc(t):void 0}},preventSrc:function(e){this.manager.session.prevented=!0,e.preventDefault()}};var Ee=32;function Se(e){this.options=o({},this.defaults,e||{}),this.id=P++,this.manager=null,this.options.enable=x(this.options.enable,!0),this.state=1,this.simultaneous={},this.requireFail=[]}function Ae(e){return 16&e?"cancel":8&e?"end":4&e?"move":2&e?"start":""}function Me(e){return 16==e?"down":8==e?"up":2==e?"left":4==e?"right":""}function Ie(e,t){var i=t.manager;return i?i.get(e):e}function Ce(){Se.apply(this,arguments)}function Pe(){Ce.apply(this,arguments),this.pX=null,this.pY=null}function Le(){Ce.apply(this,arguments)}function Re(){Se.apply(this,arguments),this._timer=null,this._input=null}function Oe(){Ce.apply(this,arguments)}function De(){Ce.apply(this,arguments)}function Be(){Se.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function Fe(e,t){return(t=t||{}).recognizers=x(t.recognizers,Fe.defaults.preset),new Ne(e,t)}Se.prototype={defaults:{},set:function(e){return o(this.options,e),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(e){if(d(e,"recognizeWith",this))return this;var t=this.simultaneous;return t[(e=Ie(e,this)).id]||(t[e.id]=e,e.recognizeWith(this)),this},dropRecognizeWith:function(e){return d(e,"dropRecognizeWith",this)||(e=Ie(e,this),delete this.simultaneous[e.id]),this},requireFailure:function(e){if(d(e,"requireFailure",this))return this;var t=this.requireFail;return-1===A(t,e=Ie(e,this))&&(t.push(e),e.requireFailure(this)),this},dropRequireFailure:function(e){if(d(e,"dropRequireFailure",this))return this;e=Ie(e,this);var t=A(this.requireFail,e);return t>-1&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(e){return!!this.simultaneous[e.id]},emit:function(e){var t=this,i=this.state;function n(i){t.manager.emit(i,e)}i<8&&n(t.options.event+Ae(i)),n(t.options.event),e.additionalEvent&&n(e.additionalEvent),i>=8&&n(t.options.event+Ae(i))},tryEmit:function(e){if(this.canEmit())return this.emit(e);this.state=Ee},canEmit:function(){for(var e=0;e<this.requireFail.length;){if(!(33&this.requireFail[e].state))return!1;e++}return!0},recognize:function(e){var t=o({},e);if(!v(this.options.enable,[this,t]))return this.reset(),void(this.state=Ee);56&this.state&&(this.state=1),this.state=this.process(t),30&this.state&&this.tryEmit(t)},process:function(e){},getTouchAction:function(){},reset:function(){}},_(Ce,Se,{defaults:{pointers:1},attrTest:function(e){var t=this.options.pointers;return 0===t||e.pointers.length===t},process:function(e){var t=this.state,i=e.eventType,n=6&t,r=this.attrTest(e);return n&&(8&i||!r)?16|t:n||r?4&i?8|t:2&t?4|t:2:Ee}}),_(Pe,Ce,{defaults:{event:"pan",threshold:10,pointers:1,direction:30},getTouchAction:function(){var e=this.options.direction,t=[];return 6&e&&t.push(be),e&N&&t.push(xe),t},directionTest:function(e){var t=this.options,i=!0,n=e.distance,r=e.direction,o=e.deltaX,s=e.deltaY;return r&t.direction||(6&t.direction?(r=0===o?1:o<0?2:4,i=o!=this.pX,n=Math.abs(e.deltaX)):(r=0===s?1:s<0?8:16,i=s!=this.pY,n=Math.abs(e.deltaY))),e.direction=r,i&&n>t.threshold&&r&t.direction},attrTest:function(e){return Ce.prototype.attrTest.call(this,e)&&(2&this.state||!(2&this.state)&&this.directionTest(e))},emit:function(e){this.pX=e.deltaX,this.pY=e.deltaY;var t=Me(e.direction);t&&(e.additionalEvent=this.options.event+t),this._super.emit.call(this,e)}}),_(Le,Ce,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[ve]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.scale-1)>this.options.threshold||2&this.state)},emit:function(e){1!==e.scale&&(e.additionalEvent=this.options.event+(e.scale<1?"in":"out"));this._super.emit.call(this,e)}}),_(Re,Se,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[_e]},process:function(e){var t=this.options,i=e.pointers.length===t.pointers,n=e.distance<t.threshold,r=e.deltaTime>t.time;if(this._input=e,!n||!i||12&e.eventType&&!r)this.reset();else if(1&e.eventType)this.reset(),this._timer=h((function(){this.state=8,this.tryEmit()}),t.time,this);else if(4&e.eventType)return 8;return Ee},reset:function(){clearTimeout(this._timer)},emit:function(e){8===this.state&&(e&&4&e.eventType?this.manager.emit(this.options.event+"up",e):(this._input.timeStamp=u(),this.manager.emit(this.options.event,this._input)))}}),_(Oe,Ce,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[ve]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.rotation)>this.options.threshold||2&this.state)}}),_(De,Ce,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:30,pointers:1},getTouchAction:function(){return Pe.prototype.getTouchAction.call(this)},attrTest:function(e){var t,i=this.options.direction;return 30&i?t=e.overallVelocity:6&i?t=e.overallVelocityX:i&N&&(t=e.overallVelocityY),this._super.attrTest.call(this,e)&&i&e.offsetDirection&&e.distance>this.options.threshold&&e.maxPointers==this.options.pointers&&c(t)>this.options.velocity&&4&e.eventType},emit:function(e){var t=Me(e.offsetDirection);t&&this.manager.emit(this.options.event+t,e),this.manager.emit(this.options.event,e)}}),_(Be,Se,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ye]},process:function(e){var t=this.options,i=e.pointers.length===t.pointers,n=e.distance<t.threshold,r=e.deltaTime<t.time;if(this.reset(),1&e.eventType&&0===this.count)return this.failTimeout();if(n&&r&&i){if(4!=e.eventType)return this.failTimeout();var o=!this.pTime||e.timeStamp-this.pTime<t.interval,s=!this.pCenter||W(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,s&&o?this.count+=1:this.count=1,this._input=e,0===this.count%t.taps)return this.hasRequireFailures()?(this._timer=h((function(){this.state=8,this.tryEmit()}),t.interval,this),2):8}return Ee},failTimeout:function(){return this._timer=h((function(){this.state=Ee}),this.options.interval,this),Ee},reset:function(){clearTimeout(this._timer)},emit:function(){8==this.state&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),Fe.VERSION="2.0.7",Fe.defaults={domEvents:!1,touchAction:ge,enable:!0,inputTarget:null,inputClass:null,preset:[[Oe,{enable:!1}],[Le,{enable:!1},["rotate"]],[De,{direction:6}],[Pe,{direction:6},["swipe"]],[Be],[Be,{event:"doubletap",taps:2},["tap"]],[Re]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};function Ne(e,t){var i;this.options=o({},Fe.defaults,t||{}),this.options.inputTarget=this.options.inputTarget||e,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new((i=this).options.inputClass||(O?ie:D?le:R?ue:J))(i,V),this.touchAction=new we(this,this.options.touchAction),ke(this,!0),p(this.options.recognizers,(function(e){var t=this.add(new e[0](e[1]));e[2]&&t.recognizeWith(e[2]),e[3]&&t.requireFailure(e[3])}),this)}function ke(e,t){var i,n=e.element;n.style&&(p(e.options.cssProps,(function(r,o){i=C(n.style,o),t?(e.oldCssProps[i]=n.style[i],n.style[i]=r):n.style[i]=e.oldCssProps[i]||""})),t||(e.oldCssProps={}))}Ne.prototype={set:function(e){return o(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this},stop:function(e){this.session.stopped=e?2:1},recognize:function(e){var t=this.session;if(!t.stopped){var i;this.touchAction.preventDefaults(e);var n=this.recognizers,r=t.curRecognizer;(!r||r&&8&r.state)&&(r=t.curRecognizer=null);for(var o=0;o<n.length;)i=n[o],2===t.stopped||r&&i!=r&&!i.canRecognizeWith(r)?i.reset():i.recognize(e),!r&&14&i.state&&(r=t.curRecognizer=i),o++}},get:function(e){if(e instanceof Se)return e;for(var t=this.recognizers,i=0;i<t.length;i++)if(t[i].options.event==e)return t[i];return null},add:function(e){if(d(e,"add",this))return this;var t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e},remove:function(e){if(d(e,"remove",this))return this;if(e=this.get(e)){var t=this.recognizers,i=A(t,e);-1!==i&&(t.splice(i,1),this.touchAction.update())}return this},on:function(e,t){if(e!==r&&t!==r){var i=this.handlers;return p(S(e),(function(e){i[e]=i[e]||[],i[e].push(t)})),this}},off:function(e,t){if(e!==r){var i=this.handlers;return p(S(e),(function(e){t?i[e]&&i[e].splice(A(i[e],t),1):delete i[e]})),this}},emit:function(e,t){this.options.domEvents&&function(e,t){var n=i.createEvent("Event");n.initEvent(e,!0,!0),n.gesture=t,t.target.dispatchEvent(n)}(e,t);var n=this.handlers[e]&&this.handlers[e].slice();if(n&&n.length){t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};for(var r=0;r<n.length;)n[r](t),r++}},destroy:function(){this.element&&ke(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},o(Fe,{INPUT_START:1,INPUT_MOVE:2,INPUT_END:4,INPUT_CANCEL:8,STATE_POSSIBLE:1,STATE_BEGAN:2,STATE_CHANGED:4,STATE_ENDED:8,STATE_RECOGNIZED:8,STATE_CANCELLED:16,STATE_FAILED:Ee,DIRECTION_NONE:1,DIRECTION_LEFT:2,DIRECTION_RIGHT:4,DIRECTION_UP:8,DIRECTION_DOWN:16,DIRECTION_HORIZONTAL:6,DIRECTION_VERTICAL:N,DIRECTION_ALL:30,Manager:Ne,Input:z,TouchAction:we,TouchInput:le,MouseInput:J,PointerEventInput:ie,TouchMouseInput:ue,SingleTouchInput:re,Recognizer:Se,AttrRecognizer:Ce,Tap:Be,Pan:Pe,Swipe:De,Pinch:Le,Rotate:Oe,Press:Re,on:b,off:T,each:p,merge:g,extend:m,assign:o,inherit:_,bindFn:y,prefixed:C}),(void 0!==t?t:"undefined"!=typeof self?self:{}).Hammer=Fe,e.exports?e.exports=Fe:t.Hammer=Fe}(window,document)}(hammer)),hammer.exports}var hammerExports=requireHammer(),hammerjs=_mergeNamespaces({__proto__:null},[hammerExports]);const INPUT_START=1,INPUT_MOVE=2,INPUT_END=4,MOUSE_INPUT_MAP={mousedown:INPUT_START,mousemove:INPUT_MOVE,mouseup:INPUT_END};function some(e,t){for(let i=0;i<e.length;i++)if(t(e[i]))return!0;return!1}function enhancePointerEventInput(e){const t=e.prototype.handler;e.prototype.handler=function(e){const i=this.store;e.button>0&&"pointerdown"===e.type&&(some(i,(t=>t.pointerId===e.pointerId))||i.push(e)),t.call(this,e)}}function enhanceMouseInput(e){e.prototype.handler=function(e){let t=MOUSE_INPUT_MAP[e.type];t&INPUT_START&&e.button>=0&&(this.pressed=!0),t&INPUT_MOVE&&0===e.buttons&&(t=INPUT_END),this.pressed&&(t&INPUT_END&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:"mouse",srcEvent:e}))}}enhancePointerEventInput(hammerExports.PointerEventInput),enhanceMouseInput(hammerExports.MouseInput);const Manager=hammerExports.Manager;class Input{constructor(e,t,i){this.element=e,this.callback=t,this.options={enable:!0,...i}}}const RECOGNIZERS=hammerjs?[[hammerjs.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[hammerjs.Rotate,{enable:!1}],[hammerjs.Pinch,{enable:!1}],[hammerjs.Swipe,{enable:!1}],[hammerjs.Pan,{threshold:0,enable:!1}],[hammerjs.Press,{enable:!1}],[hammerjs.Tap,{event:"doubletap",taps:2,enable:!1}],[hammerjs.Tap,{event:"anytap",enable:!1}],[hammerjs.Tap,{enable:!1}]]:null,RECOGNIZER_COMPATIBLE_MAP={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},RECOGNIZER_FALLBACK_MAP={doubletap:["tap"]},BASIC_EVENT_ALIASES={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},INPUT_EVENT_TYPES={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},EVENT_RECOGNIZER_MAP={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},GESTURE_EVENT_ALIASES={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"},userAgent="undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"",window_="undefined"!=typeof window?window:global;let passiveSupported=!1;try{const e={get passive(){return passiveSupported=!0,!0}};window_.addEventListener("test",null,e),window_.removeEventListener("test",null)}catch(err){passiveSupported=!1}const firefox=-1!==userAgent.indexOf("firefox"),{WHEEL_EVENTS:WHEEL_EVENTS}=INPUT_EVENT_TYPES,EVENT_TYPE$1="wheel",WHEEL_DELTA_MAGIC_SCALER=4.000244140625,WHEEL_DELTA_PER_LINE=40,SHIFT_MULTIPLIER=.25;class WheelInput extends Input{constructor(e,t,i){super(e,t,i),this.handleEvent=e=>{if(!this.options.enable)return;let t=e.deltaY;window_.WheelEvent&&(firefox&&e.deltaMode===window_.WheelEvent.DOM_DELTA_PIXEL&&(t/=window_.devicePixelRatio),e.deltaMode===window_.WheelEvent.DOM_DELTA_LINE&&(t*=WHEEL_DELTA_PER_LINE)),0!==t&&t%WHEEL_DELTA_MAGIC_SCALER==0&&(t=Math.floor(t/WHEEL_DELTA_MAGIC_SCALER)),e.shiftKey&&t&&(t*=SHIFT_MULTIPLIER),this.callback({type:EVENT_TYPE$1,center:{x:e.clientX,y:e.clientY},delta:-t,srcEvent:e,pointerType:"mouse",target:e.target})},this.events=(this.options.events||[]).concat(WHEEL_EVENTS),this.events.forEach((t=>e.addEventListener(t,this.handleEvent,!!passiveSupported&&{passive:!1})))}destroy(){this.events.forEach((e=>this.element.removeEventListener(e,this.handleEvent)))}enableEventType(e,t){e===EVENT_TYPE$1&&(this.options.enable=t)}}const{MOUSE_EVENTS:MOUSE_EVENTS$1}=INPUT_EVENT_TYPES,MOVE_EVENT_TYPE="pointermove",OVER_EVENT_TYPE="pointerover",OUT_EVENT_TYPE="pointerout",ENTER_EVENT_TYPE="pointerenter",LEAVE_EVENT_TYPE="pointerleave";class MoveInput extends Input{constructor(e,t,i){super(e,t,i),this.handleEvent=e=>{this.handleOverEvent(e),this.handleOutEvent(e),this.handleEnterEvent(e),this.handleLeaveEvent(e),this.handleMoveEvent(e)},this.pressed=!1;const{enable:n}=this.options;this.enableMoveEvent=n,this.enableLeaveEvent=n,this.enableEnterEvent=n,this.enableOutEvent=n,this.enableOverEvent=n,this.events=(this.options.events||[]).concat(MOUSE_EVENTS$1),this.events.forEach((t=>e.addEventListener(t,this.handleEvent)))}destroy(){this.events.forEach((e=>this.element.removeEventListener(e,this.handleEvent)))}enableEventType(e,t){e===MOVE_EVENT_TYPE&&(this.enableMoveEvent=t),e===OVER_EVENT_TYPE&&(this.enableOverEvent=t),e===OUT_EVENT_TYPE&&(this.enableOutEvent=t),e===ENTER_EVENT_TYPE&&(this.enableEnterEvent=t),e===LEAVE_EVENT_TYPE&&(this.enableLeaveEvent=t)}handleOverEvent(e){this.enableOverEvent&&"mouseover"===e.type&&this._emit(OVER_EVENT_TYPE,e)}handleOutEvent(e){this.enableOutEvent&&"mouseout"===e.type&&this._emit(OUT_EVENT_TYPE,e)}handleEnterEvent(e){this.enableEnterEvent&&"mouseenter"===e.type&&this._emit(ENTER_EVENT_TYPE,e)}handleLeaveEvent(e){this.enableLeaveEvent&&"mouseleave"===e.type&&this._emit(LEAVE_EVENT_TYPE,e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":0===e.buttons&&(this.pressed=!1),this.pressed||this._emit(MOVE_EVENT_TYPE,e);break;case"mouseup":this.pressed=!1}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const{KEY_EVENTS:KEY_EVENTS}=INPUT_EVENT_TYPES,DOWN_EVENT_TYPE="keydown",UP_EVENT_TYPE="keyup";class KeyInput extends Input{constructor(e,t,i){super(e,t,i),this.handleEvent=e=>{const t=e.target||e.srcElement;"INPUT"===t.tagName&&"text"===t.type||"TEXTAREA"===t.tagName||(this.enableDownEvent&&"keydown"===e.type&&this.callback({type:DOWN_EVENT_TYPE,srcEvent:e,key:e.key,target:e.target}),this.enableUpEvent&&"keyup"===e.type&&this.callback({type:UP_EVENT_TYPE,srcEvent:e,key:e.key,target:e.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(KEY_EVENTS),e.tabIndex=this.options.tabIndex||0,e.style.outline="none",this.events.forEach((t=>e.addEventListener(t,this.handleEvent)))}destroy(){this.events.forEach((e=>this.element.removeEventListener(e,this.handleEvent)))}enableEventType(e,t){e===DOWN_EVENT_TYPE&&(this.enableDownEvent=t),e===UP_EVENT_TYPE&&(this.enableUpEvent=t)}}const EVENT_TYPE="contextmenu";class ContextmenuInput extends Input{constructor(e,t,i){super(e,t,i),this.handleEvent=e=>{this.options.enable&&this.callback({type:EVENT_TYPE,center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e===EVENT_TYPE&&(this.options.enable=t)}}const DOWN_EVENT=1,MOVE_EVENT=2,UP_EVENT=4,MOUSE_EVENTS={pointerdown:DOWN_EVENT,pointermove:MOVE_EVENT,pointerup:UP_EVENT,mousedown:DOWN_EVENT,mousemove:MOVE_EVENT,mouseup:UP_EVENT},MOUSE_EVENT_BUTTON_LEFT=0,MOUSE_EVENT_BUTTON_MIDDLE=1,MOUSE_EVENT_BUTTON_RIGHT=2,MOUSE_EVENT_BUTTONS_LEFT_MASK=1,MOUSE_EVENT_BUTTONS_RIGHT_MASK=2,MOUSE_EVENT_BUTTONS_MIDDLE_MASK=4;function whichButtons(e){const t=MOUSE_EVENTS[e.srcEvent.type];if(!t)return null;const{buttons:i,button:n}=e.srcEvent;let r=!1,o=!1,s=!1;return t===MOVE_EVENT?(r=Boolean(i&MOUSE_EVENT_BUTTONS_LEFT_MASK),o=Boolean(i&MOUSE_EVENT_BUTTONS_MIDDLE_MASK),s=Boolean(i&MOUSE_EVENT_BUTTONS_RIGHT_MASK)):(r=n===MOUSE_EVENT_BUTTON_LEFT,o=n===MOUSE_EVENT_BUTTON_MIDDLE,s=n===MOUSE_EVENT_BUTTON_RIGHT),{leftButton:r,middleButton:o,rightButton:s}}function getOffsetPosition(e,t){const i=e.center;if(!i)return null;const n=t.getBoundingClientRect();return{center:i,offsetCenter:{x:(i.x-n.left-t.clientLeft)/(n.width/t.offsetWidth||1),y:(i.y-n.top-t.clientTop)/(n.height/t.offsetHeight||1)}}}const DEFAULT_OPTIONS$2={srcElement:"root",priority:0};class EventRegistrar{constructor(e){this.handleEvent=e=>{if(this.isEmpty())return;const t=this._normalizeEvent(e);let i=e.srcEvent.target;for(;i&&i!==t.rootElement;){if(this._emit(t,i),t.handled)return;i=i.parentNode}this._emit(t,"root")},this.eventManager=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,n=!1,r=!1){const{handlers:o,handlersByElement:s}=this;let a=DEFAULT_OPTIONS$2;"string"==typeof i||i&&i.addEventListener?a={...DEFAULT_OPTIONS$2,srcElement:i}:i&&(a={...DEFAULT_OPTIONS$2,...i});let l=s.get(a.srcElement);l||(l=[],s.set(a.srcElement,l));const c={type:e,handler:t,srcElement:a.srcElement,priority:a.priority};n&&(c.once=!0),r&&(c.passive=!0),o.push(c),this._active=this._active||!c.passive;let u=l.length-1;for(;u>=0&&!(l[u].priority>=c.priority);)u--;l.splice(u+1,0,c)}remove(e,t){const{handlers:i,handlersByElement:n}=this;for(let r=i.length-1;r>=0;r--){const o=i[r];if(o.type===e&&o.handler===t){i.splice(r,1);const e=n.get(o.srcElement);e.splice(e.indexOf(o),1),0===e.length&&n.delete(o.srcElement)}}this._active=i.some((e=>!e.passive))}_emit(e,t){const i=this.handlersByElement.get(t);if(i){let t=!1;const n=()=>{e.handled=!0},r=()=>{e.handled=!0,t=!0},o=[];for(let s=0;s<i.length;s++){const{type:a,handler:l,once:c}=i[s];if(l({...e,type:a,stopPropagation:n,stopImmediatePropagation:r}),c&&o.push(i[s]),t)break}for(let e=0;e<o.length;e++){const{type:t,handler:i}=o[e];this.remove(t,i)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...whichButtons(e),...getOffsetPosition(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}const DEFAULT_OPTIONS$1={events:null,recognizers:null,recognizerOptions:{},Manager:Manager,touchAction:"none",tabIndex:0};class EventManager{constructor(e=null,t){this._onBasicInput=e=>{const{srcEvent:t}=e,i=BASIC_EVENT_ALIASES[t.type];i&&this.manager.emit(i,e)},this._onOtherEvent=e=>{this.manager.emit(e.type,e)},this.options={...DEFAULT_OPTIONS$1,...t},this.events=new Map,this.setElement(e);const{events:i}=this.options;i&&this.on(i)}getElement(){return this.element}setElement(e){if(this.element&&this.destroy(),this.element=e,!e)return;const{options:t}=this;this.manager=new(0,t.Manager)(e,{touchAction:t.touchAction,recognizers:t.recognizers||RECOGNIZERS}).on("hammer.input",this._onBasicInput),t.recognizers||Object.keys(RECOGNIZER_COMPATIBLE_MAP).forEach((e=>{const t=this.manager.get(e);t&&RECOGNIZER_COMPATIBLE_MAP[e].forEach((e=>{t.recognizeWith(e)}))}));for(const e in t.recognizerOptions){const i=this.manager.get(e);if(i){const n=t.recognizerOptions[e];delete n.enable,i.set(n)}}this.wheelInput=new WheelInput(e,this._onOtherEvent,{enable:!1}),this.moveInput=new MoveInput(e,this._onOtherEvent,{enable:!1}),this.keyInput=new KeyInput(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new ContextmenuInput(e,this._onOtherEvent,{enable:!1});for(const[e,t]of this.events)t.isEmpty()||(this._toggleRecognizer(t.recognizerName,!0),this.manager.on(e,t.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){const{manager:i}=this;if(!i)return;const n=i.get(e);if(n&&n.options.enable!==t){n.set({enable:t});const r=RECOGNIZER_FALLBACK_MAP[e];r&&!this.options.recognizers&&r.forEach((r=>{const o=i.get(r);t?(o.requireFailure(e),n.dropRequireFailure(r)):o.dropRequireFailure(e)}))}this.wheelInput.enableEventType(e,t),this.moveInput.enableEventType(e,t),this.keyInput.enableEventType(e,t),this.contextmenuInput.enableEventType(e,t)}_addEventHandler(e,t,i,n,r){if("string"!=typeof e){i=t;for(const t in e)this._addEventHandler(t,e[t],i,n,r);return}const{manager:o,events:s}=this,a=GESTURE_EVENT_ALIASES[e]||e;let l=s.get(a);l||(l=new EventRegistrar(this),s.set(a,l),l.recognizerName=EVENT_RECOGNIZER_MAP[a]||a,o&&o.on(a,l.handleEvent)),l.add(e,t,i,n,r),l.isEmpty()||this._toggleRecognizer(l.recognizerName,!0)}_removeEventHandler(e,t){if("string"!=typeof e){for(const t in e)this._removeEventHandler(t,e[t]);return}const{events:i}=this,n=i.get(GESTURE_EVENT_ALIASES[e]||e);if(n&&(n.remove(e,t),n.isEmpty())){const{recognizerName:e}=n;let t=!1;for(const n of i.values())if(n.recognizerName===e&&!n.isEmpty()){t=!0;break}t||this._toggleRecognizer(e,!1)}}}function noop$1(){}const getCursor=({isDragging:e})=>e?"grabbing":"grab",defaultProps$e={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,glOptions:{},parameters:{},parent:null,gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,onWebGLInitialized:noop$1,onResize:noop$1,onViewStateChange:noop$1,onInteractionStateChange:noop$1,onBeforeRender:noop$1,onAfterRender:noop$1,onLoad:noop$1,onError:e=>{},onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:getCursor,getTooltip:null,debug:!1,drawPickingColors:!1};class Deck{constructor(e){_defineProperty(this,"props",void 0),_defineProperty(this,"width",0),_defineProperty(this,"height",0),_defineProperty(this,"userData",{}),_defineProperty(this,"canvas",null),_defineProperty(this,"viewManager",null),_defineProperty(this,"layerManager",null),_defineProperty(this,"effectManager",null),_defineProperty(this,"deckRenderer",null),_defineProperty(this,"deckPicker",null),_defineProperty(this,"eventManager",null),_defineProperty(this,"tooltip",null),_defineProperty(this,"metrics",void 0),_defineProperty(this,"animationLoop",void 0),_defineProperty(this,"stats",void 0),_defineProperty(this,"viewState",void 0),_defineProperty(this,"cursorState",void 0),_defineProperty(this,"_needsRedraw",void 0),_defineProperty(this,"_pickRequest",void 0),_defineProperty(this,"_lastPointerDownInfo",null),_defineProperty(this,"_metricsCounter",void 0),_defineProperty(this,"_onPointerMove",(e=>{const{_pickRequest:t}=this;if("pointerleave"===e.type)t.x=-1,t.y=-1,t.radius=0;else{if(e.leftButton||e.rightButton)return;{const i=e.offsetCenter;if(!i)return;t.x=i.x,t.y=i.y,t.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:t.x,y:t.y}),t.event=e})),_defineProperty(this,"_onEvent",(e=>{const t=EVENTS[e.type],i=e.offsetCenter;if(!t||!i||!this.layerManager)return;const n=this.layerManager.getLayers(),r=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:n,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:o}=r,s=o&&(o[t.handler]||o.props[t.handler]),a=this.props[t.handler];let l=!1;s&&(l=s.call(o,r,e)),!l&&a&&a(r,e)})),_defineProperty(this,"_onPointerDown",(e=>{const t=e.offsetCenter,i=this._pick("pickObject","pickObject Time",{x:t.x,y:t.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=i.result[0]||i.emptyInfo})),this.props={...defaultProps$e,...e},e=this.props,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this.cursorState={isHovering:!1,isDragging:!1},e.viewState&&e.initialViewState&&log$3.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),"IE"===getBrowser$1()&&log$3.warn("IE 11 is not supported")(),this.viewState=e.initialViewState,e.gl||"undefined"!=typeof document&&(this.canvas=this._createCanvas(e)),this.animationLoop=this._createAnimationLoop(e),this.stats=new Stats({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(e),e._typedArrayManagerProps&&defaultTypedArrayManager.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,i,n,r,o,s,a,l;(null===(e=this.animationLoop)||void 0===e||e.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,null===(t=this.layerManager)||void 0===t||t.finalize(),this.layerManager=null,null===(i=this.viewManager)||void 0===i||i.finalize(),this.viewManager=null,null===(n=this.effectManager)||void 0===n||n.finalize(),this.effectManager=null,null===(r=this.deckRenderer)||void 0===r||r.finalize(),this.deckRenderer=null,null===(o=this.deckPicker)||void 0===o||o.finalize(),this.deckPicker=null,null===(s=this.eventManager)||void 0===s||s.destroy(),this.eventManager=null,null===(a=this.tooltip)||void 0===a||a.remove(),this.tooltip=null,this.props.canvas||this.props.gl||!this.canvas)||(null===(l=this.canvas.parentElement)||void 0===l||l.removeChild(this.canvas),this.canvas=null)}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&log$3.removed("onLayerHover","onHover")(),"onLayerClick"in e&&log$3.removed("onLayerClick","onClick")(),e.initialViewState&&!deepEqual(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const i=this.viewManager.needsRedraw(e),n=this.layerManager.needsRedraw(e),r=this.effectManager.needsRedraw(e),o=this.deckRenderer.needsRedraw(e);return t=t||i||n||r||o,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return null!==this.viewManager}getViews(){return assert$4(this.viewManager),this.viewManager.views}getViewports(e){return assert$4(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_pick(e,t,i){assert$4(this.deckPicker);const{stats:n}=this;n.get("Pick Count").incrementCount(),n.get(t).timeStart();const r=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return n.get(t).timeEnd(),r}_createCanvas(e){let t=e.canvas;if("string"==typeof t&&(t=document.getElementById(t),assert$4(t)),!t){t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay";(e.parent||document.body).appendChild(t)}return Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;const{width:t,height:i}=e;if(t||0===t){const e=Number.isFinite(t)?"".concat(t,"px"):t;this.canvas.style.width=e}if(i||0===i){var n;const t=Number.isFinite(i)?"".concat(i,"px"):i;this.canvas.style.position=(null===(n=e.style)||void 0===n?void 0:n.position)||"absolute",this.canvas.style.height=t}}_updateCanvasSize(){var e,t;const{canvas:i}=this;if(!i)return;const n=null!==(e=i.clientWidth)&&void 0!==e?e:i.width,r=null!==(t=i.clientHeight)&&void 0!==t?t:i.height;var o,s;n===this.width&&r===this.height||(this.width=n,this.height=r,null===(o=this.viewManager)||void 0===o||o.setProps({width:n,height:r}),null===(s=this.layerManager)||void 0===s||s.activateViewport(this.getViewports()[0]),this.props.onResize({width:n,height:r}))}_createAnimationLoop(e){const{width:t,height:i,gl:n,glOptions:r,debug:o,onError:s,onBeforeRender:a,onAfterRender:l,useDevicePixels:c}=e;return new AnimationLoop({width:t,height:i,useDevicePixels:c,autoResizeDrawingBuffer:!n,autoResizeViewport:!1,gl:n,onCreateContext:e=>createGLContext({...r,...e,canvas:this.canvas,debug:o,onContextLost:()=>this._onContextLost()}),onInitialize:e=>this._setGLContext(e.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:a,onAfterRender:l,onError:s})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let e=this.props.views||[new MapView({id:"default-view"})];return e=Array.isArray(e)?e:[e],e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){const{_pickRequest:e}=this;if(e.event){const{result:i,emptyInfo:n}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=i.length>0;let r=n,o=!1;for(const n of i){var t;r=n,o=(null===(t=n.layer)||void 0===t?void 0:t.onHover(n,e.event))||o}if(!o&&this.props.onHover&&this.props.onHover(r,e.event),this.props.getTooltip&&this.tooltip){const e=this.props.getTooltip(r);this.tooltip.setTooltip(e,r.x,r.y)}e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setGLContext(e){if(this.layerManager)return;this.canvas||(this.canvas=e.canvas,instrumentGLContext(e,{enable:!0,copyState:!0})),this.tooltip=new Tooltip(this.canvas),setParameters(e,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(e);const t=new Timeline;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new EventManager(this.props.parent||e.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const e in EVENTS)this.eventManager.on(e,this._onEvent);this.viewManager=new ViewManager({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const i=this.viewManager.getViewports()[0];this.layerManager=new LayerManager(e,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new EffectManager,this.deckRenderer=new DeckRenderer(e),this.deckPicker=new DeckPicker(e),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){const{gl:i}=this.layerManager.context;setParameters(i,this.props.parameters),this.props.onBeforeRender({gl:i}),this.deckRenderer.renderLayers({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t}),this.props.onAfterRender({gl:i})}_onRenderFrame(e){this._getFrameStats(),this._metricsCounter++%60==0&&(this._getMetrics(),this.stats.reset(),log$3.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const i=lumaStats.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}}_defineProperty(Deck,"defaultProps",defaultProps$e),_defineProperty(Deck,"VERSION",VERSION$6);class ShaderAttribute{constructor(e,t){_defineProperty(this,"opts",void 0),_defineProperty(this,"source",void 0),this.opts=t,this.source=e}get value(){return this.source.value}getValue(){const e=this.source.getBuffer(),t=this.getAccessor();if(e)return[e,t];const{value:i}=this.source,{size:n}=t;let r=i;if(i&&i.length!==n){r=new Float32Array(n);const e=t.elementOffset||0;for(let t=0;t<n;++t)r[t]=i[e+t]}return r}getAccessor(){return{...this.source.getAccessor(),...this.opts}}}function glArrayFromType(e){switch(e){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function getStride(e){return e.stride||e.size*e.bytesPerElement}function resolveShaderAttribute(e,t){t.offset&&log$3.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const i=getStride(e),n=(void 0!==t.vertexOffset?t.vertexOffset:e.vertexOffset||0)*i+(t.elementOffset||0)*e.bytesPerElement+(e.offset||0);return{...t,offset:n,stride:i}}function resolveDoublePrecisionShaderAttributes(e,t){const i=resolveShaderAttribute(e,t);return{high:i,low:{...i,offset:i.offset+4*e.size}}}class DataColumn{constructor(e,t,i){_defineProperty(this,"gl",void 0),_defineProperty(this,"id",void 0),_defineProperty(this,"size",void 0),_defineProperty(this,"settings",void 0),_defineProperty(this,"value",void 0),_defineProperty(this,"doublePrecision",void 0),_defineProperty(this,"_buffer",void 0),_defineProperty(this,"state",void 0),this.gl=e,this.id=t.id||"",this.size=t.size||1;const n=t.logicalType||t.type,r=5130===n;let o,{defaultValue:s}=t;s=Number.isFinite(s)?[s]:s||new Array(this.size).fill(0),o=r?5126:!n&&t.isIndexed?e&&hasFeature(e,FEATURES$1.ELEMENT_INDEX_UINT32)?5125:5123:n||5126;let a=glArrayFromType(n||o||5126);this.doublePrecision=r,r&&!1===t.fp64&&(a=Float32Array),this.value=null,this.settings={...t,defaultType:a,defaultValue:s,logicalType:n,type:o,size:this.size,bytesPerElement:a.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){const{isIndexed:e,type:t}=this.settings;this._buffer=new Buffer(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:t}})}return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*getStride(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),defaultTypedArrayManager.release(this.state.allocatedValue)}getShaderAttributes(e,t){if(this.doublePrecision){const i={},n=this.value instanceof Float64Array,r=resolveDoublePrecisionShaderAttributes(this.getAccessor(),t||{});return i[e]=new ShaderAttribute(this,r.high),i["".concat(e,"64Low")]=n?new ShaderAttribute(this,r.low):new Float32Array(this.size),i}if(t){const i=resolveShaderAttribute(this.getAccessor(),t);return{[e]:new ShaderAttribute(this,i)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:i,size:n}=this,r=i*n;if(t&&r&&t.length>=r){const i=new Array(n).fill(1/0),o=new Array(n).fill(-1/0);for(let e=0;e<r;)for(let r=0;r<n;r++){const n=t[e++];n<i[r]&&(i[r]=n),n>o[r]&&(o[r]=n)}e=[i,o]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let i;i=ArrayBuffer.isView(e)?{value:e}:e instanceof Buffer?{buffer:e}:e;const n={...this.settings,...i};if(t.bufferAccessor=n,t.bounds=null,i.constant){let e=i.value;e=this._normalizeValue(e,[],0),this.settings.normalized&&(e=this.normalizeConstant(e));if(!(!t.constant||!this._areValuesEqual(e,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=e}else if(i.buffer){const e=i.buffer;t.externalBuffer=e,t.constant=!1,this.value=i.value||null;const r=i.value instanceof Float64Array;n.type=i.type||e.accessor.type,n.bytesPerElement=e.accessor.BYTES_PER_ELEMENT*(r?2:1),n.stride=getStride(n)}else if(i.value){this._checkExternalBuffer(i);let e=i.value;t.externalBuffer=null,t.constant=!1,this.value=e,n.bytesPerElement=e.BYTES_PER_ELEMENT,n.stride=getStride(n);const{buffer:r,byteOffset:o}=this;this.doublePrecision&&e instanceof Float64Array&&(e=toDoublePrecisionArray(e,n));const s=e.byteLength+o+2*n.stride;r.byteLength<s&&r.reallocate(s),r.setAccessor(null),r.subData({data:e,offset:o}),n.type=i.type||r.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:i=0,endOffset:n}=e;this.buffer.subData({data:this.doublePrecision&&t instanceof Float64Array?toDoublePrecisionArray(t,{size:this.size,startIndex:i,endIndex:n}):t.subarray(i,n),offset:i*t.BYTES_PER_ELEMENT+this.byteOffset})}allocate(e,t=!1){const{state:i}=this,n=i.allocatedValue,r=defaultTypedArrayManager.allocate(n,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=r;const{buffer:o,byteOffset:s}=this;return o.byteLength<r.byteLength+s&&(o.reallocate(r.byteLength+s),t&&n&&o.subData({data:n instanceof Float64Array?toDoublePrecisionArray(n,this):n,offset:s})),i.allocatedValue=r,i.constant=!1,i.externalBuffer=null,i.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));const i=this.settings.defaultType;let n=!1;if(this.doublePrecision&&(n=t.BYTES_PER_ELEMENT<4),n)throw new Error("Attribute ".concat(this.id," does not support ").concat(t.constructor.name));t instanceof i||!this.settings.normalized||"normalized"in e||log$3.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map((e=>(e+128)/255*2-1));case 5122:return new Float32Array(e).map((e=>(e+32768)/65535*2-1));case 5121:return new Float32Array(e).map((e=>e/255));case 5123:return new Float32Array(e).map((e=>e/65535));default:return e}}_normalizeValue(e,t,i){const{defaultValue:n,size:r}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e){let e=r;for(;--e>=0;)t[i+e]=n[e];return t}switch(r){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:n[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:n[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:n[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:n[0];break;default:let o=r;for(;--o>=0;)t[i+o]=Number.isFinite(e[o])?e[o]:n[o]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:i}=this;for(let n=0;n<i;n++)if(e[n]!==t[n])return!1;return!0}}const EMPTY_ARRAY$2=[],placeholderArray=[];function createIterable(e,t=0,i=1/0){let n=EMPTY_ARRAY$2;const r={index:-1,data:e,target:[]};return e?"function"==typeof e[Symbol.iterator]?n=e:e.length>0&&(placeholderArray.length=e.length,n=placeholderArray):n=EMPTY_ARRAY$2,(t>0||Number.isFinite(i))&&(n=(Array.isArray(n)?n:Array.from(n)).slice(t,i),r.index=t-1),{iterable:n,objectInfo:r}}function isAsyncIterable(e){return e&&e[Symbol.asyncIterator]}function getAccessorFromBuffer(e,t){const{size:i,stride:n,offset:r,startIndices:o,nested:s}=t,a=e.BYTES_PER_ELEMENT,l=n?n/a:i,c=r?r/a:0,u=Math.floor((e.length-c)/l);return(t,{index:n,target:r})=>{if(!o){const t=n*l+c;for(let n=0;n<i;n++)r[n]=e[t+n];return r}const a=o[n],h=o[n+1]||u;let d;if(s){d=new Array(h-a);for(let t=a;t<h;t++){const n=t*l+c;r=new Array(i);for(let t=0;t<i;t++)r[t]=e[n+t];d[t-a]=r}}else if(l===i)d=e.subarray(a*i+c,h*i+c);else{d=new e.constructor((h-a)*i);let t=0;for(let n=a;n<h;n++){const r=n*l+c;for(let n=0;n<i;n++)d[t++]=e[r+n]}}return d}}const EMPTY=[],FULL=[[0,1/0]];function add(e,t){if(e===FULL)return e;if(t[0]<0&&(t[0]=0),t[0]>=t[1])return e;const i=[],n=e.length;let r=0;for(let o=0;o<n;o++){const n=e[o];n[1]<t[0]?(i.push(n),r=o+1):n[0]>t[1]?i.push(n):t=[Math.min(n[0],t[0]),Math.max(n[1],t[1])]}return i.splice(r,0,t),i}function padArrayChunk(e){const{source:t,target:i,start:n=0,size:r,getData:o}=e,s=t.length,a=(e.end||i.length)-n;if(s>a)return void i.set(t.subarray(0,a),n);if(i.set(t,n),!o)return;let l=s;for(;l<a;){const e=o(l,t);for(let t=0;t<r;t++)i[n+l]=e[t]||0,l++}}function padArray({source:e,target:t,size:i,getData:n,sourceStartIndices:r,targetStartIndices:o}){if(!Array.isArray(o))return padArrayChunk({source:e,target:t,size:i,getData:n}),t;let s=0,a=0;const l=n&&((e,t)=>n(e+a,t)),c=Math.min(r.length,o.length);for(let n=1;n<c;n++){const c=r[n]*i,u=o[n]*i;padArrayChunk({source:e.subarray(s,c),target:t,start:a,end:u,size:i,getData:l}),s=c,a=u}return a<t.length&&padArrayChunk({source:[],target:t,start:a,size:i,getData:l}),t}const DEFAULT_TRANSITION_SETTINGS={interpolation:{duration:0,easing:e=>e},spring:{stiffness:.05,damping:.5}};function normalizeTransitionSettings(e,t){if(!e)return null;Number.isFinite(e)&&(e={type:"interpolation",duration:e});const i=e.type||"interpolation";return{...DEFAULT_TRANSITION_SETTINGS[i],...t,...e,type:i}}function getSourceBufferAttribute(e,t){const i=t.getBuffer();return i?[i,{divisor:0,size:t.size,normalized:t.settings.normalized}]:t.value}function getAttributeTypeFromSize(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(e,'"'))}}function cycleBuffers(e){e.push(e.shift())}function getAttributeBufferLength(e,t){const{doublePrecision:i,settings:n,value:r,size:o}=e,s=i&&r instanceof Float64Array?2:1;return(n.noAlloc?r.length:t*o)*s}function padBuffer({buffer:e,numInstances:t,attribute:i,fromLength:n,fromStartIndices:r,getData:o=e=>e}){const s=i.doublePrecision&&i.value instanceof Float64Array?2:1,a=i.size*s,l=i.byteOffset,c=i.startIndices,u=r&&c,h=getAttributeBufferLength(i,t),d=i.isConstant;if(!u&&n>=h)return;const p=d?i.value:i.getBuffer().getData({srcByteOffset:l});if(i.settings.normalized&&!d){const e=o;o=(t,n)=>i.normalizeConstant(e(t,n))}const f=d?(e,t)=>o(p,t):(e,t)=>o(p.subarray(e,e+a),t),m=e.getData({length:n}),g=new Float32Array(h);padArray({source:m,target:g,sourceStartIndices:r,targetStartIndices:c,size:a,getData:f}),e.byteLength<g.byteLength+l&&e.reallocate(g.byteLength+l),e.subData({data:g,offset:l})}class Attribute extends DataColumn{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:FULL}),_defineProperty(this,"constant",!1),this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat("function"!=typeof e&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,i=this.settings.transition,n=Array.isArray(t)?e[t.find((t=>e[t]))]:e[t];return normalizeTransitionSettings(n,i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:e=0,endRow:i=1/0}=t;this.state.updateRanges=add(this.state.updateRanges,[e,i])}else this.state.updateRanges=FULL}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=EMPTY}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:i}=this;return!i.noAlloc&&(!!i.update&&(super.allocate(e,t.updateRanges!==FULL),!0))}updateBuffer({numInstances:e,data:t,props:i,context:n}){if(!this.needsUpdate())return!1;const{state:{updateRanges:r},settings:{update:o,noAlloc:s}}=this;let a=!0;if(o){for(const[s,a]of r)o.call(n,this,{data:t,startRow:s,endRow:a,props:i,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[t,i]of r){const n=Number.isFinite(t)?this.getVertexOffset(t):0,r=Number.isFinite(i)?this.getVertexOffset(i):s||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:n,endOffset:r})}else;this._checkAttributeArray()}else a=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),a}setConstantValue(e){if(void 0===e||"function"==typeof e)return!1;return this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:i,settings:n}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(n.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;i.binaryValue=e,this.setNeedsRedraw();if(n.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const r=e;assert$4(ArrayBuffer.isView(r.value),"invalid ".concat(n.accessor));const o=Boolean(r.size)&&r.size!==this.size;return i.binaryAccessor=getAccessorFromBuffer(r.value,{size:r.size||this.size,stride:r.stride,offset:r.offset,startIndices:t,nested:o}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getShaderAttributes(){const e=this.settings.shaderAttributes||{[this.id]:null},t={};for(const i in e)Object.assign(t,super.getShaderAttributes(i,e[i]));return t}_autoUpdater(e,{data:t,startRow:i,endRow:n,props:r,numInstances:o}){if(e.constant)return;const{settings:s,state:a,value:l,size:c,startIndices:u}=e,{accessor:h,transform:d}=s,p=a.binaryAccessor||("function"==typeof h?h:r[h]);assert$4("function"==typeof p,'accessor "'.concat(h,'" is not a function'));let f=e.getVertexOffset(i);const{iterable:m,objectInfo:g}=createIterable(t,i,n);for(const t of m){g.index++;let i=p(t,g);if(d&&(i=d.call(this,i)),u){const t=(g.index<u.length-1?u[g.index+1]:o)-u[g.index];if(i&&Array.isArray(i[0])){let t=f;for(const n of i)e._normalizeValue(n,l,t),t+=c}else i&&i.length>c?l.set(i,f):(e._normalizeValue(i,g.target,0),fillArray({target:l,source:g.target,start:f,count:t}));f+=t*c}else e._normalizeValue(i,l,f),f+=c}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||"function"==typeof e.update))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw new Error("Illegal attribute generated for ".concat(this.id))}}}class GPUInterpolationTransition{constructor({gl:e,attribute:t,timeline:i}){_defineProperty(this,"gl",void 0),_defineProperty(this,"type","interpolation"),_defineProperty(this,"attributeInTransition",void 0),_defineProperty(this,"settings",void 0),_defineProperty(this,"attribute",void 0),_defineProperty(this,"transition",void 0),_defineProperty(this,"currentStartIndices",void 0),_defineProperty(this,"currentLength",void 0),_defineProperty(this,"transform",void 0),_defineProperty(this,"buffers",void 0),this.gl=e,this.transition=new Transition(i),this.attribute=t,this.attributeInTransition=new Attribute(e,t.settings),this.currentStartIndices=t.startIndices,this.currentLength=0,this.transform=getTransform$1(e,t);const n={byteLength:0,usage:35050};this.buffers=[new Buffer(e,n),new Buffer(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){if(e.duration<=0)return void this.transition.cancel();this.settings=e;const{gl:i,buffers:n,attribute:r}=this;cycleBuffers(n);const o={numInstances:t,attribute:r,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(const e of n)padBuffer({buffer:e,...o});this.currentStartIndices=r.startIndices,this.currentLength=getAttributeBufferLength(r,t),this.attributeInTransition.setData({buffer:n[1],value:r.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/r.size),sourceBuffers:{aFrom:n[0],aTo:getSourceBufferAttribute(i,r)},feedbackBuffers:{vCurrent:n[1]}})}update(){const e=this.transition.update();if(e){const{duration:e,easing:t}=this.settings,{time:i}=this.transition;let n=i/e;t&&(n=t(n)),this.transform.run({uniforms:{time:n}})}return e}cancel(){this.transition.cancel(),this.transform.delete();for(const e of this.buffers)e.delete();this.buffers.length=0}}const vs$9="\n#define SHADER_NAME interpolation-transition-vertex-shader\n\nuniform float time;\nattribute ATTRIBUTE_TYPE aFrom;\nattribute ATTRIBUTE_TYPE aTo;\nvarying ATTRIBUTE_TYPE vCurrent;\n\nvoid main(void) {\n  vCurrent = mix(aFrom, aTo, time);\n  gl_Position = vec4(0.0);\n}\n";function getTransform$1(e,t){const i=getAttributeTypeFromSize(t.size);return new Transform(e,{vs:vs$9,defines:{ATTRIBUTE_TYPE:i},varyings:["vCurrent"]})}class GPUSpringTransition{constructor({gl:e,attribute:t,timeline:i}){_defineProperty(this,"gl",void 0),_defineProperty(this,"type","spring"),_defineProperty(this,"attributeInTransition",void 0),_defineProperty(this,"settings",void 0),_defineProperty(this,"attribute",void 0),_defineProperty(this,"transition",void 0),_defineProperty(this,"currentStartIndices",void 0),_defineProperty(this,"currentLength",void 0),_defineProperty(this,"texture",void 0),_defineProperty(this,"framebuffer",void 0),_defineProperty(this,"transform",void 0),_defineProperty(this,"buffers",void 0),this.gl=e,this.type="spring",this.transition=new Transition(i),this.attribute=t,this.attributeInTransition=new Attribute(e,{...t.settings,normalized:!1}),this.currentStartIndices=t.startIndices,this.currentLength=0,this.texture=getTexture(e),this.framebuffer=getFramebuffer(e,this.texture),this.transform=getTransform(e,t,this.framebuffer);const n={byteLength:0,usage:35050};this.buffers=[new Buffer(e,n),new Buffer(e,n),new Buffer(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){const{gl:i,buffers:n,attribute:r}=this,o={numInstances:t,attribute:r,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(const e of n)padBuffer({buffer:e,...o});this.settings=e,this.currentStartIndices=r.startIndices,this.currentLength=getAttributeBufferLength(r,t),this.attributeInTransition.setData({buffer:n[1],value:r.value}),this.transition.start({...e,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/r.size),sourceBuffers:{aTo:getSourceBufferAttribute(i,r)}})}update(){const{buffers:e,transform:t,framebuffer:i,transition:n}=this;if(!n.update())return!1;const r=this.settings;t.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),t.run({framebuffer:i,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:r.stiffness,damping:r.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),cycleBuffers(e),this.attributeInTransition.setData({buffer:e[1],value:this.attribute.value});return readPixelsToArray(i)[0]>0||n.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(const e of this.buffers)e.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}}function getTransform(e,t,i){const n=getAttributeTypeFromSize(t.size);return new Transform(e,{framebuffer:i,vs:"\n#define SHADER_NAME spring-transition-vertex-shader\n\n#define EPSILON 0.00001\n\nuniform float stiffness;\nuniform float damping;\nattribute ATTRIBUTE_TYPE aPrev;\nattribute ATTRIBUTE_TYPE aCur;\nattribute ATTRIBUTE_TYPE aTo;\nvarying ATTRIBUTE_TYPE vNext;\nvarying float vIsTransitioningFlag;\n\nATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {\n  ATTRIBUTE_TYPE velocity = cur - prev;\n  ATTRIBUTE_TYPE delta = dest - cur;\n  ATTRIBUTE_TYPE spring = delta * stiffness;\n  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;\n  return spring + damper + velocity + cur;\n}\n\nvoid main(void) {\n  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;\n  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;\n\n  vNext = getNextValue(aCur, aPrev, aTo);\n  gl_Position = vec4(0, 0, 0, 1);\n  gl_PointSize = 100.0;\n}\n",fs:"\n#define SHADER_NAME spring-transition-is-transitioning-fragment-shader\n\nvarying float vIsTransitioningFlag;\n\nvoid main(void) {\n  if (vIsTransitioningFlag == 0.0) {\n    discard;\n  }\n  gl_FragColor = vec4(1.0);\n}",defines:{ATTRIBUTE_TYPE:n},varyings:["vNext"]})}function getTexture(e){return new Texture2D(e,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function getFramebuffer(e,t){return new Framebuffer(e,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{36064:t}})}const TRANSITION_TYPES$1={interpolation:GPUInterpolationTransition,spring:GPUSpringTransition};class AttributeTransitionManager{constructor(e,{id:t,timeline:i}){_defineProperty(this,"id",void 0),_defineProperty(this,"isSupported",void 0),_defineProperty(this,"gl",void 0),_defineProperty(this,"timeline",void 0),_defineProperty(this,"transitions",void 0),_defineProperty(this,"needsRedraw",void 0),_defineProperty(this,"numInstances",void 0),this.id=t,this.gl=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=Transform.isSupported(e)}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){this.numInstances=i||1;for(const i in e){const n=e[i],r=n.getTransitionSetting(t);r&&this._updateAttribute(i,n,r)}for(const i in this.transitions){const n=e[i];n&&n.getTransitionSetting(t)||this._removeTransition(i)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(!this.isSupported||0===this.numInstances)return!1;for(const e in this.transitions){this.transitions[e].update()&&(this.needsRedraw=!0)}const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,t,i){const n=this.transitions[e];let r=!n||n.type!==i.type;if(r){if(!this.isSupported)return void log$3.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();n&&this._removeTransition(e);const o=TRANSITION_TYPES$1[i.type];o?this.transitions[e]=new o({attribute:t,timeline:this.timeline,gl:this.gl}):(("unsupported transition type '".concat(i.type,"'"),()=>{})(),r=!1)}(r||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}}const TRACE_INVALIDATE="attributeManager.invalidate",TRACE_UPDATE_START="attributeManager.updateStart",TRACE_UPDATE_END="attributeManager.updateEnd",TRACE_ATTRIBUTE_UPDATE_START="attribute.updateStart",TRACE_ATTRIBUTE_ALLOCATE="attribute.allocate",TRACE_ATTRIBUTE_UPDATE_END="attribute.updateEnd";class AttributeManager{constructor(e,{id:t="attribute-manager",stats:i,timeline:n}={}){_defineProperty(this,"id",void 0),_defineProperty(this,"gl",void 0),_defineProperty(this,"attributes",void 0),_defineProperty(this,"updateTriggers",void 0),_defineProperty(this,"needsRedraw",void 0),_defineProperty(this,"userData",void 0),_defineProperty(this,"stats",void 0),_defineProperty(this,"attributeTransitionManager",void 0),_defineProperty(this,"mergeBoundsMemoized",memoize(mergeBounds)),this.id=t,this.gl=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new AttributeTransitionManager(e,{id:"".concat(t,"-transitions"),timeline:n}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{instanced:1})}remove(e){for(const t of e)void 0!==this.attributes[t]&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const i=this._invalidateTrigger(e,t);debug(TRACE_INVALIDATE,this,e,i)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);debug(TRACE_INVALIDATE,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:n,props:r={},buffers:o={},context:s={}}){let a=!1;debug(TRACE_UPDATE_START,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const n in this.attributes){const l=this.attributes[n],c=l.settings.accessor;l.startIndices=i,l.numInstances=t,r[n]&&log$3.removed("props.".concat(n),"data.attributes.".concat(n))(),l.setExternalBuffer(o[n])||l.setBinaryValue("string"==typeof c?o[c]:void 0,e.startIndices)||"string"==typeof c&&!o[c]&&l.setConstantValue(r[c])||l.needsUpdate()&&(a=!0,this._updateAttribute({attribute:l,numInstances:t,data:e,props:r,context:s})),this.needsRedraw=this.needsRedraw||l.needsRedraw()}a&&debug(TRACE_UPDATE_END,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:n})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return this.attributes}getBounds(e){const t=e.map((e=>{var t;return null===(t=this.attributes[e])||void 0===t?void 0:t.getBounds()}));return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:i}=this,n={...i.getAttributes()};for(const r in t){const o=t[r];o.needsRedraw(e)&&!i.hasAttribute(r)&&(n[r]=o)}return n}getShaderAttributes(e,t={}){e||(e=this.getAttributes());const i={};for(const n in e)t[n]||Object.assign(i,e[n].getShaderAttributes());return i}_add(e,t={}){for(const i in e){this.attributes[i]=this._createAttribute(i,e[i],t)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,t,i){const n={...t,id:e,size:(t.isIndexed?1:t.size)||1,divisor:i.instanced?1:t.divisor||0};return new Attribute(this.gl,n)}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes){this.attributes[t].getUpdateTriggers().forEach((i=>{e[i]||(e[i]=[]),e[i].push(t)}))}this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:i,updateTriggers:n}=this,r=n[e];return r&&r.forEach((e=>{const n=i[e];n&&n.setNeedsUpdate(n.id,t)})),r}_updateAttribute(e){const{attribute:t,numInstances:i}=e;if(debug(TRACE_ATTRIBUTE_UPDATE_START,t),t.constant)return void t.setConstantValue(t.value);t.allocate(i)&&debug(TRACE_ATTRIBUTE_ALLOCATE,t,i);t.updateBuffer(e)&&(this.needsRedraw=!0,debug(TRACE_ATTRIBUTE_UPDATE_END,t,i))}}class CPUInterpolationTransition extends Transition{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:i,duration:n,easing:r}}=this,o=r(e/n);this._value=lerp$4(t,i,o)}}const EPSILON=1e-5;function updateSpringElement(e,t,i,n,r){const o=t-e;return(i-t)*r+-o*n+o+t}function updateSpring(e,t,i,n,r){if(Array.isArray(i)){const o=[];for(let s=0;s<i.length;s++)o[s]=updateSpringElement(e[s],t[s],i[s],n,r);return o}return updateSpringElement(e,t,i,n,r)}function distance(e,t){if(Array.isArray(e)){let i=0;for(let n=0;n<e.length;n++){const r=e[n]-t[n];i+=r*r}return Math.sqrt(i)}return Math.abs(e-t)}class CPUSpringTransition extends Transition{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:i,stiffness:n}=this.settings,{_prevValue:r=e,_currValue:o=e}=this;let s=updateSpring(r,o,t,i,n);const a=distance(s,t),l=distance(s,o);a<EPSILON&&l<EPSILON&&(s=t,this.end()),this._prevValue=o,this._currValue=s}}const TRANSITION_TYPES={interpolation:CPUInterpolationTransition,spring:CPUSpringTransition};class UniformTransitionManager{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,n){const{transitions:r}=this;if(r.has(e)){const i=r.get(e),{value:n=i.settings.fromValue}=i;t=n,this.remove(e)}if(!(n=normalizeTransitionSettings(n)))return;const o=TRANSITION_TYPES[n.type];if(!o)return void("unsupported transition type '".concat(n.type,"'"),()=>{})();const s=new o(this.timeline);s.start({...n,fromValue:t,toValue:i}),r.set(e,s)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function validateProps(e){const t=e[PROP_TYPES_SYMBOL];for(const i in t){const n=t[i],{validate:r}=n;if(r&&!r(e[i],n))throw new Error("Invalid prop ".concat(i,": ").concat(e[i]))}}function diffProps(e,t){const i=compareProps({newProps:e,oldProps:t,propTypes:e[PROP_TYPES_SYMBOL],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),n=diffDataProps(e,t);let r=!1;return n||(r=diffUpdateTriggers(e,t)),{dataChanged:n,propsChanged:i,updateTriggersChanged:r,extensionsChanged:diffExtensions(e,t),transitionsChanged:diffTransitions(e,t)}}function diffTransitions(e,t){if(!e.transitions)return!1;const i={},n=e[PROP_TYPES_SYMBOL];let r=!1;for(const o in e.transitions){const s=n[o],a=s&&s.type;("number"===a||"color"===a||"array"===a)&&comparePropValues(e[o],t[o],s)&&(i[o]=!0,r=!0)}return!!r&&i}function compareProps({newProps:e,oldProps:t,ignoreProps:i={},propTypes:n={},triggerName:r="props"}){if(t===e)return!1;if("object"!=typeof e||null===e)return"".concat(r," changed shallowly");if("object"!=typeof t||null===t)return"".concat(r," changed shallowly");for(const o of Object.keys(e))if(!(o in i)){if(!(o in t))return"".concat(r,".").concat(o," added");const i=comparePropValues(e[o],t[o],n[o]);if(i)return"".concat(r,".").concat(o," ").concat(i)}for(const o of Object.keys(t))if(!(o in i)){if(!(o in e))return"".concat(r,".").concat(o," dropped");if(!Object.hasOwnProperty.call(e,o)){const i=comparePropValues(e[o],t[o],n[o]);if(i)return"".concat(r,".").concat(o," ").concat(i)}}return!1}function comparePropValues(e,t,i){let n=i&&i.equal;return n&&!n(e,t,i)?"changed deeply":n||(n=e&&t&&e.equals,!n||n.call(e,t))?n||t===e?null:"changed shallowly":"changed deeply"}function diffDataProps(e,t){if(null===t)return"oldProps is null, initial diff";let i=!1;const{dataComparator:n,_dataDiff:r}=e;return n?n(e.data,t.data)||(i="Data comparator detected a change"):e.data!==t.data&&(i="A new data container was supplied"),i&&r&&(i=r(e.data,t.data)||i),i}function diffUpdateTriggers(e,t){if(null===t)return{all:!0};if("all"in e.updateTriggers){if(diffUpdateTrigger(e,t,"all"))return{all:!0}}const i={};let n=!1;for(const r in e.updateTriggers)if("all"!==r){diffUpdateTrigger(e,t,r)&&(i[r]=!0,n=!0)}return!!n&&i}function diffExtensions(e,t){if(null===t)return!0;const i=t.extensions,{extensions:n}=e;if(n===i)return!1;if(!i||!n)return!0;if(n.length!==i.length)return!0;for(let e=0;e<n.length;e++)if(!n[e].equals(i[e]))return!0;return!1}function diffUpdateTrigger(e,t,i){let n=e.updateTriggers[i];n=null==n?{}:n;let r=t.updateTriggers[i];r=null==r?{}:r;return compareProps({oldProps:r,newProps:n,triggerName:i})}const ERR_NOT_OBJECT="count(): argument not an object",ERR_NOT_CONTAINER="count(): argument not a container";function count(e){if(!isObject$3(e))throw new Error(ERR_NOT_OBJECT);if("function"==typeof e.count)return e.count();if(Number.isFinite(e.size))return e.size;if(Number.isFinite(e.length))return e.length;if(isPlainObject(e))return Object.keys(e).length;throw new Error(ERR_NOT_CONTAINER)}function isPlainObject(e){return null!==e&&"object"==typeof e&&e.constructor===Object}function isObject$3(e){return null!==e&&"object"==typeof e}function mergeShaders(e,t){if(!t)return e;const i={...e,...t};if("defines"in t&&(i.defines={...e.defines,...t.defines}),"modules"in t&&(i.modules=(e.modules||[]).concat(t.modules),t.modules.some((e=>"project64"===e.name)))){const e=i.modules.findIndex((e=>"project32"===e.name));e>=0&&i.modules.splice(e,1)}if("inject"in t)if(e.inject){const n={...e.inject};for(const e in t.inject)n[e]=(n[e]||"")+t.inject[e];i.inject=n}else i.inject=t.inject;return i}const DEFAULT_TEXTURE_PARAMETERS$1={10241:9987,10240:9729,10242:33071,10243:33071},internalTextures={};function createTexture(e,t,i,n){if(i instanceof Texture2D)return i;i.constructor&&"Object"!==i.constructor.name&&(i={data:i});let r=null;i.compressed&&(r={10241:i.data.length>1?9985:9729});const o=new Texture2D(t,{...i,parameters:{...DEFAULT_TEXTURE_PARAMETERS$1,...r,...n}});return internalTextures[o.id]=e,o}function destroyTexture(e,t){t&&t instanceof Texture2D&&internalTextures[t.id]===e&&(t.delete(),delete internalTextures[t.id])}const TYPE_DEFINITIONS={boolean:{validate:(e,t)=>!0,equal:(e,t,i)=>Boolean(e)===Boolean(t)},number:{validate:(e,t)=>Number.isFinite(e)&&(!("max"in t)||e<=t.max)&&(!("min"in t)||e>=t.min)},color:{validate:(e,t)=>t.optional&&!e||isArray(e)&&(3===e.length||4===e.length),equal:(e,t,i)=>deepEqual(e,t,1)},accessor:{validate(e,t){const i=getTypeOf(e);return"function"===i||i===getTypeOf(t.value)},equal:(e,t,i)=>"function"==typeof t||deepEqual(e,t,1)},array:{validate:(e,t)=>t.optional&&!e||isArray(e),equal(e,t,i){const{compare:n}=i,r=Number.isInteger(n)?n:n?1:0;return n?deepEqual(e,t,r):e===t}},object:{equal(e,t,i){if(i.ignore)return!0;const{compare:n}=i,r=Number.isInteger(n)?n:n?1:0;return n?deepEqual(e,t,r):e===t}},function:{validate:(e,t)=>t.optional&&!e||"function"==typeof e,equal:(e,t,i)=>!i.compare&&!1!==i.ignore||e===t},data:{transform:(e,t,i)=>{const{dataTransform:n}=i.props;return n&&e?n(e):e}},image:{transform:(e,t,i)=>{const n=i.context;return n&&n.gl?createTexture(i.id,n.gl,e,{...t.parameters,...i.props.textureParameters}):null},release:(e,t,i)=>{destroyTexture(i.id,e)}}};function parsePropTypes(e){const t={},i={},n={};for(const[r,o]of Object.entries(e)){const e=null==o?void 0:o.deprecatedFor;if(e)n[r]=Array.isArray(e)?e:[e];else{const e=parsePropType(r,o);t[r]=e,i[r]=e.value}}return{propTypes:t,defaultProps:i,deprecatedProps:n}}function parsePropType(e,t){switch(getTypeOf(t)){case"object":return normalizePropDefinition(e,t);case"array":return normalizePropDefinition(e,{type:"array",value:t,compare:!1});case"boolean":return normalizePropDefinition(e,{type:"boolean",value:t});case"number":return normalizePropDefinition(e,{type:"number",value:t});case"function":return normalizePropDefinition(e,{type:"function",value:t,compare:!0});default:return{name:e,type:"unknown",value:t}}}function normalizePropDefinition(e,t){return"type"in t?{name:e,...TYPE_DEFINITIONS[t.type],...t}:"value"in t?{name:e,type:getTypeOf(t.value),...t}:{name:e,type:"object",value:t}}function isArray(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function getTypeOf(e){return isArray(e)?"array":null===e?"null":typeof e}function createProps(e,t){let i;for(let e=t.length-1;e>=0;e--){const n=t[e];"extensions"in n&&(i=n.extensions)}const n=getPropsPrototype(e.constructor,i),r=Object.create(n);r[COMPONENT_SYMBOL]=e,r[ASYNC_ORIGINAL_SYMBOL]={},r[ASYNC_RESOLVED_SYMBOL]={};for(let e=0;e<t.length;++e){const i=t[e];for(const e in i)r[e]=i[e]}return Object.freeze(r),r}const MergedDefaultPropsCacheKey="_mergedDefaultProps";function getPropsPrototype(e,t){let i=MergedDefaultPropsCacheKey;if(t)for(const e of t){const t=e.constructor;t&&(i+=":".concat(t.extensionName||t.name))}const n=getOwnProperty(e,i);return n||(e[i]=createPropsPrototypeAndTypes(e,t||[]))}function createPropsPrototypeAndTypes(e,t){if(!e.prototype)return null;const i=getPropsPrototype(Object.getPrototypeOf(e)),n=parsePropTypes(getOwnProperty(e,"defaultProps")||{}),r=Object.assign(Object.create(null),i,n.defaultProps),o=Object.assign(Object.create(null),null==i?void 0:i[PROP_TYPES_SYMBOL],n.propTypes),s=Object.assign(Object.create(null),null==i?void 0:i[DEPRECATED_PROPS_SYMBOL],n.deprecatedProps);for(const e of t){const t=getPropsPrototype(e.constructor);t&&(Object.assign(r,t),Object.assign(o,t[PROP_TYPES_SYMBOL]),Object.assign(s,t[DEPRECATED_PROPS_SYMBOL]))}return createPropsPrototype(r,e),addAsyncPropsToPropPrototype(r,o),addDeprecatedPropsToPropPrototype(r,s),r[PROP_TYPES_SYMBOL]=o,r[DEPRECATED_PROPS_SYMBOL]=s,0!==t.length||hasOwnProperty(e,"_propTypes")||(e._propTypes=o),r}function createPropsPrototype(e,t){const i=getComponentName(t);Object.defineProperties(e,{id:{writable:!0,value:i}})}function addDeprecatedPropsToPropPrototype(e,t){for(const i in t)Object.defineProperty(e,i,{enumerable:!1,set(e){const n="".concat(this.id,": ").concat(i);for(const n of t[i])hasOwnProperty(this,n)||(this[n]=e);log$3.deprecated(n,t[i].join("/"))()}})}function addAsyncPropsToPropPrototype(e,t){const i={},n={};for(const e in t){const r=t[e],{name:o,value:s}=r;r.async&&(i[o]=s,n[o]=getDescriptorForAsyncProp(o))}e[ASYNC_DEFAULTS_SYMBOL]=i,e[ASYNC_ORIGINAL_SYMBOL]={},Object.defineProperties(e,n)}function getDescriptorForAsyncProp(e){return{enumerable:!0,set(t){"string"==typeof t||t instanceof Promise||isAsyncIterable(t)?this[ASYNC_ORIGINAL_SYMBOL][e]=t:this[ASYNC_RESOLVED_SYMBOL][e]=t},get(){if(this[ASYNC_RESOLVED_SYMBOL]){if(e in this[ASYNC_RESOLVED_SYMBOL]){return this[ASYNC_RESOLVED_SYMBOL][e]||this[ASYNC_DEFAULTS_SYMBOL][e]}if(e in this[ASYNC_ORIGINAL_SYMBOL]){const t=this[COMPONENT_SYMBOL]&&this[COMPONENT_SYMBOL].internalState;if(t&&t.hasAsyncProp(e))return t.getAsyncProp(e)||this[ASYNC_DEFAULTS_SYMBOL][e]}}return this[ASYNC_DEFAULTS_SYMBOL][e]}}}function hasOwnProperty(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function getOwnProperty(e,t){return hasOwnProperty(e,t)&&e[t]}function getComponentName(e){const t=e.componentName;return t||log$3.warn("".concat(e.name,".componentName not specified"))(),t||e.name}let counter=0;class Component{constructor(...e){_defineProperty(this,"id",void 0),_defineProperty(this,"props",void 0),_defineProperty(this,"count",void 0),this.props=createProps(this,e),this.id=this.props.id,this.count=counter++}clone(e){const{props:t}=this,i={};for(const e in t[ASYNC_DEFAULTS_SYMBOL])e in t[ASYNC_RESOLVED_SYMBOL]?i[e]=t[ASYNC_RESOLVED_SYMBOL][e]:e in t[ASYNC_ORIGINAL_SYMBOL]&&(i[e]=t[ASYNC_ORIGINAL_SYMBOL][e]);return new this.constructor({...t,...i,...e})}}_defineProperty(Component,"componentName","Component"),_defineProperty(Component,"defaultProps",{});const EMPTY_PROPS=Object.freeze({});class ComponentState{constructor(e){_defineProperty(this,"component",void 0),_defineProperty(this,"onAsyncPropUpdated",void 0),_defineProperty(this,"asyncProps",void 0),_defineProperty(this,"oldProps",void 0),_defineProperty(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||EMPTY_PROPS}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[COMPONENT_SYMBOL]||this.component;const t=e[ASYNC_RESOLVED_SYMBOL]||{},i=e[ASYNC_ORIGINAL_SYMBOL]||e,n=e[ASYNC_DEFAULTS_SYMBOL]||{};for(const e in t){const i=t[e];this._createAsyncPropData(e,n[e]),this._updateAsyncProp(e,i),t[e]=this.getAsyncProp(e)}for(const e in i){const t=i[e];this._createAsyncPropData(e,n[e]),this._updateAsyncProp(e,t)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){this._didAsyncInputValueChange(e,t)&&("string"==typeof t&&(t=this._fetch(e,t)),t instanceof Promise?this._watchPromise(e,t):isAsyncIterable(t)?this._resolveAsyncIterable(e,t):this._setPropValue(e,t))}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const i=this.asyncProps[e];return t!==i.resolvedValue&&t!==i.lastValue&&(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){const n=this.asyncProps[e];n&&i>=n.resolvedLoadCount&&void 0!==t&&(this._freezeAsyncOldProps(),n.resolvedValue=t,n.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const i=this.asyncProps[e];if(i){i.pendingLoadCount++;const n=i.pendingLoadCount;t.then((t=>{this.component&&(t=this._postProcessValue(i,t),this._setAsyncPropValue(e,t,n),this._onResolve(e,t))})).catch((t=>{this._onError(e,t)}))}}async _resolveAsyncIterable(e,t){if("data"!==e)return void this._setPropValue(e,t);const i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;const n=i.pendingLoadCount;let r=[],o=0;for await(const i of t){if(!this.component)return;const{dataTransform:t}=this.component.props;r=t?t(i,r):r.concat(i),Object.defineProperty(r,"__diff",{enumerable:!1,value:[{startRow:o,endRow:r.length}]}),o=r.length,this._setAsyncPropValue(e,r,n)}this._onResolve(e,r)}_postProcessValue(e,t){const i=e.type;return i&&this.component&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const i=this.component&&this.component.props[PROP_TYPES_SYMBOL];this.asyncProps[e]={type:i&&i[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class LayerState extends ComponentState{constructor({attributeManager:e,layer:t}){super(t),_defineProperty(this,"attributeManager",void 0),_defineProperty(this,"needsRedraw",void 0),_defineProperty(this,"needsUpdate",void 0),_defineProperty(this,"subLayers",void 0),_defineProperty(this,"usesPickingColorCache",void 0),_defineProperty(this,"hasPickingBuffer",void 0),_defineProperty(this,"changeFlags",void 0),_defineProperty(this,"viewport",void 0),_defineProperty(this,"uniformTransitions",void 0),_defineProperty(this,"propsInTransition",void 0),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const i=this.layer,n=null==i?void 0:i.props.fetch;return n?n(t,{propName:e,layer:i}):super._fetch(e,t)}_onResolve(e,t){const i=this.layer;if(i){const n=i.props.onDataLoad;"data"===e&&n&&n(t,{propName:e,layer:i})}}_onError(e,t){const i=this.layer;i&&i.raiseError(t,"loading ".concat(e," of ").concat(this.layer))}}const TRACE_CHANGE_FLAG="layer.changeFlag",TRACE_INITIALIZE="layer.initialize",TRACE_UPDATE="layer.update",TRACE_FINALIZE="layer.finalize",TRACE_MATCHED="layer.matched",MAX_PICKING_COLOR_CACHE_SIZE=2**24-1,EMPTY_ARRAY$1=Object.freeze([]),areViewportsEqual=memoize((({oldViewport:e,viewport:t})=>e.equals(t)));let pickingColorCache=new Uint8ClampedArray(0);const defaultProps$d={data:{type:"data",value:EMPTY_ARRAY$1,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:e=>e&&e.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(e,{propName:t,layer:i,loaders:n,loadOptions:r,signal:o})=>{const{resourceManager:s}=i.context;var a;(r=r||i.getLoadOptions(),n=n||i.props.loaders,o)&&(r={...r,fetch:{...null===(a=r)||void 0===a?void 0:a.fetch,signal:o}});let l=s.contains(e);return l||r||(s.add({resourceId:e,data:load(e,n),persistent:!1}),l=!0),l?s.subscribe({resourceId:e,onChange:e=>{var n;return null===(n=i.internalState)||void 0===n?void 0:n.reloadAsyncProp(t,e)},consumerId:i.id,requestId:t}):load(e,n,r)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:COORDINATE_SYSTEM.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:e})=>[0,100*-e]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class Layer extends Component{constructor(...e){super(...e),_defineProperty(this,"internalState",null),_defineProperty(this,"lifecycle",LIFECYCLE.NO_STATE),_defineProperty(this,"context",void 0),_defineProperty(this,"state",void 0),_defineProperty(this,"parent",null)}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return"".concat(this.constructor.layerName||this.constructor.name,"({id: '").concat(this.props.id,"'})")}project(e){assert$4(this.internalState);const t=this.internalState.viewport||this.context.viewport,i=getWorldPosition(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[n,r,o]=worldToPixels(i,t.pixelProjectionMatrix);return 2===e.length?[n,r]:[n,r,o]}unproject(e){assert$4(this.internalState);return(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){assert$4(this.internalState);return projectPosition(e,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(e){for(const t of this.getModels())t.updateModuleSettings(e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===COORDINATE_SYSTEM.DEFAULT||e===COORDINATE_SYSTEM.LNGLAT||e===COORDINATE_SYSTEM.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){assert$4(e instanceof Uint8Array);const[t,i,n]=e;return t+256*i+65536*n-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&void 0!==this.state.numInstances?this.state.numInstances:count(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;return null===(e=this.getAttributeManager())||void 0===e?void 0:e.getBounds(["positions","instancePositions"])}getShaders(e){for(const t of this.props.extensions)e=mergeShaders(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&t)if(Array.isArray(i))for(const e of i)t.invalidateAll(e);else t.invalidateAll();if(t){const{props:i}=e,n=this.internalState.hasPickingBuffer,r=Number.isInteger(i.highlightedObjectIndex)||i.pickable||i.extensions.some((e=>e.getNeedsPickingBuffer.call(this,e)));if(n!==r){this.internalState.hasPickingBuffer=r;const{pickingColors:e,instancePickingColors:i}=t.attributes,n=e||i;n&&(r&&n.constant&&(n.constant=!1,t.invalidate(n.id)),n.value||r||(n.constant=!0,n.value=[0,0,0]))}}}finalizeState(e){for(const e of this.getModels())e.delete();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e)}getPickingInfo({info:e}){const{index:t}=e;return t>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[t]),e}raiseError(e,t){var i,n,r,o;(t&&(e=new Error("".concat(t,": ").concat(e.message),{cause:e})),null!==(i=(n=this.props).onError)&&void 0!==i&&i.call(n,e))||(null===(r=this.context)||void 0===r||null===(o=r.onError)||void 0===o||o.call(r,e,this))}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){var e;return(null===(e=this.internalState)||void 0===e?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,t&&areViewportsEqual({oldViewport:t,viewport:e})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&("all"===e?t.invalidateAll():t.invalidate(e))}updateAttributes(e){for(const t of this.getModels())this._setModelAttributes(t,e)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,i=this.getNumInstances(),n=this.getStartIndices();e.update({data:t.data,numInstances:i,startIndices:n,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const r=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(r)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),i=Object.create(this.props);for(const e in t)Object.defineProperty(i,e,{value:t[e]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const i=Math.floor(pickingColorCache.length/3);if(this.internalState.usesPickingColorCache=!0,i<t){t>MAX_PICKING_COLOR_CACHE_SIZE&&log$3.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),pickingColorCache=defaultTypedArrayManager.allocate(pickingColorCache,t,{size:3,copy:!0,maxCount:Math.max(t,MAX_PICKING_COLOR_CACHE_SIZE)});const e=Math.floor(pickingColorCache.length/3),n=[];for(let t=i;t<e;t++)this.encodePickingColor(t,n),pickingColorCache[3*t+0]=n[0],pickingColorCache[3*t+1]=n[1],pickingColorCache[3*t+2]=n[2]}e.value=pickingColorCache.subarray(0,3*t)}_setModelAttributes(e,t){const i=this.getAttributeManager().getShaderAttributes(t,e.userData.excludeAttributes||{});e.setAttributes(i)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t))return void this._disablePickingIndex(e);const{pickingColors:i,instancePickingColors:n}=this.getAttributeManager().attributes,r=i||n,o=r&&t.attributes&&t.attributes[r.id];if(o&&o.value){const i=o.value,n=this.encodePickingColor(e);for(let e=0;e<t.length;e++){const t=r.getVertexOffset(e);i[t]===n[0]&&i[t+1]===n[1]&&i[t+2]===n[2]&&this._disablePickingIndex(e)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,n=t||i;if(!n)return;const r=n.getVertexOffset(e),o=n.getVertexOffset(e+1);n.buffer.subData({data:new Uint8Array(o-r),offset:r})}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;i&&(this.internalState.usesPickingColorCache&&i.value.buffer!==pickingColorCache.buffer&&(i.value=pickingColorCache.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){assert$4(!this.internalState),assert$4(Number.isFinite(this.props.coordinateSystem)),debug(TRACE_INITIALIZE,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new LayerState({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(log$3.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new UniformTransitionManager(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const e of this.props.extensions)e.initializeState.call(this,this.context,e);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){debug(TRACE_MATCHED,this,this===e);const{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(debug(TRACE_UPDATE,this,e),!e)return;const t=this.props,i=this.context,n=this.internalState,r=i.viewport,o=this._updateUniformTransition();n.propsInTransition=o,i.viewport=n.viewport||r,this.props=o;try{const e=this._getUpdateParams(),t=this.getModels();if(i.gl)this.updateState(e);else try{this.updateState(e)}catch(e){}for(const t of this.props.extensions)t.updateState.call(this,e,t);const n=this.getModels()[0]!==t[0];this._postUpdate(e,n)}finally{i.viewport=r,this.props=t,this._clearChangeFlags(),n.needsUpdate=!1,n.resetOldProps()}}_finalize(){debug(TRACE_FINALIZE,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({moduleParameters:e=null,uniforms:t={},parameters:i={}}){this._updateAttributeTransition();const n=this.props,r=this.context;this.props=this.internalState.propsInTransition||n;t.opacity=Math.pow(this.props.opacity,1/2.2);try{e&&this.setModuleParameters(e);const{getPolygonOffset:n}=this.props,o=n&&n(t)||[0,0];setParameters(r.gl,{polygonOffset:o}),withParameters(r.gl,i,(()=>{const n={moduleParameters:e,uniforms:t,parameters:i,context:r};for(const e of this.props.extensions)e.draw.call(this,n,e);this.draw(n)}))}finally{this.props=n}}getChangeFlags(){var e;return null===(e=this.internalState)||void 0===e?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const i in e)if(e[i]){let n=!1;if("dataChanged"===i){const r=e[i],o=t[i];r&&Array.isArray(o)&&(t.dataChanged=Array.isArray(r)?o.concat(r):r,n=!0)}t[i]||(t[i]=e[i],n=!0),n&&debug(TRACE_CHANGE_FLAG,this,i,e)}const i=Boolean(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=i,t.somethingChanged=i||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){const i=diffProps(e,t);if(i.updateTriggersChanged)for(const e in i.updateTriggersChanged)i.updateTriggersChanged[e]&&this.invalidateAttribute(e);if(i.transitionsChanged)for(const r in i.transitionsChanged){var n;this.internalState.uniformTransitions.add(r,t[r],e[r],null===(n=e.transitions)||void 0===n?void 0:n[r])}return this.setChangeFlags(i)}validateProps(){validateProps(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={pickingSelectedColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&"function"==typeof i&&(t.pickingHighlightColor=i(e)),this.setModuleParameters(t),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new AttributeManager(e.gl,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:i,oldProps:n}=e;this.setNeedsRedraw(),this._updateAttributes();const{model:r}=this.state;null==r||r.setInstanceCount(this.getNumInstances());const{autoHighlight:o,highlightedObjectIndex:s,highlightColor:a}=i;if(t||n.autoHighlight!==o||n.highlightedObjectIndex!==s||n.highlightColor!==a){const e={};o||(e.pickingSelectedColor=null),Array.isArray(a)&&(e.pickingHighlightColor=a),(t||s!==n.highlightedObjectIndex)&&(e.pickingSelectedColor=Number.isFinite(s)&&s>=0?this.encodePickingColor(s):null),this.setModuleParameters(e)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const i=this.getAttributeManager(),n=!!i&&i.getNeedsRedraw(e);if(t=t||n,t)for(const e of this.props.extensions)e.onNeedsRedraw.call(this,e);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}_defineProperty(Layer,"defaultProps",defaultProps$d),_defineProperty(Layer,"layerName","Layer");const TRACE_RENDER_LAYERS="compositeLayer.renderLayers";class CompositeLayer extends Layer{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every((e=>e.isLoaded))}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id?(e.object=t.__source.object,e.index=t.__source.index,e):e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){const{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if("function"==typeof e){const t={index:-1,data:this.props.data,target:[]};return(i,n)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,n)}return e}getSubLayerProps(e={}){var t;const{opacity:i,pickable:n,visible:r,parameters:o,getPolygonOffset:s,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:d,positionFormat:p,modelMatrix:f,extensions:m,fetch:g,operation:_,_subLayerProps:y}=this.props,v={id:"",updateTriggers:{},opacity:i,pickable:n,visible:r,parameters:o,getPolygonOffset:s,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:d,positionFormat:p,modelMatrix:f,extensions:m,fetch:g,operation:_},x=y&&e.id&&y[e.id],b=x&&x.updateTriggers,T=e.id||"sublayer";if(x){const t=this.props[PROP_TYPES_SYMBOL],i=e.type?e.type._propTypes:{};for(const e in x){const n=i[e]||t[e];n&&"accessor"===n.type&&(x[e]=this.getSubLayerAccessor(x[e]))}}Object.assign(v,e,x),v.id="".concat(this.props.id,"-").concat(T),v.updateTriggers={all:null===(t=this.props.updateTriggers)||void 0===t?void 0:t.all,...e.updateTriggers,...b};for(const e of m){const t=e.getSubLayerProps.call(this,e);t&&Object.assign(v,t,{updateTriggers:Object.assign(v.updateTriggers,t.updateTriggers)})}return v}_updateAutoHighlight(e){for(const t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let i=this.internalState.subLayers;const n=!i||this.needsUpdate();if(n){i=flatten$1(this.renderLayers(),Boolean),this.internalState.subLayers=i}debug(TRACE_RENDER_LAYERS,this,n,i);for(const e of i)e.parent=this}}_defineProperty(CompositeLayer,"layerName","CompositeLayer");class Tesselator{constructor(e){_defineProperty(this,"opts",void 0),_defineProperty(this,"typedArrayManager",void 0),_defineProperty(this,"indexStarts",[0]),_defineProperty(this,"vertexStarts",[0]),_defineProperty(this,"vertexCount",0),_defineProperty(this,"instanceCount",0),_defineProperty(this,"attributes",void 0),_defineProperty(this,"_attributeDefs",void 0),_defineProperty(this,"data",void 0),_defineProperty(this,"getGeometry",void 0),_defineProperty(this,"geometryBuffer",void 0),_defineProperty(this,"buffers",void 0),_defineProperty(this,"positionSize",void 0),_defineProperty(this,"normalize",void 0);const{attributes:t={}}=e;this.typedArrayManager=defaultTypedArrayManager,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:t,buffers:i={},getGeometry:n,geometryBuffer:r,positionFormat:o,dataChanged:s,normalize:a=!0}=this.opts;if(this.data=t,this.getGeometry=n,this.positionSize=r&&r.size||("XY"===o?2:3),this.buffers=i,this.normalize=a,r&&(assert$4(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(r),a||(i.positions=r)),this.geometryBuffer=i.positions,Array.isArray(s))for(const e of s)this._rebuildGeometry(e);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){const t=e.value||e;return ArrayBuffer.isView(t)?getAccessorFromBuffer(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){const{attributes:i,buffers:n,_attributeDefs:r,typedArrayManager:o}=this;for(const s in r)if(s in n)o.release(i[s]),i[s]=null;else{const n=r[s];n.copy=t,i[s]=o.allocate(i[s],e,n)}}_forEachGeometry(e,t,i){const{data:n,getGeometry:r}=this,{iterable:o,objectInfo:s}=createIterable(n,t,i);for(const t of o){s.index++;e(r?r(t,s):null,s.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:i,instanceCount:n}=this;const{data:r,geometryBuffer:o}=this,{startRow:s=0,endRow:a=1/0}=e||{},l={};if(e||(t=[0],i=[0]),this.normalize||!o)this._forEachGeometry(((e,t)=>{const n=e&&this.normalizeGeometry(e);l[t]=n,i[t+1]=i[t]+(n?this.getGeometrySize(n):0)}),s,a),n=i[i.length-1];else if(i=r.startIndices,n=i[r.length]||0,ArrayBuffer.isView(o))n=n||o.length/this.positionSize;else if(o instanceof Buffer){n=n||o.byteLength/(o.accessor.stride||4*this.positionSize)}else if(o.buffer){n=n||o.buffer.byteLength/(o.stride||4*this.positionSize)}else if(o.value){const e=o.value;n=n||e.length/(o.stride/e.BYTES_PER_ELEMENT||this.positionSize)}this._allocate(n,Boolean(e)),this.indexStarts=t,this.vertexStarts=i,this.instanceCount=n;const c={};this._forEachGeometry(((e,r)=>{const o=l[r]||e;c.vertexStart=i[r],c.indexStart=t[r];c.geometrySize=(r<i.length-1?i[r+1]:n)-i[r],c.geometryIndex=r,this.updateGeometryAttributes(o,c)}),s,a),this.vertexCount=t[t.length-1]}}var vs$8="#define SHADER_NAME icon-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute float instanceSizes;\nattribute float instanceAngles;\nattribute vec4 instanceColors;\nattribute vec3 instancePickingColors;\nattribute vec4 instanceIconFrames;\nattribute float instanceColorModes;\nattribute vec2 instanceOffsets;\nattribute vec2 instancePixelOffset;\n\nuniform float sizeScale;\nuniform vec2 iconsTextureDim;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform bool billboard;\nuniform int sizeUnits;\n\nvarying float vColorMode;\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvec2 rotate_by_angle(vec2 vertex, float angle) {\n  float angle_radian = angle * PI / 180.0;\n  float cos_angle = cos(angle_radian);\n  float sin_angle = sin(angle_radian);\n  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);\n  return rotationMatrix * vertex;\n}\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.uv = positions;\n  geometry.pickingColor = instancePickingColors;\n  uv = positions;\n\n  vec2 iconSize = instanceIconFrames.zw;\n  float sizePixels = clamp(\n    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), \n    sizeMinPixels, sizeMaxPixels\n  );\n  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;\n  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;\n  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;\n  pixelOffset += instancePixelOffset;\n  pixelOffset.y *= -1.0;\n\n  if (billboard)  {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = vec3(pixelOffset, 0.0);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n\n  } else {\n    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);\n    DECKGL_FILTER_SIZE(offset_common, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); \n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n\n  vTextureCoords = mix(\n    instanceIconFrames.xy,\n    instanceIconFrames.xy + iconSize,\n    (positions.xy + 1.0) / 2.0\n  ) / iconsTextureDim;\n\n  vColor = instanceColors;\n  DECKGL_FILTER_COLOR(vColor, geometry);\n\n  vColorMode = instanceColorModes;\n}\n",fs$a="#define SHADER_NAME icon-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D iconsTexture;\nuniform float alphaCutoff;\n\nvarying float vColorMode;\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  vec4 texColor = texture2D(iconsTexture, vTextureCoords);\n  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);\n  float a = texColor.a * opacity * vColor.a;\n\n  if (a < alphaCutoff) {\n    discard;\n  }\n\n  gl_FragColor = vec4(color, a);\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n";const DEFAULT_CANVAS_WIDTH=1024,DEFAULT_BUFFER$1=4,noop=()=>{},DEFAULT_TEXTURE_PARAMETERS={10241:9987,10240:9729,10242:33071,10243:33071};function nextPowOfTwo$1(e){return Math.pow(2,Math.ceil(Math.log2(e)))}function resizeImage(e,t,i,n){const r=Math.min(i/t.width,n/t.height),o=Math.floor(t.width*r),s=Math.floor(t.height*r);return 1===r?{data:t,width:o,height:s}:(e.canvas.height=s,e.canvas.width=o,e.clearRect(0,0,o,s),e.drawImage(t,0,0,t.width,t.height,0,0,o,s),{data:e.canvas,width:o,height:s})}function getIconId(e){return e&&(e.id||e.url)}function resizeTexture(e,t,i,n){const r=e.width,o=e.height,s=new Texture2D(e.gl,{width:t,height:i,parameters:n});return copyToTexture(e,s,{targetY:0,width:r,height:o}),e.delete(),s}function buildRowMapping(e,t,i){for(let n=0;n<t.length;n++){const{icon:r,xOffset:o}=t[n];e[getIconId(r)]={...r,x:o,y:i}}}function buildMapping$1({icons:e,buffer:t,mapping:i={},xOffset:n=0,yOffset:r=0,rowHeight:o=0,canvasWidth:s}){let a=[];for(let l=0;l<e.length;l++){const c=e[l];if(!i[getIconId(c)]){const{height:e,width:l}=c;n+l+t>s&&(buildRowMapping(i,a,r),n=0,r=o+r+t,o=0,a=[]),a.push({icon:c,xOffset:n}),n=n+l+t,o=Math.max(o,e)}}return a.length>0&&buildRowMapping(i,a,r),{mapping:i,rowHeight:o,xOffset:n,yOffset:r,canvasWidth:s,canvasHeight:nextPowOfTwo$1(o+r+t)}}function getDiffIcons(e,t,i){if(!e||!t)return null;i=i||{};const n={},{iterable:r,objectInfo:o}=createIterable(e);for(const e of r){o.index++;const r=t(e,o),s=getIconId(r);if(!r)throw new Error("Icon is missing.");if(!r.url)throw new Error("Icon url is missing.");n[s]||i[s]&&r.url===i[s].url||(n[s]={...r,source:e,sourceIndex:o.index})}return n}class IconManager{constructor(e,{onUpdate:t=noop,onError:i=noop}){_defineProperty(this,"gl",void 0),_defineProperty(this,"onUpdate",void 0),_defineProperty(this,"onError",void 0),_defineProperty(this,"_loadOptions",null),_defineProperty(this,"_texture",null),_defineProperty(this,"_externalTexture",null),_defineProperty(this,"_mapping",{}),_defineProperty(this,"_textureParameters",null),_defineProperty(this,"_pendingCount",0),_defineProperty(this,"_autoPacking",!1),_defineProperty(this,"_xOffset",0),_defineProperty(this,"_yOffset",0),_defineProperty(this,"_rowHeight",0),_defineProperty(this,"_buffer",DEFAULT_BUFFER$1),_defineProperty(this,"_canvasWidth",DEFAULT_CANVAS_WIDTH),_defineProperty(this,"_canvasHeight",0),_defineProperty(this,"_canvas",null),this.gl=e,this.onUpdate=t,this.onError=i}finalize(){var e;null===(e=this._texture)||void 0===e||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){const t=this._autoPacking?getIconId(e):e;return this._mapping[t]||{}}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:n,textureParameters:r}){var o;(e&&(this._loadOptions=e),void 0!==t&&(this._autoPacking=t),n&&(this._mapping=n),i)&&(null===(o=this._texture)||void 0===o||o.delete(),this._texture=null,this._externalTexture=i);r&&(this._textureParameters=r)}get isLoaded(){return 0===this._pendingCount}packIcons(e,t){if(!this._autoPacking||"undefined"==typeof document)return;const i=Object.values(getDiffIcons(e,t,this._mapping)||{});if(i.length>0){const{mapping:e,xOffset:t,yOffset:n,rowHeight:r,canvasHeight:o}=buildMapping$1({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=r,this._mapping=e,this._xOffset=t,this._yOffset=n,this._canvasHeight=o,this._texture||(this._texture=new Texture2D(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:this._textureParameters||DEFAULT_TEXTURE_PARAMETERS})),this._texture.height!==this._canvasHeight&&(this._texture=resizeTexture(this._texture,this._canvasWidth,this._canvasHeight,this._textureParameters||DEFAULT_TEXTURE_PARAMETERS)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i)}}_loadIcons(e){const t=this._canvas.getContext("2d",{willReadFrequently:!0});for(const i of e)this._pendingCount++,load(i.url,this._loadOptions).then((e=>{const n=getIconId(i),r=this._mapping[n],{x:o,y:s,width:a,height:l}=r,{data:c,width:u,height:h}=resizeImage(t,e,a,l);this._texture.setSubImageData({data:c,x:o+(a-u)/2,y:s+(l-h)/2,width:u,height:h}),r.width=u,r.height=h,this._texture.generateMipmap(),this.onUpdate()})).catch((e=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:e})})).finally((()=>{this._pendingCount--}))}}const DEFAULT_COLOR$7=[0,0,0,255],defaultProps$c={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:e=>e.position},getIcon:{type:"accessor",value:e=>e.icon},getColor:{type:"accessor",value:DEFAULT_COLOR$7},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0}};class IconLayer extends Layer{constructor(...e){super(...e),_defineProperty(this,"state",void 0)}getShaders(){return super.getShaders({vs:vs$8,fs:fs$a,modules:[project32,picking]})}initializeState(){this.state={iconManager:new IconManager(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})};this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:DEFAULT_COLOR$7},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);const{props:t,oldProps:i,changeFlags:n}=e,r=this.getAttributeManager(),{iconAtlas:o,iconMapping:s,data:a,getIcon:l,textureParameters:c}=t,{iconManager:u}=this.state,h=o||this.internalState.isAsyncPropLoading("iconAtlas");if(u.setProps({loadOptions:t.loadOptions,autoPacking:!h,iconAtlas:o,iconMapping:h?s:null,textureParameters:c}),h?i.iconMapping!==t.iconMapping&&r.invalidate("getIcon"):(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getIcon))&&u.packIcons(a,l),n.extensionsChanged){var d;const{gl:e}=this.context;null===(d=this.state.model)||void 0===d||d.delete(),this.state.model=this._getModel(e),r.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,sizeUnits:r,billboard:o,alphaCutoff:s}=this.props,{iconManager:a}=this.state,l=a.getTexture();l&&this.state.model.setUniforms(e).setUniforms({iconsTexture:l,iconsTextureDim:[l.width,l.height],sizeUnits:UNIT[r],sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,billboard:o,alphaCutoff:s}).draw()}_getModel(e){return new Model(e,{...this.getShaders(),id:this.props.id,geometry:new Geometry({drawMode:6,attributes:{positions:{size:2,value:new Float32Array([-1,-1,-1,1,1,1,1,-1])}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var t;const i=null===(t=this.getCurrentLayer())||void 0===t?void 0:t.props.onIconError;i&&i(e)}getInstanceOffset(e){const{width:t,height:i,anchorX:n=t/2,anchorY:r=i/2}=this.state.iconManager.getIconMapping(e);return[t/2-n,i/2-r]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const{x:t,y:i,width:n,height:r}=this.state.iconManager.getIconMapping(e);return[t,i,n,r]}}_defineProperty(IconLayer,"defaultProps",defaultProps$c),_defineProperty(IconLayer,"layerName","IconLayer");var vs$7="#define SHADER_NAME point-cloud-layer-vertex-shader\n\nattribute vec3 positions;\nattribute vec3 instanceNormals;\nattribute vec4 instanceColors;\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform float radiusPixels;\nuniform int sizeUnits;\n\nvarying vec4 vColor;\nvarying vec2 unitPosition;\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.normal = project_normal(instanceNormals);\n  unitPosition = positions.xy;\n  geometry.uv = unitPosition;\n  geometry.pickingColor = instancePickingColors;\n  vec3 offset = vec3(positions.xy * project_size_to_pixel(radiusPixels, sizeUnits), 0.0);\n  DECKGL_FILTER_SIZE(offset, geometry);\n\n  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.), geometry.position);\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  vec3 lightColor = lighting_getLightColor(instanceColors.rgb, project_uCameraPosition, geometry.position.xyz, geometry.normal);\n  vColor = vec4(lightColor, instanceColors.a * opacity);\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs$9="#define SHADER_NAME point-cloud-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying vec2 unitPosition;\n\nvoid main(void) {\n  geometry.uv = unitPosition;\n\n  float distToCenter = length(unitPosition);\n\n  if (distToCenter > 1.0) {\n    discard;\n  }\n\n  gl_FragColor = vColor;\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n";const DEFAULT_COLOR$6=[0,0,0,255],DEFAULT_NORMAL=[0,0,1],defaultProps$b={sizeUnits:"pixels",pointSize:{type:"number",min:0,value:10},getPosition:{type:"accessor",value:e=>e.position},getNormal:{type:"accessor",value:DEFAULT_NORMAL},getColor:{type:"accessor",value:DEFAULT_COLOR$6},material:!0,radiusPixels:{deprecatedFor:"pointSize"}};function normalizeData(e){const{header:t,attributes:i}=e;t&&i&&(e.length=t.vertexCount,i.POSITION&&(i.instancePositions=i.POSITION),i.NORMAL&&(i.instanceNormals=i.NORMAL),i.COLOR_0&&(i.instanceColors=i.COLOR_0))}class PointCloudLayer extends Layer{getShaders(){return super.getShaders({vs:vs$7,fs:fs$9,modules:[project32,gouraudLighting,picking]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceNormals:{size:3,transition:!0,accessor:"getNormal",defaultValue:DEFAULT_NORMAL},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:DEFAULT_COLOR$6}})}updateState(e){const{changeFlags:t,props:i}=e;if(super.updateState(e),t.extensionsChanged){var n;const{gl:e}=this.context;null===(n=this.state.model)||void 0===n||n.delete(),this.state.model=this._getModel(e),this.getAttributeManager().invalidateAll()}t.dataChanged&&normalizeData(i.data)}draw({uniforms:e}){const{pointSize:t,sizeUnits:i}=this.props;this.state.model.setUniforms(e).setUniforms({sizeUnits:UNIT[i],radiusPixels:t}).draw()}_getModel(e){const t=[];for(let e=0;e<3;e++){const i=e/3*Math.PI*2;t.push(2*Math.cos(i),2*Math.sin(i),0)}return new Model(e,{...this.getShaders(),id:this.props.id,geometry:new Geometry({drawMode:4,attributes:{positions:new Float32Array(t)}}),isInstanced:!0})}}_defineProperty(PointCloudLayer,"layerName","PointCloudLayer"),_defineProperty(PointCloudLayer,"defaultProps",defaultProps$b);var vs$6="#define SHADER_NAME scatterplot-layer-vertex-shader\n\nattribute vec3 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute float instanceRadius;\nattribute float instanceLineWidths;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform float radiusScale;\nuniform float radiusMinPixels;\nuniform float radiusMaxPixels;\nuniform float lineWidthScale;\nuniform float lineWidthMinPixels;\nuniform float lineWidthMaxPixels;\nuniform float stroked;\nuniform bool filled;\nuniform bool antialiasing;\nuniform bool billboard;\nuniform int radiusUnits;\nuniform int lineWidthUnits;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying vec2 unitPosition;\nvarying float innerUnitRadius;\nvarying float outerRadiusPixels;\n\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  outerRadiusPixels = clamp(\n    project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),\n    radiusMinPixels, radiusMaxPixels\n  );\n  float lineWidthPixels = clamp(\n    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),\n    lineWidthMinPixels, lineWidthMaxPixels\n  );\n  outerRadiusPixels += stroked * lineWidthPixels / 2.0;\n  float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;\n  unitPosition = edgePadding * positions.xy;\n  geometry.uv = unitPosition;\n  geometry.pickingColor = instancePickingColors;\n\n  innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;\n  \n  if (billboard) {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = edgePadding * positions * outerRadiusPixels;\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  } else {\n    vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);\n  DECKGL_FILTER_COLOR(vFillColor, geometry);\n  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);\n  DECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs$8="#define SHADER_NAME scatterplot-layer-fragment-shader\n\nprecision highp float;\n\nuniform bool filled;\nuniform float stroked;\nuniform bool antialiasing;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying vec2 unitPosition;\nvarying float innerUnitRadius;\nvarying float outerRadiusPixels;\n\nvoid main(void) {\n  geometry.uv = unitPosition;\n\n  float distToCenter = length(unitPosition) * outerRadiusPixels;\n  float inCircle = antialiasing ? \n    smoothedge(distToCenter, outerRadiusPixels) : \n    step(distToCenter, outerRadiusPixels);\n\n  if (inCircle == 0.0) {\n    discard;\n  }\n\n  if (stroked > 0.5) {\n    float isLine = antialiasing ? \n      smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :\n      step(innerUnitRadius * outerRadiusPixels, distToCenter);\n\n    if (filled) {\n      gl_FragColor = mix(vFillColor, vLineColor, isLine);\n    } else {\n      if (isLine == 0.0) {\n        discard;\n      }\n      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);\n    }\n  } else if (!filled) {\n    discard;\n  } else {\n    gl_FragColor = vFillColor;\n  }\n\n  gl_FragColor.a *= inCircle;\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n";const DEFAULT_COLOR$5=[0,0,0,255],defaultProps$a={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:e=>e.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:DEFAULT_COLOR$5},getLineColor:{type:"accessor",value:DEFAULT_COLOR$5},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class ScatterplotLayer extends Layer{getShaders(){return super.getShaders({vs:vs$6,fs:fs$8,modules:[project32,picking]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){if(super.updateState(e),e.changeFlags.extensionsChanged){var t;const{gl:e}=this.context;null===(t=this.state.model)||void 0===t||t.delete(),this.state.model=this._getModel(e),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{radiusUnits:t,radiusScale:i,radiusMinPixels:n,radiusMaxPixels:r,stroked:o,filled:s,billboard:a,antialiasing:l,lineWidthUnits:c,lineWidthScale:u,lineWidthMinPixels:h,lineWidthMaxPixels:d}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:o?1:0,filled:s,billboard:a,antialiasing:l,radiusUnits:UNIT[t],radiusScale:i,radiusMinPixels:n,radiusMaxPixels:r,lineWidthUnits:UNIT[c],lineWidthScale:u,lineWidthMinPixels:h,lineWidthMaxPixels:d}).draw()}_getModel(e){return new Model(e,{...this.getShaders(),id:this.props.id,geometry:new Geometry({drawMode:6,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0])}}}),isInstanced:!0})}}_defineProperty(ScatterplotLayer,"defaultProps",defaultProps$a),_defineProperty(ScatterplotLayer,"layerName","ScatterplotLayer");const WINDING={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function modifyPolygonWindingDirection(e,t,i={}){return getPolygonWindingDirection(e,i)!==t&&(reversePolygon(e,i),!0)}function getPolygonWindingDirection(e,t={}){return Math.sign(getPolygonSignedArea(e,t))}function getPolygonSignedArea(e,t={}){const{start:i=0,end:n=e.length}=t,r=t.size||2;let o=0;for(let t=i,s=n-r;t<n;t+=r)o+=(e[t]-e[s])*(e[t+1]+e[s+1]),s=t;return o/2}function reversePolygon(e,t){const{start:i=0,end:n=e.length,size:r=2}=t,o=(n-i)/r,s=Math.floor(o/2);for(let t=0;t<s;++t){const n=i+t*r,s=i+(o-1-t)*r;for(let t=0;t<r;++t){const i=e[n+t];e[n+t]=e[s+t],e[s+t]=i}}}function push(e,t){const i=t.length,n=e.length;if(n>0){let r=!0;for(let o=0;o<i;o++)if(e[n-i+o]!==t[o]){r=!1;break}if(r)return!1}for(let r=0;r<i;r++)e[n+r]=t[r];return!0}function copy(e,t){const i=t.length;for(let n=0;n<i;n++)e[n]=t[n]}function getPointAtIndex(e,t,i,n,r=[]){const o=n+t*i;for(let t=0;t<i;t++)r[t]=e[o+t];return r}function intersect$1(e,t,i,n,r=[]){let o,s;if(8&i)o=(n[3]-e[1])/(t[1]-e[1]),s=3;else if(4&i)o=(n[1]-e[1])/(t[1]-e[1]),s=1;else if(2&i)o=(n[2]-e[0])/(t[0]-e[0]),s=2;else{if(!(1&i))return null;o=(n[0]-e[0])/(t[0]-e[0]),s=0}for(let i=0;i<e.length;i++)r[i]=(1&s)===i?n[s]:o*(t[i]-e[i])+e[i];return r}function bitCode(e,t){let i=0;return e[0]<t[0]?i|=1:e[0]>t[2]&&(i|=2),e[1]<t[1]?i|=4:e[1]>t[3]&&(i|=8),i}function cutPolylineByGrid(e,t){const{size:i=2,broken:n=!1,gridResolution:r=10,gridOffset:o=[0,0],startIndex:s=0,endIndex:a=e.length}=t||{},l=(a-s)/i;let c=[];const u=[c],h=getPointAtIndex(e,0,i,s);let d,p;const f=getGridCell(h,r,o,[]),m=[];push(c,h);for(let t=1;t<l;t++){for(d=getPointAtIndex(e,t,i,s,d),p=bitCode(d,f);p;){intersect$1(h,d,p,f,m);const e=bitCode(m,f);e&&(intersect$1(h,m,e,f,m),p=e),push(c,m),copy(h,m),moveToNeighborCell(f,r,p),n&&c.length>i&&(c=[],u.push(c),push(c,h)),p=bitCode(d,f)}push(c,d),copy(h,d)}return n?u:u[0]}const TYPE_INSIDE=0,TYPE_BORDER=1;function concatInPlace(e,t){for(let i=0;i<t.length;i++)e.push(t[i]);return e}function cutPolygonByGrid(e,t=null,i){if(!e.length)return[];const{size:n=2,gridResolution:r=10,gridOffset:o=[0,0],edgeTypes:s=!1}=i||{},a=[],l=[{pos:e,types:s?new Array(e.length/n).fill(TYPE_BORDER):null,holes:t||[]}],c=[[],[]];let u=[];for(;l.length;){const{pos:e,types:t,holes:i}=l.shift();getBoundingBox(e,n,i[0]||e.length,c),u=getGridCell(c[0],r,o,u);const h=bitCode(c[1],u);if(h){let r=bisectPolygon(e,t,n,0,i[0]||e.length,u,h);const o={pos:r[0].pos,types:r[0].types,holes:[]},a={pos:r[1].pos,types:r[1].types,holes:[]};l.push(o,a);for(let l=0;l<i.length;l++)r=bisectPolygon(e,t,n,i[l],i[l+1]||e.length,u,h),r[0]&&(o.holes.push(o.pos.length),o.pos=concatInPlace(o.pos,r[0].pos),s&&(o.types=concatInPlace(o.types,r[0].types))),r[1]&&(a.holes.push(a.pos.length),a.pos=concatInPlace(a.pos,r[1].pos),s&&(a.types=concatInPlace(a.types,r[1].types)))}else{const n={positions:e};s&&(n.edgeTypes=t),i.length&&(n.holeIndices=i),a.push(n)}}return a}function bisectPolygon(e,t,i,n,r,o,s){const a=(r-n)/i,l=[],c=[],u=[],h=[],d=[];let p,f,m;const g=getPointAtIndex(e,a-1,i,n);let _=Math.sign(8&s?g[1]-o[3]:g[0]-o[2]),y=t&&t[a-1],v=0,x=0;for(let r=0;r<a;r++)p=getPointAtIndex(e,r,i,n,p),f=Math.sign(8&s?p[1]-o[3]:p[0]-o[2]),m=t&&t[n/i+r],f&&_&&_!==f&&(intersect$1(g,p,s,o,d),push(l,d)&&u.push(y),push(c,d)&&h.push(y)),f<=0?(push(l,p)&&u.push(m),v-=f):u.length&&(u[u.length-1]=TYPE_INSIDE),f>=0?(push(c,p)&&h.push(m),x+=f):h.length&&(h[h.length-1]=TYPE_INSIDE),copy(g,p),_=f,y=m;return[v?{pos:l,types:t&&u}:null,x?{pos:c,types:t&&h}:null]}function getGridCell(e,t,i,n){const r=Math.floor((e[0]-i[0])/t)*t+i[0],o=Math.floor((e[1]-i[1])/t)*t+i[1];return n[0]=r,n[1]=o,n[2]=r+t,n[3]=o+t,n}function moveToNeighborCell(e,t,i){8&i?(e[1]+=t,e[3]+=t):4&i?(e[1]-=t,e[3]-=t):2&i?(e[0]+=t,e[2]+=t):1&i&&(e[0]-=t,e[2]-=t)}function getBoundingBox(e,t,i,n){let r=1/0,o=-1/0,s=1/0,a=-1/0;for(let n=0;n<i;n+=t){const t=e[n],i=e[n+1];r=t<r?t:r,o=t>o?t:o,s=i<s?i:s,a=i>a?i:a}return n[0][0]=r,n[0][1]=s,n[1][0]=o,n[1][1]=a,n}const DEFAULT_MAX_LATITUDE=85.051129;function cutPolylineByMercatorBounds(e,t){const{size:i=2,startIndex:n=0,endIndex:r=e.length,normalize:o=!0}=t||{},s=e.slice(n,r);wrapLongitudesForShortestPath(s,i,0,r-n);const a=cutPolylineByGrid(s,{size:i,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(o)for(const e of a)shiftLongitudesIntoRange(e,i);return a}function cutPolygonByMercatorBounds(e,t=null,i){const{size:n=2,normalize:r=!0,edgeTypes:o=!1}=i||{};t=t||[];const s=[],a=[];let l=0,c=0;for(let r=0;r<=t.length;r++){const o=t[r]||e.length,u=c,h=findSplitIndex(e,n,l,o);for(let t=h;t<o;t++)s[c++]=e[t];for(let t=l;t<h;t++)s[c++]=e[t];wrapLongitudesForShortestPath(s,n,u,c),insertPoleVertices(s,n,u,c,null==i?void 0:i.maxLatitude),l=o,a[r]=c}a.pop();const u=cutPolygonByGrid(s,a,{size:n,gridResolution:360,gridOffset:[-180,-180],edgeTypes:o});if(r)for(const e of u)shiftLongitudesIntoRange(e.positions,n);return u}function findSplitIndex(e,t,i,n){let r=-1,o=-1;for(let s=i+1;s<n;s+=t){const t=Math.abs(e[s]);t>r&&(r=t,o=s-1)}return o}function insertPoleVertices(e,t,i,n,r=DEFAULT_MAX_LATITUDE){const o=e[i],s=e[n-t];if(Math.abs(o-s)>180){const n=getPointAtIndex(e,0,t,i);n[0]+=360*Math.round((s-o)/360),push(e,n),n[1]=Math.sign(n[1])*r,push(e,n),n[0]=o,push(e,n)}}function wrapLongitudesForShortestPath(e,t,i,n){let r,o=e[0];for(let s=i;s<n;s+=t){r=e[s];const t=r-o;(t>180||t<-180)&&(r-=360*Math.round(t/360)),e[s]=o=r}}function shiftLongitudesIntoRange(e,t){let i;const n=e.length/t;for(let r=0;r<n&&(i=e[r*t],(i+180)%360==0);r++);const r=360*-Math.round(i/360);if(0!==r)for(let i=0;i<n;i++)e[i*t]+=r}function normalizePath(e,t,i,n){let r;if(Array.isArray(e[0])){r=new Array(e.length*t);for(let i=0;i<e.length;i++)for(let n=0;n<t;n++)r[i*t+n]=e[i][n]||0}else r=e;return i?cutPolylineByGrid(r,{size:t,gridResolution:i}):n?cutPolylineByMercatorBounds(r,{size:t}):r}const START_CAP=1,END_CAP=2,INVALID=4;class PathTesselator extends Tesselator{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?normalizePath(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(isCut$1(e)){let t=0;for(const i of e)t+=this.getGeometrySize(i);return t}const t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(0!==t.geometrySize)if(e&&isCut$1(e))for(const i of e){const e=this.getGeometrySize(i);t.geometrySize=e,this.updateGeometryAttributes(i,t),t.vertexStart+=e}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){const i=this.attributes.segmentTypes,n=!!e&&this.isClosed(e),{vertexStart:r,geometrySize:o}=t;i.fill(0,r,r+o),n?(i[r]=INVALID,i[r+o-2]=INVALID):(i[r]+=START_CAP,i[r+o-2]+=END_CAP),i[r+o-1]=INVALID}_updatePositions(e,t){const{positions:i}=this.attributes;if(!i||!e)return;const{vertexStart:n,geometrySize:r}=t,o=new Array(3);for(let t=n,s=0;s<r;t++,s++)this.getPointOnPath(e,s,o),i[3*t]=o[0],i[3*t+1]=o[1],i[3*t+2]=o[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,i=[]){const{positionSize:n}=this;t*n>=e.length&&(t+=1-e.length/n);const r=t*n;return i[0]=e[r],i[1]=e[r+1],i[2]=3===n&&e[r+2]||0,i}isClosed(e){if(!this.normalize)return Boolean(this.opts.loop);const{positionSize:t}=this,i=e.length-t;return e[0]===e[i]&&e[1]===e[i+1]&&(2===t||e[2]===e[i+2])}}function isCut$1(e){return Array.isArray(e[0])}var vs$5="#define SHADER_NAME path-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute float instanceTypes;\nattribute vec3 instanceStartPositions;\nattribute vec3 instanceEndPositions;\nattribute vec3 instanceLeftPositions;\nattribute vec3 instanceRightPositions;\nattribute vec3 instanceLeftPositions64Low;\nattribute vec3 instanceStartPositions64Low;\nattribute vec3 instanceEndPositions64Low;\nattribute vec3 instanceRightPositions64Low;\nattribute float instanceStrokeWidths;\nattribute vec4 instanceColors;\nattribute vec3 instancePickingColors;\n\nuniform float widthScale;\nuniform float widthMinPixels;\nuniform float widthMaxPixels;\nuniform float jointType;\nuniform float capType;\nuniform float miterLimit;\nuniform bool billboard;\nuniform int widthUnits;\n\nuniform float opacity;\n\nvarying vec4 vColor;\nvarying vec2 vCornerOffset;\nvarying float vMiterLength;\nvarying vec2 vPathPosition;\nvarying float vPathLength;\nvarying float vJointType;\n\nconst float EPSILON = 0.001;\nconst vec3 ZERO_OFFSET = vec3(0.0);\n\nfloat flipIfTrue(bool flag) {\n  return -(float(flag) * 2. - 1.);\n}\nvec3 getLineJoinOffset(\n  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,\n  vec2 width\n) {\n  bool isEnd = positions.x > 0.0;\n  float sideOfPath = positions.y;\n  float isJoint = float(sideOfPath == 0.0);\n\n  vec3 deltaA3 = (currPoint - prevPoint);\n  vec3 deltaB3 = (nextPoint - currPoint);\n\n  mat3 rotationMatrix;\n  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);\n  if (needsRotation) {\n    deltaA3 = deltaA3 * rotationMatrix;\n    deltaB3 = deltaB3 * rotationMatrix;\n  }\n  vec2 deltaA = deltaA3.xy / width;\n  vec2 deltaB = deltaB3.xy / width;\n\n  float lenA = length(deltaA);\n  float lenB = length(deltaB);\n\n  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);\n  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);\n\n  vec2 perpA = vec2(-dirA.y, dirA.x);\n  vec2 perpB = vec2(-dirB.y, dirB.x);\n  vec2 tangent = dirA + dirB;\n  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;\n  vec2 miterVec = vec2(-tangent.y, tangent.x);\n  vec2 dir = isEnd ? dirA : dirB;\n  vec2 perp = isEnd ? perpA : perpB;\n  float L = isEnd ? lenA : lenB;\n  float sinHalfA = abs(dot(miterVec, perp));\n  float cosHalfA = abs(dot(dirA, miterVec));\n  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);\n  float cornerPosition = sideOfPath * turnDirection;\n\n  float miterSize = 1.0 / max(sinHalfA, EPSILON);\n  miterSize = mix(\n    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),\n    miterSize,\n    step(0.0, cornerPosition)\n  );\n\n  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))\n    * (sideOfPath + isJoint * turnDirection);\n  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));\n  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));\n  bool isCap = isStartCap || isEndCap;\n  if (isCap) {\n    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);\n    vJointType = capType;\n  } else {\n    vJointType = jointType;\n  }\n  vPathLength = L;\n  vCornerOffset = offsetVec;\n  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);\n  vMiterLength = isCap ? isJoint : vMiterLength;\n\n  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);\n  vPathPosition = vec2(\n    dot(offsetFromStartOfPath, perp),\n    dot(offsetFromStartOfPath, dir)\n  );\n  geometry.uv = vPathPosition;\n\n  float isValid = step(instanceTypes, 3.5);\n  vec3 offset = vec3(offsetVec * width * isValid, 0.0);\n\n  if (needsRotation) {\n    offset = rotationMatrix * offset;\n  }\n  return offset;\n}\nvoid clipLine(inout vec4 position, vec4 refPosition) {\n  if (position.w < EPSILON) {\n    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);\n    position = refPosition + (position - refPosition) * r;\n  }\n}\n\nvoid main() {\n  geometry.pickingColor = instancePickingColors;\n\n  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);\n\n  float isEnd = positions.x;\n\n  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);\n  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);\n\n  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);\n  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);\n\n  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);\n  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);\n\n  geometry.worldPosition = currPosition;\n  vec2 widthPixels = vec2(clamp(\n    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),\n    widthMinPixels, widthMaxPixels) / 2.0);\n  vec3 width;\n\n  if (billboard) {\n    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);\n    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);\n    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);\n\n    clipLine(prevPositionScreen, currPositionScreen);\n    clipLine(nextPositionScreen, currPositionScreen);\n    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));\n\n    width = vec3(widthPixels, 0.0);\n    DECKGL_FILTER_SIZE(width, geometry);\n\n    vec3 offset = getLineJoinOffset(\n      prevPositionScreen.xyz / prevPositionScreen.w,\n      currPositionScreen.xyz / currPositionScreen.w,\n      nextPositionScreen.xyz / nextPositionScreen.w,\n      project_pixel_size_to_clipspace(width.xy)\n    );\n\n    DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);\n    gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);\n  } else {\n    prevPosition = project_position(prevPosition, prevPosition64Low);\n    currPosition = project_position(currPosition, currPosition64Low);\n    nextPosition = project_position(nextPosition, nextPosition64Low);\n\n    width = vec3(project_pixel_size(widthPixels), 0.0);\n    DECKGL_FILTER_SIZE(width, geometry);\n\n    vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);\n    geometry.position = vec4(currPosition + offset, 1.0);\n    gl_Position = project_common_position_to_clipspace(geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs$7="#define SHADER_NAME path-layer-fragment-shader\n\nprecision highp float;\n\nuniform float miterLimit;\n\nvarying vec4 vColor;\nvarying vec2 vCornerOffset;\nvarying float vMiterLength;\nvarying vec2 vPathPosition;\nvarying float vPathLength;\nvarying float vJointType;\n\nvoid main(void) {\n  geometry.uv = vPathPosition;\n\n  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {\n    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {\n      discard;\n    }\n    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {\n      discard;\n    }\n  }\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n";const DEFAULT_COLOR$4=[0,0,0,255],defaultProps$9={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:e=>e.path},getColor:{type:"accessor",value:DEFAULT_COLOR$4},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},ATTRIBUTE_TRANSITION$1={enter:(e,t)=>t.length?t.subarray(t.length-e.length):e};class PathLayer extends Layer{constructor(...e){super(...e),_defineProperty(this,"state",void 0)}getShaders(){return super.getShaders({vs:vs$5,fs:fs$7,modules:[project32,picking]})}get wrapLongitude(){return!1}initializeState(){const e=!0;this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:ATTRIBUTE_TRANSITION$1,accessor:"getPath",update:this.calculatePositions,noAlloc:e,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:e},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:ATTRIBUTE_TRANSITION$1,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:ATTRIBUTE_TRANSITION$1,defaultValue:DEFAULT_COLOR$4},instancePickingColors:{size:3,type:5121,accessor:(e,{index:t,target:i})=>this.encodePickingColor(e&&e.__source?e.__source.index:t,i)}}),this.setState({pathTesselator:new PathTesselator({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);const{props:t,changeFlags:i}=e,n=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){const{pathTesselator:e}=this.state,r=t.data.attributes||{};e.updateGeometry({data:t.data,geometryBuffer:r.getPath,buffers:r,normalize:!t._pathType,loop:"loop"===t._pathType,getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:e.instanceCount,startIndices:e.vertexStarts}),i.dataChanged||n.invalidateAll()}if(i.extensionsChanged){var r;const{gl:e}=this.context;null===(r=this.state.model)||void 0===r||r.delete(),this.state.model=this._getModel(e),n.invalidateAll()}}getPickingInfo(e){const t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find((e=>e.__source.index===i))),t}disablePickingIndex(e){const{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else super.disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:t,capRounded:i,billboard:n,miterLimit:r,widthUnits:o,widthScale:s,widthMinPixels:a,widthMaxPixels:l}=this.props;this.state.model.setUniforms(e).setUniforms({jointType:Number(t),capType:Number(i),billboard:n,widthUnits:UNIT[o],widthScale:s,miterLimit:r,widthMinPixels:a,widthMaxPixels:l}).draw()}_getModel(e){return new Model(e,{...this.getShaders(),id:this.props.id,geometry:new Geometry({drawMode:4,attributes:{indices:new Uint16Array([0,1,2,1,4,2,1,3,4,3,5,4]),positions:{value:new Float32Array([0,0,0,-1,0,1,1,-1,1,1,1,0]),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}}_defineProperty(PathLayer,"defaultProps",defaultProps$9),_defineProperty(PathLayer,"layerName","PathLayer");var earcut$2={exports:{}},hasRequiredEarcut;function requireEarcut(){if(hasRequiredEarcut)return earcut$2.exports;function e(e,i,r){r=r||2;var o,s,a,u,h,p,f,m=i&&i.length,g=m?i[0]*r:e.length,_=t(e,0,g,r,!0),y=[];if(!_||_.next===_.prev)return y;if(m&&(_=function(e,i,n,r){var o,s,a,u=[];for(o=0,s=i.length;o<s;o++)(a=t(e,i[o]*r,o<s-1?i[o+1]*r:e.length,r,!1))===a.next&&(a.steiner=!0),u.push(d(a));for(u.sort(l),o=0;o<u.length;o++)n=c(u[o],n);return n}(e,i,_,r)),e.length>80*r){o=a=e[0],s=u=e[1];for(var v=r;v<g;v+=r)(h=e[v])<o&&(o=h),(p=e[v+1])<s&&(s=p),h>a&&(a=h),p>u&&(u=p);f=0!==(f=Math.max(a-o,u-s))?32767/f:0}return n(_,y,r,o,s,f,0),y}function t(e,t,i,n,r){var o,s;if(r===S(e,t,i,n)>0)for(o=t;o<i;o+=n)s=T(o,e[o],e[o+1],s);else for(o=i-n;o>=t;o-=n)s=T(o,e[o],e[o+1],s);return s&&g(s,s.next)&&(w(s),s=s.next),s}function i(e,t){if(!e)return e;t||(t=e);var i,n=e;do{if(i=!1,n.steiner||!g(n,n.next)&&0!==m(n.prev,n,n.next))n=n.next;else{if(w(n),(n=t=n.prev)===n.next)break;i=!0}}while(i||n!==t);return t}function n(e,t,l,c,u,d,p){if(e){!p&&d&&function(e,t,i,n){var r=e;do{0===r.z&&(r.z=h(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t,i,n,r,o,s,a,l,c=1;do{for(i=e,e=null,o=null,s=0;i;){for(s++,n=i,a=0,t=0;t<c&&(a++,n=n.nextZ);t++);for(l=c;a>0||l>0&&n;)0!==a&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,l--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;i=n}o.nextZ=null,c*=2}while(s>1)}(r)}(e,c,u,d);for(var f,m,g=e;e.prev!==e.next;)if(f=e.prev,m=e.next,d?o(e,c,u,d):r(e))t.push(f.i/l|0),t.push(e.i/l|0),t.push(m.i/l|0),w(e),e=m.next,g=m.next;else if((e=m)===g){p?1===p?n(e=s(i(e),t,l),t,l,c,u,d,2):2===p&&a(e,t,l,c,u,d):n(i(e),t,l,c,u,d,1);break}}}function r(e){var t=e.prev,i=e,n=e.next;if(m(t,i,n)>=0)return!1;for(var r=t.x,o=i.x,s=n.x,a=t.y,l=i.y,c=n.y,u=r<o?r<s?r:s:o<s?o:s,h=a<l?a<c?a:c:l<c?l:c,d=r>o?r>s?r:s:o>s?o:s,f=a>l?a>c?a:c:l>c?l:c,g=n.next;g!==t;){if(g.x>=u&&g.x<=d&&g.y>=h&&g.y<=f&&p(r,a,o,l,s,c,g.x,g.y)&&m(g.prev,g,g.next)>=0)return!1;g=g.next}return!0}function o(e,t,i,n){var r=e.prev,o=e,s=e.next;if(m(r,o,s)>=0)return!1;for(var a=r.x,l=o.x,c=s.x,u=r.y,d=o.y,f=s.y,g=a<l?a<c?a:c:l<c?l:c,_=u<d?u<f?u:f:d<f?d:f,y=a>l?a>c?a:c:l>c?l:c,v=u>d?u>f?u:f:d>f?d:f,x=h(g,_,t,i,n),b=h(y,v,t,i,n),T=e.prevZ,w=e.nextZ;T&&T.z>=x&&w&&w.z<=b;){if(T.x>=g&&T.x<=y&&T.y>=_&&T.y<=v&&T!==r&&T!==s&&p(a,u,l,d,c,f,T.x,T.y)&&m(T.prev,T,T.next)>=0)return!1;if(T=T.prevZ,w.x>=g&&w.x<=y&&w.y>=_&&w.y<=v&&w!==r&&w!==s&&p(a,u,l,d,c,f,w.x,w.y)&&m(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;T&&T.z>=x;){if(T.x>=g&&T.x<=y&&T.y>=_&&T.y<=v&&T!==r&&T!==s&&p(a,u,l,d,c,f,T.x,T.y)&&m(T.prev,T,T.next)>=0)return!1;T=T.prevZ}for(;w&&w.z<=b;){if(w.x>=g&&w.x<=y&&w.y>=_&&w.y<=v&&w!==r&&w!==s&&p(a,u,l,d,c,f,w.x,w.y)&&m(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function s(e,t,n){var r=e;do{var o=r.prev,s=r.next.next;!g(o,s)&&_(o,r,r.next,s)&&x(o,s)&&x(s,o)&&(t.push(o.i/n|0),t.push(r.i/n|0),t.push(s.i/n|0),w(r),w(r.next),r=e=s),r=r.next}while(r!==e);return i(r)}function a(e,t,r,o,s,a){var l=e;do{for(var c=l.next.next;c!==l.prev;){if(l.i!==c.i&&f(l,c)){var u=b(l,c);return l=i(l,l.next),u=i(u,u.next),n(l,t,r,o,s,a,0),void n(u,t,r,o,s,a,0)}c=c.next}l=l.next}while(l!==e)}function l(e,t){return e.x-t.x}function c(e,t){var n=function(e,t){var i,n=t,r=e.x,o=e.y,s=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var a=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(a<=r&&a>s&&(s=a,i=n.x<n.next.x?n:n.next,a===r))return i}n=n.next}while(n!==t);if(!i)return null;var l,c=i,h=i.x,d=i.y,f=1/0;n=i;do{r>=n.x&&n.x>=h&&r!==n.x&&p(o<d?r:s,o,h,d,o<d?s:r,o,n.x,n.y)&&(l=Math.abs(o-n.y)/(r-n.x),x(n,e)&&(l<f||l===f&&(n.x>i.x||n.x===i.x&&u(i,n)))&&(i=n,f=l)),n=n.next}while(n!==c);return i}(e,t);if(!n)return t;var r=b(n,e);return i(r,r.next),i(n,n.next)}function u(e,t){return m(e.prev,e,t.prev)<0&&m(t.next,e,e.next)<0}function h(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function d(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function p(e,t,i,n,r,o,s,a){return(r-s)*(t-a)>=(e-s)*(o-a)&&(e-s)*(n-a)>=(i-s)*(t-a)&&(i-s)*(o-a)>=(r-s)*(n-a)}function f(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&_(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(x(e,t)&&x(t,e)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)&&(m(e.prev,e,t.prev)||m(e,t.prev,t))||g(e,t)&&m(e.prev,e,e.next)>0&&m(t.prev,t,t.next)>0)}function m(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function g(e,t){return e.x===t.x&&e.y===t.y}function _(e,t,i,n){var r=v(m(e,t,i)),o=v(m(e,t,n)),s=v(m(i,n,e)),a=v(m(i,n,t));return r!==o&&s!==a||(!(0!==r||!y(e,i,t))||(!(0!==o||!y(e,n,t))||(!(0!==s||!y(i,e,n))||!(0!==a||!y(i,t,n)))))}function y(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function v(e){return e>0?1:e<0?-1:0}function x(e,t){return m(e.prev,e,e.next)<0?m(e,t,e.next)>=0&&m(e,e.prev,t)>=0:m(e,t,e.prev)<0||m(e,e.next,t)<0}function b(e,t){var i=new E(e.i,e.x,e.y),n=new E(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function T(e,t,i,n){var r=new E(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function w(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function E(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function S(e,t,i,n){for(var r=0,o=t,s=i-n;o<i;o+=n)r+=(e[s]-e[o])*(e[o+1]+e[s+1]),s=o;return r}return hasRequiredEarcut=1,earcut$2.exports=e,earcut$2.exports.default=e,e.deviation=function(e,t,i,n){var r=t&&t.length,o=Math.abs(S(e,0,r?t[0]*i:e.length,i));if(r)for(var s=0,a=t.length;s<a;s++){o-=Math.abs(S(e,t[s]*i,s<a-1?t[s+1]*i:e.length,i))}var l=0;for(s=0;s<n.length;s+=3){var c=n[s]*i,u=n[s+1]*i,h=n[s+2]*i;l+=Math.abs((e[c]-e[h])*(e[u+1]-e[c+1])-(e[c]-e[u])*(e[h+1]-e[c+1]))}return 0===o&&0===l?0:Math.abs((l-o)/o)},e.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},n=0,r=0;r<e.length;r++){for(var o=0;o<e[r].length;o++)for(var s=0;s<t;s++)i.vertices.push(e[r][o][s]);r>0&&i.holes.push(n+=e[r-1].length)}return i},earcut$2.exports}var earcutExports=requireEarcut(),earcut$1=getDefaultExportFromCjs(earcutExports);const OUTER_POLYGON_WINDING=WINDING.CLOCKWISE,HOLE_POLYGON_WINDING=WINDING.COUNTER_CLOCKWISE,windingOptions={};function validate(e){if(e=e&&e.positions||e,!Array.isArray(e)&&!ArrayBuffer.isView(e))throw new Error("invalid polygon")}function getPositions(e){return"positions"in e?e.positions:e}function getHoleIndices(e){return"holeIndices"in e?e.holeIndices:null}function isNested(e){return Array.isArray(e[0])}function isSimple(e){return e.length>=1&&e[0].length>=2&&Number.isFinite(e[0][0])}function isNestedRingClosed(e){const t=e[0],i=e[e.length-1];return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]}function isFlatRingClosed(e,t,i,n){for(let r=0;r<t;r++)if(e[i+r]!==e[n-t+r])return!1;return!0}function copyNestedRing(e,t,i,n,r){let o=t;const s=i.length;for(let t=0;t<s;t++)for(let r=0;r<n;r++)e[o++]=i[t][r]||0;if(!isNestedRingClosed(i))for(let t=0;t<n;t++)e[o++]=i[0][t]||0;return windingOptions.start=t,windingOptions.end=o,windingOptions.size=n,modifyPolygonWindingDirection(e,r,windingOptions),o}function copyFlatRing(e,t,i,n,r=0,o,s){const a=(o=o||i.length)-r;if(a<=0)return t;let l=t;for(let t=0;t<a;t++)e[l++]=i[r+t];if(!isFlatRingClosed(i,n,r,o))for(let t=0;t<n;t++)e[l++]=i[r+t];return windingOptions.start=t,windingOptions.end=l,windingOptions.size=n,modifyPolygonWindingDirection(e,s,windingOptions),l}function normalize$1(e,t){validate(e);const i=[],n=[];if("positions"in e){const{positions:r,holeIndices:o}=e;if(o){let e=0;for(let s=0;s<=o.length;s++)e=copyFlatRing(i,e,r,t,o[s-1],o[s],0===s?OUTER_POLYGON_WINDING:HOLE_POLYGON_WINDING),n.push(e);return n.pop(),{positions:i,holeIndices:n}}e=r}if(!isNested(e))return copyFlatRing(i,0,e,t,0,i.length,OUTER_POLYGON_WINDING),i;if(!isSimple(e)){let r=0;for(const[o,s]of e.entries())r=copyNestedRing(i,r,s,t,0===o?OUTER_POLYGON_WINDING:HOLE_POLYGON_WINDING),n.push(r);return n.pop(),{positions:i,holeIndices:n}}return copyNestedRing(i,0,e,t,OUTER_POLYGON_WINDING),i}function getPlaneArea(e,t,i){const n=e.length/3;let r=0;for(let o=0;o<n;o++){const s=(o+1)%n;r+=e[3*o+t]*e[3*s+i],r-=e[3*s+t]*e[3*o+i]}return Math.abs(r/2)}function permutePositions(e,t,i,n){const r=e.length/3;for(let o=0;o<r;o++){const r=3*o,s=e[r+1],a=e[r+2];e[r+t]=e[r+0],e[r+i]=s,e[r+n]=a}}function getSurfaceIndices(e,t,i,n){let r=getHoleIndices(e);r&&(r=r.map((e=>e/t)));let o=getPositions(e);const s=n&&3===t;if(i){const e=o.length;o=o.slice();const n=[];for(let r=0;r<e;r+=t){n[0]=o[r],n[1]=o[r+1],s&&(n[2]=o[r+2]);const e=i(n);o[r]=e[0],o[r+1]=e[1],s&&(o[r+2]=e[2])}}if(s){const e=getPlaneArea(o,0,1),t=getPlaneArea(o,0,2),n=getPlaneArea(o,1,2);if(!e&&!t&&!n)return[];e>t&&e>n||(t>n?(i||(o=o.slice()),permutePositions(o,0,2,1)):(i||(o=o.slice()),permutePositions(o,2,0,1)))}return earcut$1(o,r,t)}class PolygonTesselator extends Tesselator{constructor(e){const{fp64:t,IndexType:i=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint8ClampedArray,size:1},indices:{type:i,size:1}}})}get(e){const{attributes:t}=this;return"indices"===e?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);const t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){const t=normalize$1(e,this.positionSize);return this.opts.resolution?cutPolygonByGrid(getPositions(t),getHoleIndices(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?cutPolygonByMercatorBounds(getPositions(t),getHoleIndices(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(isCut(e)){let t=0;for(const i of e)t+=this.getGeometrySize(i);return t}return getPositions(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&isCut(e))for(const i of e){const e=this.getGeometrySize(i);t.geometrySize=e,this.updateGeometryAttributes(i,t),t.vertexStart+=e,t.indexStart=this.indexStarts[t.geometryIndex+1]}else this._updateIndices(e,t),this._updatePositions(e,t),this._updateVertexValid(e,t)}_updateIndices(e,{geometryIndex:t,vertexStart:i,indexStart:n}){const{attributes:r,indexStarts:o,typedArrayManager:s}=this;let a=r.indices;if(!a||!e)return;let l=n;const c=getSurfaceIndices(e,this.positionSize,this.opts.preproject,this.opts.full3d);a=s.allocate(a,n+c.length,{copy:!0});for(let e=0;e<c.length;e++)a[l++]=c[e]+i;o[t+1]=n+c.length,r.indices=a}_updatePositions(e,{vertexStart:t,geometrySize:i}){const{attributes:{positions:n},positionSize:r}=this;if(!n||!e)return;const o=getPositions(e);for(let e=t,s=0;s<i;e++,s++){const t=o[s*r+1],i=r>2?o[s*r+2]:0;n[3*e]=o[s*r],n[3*e+1]=t,n[3*e+2]=i}}_updateVertexValid(e,{vertexStart:t,geometrySize:i}){const{positionSize:n}=this,r=this.attributes.vertexValid,o=e&&getHoleIndices(e);if(e&&e.edgeTypes?r.set(e.edgeTypes,t):r.fill(1,t,t+i),o)for(let e=0;e<o.length;e++)r[t+o[e]/n-1]=0;r[t+i-1]=0}}function isCut(e){return Array.isArray(e)&&e.length>0&&!Number.isFinite(e[0])}var main="\nattribute vec2 vertexPositions;\nattribute float vertexValid;\n\nuniform bool extruded;\nuniform bool isWireframe;\nuniform float elevationScale;\nuniform float opacity;\n\nvarying vec4 vColor;\n\nstruct PolygonProps {\n  vec4 fillColors;\n  vec4 lineColors;\n  vec3 positions;\n  vec3 nextPositions;\n  vec3 pickingColors;\n  vec3 positions64Low;\n  vec3 nextPositions64Low;\n  float elevations;\n};\n\nvec3 project_offset_normal(vec3 vector) {\n  if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\n    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {\n    return normalize(vector * project_uCommonUnitsPerWorldUnit);\n  }\n  return project_normal(vector);\n}\n\nvoid calculatePosition(PolygonProps props) {\n#ifdef IS_SIDE_VERTEX\n  if(vertexValid < 0.5){\n    gl_Position = vec4(0.);\n    return;\n  }\n#endif\n\n  vec3 pos;\n  vec3 pos64Low;\n  vec3 normal;\n  vec4 colors = isWireframe ? props.lineColors : props.fillColors;\n\n  geometry.worldPosition = props.positions;\n  geometry.worldPositionAlt = props.nextPositions;\n  geometry.pickingColor = props.pickingColors;\n\n#ifdef IS_SIDE_VERTEX\n  pos = mix(props.positions, props.nextPositions, vertexPositions.x);\n  pos64Low = mix(props.positions64Low, props.nextPositions64Low, vertexPositions.x);\n#else\n  pos = props.positions;\n  pos64Low = props.positions64Low;\n#endif\n\n  if (extruded) {\n    pos.z += props.elevations * vertexPositions.y * elevationScale;\n  }\n  gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);\n\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  if (extruded) {\n  #ifdef IS_SIDE_VERTEX\n    normal = vec3(\n      props.positions.y - props.nextPositions.y + (props.positions64Low.y - props.nextPositions64Low.y),\n      props.nextPositions.x - props.positions.x + (props.nextPositions64Low.x - props.positions64Low.x),\n      0.0);\n    normal = project_offset_normal(normal);\n  #else\n    normal = project_normal(vec3(0.0, 0.0, 1.0));\n  #endif\n    geometry.normal = normal;\n    vec3 lightColor = lighting_getLightColor(colors.rgb, project_uCameraPosition, geometry.position.xyz, normal);\n    vColor = vec4(lightColor, colors.a * opacity);\n  } else {\n    vColor = vec4(colors.rgb, colors.a * opacity);\n  }\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",vsTop="#define SHADER_NAME solid-polygon-layer-vertex-shader\n\nattribute vec3 positions;\nattribute vec3 positions64Low;\nattribute float elevations;\nattribute vec4 fillColors;\nattribute vec4 lineColors;\nattribute vec3 pickingColors;\n\n".concat(main,"\n\nvoid main(void) {\n  PolygonProps props;\n\n  props.positions = positions;\n  props.positions64Low = positions64Low;\n  props.elevations = elevations;\n  props.fillColors = fillColors;\n  props.lineColors = lineColors;\n  props.pickingColors = pickingColors;\n\n  calculatePosition(props);\n}\n"),vsSide="#define SHADER_NAME solid-polygon-layer-vertex-shader-side\n#define IS_SIDE_VERTEX\n\n\nattribute vec3 instancePositions;\nattribute vec3 nextPositions;\nattribute vec3 instancePositions64Low;\nattribute vec3 nextPositions64Low;\nattribute float instanceElevations;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\n".concat(main,"\n\nvoid main(void) {\n  PolygonProps props;\n\n  #if RING_WINDING_ORDER_CW == 1\n    props.positions = instancePositions;\n    props.positions64Low = instancePositions64Low;\n    props.nextPositions = nextPositions;\n    props.nextPositions64Low = nextPositions64Low;\n  #else\n    props.positions = nextPositions;\n    props.positions64Low = nextPositions64Low;\n    props.nextPositions = instancePositions;\n    props.nextPositions64Low = instancePositions64Low;\n  #endif\n  props.elevations = instanceElevations;\n  props.fillColors = instanceFillColors;\n  props.lineColors = instanceLineColors;\n  props.pickingColors = instancePickingColors;\n\n  calculatePosition(props);\n}\n"),fs$6="#define SHADER_NAME solid-polygon-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\n\nvoid main(void) {\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n";const DEFAULT_COLOR$3=[0,0,0,255],defaultProps$8={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:e=>e.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:DEFAULT_COLOR$3},getLineColor:{type:"accessor",value:DEFAULT_COLOR$3},material:!0},ATTRIBUTE_TRANSITION={enter:(e,t)=>t.length?t.subarray(t.length-e.length):e};class SolidPolygonLayer extends Layer{constructor(...e){super(...e),_defineProperty(this,"state",void 0)}getShaders(e){return super.getShaders({vs:"top"===e?vsTop:vsSide,fs:fs$6,defines:{RING_WINDING_ORDER_CW:this.props._normalize||"CCW"!==this.props._windingOrder?1:0},modules:[project32,gouraudLighting,picking]})}get wrapLongitude(){return!1}initializeState(){const{gl:e,viewport:t}=this.context;let{coordinateSystem:i}=this.props;const{_full3d:n}=this.props;let r;t.isGeospatial&&i===COORDINATE_SYSTEM.DEFAULT&&(i=COORDINATE_SYSTEM.LNGLAT),i===COORDINATE_SYSTEM.LNGLAT&&(r=n?t.projectPosition.bind(t):t.projectFlat.bind(t)),this.setState({numInstances:0,polygonTesselator:new PolygonTesselator({preproject:r,fp64:this.use64bitPositions(),IndexType:!e||hasFeatures$1(e,FEATURES$1.ELEMENT_INDEX_UINT32)?Uint32Array:Uint16Array})});const o=this.getAttributeManager(),s=!0;o.remove(["instancePickingColors"]),o.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:s},positions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:ATTRIBUTE_TRANSITION,accessor:"getPolygon",update:this.calculatePositions,noAlloc:s,shaderAttributes:{positions:{vertexOffset:0,divisor:0},instancePositions:{vertexOffset:0,divisor:1},nextPositions:{vertexOffset:1,divisor:1}}},vertexValid:{size:1,divisor:1,type:5121,update:this.calculateVertexValid,noAlloc:s},elevations:{size:1,transition:ATTRIBUTE_TRANSITION,accessor:"getElevation",shaderAttributes:{elevations:{divisor:0},instanceElevations:{divisor:1}}},fillColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:ATTRIBUTE_TRANSITION,accessor:"getFillColor",defaultValue:DEFAULT_COLOR$3,shaderAttributes:{fillColors:{divisor:0},instanceFillColors:{divisor:1}}},lineColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:ATTRIBUTE_TRANSITION,accessor:"getLineColor",defaultValue:DEFAULT_COLOR$3,shaderAttributes:{lineColors:{divisor:0},instanceLineColors:{divisor:1}}},pickingColors:{size:3,type:5121,accessor:(e,{index:t,target:i})=>this.encodePickingColor(e&&e.__source?e.__source.index:t,i),shaderAttributes:{pickingColors:{divisor:0},instancePickingColors:{divisor:1}}}})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find((e=>e.__source.index===i))),t}disablePickingIndex(e){const{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else super.disablePickingIndex(e)}draw({uniforms:e}){const{extruded:t,filled:i,wireframe:n,elevationScale:r}=this.props,{topModel:o,sideModel:s,polygonTesselator:a}=this.state,l={...e,extruded:Boolean(t),elevationScale:r};s&&(s.setInstanceCount(a.instanceCount-1),s.setUniforms(l),n&&(s.setDrawMode(3),s.setUniforms({isWireframe:!0}).draw()),i&&(s.setDrawMode(6),s.setUniforms({isWireframe:!1}).draw())),o&&(o.setVertexCount(a.vertexCount),o.setUniforms(l).draw())}updateState(e){super.updateState(e),this.updateGeometry(e);const{props:t,oldProps:i,changeFlags:n}=e,r=this.getAttributeManager();var o;(n.extensionsChanged||t.filled!==i.filled||t.extruded!==i.extruded)&&(null===(o=this.state.models)||void 0===o||o.forEach((e=>e.delete())),this.setState(this._getModels(this.context.gl)),r.invalidateAll())}updateGeometry({props:e,changeFlags:t}){if(t.dataChanged||t.updateTriggersChanged&&(t.updateTriggersChanged.all||t.updateTriggersChanged.getPolygon)){const{polygonTesselator:i}=this.state,n=e.data.attributes||{};i.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:n.getPolygon,buffers:n,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:t.dataChanged,full3d:e._full3d}),this.setState({numInstances:i.instanceCount,startIndices:i.vertexStarts}),t.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(e){const{id:t,filled:i,extruded:n}=this.props;let r,o;if(i){const i=this.getShaders("top");i.defines.NON_INSTANCED_MODEL=1,r=new Model(e,{...i,id:"".concat(t,"-top"),drawMode:4,attributes:{vertexPositions:new Float32Array([0,1])},uniforms:{isWireframe:!1,isSideVertex:!1},vertexCount:0,isIndexed:!0})}return n&&(o=new Model(e,{...this.getShaders("side"),id:"".concat(t,"-side"),geometry:new Geometry({drawMode:1,vertexCount:4,attributes:{vertexPositions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),instanceCount:0,isInstanced:1}),o.userData.excludeAttributes={indices:!0}),{models:[o,r].filter(Boolean),topModel:r,sideModel:o}}calculateIndices(e){const{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){const{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}}function replaceInRange({data:e,getIndex:t,dataRange:i,replace:n}){const{startRow:r=0,endRow:o=1/0}=i,s=e.length;let a=s,l=s;for(let i=0;i<s;i++){const n=t(e[i]);if(a>i&&n>=r&&(a=i),n>=o){l=i;break}}let c=a;const u=l-a!==n.length?e.slice(l):void 0;for(let t=0;t<n.length;t++)e[c++]=n[t];if(u){for(let t=0;t<u.length;t++)e[c++]=u[t];e.length=c}return{startRow:a,endRow:a+n.length}}function binaryToFeatureForAccesor(e,t){if(!e)return null;const i="startIndices"in e?e.startIndices[t]:t;return-1!==i?getPropertiesForIndex(e,e.featureIds.value[i],i):null}function getPropertiesForIndex(e,t,i){const n={properties:{...e.properties[t]}};for(const t in e.numericProps)n.properties[t]=e.numericProps[t].value[i];return n}function calculatePickingColors(e,t){const i={points:null,lines:null,polygons:null};for(const n in i){const r=e[n].globalFeatureIds.value;i[n]=new Uint8ClampedArray(3*r.length);const o=[];for(let e=0;e<r.length;e++)t(r[e],o),i[n][3*e+0]=o[0],i[n][3*e+1]=o[1],i[n][3*e+2]=o[2]}return i}_defineProperty(SolidPolygonLayer,"defaultProps",defaultProps$8),_defineProperty(SolidPolygonLayer,"layerName","SolidPolygonLayer");var fs$5="#define SHADER_NAME multi-icon-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D iconsTexture;\nuniform float gamma;\nuniform bool sdf;\nuniform float alphaCutoff;\nuniform float sdfBuffer;\nuniform float outlineBuffer;\nuniform vec4 outlineColor;\n\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  if (!picking_uActive) {\n    float alpha = texture2D(iconsTexture, vTextureCoords).a;\n    vec4 color = vColor;\n    if (sdf) {\n      float distance = alpha;\n      alpha = smoothstep(sdfBuffer - gamma, sdfBuffer + gamma, distance);\n\n      if (outlineBuffer > 0.0) {\n        float inFill = alpha;\n        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);\n        color = mix(outlineColor, vColor, inFill);\n        alpha = inBorder;\n      }\n    }\n    float a = alpha * color.a;\n    \n    if (a < alphaCutoff) {\n      discard;\n    }\n\n    gl_FragColor = vec4(color.rgb, a * opacity);\n  }\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n";const DEFAULT_BUFFER=.75,EMPTY_ARRAY=[],defaultProps$7={getIconOffsets:{type:"accessor",value:e=>e.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}};class MultiIconLayer extends IconLayer{constructor(...e){super(...e),_defineProperty(this,"state",void 0)}getShaders(){return{...super.getShaders(),fs:fs$5}}initializeState(){super.initializeState();this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(e,{index:t,target:i})=>this.encodePickingColor(t,i)}})}updateState(e){super.updateState(e);const{props:t,oldProps:i}=e;let{outlineColor:n}=t;n!==i.outlineColor&&(n=n.map((e=>e/255)),n[3]=Number.isFinite(n[3])?n[3]:1,this.setState({outlineColor:n})),!t.sdf&&t.outlineWidth&&log$3.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(e){const{sdf:t,smoothing:i,outlineWidth:n}=this.props,{outlineColor:r}=this.state,o=n?Math.max(i,DEFAULT_BUFFER*(1-n)):-1;if(e.uniforms={...e.uniforms,sdfBuffer:DEFAULT_BUFFER,outlineBuffer:o,gamma:i,sdf:Boolean(t),outlineColor:r},super.draw(e),t&&n){const{iconManager:e}=this.state;e.getTexture()&&this.state.model.draw({uniforms:{outlineBuffer:DEFAULT_BUFFER}})}}getInstanceOffset(e){return e?Array.from(e).flatMap((e=>super.getInstanceOffset(e))):EMPTY_ARRAY}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap((e=>super.getInstanceIconFrame(e))):EMPTY_ARRAY}}_defineProperty(MultiIconLayer,"defaultProps",defaultProps$7),_defineProperty(MultiIconLayer,"layerName","MultiIconLayer");const INF=1e20;class TinySDF{constructor({fontSize:e=24,buffer:t=3,radius:i=8,cutoff:n=.25,fontFamily:r="sans-serif",fontWeight:o="normal",fontStyle:s="normal"}={}){this.buffer=t,this.cutoff=n,this.radius=i;const a=this.size=e+4*t,l=this._createCanvas(a),c=this.ctx=l.getContext("2d",{willReadFrequently:!0});c.font=`${s} ${o} ${e}px ${r}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:n,actualBoundingBoxLeft:r,actualBoundingBoxRight:o}=this.ctx.measureText(e),s=Math.ceil(i),a=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(o-r))),l=Math.min(this.size-this.buffer,s+Math.ceil(n)),c=a+2*this.buffer,u=l+2*this.buffer,h=Math.max(c*u,0),d=new Uint8ClampedArray(h),p={data:d,width:c,height:u,glyphWidth:a,glyphHeight:l,glyphTop:s,glyphLeft:0,glyphAdvance:t};if(0===a||0===l)return p;const{ctx:f,buffer:m,gridInner:g,gridOuter:_}=this;f.clearRect(m,m,a,l),f.fillText(e,m,m+s);const y=f.getImageData(m,m,a,l);_.fill(INF,0,h),g.fill(0,0,h);for(let e=0;e<l;e++)for(let t=0;t<a;t++){const i=y.data[4*(e*a+t)+3]/255;if(0===i)continue;const n=(e+m)*c+t+m;if(1===i)_[n]=0,g[n]=INF;else{const e=.5-i;_[n]=e>0?e*e:0,g[n]=e<0?e*e:0}}edt(_,0,0,c,u,c,this.f,this.v,this.z),edt(g,m,m,a,l,c,this.f,this.v,this.z);for(let e=0;e<h;e++){const t=Math.sqrt(_[e])-Math.sqrt(g[e]);d[e]=Math.round(255-255*(t/this.radius+this.cutoff))}return p}}function edt(e,t,i,n,r,o,s,a,l){for(let c=t;c<t+n;c++)edt1d(e,i*o+c,o,r,s,a,l);for(let c=i;c<i+r;c++)edt1d(e,c*o+t,1,n,s,a,l)}function edt1d(e,t,i,n,r,o,s){o[0]=0,s[0]=-INF,s[1]=INF,r[0]=e[t];for(let a=1,l=0,c=0;a<n;a++){r[a]=e[t+a*i];const n=a*a;do{const e=o[l];c=(r[a]-r[e]+n-e*e)/(a-e)/2}while(c<=s[l]&&--l>-1);l++,o[l]=a,s[l]=c,s[l+1]=INF}for(let a=0,l=0;a<n;a++){for(;s[l+1]<a;)l++;const n=o[l],c=a-n;e[t+a*i]=r[n]+c*c}}const MISSING_CHAR_WIDTH=32,SINGLE_LINE=[];function nextPowOfTwo(e){return Math.pow(2,Math.ceil(Math.log2(e)))}function buildMapping({characterSet:e,getFontWidth:t,fontHeight:i,buffer:n,maxCanvasWidth:r,mapping:o={},xOffset:s=0,yOffset:a=0}){let l=0,c=s;const u=i+2*n;for(const s of e)if(!o[s]){const e=t(s);c+e+2*n>r&&(c=0,l++),o[s]={x:c+n,y:a+l*u+n,width:e,height:u,layoutWidth:e,layoutHeight:i},c+=e+2*n}return{mapping:o,xOffset:c,yOffset:a+l*u,canvasHeight:nextPowOfTwo(a+(l+1)*u)}}function getTextWidth(e,t,i,n){let r=0;for(let s=t;s<i;s++){var o;r+=(null===(o=n[e[s]])||void 0===o?void 0:o.layoutWidth)||0}return r}function breakAll(e,t,i,n,r,o){let s=t,a=0;for(let l=t;l<i;l++){const t=getTextWidth(e,l,l+1,r);a+t>n&&(s<l&&o.push(l),s=l,a=0),a+=t}return a}function breakWord(e,t,i,n,r,o){let s=t,a=t,l=t,c=0;for(let u=t;u<i;u++)if(" "===e[u]?l=u+1:" "!==e[u+1]&&u+1!==i||(l=u+1),l>a){let t=getTextWidth(e,a,l,r);c+t>n&&(s<a&&(o.push(a),s=a,c=0),t>n&&(t=breakAll(e,a,l,n,r,o),s=o[o.length-1])),a=l,c+=t}return c}function autoWrapping(e,t,i,n,r=0,o){void 0===o&&(o=e.length);const s=[];return"break-all"===t?breakAll(e,r,o,i,n,s):breakWord(e,r,o,i,n,s),s}function transformRow(e,t,i,n,r,o){let s=0,a=0;for(let o=t;o<i;o++){const t=e[o],i=n[t];i?(a||(a=i.layoutHeight),r[o]=s+i.layoutWidth/2,s+=i.layoutWidth):(log$3.warn("Missing character: ".concat(t," (").concat(t.codePointAt(0),")"))(),r[o]=s,s+=MISSING_CHAR_WIDTH)}o[0]=s,o[1]=a}function transformParagraph(e,t,i,n,r){const o=Array.from(e),s=o.length,a=new Array(s),l=new Array(s),c=new Array(s),u=("break-word"===i||"break-all"===i)&&isFinite(n)&&n>0,h=[0,0],d=[0,0];let p=0,f=0,m=0;for(let e=0;e<=s;e++){const _=o[e];if("\n"!==_&&e!==s||(m=e),m>f){const e=u?autoWrapping(o,i,n,r,f,m):SINGLE_LINE;for(let i=0;i<=e.length;i++){const n=0===i?f:e[i-1],s=i<e.length?e[i]:m;transformRow(o,n,s,r,a,d);for(let e=n;e<s;e++){var g;const t=(null===(g=r[o[e]])||void 0===g?void 0:g.layoutOffsetY)||0;l[e]=p+d[1]/2+t,c[e]=d[0]}p+=d[1]*t,h[0]=Math.max(h[0],d[0])}f=m}"\n"===_&&(a[f]=0,l[f]=0,c[f]=0,f++)}return h[1]=p,{x:a,y:l,rowWidth:c,size:h}}function getTextFromBuffer({value:e,length:t,stride:i,offset:n,startIndices:r,characterSet:o}){const s=e.BYTES_PER_ELEMENT,a=i?i/s:1,l=n?n/s:0,c=r[t]||Math.ceil((e.length-l)/a),u=o&&new Set,h=new Array(t);let d=e;if(a>1||l>0){d=new(0,e.constructor)(c);for(let t=0;t<c;t++)d[t]=e[t*a+l]}for(let e=0;e<t;e++){const t=d.subarray(r[e],r[e+1]||c);h[e]=String.fromCodePoint.apply(null,t),u&&t.forEach(u.add,u)}if(u)for(const e of u)o.add(String.fromCodePoint(e));return{texts:h,characterCount:c}}class LRUCache{constructor(e=5){_defineProperty(this,"limit",void 0),_defineProperty(this,"_cache",{}),_defineProperty(this,"_order",[]),this.limit=e}get(e){const t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){const t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}}function getDefaultCharacterSet(){const e=[];for(let t=32;t<128;t++)e.push(String.fromCharCode(t));return e}const DEFAULT_FONT_SETTINGS={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:getDefaultCharacterSet(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},MAX_CANVAS_WIDTH=1024,BASELINE_SCALE=.9,HEIGHT_SCALE=1.2,CACHE_LIMIT=3;let cache=new LRUCache(CACHE_LIMIT);function getNewChars(e,t){let i;i="string"==typeof t?new Set(Array.from(t)):new Set(t);const n=cache.get(e);if(!n)return i;for(const e in n.mapping)i.has(e)&&i.delete(e);return i}function populateAlphaChannel(e,t){for(let i=0;i<e.length;i++)t.data[4*i+3]=e[i]}function setTextStyle(e,t,i,n){e.font="".concat(n," ").concat(i,"px ").concat(t),e.fillStyle="#000",e.textBaseline="alphabetic",e.textAlign="left"}function setFontAtlasCacheLimit(e){log$3.assert(Number.isFinite(e)&&e>=CACHE_LIMIT,"Invalid cache limit"),cache=new LRUCache(e)}class FontAtlasManager{constructor(){_defineProperty(this,"props",{...DEFAULT_FONT_SETTINGS}),_defineProperty(this,"_key",void 0),_defineProperty(this,"_atlas",void 0)}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:e,buffer:t}=this.props;return(e*HEIGHT_SCALE+2*t)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();const t=getNewChars(this._key,this.props.characterSet),i=cache.get(this._key);if(i&&0===t.size)return void(this._atlas!==i&&(this._atlas=i));const n=this._generateFontAtlas(t,i);this._atlas=n,cache.set(this._key,n)}_generateFontAtlas(e,t){const{fontFamily:i,fontWeight:n,fontSize:r,buffer:o,sdf:s,radius:a,cutoff:l}=this.props;let c=t&&t.data;c||(c=document.createElement("canvas"),c.width=MAX_CANVAS_WIDTH);const u=c.getContext("2d",{willReadFrequently:!0});setTextStyle(u,i,r,n);const{mapping:h,canvasHeight:d,xOffset:p,yOffset:f}=buildMapping({getFontWidth:e=>u.measureText(e).width,fontHeight:r*HEIGHT_SCALE,buffer:o,characterSet:e,maxCanvasWidth:MAX_CANVAS_WIDTH,...t&&{mapping:t.mapping,xOffset:t.xOffset,yOffset:t.yOffset}});if(c.height!==d){const e=u.getImageData(0,0,c.width,c.height);c.height=d,u.putImageData(e,0,0)}if(setTextStyle(u,i,r,n),s){const t=new TinySDF({fontSize:r,buffer:o,radius:a,cutoff:l,fontFamily:i,fontWeight:"".concat(n)});for(const i of e){const{data:e,width:n,height:o,glyphTop:s}=t.draw(i);h[i].width=n,h[i].layoutOffsetY=r*BASELINE_SCALE-s;const a=u.createImageData(n,o);populateAlphaChannel(e,a),u.putImageData(a,h[i].x,h[i].y)}}else for(const t of e)u.fillText(t,h[t].x,h[t].y+o+r*BASELINE_SCALE);return{xOffset:p,yOffset:f,mapping:h,data:c,width:c.width,height:c.height}}_getKey(){const{fontFamily:e,fontWeight:t,fontSize:i,buffer:n,sdf:r,radius:o,cutoff:s}=this.props;return r?"".concat(e," ").concat(t," ").concat(i," ").concat(n," ").concat(o," ").concat(s):"".concat(e," ").concat(t," ").concat(i," ").concat(n)}}var vs$4="#define SHADER_NAME text-background-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute vec4 instanceRects;\nattribute float instanceSizes;\nattribute float instanceAngles;\nattribute vec2 instancePixelOffsets;\nattribute float instanceLineWidths;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\nuniform bool billboard;\nuniform float opacity;\nuniform float sizeScale;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform vec4 padding;\nuniform int sizeUnits;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying float vLineWidth;\nvarying vec2 uv;\nvarying vec2 dimensions;\n\nvec2 rotate_by_angle(vec2 vertex, float angle) {\n  float angle_radian = radians(angle);\n  float cos_angle = cos(angle_radian);\n  float sin_angle = sin(angle_radian);\n  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);\n  return rotationMatrix * vertex;\n}\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.uv = positions;\n  geometry.pickingColor = instancePickingColors;\n  uv = positions;\n  vLineWidth = instanceLineWidths;\n  float sizePixels = clamp(\n    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),\n    sizeMinPixels, sizeMaxPixels\n  );\n\n  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;\n\n  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);\n  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);\n  pixelOffset += instancePixelOffsets;\n  pixelOffset.y *= -1.0;\n\n  if (billboard)  {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = vec3(pixelOffset, 0.0);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  } else {\n    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);\n    DECKGL_FILTER_SIZE(offset_common, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);\n  DECKGL_FILTER_COLOR(vFillColor, geometry);\n  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);\n  DECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs$4="#define SHADER_NAME text-background-layer-fragment-shader\n\nprecision highp float;\n\nuniform bool stroked;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying float vLineWidth;\nvarying vec2 uv;\nvarying vec2 dimensions;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  vec2 pixelPosition = uv * dimensions;\n  if (stroked) {\n    float distToEdge = min(\n      min(pixelPosition.x, dimensions.x - pixelPosition.x),\n      min(pixelPosition.y, dimensions.y - pixelPosition.y)\n    );\n    float isBorder = smoothedge(distToEdge, vLineWidth);\n    gl_FragColor = mix(vFillColor, vLineColor, isBorder);\n  } else {\n    gl_FragColor = vFillColor;\n  }\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n";const defaultProps$6={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:e=>e.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class TextBackgroundLayer extends Layer{constructor(...e){super(...e),_defineProperty(this,"state",void 0)}getShaders(){return super.getShaders({vs:vs$4,fs:fs$4,modules:[project32,picking]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);const{changeFlags:t}=e;if(t.extensionsChanged){var i;const{gl:e}=this.context;null===(i=this.state.model)||void 0===i||i.delete(),this.state.model=this._getModel(e),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{billboard:t,sizeScale:i,sizeUnits:n,sizeMinPixels:r,sizeMaxPixels:o,getLineWidth:s}=this.props;let{padding:a}=this.props;a.length<4&&(a=[a[0],a[1],a[0],a[1]]),this.state.model.setUniforms(e).setUniforms({billboard:t,stroked:Boolean(s),padding:a,sizeUnits:UNIT[n],sizeScale:i,sizeMinPixels:r,sizeMaxPixels:o}).draw()}_getModel(e){return new Model(e,{...this.getShaders(),id:this.props.id,geometry:new Geometry({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array([0,0,1,0,1,1,0,1])}}}),isInstanced:!0})}}_defineProperty(TextBackgroundLayer,"defaultProps",defaultProps$6),_defineProperty(TextBackgroundLayer,"layerName","TextBackgroundLayer");const TEXT_ANCHOR={start:1,middle:0,end:-1},ALIGNMENT_BASELINE={top:1,center:0,bottom:-1},DEFAULT_COLOR$2=[0,0,0,255],DEFAULT_LINE_HEIGHT=1,defaultProps$5={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:DEFAULT_COLOR$2},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:DEFAULT_FONT_SETTINGS.characterSet},fontFamily:DEFAULT_FONT_SETTINGS.fontFamily,fontWeight:DEFAULT_FONT_SETTINGS.fontWeight,lineHeight:DEFAULT_LINE_HEIGHT,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:DEFAULT_COLOR$2},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:e=>e.text},getPosition:{type:"accessor",value:e=>e.position},getColor:{type:"accessor",value:DEFAULT_COLOR$2},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class TextLayer extends CompositeLayer{constructor(...e){super(...e),_defineProperty(this,"state",void 0),_defineProperty(this,"getBoundingRect",((e,t)=>{let{size:[i,n]}=this.transformParagraph(e,t);const{fontSize:r}=this.state.fontAtlasManager.props;i/=r,n/=r;const{getTextAnchor:o,getAlignmentBaseline:s}=this.props;return[(TEXT_ANCHOR["function"==typeof o?o(e,t):o]-1)*i/2,(ALIGNMENT_BASELINE["function"==typeof s?s(e,t):s]-1)*n/2,i,n]})),_defineProperty(this,"getIconOffsets",((e,t)=>{const{getTextAnchor:i,getAlignmentBaseline:n}=this.props,{x:r,y:o,rowWidth:s,size:[a,l]}=this.transformParagraph(e,t),c=TEXT_ANCHOR["function"==typeof i?i(e,t):i],u=ALIGNMENT_BASELINE["function"==typeof n?n(e,t):n],h=r.length,d=new Array(2*h);let p=0;for(let e=0;e<h;e++){d[p++]=(c-1)*a/2+(1-c)*(a-s[e])/2+r[e],d[p++]=(u-1)*l/2+o[e]}return d}))}initializeState(){this.state={styleVersion:0,fontAtlasManager:new FontAtlasManager},this.props.maxWidth>0&&log$3.warn("v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){const{props:t,oldProps:i,changeFlags:n}=e;(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getText))&&this._updateText();(this._updateFontAtlas()||t.lineHeight!==i.lineHeight||t.wordBreak!==i.wordBreak||t.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){const{fontSettings:e,fontFamily:t,fontWeight:i}=this.props,{fontAtlasManager:n,characterSet:r}=this.state,o={...e,characterSet:r,fontFamily:t,fontWeight:i};if(!n.mapping)return n.setProps(o),!0;for(const e in o)if(o[e]!==n.props[e])return n.setProps(o),!0;return!1}_updateText(){var e;const{data:t,characterSet:i}=this.props,n=null===(e=t.attributes)||void 0===e?void 0:e.getText;let r,{getText:o}=this.props,s=t.startIndices;const a="auto"===i&&new Set;if(n&&s){const{texts:e,characterCount:i}=getTextFromBuffer({...ArrayBuffer.isView(n)?{value:n}:n,length:t.length,startIndices:s,characterSet:a});r=i,o=(t,{index:i})=>e[i]}else{const{iterable:e,objectInfo:i}=createIterable(t);s=[0],r=0;for(const t of e){i.index++;const e=Array.from(o(t,i)||"");a&&e.forEach(a.add,a),r+=e.length,s.push(r)}}this.setState({getText:o,startIndices:s,numInstances:r,characterSet:a||i})}transformParagraph(e,t){const{fontAtlasManager:i}=this.state,n=i.mapping,r=this.state.getText,{wordBreak:o,lineHeight:s,maxWidth:a}=this.props;return transformParagraph(r(e,t)||"",s,o,a*i.props.fontSize,n)}renderLayers(){const{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:n,texture:r,mapping:o},styleVersion:s}=this.state,{data:a,_dataDiff:l,getPosition:c,getColor:u,getSize:h,getAngle:d,getPixelOffset:p,getBackgroundColor:f,getBorderColor:m,getBorderWidth:g,backgroundPadding:_,background:y,billboard:v,fontSettings:x,outlineWidth:b,outlineColor:T,sizeScale:w,sizeUnits:E,sizeMinPixels:S,sizeMaxPixels:A,transitions:M,updateTriggers:I}=this.props,C=this.getSubLayerClass("characters",MultiIconLayer),P=this.getSubLayerClass("background",TextBackgroundLayer);return[y&&new P({getFillColor:f,getLineColor:m,getLineWidth:g,padding:_,getPosition:c,getSize:h,getAngle:d,getPixelOffset:p,billboard:v,sizeScale:w,sizeUnits:E,sizeMinPixels:S,sizeMaxPixels:A,transitions:M&&{getPosition:M.getPosition,getAngle:M.getAngle,getSize:M.getSize,getFillColor:M.getBackgroundColor,getLineColor:M.getBorderColor,getLineWidth:M.getBorderWidth,getPixelOffset:M.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:I.getPosition,getAngle:I.getAngle,getSize:I.getSize,getFillColor:I.getBackgroundColor,getLineColor:I.getBorderColor,getLineWidth:I.getBorderWidth,getPixelOffset:I.getPixelOffset,getBoundingRect:{getText:I.getText,getTextAnchor:I.getTextAnchor,getAlignmentBaseline:I.getAlignmentBaseline,styleVersion:s}}}),{data:a.attributes&&a.attributes.background?{length:a.length,attributes:a.attributes.background}:a,_dataDiff:l,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new C({sdf:x.sdf,smoothing:Number.isFinite(x.smoothing)?x.smoothing:DEFAULT_FONT_SETTINGS.smoothing,outlineWidth:b/(x.radius||DEFAULT_FONT_SETTINGS.radius),outlineColor:T,iconAtlas:r,iconMapping:o,getPosition:c,getColor:u,getSize:h,getAngle:d,getPixelOffset:p,billboard:v,sizeScale:w*n,sizeUnits:E,sizeMinPixels:S*n,sizeMaxPixels:A*n,transitions:M&&{getPosition:M.getPosition,getAngle:M.getAngle,getColor:M.getColor,getSize:M.getSize,getPixelOffset:M.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:I.getText,getPosition:I.getPosition,getAngle:I.getAngle,getColor:I.getColor,getSize:I.getSize,getPixelOffset:I.getPixelOffset,getIconOffsets:{getTextAnchor:I.getTextAnchor,getAlignmentBaseline:I.getAlignmentBaseline,styleVersion:s}}}),{data:a,_dataDiff:l,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){setFontAtlasCacheLimit(e)}}_defineProperty(TextLayer,"defaultProps",defaultProps$5),_defineProperty(TextLayer,"layerName","TextLayer");const POINT_LAYER={circle:{type:ScatterplotLayer,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:IconLayer,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:TextLayer,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},LINE_LAYER={type:PathLayer,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},POLYGON_LAYER={type:SolidPolygonLayer,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function getDefaultProps({type:e,props:t}){const i={};for(const n in t)i[n]=e.defaultProps[t[n]];return i}function forwardProps(e,t){const{transitions:i,updateTriggers:n}=e.props,r={updateTriggers:{},transitions:i&&{getPosition:i.geometry}};for(const o in t){const s=t[o];let a=e.props[o];o.startsWith("get")&&(a=e.getSubLayerAccessor(a),r.updateTriggers[s]=n[o],i&&(r.transitions[s]=i[o])),r[s]=a}return r}function getGeojsonFeatures(e){if(Array.isArray(e))return e;switch(log$3.assert(e.type,"GeoJSON does not have type"),e.type){case"Feature":return[e];case"FeatureCollection":return log$3.assert(Array.isArray(e.features),"GeoJSON does not have features array"),e.features;default:return[{geometry:e}]}}function separateGeojsonFeatures(e,t,i={}){const n={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:r=0,endRow:o=e.length}=i;for(let i=r;i<o;i++){const r=e[i],{geometry:o}=r;if(o)if("GeometryCollection"===o.type){log$3.assert(Array.isArray(o.geometries),"GeoJSON does not have geometries array");const{geometries:e}=o;for(let o=0;o<e.length;o++){separateGeometry(e[o],n,t,r,i)}}else separateGeometry(o,n,t,r,i)}return n}function separateGeometry(e,t,i,n,r){const{type:o,coordinates:s}=e,{pointFeatures:a,lineFeatures:l,polygonFeatures:c,polygonOutlineFeatures:u}=t;if(validateGeometry(o,s))switch(o){case"Point":a.push(i({geometry:e},n,r));break;case"MultiPoint":s.forEach((e=>{a.push(i({geometry:{type:"Point",coordinates:e}},n,r))}));break;case"LineString":l.push(i({geometry:e},n,r));break;case"MultiLineString":s.forEach((e=>{l.push(i({geometry:{type:"LineString",coordinates:e}},n,r))}));break;case"Polygon":c.push(i({geometry:e},n,r)),s.forEach((e=>{u.push(i({geometry:{type:"LineString",coordinates:e}},n,r))}));break;case"MultiPolygon":s.forEach((e=>{c.push(i({geometry:{type:"Polygon",coordinates:e}},n,r)),e.forEach((e=>{u.push(i({geometry:{type:"LineString",coordinates:e}},n,r))}))}))}else log$3.warn("".concat(o," coordinates are malformed"))()}const COORDINATE_NEST_LEVEL={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function validateGeometry(e,t){let i=COORDINATE_NEST_LEVEL[e];for(log$3.assert(i,"Unknown GeoJSON type ".concat(e));t&&--i>0;)t=t[0];return t&&Number.isFinite(t[0])}function createEmptyLayerProps(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function getCoordinates(e){return e.geometry.coordinates}function createLayerPropsFromFeatures(e,t){const i=createEmptyLayerProps(),{pointFeatures:n,lineFeatures:r,polygonFeatures:o,polygonOutlineFeatures:s}=e;return i.points.data=n,i.points._dataDiff=t.pointFeatures&&(()=>t.pointFeatures),i.points.getPosition=getCoordinates,i.lines.data=r,i.lines._dataDiff=t.lineFeatures&&(()=>t.lineFeatures),i.lines.getPath=getCoordinates,i.polygons.data=o,i.polygons._dataDiff=t.polygonFeatures&&(()=>t.polygonFeatures),i.polygons.getPolygon=getCoordinates,i.polygonsOutline.data=s,i.polygonsOutline._dataDiff=t.polygonOutlineFeatures&&(()=>t.polygonOutlineFeatures),i.polygonsOutline.getPath=getCoordinates,i}function createLayerPropsFromBinary(e,t){const i=createEmptyLayerProps(),{points:n,lines:r,polygons:o}=e,s=calculatePickingColors(e,t);return i.points.data={length:n.positions.value.length/n.positions.size,attributes:{...n.attributes,getPosition:n.positions,instancePickingColors:{size:3,value:s.points}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},i.lines.data={length:r.pathIndices.value.length-1,startIndices:r.pathIndices.value,attributes:{...r.attributes,getPath:r.positions,instancePickingColors:{size:3,value:s.lines}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},i.lines._pathType="open",i.polygons.data={length:o.polygonIndices.value.length-1,startIndices:o.polygonIndices.value,attributes:{...o.attributes,getPolygon:o.positions,pickingColors:{size:3,value:s.polygons}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},i.polygons._normalize=!1,o.triangles&&(i.polygons.data.attributes.indices=o.triangles.value),i.polygonsOutline.data={length:o.primitivePolygonIndices.value.length-1,startIndices:o.primitivePolygonIndices.value,attributes:{...o.attributes,getPath:o.positions,instancePickingColors:{size:3,value:s.polygons}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},i.polygonsOutline._pathType="open",i}const FEATURE_TYPES=["points","linestrings","polygons"],defaultProps$4={...getDefaultProps(POINT_LAYER.circle),...getDefaultProps(POINT_LAYER.icon),...getDefaultProps(POINT_LAYER.text),...getDefaultProps(LINE_LAYER),...getDefaultProps(POLYGON_LAYER),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:e=>e.properties.icon},getText:{type:"accessor",value:e=>e.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};let GeoJsonLayer$1=class extends CompositeLayer{initializeState(){this.state={layerProps:{},features:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;const{data:i}=this.props,n=i&&"points"in i&&"polygons"in i&&"lines"in i;this.setState({binary:n}),n?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e}){const t=createLayerPropsFromBinary(e.data,this.encodePickingColor);this.setState({layerProps:t})}_updateStateJSON({props:e,changeFlags:t}){const i=getGeojsonFeatures(e.data),n=this.getSubLayerRow.bind(this);let r={};const o={};if(Array.isArray(t.dataChanged)){const e=this.state.features;for(const t in e)r[t]=e[t].slice(),o[t]=[];for(const s of t.dataChanged){const t=separateGeojsonFeatures(i,n,s);for(const i in e)o[i].push(replaceInRange({data:r[i],getIndex:e=>e.__source.index,dataRange:s,replace:t[i]}))}}else r=separateGeojsonFeatures(i,n);const s=createLayerPropsFromFeatures(r,o);this.setState({features:r,featuresDiff:o,layerProps:s})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:i,sourceLayer:n}=t;return t.featureType=FEATURE_TYPES.find((e=>n.id.startsWith("".concat(this.id,"-").concat(e,"-")))),i>=0&&n.id.startsWith("".concat(this.id,"-points-text"))&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[i]),t}_updateAutoHighlight(e){const t="".concat(this.id,"-points-"),i="points"===e.featureType;for(const n of this.getSubLayers())n.id.startsWith(t)===i&&n.updateAutoHighlight(e)}_renderPolygonLayer(){const{extruded:e,wireframe:t}=this.props,{layerProps:i}=this.state,n="polygons-fill",r=this.shouldRenderSubLayer(n,i.polygons.data)&&this.getSubLayerClass(n,POLYGON_LAYER.type);if(r){const o=forwardProps(this,POLYGON_LAYER.props),s=e&&t;return s||delete o.getLineColor,o.updateTriggers.lineColors=s,new r(o,this.getSubLayerProps({id:n,updateTriggers:o.updateTriggers}),i.polygons)}return null}_renderLineLayers(){const{extruded:e,stroked:t}=this.props,{layerProps:i}=this.state,n="polygons-stroke",r="linestrings",o=!e&&t&&this.shouldRenderSubLayer(n,i.polygonsOutline.data)&&this.getSubLayerClass(n,LINE_LAYER.type),s=this.shouldRenderSubLayer(r,i.lines.data)&&this.getSubLayerClass(r,LINE_LAYER.type);if(o||s){const e=forwardProps(this,LINE_LAYER.props);return[o&&new o(e,this.getSubLayerProps({id:n,updateTriggers:e.updateTriggers}),i.polygonsOutline),s&&new s(e,this.getSubLayerProps({id:r,updateTriggers:e.updateTriggers}),i.lines)]}return null}_renderPointLayers(){const{pointType:e}=this.props,{layerProps:t,binary:i}=this.state;let{highlightedObjectIndex:n}=this.props;!i&&Number.isFinite(n)&&(n=t.points.data.findIndex((e=>e.__source.index===n)));const r=new Set(e.split("+")),o=[];for(const e of r){const r="points-".concat(e),s=POINT_LAYER[e],a=s&&this.shouldRenderSubLayer(r,t.points.data)&&this.getSubLayerClass(r,s.type);if(a){const l=forwardProps(this,s.props);let c=t.points;if("text"===e&&i){const{instancePickingColors:e,...t}=c.data.attributes;c={...c,data:{...c.data,attributes:t}}}o.push(new a(l,this.getSubLayerProps({id:r,updateTriggers:l.updateTriggers,highlightedObjectIndex:n}),c))}}return o}renderLayers(){const{extruded:e}=this.props,t=this._renderPolygonLayer();return[!e&&t,this._renderLineLayers(),this._renderPointLayers(),e&&t]}getSubLayerAccessor(e){const{binary:t}=this.state;return t&&"function"==typeof e?(t,i)=>{const{data:n,index:r}=i,o=binaryToFeatureForAccesor(n,r);return e(o,i)}:super.getSubLayerAccessor(e)}};_defineProperty(GeoJsonLayer$1,"layerName","GeoJsonLayer"),_defineProperty(GeoJsonLayer$1,"defaultProps",defaultProps$4);const TILE_SIZE=512,DEGREES_TO_RADIANS=Math.PI/180;function getDeckInstance({map:e,gl:t,deck:i}){if(e.__deck)return e.__deck;const n=null==i?void 0:i.props._customRender,r=null==i?void 0:i.props.onLoad,o=getInterleavedProps({...null==i?void 0:i.props,_customRender:()=>{e.triggerRepaint(),null==n||n("")}});let s;return i&&i.props.gl!==t||(Object.assign(o,{gl:t,width:null,height:null,touchAction:"unset",viewState:getViewState(e)}),null!=i&&i.isInitialized?watchMapMove(i,e):o.onLoad=()=>{null==r||r(),watchMapMove(s,e)}),i?(s=i,i.setProps(o),i.userData.isExternal=!0):(s=new Deck(o),e.on("remove",(()=>{removeDeckInstance(e)}))),s.userData.mapboxLayers=new Set,e.__deck=s,e.on("render",(()=>{s.isInitialized&&afterRender(s,e)})),s}function watchMapMove(e,t){const i=()=>{e.isInitialized?onMapMove(e,t):t.off("move",i)};t.on("move",i)}function removeDeckInstance(e){var t;null===(t=e.__deck)||void 0===t||t.finalize(),e.__deck=null}function getInterleavedProps(e){return{...e,parameters:{depthMask:!0,depthTest:!0,blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthFunc:515,blendEquation:32774,...e.parameters},views:e.views||[new MapView({id:"mapbox"})]}}function addLayer(e,t){e.userData.mapboxLayers.add(t),updateLayers(e)}function removeLayer(e,t){e.userData.mapboxLayers.delete(t),updateLayers(e)}function updateLayer(e,t){updateLayers(e)}function drawLayer(e,t,i){let{currentViewport:n}=e.userData,r=!1;n||(n=getViewport(e,t,!0),e.userData.currentViewport=n,r=!0),e.isInitialized&&e._drawLayers("mapbox-repaint",{viewports:[n],layerFilter:({layer:e})=>i.id===e.id||e.props.operation.includes("terrain"),clearStack:r,clearCanvas:!1})}function getViewState(e){var t;const{lng:i,lat:n}=e.getCenter(),r={longitude:(i+540)%360-180,latitude:n,zoom:e.getZoom(),bearing:e.getBearing(),pitch:e.getPitch(),padding:e.getPadding(),repeat:e.getRenderWorldCopies()};return null!==(t=e.getTerrain)&&void 0!==t&&t.call(e)&&centerCameraOnTerrain(e,r),r}function centerCameraOnTerrain(e,t){if(e.getFreeCameraOptions){const{position:i}=e.getFreeCameraOptions();if(!i||void 0===i.z)return;const n=e.transform.height,{longitude:r,latitude:o,pitch:s}=t,a=i.x*TILE_SIZE,l=(1-i.y)*TILE_SIZE,c=i.z*TILE_SIZE,u=lngLatToWorld([r,o]),h=a-u[0],d=l-u[1],p=Math.sqrt(h*h+d*d),f=s*DEGREES_TO_RADIANS,m=1.5*n,g=f<.001?m*Math.cos(f)/c:m*Math.sin(f)/p;t.zoom=Math.log2(g);const _=m*Math.cos(f)/g;t.position=[0,0,(c-_)/unitsPerMeter(o)]}else"number"==typeof e.transform.elevation&&(t.position=[0,0,e.transform.elevation])}function getViewport(e,t,i=!0){return new WebMercatorViewport({id:"mapbox",x:0,y:0,width:e.width,height:e.height,...getViewState(t),nearZMultiplier:i?.02:.1,nearZ:t.transform._nearZ/t.transform.height,farZ:t.transform._farZ/t.transform.height})}function afterRender(e,t){const{mapboxLayers:i,isExternal:n}=e.userData;if(n){const n=Array.from(i,(e=>e.id)),r=flatten$1(e.props.layers,Boolean).some((e=>e&&!n.includes(e.id)));let o=e.getViewports();const s=o.findIndex((e=>"mapbox"===e.id));(r||(o.length>1||s<0))&&(s>=0&&(o=o.slice(),o[s]=getViewport(e,t,!1)),e._drawLayers("mapbox-repaint",{viewports:o,layerFilter:t=>(!e.props.layerFilter||e.props.layerFilter(t))&&("mapbox"!==t.viewport.id||!n.includes(t.layer.id)),clearCanvas:!1}))}e.userData.currentViewport=null}function onMapMove(e,t){e.setProps({viewState:getViewState(t)}),e.needsRedraw({clearRedrawFlags:!0})}function updateLayers(e){if(e.userData.isExternal)return;const t=[];e.userData.mapboxLayers.forEach((e=>{const i=new(0,e.props.type)(e.props);t.push(i)})),e.setProps({layers:t})}class MapboxLayer{constructor(e){if(_defineProperty(this,"id",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"renderingMode",void 0),_defineProperty(this,"map",void 0),_defineProperty(this,"deck",void 0),_defineProperty(this,"props",void 0),!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.map=null,this.deck=null,this.props=e}onAdd(e,t){this.map=e,this.deck=getDeckInstance({map:e,gl:t,deck:this.props.deck}),addLayer(this.deck,this)}onRemove(){this.deck&&removeLayer(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&updateLayer(this.deck)}render(){drawLayer(this.deck,this.map,this)}}class GeoJsonLayer{constructor(e){this.implementation=e}onAdd(e,t){const i=this.implementation,n=i.id,r=Object.assign({},i,{type:GeoJsonLayer$1}),o=e.map;this.map=e,delete r.minzoom,delete r.maxzoom,delete r.metadata,o.addLayer(new MapboxLayer(r),t||"poi"),o.setLayerZoomRange(n,i.minzoom,i.maxzoom),o.style.getOwnLayer(n).metadata=i.metadata}}
/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const REVISION="182",MOUSE={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},TOUCH={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},CullFaceNone=0,CullFaceBack=1,CullFaceFront=2,CullFaceFrontBack=3,BasicShadowMap=0,PCFShadowMap=1,PCFSoftShadowMap=2,VSMShadowMap=3,FrontSide=0,BackSide=1,DoubleSide=2,NoBlending=0,NormalBlending=1,AdditiveBlending=2,SubtractiveBlending=3,MultiplyBlending=4,CustomBlending=5,AddEquation=100,SubtractEquation=101,ReverseSubtractEquation=102,MinEquation=103,MaxEquation=104,ZeroFactor=200,OneFactor=201,SrcColorFactor=202,OneMinusSrcColorFactor=203,SrcAlphaFactor=204,OneMinusSrcAlphaFactor=205,DstAlphaFactor=206,OneMinusDstAlphaFactor=207,DstColorFactor=208,OneMinusDstColorFactor=209,SrcAlphaSaturateFactor=210,ConstantColorFactor=211,OneMinusConstantColorFactor=212,ConstantAlphaFactor=213,OneMinusConstantAlphaFactor=214,NeverDepth=0,AlwaysDepth=1,LessDepth=2,LessEqualDepth=3,EqualDepth=4,GreaterEqualDepth=5,GreaterDepth=6,NotEqualDepth=7,MultiplyOperation=0,MixOperation=1,AddOperation=2,NoToneMapping=0,LinearToneMapping=1,ReinhardToneMapping=2,CineonToneMapping=3,ACESFilmicToneMapping=4,CustomToneMapping=5,AgXToneMapping=6,NeutralToneMapping=7,AttachedBindMode="attached",DetachedBindMode="detached",UVMapping=300,CubeReflectionMapping=301,CubeRefractionMapping=302,EquirectangularReflectionMapping=303,EquirectangularRefractionMapping=304,CubeUVReflectionMapping=306,RepeatWrapping=1e3,ClampToEdgeWrapping=1001,MirroredRepeatWrapping=1002,NearestFilter=1003,NearestMipmapNearestFilter=1004,NearestMipMapNearestFilter=1004,NearestMipmapLinearFilter=1005,NearestMipMapLinearFilter=1005,LinearFilter=1006,LinearMipmapNearestFilter=1007,LinearMipMapNearestFilter=1007,LinearMipmapLinearFilter=1008,LinearMipMapLinearFilter=1008,UnsignedByteType=1009,ByteType=1010,ShortType=1011,UnsignedShortType=1012,IntType=1013,UnsignedIntType=1014,FloatType=1015,HalfFloatType=1016,UnsignedShort4444Type=1017,UnsignedShort5551Type=1018,UnsignedInt248Type=1020,UnsignedInt5999Type=35902,UnsignedInt101111Type=35899,AlphaFormat=1021,RGBFormat=1022,RGBAFormat=1023,DepthFormat=1026,DepthStencilFormat=1027,RedFormat=1028,RedIntegerFormat=1029,RGFormat=1030,RGIntegerFormat=1031,RGBIntegerFormat=1032,RGBAIntegerFormat=1033,RGB_S3TC_DXT1_Format=33776,RGBA_S3TC_DXT1_Format=33777,RGBA_S3TC_DXT3_Format=33778,RGBA_S3TC_DXT5_Format=33779,RGB_PVRTC_4BPPV1_Format=35840,RGB_PVRTC_2BPPV1_Format=35841,RGBA_PVRTC_4BPPV1_Format=35842,RGBA_PVRTC_2BPPV1_Format=35843,RGB_ETC1_Format=36196,RGB_ETC2_Format=37492,RGBA_ETC2_EAC_Format=37496,R11_EAC_Format=37488,SIGNED_R11_EAC_Format=37489,RG11_EAC_Format=37490,SIGNED_RG11_EAC_Format=37491,RGBA_ASTC_4x4_Format=37808,RGBA_ASTC_5x4_Format=37809,RGBA_ASTC_5x5_Format=37810,RGBA_ASTC_6x5_Format=37811,RGBA_ASTC_6x6_Format=37812,RGBA_ASTC_8x5_Format=37813,RGBA_ASTC_8x6_Format=37814,RGBA_ASTC_8x8_Format=37815,RGBA_ASTC_10x5_Format=37816,RGBA_ASTC_10x6_Format=37817,RGBA_ASTC_10x8_Format=37818,RGBA_ASTC_10x10_Format=37819,RGBA_ASTC_12x10_Format=37820,RGBA_ASTC_12x12_Format=37821,RGBA_BPTC_Format=36492,RGB_BPTC_SIGNED_Format=36494,RGB_BPTC_UNSIGNED_Format=36495,RED_RGTC1_Format=36283,SIGNED_RED_RGTC1_Format=36284,RED_GREEN_RGTC2_Format=36285,SIGNED_RED_GREEN_RGTC2_Format=36286,LoopOnce=2200,LoopRepeat=2201,LoopPingPong=2202,InterpolateDiscrete=2300,InterpolateLinear=2301,InterpolateSmooth=2302,ZeroCurvatureEnding=2400,ZeroSlopeEnding=2401,WrapAroundEnding=2402,NormalAnimationBlendMode=2500,AdditiveAnimationBlendMode=2501,TrianglesDrawMode=0,TriangleStripDrawMode=1,TriangleFanDrawMode=2,BasicDepthPacking=3200,RGBADepthPacking=3201,RGBDepthPacking=3202,RGDepthPacking=3203,TangentSpaceNormalMap=0,ObjectSpaceNormalMap=1,NoColorSpace="",SRGBColorSpace="srgb",LinearSRGBColorSpace="srgb-linear",LinearTransfer="linear",SRGBTransfer="srgb",NoNormalPacking="",NormalRGPacking="rg",NormalGAPacking="ga",ZeroStencilOp=0,KeepStencilOp=7680,ReplaceStencilOp=7681,IncrementStencilOp=7682,DecrementStencilOp=7683,IncrementWrapStencilOp=34055,DecrementWrapStencilOp=34056,InvertStencilOp=5386,NeverStencilFunc=512,LessStencilFunc=513,EqualStencilFunc=514,LessEqualStencilFunc=515,GreaterStencilFunc=516,NotEqualStencilFunc=517,GreaterEqualStencilFunc=518,AlwaysStencilFunc=519,NeverCompare=512,LessCompare=513,EqualCompare=514,LessEqualCompare=515,GreaterCompare=516,NotEqualCompare=517,GreaterEqualCompare=518,AlwaysCompare=519,StaticDrawUsage=35044,DynamicDrawUsage=35048,StreamDrawUsage=35040,StaticReadUsage=35045,DynamicReadUsage=35049,StreamReadUsage=35041,StaticCopyUsage=35046,DynamicCopyUsage=35050,StreamCopyUsage=35042,GLSL1="100",GLSL3="300 es",WebGLCoordinateSystem=2e3,WebGPUCoordinateSystem=2001,TimestampQuery={COMPUTE:"compute",RENDER:"render"},InterpolationSamplingType={PERSPECTIVE:"perspective",LINEAR:"linear",FLAT:"flat"},InterpolationSamplingMode={NORMAL:"normal",CENTROID:"centroid",SAMPLE:"sample",FIRST:"first",EITHER:"either"};function arrayNeedsUint32(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}const TYPED_ARRAYS={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function getTypedArray(e,t){return new TYPED_ARRAYS[e](t)}function isTypedArray(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function createElementNS(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function createCanvasElement(){const e=createElementNS("canvas");return e.style.display="block",e}const _cache={};let _setConsoleFunction=null;function setConsoleFunction(e){_setConsoleFunction=e}function getConsoleFunction(){return _setConsoleFunction}function log(...e){const t="THREE."+e.shift();_setConsoleFunction&&_setConsoleFunction("log",t,...e)}function warn(...e){const t="THREE."+e.shift();_setConsoleFunction&&_setConsoleFunction("warn",t,...e)}function error(...e){const t="THREE."+e.shift();_setConsoleFunction&&_setConsoleFunction("error",t,...e)}function warnOnce(...e){const t=e.join(" ");t in _cache||(_cache[t]=!0,warn(...e))}function probeAsync(e,t,i){return new Promise((function(n,r){setTimeout((function o(){switch(e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:r();break;case e.TIMEOUT_EXPIRED:setTimeout(o,i);break;default:n()}}),i)}))}class EventDispatcher{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return void 0!==i&&(void 0!==i[e]&&-1!==i[e].indexOf(t))}removeEventListener(e,t){const i=this._listeners;if(void 0===i)return;const n=i[e];if(void 0!==n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}dispatchEvent(e){const t=this._listeners;if(void 0===t)return;const i=t[e.type];if(void 0!==i){e.target=this;const t=i.slice(0);for(let i=0,n=t.length;i<n;i++)t[i].call(this,e);e.target=null}}}const _lut=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let _seed=1234567;const DEG2RAD=Math.PI/180,RAD2DEG=180/Math.PI;function generateUUID$1(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(_lut[255&e]+_lut[e>>8&255]+_lut[e>>16&255]+_lut[e>>24&255]+"-"+_lut[255&t]+_lut[t>>8&255]+"-"+_lut[t>>16&15|64]+_lut[t>>24&255]+"-"+_lut[63&i|128]+_lut[i>>8&255]+"-"+_lut[i>>16&255]+_lut[i>>24&255]+_lut[255&n]+_lut[n>>8&255]+_lut[n>>16&255]+_lut[n>>24&255]).toLowerCase()}function clamp(e,t,i){return Math.max(t,Math.min(i,e))}function euclideanModulo(e,t){return(e%t+t)%t}function mapLinear(e,t,i,n,r){return n+(e-t)*(r-n)/(i-t)}function inverseLerp(e,t,i){return e!==t?(i-e)/(t-e):0}function lerp(e,t,i){return(1-i)*e+i*t}function damp(e,t,i,n){return lerp(e,t,1-Math.exp(-i*n))}function pingpong(e,t=1){return t-Math.abs(euclideanModulo(e,2*t)-t)}function smoothstep(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)}function smootherstep(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)}function randInt(e,t){return e+Math.floor(Math.random()*(t-e+1))}function randFloat(e,t){return e+Math.random()*(t-e)}function randFloatSpread(e){return e*(.5-Math.random())}function seededRandom(e){void 0!==e&&(_seed=e);let t=_seed+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}function degToRad(e){return e*DEG2RAD}function radToDeg(e){return e*RAD2DEG}function isPowerOfTwo(e){return!(e&e-1)&&0!==e}function ceilPowerOfTwo(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function floorPowerOfTwo(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}function setQuaternionFromProperEuler(e,t,i,n,r){const o=Math.cos,s=Math.sin,a=o(i/2),l=s(i/2),c=o((t+n)/2),u=s((t+n)/2),h=o((t-n)/2),d=s((t-n)/2),p=o((n-t)/2),f=s((n-t)/2);switch(r){case"XYX":e.set(a*u,l*h,l*d,a*c);break;case"YZY":e.set(l*d,a*u,l*h,a*c);break;case"ZXZ":e.set(l*h,l*d,a*u,a*c);break;case"XZX":e.set(a*u,l*f,l*p,a*c);break;case"YXY":e.set(l*p,a*u,l*f,a*c);break;case"ZYZ":e.set(l*f,l*p,a*u,a*c);break;default:warn("MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}function denormalize(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function normalize(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const MathUtils={DEG2RAD:DEG2RAD,RAD2DEG:RAD2DEG,generateUUID:generateUUID$1,clamp:clamp,euclideanModulo:euclideanModulo,mapLinear:mapLinear,inverseLerp:inverseLerp,lerp:lerp,damp:damp,pingpong:pingpong,smoothstep:smoothstep,smootherstep:smootherstep,randInt:randInt,randFloat:randFloat,randFloatSpread:randFloatSpread,seededRandom:seededRandom,degToRad:degToRad,radToDeg:radToDeg,isPowerOfTwo:isPowerOfTwo,ceilPowerOfTwo:ceilPowerOfTwo,floorPowerOfTwo:floorPowerOfTwo,setQuaternionFromProperEuler:setQuaternionFromProperEuler,normalize:normalize,denormalize:denormalize};class Vector2{constructor(e=0,t=0){Vector2.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6],this.y=n[1]*t+n[4]*i+n[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=clamp(this.x,e.x,t.x),this.y=clamp(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=clamp(this.x,e,t),this.y=clamp(this.y,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(clamp(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(clamp(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),n=Math.sin(t),r=this.x-e.x,o=this.y-e.y;return this.x=r*i-o*n+e.x,this.y=r*n+o*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Quaternion{constructor(e=0,t=0,i=0,n=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=i,this._w=n}static slerpFlat(e,t,i,n,r,o,s){let a=i[n+0],l=i[n+1],c=i[n+2],u=i[n+3],h=r[o+0],d=r[o+1],p=r[o+2],f=r[o+3];if(s<=0)return e[t+0]=a,e[t+1]=l,e[t+2]=c,void(e[t+3]=u);if(s>=1)return e[t+0]=h,e[t+1]=d,e[t+2]=p,void(e[t+3]=f);if(u!==f||a!==h||l!==d||c!==p){let e=a*h+l*d+c*p+u*f;e<0&&(h=-h,d=-d,p=-p,f=-f,e=-e);let t=1-s;if(e<.9995){const i=Math.acos(e),n=Math.sin(i);t=Math.sin(t*i)/n,a=a*t+h*(s=Math.sin(s*i)/n),l=l*t+d*s,c=c*t+p*s,u=u*t+f*s}else{a=a*t+h*s,l=l*t+d*s,c=c*t+p*s,u=u*t+f*s;const e=1/Math.sqrt(a*a+l*l+c*c+u*u);a*=e,l*=e,c*=e,u*=e}}e[t]=a,e[t+1]=l,e[t+2]=c,e[t+3]=u}static multiplyQuaternionsFlat(e,t,i,n,r,o){const s=i[n],a=i[n+1],l=i[n+2],c=i[n+3],u=r[o],h=r[o+1],d=r[o+2],p=r[o+3];return e[t]=s*p+c*u+a*d-l*h,e[t+1]=a*p+c*h+l*u-s*d,e[t+2]=l*p+c*d+s*h-a*u,e[t+3]=c*p-s*u-a*h-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const i=e._x,n=e._y,r=e._z,o=e._order,s=Math.cos,a=Math.sin,l=s(i/2),c=s(n/2),u=s(r/2),h=a(i/2),d=a(n/2),p=a(r/2);switch(o){case"XYZ":this._x=h*c*u+l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u-h*d*p;break;case"YXZ":this._x=h*c*u+l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u+h*d*p;break;case"ZXY":this._x=h*c*u-l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u-h*d*p;break;case"ZYX":this._x=h*c*u-l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u+h*d*p;break;case"YZX":this._x=h*c*u+l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u-h*d*p;break;case"XZY":this._x=h*c*u-l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u+h*d*p;break;default:warn("Quaternion: .setFromEuler() encountered an unknown order: "+o)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,n=Math.sin(i);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],n=t[4],r=t[8],o=t[1],s=t[5],a=t[9],l=t[2],c=t[6],u=t[10],h=i+s+u;if(h>0){const e=.5/Math.sqrt(h+1);this._w=.25/e,this._x=(c-a)*e,this._y=(r-l)*e,this._z=(o-n)*e}else if(i>s&&i>u){const e=2*Math.sqrt(1+i-s-u);this._w=(c-a)/e,this._x=.25*e,this._y=(n+o)/e,this._z=(r+l)/e}else if(s>u){const e=2*Math.sqrt(1+s-i-u);this._w=(r-l)/e,this._x=(n+o)/e,this._y=.25*e,this._z=(a+c)/e}else{const e=2*Math.sqrt(1+u-i-s);this._w=(o-n)/e,this._x=(r+l)/e,this._y=(a+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<1e-8?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(clamp(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const n=Math.min(1,t/i);return this.slerp(e,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,n=e._y,r=e._z,o=e._w,s=t._x,a=t._y,l=t._z,c=t._w;return this._x=i*c+o*s+n*l-r*a,this._y=n*c+o*a+r*s-i*l,this._z=r*c+o*l+i*a-n*s,this._w=o*c-i*s-n*a-r*l,this._onChangeCallback(),this}slerp(e,t){if(t<=0)return this;if(t>=1)return this.copy(e);let i=e._x,n=e._y,r=e._z,o=e._w,s=this.dot(e);s<0&&(i=-i,n=-n,r=-r,o=-o,s=-s);let a=1-t;if(s<.9995){const e=Math.acos(s),l=Math.sin(e);a=Math.sin(a*e)/l,t=Math.sin(t*e)/l,this._x=this._x*a+i*t,this._y=this._y*a+n*t,this._z=this._z*a+r*t,this._w=this._w*a+o*t,this._onChangeCallback()}else this._x=this._x*a+i*t,this._y=this._y*a+n*t,this._z=this._z*a+r*t,this._w=this._w*a+o*t,this.normalize();return this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),i=Math.random(),n=Math.sqrt(1-i),r=Math.sqrt(i);return this.set(n*Math.sin(e),n*Math.cos(e),r*Math.sin(t),r*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Vector3{constructor(e=0,t=0,i=0){Vector3.prototype.isVector3=!0,this.x=e,this.y=t,this.z=i}set(e,t,i){return void 0===i&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(_quaternion$4.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(_quaternion$4.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,n=this.z,r=e.elements;return this.x=r[0]*t+r[3]*i+r[6]*n,this.y=r[1]*t+r[4]*i+r[7]*n,this.z=r[2]*t+r[5]*i+r[8]*n,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,r=e.elements,o=1/(r[3]*t+r[7]*i+r[11]*n+r[15]);return this.x=(r[0]*t+r[4]*i+r[8]*n+r[12])*o,this.y=(r[1]*t+r[5]*i+r[9]*n+r[13])*o,this.z=(r[2]*t+r[6]*i+r[10]*n+r[14])*o,this}applyQuaternion(e){const t=this.x,i=this.y,n=this.z,r=e.x,o=e.y,s=e.z,a=e.w,l=2*(o*n-s*i),c=2*(s*t-r*n),u=2*(r*i-o*t);return this.x=t+a*l+o*u-s*c,this.y=i+a*c+s*l-r*u,this.z=n+a*u+r*c-o*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,n=this.z,r=e.elements;return this.x=r[0]*t+r[4]*i+r[8]*n,this.y=r[1]*t+r[5]*i+r[9]*n,this.z=r[2]*t+r[6]*i+r[10]*n,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=clamp(this.x,e.x,t.x),this.y=clamp(this.y,e.y,t.y),this.z=clamp(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=clamp(this.x,e,t),this.y=clamp(this.y,e,t),this.z=clamp(this.z,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(clamp(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,n=e.y,r=e.z,o=t.x,s=t.y,a=t.z;return this.x=n*a-r*s,this.y=r*o-i*a,this.z=i*s-n*o,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return _vector$c.copy(this).projectOnVector(e),this.sub(_vector$c)}reflect(e){return this.sub(_vector$c.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(clamp(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const n=Math.sin(t)*e;return this.x=n*Math.sin(i),this.y=Math.cos(t)*e,this.z=n*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=n,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,i=Math.sqrt(1-t*t);return this.x=i*Math.cos(e),this.y=t,this.z=i*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const _vector$c=new Vector3,_quaternion$4=new Quaternion;class Matrix3{constructor(e,t,i,n,r,o,s,a,l){Matrix3.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,i,n,r,o,s,a,l)}set(e,t,i,n,r,o,s,a,l){const c=this.elements;return c[0]=e,c[1]=n,c[2]=s,c[3]=t,c[4]=r,c[5]=a,c[6]=i,c[7]=o,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,r=this.elements,o=i[0],s=i[3],a=i[6],l=i[1],c=i[4],u=i[7],h=i[2],d=i[5],p=i[8],f=n[0],m=n[3],g=n[6],_=n[1],y=n[4],v=n[7],x=n[2],b=n[5],T=n[8];return r[0]=o*f+s*_+a*x,r[3]=o*m+s*y+a*b,r[6]=o*g+s*v+a*T,r[1]=l*f+c*_+u*x,r[4]=l*m+c*y+u*b,r[7]=l*g+c*v+u*T,r[2]=h*f+d*_+p*x,r[5]=h*m+d*y+p*b,r[8]=h*g+d*v+p*T,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],l=e[7],c=e[8];return t*o*c-t*s*l-i*r*c+i*s*a+n*r*l-n*o*a}invert(){const e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],l=e[7],c=e[8],u=c*o-s*l,h=s*a-c*r,d=l*r-o*a,p=t*u+i*h+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return e[0]=u*f,e[1]=(n*l-c*i)*f,e[2]=(s*i-n*o)*f,e[3]=h*f,e[4]=(c*t-n*a)*f,e[5]=(n*r-s*t)*f,e[6]=d*f,e[7]=(i*a-l*t)*f,e[8]=(o*t-i*r)*f,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,n,r,o,s){const a=Math.cos(r),l=Math.sin(r);return this.set(i*a,i*l,-i*(a*o+l*s)+o+e,-n*l,n*a,-n*(-l*o+a*s)+s+t,0,0,1),this}scale(e,t){return this.premultiply(_m3.makeScale(e,t)),this}rotate(e){return this.premultiply(_m3.makeRotation(-e)),this}translate(e,t){return this.premultiply(_m3.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,i,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<9;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const _m3=new Matrix3,LINEAR_REC709_TO_XYZ=(new Matrix3).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),XYZ_TO_LINEAR_REC709=(new Matrix3).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function createColorManagement(){const e={enabled:!0,workingColorSpace:LinearSRGBColorSpace,spaces:{},convert:function(e,t,i){return!1!==this.enabled&&t!==i&&t&&i?(this.spaces[t].transfer===SRGBTransfer&&(e.r=SRGBToLinear(e.r),e.g=SRGBToLinear(e.g),e.b=SRGBToLinear(e.b)),this.spaces[t].primaries!==this.spaces[i].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[i].fromXYZ)),this.spaces[i].transfer===SRGBTransfer&&(e.r=LinearToSRGB(e.r),e.g=LinearToSRGB(e.g),e.b=LinearToSRGB(e.b)),e):e},workingToColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},colorSpaceToWorking:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===NoColorSpace?LinearTransfer:this.spaces[e].transfer},getToneMappingMode:function(e){return this.spaces[e].outputColorSpaceConfig.toneMappingMode||"standard"},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,i){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[i].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(t,i){return warnOnce("ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),e.workingToColorSpace(t,i)},toWorkingColorSpace:function(t,i){return warnOnce("ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),e.colorSpaceToWorking(t,i)}},t=[.64,.33,.3,.6,.15,.06],i=[.2126,.7152,.0722],n=[.3127,.329];return e.define({[LinearSRGBColorSpace]:{primaries:t,whitePoint:n,transfer:LinearTransfer,toXYZ:LINEAR_REC709_TO_XYZ,fromXYZ:XYZ_TO_LINEAR_REC709,luminanceCoefficients:i,workingColorSpaceConfig:{unpackColorSpace:SRGBColorSpace},outputColorSpaceConfig:{drawingBufferColorSpace:SRGBColorSpace}},[SRGBColorSpace]:{primaries:t,whitePoint:n,transfer:SRGBTransfer,toXYZ:LINEAR_REC709_TO_XYZ,fromXYZ:XYZ_TO_LINEAR_REC709,luminanceCoefficients:i,outputColorSpaceConfig:{drawingBufferColorSpace:SRGBColorSpace}}}),e}const ColorManagement=createColorManagement();function SRGBToLinear(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function LinearToSRGB(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let _canvas;class ImageUtils{static getDataURL(e,t="image/png"){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let i;if(e instanceof HTMLCanvasElement)i=e;else{void 0===_canvas&&(_canvas=createElementNS("canvas")),_canvas.width=e.width,_canvas.height=e.height;const t=_canvas.getContext("2d");e instanceof ImageData?t.putImageData(e,0,0):t.drawImage(e,0,0,e.width,e.height),i=_canvas}return i.toDataURL(t)}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=createElementNS("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);const n=i.getImageData(0,0,e.width,e.height),r=n.data;for(let e=0;e<r.length;e++)r[e]=255*SRGBToLinear(r[e]/255);return i.putImageData(n,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t[e]=t instanceof Uint8Array||t instanceof Uint8ClampedArray?Math.floor(255*SRGBToLinear(t[e]/255)):SRGBToLinear(t[e]);return{data:t,width:e.width,height:e.height}}return warn("ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let _sourceId=0;class Source{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:_sourceId++}),this.uuid=generateUUID$1(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){const t=this.data;return"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement?e.set(t.videoWidth,t.videoHeight,0):"undefined"!=typeof VideoFrame&&t instanceof VideoFrame?e.set(t.displayHeight,t.displayWidth,0):null!==t?e.set(t.width,t.height,t.depth||0):e.set(0,0,0),e}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const i={uuid:this.uuid,url:""},n=this.data;if(null!==n){let e;if(Array.isArray(n)){e=[];for(let t=0,i=n.length;t<i;t++)e.push(serializeImage(n[t].isDataTexture?n[t].image:n[t]))}else e=serializeImage(n);i.url=e}return t||(e.images[this.uuid]=i),i}}function serializeImage(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?ImageUtils.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(warn("Texture: Unable to serialize Texture."),{})}let _textureId=0;const _tempVec3=new Vector3;class Texture extends EventDispatcher{constructor(e=Texture.DEFAULT_IMAGE,t=Texture.DEFAULT_MAPPING,i=ClampToEdgeWrapping,n=ClampToEdgeWrapping,r=LinearFilter,o=LinearMipmapLinearFilter,s=RGBAFormat,a=UnsignedByteType,l=Texture.DEFAULT_ANISOTROPY,c=NoColorSpace){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:_textureId++}),this.uuid=generateUUID$1(),this.name="",this.source=new Source(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=i,this.wrapT=n,this.magFilter=r,this.minFilter=o,this.anisotropy=l,this.format=s,this.internalFormat=null,this.type=a,this.offset=new Vector2(0,0),this.repeat=new Vector2(1,1),this.center=new Vector2(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Matrix3,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(e&&e.depth&&e.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(_tempVec3).x}get height(){return this.source.getSize(_tempVec3).y}get depth(){return this.source.getSize(_tempVec3).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(const t in e){const i=e[t];if(void 0===i){warn(`Texture.setValues(): parameter '${t}' has value of undefined.`);continue}const n=this[t];void 0!==n?n&&i&&n.isVector2&&i.isVector2||n&&i&&n.isVector3&&i.isVector3||n&&i&&n.isMatrix3&&i.isMatrix3?n.copy(i):this[t]=i:warn(`Texture.setValues(): property '${t}' does not exist.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const i={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==UVMapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case RepeatWrapping:e.x=e.x-Math.floor(e.x);break;case ClampToEdgeWrapping:e.x=e.x<0?0:1;break;case MirroredRepeatWrapping:e.x=1===Math.abs(Math.floor(e.x)%2)?Math.ceil(e.x)-e.x:e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case RepeatWrapping:e.y=e.y-Math.floor(e.y);break;case ClampToEdgeWrapping:e.y=e.y<0?0:1;break;case MirroredRepeatWrapping:e.y=1===Math.abs(Math.floor(e.y)%2)?Math.ceil(e.y)-e.y:e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}Texture.DEFAULT_IMAGE=null,Texture.DEFAULT_MAPPING=UVMapping,Texture.DEFAULT_ANISOTROPY=1;class Vector4{constructor(e=0,t=0,i=0,n=1){Vector4.prototype.isVector4=!0,this.x=e,this.y=t,this.z=i,this.w=n}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,r=this.w,o=e.elements;return this.x=o[0]*t+o[4]*i+o[8]*n+o[12]*r,this.y=o[1]*t+o[5]*i+o[9]*n+o[13]*r,this.z=o[2]*t+o[6]*i+o[10]*n+o[14]*r,this.w=o[3]*t+o[7]*i+o[11]*n+o[15]*r,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,n,r;const o=.01,s=.1,a=e.elements,l=a[0],c=a[4],u=a[8],h=a[1],d=a[5],p=a[9],f=a[2],m=a[6],g=a[10];if(Math.abs(c-h)<o&&Math.abs(u-f)<o&&Math.abs(p-m)<o){if(Math.abs(c+h)<s&&Math.abs(u+f)<s&&Math.abs(p+m)<s&&Math.abs(l+d+g-3)<s)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,a=(d+1)/2,_=(g+1)/2,y=(c+h)/4,v=(u+f)/4,x=(p+m)/4;return e>a&&e>_?e<o?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(e),n=y/i,r=v/i):a>_?a<o?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(a),i=y/n,r=x/n):_<o?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(_),i=v/r,n=x/r),this.set(i,n,r,t),this}let _=Math.sqrt((m-p)*(m-p)+(u-f)*(u-f)+(h-c)*(h-c));return Math.abs(_)<.001&&(_=1),this.x=(m-p)/_,this.y=(u-f)/_,this.z=(h-c)/_,this.w=Math.acos((l+d+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=clamp(this.x,e.x,t.x),this.y=clamp(this.y,e.y,t.y),this.z=clamp(this.z,e.z,t.z),this.w=clamp(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=clamp(this.x,e,t),this.y=clamp(this.y,e,t),this.z=clamp(this.z,e,t),this.w=clamp(this.w,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(clamp(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class RenderTarget extends EventDispatcher{constructor(e=1,t=1,i={}){super(),i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:LinearFilter,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},i),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=i.depth,this.scissor=new Vector4(0,0,e,t),this.scissorTest=!1,this.viewport=new Vector4(0,0,e,t);const n=new Texture({width:e,height:t,depth:i.depth});this.textures=[];const r=i.count;for(let e=0;e<r;e++)this.textures[e]=n.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this._setTextureOptions(i),this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.resolveDepthBuffer=i.resolveDepthBuffer,this.resolveStencilBuffer=i.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=i.depthTexture,this.samples=i.samples,this.multiview=i.multiview}_setTextureOptions(e={}){const t={minFilter:LinearFilter,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==e.mapping&&(t.mapping=e.mapping),void 0!==e.wrapS&&(t.wrapS=e.wrapS),void 0!==e.wrapT&&(t.wrapT=e.wrapT),void 0!==e.wrapR&&(t.wrapR=e.wrapR),void 0!==e.magFilter&&(t.magFilter=e.magFilter),void 0!==e.minFilter&&(t.minFilter=e.minFilter),void 0!==e.format&&(t.format=e.format),void 0!==e.type&&(t.type=e.type),void 0!==e.anisotropy&&(t.anisotropy=e.anisotropy),void 0!==e.colorSpace&&(t.colorSpace=e.colorSpace),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.generateMipmaps&&(t.generateMipmaps=e.generateMipmaps),void 0!==e.internalFormat&&(t.internalFormat=e.internalFormat);for(let e=0;e<this.textures.length;e++){this.textures[e].setValues(t)}}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,i=1){if(this.width!==e||this.height!==t||this.depth!==i){this.width=e,this.height=t,this.depth=i;for(let n=0,r=this.textures.length;n<r;n++)this.textures[n].image.width=e,this.textures[n].image.height=t,this.textures[n].image.depth=i,!0!==this.textures[n].isData3DTexture&&(this.textures[n].isArrayTexture=this.textures[n].image.depth>1);this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,i=e.textures.length;t<i;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const i=Object.assign({},e.textures[t].image);this.textures[t].source=new Source(i)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class WebGLRenderTarget extends RenderTarget{constructor(e=1,t=1,i={}){super(e,t,i),this.isWebGLRenderTarget=!0}}class DataArrayTexture extends Texture{constructor(e=null,t=1,i=1,n=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:i,depth:n},this.magFilter=NearestFilter,this.minFilter=NearestFilter,this.wrapR=ClampToEdgeWrapping,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class WebGLArrayRenderTarget extends WebGLRenderTarget{constructor(e=1,t=1,i=1,n={}){super(e,t,n),this.isWebGLArrayRenderTarget=!0,this.depth=i,this.texture=new DataArrayTexture(null,e,t,i),this._setTextureOptions(n),this.texture.isRenderTargetTexture=!0}}class Data3DTexture extends Texture{constructor(e=null,t=1,i=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:n},this.magFilter=NearestFilter,this.minFilter=NearestFilter,this.wrapR=ClampToEdgeWrapping,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class WebGL3DRenderTarget extends WebGLRenderTarget{constructor(e=1,t=1,i=1,n={}){super(e,t,n),this.isWebGL3DRenderTarget=!0,this.depth=i,this.texture=new Data3DTexture(null,e,t,i),this._setTextureOptions(n),this.texture.isRenderTargetTexture=!0}}class Box3{constructor(e=new Vector3(1/0,1/0,1/0),t=new Vector3(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t+=3)this.expandByPoint(_vector$b.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,i=e.count;t<i;t++)this.expandByPoint(_vector$b.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=_vector$b.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const i=e.geometry;if(void 0!==i){const n=i.getAttribute("position");if(!0===t&&void 0!==n&&!0!==e.isInstancedMesh)for(let t=0,i=n.count;t<i;t++)!0===e.isMesh?e.getVertexPosition(t,_vector$b):_vector$b.fromBufferAttribute(n,t),_vector$b.applyMatrix4(e.matrixWorld),this.expandByPoint(_vector$b);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),_box$4.copy(e.boundingBox)):(null===i.boundingBox&&i.computeBoundingBox(),_box$4.copy(i.boundingBox)),_box$4.applyMatrix4(e.matrixWorld),this.union(_box$4)}const n=e.children;for(let e=0,i=n.length;e<i;e++)this.expandByObject(n[e],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,_vector$b),_vector$b.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(_center),_extents.subVectors(this.max,_center),_v0$2.subVectors(e.a,_center),_v1$7.subVectors(e.b,_center),_v2$4.subVectors(e.c,_center),_f0.subVectors(_v1$7,_v0$2),_f1.subVectors(_v2$4,_v1$7),_f2.subVectors(_v0$2,_v2$4);let t=[0,-_f0.z,_f0.y,0,-_f1.z,_f1.y,0,-_f2.z,_f2.y,_f0.z,0,-_f0.x,_f1.z,0,-_f1.x,_f2.z,0,-_f2.x,-_f0.y,_f0.x,0,-_f1.y,_f1.x,0,-_f2.y,_f2.x,0];return!!satForAxes(t,_v0$2,_v1$7,_v2$4,_extents)&&(t=[1,0,0,0,1,0,0,0,1],!!satForAxes(t,_v0$2,_v1$7,_v2$4,_extents)&&(_triangleNormal.crossVectors(_f0,_f1),t=[_triangleNormal.x,_triangleNormal.y,_triangleNormal.z],satForAxes(t,_v0$2,_v1$7,_v2$4,_extents)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,_vector$b).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(_vector$b).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(_points[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),_points[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),_points[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),_points[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),_points[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),_points[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),_points[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),_points[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(_points)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}const _points=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],_vector$b=new Vector3,_box$4=new Box3,_v0$2=new Vector3,_v1$7=new Vector3,_v2$4=new Vector3,_f0=new Vector3,_f1=new Vector3,_f2=new Vector3,_center=new Vector3,_extents=new Vector3,_triangleNormal=new Vector3,_testAxis=new Vector3;function satForAxes(e,t,i,n,r){for(let o=0,s=e.length-3;o<=s;o+=3){_testAxis.fromArray(e,o);const s=r.x*Math.abs(_testAxis.x)+r.y*Math.abs(_testAxis.y)+r.z*Math.abs(_testAxis.z),a=t.dot(_testAxis),l=i.dot(_testAxis),c=n.dot(_testAxis);if(Math.max(-Math.max(a,l,c),Math.min(a,l,c))>s)return!1}return!0}const _box$3=new Box3,_v1$6=new Vector3,_v2$3=new Vector3;class Sphere{constructor(e=new Vector3,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const i=this.center;void 0!==t?i.copy(t):_box$3.setFromPoints(e).getCenter(i);let n=0;for(let t=0,r=e.length;t<r;t++)n=Math.max(n,i.distanceToSquared(e[t]));return this.radius=Math.sqrt(n),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const i=this.center.distanceToSquared(e);return t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;_v1$6.subVectors(e,this.center);const t=_v1$6.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),i=.5*(e-this.radius);this.center.addScaledVector(_v1$6,i/e),this.radius+=i}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(_v2$3.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(_v1$6.copy(e.center).add(_v2$3)),this.expandByPoint(_v1$6.copy(e.center).sub(_v2$3))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}const _vector$a=new Vector3,_segCenter=new Vector3,_segDir=new Vector3,_diff=new Vector3,_edge1=new Vector3,_edge2=new Vector3,_normal$1=new Vector3;class Ray{constructor(e=new Vector3,t=new Vector3(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,_vector$a)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=_vector$a.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(_vector$a.copy(this.origin).addScaledVector(this.direction,t),_vector$a.distanceToSquared(e))}distanceSqToSegment(e,t,i,n){_segCenter.copy(e).add(t).multiplyScalar(.5),_segDir.copy(t).sub(e).normalize(),_diff.copy(this.origin).sub(_segCenter);const r=.5*e.distanceTo(t),o=-this.direction.dot(_segDir),s=_diff.dot(this.direction),a=-_diff.dot(_segDir),l=_diff.lengthSq(),c=Math.abs(1-o*o);let u,h,d,p;if(c>0)if(u=o*a-s,h=o*s-a,p=r*c,u>=0)if(h>=-p)if(h<=p){const e=1/c;u*=e,h*=e,d=u*(u+o*h+2*s)+h*(o*u+h+2*a)+l}else h=r,u=Math.max(0,-(o*h+s)),d=-u*u+h*(h+2*a)+l;else h=-r,u=Math.max(0,-(o*h+s)),d=-u*u+h*(h+2*a)+l;else h<=-p?(u=Math.max(0,-(-o*r+s)),h=u>0?-r:Math.min(Math.max(-r,-a),r),d=-u*u+h*(h+2*a)+l):h<=p?(u=0,h=Math.min(Math.max(-r,-a),r),d=h*(h+2*a)+l):(u=Math.max(0,-(o*r+s)),h=u>0?r:Math.min(Math.max(-r,-a),r),d=-u*u+h*(h+2*a)+l);else h=o>0?-r:r,u=Math.max(0,-(o*h+s)),d=-u*u+h*(h+2*a)+l;return i&&i.copy(this.origin).addScaledVector(this.direction,u),n&&n.copy(_segCenter).addScaledVector(_segDir,h),d}intersectSphere(e,t){_vector$a.subVectors(e.center,this.origin);const i=_vector$a.dot(this.direction),n=_vector$a.dot(_vector$a)-i*i,r=e.radius*e.radius;if(n>r)return null;const o=Math.sqrt(r-n),s=i-o,a=i+o;return a<0?null:this.at(s<0?a:s,t)}intersectsSphere(e){return!(e.radius<0)&&this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){const i=this.distanceToPlane(e);return null===i?null:this.at(i,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let i,n,r,o,s,a;const l=1/this.direction.x,c=1/this.direction.y,u=1/this.direction.z,h=this.origin;return l>=0?(i=(e.min.x-h.x)*l,n=(e.max.x-h.x)*l):(i=(e.max.x-h.x)*l,n=(e.min.x-h.x)*l),c>=0?(r=(e.min.y-h.y)*c,o=(e.max.y-h.y)*c):(r=(e.max.y-h.y)*c,o=(e.min.y-h.y)*c),i>o||r>n?null:((r>i||isNaN(i))&&(i=r),(o<n||isNaN(n))&&(n=o),u>=0?(s=(e.min.z-h.z)*u,a=(e.max.z-h.z)*u):(s=(e.max.z-h.z)*u,a=(e.min.z-h.z)*u),i>a||s>n?null:((s>i||i!=i)&&(i=s),(a<n||n!=n)&&(n=a),n<0?null:this.at(i>=0?i:n,t)))}intersectsBox(e){return null!==this.intersectBox(e,_vector$a)}intersectTriangle(e,t,i,n,r){_edge1.subVectors(t,e),_edge2.subVectors(i,e),_normal$1.crossVectors(_edge1,_edge2);let o,s=this.direction.dot(_normal$1);if(s>0){if(n)return null;o=1}else{if(!(s<0))return null;o=-1,s=-s}_diff.subVectors(this.origin,e);const a=o*this.direction.dot(_edge2.crossVectors(_diff,_edge2));if(a<0)return null;const l=o*this.direction.dot(_edge1.cross(_diff));if(l<0)return null;if(a+l>s)return null;const c=-o*_diff.dot(_normal$1);return c<0?null:this.at(c/s,r)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Matrix4{constructor(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m){Matrix4.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m)}set(e,t,i,n,r,o,s,a,l,c,u,h,d,p,f,m){const g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=n,g[1]=r,g[5]=o,g[9]=s,g[13]=a,g[2]=l,g[6]=c,g[10]=u,g[14]=h,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Matrix4).fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return 0===this.determinant()?(e.set(1,0,0),t.set(0,1,0),i.set(0,0,1),this):(e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this)}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){if(0===e.determinant())return this.identity();const t=this.elements,i=e.elements,n=1/_v1$5.setFromMatrixColumn(e,0).length(),r=1/_v1$5.setFromMatrixColumn(e,1).length(),o=1/_v1$5.setFromMatrixColumn(e,2).length();return t[0]=i[0]*n,t[1]=i[1]*n,t[2]=i[2]*n,t[3]=0,t[4]=i[4]*r,t[5]=i[5]*r,t[6]=i[6]*r,t[7]=0,t[8]=i[8]*o,t[9]=i[9]*o,t[10]=i[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,i=e.x,n=e.y,r=e.z,o=Math.cos(i),s=Math.sin(i),a=Math.cos(n),l=Math.sin(n),c=Math.cos(r),u=Math.sin(r);if("XYZ"===e.order){const e=o*c,i=o*u,n=s*c,r=s*u;t[0]=a*c,t[4]=-a*u,t[8]=l,t[1]=i+n*l,t[5]=e-r*l,t[9]=-s*a,t[2]=r-e*l,t[6]=n+i*l,t[10]=o*a}else if("YXZ"===e.order){const e=a*c,i=a*u,n=l*c,r=l*u;t[0]=e+r*s,t[4]=n*s-i,t[8]=o*l,t[1]=o*u,t[5]=o*c,t[9]=-s,t[2]=i*s-n,t[6]=r+e*s,t[10]=o*a}else if("ZXY"===e.order){const e=a*c,i=a*u,n=l*c,r=l*u;t[0]=e-r*s,t[4]=-o*u,t[8]=n+i*s,t[1]=i+n*s,t[5]=o*c,t[9]=r-e*s,t[2]=-o*l,t[6]=s,t[10]=o*a}else if("ZYX"===e.order){const e=o*c,i=o*u,n=s*c,r=s*u;t[0]=a*c,t[4]=n*l-i,t[8]=e*l+r,t[1]=a*u,t[5]=r*l+e,t[9]=i*l-n,t[2]=-l,t[6]=s*a,t[10]=o*a}else if("YZX"===e.order){const e=o*a,i=o*l,n=s*a,r=s*l;t[0]=a*c,t[4]=r-e*u,t[8]=n*u+i,t[1]=u,t[5]=o*c,t[9]=-s*c,t[2]=-l*c,t[6]=i*u+n,t[10]=e-r*u}else if("XZY"===e.order){const e=o*a,i=o*l,n=s*a,r=s*l;t[0]=a*c,t[4]=-u,t[8]=l*c,t[1]=e*u+r,t[5]=o*c,t[9]=i*u-n,t[2]=n*u-i,t[6]=s*c,t[10]=r*u+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(_zero,e,_one)}lookAt(e,t,i){const n=this.elements;return _z.subVectors(e,t),0===_z.lengthSq()&&(_z.z=1),_z.normalize(),_x.crossVectors(i,_z),0===_x.lengthSq()&&(1===Math.abs(i.z)?_z.x+=1e-4:_z.z+=1e-4,_z.normalize(),_x.crossVectors(i,_z)),_x.normalize(),_y.crossVectors(_z,_x),n[0]=_x.x,n[4]=_y.x,n[8]=_z.x,n[1]=_x.y,n[5]=_y.y,n[9]=_z.y,n[2]=_x.z,n[6]=_y.z,n[10]=_z.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,r=this.elements,o=i[0],s=i[4],a=i[8],l=i[12],c=i[1],u=i[5],h=i[9],d=i[13],p=i[2],f=i[6],m=i[10],g=i[14],_=i[3],y=i[7],v=i[11],x=i[15],b=n[0],T=n[4],w=n[8],E=n[12],S=n[1],A=n[5],M=n[9],I=n[13],C=n[2],P=n[6],L=n[10],R=n[14],O=n[3],D=n[7],B=n[11],F=n[15];return r[0]=o*b+s*S+a*C+l*O,r[4]=o*T+s*A+a*P+l*D,r[8]=o*w+s*M+a*L+l*B,r[12]=o*E+s*I+a*R+l*F,r[1]=c*b+u*S+h*C+d*O,r[5]=c*T+u*A+h*P+d*D,r[9]=c*w+u*M+h*L+d*B,r[13]=c*E+u*I+h*R+d*F,r[2]=p*b+f*S+m*C+g*O,r[6]=p*T+f*A+m*P+g*D,r[10]=p*w+f*M+m*L+g*B,r[14]=p*E+f*I+m*R+g*F,r[3]=_*b+y*S+v*C+x*O,r[7]=_*T+y*A+v*P+x*D,r[11]=_*w+y*M+v*L+x*B,r[15]=_*E+y*I+v*R+x*F,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[1],i=e[5],n=e[9],r=e[13],o=e[2],s=e[6],a=e[10],l=e[14],c=e[3],u=e[7],h=e[11],d=e[15],p=n*l-r*a,f=i*l-r*s,m=i*a-n*s,g=t*l-r*o,_=t*a-n*o,y=t*s-i*o;return e[0]*(u*p-h*f+d*m)-e[4]*(c*p-h*g+d*_)+e[8]*(c*f-u*g+d*y)-e[12]*(c*m-u*_+h*y)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,i){const n=this.elements;return e.isVector3?(n[12]=e.x,n[13]=e.y,n[14]=e.z):(n[12]=e,n[13]=t,n[14]=i),this}invert(){const e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],l=e[7],c=e[8],u=e[9],h=e[10],d=e[11],p=e[12],f=e[13],m=e[14],g=e[15],_=u*m*l-f*h*l+f*a*d-s*m*d-u*a*g+s*h*g,y=p*h*l-c*m*l-p*a*d+o*m*d+c*a*g-o*h*g,v=c*f*l-p*u*l+p*s*d-o*f*d-c*s*g+o*u*g,x=p*u*a-c*f*a-p*s*h+o*f*h+c*s*m-o*u*m,b=t*_+i*y+n*v+r*x;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const T=1/b;return e[0]=_*T,e[1]=(f*h*r-u*m*r-f*n*d+i*m*d+u*n*g-i*h*g)*T,e[2]=(s*m*r-f*a*r+f*n*l-i*m*l-s*n*g+i*a*g)*T,e[3]=(u*a*r-s*h*r-u*n*l+i*h*l+s*n*d-i*a*d)*T,e[4]=y*T,e[5]=(c*m*r-p*h*r+p*n*d-t*m*d-c*n*g+t*h*g)*T,e[6]=(p*a*r-o*m*r-p*n*l+t*m*l+o*n*g-t*a*g)*T,e[7]=(o*h*r-c*a*r+c*n*l-t*h*l-o*n*d+t*a*d)*T,e[8]=v*T,e[9]=(p*u*r-c*f*r-p*i*d+t*f*d+c*i*g-t*u*g)*T,e[10]=(o*f*r-p*s*r+p*i*l-t*f*l-o*i*g+t*s*g)*T,e[11]=(c*s*r-o*u*r-c*i*l+t*u*l+o*i*d-t*s*d)*T,e[12]=x*T,e[13]=(c*f*n-p*u*n+p*i*h-t*f*h-c*i*m+t*u*m)*T,e[14]=(p*s*n-o*f*n-p*i*a+t*f*a+o*i*m-t*s*m)*T,e[15]=(o*u*n-c*s*n+c*i*a-t*u*a-o*i*h+t*s*h)*T,this}scale(e){const t=this.elements,i=e.x,n=e.y,r=e.z;return t[0]*=i,t[4]*=n,t[8]*=r,t[1]*=i,t[5]*=n,t[9]*=r,t[2]*=i,t[6]*=n,t[10]*=r,t[3]*=i,t[7]*=n,t[11]*=r,this}getMaxScaleOnAxis(){const e=this.elements;return Math.sqrt(Math.max(e[0]*e[0]+e[1]*e[1]+e[2]*e[2],e[4]*e[4]+e[5]*e[5]+e[6]*e[6],e[8]*e[8]+e[9]*e[9]+e[10]*e[10]))}makeTranslation(e,t,i){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),n=Math.sin(t),r=1-i,o=e.x,s=e.y,a=e.z,l=r*o,c=r*s;return this.set(l*o+i,l*s-n*a,l*a+n*s,0,l*s+n*a,c*s+i,c*a-n*o,0,l*a-n*s,c*a+n*o,r*a*a+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,n,r,o){return this.set(1,i,r,0,e,1,o,0,t,n,1,0,0,0,0,1),this}compose(e,t,i){const n=this.elements,r=t._x,o=t._y,s=t._z,a=t._w,l=r+r,c=o+o,u=s+s,h=r*l,d=r*c,p=r*u,f=o*c,m=o*u,g=s*u,_=a*l,y=a*c,v=a*u,x=i.x,b=i.y,T=i.z;return n[0]=(1-(f+g))*x,n[1]=(d+v)*x,n[2]=(p-y)*x,n[3]=0,n[4]=(d-v)*b,n[5]=(1-(h+g))*b,n[6]=(m+_)*b,n[7]=0,n[8]=(p+y)*T,n[9]=(m-_)*T,n[10]=(1-(h+f))*T,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this}decompose(e,t,i){const n=this.elements;if(e.x=n[12],e.y=n[13],e.z=n[14],0===this.determinant())return i.set(1,1,1),t.identity(),this;let r=_v1$5.set(n[0],n[1],n[2]).length();const o=_v1$5.set(n[4],n[5],n[6]).length(),s=_v1$5.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),_m1$2.copy(this);const a=1/r,l=1/o,c=1/s;return _m1$2.elements[0]*=a,_m1$2.elements[1]*=a,_m1$2.elements[2]*=a,_m1$2.elements[4]*=l,_m1$2.elements[5]*=l,_m1$2.elements[6]*=l,_m1$2.elements[8]*=c,_m1$2.elements[9]*=c,_m1$2.elements[10]*=c,t.setFromRotationMatrix(_m1$2),i.x=r,i.y=o,i.z=s,this}makePerspective(e,t,i,n,r,o,s=WebGLCoordinateSystem,a=!1){const l=this.elements,c=2*r/(t-e),u=2*r/(i-n),h=(t+e)/(t-e),d=(i+n)/(i-n);let p,f;if(a)p=r/(o-r),f=o*r/(o-r);else if(s===WebGLCoordinateSystem)p=-(o+r)/(o-r),f=-2*o*r/(o-r);else{if(s!==WebGPUCoordinateSystem)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+s);p=-o/(o-r),f=-o*r/(o-r)}return l[0]=c,l[4]=0,l[8]=h,l[12]=0,l[1]=0,l[5]=u,l[9]=d,l[13]=0,l[2]=0,l[6]=0,l[10]=p,l[14]=f,l[3]=0,l[7]=0,l[11]=-1,l[15]=0,this}makeOrthographic(e,t,i,n,r,o,s=WebGLCoordinateSystem,a=!1){const l=this.elements,c=2/(t-e),u=2/(i-n),h=-(t+e)/(t-e),d=-(i+n)/(i-n);let p,f;if(a)p=1/(o-r),f=o/(o-r);else if(s===WebGLCoordinateSystem)p=-2/(o-r),f=-(o+r)/(o-r);else{if(s!==WebGPUCoordinateSystem)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+s);p=-1/(o-r),f=-r/(o-r)}return l[0]=c,l[4]=0,l[8]=0,l[12]=h,l[1]=0,l[5]=u,l[9]=0,l[13]=d,l[2]=0,l[6]=0,l[10]=p,l[14]=f,l[3]=0,l[7]=0,l[11]=0,l[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let e=0;e<16;e++)if(t[e]!==i[e])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}const _v1$5=new Vector3,_m1$2=new Matrix4,_zero=new Vector3(0,0,0),_one=new Vector3(1,1,1),_x=new Vector3,_y=new Vector3,_z=new Vector3,_matrix$2=new Matrix4,_quaternion$3=new Quaternion;class Euler{constructor(e=0,t=0,i=0,n=Euler.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=i,this._order=n}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,n=this._order){return this._x=e,this._y=t,this._z=i,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,i=!0){const n=e.elements,r=n[0],o=n[4],s=n[8],a=n[1],l=n[5],c=n[9],u=n[2],h=n[6],d=n[10];switch(t){case"XYZ":this._y=Math.asin(clamp(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-o,r)):(this._x=Math.atan2(h,l),this._z=0);break;case"YXZ":this._x=Math.asin(-clamp(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(s,d),this._z=Math.atan2(a,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(clamp(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(a,r));break;case"ZYX":this._y=Math.asin(-clamp(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(h,d),this._z=Math.atan2(a,r)):(this._x=0,this._z=Math.atan2(-o,l));break;case"YZX":this._z=Math.asin(clamp(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(s,d));break;case"XZY":this._z=Math.asin(-clamp(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(h,l),this._y=Math.atan2(s,r)):(this._x=Math.atan2(-c,d),this._y=0);break;default:warn("Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===i&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return _matrix$2.makeRotationFromQuaternion(e),this.setFromRotationMatrix(_matrix$2,t,i)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return _quaternion$3.setFromEuler(this),this.setFromQuaternion(_quaternion$3,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Euler.DEFAULT_ORDER="XYZ";class Layers{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return!!(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}}let _object3DId=0;const _v1$4=new Vector3,_q1=new Quaternion,_m1$1$1=new Matrix4,_target=new Vector3,_position$3=new Vector3,_scale$2=new Vector3,_quaternion$2=new Quaternion,_xAxis=new Vector3(1,0,0),_yAxis=new Vector3(0,1,0),_zAxis=new Vector3(0,0,1),_addedEvent={type:"added"},_removedEvent={type:"removed"},_childaddedEvent={type:"childadded",child:null},_childremovedEvent={type:"childremoved",child:null};class Object3D extends EventDispatcher{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:_object3DId++}),this.uuid=generateUUID$1(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Object3D.DEFAULT_UP.clone();const e=new Vector3,t=new Euler,i=new Quaternion,n=new Vector3(1,1,1);t._onChange((function(){i.setFromEuler(t,!1)})),i._onChange((function(){t.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new Matrix4},normalMatrix:{value:new Matrix3}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=Object3D.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Object3D.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Layers,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return _q1.setFromAxisAngle(e,t),this.quaternion.multiply(_q1),this}rotateOnWorldAxis(e,t){return _q1.setFromAxisAngle(e,t),this.quaternion.premultiply(_q1),this}rotateX(e){return this.rotateOnAxis(_xAxis,e)}rotateY(e){return this.rotateOnAxis(_yAxis,e)}rotateZ(e){return this.rotateOnAxis(_zAxis,e)}translateOnAxis(e,t){return _v1$4.copy(e).applyQuaternion(this.quaternion),this.position.add(_v1$4.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(_xAxis,e)}translateY(e){return this.translateOnAxis(_yAxis,e)}translateZ(e){return this.translateOnAxis(_zAxis,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(_m1$1$1.copy(this.matrixWorld).invert())}lookAt(e,t,i){e.isVector3?_target.copy(e):_target.set(e,t,i);const n=this.parent;this.updateWorldMatrix(!0,!1),_position$3.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?_m1$1$1.lookAt(_position$3,_target,this.up):_m1$1$1.lookAt(_target,_position$3,this.up),this.quaternion.setFromRotationMatrix(_m1$1$1),n&&(_m1$1$1.extractRotation(n.matrixWorld),_q1.setFromRotationMatrix(_m1$1$1),this.quaternion.premultiply(_q1.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(error("Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(_addedEvent),_childaddedEvent.child=e,this.dispatchEvent(_childaddedEvent),_childaddedEvent.child=null):error("Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(_removedEvent),_childremovedEvent.child=e,this.dispatchEvent(_childremovedEvent),_childremovedEvent.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),_m1$1$1.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),_m1$1$1.multiply(e.parent.matrixWorld)),e.applyMatrix4(_m1$1$1),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(_addedEvent),_childaddedEvent.child=e,this.dispatchEvent(_childaddedEvent),_childaddedEvent.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(e,t);if(void 0!==n)return n}}getObjectsByProperty(e,t,i=[]){this[e]===t&&i.push(this);const n=this.children;for(let r=0,o=n.length;r<o;r++)n[r].getObjectsByProperty(e,t,i);return i}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(_position$3,e,_scale$2),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(_position$3,_quaternion$2,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,n=t.length;i<n;i++){t[i].updateMatrixWorld(e)}}updateWorldMatrix(e,t){const i=this.parent;if(!0===e&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,i=e.length;t<i;t++){e[t].updateWorldMatrix(!1,!0)}}}toJSON(e){const t=void 0===e||"string"==typeof e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const n={};function r(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),n.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(n.type="BatchedMesh",n.perObjectFrustumCulled=this.perObjectFrustumCulled,n.sortObjects=this.sortObjects,n.drawRanges=this._drawRanges,n.reservedRanges=this._reservedRanges,n.geometryInfo=this._geometryInfo.map((e=>({...e,boundingBox:e.boundingBox?e.boundingBox.toJSON():void 0,boundingSphere:e.boundingSphere?e.boundingSphere.toJSON():void 0}))),n.instanceInfo=this._instanceInfo.map((e=>({...e}))),n.availableInstanceIds=this._availableInstanceIds.slice(),n.availableGeometryIds=this._availableGeometryIds.slice(),n.nextIndexStart=this._nextIndexStart,n.nextVertexStart=this._nextVertexStart,n.geometryCount=this._geometryCount,n.maxInstanceCount=this._maxInstanceCount,n.maxVertexCount=this._maxVertexCount,n.maxIndexCount=this._maxIndexCount,n.geometryInitialized=this._geometryInitialized,n.matricesTexture=this._matricesTexture.toJSON(e),n.indirectTexture=this._indirectTexture.toJSON(e),null!==this._colorsTexture&&(n.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(n.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(n.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(n.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=r(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const i=t.shapes;if(Array.isArray(i))for(let t=0,n=i.length;t<n;t++){r(e.shapes,i[t])}else r(e.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(e.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let i=0,n=this.material.length;i<n;i++)t.push(r(e.materials,this.material[i]));n.material=t}else n.material=r(e.materials,this.material);if(this.children.length>0){n.children=[];for(let t=0;t<this.children.length;t++)n.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){n.animations=[];for(let t=0;t<this.animations.length;t++){n.animations.push(r(e.animations,this.animations[t]))}}if(t){const t=o(e.geometries),n=o(e.materials),r=o(e.textures),s=o(e.images),a=o(e.shapes),l=o(e.skeletons),c=o(e.animations),u=o(e.nodes);t.length>0&&(i.geometries=t),n.length>0&&(i.materials=n),r.length>0&&(i.textures=r),s.length>0&&(i.images=s),a.length>0&&(i.shapes=a),l.length>0&&(i.skeletons=l),c.length>0&&(i.animations=c),u.length>0&&(i.nodes=u)}return i.object=n,i;function o(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){this.add(e.children[t].clone())}return this}}Object3D.DEFAULT_UP=new Vector3(0,1,0),Object3D.DEFAULT_MATRIX_AUTO_UPDATE=!0,Object3D.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const _v0$1=new Vector3,_v1$3=new Vector3,_v2$2=new Vector3,_v3$2=new Vector3,_vab=new Vector3,_vac=new Vector3,_vbc=new Vector3,_vap=new Vector3,_vbp=new Vector3,_vcp=new Vector3,_v40=new Vector4,_v41=new Vector4,_v42=new Vector4;class Triangle{constructor(e=new Vector3,t=new Vector3,i=new Vector3){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,n){n.subVectors(i,t),_v0$1.subVectors(e,t),n.cross(_v0$1);const r=n.lengthSq();return r>0?n.multiplyScalar(1/Math.sqrt(r)):n.set(0,0,0)}static getBarycoord(e,t,i,n,r){_v0$1.subVectors(n,t),_v1$3.subVectors(i,t),_v2$2.subVectors(e,t);const o=_v0$1.dot(_v0$1),s=_v0$1.dot(_v1$3),a=_v0$1.dot(_v2$2),l=_v1$3.dot(_v1$3),c=_v1$3.dot(_v2$2),u=o*l-s*s;if(0===u)return r.set(0,0,0),null;const h=1/u,d=(l*a-s*c)*h,p=(o*c-s*a)*h;return r.set(1-d-p,p,d)}static containsPoint(e,t,i,n){return null!==this.getBarycoord(e,t,i,n,_v3$2)&&(_v3$2.x>=0&&_v3$2.y>=0&&_v3$2.x+_v3$2.y<=1)}static getInterpolation(e,t,i,n,r,o,s,a){return null===this.getBarycoord(e,t,i,n,_v3$2)?(a.x=0,a.y=0,"z"in a&&(a.z=0),"w"in a&&(a.w=0),null):(a.setScalar(0),a.addScaledVector(r,_v3$2.x),a.addScaledVector(o,_v3$2.y),a.addScaledVector(s,_v3$2.z),a)}static getInterpolatedAttribute(e,t,i,n,r,o){return _v40.setScalar(0),_v41.setScalar(0),_v42.setScalar(0),_v40.fromBufferAttribute(e,t),_v41.fromBufferAttribute(e,i),_v42.fromBufferAttribute(e,n),o.setScalar(0),o.addScaledVector(_v40,r.x),o.addScaledVector(_v41,r.y),o.addScaledVector(_v42,r.z),o}static isFrontFacing(e,t,i,n){return _v0$1.subVectors(i,t),_v1$3.subVectors(e,t),_v0$1.cross(_v1$3).dot(n)<0}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,n){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[n]),this}setFromAttributeAndIndices(e,t,i,n){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,i),this.c.fromBufferAttribute(e,n),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return _v0$1.subVectors(this.c,this.b),_v1$3.subVectors(this.a,this.b),.5*_v0$1.cross(_v1$3).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Triangle.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Triangle.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,i,n,r){return Triangle.getInterpolation(e,this.a,this.b,this.c,t,i,n,r)}containsPoint(e){return Triangle.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Triangle.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const i=this.a,n=this.b,r=this.c;let o,s;_vab.subVectors(n,i),_vac.subVectors(r,i),_vap.subVectors(e,i);const a=_vab.dot(_vap),l=_vac.dot(_vap);if(a<=0&&l<=0)return t.copy(i);_vbp.subVectors(e,n);const c=_vab.dot(_vbp),u=_vac.dot(_vbp);if(c>=0&&u<=c)return t.copy(n);const h=a*u-c*l;if(h<=0&&a>=0&&c<=0)return o=a/(a-c),t.copy(i).addScaledVector(_vab,o);_vcp.subVectors(e,r);const d=_vab.dot(_vcp),p=_vac.dot(_vcp);if(p>=0&&d<=p)return t.copy(r);const f=d*l-a*p;if(f<=0&&l>=0&&p<=0)return s=l/(l-p),t.copy(i).addScaledVector(_vac,s);const m=c*p-d*u;if(m<=0&&u-c>=0&&d-p>=0)return _vbc.subVectors(r,n),s=(u-c)/(u-c+(d-p)),t.copy(n).addScaledVector(_vbc,s);const g=1/(m+f+h);return o=f*g,s=h*g,t.copy(i).addScaledVector(_vab,o).addScaledVector(_vac,s)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const _colorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},_hslA={h:0,s:0,l:0},_hslB={h:0,s:0,l:0};function hue2rgb(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}class Color{constructor(e,t,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,i)}set(e,t,i){if(void 0===t&&void 0===i){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,i);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=SRGBColorSpace){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,ColorManagement.colorSpaceToWorking(this,t),this}setRGB(e,t,i,n=ColorManagement.workingColorSpace){return this.r=e,this.g=t,this.b=i,ColorManagement.colorSpaceToWorking(this,n),this}setHSL(e,t,i,n=ColorManagement.workingColorSpace){if(e=euclideanModulo(e,1),t=clamp(t,0,1),i=clamp(i,0,1),0===t)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+t):i+t-i*t,r=2*i-n;this.r=hue2rgb(r,n,e+1/3),this.g=hue2rgb(r,n,e),this.b=hue2rgb(r,n,e-1/3)}return ColorManagement.colorSpaceToWorking(this,n),this}setStyle(e,t=SRGBColorSpace){function i(t){void 0!==t&&parseFloat(t)<1&&warn("Color: Alpha component of "+e+" will be ignored.")}let n;if(n=/^(\w+)\(([^\)]*)\)/.exec(e)){let r;const o=n[2];switch(n[1]){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,t);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,t);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,t);break;default:warn("Color: Unknown color model "+e)}}else if(n=/^\#([A-Fa-f\d]+)$/.exec(e)){const i=n[1],r=i.length;if(3===r)return this.setRGB(parseInt(i.charAt(0),16)/15,parseInt(i.charAt(1),16)/15,parseInt(i.charAt(2),16)/15,t);if(6===r)return this.setHex(parseInt(i,16),t);warn("Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=SRGBColorSpace){const i=_colorKeywords[e.toLowerCase()];return void 0!==i?this.setHex(i,t):warn("Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=SRGBToLinear(e.r),this.g=SRGBToLinear(e.g),this.b=SRGBToLinear(e.b),this}copyLinearToSRGB(e){return this.r=LinearToSRGB(e.r),this.g=LinearToSRGB(e.g),this.b=LinearToSRGB(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=SRGBColorSpace){return ColorManagement.workingToColorSpace(_color.copy(this),e),65536*Math.round(clamp(255*_color.r,0,255))+256*Math.round(clamp(255*_color.g,0,255))+Math.round(clamp(255*_color.b,0,255))}getHexString(e=SRGBColorSpace){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=ColorManagement.workingColorSpace){ColorManagement.workingToColorSpace(_color.copy(this),t);const i=_color.r,n=_color.g,r=_color.b,o=Math.max(i,n,r),s=Math.min(i,n,r);let a,l;const c=(s+o)/2;if(s===o)a=0,l=0;else{const e=o-s;switch(l=c<=.5?e/(o+s):e/(2-o-s),o){case i:a=(n-r)/e+(n<r?6:0);break;case n:a=(r-i)/e+2;break;case r:a=(i-n)/e+4}a/=6}return e.h=a,e.s=l,e.l=c,e}getRGB(e,t=ColorManagement.workingColorSpace){return ColorManagement.workingToColorSpace(_color.copy(this),t),e.r=_color.r,e.g=_color.g,e.b=_color.b,e}getStyle(e=SRGBColorSpace){ColorManagement.workingToColorSpace(_color.copy(this),e);const t=_color.r,i=_color.g,n=_color.b;return e!==SRGBColorSpace?`color(${e} ${t.toFixed(3)} ${i.toFixed(3)} ${n.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*i)},${Math.round(255*n)})`}offsetHSL(e,t,i){return this.getHSL(_hslA),this.setHSL(_hslA.h+e,_hslA.s+t,_hslA.l+i)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(_hslA),e.getHSL(_hslB);const i=lerp(_hslA.h,_hslB.h,t),n=lerp(_hslA.s,_hslB.s,t),r=lerp(_hslA.l,_hslB.l,t);return this.setHSL(i,n,r),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,i=this.g,n=this.b,r=e.elements;return this.r=r[0]*t+r[3]*i+r[6]*n,this.g=r[1]*t+r[4]*i+r[7]*n,this.b=r[2]*t+r[5]*i+r[8]*n,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const _color=new Color;Color.NAMES=_colorKeywords;let _materialId=0;class Material extends EventDispatcher{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:_materialId++}),this.uuid=generateUUID$1(),this.name="",this.type="Material",this.blending=NormalBlending,this.side=FrontSide,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=SrcAlphaFactor,this.blendDst=OneMinusSrcAlphaFactor,this.blendEquation=AddEquation,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Color(0,0,0),this.blendAlpha=0,this.depthFunc=LessEqualDepth,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=AlwaysStencilFunc,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=KeepStencilOp,this.stencilZFail=KeepStencilOp,this.stencilZPass=KeepStencilOp,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i){warn(`Material: parameter '${t}' has value of undefined.`);continue}const n=this[t];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[t]=i:warn(`Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const i={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function n(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.sheenColorMap&&this.sheenColorMap.isTexture&&(i.sheenColorMap=this.sheenColorMap.toJSON(e).uuid),this.sheenRoughnessMap&&this.sheenRoughnessMap.isTexture&&(i.sheenRoughnessMap=this.sheenRoughnessMap.toJSON(e).uuid),void 0!==this.dispersion&&(i.dispersion=this.dispersion),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapRotation&&(i.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==NormalBlending&&(i.blending=this.blending),this.side!==FrontSide&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),this.blendSrc!==SrcAlphaFactor&&(i.blendSrc=this.blendSrc),this.blendDst!==OneMinusSrcAlphaFactor&&(i.blendDst=this.blendDst),this.blendEquation!==AddEquation&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),this.depthFunc!==LessEqualDepth&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==AlwaysStencilFunc&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==KeepStencilOp&&(i.stencilFail=this.stencilFail),this.stencilZFail!==KeepStencilOp&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==KeepStencilOp&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!1===this.allowOverride&&(i.allowOverride=!1),!0===this.wireframe&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),t){const t=n(e.textures),r=n(e.images);t.length>0&&(i.textures=t),r.length>0&&(i.images=r)}return i}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(null!==t){const e=t.length;i=new Array(e);for(let n=0;n!==e;++n)i[n]=t[n].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.allowOverride=e.allowOverride,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class MeshBasicMaterial extends Material{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Euler,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const _tables=_generateTables();function _generateTables(){const e=new ArrayBuffer(4),t=new Float32Array(e),i=new Uint32Array(e),n=new Uint32Array(512),r=new Uint32Array(512);for(let e=0;e<256;++e){const t=e-127;t<-27?(n[e]=0,n[256|e]=32768,r[e]=24,r[256|e]=24):t<-14?(n[e]=1024>>-t-14,n[256|e]=1024>>-t-14|32768,r[e]=-t-1,r[256|e]=-t-1):t<=15?(n[e]=t+15<<10,n[256|e]=t+15<<10|32768,r[e]=13,r[256|e]=13):t<128?(n[e]=31744,n[256|e]=64512,r[e]=24,r[256|e]=24):(n[e]=31744,n[256|e]=64512,r[e]=13,r[256|e]=13)}const o=new Uint32Array(2048),s=new Uint32Array(64),a=new Uint32Array(64);for(let e=1;e<1024;++e){let t=e<<13,i=0;for(;!(8388608&t);)t<<=1,i-=8388608;t&=-8388609,i+=947912704,o[e]=t|i}for(let e=1024;e<2048;++e)o[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)s[e]=e<<23;s[31]=1199570944,s[32]=2147483648;for(let e=33;e<63;++e)s[e]=2147483648+(e-32<<23);s[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(a[e]=1024);return{floatView:t,uint32View:i,baseTable:n,shiftTable:r,mantissaTable:o,exponentTable:s,offsetTable:a}}function toHalfFloat(e){Math.abs(e)>65504&&warn("DataUtils.toHalfFloat(): Value out of range."),e=clamp(e,-65504,65504),_tables.floatView[0]=e;const t=_tables.uint32View[0],i=t>>23&511;return _tables.baseTable[i]+((8388607&t)>>_tables.shiftTable[i])}function fromHalfFloat(e){const t=e>>10;return _tables.uint32View[0]=_tables.mantissaTable[_tables.offsetTable[t]+(1023&e)]+_tables.exponentTable[t],_tables.floatView[0]}class DataUtils{static toHalfFloat(e){return toHalfFloat(e)}static fromHalfFloat(e){return fromHalfFloat(e)}}const _vector$9=new Vector3,_vector2$1=new Vector2;let _id$2=0;class BufferAttribute{constructor(e,t,i=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:_id$2++}),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=i,this.usage=StaticDrawUsage,this.updateRanges=[],this.gpuType=FloatType,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let n=0,r=this.itemSize;n<r;n++)this.array[e+n]=t.array[i+n];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,i=this.count;t<i;t++)_vector2$1.fromBufferAttribute(this,t),_vector2$1.applyMatrix3(e),this.setXY(t,_vector2$1.x,_vector2$1.y);else if(3===this.itemSize)for(let t=0,i=this.count;t<i;t++)_vector$9.fromBufferAttribute(this,t),_vector$9.applyMatrix3(e),this.setXYZ(t,_vector$9.x,_vector$9.y,_vector$9.z);return this}applyMatrix4(e){for(let t=0,i=this.count;t<i;t++)_vector$9.fromBufferAttribute(this,t),_vector$9.applyMatrix4(e),this.setXYZ(t,_vector$9.x,_vector$9.y,_vector$9.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)_vector$9.fromBufferAttribute(this,t),_vector$9.applyNormalMatrix(e),this.setXYZ(t,_vector$9.x,_vector$9.y,_vector$9.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)_vector$9.fromBufferAttribute(this,t),_vector$9.transformDirection(e),this.setXYZ(t,_vector$9.x,_vector$9.y,_vector$9.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let i=this.array[e*this.itemSize+t];return this.normalized&&(i=denormalize(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=normalize(i,this.array)),this.array[e*this.itemSize+t]=i,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=denormalize(t,this.array)),t}setX(e,t){return this.normalized&&(t=normalize(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=denormalize(t,this.array)),t}setY(e,t){return this.normalized&&(t=normalize(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=denormalize(t,this.array)),t}setZ(e,t){return this.normalized&&(t=normalize(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=denormalize(t,this.array)),t}setW(e,t){return this.normalized&&(t=normalize(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array)),this.array[e+0]=t,this.array[e+1]=i,this}setXYZ(e,t,i,n){return e*=this.itemSize,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array),n=normalize(n,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this}setXYZW(e,t,i,n,r){return e*=this.itemSize,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array),n=normalize(n,this.array),r=normalize(r,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this.array[e+3]=r,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==StaticDrawUsage&&(e.usage=this.usage),e}}class Int8BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Int8Array(e),t,i)}}class Uint8BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Uint8Array(e),t,i)}}class Uint8ClampedBufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Uint8ClampedArray(e),t,i)}}class Int16BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Int16Array(e),t,i)}}class Uint16BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Uint16Array(e),t,i)}}class Int32BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Int32Array(e),t,i)}}class Uint32BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Uint32Array(e),t,i)}}class Float16BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Uint16Array(e),t,i),this.isFloat16BufferAttribute=!0}getX(e){let t=fromHalfFloat(this.array[e*this.itemSize]);return this.normalized&&(t=denormalize(t,this.array)),t}setX(e,t){return this.normalized&&(t=normalize(t,this.array)),this.array[e*this.itemSize]=toHalfFloat(t),this}getY(e){let t=fromHalfFloat(this.array[e*this.itemSize+1]);return this.normalized&&(t=denormalize(t,this.array)),t}setY(e,t){return this.normalized&&(t=normalize(t,this.array)),this.array[e*this.itemSize+1]=toHalfFloat(t),this}getZ(e){let t=fromHalfFloat(this.array[e*this.itemSize+2]);return this.normalized&&(t=denormalize(t,this.array)),t}setZ(e,t){return this.normalized&&(t=normalize(t,this.array)),this.array[e*this.itemSize+2]=toHalfFloat(t),this}getW(e){let t=fromHalfFloat(this.array[e*this.itemSize+3]);return this.normalized&&(t=denormalize(t,this.array)),t}setW(e,t){return this.normalized&&(t=normalize(t,this.array)),this.array[e*this.itemSize+3]=toHalfFloat(t),this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array)),this.array[e+0]=toHalfFloat(t),this.array[e+1]=toHalfFloat(i),this}setXYZ(e,t,i,n){return e*=this.itemSize,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array),n=normalize(n,this.array)),this.array[e+0]=toHalfFloat(t),this.array[e+1]=toHalfFloat(i),this.array[e+2]=toHalfFloat(n),this}setXYZW(e,t,i,n,r){return e*=this.itemSize,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array),n=normalize(n,this.array),r=normalize(r,this.array)),this.array[e+0]=toHalfFloat(t),this.array[e+1]=toHalfFloat(i),this.array[e+2]=toHalfFloat(n),this.array[e+3]=toHalfFloat(r),this}}class Float32BufferAttribute extends BufferAttribute{constructor(e,t,i){super(new Float32Array(e),t,i)}}let _id$1=0;const _m1$3=new Matrix4,_obj=new Object3D,_offset=new Vector3,_box$2=new Box3,_boxMorphTargets=new Box3,_vector$8=new Vector3;class BufferGeometry extends EventDispatcher{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:_id$1++}),this.uuid=generateUUID$1(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.indirectOffset=0,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return this.index=Array.isArray(e)?new(arrayNeedsUint32(e)?Uint32BufferAttribute:Uint16BufferAttribute)(e,1):e,this}setIndirect(e,t=0){return this.indirect=e,this.indirectOffset=t,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const t=(new Matrix3).getNormalMatrix(e);i.applyNormalMatrix(t),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(e),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return _m1$3.makeRotationFromQuaternion(e),this.applyMatrix4(_m1$3),this}rotateX(e){return _m1$3.makeRotationX(e),this.applyMatrix4(_m1$3),this}rotateY(e){return _m1$3.makeRotationY(e),this.applyMatrix4(_m1$3),this}rotateZ(e){return _m1$3.makeRotationZ(e),this.applyMatrix4(_m1$3),this}translate(e,t,i){return _m1$3.makeTranslation(e,t,i),this.applyMatrix4(_m1$3),this}scale(e,t,i){return _m1$3.makeScale(e,t,i),this.applyMatrix4(_m1$3),this}lookAt(e){return _obj.lookAt(e),_obj.updateMatrix(),this.applyMatrix4(_obj.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(_offset).negate(),this.translate(_offset.x,_offset.y,_offset.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let i=0,n=e.length;i<n;i++){const n=e[i];t.push(n.x,n.y,n.z||0)}this.setAttribute("position",new Float32BufferAttribute(t,3))}else{const i=Math.min(e.length,t.count);for(let n=0;n<i;n++){const i=e[n];t.setXYZ(n,i.x,i.y,i.z||0)}e.length>t.count&&warn("BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Box3);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return error("BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new Vector3(-1/0,-1/0,-1/0),new Vector3(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){_box$2.setFromBufferAttribute(t[e]),this.morphTargetsRelative?(_vector$8.addVectors(this.boundingBox.min,_box$2.min),this.boundingBox.expandByPoint(_vector$8),_vector$8.addVectors(this.boundingBox.max,_box$2.max),this.boundingBox.expandByPoint(_vector$8)):(this.boundingBox.expandByPoint(_box$2.min),this.boundingBox.expandByPoint(_box$2.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&error('BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return error("BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new Vector3,1/0);if(e){const i=this.boundingSphere.center;if(_box$2.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){_boxMorphTargets.setFromBufferAttribute(t[e]),this.morphTargetsRelative?(_vector$8.addVectors(_box$2.min,_boxMorphTargets.min),_box$2.expandByPoint(_vector$8),_vector$8.addVectors(_box$2.max,_boxMorphTargets.max),_box$2.expandByPoint(_vector$8)):(_box$2.expandByPoint(_boxMorphTargets.min),_box$2.expandByPoint(_boxMorphTargets.max))}_box$2.getCenter(i);let n=0;for(let t=0,r=e.count;t<r;t++)_vector$8.fromBufferAttribute(e,t),n=Math.max(n,i.distanceToSquared(_vector$8));if(t)for(let r=0,o=t.length;r<o;r++){const o=t[r],s=this.morphTargetsRelative;for(let t=0,r=o.count;t<r;t++)_vector$8.fromBufferAttribute(o,t),s&&(_offset.fromBufferAttribute(e,t),_vector$8.add(_offset)),n=Math.max(n,i.distanceToSquared(_vector$8))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&error('BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void error("BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const i=t.position,n=t.normal,r=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new BufferAttribute(new Float32Array(4*i.count),4));const o=this.getAttribute("tangent"),s=[],a=[];for(let e=0;e<i.count;e++)s[e]=new Vector3,a[e]=new Vector3;const l=new Vector3,c=new Vector3,u=new Vector3,h=new Vector2,d=new Vector2,p=new Vector2,f=new Vector3,m=new Vector3;function g(e,t,n){l.fromBufferAttribute(i,e),c.fromBufferAttribute(i,t),u.fromBufferAttribute(i,n),h.fromBufferAttribute(r,e),d.fromBufferAttribute(r,t),p.fromBufferAttribute(r,n),c.sub(l),u.sub(l),d.sub(h),p.sub(h);const o=1/(d.x*p.y-p.x*d.y);isFinite(o)&&(f.copy(c).multiplyScalar(p.y).addScaledVector(u,-d.y).multiplyScalar(o),m.copy(u).multiplyScalar(d.x).addScaledVector(c,-p.x).multiplyScalar(o),s[e].add(f),s[t].add(f),s[n].add(f),a[e].add(m),a[t].add(m),a[n].add(m))}let _=this.groups;0===_.length&&(_=[{start:0,count:e.count}]);for(let t=0,i=_.length;t<i;++t){const i=_[t],n=i.start;for(let t=n,r=n+i.count;t<r;t+=3)g(e.getX(t+0),e.getX(t+1),e.getX(t+2))}const y=new Vector3,v=new Vector3,x=new Vector3,b=new Vector3;function T(e){x.fromBufferAttribute(n,e),b.copy(x);const t=s[e];y.copy(t),y.sub(x.multiplyScalar(x.dot(t))).normalize(),v.crossVectors(b,t);const i=v.dot(a[e]);o.setXYZW(e,y.x,y.y,y.z,i<0?-1:1)}for(let t=0,i=_.length;t<i;++t){const i=_[t],n=i.start;for(let t=n,r=n+i.count;t<r;t+=3)T(e.getX(t+0)),T(e.getX(t+1)),T(e.getX(t+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let i=this.getAttribute("normal");if(void 0===i)i=new BufferAttribute(new Float32Array(3*t.count),3),this.setAttribute("normal",i);else for(let e=0,t=i.count;e<t;e++)i.setXYZ(e,0,0,0);const n=new Vector3,r=new Vector3,o=new Vector3,s=new Vector3,a=new Vector3,l=new Vector3,c=new Vector3,u=new Vector3;if(e)for(let h=0,d=e.count;h<d;h+=3){const d=e.getX(h+0),p=e.getX(h+1),f=e.getX(h+2);n.fromBufferAttribute(t,d),r.fromBufferAttribute(t,p),o.fromBufferAttribute(t,f),c.subVectors(o,r),u.subVectors(n,r),c.cross(u),s.fromBufferAttribute(i,d),a.fromBufferAttribute(i,p),l.fromBufferAttribute(i,f),s.add(c),a.add(c),l.add(c),i.setXYZ(d,s.x,s.y,s.z),i.setXYZ(p,a.x,a.y,a.z),i.setXYZ(f,l.x,l.y,l.z)}else for(let e=0,s=t.count;e<s;e+=3)n.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),o.fromBufferAttribute(t,e+2),c.subVectors(o,r),u.subVectors(n,r),c.cross(u),i.setXYZ(e+0,c.x,c.y,c.z),i.setXYZ(e+1,c.x,c.y,c.z),i.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)_vector$8.fromBufferAttribute(e,t),_vector$8.normalize(),e.setXYZ(t,_vector$8.x,_vector$8.y,_vector$8.z)}toNonIndexed(){function e(e,t){const i=e.array,n=e.itemSize,r=e.normalized,o=new i.constructor(t.length*n);let s=0,a=0;for(let r=0,l=t.length;r<l;r++){s=e.isInterleavedBufferAttribute?t[r]*e.data.stride+e.offset:t[r]*n;for(let e=0;e<n;e++)o[a++]=i[s++]}return new BufferAttribute(o,n,r)}if(null===this.index)return warn("BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new BufferGeometry,i=this.index.array,n=this.attributes;for(const r in n){const o=e(n[r],i);t.setAttribute(r,o)}const r=this.morphAttributes;for(const n in r){const o=[],s=r[n];for(let t=0,n=s.length;t<n;t++){const n=e(s[t],i);o.push(n)}t.morphAttributes[n]=o}t.morphTargetsRelative=this.morphTargetsRelative;const o=this.groups;for(let e=0,i=o.length;e<i;e++){const i=o[e];t.addGroup(i.start,i.count,i.materialIndex)}return t}toJSON(){const e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const t in i){e.data.attributes[t]=i[t].toJSON(e.data)}const n={};let r=!1;for(const t in this.morphAttributes){const i=this.morphAttributes[t],o=[];for(let t=0,n=i.length;t<n;t++){o.push(i[t].toJSON(e.data))}o.length>0&&(n[t]=o,r=!0)}r&&(e.data.morphAttributes=n,e.data.morphTargetsRelative=this.morphTargetsRelative);const o=this.groups;o.length>0&&(e.data.groups=JSON.parse(JSON.stringify(o)));const s=this.boundingSphere;return null!==s&&(e.data.boundingSphere=s.toJSON()),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;null!==i&&this.setIndex(i.clone());const n=e.attributes;for(const e in n){this.setAttribute(e,n[e].clone(t))}const r=e.morphAttributes;for(const e in r){const i=[],n=r[e];for(let e=0,r=n.length;e<r;e++)i.push(n[e].clone(t));this.morphAttributes[e]=i}this.morphTargetsRelative=e.morphTargetsRelative;const o=e.groups;for(let e=0,t=o.length;e<t;e++){const t=o[e];this.addGroup(t.start,t.count,t.materialIndex)}const s=e.boundingBox;null!==s&&(this.boundingBox=s.clone());const a=e.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const _inverseMatrix$3=new Matrix4,_ray$3=new Ray,_sphere$6=new Sphere,_sphereHitAt=new Vector3,_vA$1=new Vector3,_vB$1=new Vector3,_vC$1=new Vector3,_tempA=new Vector3,_morphA=new Vector3,_intersectionPoint=new Vector3,_intersectionPointWorld=new Vector3;class Mesh extends Object3D{constructor(e=new BufferGeometry,t=new MeshBasicMaterial){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const i=this.geometry,n=i.morphAttributes.position,r=i.morphTargetsRelative;t.fromBufferAttribute(i.attributes.position,e);const o=this.morphTargetInfluences;if(n&&o){_morphA.set(0,0,0);for(let i=0,s=n.length;i<s;i++){const s=o[i];0!==s&&(_tempA.fromBufferAttribute(n[i],e),_morphA.addScaledVector(r?_tempA:_tempA.sub(t),s))}t.add(_morphA)}return t}raycast(e,t){const i=this.geometry,n=this.matrixWorld;if(void 0!==this.material){if(null===i.boundingSphere&&i.computeBoundingSphere(),_sphere$6.copy(i.boundingSphere),_sphere$6.applyMatrix4(n),_ray$3.copy(e.ray).recast(e.near),!1===_sphere$6.containsPoint(_ray$3.origin)){if(null===_ray$3.intersectSphere(_sphere$6,_sphereHitAt))return;if(_ray$3.origin.distanceToSquared(_sphereHitAt)>(e.far-e.near)**2)return}_inverseMatrix$3.copy(n).invert(),_ray$3.copy(e.ray).applyMatrix4(_inverseMatrix$3),null!==i.boundingBox&&!1===_ray$3.intersectsBox(i.boundingBox)||this._computeIntersections(e,t,_ray$3)}}_computeIntersections(e,t,i){let n;const r=this.geometry,o=this.material,s=r.index,a=r.attributes.position,l=r.attributes.uv,c=r.attributes.uv1,u=r.attributes.normal,h=r.groups,d=r.drawRange;if(null!==s)if(Array.isArray(o))for(let r=0,a=h.length;r<a;r++){const a=h[r],p=o[a.materialIndex];for(let r=Math.max(a.start,d.start),o=Math.min(s.count,Math.min(a.start+a.count,d.start+d.count));r<o;r+=3){n=checkGeometryIntersection(this,p,e,i,l,c,u,s.getX(r),s.getX(r+1),s.getX(r+2)),n&&(n.faceIndex=Math.floor(r/3),n.face.materialIndex=a.materialIndex,t.push(n))}}else{for(let r=Math.max(0,d.start),a=Math.min(s.count,d.start+d.count);r<a;r+=3){n=checkGeometryIntersection(this,o,e,i,l,c,u,s.getX(r),s.getX(r+1),s.getX(r+2)),n&&(n.faceIndex=Math.floor(r/3),t.push(n))}}else if(void 0!==a)if(Array.isArray(o))for(let r=0,s=h.length;r<s;r++){const s=h[r],p=o[s.materialIndex];for(let r=Math.max(s.start,d.start),o=Math.min(a.count,Math.min(s.start+s.count,d.start+d.count));r<o;r+=3){n=checkGeometryIntersection(this,p,e,i,l,c,u,r,r+1,r+2),n&&(n.faceIndex=Math.floor(r/3),n.face.materialIndex=s.materialIndex,t.push(n))}}else{for(let r=Math.max(0,d.start),s=Math.min(a.count,d.start+d.count);r<s;r+=3){n=checkGeometryIntersection(this,o,e,i,l,c,u,r,r+1,r+2),n&&(n.faceIndex=Math.floor(r/3),t.push(n))}}}}function checkIntersection$1(e,t,i,n,r,o,s,a){let l;if(l=t.side===BackSide?n.intersectTriangle(s,o,r,!0,a):n.intersectTriangle(r,o,s,t.side===FrontSide,a),null===l)return null;_intersectionPointWorld.copy(a),_intersectionPointWorld.applyMatrix4(e.matrixWorld);const c=i.ray.origin.distanceTo(_intersectionPointWorld);return c<i.near||c>i.far?null:{distance:c,point:_intersectionPointWorld.clone(),object:e}}function checkGeometryIntersection(e,t,i,n,r,o,s,a,l,c){e.getVertexPosition(a,_vA$1),e.getVertexPosition(l,_vB$1),e.getVertexPosition(c,_vC$1);const u=checkIntersection$1(e,t,i,n,_vA$1,_vB$1,_vC$1,_intersectionPoint);if(u){const e=new Vector3;Triangle.getBarycoord(_intersectionPoint,_vA$1,_vB$1,_vC$1,e),r&&(u.uv=Triangle.getInterpolatedAttribute(r,a,l,c,e,new Vector2)),o&&(u.uv1=Triangle.getInterpolatedAttribute(o,a,l,c,e,new Vector2)),s&&(u.normal=Triangle.getInterpolatedAttribute(s,a,l,c,e,new Vector3),u.normal.dot(n.direction)>0&&u.normal.multiplyScalar(-1));const t={a:a,b:l,c:c,normal:new Vector3,materialIndex:0};Triangle.getNormal(_vA$1,_vB$1,_vC$1,t.normal),u.face=t,u.barycoord=e}return u}class BoxGeometry extends BufferGeometry{constructor(e=1,t=1,i=1,n=1,r=1,o=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:n,heightSegments:r,depthSegments:o};const s=this;n=Math.floor(n),r=Math.floor(r),o=Math.floor(o);const a=[],l=[],c=[],u=[];let h=0,d=0;function p(e,t,i,n,r,o,p,f,m,g,_){const y=o/m,v=p/g,x=o/2,b=p/2,T=f/2,w=m+1,E=g+1;let S=0,A=0;const M=new Vector3;for(let o=0;o<E;o++){const s=o*v-b;for(let a=0;a<w;a++){M[e]=(a*y-x)*n,M[t]=s*r,M[i]=T,l.push(M.x,M.y,M.z),M[e]=0,M[t]=0,M[i]=f>0?1:-1,c.push(M.x,M.y,M.z),u.push(a/m),u.push(1-o/g),S+=1}}for(let e=0;e<g;e++)for(let t=0;t<m;t++){const i=h+t+w*(e+1),n=h+(t+1)+w*(e+1),r=h+(t+1)+w*e;a.push(h+t+w*e,i,r),a.push(i,n,r),A+=6}s.addGroup(d,A,_),d+=A,h+=S}p("z","y","x",-1,-1,i,t,e,o,r,0),p("z","y","x",1,-1,i,t,-e,o,r,1),p("x","z","y",1,1,e,i,t,n,o,2),p("x","z","y",1,-1,e,i,-t,n,o,3),p("x","y","z",1,-1,e,t,i,n,r,4),p("x","y","z",-1,-1,e,t,-i,n,r,5),this.setIndex(a),this.setAttribute("position",new Float32BufferAttribute(l,3)),this.setAttribute("normal",new Float32BufferAttribute(c,3)),this.setAttribute("uv",new Float32BufferAttribute(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new BoxGeometry(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function cloneUniforms(e){const t={};for(const i in e){t[i]={};for(const n in e[i]){const r=e[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?(warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[i][n]=null):t[i][n]=r.clone():t[i][n]=Array.isArray(r)?r.slice():r}}return t}function mergeUniforms(e){const t={};for(let i=0;i<e.length;i++){const n=cloneUniforms(e[i]);for(const e in n)t[e]=n[e]}return t}function cloneUniformsGroups(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].clone());return t}function getUnlitUniformColorSpace(e){const t=e.getRenderTarget();return null===t?e.outputColorSpace:!0===t.isXRRenderTarget?t.texture.colorSpace:ColorManagement.workingColorSpace}const UniformsUtils={clone:cloneUniforms,merge:mergeUniforms};var default_vertex="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",default_fragment="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}";class ShaderMaterial extends Material{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=default_vertex,this.fragmentShader=default_fragment,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=cloneUniforms(e.uniforms),this.uniformsGroups=cloneUniformsGroups(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this.defaultAttributeValues=Object.assign({},e.defaultAttributeValues),this.index0AttributeName=e.index0AttributeName,this.uniformsNeedUpdate=e.uniformsNeedUpdate,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;t.uniforms[i]=n&&n.isTexture?{type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?{type:"c",value:n.getHex()}:n&&n.isVector2?{type:"v2",value:n.toArray()}:n&&n.isVector3?{type:"v3",value:n.toArray()}:n&&n.isVector4?{type:"v4",value:n.toArray()}:n&&n.isMatrix3?{type:"m3",value:n.toArray()}:n&&n.isMatrix4?{type:"m4",value:n.toArray()}:{value:n}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const i={};for(const e in this.extensions)!0===this.extensions[e]&&(i[e]=!0);return Object.keys(i).length>0&&(t.extensions=i),t}}class Camera extends Object3D{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4,this.projectionMatrixInverse=new Matrix4,this.coordinateSystem=WebGLCoordinateSystem,this._reversedDepth=!1}get reversedDepth(){return this._reversedDepth}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const _v3$1=new Vector3,_minTarget=new Vector2,_maxTarget=new Vector2;class PerspectiveCamera extends Camera{constructor(e=50,t=1,i=.1,n=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*RAD2DEG*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*DEG2RAD*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*RAD2DEG*Math.atan(Math.tan(.5*DEG2RAD*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,i){_v3$1.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(_v3$1.x,_v3$1.y).multiplyScalar(-e/_v3$1.z),_v3$1.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(_v3$1.x,_v3$1.y).multiplyScalar(-e/_v3$1.z)}getViewSize(e,t){return this.getViewBounds(e,_minTarget,_maxTarget),t.subVectors(_maxTarget,_minTarget)}setViewOffset(e,t,i,n,r,o){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=o,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*DEG2RAD*this.fov)/this.zoom,i=2*t,n=this.aspect*i,r=-.5*n;const o=this.view;if(null!==this.view&&this.view.enabled){const e=o.fullWidth,s=o.fullHeight;r+=o.offsetX*n/e,t-=o.offsetY*i/s,n*=o.width/e,i*=o.height/s}const s=this.filmOffset;0!==s&&(r+=e*s/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,t,t-i,e,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const fov=-90,aspect=1;class CubeCamera extends Object3D{constructor(e,t,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;const n=new PerspectiveCamera(fov,aspect,e,t);n.layers=this.layers,this.add(n);const r=new PerspectiveCamera(fov,aspect,e,t);r.layers=this.layers,this.add(r);const o=new PerspectiveCamera(fov,aspect,e,t);o.layers=this.layers,this.add(o);const s=new PerspectiveCamera(fov,aspect,e,t);s.layers=this.layers,this.add(s);const a=new PerspectiveCamera(fov,aspect,e,t);a.layers=this.layers,this.add(a);const l=new PerspectiveCamera(fov,aspect,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[i,n,r,o,s,a]=t;for(const e of t)this.remove(e);if(e===WebGLCoordinateSystem)i.up.set(0,1,0),i.lookAt(1,0,0),n.up.set(0,1,0),n.lookAt(-1,0,0),r.up.set(0,0,-1),r.lookAt(0,1,0),o.up.set(0,0,1),o.lookAt(0,-1,0),s.up.set(0,1,0),s.lookAt(0,0,1),a.up.set(0,1,0),a.lookAt(0,0,-1);else{if(e!==WebGPUCoordinateSystem)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);i.up.set(0,-1,0),i.lookAt(-1,0,0),n.up.set(0,-1,0),n.lookAt(1,0,0),r.up.set(0,0,1),r.lookAt(0,1,0),o.up.set(0,0,-1),o.lookAt(0,-1,0),s.up.set(0,-1,0),s.lookAt(0,0,1),a.up.set(0,-1,0),a.lookAt(0,0,-1)}for(const e of t)this.add(e),e.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:i,activeMipmapLevel:n}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[r,o,s,a,l,c]=this.children,u=e.getRenderTarget(),h=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;const f=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0,n),e.render(t,r),e.setRenderTarget(i,1,n),e.render(t,o),e.setRenderTarget(i,2,n),e.render(t,s),e.setRenderTarget(i,3,n),e.render(t,a),e.setRenderTarget(i,4,n),e.render(t,l),i.texture.generateMipmaps=f,e.setRenderTarget(i,5,n),e.render(t,c),e.setRenderTarget(u,h,d),e.xr.enabled=p,i.texture.needsPMREMUpdate=!0}}class CubeTexture extends Texture{constructor(e=[],t=CubeReflectionMapping,i,n,r,o,s,a,l,c){super(e,t,i,n,r,o,s,a,l,c),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class WebGLCubeRenderTarget extends WebGLRenderTarget{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const i={width:e,height:e,depth:1};this.texture=new CubeTexture([i,i,i,i,i,i]),this._setTextureOptions(t),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new BoxGeometry(5,5,5),r=new ShaderMaterial({name:"CubemapFromEquirect",uniforms:cloneUniforms(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:BackSide,blending:NoBlending});r.uniforms.tEquirect.value=t;const o=new Mesh(n,r),s=t.minFilter;t.minFilter===LinearMipmapLinearFilter&&(t.minFilter=LinearFilter);return new CubeCamera(1,10,this).update(e,o),t.minFilter=s,o.geometry.dispose(),o.material.dispose(),this}clear(e,t=!0,i=!0,n=!0){const r=e.getRenderTarget();for(let r=0;r<6;r++)e.setRenderTarget(this,r),e.clear(t,i,n);e.setRenderTarget(r)}}class Group extends Object3D{constructor(){super(),this.isGroup=!0,this.type="Group"}}const _moveEvent={type:"move"};class WebXRController{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new Group,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new Group,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Vector3,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Vector3),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new Group,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Vector3,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Vector3),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const i of e.hand.values())this._getHandJoint(t,i)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,i){let n=null,r=null,o=null;const s=this._targetRay,a=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){o=!0;for(const n of e.hand.values()){const e=t.getJointPose(n,i),r=this._getHandJoint(l,n);null!==e&&(r.matrix.fromArray(e.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.matrixWorldNeedsUpdate=!0,r.jointRadius=e.radius),r.visible=null!==e}const n=l.joints["index-finger-tip"].position.distanceTo(l.joints["thumb-tip"].position),r=.02,s=.005;l.inputState.pinching&&n>r+s?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&n<=r-s&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==a&&e.gripSpace&&(r=t.getPose(e.gripSpace,i),null!==r&&(a.matrix.fromArray(r.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,r.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(r.linearVelocity)):a.hasLinearVelocity=!1,r.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(r.angularVelocity)):a.hasAngularVelocity=!1));null!==s&&(n=t.getPose(e.targetRaySpace,i),null===n&&null!==r&&(n=r),null!==n&&(s.matrix.fromArray(n.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale),s.matrixWorldNeedsUpdate=!0,n.linearVelocity?(s.hasLinearVelocity=!0,s.linearVelocity.copy(n.linearVelocity)):s.hasLinearVelocity=!1,n.angularVelocity?(s.hasAngularVelocity=!0,s.angularVelocity.copy(n.angularVelocity)):s.hasAngularVelocity=!1,this.dispatchEvent(_moveEvent)))}return null!==s&&(s.visible=null!==n),null!==a&&(a.visible=null!==r),null!==l&&(l.visible=null!==o),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const i=new Group;i.matrixAutoUpdate=!1,i.visible=!1,e.joints[t.jointName]=i,e.add(i)}return e.joints[t.jointName]}}class FogExp2{constructor(e,t=25e-5){this.isFogExp2=!0,this.name="",this.color=new Color(e),this.density=t}clone(){return new FogExp2(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class Fog{constructor(e,t=1,i=1e3){this.isFog=!0,this.name="",this.color=new Color(e),this.near=t,this.far=i}clone(){return new Fog(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class Scene extends Object3D{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Euler,this.environmentIntensity=1,this.environmentRotation=new Euler,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class InterleavedBuffer{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=StaticDrawUsage,this.updateRanges=[],this.version=0,this.uuid=generateUUID$1()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,i){e*=this.stride,i*=t.stride;for(let n=0,r=this.stride;n<r;n++)this.array[e+n]=t.array[i+n];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=generateUUID$1()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(t,this.stride);return i.setUsage(this.usage),i}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=generateUUID$1()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const _vector$7=new Vector3;class InterleavedBufferAttribute{constructor(e,t,i,n=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=i,this.normalized=n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,i=this.data.count;t<i;t++)_vector$7.fromBufferAttribute(this,t),_vector$7.applyMatrix4(e),this.setXYZ(t,_vector$7.x,_vector$7.y,_vector$7.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)_vector$7.fromBufferAttribute(this,t),_vector$7.applyNormalMatrix(e),this.setXYZ(t,_vector$7.x,_vector$7.y,_vector$7.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)_vector$7.fromBufferAttribute(this,t),_vector$7.transformDirection(e),this.setXYZ(t,_vector$7.x,_vector$7.y,_vector$7.z);return this}getComponent(e,t){let i=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(i=denormalize(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=normalize(i,this.array)),this.data.array[e*this.data.stride+this.offset+t]=i,this}setX(e,t){return this.normalized&&(t=normalize(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=normalize(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=normalize(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=normalize(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=denormalize(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=denormalize(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=denormalize(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=denormalize(t,this.array)),t}setXY(e,t,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this}setXYZ(e,t,i,n){return e=e*this.data.stride+this.offset,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array),n=normalize(n,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this}setXYZW(e,t,i,n,r){return e=e*this.data.stride+this.offset,this.normalized&&(t=normalize(t,this.array),i=normalize(i,this.array),n=normalize(n,this.array),r=normalize(r,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this.data.array[e+3]=r,this}clone(e){if(void 0===e){log("InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return new BufferAttribute(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new InterleavedBufferAttribute(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){log("InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class SpriteMaterial extends Material{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new Color(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}let _geometry$1;const _intersectPoint=new Vector3,_worldScale=new Vector3,_mvPosition=new Vector3,_alignedPosition=new Vector2,_rotatedPosition=new Vector2,_viewWorldMatrix=new Matrix4,_vA=new Vector3,_vB=new Vector3,_vC=new Vector3,_uvA=new Vector2,_uvB=new Vector2,_uvC=new Vector2;class Sprite extends Object3D{constructor(e=new SpriteMaterial){if(super(),this.isSprite=!0,this.type="Sprite",void 0===_geometry$1){_geometry$1=new BufferGeometry;const e=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),t=new InterleavedBuffer(e,5);_geometry$1.setIndex([0,1,2,0,2,3]),_geometry$1.setAttribute("position",new InterleavedBufferAttribute(t,3,0,!1)),_geometry$1.setAttribute("uv",new InterleavedBufferAttribute(t,2,3,!1))}this.geometry=_geometry$1,this.material=e,this.center=new Vector2(.5,.5),this.count=1}raycast(e,t){null===e.camera&&error('Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),_worldScale.setFromMatrixScale(this.matrixWorld),_viewWorldMatrix.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),_mvPosition.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&_worldScale.multiplyScalar(-_mvPosition.z);const i=this.material.rotation;let n,r;0!==i&&(r=Math.cos(i),n=Math.sin(i));const o=this.center;transformVertex(_vA.set(-.5,-.5,0),_mvPosition,o,_worldScale,n,r),transformVertex(_vB.set(.5,-.5,0),_mvPosition,o,_worldScale,n,r),transformVertex(_vC.set(.5,.5,0),_mvPosition,o,_worldScale,n,r),_uvA.set(0,0),_uvB.set(1,0),_uvC.set(1,1);let s=e.ray.intersectTriangle(_vA,_vB,_vC,!1,_intersectPoint);if(null===s&&(transformVertex(_vB.set(-.5,.5,0),_mvPosition,o,_worldScale,n,r),_uvB.set(0,1),s=e.ray.intersectTriangle(_vA,_vC,_vB,!1,_intersectPoint),null===s))return;const a=e.ray.origin.distanceTo(_intersectPoint);a<e.near||a>e.far||t.push({distance:a,point:_intersectPoint.clone(),uv:Triangle.getInterpolation(_intersectPoint,_vA,_vB,_vC,_uvA,_uvB,_uvC,new Vector2),face:null,object:this})}copy(e,t){return super.copy(e,t),void 0!==e.center&&this.center.copy(e.center),this.material=e.material,this}}function transformVertex(e,t,i,n,r,o){_alignedPosition.subVectors(e,i).addScalar(.5).multiply(n),void 0!==r?(_rotatedPosition.x=o*_alignedPosition.x-r*_alignedPosition.y,_rotatedPosition.y=r*_alignedPosition.x+o*_alignedPosition.y):_rotatedPosition.copy(_alignedPosition),e.copy(t),e.x+=_rotatedPosition.x,e.y+=_rotatedPosition.y,e.applyMatrix4(_viewWorldMatrix)}const _v1$2=new Vector3,_v2$1=new Vector3;class LOD extends Object3D{constructor(){super(),this.isLOD=!0,this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}}),this.autoUpdate=!0}copy(e){super.copy(e,!1);const t=e.levels;for(let e=0,i=t.length;e<i;e++){const i=t[e];this.addLevel(i.object.clone(),i.distance,i.hysteresis)}return this.autoUpdate=e.autoUpdate,this}addLevel(e,t=0,i=0){t=Math.abs(t);const n=this.levels;let r;for(r=0;r<n.length&&!(t<n[r].distance);r++);return n.splice(r,0,{distance:t,hysteresis:i,object:e}),this.add(e),this}removeLevel(e){const t=this.levels;for(let i=0;i<t.length;i++)if(t[i].distance===e){const e=t.splice(i,1);return this.remove(e[0].object),!0}return!1}getCurrentLevel(){return this._currentLevel}getObjectForDistance(e){const t=this.levels;if(t.length>0){let i,n;for(i=1,n=t.length;i<n;i++){let n=t[i].distance;if(t[i].object.visible&&(n-=n*t[i].hysteresis),e<n)break}return t[i-1].object}return null}raycast(e,t){if(this.levels.length>0){_v1$2.setFromMatrixPosition(this.matrixWorld);const i=e.ray.origin.distanceTo(_v1$2);this.getObjectForDistance(i).raycast(e,t)}}update(e){const t=this.levels;if(t.length>1){_v1$2.setFromMatrixPosition(e.matrixWorld),_v2$1.setFromMatrixPosition(this.matrixWorld);const i=_v1$2.distanceTo(_v2$1)/e.zoom;let n,r;for(t[0].object.visible=!0,n=1,r=t.length;n<r;n++){let e=t[n].distance;if(t[n].object.visible&&(e-=e*t[n].hysteresis),!(i>=e))break;t[n-1].object.visible=!1,t[n].object.visible=!0}for(this._currentLevel=n-1;n<r;n++)t[n].object.visible=!1}}toJSON(e){const t=super.toJSON(e);!1===this.autoUpdate&&(t.object.autoUpdate=!1),t.object.levels=[];const i=this.levels;for(let e=0,n=i.length;e<n;e++){const n=i[e];t.object.levels.push({object:n.object.uuid,distance:n.distance,hysteresis:n.hysteresis})}return t}}const _basePosition=new Vector3,_skinIndex=new Vector4,_skinWeight=new Vector4,_vector3=new Vector3,_matrix4=new Matrix4,_vertex=new Vector3,_sphere$5=new Sphere,_inverseMatrix$2=new Matrix4,_ray$2=new Ray;class SkinnedMesh extends Mesh{constructor(e,t){super(e,t),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=AttachedBindMode,this.bindMatrix=new Matrix4,this.bindMatrixInverse=new Matrix4,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const e=this.geometry;null===this.boundingBox&&(this.boundingBox=new Box3),this.boundingBox.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,_vertex),this.boundingBox.expandByPoint(_vertex)}computeBoundingSphere(){const e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new Sphere),this.boundingSphere.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,_vertex),this.boundingSphere.expandByPoint(_vertex)}copy(e,t){return super.copy(e,t),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,t){const i=this.matrixWorld;void 0!==this.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),_sphere$5.copy(this.boundingSphere),_sphere$5.applyMatrix4(i),!1!==e.ray.intersectsSphere(_sphere$5)&&(_inverseMatrix$2.copy(i).invert(),_ray$2.copy(e.ray).applyMatrix4(_inverseMatrix$2),null!==this.boundingBox&&!1===_ray$2.intersectsBox(this.boundingBox)||this._computeIntersections(e,t,_ray$2)))}getVertexPosition(e,t){return super.getVertexPosition(e,t),this.applyBoneTransform(e,t),t}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new Vector4,t=this.geometry.attributes.skinWeight;for(let i=0,n=t.count;i<n;i++){e.fromBufferAttribute(t,i);const n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),t.setXYZW(i,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===AttachedBindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode===DetachedBindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():warn("SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,t){const i=this.skeleton,n=this.geometry;_skinIndex.fromBufferAttribute(n.attributes.skinIndex,e),_skinWeight.fromBufferAttribute(n.attributes.skinWeight,e),_basePosition.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let e=0;e<4;e++){const n=_skinWeight.getComponent(e);if(0!==n){const r=_skinIndex.getComponent(e);_matrix4.multiplyMatrices(i.bones[r].matrixWorld,i.boneInverses[r]),t.addScaledVector(_vector3.copy(_basePosition).applyMatrix4(_matrix4),n)}}return t.applyMatrix4(this.bindMatrixInverse)}}class Bone extends Object3D{constructor(){super(),this.isBone=!0,this.type="Bone"}}class DataTexture extends Texture{constructor(e=null,t=1,i=1,n,r,o,s,a,l=NearestFilter,c=NearestFilter,u,h){super(null,o,s,a,l,c,n,r,u,h),this.isDataTexture=!0,this.image={data:e,width:t,height:i},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const _offsetMatrix=new Matrix4,_identityMatrix$1=new Matrix4;class Skeleton{constructor(e=[],t=[]){this.uuid=generateUUID$1(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.previousBoneMatrices=null,this.boneTexture=null,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){warn("Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new Matrix4)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new Matrix4;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,i=this.boneMatrices,n=this.boneTexture;for(let n=0,r=e.length;n<r;n++){_offsetMatrix.multiplyMatrices(e[n]?e[n].matrixWorld:_identityMatrix$1,t[n]),_offsetMatrix.toArray(i,16*n)}null!==n&&(n.needsUpdate=!0)}clone(){return new Skeleton(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length);e=4*Math.ceil(e/4),e=Math.max(e,4);const t=new Float32Array(e*e*4);t.set(this.boneMatrices);const i=new DataTexture(t,e,e,RGBAFormat,FloatType);return i.needsUpdate=!0,this.boneMatrices=t,this.boneTexture=i,this}getBoneByName(e){for(let t=0,i=this.bones.length;t<i;t++){const i=this.bones[t];if(i.name===e)return i}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let i=0,n=e.bones.length;i<n;i++){const n=e.bones[i];let r=t[n];void 0===r&&(warn("Skeleton: No bone found with UUID:",n),r=new Bone),this.bones.push(r),this.boneInverses.push((new Matrix4).fromArray(e.boneInverses[i]))}return this.init(),this}toJSON(){const e={metadata:{version:4.7,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,i=this.boneInverses;for(let n=0,r=t.length;n<r;n++){e.bones.push(t[n].uuid);e.boneInverses.push(i[n].toArray())}return e}}class InstancedBufferAttribute extends BufferAttribute{constructor(e,t,i,n=1){super(e,t,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const _instanceLocalMatrix=new Matrix4,_instanceWorldMatrix=new Matrix4,_instanceIntersects=[],_box3=new Box3,_identity=new Matrix4,_mesh$1=new Mesh,_sphere$4=new Sphere;class InstancedMesh extends Mesh{constructor(e,t,i){super(e,t),this.isInstancedMesh=!0,this.instanceMatrix=new InstancedBufferAttribute(new Float32Array(16*i),16),this.instanceColor=null,this.morphTexture=null,this.count=i,this.boundingBox=null,this.boundingSphere=null;for(let e=0;e<i;e++)this.setMatrixAt(e,_identity)}computeBoundingBox(){const e=this.geometry,t=this.count;null===this.boundingBox&&(this.boundingBox=new Box3),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,_instanceLocalMatrix),_box3.copy(e.boundingBox).applyMatrix4(_instanceLocalMatrix),this.boundingBox.union(_box3)}computeBoundingSphere(){const e=this.geometry,t=this.count;null===this.boundingSphere&&(this.boundingSphere=new Sphere),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,_instanceLocalMatrix),_sphere$4.copy(e.boundingSphere).applyMatrix4(_instanceLocalMatrix),this.boundingSphere.union(_sphere$4)}copy(e,t){return super.copy(e,t),this.instanceMatrix.copy(e.instanceMatrix),null!==e.morphTexture&&(this.morphTexture=e.morphTexture.clone()),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,t){t.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,16*e)}getMorphAt(e,t){const i=t.morphTargetInfluences,n=this.morphTexture.source.data.data,r=e*(i.length+1)+1;for(let e=0;e<i.length;e++)i[e]=n[r+e]}raycast(e,t){const i=this.matrixWorld,n=this.count;if(_mesh$1.geometry=this.geometry,_mesh$1.material=this.material,void 0!==_mesh$1.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),_sphere$4.copy(this.boundingSphere),_sphere$4.applyMatrix4(i),!1!==e.ray.intersectsSphere(_sphere$4)))for(let r=0;r<n;r++){this.getMatrixAt(r,_instanceLocalMatrix),_instanceWorldMatrix.multiplyMatrices(i,_instanceLocalMatrix),_mesh$1.matrixWorld=_instanceWorldMatrix,_mesh$1.raycast(e,_instanceIntersects);for(let e=0,i=_instanceIntersects.length;e<i;e++){const i=_instanceIntersects[e];i.instanceId=r,i.object=this,t.push(i)}_instanceIntersects.length=0}}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count).fill(1),3)),t.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,16*e)}setMorphAt(e,t){const i=t.morphTargetInfluences,n=i.length+1;null===this.morphTexture&&(this.morphTexture=new DataTexture(new Float32Array(n*this.count),n,this.count,RedFormat,FloatType));const r=this.morphTexture.source.data.data;let o=0;for(let e=0;e<i.length;e++)o+=i[e];const s=n*e;r[s]=this.geometry.morphTargetsRelative?1:1-o,r.set(i,s+1)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null)}}const _vector1=new Vector3,_vector2=new Vector3,_normalMatrix=new Matrix3;let Plane$1=class{constructor(e=new Vector3(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,n){return this.normal.set(e,t,i),this.constant=n,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const n=_vector1.subVectors(i,t).cross(_vector2.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const i=e.delta(_vector1),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const r=-(e.start.dot(this.normal)+this.constant)/n;return r<0||r>1?null:t.copy(e.start).addScaledVector(i,r)}intersectsLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||_normalMatrix.getNormalMatrix(e),n=this.coplanarPoint(_vector1).applyMatrix4(e),r=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(r),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}};const _sphere$3=new Sphere,_defaultSpriteCenter=new Vector2(.5,.5),_vector$6=new Vector3;class Frustum{constructor(e=new Plane$1,t=new Plane$1,i=new Plane$1,n=new Plane$1,r=new Plane$1,o=new Plane$1){this.planes=[e,t,i,n,r,o]}set(e,t,i,n,r,o){const s=this.planes;return s[0].copy(e),s[1].copy(t),s[2].copy(i),s[3].copy(n),s[4].copy(r),s[5].copy(o),this}copy(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e,t=WebGLCoordinateSystem,i=!1){const n=this.planes,r=e.elements,o=r[0],s=r[1],a=r[2],l=r[3],c=r[4],u=r[5],h=r[6],d=r[7],p=r[8],f=r[9],m=r[10],g=r[11],_=r[12],y=r[13],v=r[14],x=r[15];if(n[0].setComponents(l-o,d-c,g-p,x-_).normalize(),n[1].setComponents(l+o,d+c,g+p,x+_).normalize(),n[2].setComponents(l+s,d+u,g+f,x+y).normalize(),n[3].setComponents(l-s,d-u,g-f,x-y).normalize(),i)n[4].setComponents(a,h,m,v).normalize(),n[5].setComponents(l-a,d-h,g-m,x-v).normalize();else if(n[4].setComponents(l-a,d-h,g-m,x-v).normalize(),t===WebGLCoordinateSystem)n[5].setComponents(l+a,d+h,g+m,x+v).normalize();else{if(t!==WebGPUCoordinateSystem)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);n[5].setComponents(a,h,m,v).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),_sphere$3.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),_sphere$3.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(_sphere$3)}intersectsSprite(e){_sphere$3.center.set(0,0,0);const t=_defaultSpriteCenter.distanceTo(e.center);return _sphere$3.radius=.7071067811865476+t,_sphere$3.applyMatrix4(e.matrixWorld),this.intersectsSphere(_sphere$3)}intersectsSphere(e){const t=this.planes,i=e.center,n=-e.radius;for(let e=0;e<6;e++){if(t[e].distanceToPoint(i)<n)return!1}return!0}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const n=t[i];if(_vector$6.x=n.normal.x>0?e.max.x:e.min.x,_vector$6.y=n.normal.y>0?e.max.y:e.min.y,_vector$6.z=n.normal.z>0?e.max.z:e.min.z,n.distanceToPoint(_vector$6)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}const _projScreenMatrix$1=new Matrix4,_frustum$1=new Frustum;class FrustumArray{constructor(){this.coordinateSystem=WebGLCoordinateSystem}intersectsObject(e,t){if(!t.isArrayCamera||0===t.cameras.length)return!1;for(let i=0;i<t.cameras.length;i++){const n=t.cameras[i];if(_projScreenMatrix$1.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),_frustum$1.setFromProjectionMatrix(_projScreenMatrix$1,n.coordinateSystem,n.reversedDepth),_frustum$1.intersectsObject(e))return!0}return!1}intersectsSprite(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let i=0;i<t.cameras.length;i++){const n=t.cameras[i];if(_projScreenMatrix$1.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),_frustum$1.setFromProjectionMatrix(_projScreenMatrix$1,n.coordinateSystem,n.reversedDepth),_frustum$1.intersectsSprite(e))return!0}return!1}intersectsSphere(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let i=0;i<t.cameras.length;i++){const n=t.cameras[i];if(_projScreenMatrix$1.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),_frustum$1.setFromProjectionMatrix(_projScreenMatrix$1,n.coordinateSystem,n.reversedDepth),_frustum$1.intersectsSphere(e))return!0}return!1}intersectsBox(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let i=0;i<t.cameras.length;i++){const n=t.cameras[i];if(_projScreenMatrix$1.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),_frustum$1.setFromProjectionMatrix(_projScreenMatrix$1,n.coordinateSystem,n.reversedDepth),_frustum$1.intersectsBox(e))return!0}return!1}containsPoint(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let i=0;i<t.cameras.length;i++){const n=t.cameras[i];if(_projScreenMatrix$1.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),_frustum$1.setFromProjectionMatrix(_projScreenMatrix$1,n.coordinateSystem,n.reversedDepth),_frustum$1.containsPoint(e))return!0}return!1}clone(){return new FrustumArray}}function ascIdSort(e,t){return e-t}function sortOpaque(e,t){return e.z-t.z}function sortTransparent(e,t){return t.z-e.z}class MultiDrawRenderList{constructor(){this.index=0,this.pool=[],this.list=[]}push(e,t,i,n){const r=this.pool,o=this.list;this.index>=r.length&&r.push({start:-1,count:-1,z:-1,index:-1});const s=r[this.index];o.push(s),this.index++,s.start=e,s.count=t,s.z=i,s.index=n}reset(){this.list.length=0,this.index=0}}const _matrix$1=new Matrix4,_whiteColor=new Color(1,1,1),_frustum=new Frustum,_frustumArray=new FrustumArray,_box$1=new Box3,_sphere$2=new Sphere,_vector$5=new Vector3,_forward$1=new Vector3,_temp=new Vector3,_renderList=new MultiDrawRenderList,_mesh=new Mesh,_batchIntersects=[];function copyAttributeData(e,t,i=0){const n=t.itemSize;if(e.isInterleavedBufferAttribute||e.array.constructor!==t.array.constructor){const r=e.count;for(let o=0;o<r;o++)for(let r=0;r<n;r++)t.setComponent(o+i,r,e.getComponent(o,r))}else t.array.set(e.array,i*n);t.needsUpdate=!0}function copyArrayContents(e,t){if(e.constructor!==t.constructor){const i=Math.min(e.length,t.length);for(let n=0;n<i;n++)t[n]=e[n]}else{const i=Math.min(e.length,t.length);t.set(new e.constructor(e.buffer,0,i))}}class BatchedMesh extends Mesh{constructor(e,t,i=2*t,n){super(new BufferGeometry,n),this.isBatchedMesh=!0,this.perObjectFrustumCulled=!0,this.sortObjects=!0,this.boundingBox=null,this.boundingSphere=null,this.customSort=null,this._instanceInfo=[],this._geometryInfo=[],this._availableInstanceIds=[],this._availableGeometryIds=[],this._nextIndexStart=0,this._nextVertexStart=0,this._geometryCount=0,this._visibilityChanged=!0,this._geometryInitialized=!1,this._maxInstanceCount=e,this._maxVertexCount=t,this._maxIndexCount=i,this._multiDrawCounts=new Int32Array(e),this._multiDrawStarts=new Int32Array(e),this._multiDrawCount=0,this._multiDrawInstances=null,this._matricesTexture=null,this._indirectTexture=null,this._colorsTexture=null,this._initMatricesTexture(),this._initIndirectTexture()}get maxInstanceCount(){return this._maxInstanceCount}get instanceCount(){return this._instanceInfo.length-this._availableInstanceIds.length}get unusedVertexCount(){return this._maxVertexCount-this._nextVertexStart}get unusedIndexCount(){return this._maxIndexCount-this._nextIndexStart}_initMatricesTexture(){let e=Math.sqrt(4*this._maxInstanceCount);e=4*Math.ceil(e/4),e=Math.max(e,4);const t=new Float32Array(e*e*4),i=new DataTexture(t,e,e,RGBAFormat,FloatType);this._matricesTexture=i}_initIndirectTexture(){let e=Math.sqrt(this._maxInstanceCount);e=Math.ceil(e);const t=new Uint32Array(e*e),i=new DataTexture(t,e,e,RedIntegerFormat,UnsignedIntType);this._indirectTexture=i}_initColorsTexture(){let e=Math.sqrt(this._maxInstanceCount);e=Math.ceil(e);const t=new Float32Array(e*e*4).fill(1),i=new DataTexture(t,e,e,RGBAFormat,FloatType);i.colorSpace=ColorManagement.workingColorSpace,this._colorsTexture=i}_initializeGeometry(e){const t=this.geometry,i=this._maxVertexCount,n=this._maxIndexCount;if(!1===this._geometryInitialized){for(const n in e.attributes){const r=e.getAttribute(n),{array:o,itemSize:s,normalized:a}=r,l=new o.constructor(i*s),c=new BufferAttribute(l,s,a);t.setAttribute(n,c)}if(null!==e.getIndex()){const e=i>65535?new Uint32Array(n):new Uint16Array(n);t.setIndex(new BufferAttribute(e,1))}this._geometryInitialized=!0}}_validateGeometry(e){const t=this.geometry;if(Boolean(e.getIndex())!==Boolean(t.getIndex()))throw new Error('THREE.BatchedMesh: All geometries must consistently have "index".');for(const i in t.attributes){if(!e.hasAttribute(i))throw new Error(`THREE.BatchedMesh: Added geometry missing "${i}". All geometries must have consistent attributes.`);const n=e.getAttribute(i),r=t.getAttribute(i);if(n.itemSize!==r.itemSize||n.normalized!==r.normalized)throw new Error("THREE.BatchedMesh: All attributes must have a consistent itemSize and normalized value.")}}validateInstanceId(e){const t=this._instanceInfo;if(e<0||e>=t.length||!1===t[e].active)throw new Error(`THREE.BatchedMesh: Invalid instanceId ${e}. Instance is either out of range or has been deleted.`)}validateGeometryId(e){const t=this._geometryInfo;if(e<0||e>=t.length||!1===t[e].active)throw new Error(`THREE.BatchedMesh: Invalid geometryId ${e}. Geometry is either out of range or has been deleted.`)}setCustomSort(e){return this.customSort=e,this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Box3);const e=this.boundingBox,t=this._instanceInfo;e.makeEmpty();for(let i=0,n=t.length;i<n;i++){if(!1===t[i].active)continue;const n=t[i].geometryIndex;this.getMatrixAt(i,_matrix$1),this.getBoundingBoxAt(n,_box$1).applyMatrix4(_matrix$1),e.union(_box$1)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);const e=this.boundingSphere,t=this._instanceInfo;e.makeEmpty();for(let i=0,n=t.length;i<n;i++){if(!1===t[i].active)continue;const n=t[i].geometryIndex;this.getMatrixAt(i,_matrix$1),this.getBoundingSphereAt(n,_sphere$2).applyMatrix4(_matrix$1),e.union(_sphere$2)}}addInstance(e){if(this._instanceInfo.length>=this.maxInstanceCount&&0===this._availableInstanceIds.length)throw new Error("THREE.BatchedMesh: Maximum item count reached.");const t={visible:!0,active:!0,geometryIndex:e};let i=null;this._availableInstanceIds.length>0?(this._availableInstanceIds.sort(ascIdSort),i=this._availableInstanceIds.shift(),this._instanceInfo[i]=t):(i=this._instanceInfo.length,this._instanceInfo.push(t));const n=this._matricesTexture;_matrix$1.identity().toArray(n.image.data,16*i),n.needsUpdate=!0;const r=this._colorsTexture;return r&&(_whiteColor.toArray(r.image.data,4*i),r.needsUpdate=!0),this._visibilityChanged=!0,i}addGeometry(e,t=-1,i=-1){this._initializeGeometry(e),this._validateGeometry(e);const n={vertexStart:-1,vertexCount:-1,reservedVertexCount:-1,indexStart:-1,indexCount:-1,reservedIndexCount:-1,start:-1,count:-1,boundingBox:null,boundingSphere:null,active:!0},r=this._geometryInfo;n.vertexStart=this._nextVertexStart,n.reservedVertexCount=-1===t?e.getAttribute("position").count:t;const o=e.getIndex();if(null!==o&&(n.indexStart=this._nextIndexStart,n.reservedIndexCount=-1===i?o.count:i),-1!==n.indexStart&&n.indexStart+n.reservedIndexCount>this._maxIndexCount||n.vertexStart+n.reservedVertexCount>this._maxVertexCount)throw new Error("THREE.BatchedMesh: Reserved space request exceeds the maximum buffer size.");let s;return this._availableGeometryIds.length>0?(this._availableGeometryIds.sort(ascIdSort),s=this._availableGeometryIds.shift(),r[s]=n):(s=this._geometryCount,this._geometryCount++,r.push(n)),this.setGeometryAt(s,e),this._nextIndexStart=n.indexStart+n.reservedIndexCount,this._nextVertexStart=n.vertexStart+n.reservedVertexCount,s}setGeometryAt(e,t){if(e>=this._geometryCount)throw new Error("THREE.BatchedMesh: Maximum geometry count reached.");this._validateGeometry(t);const i=this.geometry,n=null!==i.getIndex(),r=i.getIndex(),o=t.getIndex(),s=this._geometryInfo[e];if(n&&o.count>s.reservedIndexCount||t.attributes.position.count>s.reservedVertexCount)throw new Error("THREE.BatchedMesh: Reserved space not large enough for provided geometry.");const a=s.vertexStart,l=s.reservedVertexCount;s.vertexCount=t.getAttribute("position").count;for(const e in i.attributes){const n=t.getAttribute(e),r=i.getAttribute(e);copyAttributeData(n,r,a);const o=n.itemSize;for(let e=n.count,t=l;e<t;e++){const t=a+e;for(let e=0;e<o;e++)r.setComponent(t,e,0)}r.needsUpdate=!0,r.addUpdateRange(a*o,l*o)}if(n){const e=s.indexStart,i=s.reservedIndexCount;s.indexCount=t.getIndex().count;for(let t=0;t<o.count;t++)r.setX(e+t,a+o.getX(t));for(let t=o.count,n=i;t<n;t++)r.setX(e+t,a);r.needsUpdate=!0,r.addUpdateRange(e,s.reservedIndexCount)}return s.start=n?s.indexStart:s.vertexStart,s.count=n?s.indexCount:s.vertexCount,s.boundingBox=null,null!==t.boundingBox&&(s.boundingBox=t.boundingBox.clone()),s.boundingSphere=null,null!==t.boundingSphere&&(s.boundingSphere=t.boundingSphere.clone()),this._visibilityChanged=!0,e}deleteGeometry(e){const t=this._geometryInfo;if(e>=t.length||!1===t[e].active)return this;const i=this._instanceInfo;for(let t=0,n=i.length;t<n;t++)i[t].active&&i[t].geometryIndex===e&&this.deleteInstance(t);return t[e].active=!1,this._availableGeometryIds.push(e),this._visibilityChanged=!0,this}deleteInstance(e){return this.validateInstanceId(e),this._instanceInfo[e].active=!1,this._availableInstanceIds.push(e),this._visibilityChanged=!0,this}optimize(){let e=0,t=0;const i=this._geometryInfo,n=i.map(((e,t)=>t)).sort(((e,t)=>i[e].vertexStart-i[t].vertexStart)),r=this.geometry;for(let o=0,s=i.length;o<s;o++){const s=i[n[o]];if(!1!==s.active){if(null!==r.index){if(s.indexStart!==t){const{indexStart:i,vertexStart:n,reservedIndexCount:o}=s,a=r.index,l=a.array,c=e-n;for(let e=i;e<i+o;e++)l[e]=l[e]+c;a.array.copyWithin(t,i,i+o),a.addUpdateRange(t,o),a.needsUpdate=!0,s.indexStart=t}t+=s.reservedIndexCount}if(s.vertexStart!==e){const{vertexStart:t,reservedVertexCount:i}=s,n=r.attributes;for(const r in n){const o=n[r],{array:s,itemSize:a}=o;s.copyWithin(e*a,t*a,(t+i)*a),o.addUpdateRange(e*a,i*a),o.needsUpdate=!0}s.vertexStart=e}e+=s.reservedVertexCount,s.start=r.index?s.indexStart:s.vertexStart,this._nextIndexStart=r.index?s.indexStart+s.reservedIndexCount:0,this._nextVertexStart=s.vertexStart+s.reservedVertexCount}}return this._visibilityChanged=!0,this}getBoundingBoxAt(e,t){if(e>=this._geometryCount)return null;const i=this.geometry,n=this._geometryInfo[e];if(null===n.boundingBox){const e=new Box3,t=i.index,r=i.attributes.position;for(let i=n.start,o=n.start+n.count;i<o;i++){let n=i;t&&(n=t.getX(n)),e.expandByPoint(_vector$5.fromBufferAttribute(r,n))}n.boundingBox=e}return t.copy(n.boundingBox),t}getBoundingSphereAt(e,t){if(e>=this._geometryCount)return null;const i=this.geometry,n=this._geometryInfo[e];if(null===n.boundingSphere){const t=new Sphere;this.getBoundingBoxAt(e,_box$1),_box$1.getCenter(t.center);const r=i.index,o=i.attributes.position;let s=0;for(let e=n.start,i=n.start+n.count;e<i;e++){let i=e;r&&(i=r.getX(i)),_vector$5.fromBufferAttribute(o,i),s=Math.max(s,t.center.distanceToSquared(_vector$5))}t.radius=Math.sqrt(s),n.boundingSphere=t}return t.copy(n.boundingSphere),t}setMatrixAt(e,t){this.validateInstanceId(e);const i=this._matricesTexture;return t.toArray(this._matricesTexture.image.data,16*e),i.needsUpdate=!0,this}getMatrixAt(e,t){return this.validateInstanceId(e),t.fromArray(this._matricesTexture.image.data,16*e)}setColorAt(e,t){return this.validateInstanceId(e),null===this._colorsTexture&&this._initColorsTexture(),t.toArray(this._colorsTexture.image.data,4*e),this._colorsTexture.needsUpdate=!0,this}getColorAt(e,t){return this.validateInstanceId(e),t.fromArray(this._colorsTexture.image.data,4*e)}setVisibleAt(e,t){return this.validateInstanceId(e),this._instanceInfo[e].visible===t||(this._instanceInfo[e].visible=t,this._visibilityChanged=!0),this}getVisibleAt(e){return this.validateInstanceId(e),this._instanceInfo[e].visible}setGeometryIdAt(e,t){return this.validateInstanceId(e),this.validateGeometryId(t),this._instanceInfo[e].geometryIndex=t,this}getGeometryIdAt(e){return this.validateInstanceId(e),this._instanceInfo[e].geometryIndex}getGeometryRangeAt(e,t={}){this.validateGeometryId(e);const i=this._geometryInfo[e];return t.vertexStart=i.vertexStart,t.vertexCount=i.vertexCount,t.reservedVertexCount=i.reservedVertexCount,t.indexStart=i.indexStart,t.indexCount=i.indexCount,t.reservedIndexCount=i.reservedIndexCount,t.start=i.start,t.count=i.count,t}setInstanceCount(e){const t=this._availableInstanceIds,i=this._instanceInfo;for(t.sort(ascIdSort);t[t.length-1]===i.length-1;)i.pop(),t.pop();if(e<i.length)throw new Error(`BatchedMesh: Instance ids outside the range ${e} are being used. Cannot shrink instance count.`);const n=new Int32Array(e),r=new Int32Array(e);copyArrayContents(this._multiDrawCounts,n),copyArrayContents(this._multiDrawStarts,r),this._multiDrawCounts=n,this._multiDrawStarts=r,this._maxInstanceCount=e;const o=this._indirectTexture,s=this._matricesTexture,a=this._colorsTexture;o.dispose(),this._initIndirectTexture(),copyArrayContents(o.image.data,this._indirectTexture.image.data),s.dispose(),this._initMatricesTexture(),copyArrayContents(s.image.data,this._matricesTexture.image.data),a&&(a.dispose(),this._initColorsTexture(),copyArrayContents(a.image.data,this._colorsTexture.image.data))}setGeometrySize(e,t){const i=[...this._geometryInfo].filter((e=>e.active));if(Math.max(...i.map((e=>e.vertexStart+e.reservedVertexCount)))>e)throw new Error(`BatchedMesh: Geometry vertex values are being used outside the range ${t}. Cannot shrink further.`);if(this.geometry.index){if(Math.max(...i.map((e=>e.indexStart+e.reservedIndexCount)))>t)throw new Error(`BatchedMesh: Geometry index values are being used outside the range ${t}. Cannot shrink further.`)}const n=this.geometry;n.dispose(),this._maxVertexCount=e,this._maxIndexCount=t,this._geometryInitialized&&(this._geometryInitialized=!1,this.geometry=new BufferGeometry,this._initializeGeometry(n));const r=this.geometry;n.index&&copyArrayContents(n.index.array,r.index.array);for(const e in n.attributes)copyArrayContents(n.attributes[e].array,r.attributes[e].array)}raycast(e,t){const i=this._instanceInfo,n=this._geometryInfo,r=this.matrixWorld,o=this.geometry;_mesh.material=this.material,_mesh.geometry.index=o.index,_mesh.geometry.attributes=o.attributes,null===_mesh.geometry.boundingBox&&(_mesh.geometry.boundingBox=new Box3),null===_mesh.geometry.boundingSphere&&(_mesh.geometry.boundingSphere=new Sphere);for(let o=0,s=i.length;o<s;o++){if(!i[o].visible||!i[o].active)continue;const s=i[o].geometryIndex,a=n[s];_mesh.geometry.setDrawRange(a.start,a.count),this.getMatrixAt(o,_mesh.matrixWorld).premultiply(r),this.getBoundingBoxAt(s,_mesh.geometry.boundingBox),this.getBoundingSphereAt(s,_mesh.geometry.boundingSphere),_mesh.raycast(e,_batchIntersects);for(let e=0,i=_batchIntersects.length;e<i;e++){const i=_batchIntersects[e];i.object=this,i.batchId=o,t.push(i)}_batchIntersects.length=0}_mesh.material=null,_mesh.geometry.index=null,_mesh.geometry.attributes={},_mesh.geometry.setDrawRange(0,1/0)}copy(e){return super.copy(e),this.geometry=e.geometry.clone(),this.perObjectFrustumCulled=e.perObjectFrustumCulled,this.sortObjects=e.sortObjects,this.boundingBox=null!==e.boundingBox?e.boundingBox.clone():null,this.boundingSphere=null!==e.boundingSphere?e.boundingSphere.clone():null,this._geometryInfo=e._geometryInfo.map((e=>({...e,boundingBox:null!==e.boundingBox?e.boundingBox.clone():null,boundingSphere:null!==e.boundingSphere?e.boundingSphere.clone():null}))),this._instanceInfo=e._instanceInfo.map((e=>({...e}))),this._availableInstanceIds=e._availableInstanceIds.slice(),this._availableGeometryIds=e._availableGeometryIds.slice(),this._nextIndexStart=e._nextIndexStart,this._nextVertexStart=e._nextVertexStart,this._geometryCount=e._geometryCount,this._maxInstanceCount=e._maxInstanceCount,this._maxVertexCount=e._maxVertexCount,this._maxIndexCount=e._maxIndexCount,this._geometryInitialized=e._geometryInitialized,this._multiDrawCounts=e._multiDrawCounts.slice(),this._multiDrawStarts=e._multiDrawStarts.slice(),this._indirectTexture=e._indirectTexture.clone(),this._indirectTexture.image.data=this._indirectTexture.image.data.slice(),this._matricesTexture=e._matricesTexture.clone(),this._matricesTexture.image.data=this._matricesTexture.image.data.slice(),null!==this._colorsTexture&&(this._colorsTexture=e._colorsTexture.clone(),this._colorsTexture.image.data=this._colorsTexture.image.data.slice()),this}dispose(){this.geometry.dispose(),this._matricesTexture.dispose(),this._matricesTexture=null,this._indirectTexture.dispose(),this._indirectTexture=null,null!==this._colorsTexture&&(this._colorsTexture.dispose(),this._colorsTexture=null)}onBeforeRender(e,t,i,n,r){if(!this._visibilityChanged&&!this.perObjectFrustumCulled&&!this.sortObjects)return;const o=n.getIndex(),s=null===o?1:o.array.BYTES_PER_ELEMENT,a=this._instanceInfo,l=this._multiDrawStarts,c=this._multiDrawCounts,u=this._geometryInfo,h=this.perObjectFrustumCulled,d=this._indirectTexture,p=d.image.data,f=i.isArrayCamera?_frustumArray:_frustum;h&&!i.isArrayCamera&&(_matrix$1.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse).multiply(this.matrixWorld),_frustum.setFromProjectionMatrix(_matrix$1,i.coordinateSystem,i.reversedDepth));let m=0;if(this.sortObjects){_matrix$1.copy(this.matrixWorld).invert(),_vector$5.setFromMatrixPosition(i.matrixWorld).applyMatrix4(_matrix$1),_forward$1.set(0,0,-1).transformDirection(i.matrixWorld).transformDirection(_matrix$1);for(let e=0,t=a.length;e<t;e++)if(a[e].visible&&a[e].active){const t=a[e].geometryIndex;this.getMatrixAt(e,_matrix$1),this.getBoundingSphereAt(t,_sphere$2).applyMatrix4(_matrix$1);let n=!1;if(h&&(n=!f.intersectsSphere(_sphere$2,i)),!n){const i=u[t],n=_temp.subVectors(_sphere$2.center,_vector$5).dot(_forward$1);_renderList.push(i.start,i.count,n,e)}}const e=_renderList.list,t=this.customSort;null===t?e.sort(r.transparent?sortTransparent:sortOpaque):t.call(this,e,i);for(let t=0,i=e.length;t<i;t++){const i=e[t];l[m]=i.start*s,c[m]=i.count,p[m]=i.index,m++}_renderList.reset()}else for(let e=0,t=a.length;e<t;e++)if(a[e].visible&&a[e].active){const t=a[e].geometryIndex;let n=!1;if(h&&(this.getMatrixAt(e,_matrix$1),this.getBoundingSphereAt(t,_sphere$2).applyMatrix4(_matrix$1),n=!f.intersectsSphere(_sphere$2,i)),!n){const i=u[t];l[m]=i.start*s,c[m]=i.count,p[m]=e,m++}}d.needsUpdate=!0,this._multiDrawCount=m,this._visibilityChanged=!1}onBeforeShadow(e,t,i,n,r,o){this.onBeforeRender(e,null,n,r,o)}}class LineBasicMaterial extends Material{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Color(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const _vStart=new Vector3,_vEnd=new Vector3,_inverseMatrix$1=new Matrix4,_ray$1=new Ray,_sphere$1=new Sphere,_intersectPointOnRay=new Vector3,_intersectPointOnSegment=new Vector3;class Line extends Object3D{constructor(e=new BufferGeometry,t=new LineBasicMaterial){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,i=[0];for(let e=1,n=t.count;e<n;e++)_vStart.fromBufferAttribute(t,e-1),_vEnd.fromBufferAttribute(t,e),i[e]=i[e-1],i[e]+=_vStart.distanceTo(_vEnd);e.setAttribute("lineDistance",new Float32BufferAttribute(i,1))}else warn("Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const i=this.geometry,n=this.matrixWorld,r=e.params.Line.threshold,o=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),_sphere$1.copy(i.boundingSphere),_sphere$1.applyMatrix4(n),_sphere$1.radius+=r,!1===e.ray.intersectsSphere(_sphere$1))return;_inverseMatrix$1.copy(n).invert(),_ray$1.copy(e.ray).applyMatrix4(_inverseMatrix$1);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=s*s,l=this.isLineSegments?2:1,c=i.index,u=i.attributes.position;if(null!==c){const i=Math.max(0,o.start),n=Math.min(c.count,o.start+o.count);for(let r=i,o=n-1;r<o;r+=l){const i=c.getX(r),n=c.getX(r+1),o=checkIntersection(this,e,_ray$1,a,i,n,r);o&&t.push(o)}if(this.isLineLoop){const r=c.getX(n-1),o=c.getX(i),s=checkIntersection(this,e,_ray$1,a,r,o,n-1);s&&t.push(s)}}else{const i=Math.max(0,o.start),n=Math.min(u.count,o.start+o.count);for(let r=i,o=n-1;r<o;r+=l){const i=checkIntersection(this,e,_ray$1,a,r,r+1,r);i&&t.push(i)}if(this.isLineLoop){const r=checkIntersection(this,e,_ray$1,a,n-1,i,n-1);r&&t.push(r)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function checkIntersection(e,t,i,n,r,o,s){const a=e.geometry.attributes.position;_vStart.fromBufferAttribute(a,r),_vEnd.fromBufferAttribute(a,o);if(i.distanceSqToSegment(_vStart,_vEnd,_intersectPointOnRay,_intersectPointOnSegment)>n)return;_intersectPointOnRay.applyMatrix4(e.matrixWorld);const l=t.ray.origin.distanceTo(_intersectPointOnRay);return l<t.near||l>t.far?void 0:{distance:l,point:_intersectPointOnSegment.clone().applyMatrix4(e.matrixWorld),index:s,face:null,faceIndex:null,barycoord:null,object:e}}const _start=new Vector3,_end=new Vector3;class LineSegments extends Line{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,i=[];for(let e=0,n=t.count;e<n;e+=2)_start.fromBufferAttribute(t,e),_end.fromBufferAttribute(t,e+1),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+_start.distanceTo(_end);e.setAttribute("lineDistance",new Float32BufferAttribute(i,1))}else warn("LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class LineLoop extends Line{constructor(e,t){super(e,t),this.isLineLoop=!0,this.type="LineLoop"}}class PointsMaterial extends Material{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new Color(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}const _inverseMatrix=new Matrix4,_ray=new Ray,_sphere=new Sphere,_position$2=new Vector3;class Points extends Object3D{constructor(e=new BufferGeometry,t=new PointsMaterial){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,t){const i=this.geometry,n=this.matrixWorld,r=e.params.Points.threshold,o=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),_sphere.copy(i.boundingSphere),_sphere.applyMatrix4(n),_sphere.radius+=r,!1===e.ray.intersectsSphere(_sphere))return;_inverseMatrix.copy(n).invert(),_ray.copy(e.ray).applyMatrix4(_inverseMatrix);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=s*s,l=i.index,c=i.attributes.position;if(null!==l){for(let i=Math.max(0,o.start),r=Math.min(l.count,o.start+o.count);i<r;i++){const r=l.getX(i);_position$2.fromBufferAttribute(c,r),testPoint(_position$2,r,a,n,e,t,this)}}else{for(let i=Math.max(0,o.start),r=Math.min(c.count,o.start+o.count);i<r;i++)_position$2.fromBufferAttribute(c,i),testPoint(_position$2,i,a,n,e,t,this)}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const i=e[t[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=i.length;e<t;e++){const t=i[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function testPoint(e,t,i,n,r,o,s){const a=_ray.distanceSqToPoint(e);if(a<i){const i=new Vector3;_ray.closestPointToPoint(e,i),i.applyMatrix4(n);const l=r.ray.origin.distanceTo(i);if(l<r.near||l>r.far)return;o.push({distance:l,distanceToRay:Math.sqrt(a),point:i,index:t,face:null,faceIndex:null,barycoord:null,object:s})}}class VideoTexture extends Texture{constructor(e,t,i,n,r=LinearFilter,o=LinearFilter,s,a,l){super(e,t,i,n,r,o,s,a,l),this.isVideoTexture=!0,this.generateMipmaps=!1,this._requestVideoFrameCallbackId=0;const c=this;"requestVideoFrameCallback"in e&&(this._requestVideoFrameCallbackId=e.requestVideoFrameCallback((function t(){c.needsUpdate=!0,c._requestVideoFrameCallbackId=e.requestVideoFrameCallback(t)})))}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;!1==="requestVideoFrameCallback"in e&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}dispose(){0!==this._requestVideoFrameCallbackId&&(this.source.data.cancelVideoFrameCallback(this._requestVideoFrameCallbackId),this._requestVideoFrameCallbackId=0),super.dispose()}}class VideoFrameTexture extends VideoTexture{constructor(e,t,i,n,r,o,s,a){super({},e,t,i,n,r,o,s,a),this.isVideoFrameTexture=!0}update(){}clone(){return(new this.constructor).copy(this)}setFrame(e){this.image=e,this.needsUpdate=!0}}class FramebufferTexture extends Texture{constructor(e,t){super({width:e,height:t}),this.isFramebufferTexture=!0,this.magFilter=NearestFilter,this.minFilter=NearestFilter,this.generateMipmaps=!1,this.needsUpdate=!0}}class CompressedTexture extends Texture{constructor(e,t,i,n,r,o,s,a,l,c,u,h){super(null,o,s,a,l,c,n,r,u,h),this.isCompressedTexture=!0,this.image={width:t,height:i},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}class CompressedArrayTexture extends CompressedTexture{constructor(e,t,i,n,r,o){super(e,t,i,r,o),this.isCompressedArrayTexture=!0,this.image.depth=n,this.wrapR=ClampToEdgeWrapping,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class CompressedCubeTexture extends CompressedTexture{constructor(e,t,i){super(void 0,e[0].width,e[0].height,t,i,CubeReflectionMapping),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class CanvasTexture extends Texture{constructor(e,t,i,n,r,o,s,a,l){super(e,t,i,n,r,o,s,a,l),this.isCanvasTexture=!0,this.needsUpdate=!0}}class DepthTexture extends Texture{constructor(e,t,i=UnsignedIntType,n,r,o,s=NearestFilter,a=NearestFilter,l,c=DepthFormat,u=1){if(c!==DepthFormat&&c!==DepthStencilFormat)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:e,height:t,depth:u},n,r,o,s,a,c,i,l),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new Source(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}class CubeDepthTexture extends DepthTexture{constructor(e,t=UnsignedIntType,i=CubeReflectionMapping,n,r,o=NearestFilter,s=NearestFilter,a,l=DepthFormat){const c={width:e,height:e,depth:1},u=[c,c,c,c,c,c];super(e,e,t,i,n,r,o,s,a,l),this.image=u,this.isCubeDepthTexture=!0,this.isCubeTexture=!0}get images(){return this.image}set images(e){this.image=e}}class ExternalTexture extends Texture{constructor(e=null){super(),this.sourceTexture=e,this.isExternalTexture=!0}copy(e){return super.copy(e),this.sourceTexture=e.sourceTexture,this}}class CapsuleGeometry extends BufferGeometry{constructor(e=1,t=1,i=4,n=8,r=1){super(),this.type="CapsuleGeometry",this.parameters={radius:e,height:t,capSegments:i,radialSegments:n,heightSegments:r},t=Math.max(0,t),i=Math.max(1,Math.floor(i)),n=Math.max(3,Math.floor(n)),r=Math.max(1,Math.floor(r));const o=[],s=[],a=[],l=[],c=t/2,u=Math.PI/2*e,h=t,d=2*u+h,p=2*i+r,f=n+1,m=new Vector3,g=new Vector3;for(let _=0;_<=p;_++){let y=0,v=0,x=0,b=0;if(_<=i){const t=_/i,n=t*Math.PI/2;v=-c-e*Math.cos(n),x=e*Math.sin(n),b=-e*Math.cos(n),y=t*u}else if(_<=i+r){const n=(_-i)/r;v=n*t-c,x=e,b=0,y=u+n*h}else{const t=(_-i-r)/i,n=t*Math.PI/2;v=c+e*Math.sin(n),x=e*Math.cos(n),b=e*Math.sin(n),y=u+h+t*u}const T=Math.max(0,Math.min(1,y/d));let w=0;0===_?w=.5/n:_===p&&(w=-.5/n);for(let e=0;e<=n;e++){const t=e/n,i=t*Math.PI*2,r=Math.sin(i),o=Math.cos(i);g.x=-x*o,g.y=v,g.z=x*r,s.push(g.x,g.y,g.z),m.set(-x*o,b,x*r),m.normalize(),a.push(m.x,m.y,m.z),l.push(t+w,T)}if(_>0){const e=(_-1)*f;for(let t=0;t<n;t++){const i=e+t+1,n=_*f+t,r=_*f+t+1;o.push(e+t,i,n),o.push(i,r,n)}}}this.setIndex(o),this.setAttribute("position",new Float32BufferAttribute(s,3)),this.setAttribute("normal",new Float32BufferAttribute(a,3)),this.setAttribute("uv",new Float32BufferAttribute(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new CapsuleGeometry(e.radius,e.height,e.capSegments,e.radialSegments,e.heightSegments)}}class CircleGeometry extends BufferGeometry{constructor(e=1,t=32,i=0,n=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:n},t=Math.max(3,t);const r=[],o=[],s=[],a=[],l=new Vector3,c=new Vector2;o.push(0,0,0),s.push(0,0,1),a.push(.5,.5);for(let r=0,u=3;r<=t;r++,u+=3){const h=i+r/t*n;l.x=e*Math.cos(h),l.y=e*Math.sin(h),o.push(l.x,l.y,l.z),s.push(0,0,1),c.x=(o[u]/e+1)/2,c.y=(o[u+1]/e+1)/2,a.push(c.x,c.y)}for(let e=1;e<=t;e++)r.push(e,e+1,0);this.setIndex(r),this.setAttribute("position",new Float32BufferAttribute(o,3)),this.setAttribute("normal",new Float32BufferAttribute(s,3)),this.setAttribute("uv",new Float32BufferAttribute(a,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new CircleGeometry(e.radius,e.segments,e.thetaStart,e.thetaLength)}}class CylinderGeometry extends BufferGeometry{constructor(e=1,t=1,i=1,n=32,r=1,o=!1,s=0,a=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:n,heightSegments:r,openEnded:o,thetaStart:s,thetaLength:a};const l=this;n=Math.floor(n),r=Math.floor(r);const c=[],u=[],h=[],d=[];let p=0;const f=[],m=i/2;let g=0;function _(i){const r=p,o=new Vector2,f=new Vector3;let _=0;const y=!0===i?e:t,v=!0===i?1:-1;for(let e=1;e<=n;e++)u.push(0,m*v,0),h.push(0,v,0),d.push(.5,.5),p++;const x=p;for(let e=0;e<=n;e++){const t=e/n*a+s,i=Math.cos(t),r=Math.sin(t);f.x=y*r,f.y=m*v,f.z=y*i,u.push(f.x,f.y,f.z),h.push(0,v,0),o.x=.5*i+.5,o.y=.5*r*v+.5,d.push(o.x,o.y),p++}for(let e=0;e<n;e++){const t=r+e,n=x+e;!0===i?c.push(n,n+1,t):c.push(n+1,n,t),_+=3}l.addGroup(g,_,!0===i?1:2),g+=_}!function(){const o=new Vector3,_=new Vector3;let y=0;const v=(t-e)/i;for(let l=0;l<=r;l++){const c=[],g=l/r,y=g*(t-e)+e;for(let e=0;e<=n;e++){const t=e/n,r=t*a+s,l=Math.sin(r),f=Math.cos(r);_.x=y*l,_.y=-g*i+m,_.z=y*f,u.push(_.x,_.y,_.z),o.set(l,v,f).normalize(),h.push(o.x,o.y,o.z),d.push(t,1-g),c.push(p++)}f.push(c)}for(let i=0;i<n;i++)for(let n=0;n<r;n++){const o=f[n+1][i],s=f[n+1][i+1],a=f[n][i+1];(e>0||0!==n)&&(c.push(f[n][i],o,a),y+=3),(t>0||n!==r-1)&&(c.push(o,s,a),y+=3)}l.addGroup(g,y,0),g+=y}(),!1===o&&(e>0&&_(!0),t>0&&_(!1)),this.setIndex(c),this.setAttribute("position",new Float32BufferAttribute(u,3)),this.setAttribute("normal",new Float32BufferAttribute(h,3)),this.setAttribute("uv",new Float32BufferAttribute(d,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new CylinderGeometry(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class ConeGeometry extends CylinderGeometry{constructor(e=1,t=1,i=32,n=1,r=!1,o=0,s=2*Math.PI){super(0,e,t,i,n,r,o,s),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:n,openEnded:r,thetaStart:o,thetaLength:s}}static fromJSON(e){return new ConeGeometry(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class PolyhedronGeometry extends BufferGeometry{constructor(e=[],t=[],i=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:n};const r=[],o=[];function s(e,t,i,n){const r=n+1,o=[];for(let n=0;n<=r;n++){o[n]=[];const s=e.clone().lerp(i,n/r),a=t.clone().lerp(i,n/r),l=r-n;for(let e=0;e<=l;e++)o[n][e]=0===e&&n===r?s:s.clone().lerp(a,e/l)}for(let e=0;e<r;e++)for(let t=0;t<2*(r-e)-1;t++){const i=Math.floor(t/2);t%2==0?(a(o[e][i+1]),a(o[e+1][i]),a(o[e][i])):(a(o[e][i+1]),a(o[e+1][i+1]),a(o[e+1][i]))}}function a(e){r.push(e.x,e.y,e.z)}function l(t,i){const n=3*t;i.x=e[n+0],i.y=e[n+1],i.z=e[n+2]}function c(e,t,i,n){n<0&&1===e.x&&(o[t]=e.x-1),0===i.x&&0===i.z&&(o[t]=n/2/Math.PI+.5)}function u(e){return Math.atan2(e.z,-e.x)}!function(e){const i=new Vector3,n=new Vector3,r=new Vector3;for(let o=0;o<t.length;o+=3)l(t[o+0],i),l(t[o+1],n),l(t[o+2],r),s(i,n,r,e)}(n),function(e){const t=new Vector3;for(let i=0;i<r.length;i+=3)t.x=r[i+0],t.y=r[i+1],t.z=r[i+2],t.normalize().multiplyScalar(e),r[i+0]=t.x,r[i+1]=t.y,r[i+2]=t.z}(i),function(){const e=new Vector3;for(let i=0;i<r.length;i+=3){e.x=r[i+0],e.y=r[i+1],e.z=r[i+2];const n=u(e)/2/Math.PI+.5,s=(t=e,Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))/Math.PI+.5);o.push(n,1-s)}var t;(function(){const e=new Vector3,t=new Vector3,i=new Vector3,n=new Vector3,s=new Vector2,a=new Vector2,l=new Vector2;for(let h=0,d=0;h<r.length;h+=9,d+=6){e.set(r[h+0],r[h+1],r[h+2]),t.set(r[h+3],r[h+4],r[h+5]),i.set(r[h+6],r[h+7],r[h+8]),s.set(o[d+0],o[d+1]),a.set(o[d+2],o[d+3]),l.set(o[d+4],o[d+5]),n.copy(e).add(t).add(i).divideScalar(3);const p=u(n);c(s,d+0,e,p),c(a,d+2,t,p),c(l,d+4,i,p)}})(),function(){for(let e=0;e<o.length;e+=6){const t=o[e+0],i=o[e+2],n=o[e+4],r=Math.max(t,i,n),s=Math.min(t,i,n);r>.9&&s<.1&&(t<.2&&(o[e+0]+=1),i<.2&&(o[e+2]+=1),n<.2&&(o[e+4]+=1))}}()}(),this.setAttribute("position",new Float32BufferAttribute(r,3)),this.setAttribute("normal",new Float32BufferAttribute(r.slice(),3)),this.setAttribute("uv",new Float32BufferAttribute(o,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new PolyhedronGeometry(e.vertices,e.indices,e.radius,e.detail)}}class DodecahedronGeometry extends PolyhedronGeometry{constructor(e=1,t=0){const i=(1+Math.sqrt(5))/2,n=1/i;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-i,0,-n,i,0,n,-i,0,n,i,-n,-i,0,-n,i,0,n,-i,0,n,i,0,-i,0,-n,i,0,-n,-i,0,n,i,0,n],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new DodecahedronGeometry(e.radius,e.detail)}}const _v0$3=new Vector3,_v1$1=new Vector3,_normal=new Vector3,_triangle=new Triangle;class EdgesGeometry extends BufferGeometry{constructor(e=null,t=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:e,thresholdAngle:t},null!==e){const i=Math.pow(10,4),n=Math.cos(DEG2RAD*t),r=e.getIndex(),o=e.getAttribute("position"),s=r?r.count:o.count,a=[0,0,0],l=["a","b","c"],c=new Array(3),u={},h=[];for(let e=0;e<s;e+=3){r?(a[0]=r.getX(e),a[1]=r.getX(e+1),a[2]=r.getX(e+2)):(a[0]=e,a[1]=e+1,a[2]=e+2);const{a:t,b:s,c:d}=_triangle;if(t.fromBufferAttribute(o,a[0]),s.fromBufferAttribute(o,a[1]),d.fromBufferAttribute(o,a[2]),_triangle.getNormal(_normal),c[0]=`${Math.round(t.x*i)},${Math.round(t.y*i)},${Math.round(t.z*i)}`,c[1]=`${Math.round(s.x*i)},${Math.round(s.y*i)},${Math.round(s.z*i)}`,c[2]=`${Math.round(d.x*i)},${Math.round(d.y*i)},${Math.round(d.z*i)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let e=0;e<3;e++){const t=(e+1)%3,i=c[e],r=c[t],o=_triangle[l[e]],s=_triangle[l[t]],d=`${i}_${r}`,p=`${r}_${i}`;p in u&&u[p]?(_normal.dot(u[p].normal)<=n&&(h.push(o.x,o.y,o.z),h.push(s.x,s.y,s.z)),u[p]=null):d in u||(u[d]={index0:a[e],index1:a[t],normal:_normal.clone()})}}for(const e in u)if(u[e]){const{index0:t,index1:i}=u[e];_v0$3.fromBufferAttribute(o,t),_v1$1.fromBufferAttribute(o,i),h.push(_v0$3.x,_v0$3.y,_v0$3.z),h.push(_v1$1.x,_v1$1.y,_v1$1.z)}this.setAttribute("position",new Float32BufferAttribute(h,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}}class Curve{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){warn("Curve: .getPoint() not implemented.")}getPointAt(e,t){const i=this.getUtoTmapping(e);return this.getPoint(i,t)}getPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return t}getSpacedPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let i,n=this.getPoint(0),r=0;t.push(0);for(let o=1;o<=e;o++)i=this.getPoint(o/e),r+=i.distanceTo(n),t.push(r),n=i;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t=null){const i=this.getLengths();let n=0;const r=i.length;let o;o=t||e*i[r-1];let s,a=0,l=r-1;for(;a<=l;)if(n=Math.floor(a+(l-a)/2),s=i[n]-o,s<0)a=n+1;else{if(!(s>0)){l=n;break}l=n-1}if(n=l,i[n]===o)return n/(r-1);const c=i[n];return(n+(o-c)/(i[n+1]-c))/(r-1)}getTangent(e,t){const i=1e-4;let n=e-i,r=e+i;n<0&&(n=0),r>1&&(r=1);const o=this.getPoint(n),s=this.getPoint(r),a=t||(o.isVector2?new Vector2:new Vector3);return a.copy(s).sub(o).normalize(),a}getTangentAt(e,t){const i=this.getUtoTmapping(e);return this.getTangent(i,t)}computeFrenetFrames(e,t=!1){const i=new Vector3,n=[],r=[],o=[],s=new Vector3,a=new Matrix4;for(let t=0;t<=e;t++){n[t]=this.getTangentAt(t/e,new Vector3)}r[0]=new Vector3,o[0]=new Vector3;let l=Number.MAX_VALUE;const c=Math.abs(n[0].x),u=Math.abs(n[0].y),h=Math.abs(n[0].z);c<=l&&(l=c,i.set(1,0,0)),u<=l&&(l=u,i.set(0,1,0)),h<=l&&i.set(0,0,1),s.crossVectors(n[0],i).normalize(),r[0].crossVectors(n[0],s),o[0].crossVectors(n[0],r[0]);for(let t=1;t<=e;t++){if(r[t]=r[t-1].clone(),o[t]=o[t-1].clone(),s.crossVectors(n[t-1],n[t]),s.length()>Number.EPSILON){s.normalize();const e=Math.acos(clamp(n[t-1].dot(n[t]),-1,1));r[t].applyMatrix4(a.makeRotationAxis(s,e))}o[t].crossVectors(n[t],r[t])}if(!0===t){let t=Math.acos(clamp(r[0].dot(r[e]),-1,1));t/=e,n[0].dot(s.crossVectors(r[0],r[e]))>0&&(t=-t);for(let i=1;i<=e;i++)r[i].applyMatrix4(a.makeRotationAxis(n[i],t*i)),o[i].crossVectors(n[i],r[i])}return{tangents:n,normals:r,binormals:o}}clone(){return(new this.constructor).copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class EllipseCurve extends Curve{constructor(e=0,t=0,i=1,n=1,r=0,o=2*Math.PI,s=!1,a=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=n,this.aStartAngle=r,this.aEndAngle=o,this.aClockwise=s,this.aRotation=a}getPoint(e,t=new Vector2){const i=t,n=2*Math.PI;let r=this.aEndAngle-this.aStartAngle;const o=Math.abs(r)<Number.EPSILON;for(;r<0;)r+=n;for(;r>n;)r-=n;r<Number.EPSILON&&(r=o?0:n),!0!==this.aClockwise||o||(r===n?r=-n:r-=n);const s=this.aStartAngle+e*r;let a=this.aX+this.xRadius*Math.cos(s),l=this.aY+this.yRadius*Math.sin(s);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),i=a-this.aX,n=l-this.aY;a=i*e-n*t+this.aX,l=i*t+n*e+this.aY}return i.set(a,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}class ArcCurve extends EllipseCurve{constructor(e,t,i,n,r,o){super(e,t,i,i,n,r,o),this.isArcCurve=!0,this.type="ArcCurve"}}function CubicPoly(){let e=0,t=0,i=0,n=0;function r(r,o,s,a){e=r,t=s,i=-3*r+3*o-2*s-a,n=2*r-2*o+s+a}return{initCatmullRom:function(e,t,i,n,o){r(t,i,o*(i-e),o*(n-t))},initNonuniformCatmullRom:function(e,t,i,n,o,s,a){let l=(t-e)/o-(i-e)/(o+s)+(i-t)/s,c=(i-t)/s-(n-t)/(s+a)+(n-i)/a;l*=s,c*=s,r(t,i,l,c)},calc:function(r){const o=r*r;return e+t*r+i*o+n*(o*r)}}}const tmp=new Vector3,px=new CubicPoly,py=new CubicPoly,pz=new CubicPoly;class CatmullRomCurve3 extends Curve{constructor(e=[],t=!1,i="centripetal",n=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=i,this.tension=n}getPoint(e,t=new Vector3){const i=t,n=this.points,r=n.length,o=(r-(this.closed?0:1))*e;let s,a,l=Math.floor(o),c=o-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/r)+1)*r:0===c&&l===r-1&&(l=r-2,c=1),this.closed||l>0?s=n[(l-1)%r]:(tmp.subVectors(n[0],n[1]).add(n[0]),s=tmp);const u=n[l%r],h=n[(l+1)%r];if(this.closed||l+2<r?a=n[(l+2)%r]:(tmp.subVectors(n[r-1],n[r-2]).add(n[r-1]),a=tmp),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let t=Math.pow(s.distanceToSquared(u),e),i=Math.pow(u.distanceToSquared(h),e),n=Math.pow(h.distanceToSquared(a),e);i<1e-4&&(i=1),t<1e-4&&(t=i),n<1e-4&&(n=i),px.initNonuniformCatmullRom(s.x,u.x,h.x,a.x,t,i,n),py.initNonuniformCatmullRom(s.y,u.y,h.y,a.y,t,i,n),pz.initNonuniformCatmullRom(s.z,u.z,h.z,a.z,t,i,n)}else"catmullrom"===this.curveType&&(px.initCatmullRom(s.x,u.x,h.x,a.x,this.tension),py.initCatmullRom(s.y,u.y,h.y,a.y,this.tension),pz.initCatmullRom(s.z,u.z,h.z,a.z,this.tension));return i.set(px.calc(c),py.calc(c),pz.calc(c)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){this.points.push(e.points[t].clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){e.points.push(this.points[t].toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push((new Vector3).fromArray(i))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function CatmullRom(e,t,i,n,r){const o=.5*(n-t),s=.5*(r-i),a=e*e;return(2*i-2*n+o+s)*(e*a)+(-3*i+3*n-2*o-s)*a+o*e+i}function QuadraticBezierP0(e,t){const i=1-e;return i*i*t}function QuadraticBezierP1(e,t){return 2*(1-e)*e*t}function QuadraticBezierP2(e,t){return e*e*t}function QuadraticBezier(e,t,i,n){return QuadraticBezierP0(e,t)+QuadraticBezierP1(e,i)+QuadraticBezierP2(e,n)}function CubicBezierP0(e,t){const i=1-e;return i*i*i*t}function CubicBezierP1(e,t){const i=1-e;return 3*i*i*e*t}function CubicBezierP2(e,t){return 3*(1-e)*e*e*t}function CubicBezierP3(e,t){return e*e*e*t}function CubicBezier(e,t,i,n,r){return CubicBezierP0(e,t)+CubicBezierP1(e,i)+CubicBezierP2(e,n)+CubicBezierP3(e,r)}class CubicBezierCurve extends Curve{constructor(e=new Vector2,t=new Vector2,i=new Vector2,n=new Vector2){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=i,this.v3=n}getPoint(e,t=new Vector2){const i=t,n=this.v0,r=this.v1,o=this.v2,s=this.v3;return i.set(CubicBezier(e,n.x,r.x,o.x,s.x),CubicBezier(e,n.y,r.y,o.y,s.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class CubicBezierCurve3 extends Curve{constructor(e=new Vector3,t=new Vector3,i=new Vector3,n=new Vector3){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=i,this.v3=n}getPoint(e,t=new Vector3){const i=t,n=this.v0,r=this.v1,o=this.v2,s=this.v3;return i.set(CubicBezier(e,n.x,r.x,o.x,s.x),CubicBezier(e,n.y,r.y,o.y,s.y),CubicBezier(e,n.z,r.z,o.z,s.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class LineCurve extends Curve{constructor(e=new Vector2,t=new Vector2){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new Vector2){const i=t;return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new Vector2){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class LineCurve3 extends Curve{constructor(e=new Vector3,t=new Vector3){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=t}getPoint(e,t=new Vector3){const i=t;return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new Vector3){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class QuadraticBezierCurve extends Curve{constructor(e=new Vector2,t=new Vector2,i=new Vector2){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new Vector2){const i=t,n=this.v0,r=this.v1,o=this.v2;return i.set(QuadraticBezier(e,n.x,r.x,o.x),QuadraticBezier(e,n.y,r.y,o.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class QuadraticBezierCurve3 extends Curve{constructor(e=new Vector3,t=new Vector3,i=new Vector3){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new Vector3){const i=t,n=this.v0,r=this.v1,o=this.v2;return i.set(QuadraticBezier(e,n.x,r.x,o.x),QuadraticBezier(e,n.y,r.y,o.y),QuadraticBezier(e,n.z,r.z,o.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class SplineCurve extends Curve{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,t=new Vector2){const i=t,n=this.points,r=(n.length-1)*e,o=Math.floor(r),s=r-o,a=n[0===o?o:o-1],l=n[o],c=n[o>n.length-2?n.length-1:o+1],u=n[o>n.length-3?n.length-1:o+2];return i.set(CatmullRom(s,a.x,l.x,c.x,u.x),CatmullRom(s,a.y,l.y,c.y,u.y)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){this.points.push(e.points[t].clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){e.points.push(this.points[t].toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push((new Vector2).fromArray(i))}return this}}var Curves=Object.freeze({__proto__:null,ArcCurve:ArcCurve,CatmullRomCurve3:CatmullRomCurve3,CubicBezierCurve:CubicBezierCurve,CubicBezierCurve3:CubicBezierCurve3,EllipseCurve:EllipseCurve,LineCurve:LineCurve,LineCurve3:LineCurve3,QuadraticBezierCurve:QuadraticBezierCurve,QuadraticBezierCurve3:QuadraticBezierCurve3,SplineCurve:SplineCurve});class CurvePath extends Curve{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);if(!e.equals(t)){this.curves.push(new Curves[!0===e.isVector2?"LineCurve":"LineCurve3"](t,e))}return this}getPoint(e,t){const i=e*this.getLength(),n=this.getCurveLengths();let r=0;for(;r<n.length;){if(n[r]>=i){const e=n[r]-i,o=this.curves[r],s=o.getLength();return o.getPointAt(0===s?0:1-e/s,t)}r++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let i=0,n=this.curves.length;i<n;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let i;for(let n=0,r=this.curves;n<r.length;n++){const o=r[n],s=o.getPoints(o.isEllipseCurve?2*e:o.isLineCurve||o.isLineCurve3?1:o.isSplineCurve?e*o.points.length:e);for(let e=0;e<s.length;e++){const n=s[e];i&&i.equals(n)||(t.push(n),i=n)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){this.curves.push(e.curves[t].clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,i=this.curves.length;t<i;t++){e.curves.push(this.curves[t].toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const i=e.curves[t];this.curves.push((new Curves[i.type]).fromJSON(i))}return this}}class Path extends CurvePath{constructor(e){super(),this.type="Path",this.currentPoint=new Vector2,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const i=new LineCurve(this.currentPoint.clone(),new Vector2(e,t));return this.curves.push(i),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,i,n){const r=new QuadraticBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(i,n));return this.curves.push(r),this.currentPoint.set(i,n),this}bezierCurveTo(e,t,i,n,r,o){const s=new CubicBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(i,n),new Vector2(r,o));return this.curves.push(s),this.currentPoint.set(r,o),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),i=new SplineCurve(t);return this.curves.push(i),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,i,n,r,o){return this.absarc(e+this.currentPoint.x,t+this.currentPoint.y,i,n,r,o),this}absarc(e,t,i,n,r,o){return this.absellipse(e,t,i,i,n,r,o),this}ellipse(e,t,i,n,r,o,s,a){return this.absellipse(e+this.currentPoint.x,t+this.currentPoint.y,i,n,r,o,s,a),this}absellipse(e,t,i,n,r,o,s,a){const l=new EllipseCurve(e,t,i,n,r,o,s,a);if(this.curves.length>0){const e=l.getPoint(0);e.equals(this.currentPoint)||this.lineTo(e.x,e.y)}this.curves.push(l);const c=l.getPoint(1);return this.currentPoint.copy(c),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class Shape extends Path{constructor(e){super(e),this.uuid=generateUUID$1(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let i=0,n=this.holes.length;i<n;i++)t[i]=this.holes[i].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){this.holes.push(e.holes[t].clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,i=this.holes.length;t<i;t++){e.holes.push(this.holes[t].toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){const i=e.holes[t];this.holes.push((new Path).fromJSON(i))}return this}}function earcut(e,t,i=2){const n=t&&t.length,r=n?t[0]*i:e.length;let o=linkedList(e,0,r,i,!0);const s=[];if(!o||o.next===o.prev)return s;let a,l,c;if(n&&(o=eliminateHoles(e,t,o,i)),e.length>80*i){a=e[0],l=e[1];let t=a,n=l;for(let o=i;o<r;o+=i){const i=e[o],r=e[o+1];i<a&&(a=i),r<l&&(l=r),i>t&&(t=i),r>n&&(n=r)}c=Math.max(t-a,n-l),c=0!==c?32767/c:0}return earcutLinked(o,s,i,a,l,c,0),s}function linkedList(e,t,i,n,r){let o;if(r===signedArea(e,t,i,n)>0)for(let r=t;r<i;r+=n)o=insertNode(r/n|0,e[r],e[r+1],o);else for(let r=i-n;r>=t;r-=n)o=insertNode(r/n|0,e[r],e[r+1],o);return o&&equals(o,o.next)&&(removeNode(o),o=o.next),o}function filterPoints(e,t){if(!e)return e;t||(t=e);let i,n=e;do{if(i=!1,n.steiner||!equals(n,n.next)&&0!==area(n.prev,n,n.next))n=n.next;else{if(removeNode(n),n=t=n.prev,n===n.next)break;i=!0}}while(i||n!==t);return t}function earcutLinked(e,t,i,n,r,o,s){if(!e)return;!s&&o&&indexCurve(e,n,r,o);let a=e;for(;e.prev!==e.next;){const l=e.prev,c=e.next;if(o?isEarHashed(e,n,r,o):isEar(e))t.push(l.i,e.i,c.i),removeNode(e),e=c.next,a=c.next;else if((e=c)===a){s?1===s?earcutLinked(e=cureLocalIntersections(filterPoints(e),t),t,i,n,r,o,2):2===s&&splitEarcut(e,t,i,n,r,o):earcutLinked(filterPoints(e),t,i,n,r,o,1);break}}}function isEar(e){const t=e.prev,i=e,n=e.next;if(area(t,i,n)>=0)return!1;const r=t.x,o=i.x,s=n.x,a=t.y,l=i.y,c=n.y,u=Math.min(r,o,s),h=Math.min(a,l,c),d=Math.max(r,o,s),p=Math.max(a,l,c);let f=n.next;for(;f!==t;){if(f.x>=u&&f.x<=d&&f.y>=h&&f.y<=p&&pointInTriangleExceptFirst(r,a,o,l,s,c,f.x,f.y)&&area(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function isEarHashed(e,t,i,n){const r=e.prev,o=e,s=e.next;if(area(r,o,s)>=0)return!1;const a=r.x,l=o.x,c=s.x,u=r.y,h=o.y,d=s.y,p=Math.min(a,l,c),f=Math.min(u,h,d),m=Math.max(a,l,c),g=Math.max(u,h,d),_=zOrder(p,f,t,i,n),y=zOrder(m,g,t,i,n);let v=e.prevZ,x=e.nextZ;for(;v&&v.z>=_&&x&&x.z<=y;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==s&&pointInTriangleExceptFirst(a,u,l,h,c,d,v.x,v.y)&&area(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==s&&pointInTriangleExceptFirst(a,u,l,h,c,d,x.x,x.y)&&area(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=_;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==s&&pointInTriangleExceptFirst(a,u,l,h,c,d,v.x,v.y)&&area(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==s&&pointInTriangleExceptFirst(a,u,l,h,c,d,x.x,x.y)&&area(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function cureLocalIntersections(e,t){let i=e;do{const n=i.prev,r=i.next.next;!equals(n,r)&&intersects$2(n,i,i.next,r)&&locallyInside(n,r)&&locallyInside(r,n)&&(t.push(n.i,i.i,r.i),removeNode(i),removeNode(i.next),i=e=r),i=i.next}while(i!==e);return filterPoints(i)}function splitEarcut(e,t,i,n,r,o){let s=e;do{let e=s.next.next;for(;e!==s.prev;){if(s.i!==e.i&&isValidDiagonal(s,e)){let a=splitPolygon(s,e);return s=filterPoints(s,s.next),a=filterPoints(a,a.next),earcutLinked(s,t,i,n,r,o,0),void earcutLinked(a,t,i,n,r,o,0)}e=e.next}s=s.next}while(s!==e)}function eliminateHoles(e,t,i,n){const r=[];for(let i=0,o=t.length;i<o;i++){const s=linkedList(e,t[i]*n,i<o-1?t[i+1]*n:e.length,n,!1);s===s.next&&(s.steiner=!0),r.push(getLeftmost(s))}r.sort(compareXYSlope);for(let e=0;e<r.length;e++)i=eliminateHole(r[e],i);return i}function compareXYSlope(e,t){let i=e.x-t.x;if(0===i&&(i=e.y-t.y,0===i)){i=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)}return i}function eliminateHole(e,t){const i=findHoleBridge(e,t);if(!i)return t;const n=splitPolygon(i,e);return filterPoints(n,n.next),filterPoints(i,i.next)}function findHoleBridge(e,t){let i=t;const n=e.x,r=e.y;let o,s=-1/0;if(equals(e,i))return i;do{if(equals(e,i.next))return i.next;if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const e=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=n&&e>s&&(s=e,o=i.x<i.next.x?i:i.next,e===n))return o}i=i.next}while(i!==t);if(!o)return null;const a=o,l=o.x,c=o.y;let u=1/0;i=o;do{if(n>=i.x&&i.x>=l&&n!==i.x&&pointInTriangle(r<c?n:s,r,l,c,r<c?s:n,r,i.x,i.y)){const t=Math.abs(r-i.y)/(n-i.x);locallyInside(i,e)&&(t<u||t===u&&(i.x>o.x||i.x===o.x&&sectorContainsSector(o,i)))&&(o=i,u=t)}i=i.next}while(i!==a);return o}function sectorContainsSector(e,t){return area(e.prev,e,t.prev)<0&&area(t.next,e,e.next)<0}function indexCurve(e,t,i,n){let r=e;do{0===r.z&&(r.z=zOrder(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,sortLinked(r)}function sortLinked(e){let t,i=1;do{let n,r=e;e=null;let o=null;for(t=0;r;){t++;let s=r,a=0;for(let e=0;e<i&&(a++,s=s.nextZ,s);e++);let l=i;for(;a>0||l>0&&s;)0!==a&&(0===l||!s||r.z<=s.z)?(n=r,r=r.nextZ,a--):(n=s,s=s.nextZ,l--),o?o.nextZ=n:e=n,n.prevZ=o,o=n;r=s}o.nextZ=null,i*=2}while(t>1);return e}function zOrder(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function getLeftmost(e){let t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function pointInTriangle(e,t,i,n,r,o,s,a){return(r-s)*(t-a)>=(e-s)*(o-a)&&(e-s)*(n-a)>=(i-s)*(t-a)&&(i-s)*(o-a)>=(r-s)*(n-a)}function pointInTriangleExceptFirst(e,t,i,n,r,o,s,a){return!(e===s&&t===a)&&pointInTriangle(e,t,i,n,r,o,s,a)}function isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!intersectsPolygon(e,t)&&(locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,t)&&(area(e.prev,e,t.prev)||area(e,t.prev,t))||equals(e,t)&&area(e.prev,e,e.next)>0&&area(t.prev,t,t.next)>0)}function area(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function equals(e,t){return e.x===t.x&&e.y===t.y}function intersects$2(e,t,i,n){const r=sign(area(e,t,i)),o=sign(area(e,t,n)),s=sign(area(i,n,e)),a=sign(area(i,n,t));return r!==o&&s!==a||(!(0!==r||!onSegment(e,i,t))||(!(0!==o||!onSegment(e,n,t))||(!(0!==s||!onSegment(i,e,n))||!(0!==a||!onSegment(i,t,n)))))}function onSegment(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function sign(e){return e>0?1:e<0?-1:0}function intersectsPolygon(e,t){let i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&intersects$2(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}function locallyInside(e,t){return area(e.prev,e,e.next)<0?area(e,t,e.next)>=0&&area(e,e.prev,t)>=0:area(e,t,e.prev)<0||area(e,e.next,t)<0}function middleInside(e,t){let i=e,n=!1;const r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}function splitPolygon(e,t){const i=createNode$1(e.i,e.x,e.y),n=createNode$1(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function insertNode(e,t,i,n){const r=createNode$1(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function createNode$1(e,t,i){return{i:e,x:t,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function signedArea(e,t,i,n){let r=0;for(let o=t,s=i-n;o<i;o+=n)r+=(e[s]-e[o])*(e[o+1]+e[s+1]),s=o;return r}class Earcut{static triangulate(e,t,i=2){return earcut(e,t,i)}}class ShapeUtils{static area(e){const t=e.length;let i=0;for(let n=t-1,r=0;r<t;n=r++)i+=e[n].x*e[r].y-e[r].x*e[n].y;return.5*i}static isClockWise(e){return ShapeUtils.area(e)<0}static triangulateShape(e,t){const i=[],n=[],r=[];removeDupEndPts(e),addContour(i,e);let o=e.length;t.forEach(removeDupEndPts);for(let e=0;e<t.length;e++)n.push(o),o+=t[e].length,addContour(i,t[e]);const s=Earcut.triangulate(i,n);for(let e=0;e<s.length;e+=3)r.push(s.slice(e,e+3));return r}}function removeDupEndPts(e){const t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function addContour(e,t){for(let i=0;i<t.length;i++)e.push(t[i].x),e.push(t[i].y)}class ExtrudeGeometry extends BufferGeometry{constructor(e=new Shape([new Vector2(.5,.5),new Vector2(-.5,.5),new Vector2(-.5,-.5),new Vector2(.5,-.5)]),t={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const i=this,n=[],r=[];for(let t=0,i=e.length;t<i;t++){o(e[t])}function o(e){const o=[],s=void 0!==t.curveSegments?t.curveSegments:12,a=void 0!==t.steps?t.steps:1,l=void 0!==t.depth?t.depth:1;let c=void 0===t.bevelEnabled||t.bevelEnabled,u=void 0!==t.bevelThickness?t.bevelThickness:.2,h=void 0!==t.bevelSize?t.bevelSize:u-.1,d=void 0!==t.bevelOffset?t.bevelOffset:0,p=void 0!==t.bevelSegments?t.bevelSegments:3;const f=t.extrudePath,m=void 0!==t.UVGenerator?t.UVGenerator:WorldUVGenerator;let g,_,y,v,x,b=!1;if(f){g=f.getSpacedPoints(a),b=!0,c=!1;_=f.computeFrenetFrames(a,!!f.isCatmullRomCurve3&&f.closed),y=new Vector3,v=new Vector3,x=new Vector3}c||(p=0,u=0,h=0,d=0);const T=e.extractPoints(s);let w=T.shape;const E=T.holes;if(!ShapeUtils.isClockWise(w)){w=w.reverse();for(let e=0,t=E.length;e<t;e++){const t=E[e];ShapeUtils.isClockWise(t)&&(E[e]=t.reverse())}}function S(e){const t=1e-10*1e-10;let i=e[0];for(let n=1;n<=e.length;n++){const r=n%e.length,o=e[r],s=o.x-i.x,a=o.y-i.y,l=s*s+a*a,c=Math.max(Math.abs(o.x),Math.abs(o.y),Math.abs(i.x),Math.abs(i.y));l<=t*c*c?(e.splice(r,1),n--):i=o}}S(w),E.forEach(S);const A=E.length,M=w;for(let e=0;e<A;e++){w=w.concat(E[e])}function I(e,t,i){return t||error("ExtrudeGeometry: vec does not exist"),e.clone().addScaledVector(t,i)}const C=w.length;function P(e,t,i){let n,r,o;const s=e.x-t.x,a=e.y-t.y,l=i.x-e.x,c=i.y-e.y,u=s*s+a*a;if(Math.abs(s*c-a*l)>Number.EPSILON){const h=Math.sqrt(u),d=Math.sqrt(l*l+c*c),p=t.x-a/h,f=t.y+s/h,m=((i.x-c/d-p)*c-(i.y+l/d-f)*l)/(s*c-a*l);n=p+s*m-e.x,r=f+a*m-e.y;const g=n*n+r*r;if(g<=2)return new Vector2(n,r);o=Math.sqrt(g/2)}else{let e=!1;s>Number.EPSILON?l>Number.EPSILON&&(e=!0):s<-Number.EPSILON?l<-Number.EPSILON&&(e=!0):Math.sign(a)===Math.sign(c)&&(e=!0),e?(n=-a,r=s,o=Math.sqrt(u)):(n=s,r=a,o=Math.sqrt(u/2))}return new Vector2(n/o,r/o)}const L=[];for(let e=0,t=M.length,i=t-1,n=e+1;e<t;e++,i++,n++)i===t&&(i=0),n===t&&(n=0),L[e]=P(M[e],M[i],M[n]);const R=[];let O,D,B=L.concat();for(let e=0,t=A;e<t;e++){const t=E[e];O=[];for(let e=0,i=t.length,n=i-1,r=e+1;e<i;e++,n++,r++)n===i&&(n=0),r===i&&(r=0),O[e]=P(t[e],t[n],t[r]);R.push(O),B=B.concat(O)}if(0===p)D=ShapeUtils.triangulateShape(M,E);else{const e=[],t=[];for(let i=0;i<p;i++){const n=i/p,r=u*Math.cos(n*Math.PI/2),o=h*Math.sin(n*Math.PI/2)+d;for(let t=0,i=M.length;t<i;t++){const i=I(M[t],L[t],o);U(i.x,i.y,-r),0===n&&e.push(i)}for(let e=0,i=A;e<i;e++){const i=E[e];O=R[e];const s=[];for(let e=0,t=i.length;e<t;e++){const t=I(i[e],O[e],o);U(t.x,t.y,-r),0===n&&s.push(t)}0===n&&t.push(s)}}D=ShapeUtils.triangulateShape(e,t)}const F=D.length,N=h+d;for(let e=0;e<C;e++){const t=c?I(w[e],B[e],N):w[e];b?(v.copy(_.normals[0]).multiplyScalar(t.x),y.copy(_.binormals[0]).multiplyScalar(t.y),x.copy(g[0]).add(v).add(y),U(x.x,x.y,x.z)):U(t.x,t.y,0)}for(let e=1;e<=a;e++)for(let t=0;t<C;t++){const i=c?I(w[t],B[t],N):w[t];b?(v.copy(_.normals[e]).multiplyScalar(i.x),y.copy(_.binormals[e]).multiplyScalar(i.y),x.copy(g[e]).add(v).add(y),U(x.x,x.y,x.z)):U(i.x,i.y,l/a*e)}for(let e=p-1;e>=0;e--){const t=e/p,i=u*Math.cos(t*Math.PI/2),n=h*Math.sin(t*Math.PI/2)+d;for(let e=0,t=M.length;e<t;e++){const t=I(M[e],L[e],n);U(t.x,t.y,l+i)}for(let e=0,t=E.length;e<t;e++){const t=E[e];O=R[e];for(let e=0,r=t.length;e<r;e++){const r=I(t[e],O[e],n);b?U(r.x,r.y+g[a-1].y,g[a-1].x+i):U(r.x,r.y,l+i)}}}function k(e,t){let i=e.length;for(;--i>=0;){const n=i;let r=i-1;r<0&&(r=e.length-1);for(let e=0,i=a+2*p;e<i;e++){const i=C*e,o=C*(e+1);V(t+n+i,t+r+i,t+r+o,t+n+o)}}}function U(e,t,i){o.push(e),o.push(t),o.push(i)}function z(e,t,r){G(e),G(t),G(r);const o=n.length/3,s=m.generateTopUV(i,n,o-3,o-2,o-1);j(s[0]),j(s[1]),j(s[2])}function V(e,t,r,o){G(e),G(t),G(o),G(t),G(r),G(o);const s=n.length/3,a=m.generateSideWallUV(i,n,s-6,s-3,s-2,s-1);j(a[0]),j(a[1]),j(a[3]),j(a[1]),j(a[2]),j(a[3])}function G(e){n.push(o[3*e+0]),n.push(o[3*e+1]),n.push(o[3*e+2])}function j(e){r.push(e.x),r.push(e.y)}!function(){const e=n.length/3;if(c){let e=0,t=C*e;for(let e=0;e<F;e++){const i=D[e];z(i[2]+t,i[1]+t,i[0]+t)}e=a+2*p,t=C*e;for(let e=0;e<F;e++){const i=D[e];z(i[0]+t,i[1]+t,i[2]+t)}}else{for(let e=0;e<F;e++){const t=D[e];z(t[2],t[1],t[0])}for(let e=0;e<F;e++){const t=D[e];z(t[0]+C*a,t[1]+C*a,t[2]+C*a)}}i.addGroup(e,n.length/3-e,0)}(),function(){const e=n.length/3;let t=0;k(M,t),t+=M.length;for(let e=0,i=E.length;e<i;e++){const i=E[e];k(i,t),t+=i.length}i.addGroup(e,n.length/3-e,1)}()}this.setAttribute("position",new Float32BufferAttribute(n,3)),this.setAttribute("uv",new Float32BufferAttribute(r,2)),this.computeVertexNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return toJSON$1(this.parameters.shapes,this.parameters.options,e)}static fromJSON(e,t){const i=[];for(let n=0,r=e.shapes.length;n<r;n++){i.push(t[e.shapes[n]])}const n=e.options.extrudePath;return void 0!==n&&(e.options.extrudePath=(new Curves[n.type]).fromJSON(n)),new ExtrudeGeometry(i,e.options)}}const WorldUVGenerator={generateTopUV:function(e,t,i,n,r){const o=t[3*n],s=t[3*n+1],a=t[3*r],l=t[3*r+1];return[new Vector2(t[3*i],t[3*i+1]),new Vector2(o,s),new Vector2(a,l)]},generateSideWallUV:function(e,t,i,n,r,o){const s=t[3*i],a=t[3*i+1],l=t[3*i+2],c=t[3*n],u=t[3*n+1],h=t[3*n+2],d=t[3*r],p=t[3*r+1],f=t[3*r+2],m=t[3*o],g=t[3*o+1],_=t[3*o+2];return Math.abs(a-u)<Math.abs(s-c)?[new Vector2(s,1-l),new Vector2(c,1-h),new Vector2(d,1-f),new Vector2(m,1-_)]:[new Vector2(a,1-l),new Vector2(u,1-h),new Vector2(p,1-f),new Vector2(g,1-_)]}};function toJSON$1(e,t,i){if(i.shapes=[],Array.isArray(e))for(let t=0,n=e.length;t<n;t++){i.shapes.push(e[t].uuid)}else i.shapes.push(e.uuid);return i.options=Object.assign({},t),void 0!==t.extrudePath&&(i.options.extrudePath=t.extrudePath.toJSON()),i}class IcosahedronGeometry extends PolyhedronGeometry{constructor(e=1,t=0){const i=(1+Math.sqrt(5))/2;super([-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new IcosahedronGeometry(e.radius,e.detail)}}class LatheGeometry extends BufferGeometry{constructor(e=[new Vector2(0,-.5),new Vector2(.5,0),new Vector2(0,.5)],t=12,i=0,n=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:n},t=Math.floor(t),n=clamp(n,0,2*Math.PI);const r=[],o=[],s=[],a=[],l=[],c=1/t,u=new Vector3,h=new Vector2,d=new Vector3,p=new Vector3,f=new Vector3;let m=0,g=0;for(let t=0;t<=e.length-1;t++)switch(t){case 0:m=e[t+1].x-e[t].x,g=e[t+1].y-e[t].y,d.x=1*g,d.y=-m,d.z=0*g,f.copy(d),d.normalize(),a.push(d.x,d.y,d.z);break;case e.length-1:a.push(f.x,f.y,f.z);break;default:m=e[t+1].x-e[t].x,g=e[t+1].y-e[t].y,d.x=1*g,d.y=-m,d.z=0*g,p.copy(d),d.x+=f.x,d.y+=f.y,d.z+=f.z,d.normalize(),a.push(d.x,d.y,d.z),f.copy(p)}for(let r=0;r<=t;r++){const d=i+r*c*n,p=Math.sin(d),f=Math.cos(d);for(let i=0;i<=e.length-1;i++){u.x=e[i].x*p,u.y=e[i].y,u.z=e[i].x*f,o.push(u.x,u.y,u.z),h.x=r/t,h.y=i/(e.length-1),s.push(h.x,h.y);l.push(a[3*i+0]*p,a[3*i+1],a[3*i+0]*f)}}for(let i=0;i<t;i++)for(let t=0;t<e.length-1;t++){const n=t+i*e.length,o=n+e.length,s=n+e.length+1,a=n+1;r.push(n,o,a),r.push(s,a,o)}this.setIndex(r),this.setAttribute("position",new Float32BufferAttribute(o,3)),this.setAttribute("uv",new Float32BufferAttribute(s,2)),this.setAttribute("normal",new Float32BufferAttribute(l,3))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new LatheGeometry(e.points,e.segments,e.phiStart,e.phiLength)}}class OctahedronGeometry extends PolyhedronGeometry{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new OctahedronGeometry(e.radius,e.detail)}}class PlaneGeometry extends BufferGeometry{constructor(e=1,t=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:n};const r=e/2,o=t/2,s=Math.floor(i),a=Math.floor(n),l=s+1,c=a+1,u=e/s,h=t/a,d=[],p=[],f=[],m=[];for(let e=0;e<c;e++){const t=e*h-o;for(let i=0;i<l;i++){p.push(i*u-r,-t,0),f.push(0,0,1),m.push(i/s),m.push(1-e/a)}}for(let e=0;e<a;e++)for(let t=0;t<s;t++){const i=t+l*(e+1),n=t+1+l*(e+1),r=t+1+l*e;d.push(t+l*e,i,r),d.push(i,n,r)}this.setIndex(d),this.setAttribute("position",new Float32BufferAttribute(p,3)),this.setAttribute("normal",new Float32BufferAttribute(f,3)),this.setAttribute("uv",new Float32BufferAttribute(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new PlaneGeometry(e.width,e.height,e.widthSegments,e.heightSegments)}}class RingGeometry extends BufferGeometry{constructor(e=.5,t=1,i=32,n=1,r=0,o=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:n,thetaStart:r,thetaLength:o},i=Math.max(3,i);const s=[],a=[],l=[],c=[];let u=e;const h=(t-e)/(n=Math.max(1,n)),d=new Vector3,p=new Vector2;for(let e=0;e<=n;e++){for(let e=0;e<=i;e++){const n=r+e/i*o;d.x=u*Math.cos(n),d.y=u*Math.sin(n),a.push(d.x,d.y,d.z),l.push(0,0,1),p.x=(d.x/t+1)/2,p.y=(d.y/t+1)/2,c.push(p.x,p.y)}u+=h}for(let e=0;e<n;e++){const t=e*(i+1);for(let e=0;e<i;e++){const n=e+t,r=n+i+1,o=n+i+2,a=n+1;s.push(n,r,a),s.push(r,o,a)}}this.setIndex(s),this.setAttribute("position",new Float32BufferAttribute(a,3)),this.setAttribute("normal",new Float32BufferAttribute(l,3)),this.setAttribute("uv",new Float32BufferAttribute(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new RingGeometry(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength)}}class ShapeGeometry extends BufferGeometry{constructor(e=new Shape([new Vector2(0,.5),new Vector2(-.5,-.5),new Vector2(.5,-.5)]),t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const i=[],n=[],r=[],o=[];let s=0,a=0;if(!1===Array.isArray(e))l(e);else for(let t=0;t<e.length;t++)l(e[t]),this.addGroup(s,a,t),s+=a,a=0;function l(e){const s=n.length/3,l=e.extractPoints(t);let c=l.shape;const u=l.holes;!1===ShapeUtils.isClockWise(c)&&(c=c.reverse());for(let e=0,t=u.length;e<t;e++){const t=u[e];!0===ShapeUtils.isClockWise(t)&&(u[e]=t.reverse())}const h=ShapeUtils.triangulateShape(c,u);for(let e=0,t=u.length;e<t;e++){c=c.concat(u[e])}for(let e=0,t=c.length;e<t;e++){const t=c[e];n.push(t.x,t.y,0),r.push(0,0,1),o.push(t.x,t.y)}for(let e=0,t=h.length;e<t;e++){const t=h[e];i.push(t[0]+s,t[1]+s,t[2]+s),a+=3}}this.setIndex(i),this.setAttribute("position",new Float32BufferAttribute(n,3)),this.setAttribute("normal",new Float32BufferAttribute(r,3)),this.setAttribute("uv",new Float32BufferAttribute(o,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return toJSON(this.parameters.shapes,e)}static fromJSON(e,t){const i=[];for(let n=0,r=e.shapes.length;n<r;n++){i.push(t[e.shapes[n]])}return new ShapeGeometry(i,e.curveSegments)}}function toJSON(e,t){if(t.shapes=[],Array.isArray(e))for(let i=0,n=e.length;i<n;i++){t.shapes.push(e[i].uuid)}else t.shapes.push(e.uuid);return t}class SphereGeometry extends BufferGeometry{constructor(e=1,t=32,i=16,n=0,r=2*Math.PI,o=0,s=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:n,phiLength:r,thetaStart:o,thetaLength:s},t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));const a=Math.min(o+s,Math.PI);let l=0;const c=[],u=new Vector3,h=new Vector3,d=[],p=[],f=[],m=[];for(let d=0;d<=i;d++){const g=[],_=d/i;let y=0;0===d&&0===o?y=.5/t:d===i&&a===Math.PI&&(y=-.5/t);for(let i=0;i<=t;i++){const a=i/t;u.x=-e*Math.cos(n+a*r)*Math.sin(o+_*s),u.y=e*Math.cos(o+_*s),u.z=e*Math.sin(n+a*r)*Math.sin(o+_*s),p.push(u.x,u.y,u.z),h.copy(u).normalize(),f.push(h.x,h.y,h.z),m.push(a+y,1-_),g.push(l++)}c.push(g)}for(let e=0;e<i;e++)for(let n=0;n<t;n++){const t=c[e][n],r=c[e+1][n],s=c[e+1][n+1];(0!==e||o>0)&&d.push(c[e][n+1],t,s),(e!==i-1||a<Math.PI)&&d.push(t,r,s)}this.setIndex(d),this.setAttribute("position",new Float32BufferAttribute(p,3)),this.setAttribute("normal",new Float32BufferAttribute(f,3)),this.setAttribute("uv",new Float32BufferAttribute(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new SphereGeometry(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class TetrahedronGeometry extends PolyhedronGeometry{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new TetrahedronGeometry(e.radius,e.detail)}}class TorusGeometry extends BufferGeometry{constructor(e=1,t=.4,i=12,n=48,r=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:n,arc:r},i=Math.floor(i),n=Math.floor(n);const o=[],s=[],a=[],l=[],c=new Vector3,u=new Vector3,h=new Vector3;for(let o=0;o<=i;o++)for(let d=0;d<=n;d++){const p=d/n*r,f=o/i*Math.PI*2;u.x=(e+t*Math.cos(f))*Math.cos(p),u.y=(e+t*Math.cos(f))*Math.sin(p),u.z=t*Math.sin(f),s.push(u.x,u.y,u.z),c.x=e*Math.cos(p),c.y=e*Math.sin(p),h.subVectors(u,c).normalize(),a.push(h.x,h.y,h.z),l.push(d/n),l.push(o/i)}for(let e=1;e<=i;e++)for(let t=1;t<=n;t++){const i=(n+1)*(e-1)+t-1,r=(n+1)*(e-1)+t,s=(n+1)*e+t;o.push((n+1)*e+t-1,i,s),o.push(i,r,s)}this.setIndex(o),this.setAttribute("position",new Float32BufferAttribute(s,3)),this.setAttribute("normal",new Float32BufferAttribute(a,3)),this.setAttribute("uv",new Float32BufferAttribute(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new TorusGeometry(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc)}}class TorusKnotGeometry extends BufferGeometry{constructor(e=1,t=.4,i=64,n=8,r=2,o=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:n,p:r,q:o},i=Math.floor(i),n=Math.floor(n);const s=[],a=[],l=[],c=[],u=new Vector3,h=new Vector3,d=new Vector3,p=new Vector3,f=new Vector3,m=new Vector3,g=new Vector3;for(let s=0;s<=i;++s){const y=s/i*r*Math.PI*2;_(y,r,o,e,d),_(y+.01,r,o,e,p),m.subVectors(p,d),g.addVectors(p,d),f.crossVectors(m,g),g.crossVectors(f,m),f.normalize(),g.normalize();for(let e=0;e<=n;++e){const r=e/n*Math.PI*2,o=-t*Math.cos(r),p=t*Math.sin(r);u.x=d.x+(o*g.x+p*f.x),u.y=d.y+(o*g.y+p*f.y),u.z=d.z+(o*g.z+p*f.z),a.push(u.x,u.y,u.z),h.subVectors(u,d).normalize(),l.push(h.x,h.y,h.z),c.push(s/i),c.push(e/n)}}for(let e=1;e<=i;e++)for(let t=1;t<=n;t++){const i=(n+1)*e+(t-1),r=(n+1)*e+t,o=(n+1)*(e-1)+t;s.push((n+1)*(e-1)+(t-1),i,o),s.push(i,r,o)}function _(e,t,i,n,r){const o=Math.cos(e),s=Math.sin(e),a=i/t*e,l=Math.cos(a);r.x=n*(2+l)*.5*o,r.y=n*(2+l)*s*.5,r.z=n*Math.sin(a)*.5}this.setIndex(s),this.setAttribute("position",new Float32BufferAttribute(a,3)),this.setAttribute("normal",new Float32BufferAttribute(l,3)),this.setAttribute("uv",new Float32BufferAttribute(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new TorusKnotGeometry(e.radius,e.tube,e.tubularSegments,e.radialSegments,e.p,e.q)}}class TubeGeometry extends BufferGeometry{constructor(e=new QuadraticBezierCurve3(new Vector3(-1,-1,0),new Vector3(-1,1,0),new Vector3(1,1,0)),t=64,i=1,n=8,r=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:n,closed:r};const o=e.computeFrenetFrames(t,r);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals;const s=new Vector3,a=new Vector3,l=new Vector2;let c=new Vector3;const u=[],h=[],d=[],p=[];function f(r){c=e.getPointAt(r/t,c);const l=o.normals[r],d=o.binormals[r];for(let e=0;e<=n;e++){const t=e/n*Math.PI*2,r=Math.sin(t),o=-Math.cos(t);a.x=o*l.x+r*d.x,a.y=o*l.y+r*d.y,a.z=o*l.z+r*d.z,a.normalize(),h.push(a.x,a.y,a.z),s.x=c.x+i*a.x,s.y=c.y+i*a.y,s.z=c.z+i*a.z,u.push(s.x,s.y,s.z)}}!function(){for(let e=0;e<t;e++)f(e);f(!1===r?t:0),function(){for(let e=0;e<=t;e++)for(let i=0;i<=n;i++)l.x=e/t,l.y=i/n,d.push(l.x,l.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=n;t++){const i=(n+1)*e+(t-1),r=(n+1)*e+t,o=(n+1)*(e-1)+t;p.push((n+1)*(e-1)+(t-1),i,o),p.push(i,r,o)}}()}(),this.setIndex(p),this.setAttribute("position",new Float32BufferAttribute(u,3)),this.setAttribute("normal",new Float32BufferAttribute(h,3)),this.setAttribute("uv",new Float32BufferAttribute(d,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return e.path=this.parameters.path.toJSON(),e}static fromJSON(e){return new TubeGeometry((new Curves[e.path.type]).fromJSON(e.path),e.tubularSegments,e.radius,e.radialSegments,e.closed)}}class WireframeGeometry extends BufferGeometry{constructor(e=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:e},null!==e){const t=[],i=new Set,n=new Vector3,r=new Vector3;if(null!==e.index){const o=e.attributes.position,s=e.index;let a=e.groups;0===a.length&&(a=[{start:0,count:s.count,materialIndex:0}]);for(let e=0,l=a.length;e<l;++e){const l=a[e],c=l.start;for(let e=c,a=c+l.count;e<a;e+=3)for(let a=0;a<3;a++){const l=s.getX(e+a),c=s.getX(e+(a+1)%3);n.fromBufferAttribute(o,l),r.fromBufferAttribute(o,c),!0===isUniqueEdge(n,r,i)&&(t.push(n.x,n.y,n.z),t.push(r.x,r.y,r.z))}}}else{const o=e.attributes.position;for(let e=0,s=o.count/3;e<s;e++)for(let s=0;s<3;s++){const a=3*e+(s+1)%3;n.fromBufferAttribute(o,3*e+s),r.fromBufferAttribute(o,a),!0===isUniqueEdge(n,r,i)&&(t.push(n.x,n.y,n.z),t.push(r.x,r.y,r.z))}}this.setAttribute("position",new Float32BufferAttribute(t,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}}function isUniqueEdge(e,t,i){const n=`${e.x},${e.y},${e.z}-${t.x},${t.y},${t.z}`,r=`${t.x},${t.y},${t.z}-${e.x},${e.y},${e.z}`;return!0!==i.has(n)&&!0!==i.has(r)&&(i.add(n),i.add(r),!0)}var Geometries=Object.freeze({__proto__:null,BoxGeometry:BoxGeometry,CapsuleGeometry:CapsuleGeometry,CircleGeometry:CircleGeometry,ConeGeometry:ConeGeometry,CylinderGeometry:CylinderGeometry,DodecahedronGeometry:DodecahedronGeometry,EdgesGeometry:EdgesGeometry,ExtrudeGeometry:ExtrudeGeometry,IcosahedronGeometry:IcosahedronGeometry,LatheGeometry:LatheGeometry,OctahedronGeometry:OctahedronGeometry,PlaneGeometry:PlaneGeometry,PolyhedronGeometry:PolyhedronGeometry,RingGeometry:RingGeometry,ShapeGeometry:ShapeGeometry,SphereGeometry:SphereGeometry,TetrahedronGeometry:TetrahedronGeometry,TorusGeometry:TorusGeometry,TorusKnotGeometry:TorusKnotGeometry,TubeGeometry:TubeGeometry,WireframeGeometry:WireframeGeometry});class ShadowMaterial extends Material{constructor(e){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new Color(0),this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.fog=e.fog,this}}class RawShaderMaterial extends ShaderMaterial{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class MeshStandardMaterial extends Material{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new Color(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Euler,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class MeshPhysicalMaterial extends MeshStandardMaterial{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Vector2(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return clamp(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new Color(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new Color(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new Color(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class MeshPhongMaterial extends Material{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Color(16777215),this.specular=new Color(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Euler,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class MeshToonMaterial extends Material{constructor(e){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Color(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}class MeshNormalMaterial extends Material{constructor(e){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}class MeshLambertMaterial extends Material{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Euler,this.combine=MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class MeshDepthMaterial extends Material{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=BasicDepthPacking,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class MeshDistanceMaterial extends Material{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}class MeshMatcapMaterial extends Material{constructor(e){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Color(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=TangentSpaceNormalMap,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this.fog=e.fog,this}}class LineDashedMaterial extends LineBasicMaterial{constructor(e){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}function convertArray(e,t){return e&&e.constructor!==t?"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e):e}function getKeyframeOrder(e){const t=e.length,i=new Array(t);for(let e=0;e!==t;++e)i[e]=e;return i.sort((function(t,i){return e[t]-e[i]})),i}function sortedArray(e,t,i){const n=e.length,r=new e.constructor(n);for(let o=0,s=0;s!==n;++o){const n=i[o]*t;for(let i=0;i!==t;++i)r[s++]=e[n+i]}return r}function flattenJSON(e,t,i,n){let r=1,o=e[0];for(;void 0!==o&&void 0===o[n];)o=e[r++];if(void 0===o)return;let s=o[n];if(void 0!==s)if(Array.isArray(s))do{s=o[n],void 0!==s&&(t.push(o.time),i.push(...s)),o=e[r++]}while(void 0!==o);else if(void 0!==s.toArray)do{s=o[n],void 0!==s&&(t.push(o.time),s.toArray(i,i.length)),o=e[r++]}while(void 0!==o);else do{s=o[n],void 0!==s&&(t.push(o.time),i.push(s)),o=e[r++]}while(void 0!==o)}function subclip(e,t,i,n,r=30){const o=e.clone();o.name=t;const s=[];for(let e=0;e<o.tracks.length;++e){const t=o.tracks[e],a=t.getValueSize(),l=[],c=[];for(let e=0;e<t.times.length;++e){const o=t.times[e]*r;if(!(o<i||o>=n)){l.push(t.times[e]);for(let i=0;i<a;++i)c.push(t.values[e*a+i])}}0!==l.length&&(t.times=convertArray(l,t.times.constructor),t.values=convertArray(c,t.values.constructor),s.push(t))}o.tracks=s;let a=1/0;for(let e=0;e<o.tracks.length;++e)a>o.tracks[e].times[0]&&(a=o.tracks[e].times[0]);for(let e=0;e<o.tracks.length;++e)o.tracks[e].shift(-1*a);return o.resetDuration(),o}function makeClipAdditive(e,t=0,i=e,n=30){n<=0&&(n=30);const r=i.tracks.length,o=t/n;for(let t=0;t<r;++t){const n=i.tracks[t],r=n.ValueTypeName;if("bool"===r||"string"===r)continue;const s=e.tracks.find((function(e){return e.name===n.name&&e.ValueTypeName===r}));if(void 0===s)continue;let a=0;const l=n.getValueSize();n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(a=l/3);let c=0;const u=s.getValueSize();s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(c=u/3);const h=n.times.length-1;let d;if(o<=n.times[0]){d=n.values.slice(a,l-a)}else if(o>=n.times[h]){const e=h*l+a;d=n.values.slice(e,e+l-a)}else{const e=n.createInterpolant(),t=a,i=l-a;e.evaluate(o),d=e.resultBuffer.slice(t,i)}if("quaternion"===r){(new Quaternion).fromArray(d).normalize().conjugate().toArray(d)}const p=s.times.length;for(let e=0;e<p;++e){const t=e*u+c;if("quaternion"===r)Quaternion.multiplyQuaternionsFlat(s.values,t,d,0,s.values,t);else{const e=u-2*c;for(let i=0;i<e;++i)s.values[t+i]-=d[i]}}}return e.blendMode=AdditiveAnimationBlendMode,e}class AnimationUtils{static convertArray(e,t){return convertArray(e,t)}static isTypedArray(e){return isTypedArray(e)}static getKeyframeOrder(e){return getKeyframeOrder(e)}static sortedArray(e,t,i){return sortedArray(e,t,i)}static flattenJSON(e,t,i,n){flattenJSON(e,t,i,n)}static subclip(e,t,i,n,r=30){return subclip(e,t,i,n,r)}static makeClipAdditive(e,t=0,i=e,n=30){return makeClipAdditive(e,t,i,n)}}class Interpolant{constructor(e,t,i,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new t.constructor(i),this.sampleValues=t,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let i=this._cachedIndex,n=t[i],r=t[i-1];e:{t:{let o;i:{n:if(!(e<n)){for(let o=i+2;;){if(void 0===n){if(e<r)break n;return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}if(i===o)break;if(r=n,n=t[++i],e<n)break t}o=t.length;break i}if(e>=r)break e;{const s=t[1];e<s&&(i=2,r=s);for(let o=i-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(i===o)break;if(n=r,r=t[--i-1],e>=r)break t}o=i,i=0}}for(;i<o;){const n=i+o>>>1;e<t[n]?o=n:i=n+1}if(n=t[i],r=t[i-1],void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===n)return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}this._cachedIndex=i,this.intervalChanged_(i,r,n)}return this.interpolate_(i,r,e,n)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=e*n;for(let e=0;e!==n;++e)t[e]=i[r+e];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class CubicInterpolant extends Interpolant{constructor(e,t,i,n){super(e,t,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:ZeroCurvatureEnding,endingEnd:ZeroCurvatureEnding}}intervalChanged_(e,t,i){const n=this.parameterPositions;let r=e-2,o=e+1,s=n[r],a=n[o];if(void 0===s)switch(this.getSettings_().endingStart){case ZeroSlopeEnding:r=e,s=2*t-i;break;case WrapAroundEnding:r=n.length-2,s=t+n[r]-n[r+1];break;default:r=e,s=i}if(void 0===a)switch(this.getSettings_().endingEnd){case ZeroSlopeEnding:o=e,a=2*i-t;break;case WrapAroundEnding:o=1,a=i+n[1]-n[0];break;default:o=e-1,a=t}const l=.5*(i-t),c=this.valueSize;this._weightPrev=l/(t-s),this._weightNext=l/(a-i),this._offsetPrev=r*c,this._offsetNext=o*c}interpolate_(e,t,i,n){const r=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=e*s,l=a-s,c=this._offsetPrev,u=this._offsetNext,h=this._weightPrev,d=this._weightNext,p=(i-t)/(n-t),f=p*p,m=f*p,g=-h*m+2*h*f-h*p,_=(1+h)*m+(-1.5-2*h)*f+(-.5+h)*p+1,y=(-1-d)*m+(1.5+d)*f+.5*p,v=d*m-d*f;for(let e=0;e!==s;++e)r[e]=g*o[c+e]+_*o[l+e]+y*o[a+e]+v*o[u+e];return r}}class LinearInterpolant extends Interpolant{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e,t,i,n){const r=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=e*s,l=a-s,c=(i-t)/(n-t),u=1-c;for(let e=0;e!==s;++e)r[e]=o[l+e]*u+o[a+e]*c;return r}}class DiscreteInterpolant extends Interpolant{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e){return this.copySampleValue_(e-1)}}class KeyframeTrack{constructor(e,t,i,n){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=convertArray(t,this.TimeBufferType),this.values=convertArray(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let i;if(t.toJSON!==this.toJSON)i=t.toJSON(e);else{i={name:e.name,times:convertArray(e.times,Array),values:convertArray(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(i.interpolation=t)}return i.type=e.ValueTypeName,i}InterpolantFactoryMethodDiscrete(e){return new DiscreteInterpolant(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new LinearInterpolant(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new CubicInterpolant(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case InterpolateDiscrete:t=this.InterpolantFactoryMethodDiscrete;break;case InterpolateLinear:t=this.InterpolantFactoryMethodLinear;break;case InterpolateSmooth:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return warn("KeyframeTrack:",t),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return InterpolateDiscrete;case this.InterpolantFactoryMethodLinear:return InterpolateLinear;case this.InterpolantFactoryMethodSmooth:return InterpolateSmooth}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let i=0,n=t.length;i!==n;++i)t[i]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let i=0,n=t.length;i!==n;++i)t[i]*=e}return this}trim(e,t){const i=this.times,n=i.length;let r=0,o=n-1;for(;r!==n&&i[r]<e;)++r;for(;-1!==o&&i[o]>t;)--o;if(++o,0!==r||o!==n){r>=o&&(o=Math.max(o,1),r=o-1);const e=this.getValueSize();this.times=i.slice(r,o),this.values=this.values.slice(r*e,o*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!=0&&(error("KeyframeTrack: Invalid value size in track.",this),e=!1);const i=this.times,n=this.values,r=i.length;0===r&&(error("KeyframeTrack: Track is empty.",this),e=!1);let o=null;for(let t=0;t!==r;t++){const n=i[t];if("number"==typeof n&&isNaN(n)){error("KeyframeTrack: Time is not a valid number.",this,t,n),e=!1;break}if(null!==o&&o>n){error("KeyframeTrack: Out of order keys.",this,t,n,o),e=!1;break}o=n}if(void 0!==n&&isTypedArray(n))for(let t=0,i=n.length;t!==i;++t){const i=n[t];if(isNaN(i)){error("KeyframeTrack: Value is not a valid number.",this,t,i),e=!1;break}}return e}optimize(){const e=this.times.slice(),t=this.values.slice(),i=this.getValueSize(),n=this.getInterpolation()===InterpolateSmooth,r=e.length-1;let o=1;for(let s=1;s<r;++s){let r=!1;const a=e[s];if(a!==e[s+1]&&(1!==s||a!==e[0]))if(n)r=!0;else{const e=s*i,n=e-i,o=e+i;for(let s=0;s!==i;++s){const i=t[e+s];if(i!==t[n+s]||i!==t[o+s]){r=!0;break}}}if(r){if(s!==o){e[o]=e[s];const n=s*i,r=o*i;for(let e=0;e!==i;++e)t[r+e]=t[n+e]}++o}}if(r>0){e[o]=e[r];for(let e=r*i,n=o*i,s=0;s!==i;++s)t[n+s]=t[e+s];++o}return o!==e.length?(this.times=e.slice(0,o),this.values=t.slice(0,o*i)):(this.times=e,this.values=t),this}clone(){const e=this.times.slice(),t=this.values.slice(),i=new(0,this.constructor)(this.name,e,t);return i.createInterpolant=this.createInterpolant,i}}KeyframeTrack.prototype.ValueTypeName="",KeyframeTrack.prototype.TimeBufferType=Float32Array,KeyframeTrack.prototype.ValueBufferType=Float32Array,KeyframeTrack.prototype.DefaultInterpolation=InterpolateLinear;class BooleanKeyframeTrack extends KeyframeTrack{constructor(e,t,i){super(e,t,i)}}BooleanKeyframeTrack.prototype.ValueTypeName="bool",BooleanKeyframeTrack.prototype.ValueBufferType=Array,BooleanKeyframeTrack.prototype.DefaultInterpolation=InterpolateDiscrete,BooleanKeyframeTrack.prototype.InterpolantFactoryMethodLinear=void 0,BooleanKeyframeTrack.prototype.InterpolantFactoryMethodSmooth=void 0;class ColorKeyframeTrack extends KeyframeTrack{constructor(e,t,i,n){super(e,t,i,n)}}ColorKeyframeTrack.prototype.ValueTypeName="color";class NumberKeyframeTrack extends KeyframeTrack{constructor(e,t,i,n){super(e,t,i,n)}}NumberKeyframeTrack.prototype.ValueTypeName="number";class QuaternionLinearInterpolant extends Interpolant{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e,t,i,n){const r=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=(i-t)/(n-t);let l=e*s;for(let e=l+s;l!==e;l+=4)Quaternion.slerpFlat(r,0,o,l-s,o,l,a);return r}}class QuaternionKeyframeTrack extends KeyframeTrack{constructor(e,t,i,n){super(e,t,i,n)}InterpolantFactoryMethodLinear(e){return new QuaternionLinearInterpolant(this.times,this.values,this.getValueSize(),e)}}QuaternionKeyframeTrack.prototype.ValueTypeName="quaternion",QuaternionKeyframeTrack.prototype.InterpolantFactoryMethodSmooth=void 0;class StringKeyframeTrack extends KeyframeTrack{constructor(e,t,i){super(e,t,i)}}StringKeyframeTrack.prototype.ValueTypeName="string",StringKeyframeTrack.prototype.ValueBufferType=Array,StringKeyframeTrack.prototype.DefaultInterpolation=InterpolateDiscrete,StringKeyframeTrack.prototype.InterpolantFactoryMethodLinear=void 0,StringKeyframeTrack.prototype.InterpolantFactoryMethodSmooth=void 0;class VectorKeyframeTrack extends KeyframeTrack{constructor(e,t,i,n){super(e,t,i,n)}}VectorKeyframeTrack.prototype.ValueTypeName="vector";class AnimationClip{constructor(e="",t=-1,i=[],n=NormalAnimationBlendMode){this.name=e,this.tracks=i,this.duration=t,this.blendMode=n,this.uuid=generateUUID$1(),this.userData={},this.duration<0&&this.resetDuration()}static parse(e){const t=[],i=e.tracks,n=1/(e.fps||1);for(let e=0,r=i.length;e!==r;++e)t.push(parseKeyframeTrack(i[e]).scale(n));const r=new this(e.name,e.duration,t,e.blendMode);return r.uuid=e.uuid,r.userData=JSON.parse(e.userData||"{}"),r}static toJSON(e){const t=[],i=e.tracks,n={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode,userData:JSON.stringify(e.userData)};for(let e=0,n=i.length;e!==n;++e)t.push(KeyframeTrack.toJSON(i[e]));return n}static CreateFromMorphTargetSequence(e,t,i,n){const r=t.length,o=[];for(let e=0;e<r;e++){let s=[],a=[];s.push((e+r-1)%r,e,(e+1)%r),a.push(0,1,0);const l=getKeyframeOrder(s);s=sortedArray(s,1,l),a=sortedArray(a,1,l),n||0!==s[0]||(s.push(r),a.push(a[0])),o.push(new NumberKeyframeTrack(".morphTargetInfluences["+t[e].name+"]",s,a).scale(1/i))}return new this(e,-1,o)}static findByName(e,t){let i=e;if(!Array.isArray(e)){i=e.geometry&&e.geometry.animations||e.animations}for(let e=0;e<i.length;e++)if(i[e].name===t)return i[e];return null}static CreateClipsFromMorphTargetSequences(e,t,i){const n={},r=/^([\w-]*?)([\d]+)$/;for(let t=0,i=e.length;t<i;t++){const i=e[t],o=i.name.match(r);if(o&&o.length>1){const e=o[1];let t=n[e];t||(n[e]=t=[]),t.push(i)}}const o=[];for(const e in n)o.push(this.CreateFromMorphTargetSequence(e,n[e],t,i));return o}static parseAnimation(e,t){if(warn("AnimationClip: parseAnimation() is deprecated and will be removed with r185"),!e)return error("AnimationClip: No animation in JSONLoader data."),null;const i=function(e,t,i,n,r){if(0!==i.length){const o=[],s=[];flattenJSON(i,o,s,n),0!==o.length&&r.push(new e(t,o,s))}},n=[],r=e.name||"default",o=e.fps||30,s=e.blendMode;let a=e.length||-1;const l=e.hierarchy||[];for(let e=0;e<l.length;e++){const r=l[e].keys;if(r&&0!==r.length)if(r[0].morphTargets){const e={};let t;for(t=0;t<r.length;t++)if(r[t].morphTargets)for(let i=0;i<r[t].morphTargets.length;i++)e[r[t].morphTargets[i]]=-1;for(const i in e){const e=[],o=[];for(let n=0;n!==r[t].morphTargets.length;++n){const n=r[t];e.push(n.time),o.push(n.morphTarget===i?1:0)}n.push(new NumberKeyframeTrack(".morphTargetInfluence["+i+"]",e,o))}a=e.length*o}else{const o=".bones["+t[e].name+"]";i(VectorKeyframeTrack,o+".position",r,"pos",n),i(QuaternionKeyframeTrack,o+".quaternion",r,"rot",n),i(VectorKeyframeTrack,o+".scale",r,"scl",n)}}if(0===n.length)return null;return new this(r,a,n,s)}resetDuration(){let e=0;for(let t=0,i=this.tracks.length;t!==i;++t){const i=this.tracks[t];e=Math.max(e,i.times[i.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());const t=new this.constructor(this.name,this.duration,e,this.blendMode);return t.userData=JSON.parse(JSON.stringify(this.userData)),t}toJSON(){return this.constructor.toJSON(this)}}function getTrackTypeForValueTypeName(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return NumberKeyframeTrack;case"vector":case"vector2":case"vector3":case"vector4":return VectorKeyframeTrack;case"color":return ColorKeyframeTrack;case"quaternion":return QuaternionKeyframeTrack;case"bool":case"boolean":return BooleanKeyframeTrack;case"string":return StringKeyframeTrack}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}function parseKeyframeTrack(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=getTrackTypeForValueTypeName(e.type);if(void 0===e.times){const t=[],i=[];flattenJSON(e.keys,t,i,"value"),e.times=t,e.values=i}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}const Cache={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class LoadingManager{constructor(e,t,i){const n=this;let r,o=!1,s=0,a=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this._abortController=null,this.itemStart=function(e){a++,!1===o&&void 0!==n.onStart&&n.onStart(e,s,a),o=!0},this.itemEnd=function(e){s++,void 0!==n.onProgress&&n.onProgress(e,s,a),s===a&&(o=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)},this.resolveURL=function(e){return r?r(e):e},this.setURLModifier=function(e){return r=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,i=l.length;t<i;t+=2){const i=l[t],n=l[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return n}return null},this.abort=function(){return this.abortController.abort(),this._abortController=null,this}}get abortController(){return this._abortController||(this._abortController=new AbortController),this._abortController}}const DefaultLoadingManager=new LoadingManager;class Loader{constructor(e){this.manager=void 0!==e?e:DefaultLoadingManager,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise((function(n,r){i.load(e,n,t,r)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}abort(){return this}}Loader.DEFAULT_MATERIAL_NAME="__DEFAULT";const loading={};class HttpError extends Error{constructor(e,t){super(e),this.response=t}}class FileLoader extends Loader{constructor(e){super(e),this.mimeType="",this.responseType="",this._abortController=new AbortController}load(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=Cache.get(`file:${e}`);if(void 0!==r)return this.manager.itemStart(e),setTimeout((()=>{t&&t(r),this.manager.itemEnd(e)}),0),r;if(void 0!==loading[e])return void loading[e].push({onLoad:t,onProgress:i,onError:n});loading[e]=[],loading[e].push({onLoad:t,onProgress:i,onError:n});const o=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin",signal:"function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal}),s=this.mimeType,a=this.responseType;fetch(o).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&warn("FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;const i=loading[e],n=t.body.getReader(),r=t.headers.get("X-File-Size")||t.headers.get("Content-Length"),o=r?parseInt(r):0,s=0!==o;let a=0;const l=new ReadableStream({start(e){!function t(){n.read().then((({done:n,value:r})=>{if(n)e.close();else{a+=r.byteLength;const n=new ProgressEvent("progress",{lengthComputable:s,loaded:a,total:o});for(let e=0,t=i.length;e<t;e++){const t=i[e];t.onProgress&&t.onProgress(n)}e.enqueue(r),t()}}),(t=>{e.error(t)}))}()}});return new Response(l)}throw new HttpError(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)})).then((e=>{switch(a){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,s)));case"json":return e.json();default:if(""===s)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(s),i=t&&t[1]?t[1].toLowerCase():void 0,n=new TextDecoder(i);return e.arrayBuffer().then((e=>n.decode(e)))}}})).then((t=>{Cache.add(`file:${e}`,t);const i=loading[e];delete loading[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onLoad&&n.onLoad(t)}})).catch((t=>{const i=loading[e];if(void 0===i)throw this.manager.itemError(e),t;delete loading[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onError&&n.onError(t)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}class AnimationLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){const r=this,o=new FileLoader(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(i){try{t(r.parse(JSON.parse(i)))}catch(t){n?n(t):error(t),r.manager.itemError(e)}}),i,n)}parse(e){const t=[];for(let i=0;i<e.length;i++){const n=AnimationClip.parse(e[i]);t.push(n)}return t}}class CompressedTextureLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){const r=this,o=[],s=new CompressedTexture,a=new FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(r.withCredentials);let l=0;function c(c){a.load(e[c],(function(e){const i=r.parse(e,!0);o[c]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},l+=1,6===l&&(1===i.mipmapCount&&(s.minFilter=LinearFilter),s.image=o,s.format=i.format,s.needsUpdate=!0,t&&t(s))}),i,n)}if(Array.isArray(e))for(let t=0,i=e.length;t<i;++t)c(t);else a.load(e,(function(e){const i=r.parse(e,!0);if(i.isCubemap){const e=i.mipmaps.length/i.mipmapCount;for(let t=0;t<e;t++){o[t]={mipmaps:[]};for(let e=0;e<i.mipmapCount;e++)o[t].mipmaps.push(i.mipmaps[t*i.mipmapCount+e]),o[t].format=i.format,o[t].width=i.width,o[t].height=i.height}s.image=o}else s.image.width=i.width,s.image.height=i.height,s.mipmaps=i.mipmaps;1===i.mipmapCount&&(s.minFilter=LinearFilter),s.format=i.format,s.needsUpdate=!0,t&&t(s)}),i,n);return s}}const _loading=new WeakMap;class ImageLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,o=Cache.get(`image:${e}`);if(void 0!==o){if(!0===o.complete)r.manager.itemStart(e),setTimeout((function(){t&&t(o),r.manager.itemEnd(e)}),0);else{let e=_loading.get(o);void 0===e&&(e=[],_loading.set(o,e)),e.push({onLoad:t,onError:n})}return o}const s=createElementNS("img");function a(){c(),t&&t(this);const i=_loading.get(this)||[];for(let e=0;e<i.length;e++){const t=i[e];t.onLoad&&t.onLoad(this)}_loading.delete(this),r.manager.itemEnd(e)}function l(t){c(),n&&n(t),Cache.remove(`image:${e}`);const i=_loading.get(this)||[];for(let e=0;e<i.length;e++){const n=i[e];n.onError&&n.onError(t)}_loading.delete(this),r.manager.itemError(e),r.manager.itemEnd(e)}function c(){s.removeEventListener("load",a,!1),s.removeEventListener("error",l,!1)}return s.addEventListener("load",a,!1),s.addEventListener("error",l,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(s.crossOrigin=this.crossOrigin),Cache.add(`image:${e}`,s),r.manager.itemStart(e),s.src=e,s}}class CubeTextureLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){const r=new CubeTexture;r.colorSpace=SRGBColorSpace;const o=new ImageLoader(this.manager);o.setCrossOrigin(this.crossOrigin),o.setPath(this.path);let s=0;function a(i){o.load(e[i],(function(e){r.images[i]=e,s++,6===s&&(r.needsUpdate=!0,t&&t(r))}),void 0,n)}for(let t=0;t<e.length;++t)a(t);return r}}class DataTextureLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){const r=this,o=new DataTexture,s=new FileLoader(this.manager);return s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setPath(this.path),s.setWithCredentials(r.withCredentials),s.load(e,(function(e){let i;try{i=r.parse(e)}catch(e){if(void 0===n)return void e(e);n(e)}void 0!==i.image?o.image=i.image:void 0!==i.data&&(o.image.width=i.width,o.image.height=i.height,o.image.data=i.data),o.wrapS=void 0!==i.wrapS?i.wrapS:ClampToEdgeWrapping,o.wrapT=void 0!==i.wrapT?i.wrapT:ClampToEdgeWrapping,o.magFilter=void 0!==i.magFilter?i.magFilter:LinearFilter,o.minFilter=void 0!==i.minFilter?i.minFilter:LinearFilter,o.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.colorSpace&&(o.colorSpace=i.colorSpace),void 0!==i.flipY&&(o.flipY=i.flipY),void 0!==i.format&&(o.format=i.format),void 0!==i.type&&(o.type=i.type),void 0!==i.mipmaps&&(o.mipmaps=i.mipmaps,o.minFilter=LinearMipmapLinearFilter),1===i.mipmapCount&&(o.minFilter=LinearFilter),void 0!==i.generateMipmaps&&(o.generateMipmaps=i.generateMipmaps),o.needsUpdate=!0,t&&t(o,i)}),i,n),o}}class TextureLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){const r=new Texture,o=new ImageLoader(this.manager);return o.setCrossOrigin(this.crossOrigin),o.setPath(this.path),o.load(e,(function(e){r.image=e,r.needsUpdate=!0,void 0!==t&&t(r)}),i,n),r}}class Light extends Object3D{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new Color(e),this.intensity=t}dispose(){this.dispatchEvent({type:"dispose"})}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,t}}class HemisphereLight extends Light{constructor(e,t,i){super(e,i),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(Object3D.DEFAULT_UP),this.updateMatrix(),this.groundColor=new Color(t)}copy(e,t){return super.copy(e,t),this.groundColor.copy(e.groundColor),this}toJSON(e){const t=super.toJSON(e);return t.object.groundColor=this.groundColor.getHex(),t}}const _projScreenMatrix$2=new Matrix4,_lightPositionWorld$1=new Vector3,_lookTarget$1=new Vector3;class LightShadow{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Vector2(512,512),this.mapType=UnsignedByteType,this.map=null,this.mapPass=null,this.matrix=new Matrix4,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Frustum,this._frameExtents=new Vector2(1,1),this._viewportCount=1,this._viewports=[new Vector4(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,i=this.matrix;_lightPositionWorld$1.setFromMatrixPosition(e.matrixWorld),t.position.copy(_lightPositionWorld$1),_lookTarget$1.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(_lookTarget$1),t.updateMatrixWorld(),_projScreenMatrix$2.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(_projScreenMatrix$2,t.coordinateSystem,t.reversedDepth),t.reversedDepth?i.set(.5,0,0,.5,0,.5,0,.5,0,0,1,0,0,0,0,1):i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(_projScreenMatrix$2)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class SpotLightShadow extends LightShadow{constructor(){super(new PerspectiveCamera(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1,this.aspect=1}updateMatrices(e){const t=this.camera,i=2*RAD2DEG*e.angle*this.focus,n=this.mapSize.width/this.mapSize.height*this.aspect,r=e.distance||t.far;i===t.fov&&n===t.aspect&&r===t.far||(t.fov=i,t.aspect=n,t.far=r,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class SpotLight extends Light{constructor(e,t,i=0,n=Math.PI/3,r=0,o=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Object3D.DEFAULT_UP),this.updateMatrix(),this.target=new Object3D,this.distance=i,this.angle=n,this.penumbra=r,this.decay=o,this.map=null,this.shadow=new SpotLightShadow}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){super.dispose(),this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.map=e.map,this.shadow=e.shadow.clone(),this}toJSON(e){const t=super.toJSON(e);return t.object.distance=this.distance,t.object.angle=this.angle,t.object.decay=this.decay,t.object.penumbra=this.penumbra,t.object.target=this.target.uuid,this.map&&this.map.isTexture&&(t.object.map=this.map.toJSON(e).uuid),t.object.shadow=this.shadow.toJSON(),t}}class PointLightShadow extends LightShadow{constructor(){super(new PerspectiveCamera(90,1,.5,500)),this.isPointLightShadow=!0}}class PointLight extends Light{constructor(e,t,i=0,n=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=n,this.shadow=new PointLightShadow}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){super.dispose(),this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}toJSON(e){const t=super.toJSON(e);return t.object.distance=this.distance,t.object.decay=this.decay,t.object.shadow=this.shadow.toJSON(),t}}class OrthographicCamera extends Camera{constructor(e=-1,t=1,i=1,n=-1,r=.1,o=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=n,this.near=r,this.far=o,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,i,n,r,o){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=o,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let r=i-e,o=i+e,s=n+t,a=n-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,o=r+e*this.view.width,s-=t*this.view.offsetY,a=s-t*this.view.height}this.projectionMatrix.makeOrthographic(r,o,s,a,this.near,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}class DirectionalLightShadow extends LightShadow{constructor(){super(new OrthographicCamera(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class DirectionalLight extends Light{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Object3D.DEFAULT_UP),this.updateMatrix(),this.target=new Object3D,this.shadow=new DirectionalLightShadow}dispose(){super.dispose(),this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}toJSON(e){const t=super.toJSON(e);return t.object.shadow=this.shadow.toJSON(),t.object.target=this.target.uuid,t}}class AmbientLight extends Light{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class RectAreaLight extends Light{constructor(e,t,i=10,n=10){super(e,t),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=i,this.height=n}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}class SphericalHarmonics3{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new Vector3)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){const i=e.x,n=e.y,r=e.z,o=this.coefficients;return t.copy(o[0]).multiplyScalar(.282095),t.addScaledVector(o[1],.488603*n),t.addScaledVector(o[2],.488603*r),t.addScaledVector(o[3],.488603*i),t.addScaledVector(o[4],i*n*1.092548),t.addScaledVector(o[5],n*r*1.092548),t.addScaledVector(o[6],.315392*(3*r*r-1)),t.addScaledVector(o[7],i*r*1.092548),t.addScaledVector(o[8],.546274*(i*i-n*n)),t}getIrradianceAt(e,t){const i=e.x,n=e.y,r=e.z,o=this.coefficients;return t.copy(o[0]).multiplyScalar(.886227),t.addScaledVector(o[1],1.023328*n),t.addScaledVector(o[2],1.023328*r),t.addScaledVector(o[3],1.023328*i),t.addScaledVector(o[4],.858086*i*n),t.addScaledVector(o[5],.858086*n*r),t.addScaledVector(o[6],.743125*r*r-.247708),t.addScaledVector(o[7],.858086*i*r),t.addScaledVector(o[8],.429043*(i*i-n*n)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let i=0;i<9;i++)this.coefficients[i].addScaledVector(e.coefficients[i],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let i=0;i<9;i++)this.coefficients[i].lerp(e.coefficients[i],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].fromArray(e,t+3*n);return this}toArray(e=[],t=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].toArray(e,t+3*n);return e}static getBasisAt(e,t){const i=e.x,n=e.y,r=e.z;t[0]=.282095,t[1]=.488603*n,t[2]=.488603*r,t[3]=.488603*i,t[4]=1.092548*i*n,t[5]=1.092548*n*r,t[6]=.315392*(3*r*r-1),t[7]=1.092548*i*r,t[8]=.546274*(i*i-n*n)}}class LightProbe extends Light{constructor(e=new SphericalHarmonics3,t=1){super(void 0,t),this.isLightProbe=!0,this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}toJSON(e){const t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}}class MaterialLoader extends Loader{constructor(e){super(e),this.textures={}}load(e,t,i,n){const r=this,o=new FileLoader(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(e,(function(i){try{t(r.parse(JSON.parse(i)))}catch(t){n?n(t):error(t),r.manager.itemError(e)}}),i,n)}parse(e){const t=this.textures;function i(e){return void 0===t[e]&&warn("MaterialLoader: Undefined texture",e),t[e]}const n=this.createMaterialFromType(e.type);if(void 0!==e.uuid&&(n.uuid=e.uuid),void 0!==e.name&&(n.name=e.name),void 0!==e.color&&void 0!==n.color&&n.color.setHex(e.color),void 0!==e.roughness&&(n.roughness=e.roughness),void 0!==e.metalness&&(n.metalness=e.metalness),void 0!==e.sheen&&(n.sheen=e.sheen),void 0!==e.sheenColor&&(n.sheenColor=(new Color).setHex(e.sheenColor)),void 0!==e.sheenRoughness&&(n.sheenRoughness=e.sheenRoughness),void 0!==e.emissive&&void 0!==n.emissive&&n.emissive.setHex(e.emissive),void 0!==e.specular&&void 0!==n.specular&&n.specular.setHex(e.specular),void 0!==e.specularIntensity&&(n.specularIntensity=e.specularIntensity),void 0!==e.specularColor&&void 0!==n.specularColor&&n.specularColor.setHex(e.specularColor),void 0!==e.shininess&&(n.shininess=e.shininess),void 0!==e.clearcoat&&(n.clearcoat=e.clearcoat),void 0!==e.clearcoatRoughness&&(n.clearcoatRoughness=e.clearcoatRoughness),void 0!==e.dispersion&&(n.dispersion=e.dispersion),void 0!==e.iridescence&&(n.iridescence=e.iridescence),void 0!==e.iridescenceIOR&&(n.iridescenceIOR=e.iridescenceIOR),void 0!==e.iridescenceThicknessRange&&(n.iridescenceThicknessRange=e.iridescenceThicknessRange),void 0!==e.transmission&&(n.transmission=e.transmission),void 0!==e.thickness&&(n.thickness=e.thickness),void 0!==e.attenuationDistance&&(n.attenuationDistance=e.attenuationDistance),void 0!==e.attenuationColor&&void 0!==n.attenuationColor&&n.attenuationColor.setHex(e.attenuationColor),void 0!==e.anisotropy&&(n.anisotropy=e.anisotropy),void 0!==e.anisotropyRotation&&(n.anisotropyRotation=e.anisotropyRotation),void 0!==e.fog&&(n.fog=e.fog),void 0!==e.flatShading&&(n.flatShading=e.flatShading),void 0!==e.blending&&(n.blending=e.blending),void 0!==e.combine&&(n.combine=e.combine),void 0!==e.side&&(n.side=e.side),void 0!==e.shadowSide&&(n.shadowSide=e.shadowSide),void 0!==e.opacity&&(n.opacity=e.opacity),void 0!==e.transparent&&(n.transparent=e.transparent),void 0!==e.alphaTest&&(n.alphaTest=e.alphaTest),void 0!==e.alphaHash&&(n.alphaHash=e.alphaHash),void 0!==e.depthFunc&&(n.depthFunc=e.depthFunc),void 0!==e.depthTest&&(n.depthTest=e.depthTest),void 0!==e.depthWrite&&(n.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(n.colorWrite=e.colorWrite),void 0!==e.blendSrc&&(n.blendSrc=e.blendSrc),void 0!==e.blendDst&&(n.blendDst=e.blendDst),void 0!==e.blendEquation&&(n.blendEquation=e.blendEquation),void 0!==e.blendSrcAlpha&&(n.blendSrcAlpha=e.blendSrcAlpha),void 0!==e.blendDstAlpha&&(n.blendDstAlpha=e.blendDstAlpha),void 0!==e.blendEquationAlpha&&(n.blendEquationAlpha=e.blendEquationAlpha),void 0!==e.blendColor&&void 0!==n.blendColor&&n.blendColor.setHex(e.blendColor),void 0!==e.blendAlpha&&(n.blendAlpha=e.blendAlpha),void 0!==e.stencilWriteMask&&(n.stencilWriteMask=e.stencilWriteMask),void 0!==e.stencilFunc&&(n.stencilFunc=e.stencilFunc),void 0!==e.stencilRef&&(n.stencilRef=e.stencilRef),void 0!==e.stencilFuncMask&&(n.stencilFuncMask=e.stencilFuncMask),void 0!==e.stencilFail&&(n.stencilFail=e.stencilFail),void 0!==e.stencilZFail&&(n.stencilZFail=e.stencilZFail),void 0!==e.stencilZPass&&(n.stencilZPass=e.stencilZPass),void 0!==e.stencilWrite&&(n.stencilWrite=e.stencilWrite),void 0!==e.wireframe&&(n.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(n.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(n.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(n.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.rotation&&(n.rotation=e.rotation),void 0!==e.linewidth&&(n.linewidth=e.linewidth),void 0!==e.dashSize&&(n.dashSize=e.dashSize),void 0!==e.gapSize&&(n.gapSize=e.gapSize),void 0!==e.scale&&(n.scale=e.scale),void 0!==e.polygonOffset&&(n.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(n.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(n.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.dithering&&(n.dithering=e.dithering),void 0!==e.alphaToCoverage&&(n.alphaToCoverage=e.alphaToCoverage),void 0!==e.premultipliedAlpha&&(n.premultipliedAlpha=e.premultipliedAlpha),void 0!==e.forceSinglePass&&(n.forceSinglePass=e.forceSinglePass),void 0!==e.allowOverride&&(n.allowOverride=e.allowOverride),void 0!==e.visible&&(n.visible=e.visible),void 0!==e.toneMapped&&(n.toneMapped=e.toneMapped),void 0!==e.userData&&(n.userData=e.userData),void 0!==e.vertexColors&&(n.vertexColors="number"==typeof e.vertexColors?e.vertexColors>0:e.vertexColors),void 0!==e.uniforms)for(const t in e.uniforms){const r=e.uniforms[t];switch(n.uniforms[t]={},r.type){case"t":n.uniforms[t].value=i(r.value);break;case"c":n.uniforms[t].value=(new Color).setHex(r.value);break;case"v2":n.uniforms[t].value=(new Vector2).fromArray(r.value);break;case"v3":n.uniforms[t].value=(new Vector3).fromArray(r.value);break;case"v4":n.uniforms[t].value=(new Vector4).fromArray(r.value);break;case"m3":n.uniforms[t].value=(new Matrix3).fromArray(r.value);break;case"m4":n.uniforms[t].value=(new Matrix4).fromArray(r.value);break;default:n.uniforms[t].value=r.value}}if(void 0!==e.defines&&(n.defines=e.defines),void 0!==e.vertexShader&&(n.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(n.fragmentShader=e.fragmentShader),void 0!==e.glslVersion&&(n.glslVersion=e.glslVersion),void 0!==e.extensions)for(const t in e.extensions)n.extensions[t]=e.extensions[t];if(void 0!==e.lights&&(n.lights=e.lights),void 0!==e.clipping&&(n.clipping=e.clipping),void 0!==e.size&&(n.size=e.size),void 0!==e.sizeAttenuation&&(n.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(n.map=i(e.map)),void 0!==e.matcap&&(n.matcap=i(e.matcap)),void 0!==e.alphaMap&&(n.alphaMap=i(e.alphaMap)),void 0!==e.bumpMap&&(n.bumpMap=i(e.bumpMap)),void 0!==e.bumpScale&&(n.bumpScale=e.bumpScale),void 0!==e.normalMap&&(n.normalMap=i(e.normalMap)),void 0!==e.normalMapType&&(n.normalMapType=e.normalMapType),void 0!==e.normalScale){let t=e.normalScale;!1===Array.isArray(t)&&(t=[t,t]),n.normalScale=(new Vector2).fromArray(t)}return void 0!==e.displacementMap&&(n.displacementMap=i(e.displacementMap)),void 0!==e.displacementScale&&(n.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(n.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(n.roughnessMap=i(e.roughnessMap)),void 0!==e.metalnessMap&&(n.metalnessMap=i(e.metalnessMap)),void 0!==e.emissiveMap&&(n.emissiveMap=i(e.emissiveMap)),void 0!==e.emissiveIntensity&&(n.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(n.specularMap=i(e.specularMap)),void 0!==e.specularIntensityMap&&(n.specularIntensityMap=i(e.specularIntensityMap)),void 0!==e.specularColorMap&&(n.specularColorMap=i(e.specularColorMap)),void 0!==e.envMap&&(n.envMap=i(e.envMap)),void 0!==e.envMapRotation&&n.envMapRotation.fromArray(e.envMapRotation),void 0!==e.envMapIntensity&&(n.envMapIntensity=e.envMapIntensity),void 0!==e.reflectivity&&(n.reflectivity=e.reflectivity),void 0!==e.refractionRatio&&(n.refractionRatio=e.refractionRatio),void 0!==e.lightMap&&(n.lightMap=i(e.lightMap)),void 0!==e.lightMapIntensity&&(n.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(n.aoMap=i(e.aoMap)),void 0!==e.aoMapIntensity&&(n.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(n.gradientMap=i(e.gradientMap)),void 0!==e.clearcoatMap&&(n.clearcoatMap=i(e.clearcoatMap)),void 0!==e.clearcoatRoughnessMap&&(n.clearcoatRoughnessMap=i(e.clearcoatRoughnessMap)),void 0!==e.clearcoatNormalMap&&(n.clearcoatNormalMap=i(e.clearcoatNormalMap)),void 0!==e.clearcoatNormalScale&&(n.clearcoatNormalScale=(new Vector2).fromArray(e.clearcoatNormalScale)),void 0!==e.iridescenceMap&&(n.iridescenceMap=i(e.iridescenceMap)),void 0!==e.iridescenceThicknessMap&&(n.iridescenceThicknessMap=i(e.iridescenceThicknessMap)),void 0!==e.transmissionMap&&(n.transmissionMap=i(e.transmissionMap)),void 0!==e.thicknessMap&&(n.thicknessMap=i(e.thicknessMap)),void 0!==e.anisotropyMap&&(n.anisotropyMap=i(e.anisotropyMap)),void 0!==e.sheenColorMap&&(n.sheenColorMap=i(e.sheenColorMap)),void 0!==e.sheenRoughnessMap&&(n.sheenRoughnessMap=i(e.sheenRoughnessMap)),n}setTextures(e){return this.textures=e,this}createMaterialFromType(e){return MaterialLoader.createMaterialFromType(e)}static createMaterialFromType(e){return new{ShadowMaterial:ShadowMaterial,SpriteMaterial:SpriteMaterial,RawShaderMaterial:RawShaderMaterial,ShaderMaterial:ShaderMaterial,PointsMaterial:PointsMaterial,MeshPhysicalMaterial:MeshPhysicalMaterial,MeshStandardMaterial:MeshStandardMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshToonMaterial:MeshToonMaterial,MeshNormalMaterial:MeshNormalMaterial,MeshLambertMaterial:MeshLambertMaterial,MeshDepthMaterial:MeshDepthMaterial,MeshDistanceMaterial:MeshDistanceMaterial,MeshBasicMaterial:MeshBasicMaterial,MeshMatcapMaterial:MeshMatcapMaterial,LineDashedMaterial:LineDashedMaterial,LineBasicMaterial:LineBasicMaterial,Material:Material}[e]}}class LoaderUtils{static extractUrlBase(e){const t=e.lastIndexOf("/");return-1===t?"./":e.slice(0,t+1)}static resolveURL(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}}class InstancedBufferGeometry extends BufferGeometry{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(e){return super.copy(e),this.instanceCount=e.instanceCount,this}toJSON(){const e=super.toJSON();return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}class BufferGeometryLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){const r=this,o=new FileLoader(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(e,(function(i){try{t(r.parse(JSON.parse(i)))}catch(t){n?n(t):error(t),r.manager.itemError(e)}}),i,n)}parse(e){const t={},i={};function n(e,n){if(void 0!==t[n])return t[n];const r=e.interleavedBuffers[n],o=function(e,t){if(void 0!==i[t])return i[t];const n=e.arrayBuffers,r=n[t],o=new Uint32Array(r).buffer;return i[t]=o,o}(e,r.buffer),s=getTypedArray(r.type,o),a=new InterleavedBuffer(s,r.stride);return a.uuid=r.uuid,t[n]=a,a}const r=e.isInstancedBufferGeometry?new InstancedBufferGeometry:new BufferGeometry,o=e.data.index;if(void 0!==o){const e=getTypedArray(o.type,o.array);r.setIndex(new BufferAttribute(e,1))}const s=e.data.attributes;for(const t in s){const i=s[t];let o;if(i.isInterleavedBufferAttribute){const t=n(e.data,i.data);o=new InterleavedBufferAttribute(t,i.itemSize,i.offset,i.normalized)}else{const e=getTypedArray(i.type,i.array);o=new(i.isInstancedBufferAttribute?InstancedBufferAttribute:BufferAttribute)(e,i.itemSize,i.normalized)}void 0!==i.name&&(o.name=i.name),void 0!==i.usage&&o.setUsage(i.usage),r.setAttribute(t,o)}const a=e.data.morphAttributes;if(a)for(const t in a){const i=a[t],o=[];for(let t=0,r=i.length;t<r;t++){const r=i[t];let s;if(r.isInterleavedBufferAttribute){const t=n(e.data,r.data);s=new InterleavedBufferAttribute(t,r.itemSize,r.offset,r.normalized)}else{const e=getTypedArray(r.type,r.array);s=new BufferAttribute(e,r.itemSize,r.normalized)}void 0!==r.name&&(s.name=r.name),o.push(s)}r.morphAttributes[t]=o}e.data.morphTargetsRelative&&(r.morphTargetsRelative=!0);const l=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==l)for(let e=0,t=l.length;e!==t;++e){const t=l[e];r.addGroup(t.start,t.count,t.materialIndex)}const c=e.data.boundingSphere;return void 0!==c&&(r.boundingSphere=(new Sphere).fromJSON(c)),e.name&&(r.name=e.name),e.userData&&(r.userData=e.userData),r}}class ObjectLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){const r=this,o=""===this.path?LoaderUtils.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||o;const s=new FileLoader(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,(function(i){let o=null;try{o=JSON.parse(i)}catch(t){return void 0!==n&&n(t),void t("ObjectLoader: Can't parse "+e+".",t.message)}const s=o.metadata;if(void 0===s||void 0===s.type||"geometry"===s.type.toLowerCase())return void 0!==n&&n(new Error("THREE.ObjectLoader: Can't load "+e)),void error("ObjectLoader: Can't load "+e);r.parse(o,t)}),i,n)}async loadAsync(e,t){const i=""===this.path?LoaderUtils.extractUrlBase(e):this.path;this.resourcePath=this.resourcePath||i;const n=new FileLoader(this.manager);n.setPath(this.path),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials);const r=await n.loadAsync(e,t),o=JSON.parse(r),s=o.metadata;if(void 0===s||void 0===s.type||"geometry"===s.type.toLowerCase())throw new Error("THREE.ObjectLoader: Can't load "+e);return await this.parseAsync(o)}parse(e,t){const i=this.parseAnimations(e.animations),n=this.parseShapes(e.shapes),r=this.parseGeometries(e.geometries,n),o=this.parseImages(e.images,(function(){void 0!==t&&t(l)})),s=this.parseTextures(e.textures,o),a=this.parseMaterials(e.materials,s),l=this.parseObject(e.object,r,a,s,i),c=this.parseSkeletons(e.skeletons,l);if(this.bindSkeletons(l,c),this.bindLightTargets(l),void 0!==t){let e=!1;for(const t in o)if(o[t].data instanceof HTMLImageElement){e=!0;break}!1===e&&t(l)}return l}async parseAsync(e){const t=this.parseAnimations(e.animations),i=this.parseShapes(e.shapes),n=this.parseGeometries(e.geometries,i),r=await this.parseImagesAsync(e.images),o=this.parseTextures(e.textures,r),s=this.parseMaterials(e.materials,o),a=this.parseObject(e.object,n,s,o,t),l=this.parseSkeletons(e.skeletons,a);return this.bindSkeletons(a,l),this.bindLightTargets(a),a}parseShapes(e){const t={};if(void 0!==e)for(let i=0,n=e.length;i<n;i++){const n=(new Shape).fromJSON(e[i]);t[n.uuid]=n}return t}parseSkeletons(e,t){const i={},n={};if(t.traverse((function(e){e.isBone&&(n[e.uuid]=e)})),void 0!==e)for(let t=0,r=e.length;t<r;t++){const r=(new Skeleton).fromJSON(e[t],n);i[r.uuid]=r}return i}parseGeometries(e,t){const i={};if(void 0!==e){const n=new BufferGeometryLoader;for(let r=0,o=e.length;r<o;r++){let o;const s=e[r];switch(s.type){case"BufferGeometry":case"InstancedBufferGeometry":o=n.parse(s);break;default:s.type in Geometries?o=Geometries[s.type].fromJSON(s,t):warn(`ObjectLoader: Unsupported geometry type "${s.type}"`)}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),void 0!==s.userData&&(o.userData=s.userData),i[s.uuid]=o}}return i}parseMaterials(e,t){const i={},n={};if(void 0!==e){const r=new MaterialLoader;r.setTextures(t);for(let t=0,o=e.length;t<o;t++){const o=e[t];void 0===i[o.uuid]&&(i[o.uuid]=r.parse(o)),n[o.uuid]=i[o.uuid]}}return n}parseAnimations(e){const t={};if(void 0!==e)for(let i=0;i<e.length;i++){const n=AnimationClip.parse(e[i]);t[n.uuid]=n}return t}parseImages(e,t){const i=this,n={};let r;function o(e){if("string"==typeof e){const t=e;return function(e){return i.manager.itemStart(e),r.load(e,(function(){i.manager.itemEnd(e)}),void 0,(function(){i.manager.itemError(e),i.manager.itemEnd(e)}))}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(t)?t:i.resourcePath+t)}return e.data?{data:getTypedArray(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){const i=new LoadingManager(t);r=new ImageLoader(i),r.setCrossOrigin(this.crossOrigin);for(let t=0,i=e.length;t<i;t++){const i=e[t],r=i.url;if(Array.isArray(r)){const e=[];for(let t=0,i=r.length;t<i;t++){const i=o(r[t]);null!==i&&(i instanceof HTMLImageElement?e.push(i):e.push(new DataTexture(i.data,i.width,i.height)))}n[i.uuid]=new Source(e)}else{const e=o(i.url);n[i.uuid]=new Source(e)}}}return n}async parseImagesAsync(e){const t=this,i={};let n;async function r(e){if("string"==typeof e){const i=e,r=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(i)?i:t.resourcePath+i;return await n.loadAsync(r)}return e.data?{data:getTypedArray(e.type,e.data),width:e.width,height:e.height}:null}if(void 0!==e&&e.length>0){n=new ImageLoader(this.manager),n.setCrossOrigin(this.crossOrigin);for(let t=0,n=e.length;t<n;t++){const n=e[t],o=n.url;if(Array.isArray(o)){const e=[];for(let t=0,i=o.length;t<i;t++){const i=o[t],n=await r(i);null!==n&&(n instanceof HTMLImageElement?e.push(n):e.push(new DataTexture(n.data,n.width,n.height)))}i[n.uuid]=new Source(e)}else{const e=await r(n.url);i[n.uuid]=new Source(e)}}}return i}parseTextures(e,t){function i(e,t){return"number"==typeof e?e:(warn("ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}const n={};if(void 0!==e)for(let r=0,o=e.length;r<o;r++){const o=e[r];void 0===o.image&&warn('ObjectLoader: No "image" specified for',o.uuid),void 0===t[o.image]&&warn("ObjectLoader: Undefined image",o.image);const s=t[o.image],a=s.data;let l;Array.isArray(a)?(l=new CubeTexture,6===a.length&&(l.needsUpdate=!0)):(l=a&&a.data?new DataTexture:new Texture,a&&(l.needsUpdate=!0)),l.source=s,l.uuid=o.uuid,void 0!==o.name&&(l.name=o.name),void 0!==o.mapping&&(l.mapping=i(o.mapping,TEXTURE_MAPPING)),void 0!==o.channel&&(l.channel=o.channel),void 0!==o.offset&&l.offset.fromArray(o.offset),void 0!==o.repeat&&l.repeat.fromArray(o.repeat),void 0!==o.center&&l.center.fromArray(o.center),void 0!==o.rotation&&(l.rotation=o.rotation),void 0!==o.wrap&&(l.wrapS=i(o.wrap[0],TEXTURE_WRAPPING),l.wrapT=i(o.wrap[1],TEXTURE_WRAPPING)),void 0!==o.format&&(l.format=o.format),void 0!==o.internalFormat&&(l.internalFormat=o.internalFormat),void 0!==o.type&&(l.type=o.type),void 0!==o.colorSpace&&(l.colorSpace=o.colorSpace),void 0!==o.minFilter&&(l.minFilter=i(o.minFilter,TEXTURE_FILTER)),void 0!==o.magFilter&&(l.magFilter=i(o.magFilter,TEXTURE_FILTER)),void 0!==o.anisotropy&&(l.anisotropy=o.anisotropy),void 0!==o.flipY&&(l.flipY=o.flipY),void 0!==o.generateMipmaps&&(l.generateMipmaps=o.generateMipmaps),void 0!==o.premultiplyAlpha&&(l.premultiplyAlpha=o.premultiplyAlpha),void 0!==o.unpackAlignment&&(l.unpackAlignment=o.unpackAlignment),void 0!==o.compareFunction&&(l.compareFunction=o.compareFunction),void 0!==o.userData&&(l.userData=o.userData),n[o.uuid]=l}return n}parseObject(e,t,i,n,r){let o,s,a;function l(e){return void 0===t[e]&&warn("ObjectLoader: Undefined geometry",e),t[e]}function c(e){if(void 0!==e){if(Array.isArray(e)){const t=[];for(let n=0,r=e.length;n<r;n++){const r=e[n];void 0===i[r]&&warn("ObjectLoader: Undefined material",r),t.push(i[r])}return t}return void 0===i[e]&&warn("ObjectLoader: Undefined material",e),i[e]}}function u(e){return void 0===n[e]&&warn("ObjectLoader: Undefined texture",e),n[e]}switch(e.type){case"Scene":o=new Scene,void 0!==e.background&&(o.background=Number.isInteger(e.background)?new Color(e.background):u(e.background)),void 0!==e.environment&&(o.environment=u(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?o.fog=new Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(o.fog=new FogExp2(e.fog.color,e.fog.density)),""!==e.fog.name&&(o.fog.name=e.fog.name)),void 0!==e.backgroundBlurriness&&(o.backgroundBlurriness=e.backgroundBlurriness),void 0!==e.backgroundIntensity&&(o.backgroundIntensity=e.backgroundIntensity),void 0!==e.backgroundRotation&&o.backgroundRotation.fromArray(e.backgroundRotation),void 0!==e.environmentIntensity&&(o.environmentIntensity=e.environmentIntensity),void 0!==e.environmentRotation&&o.environmentRotation.fromArray(e.environmentRotation);break;case"PerspectiveCamera":o=new PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(o.focus=e.focus),void 0!==e.zoom&&(o.zoom=e.zoom),void 0!==e.filmGauge&&(o.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(o.filmOffset=e.filmOffset),void 0!==e.view&&(o.view=Object.assign({},e.view));break;case"OrthographicCamera":o=new OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(o.zoom=e.zoom),void 0!==e.view&&(o.view=Object.assign({},e.view));break;case"AmbientLight":o=new AmbientLight(e.color,e.intensity);break;case"DirectionalLight":o=new DirectionalLight(e.color,e.intensity),o.target=e.target||"";break;case"PointLight":o=new PointLight(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":o=new RectAreaLight(e.color,e.intensity,e.width,e.height);break;case"SpotLight":o=new SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay),o.target=e.target||"";break;case"HemisphereLight":o=new HemisphereLight(e.color,e.groundColor,e.intensity);break;case"LightProbe":const t=(new SphericalHarmonics3).fromArray(e.sh);o=new LightProbe(t,e.intensity);break;case"SkinnedMesh":s=l(e.geometry),a=c(e.material),o=new SkinnedMesh(s,a),void 0!==e.bindMode&&(o.bindMode=e.bindMode),void 0!==e.bindMatrix&&o.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(o.skeleton=e.skeleton);break;case"Mesh":s=l(e.geometry),a=c(e.material),o=new Mesh(s,a);break;case"InstancedMesh":s=l(e.geometry),a=c(e.material);const i=e.instanceMatrix,n=e.instanceColor;o=new InstancedMesh(s,a,e.count),o.instanceMatrix=new InstancedBufferAttribute(new Float32Array(i.array),16),void 0!==n&&(o.instanceColor=new InstancedBufferAttribute(new Float32Array(n.array),n.itemSize));break;case"BatchedMesh":s=l(e.geometry),a=c(e.material),o=new BatchedMesh(e.maxInstanceCount,e.maxVertexCount,e.maxIndexCount,a),o.geometry=s,o.perObjectFrustumCulled=e.perObjectFrustumCulled,o.sortObjects=e.sortObjects,o._drawRanges=e.drawRanges,o._reservedRanges=e.reservedRanges,o._geometryInfo=e.geometryInfo.map((e=>{let t=null,i=null;return void 0!==e.boundingBox&&(t=(new Box3).fromJSON(e.boundingBox)),void 0!==e.boundingSphere&&(i=(new Sphere).fromJSON(e.boundingSphere)),{...e,boundingBox:t,boundingSphere:i}})),o._instanceInfo=e.instanceInfo,o._availableInstanceIds=e._availableInstanceIds,o._availableGeometryIds=e._availableGeometryIds,o._nextIndexStart=e.nextIndexStart,o._nextVertexStart=e.nextVertexStart,o._geometryCount=e.geometryCount,o._maxInstanceCount=e.maxInstanceCount,o._maxVertexCount=e.maxVertexCount,o._maxIndexCount=e.maxIndexCount,o._geometryInitialized=e.geometryInitialized,o._matricesTexture=u(e.matricesTexture.uuid),o._indirectTexture=u(e.indirectTexture.uuid),void 0!==e.colorsTexture&&(o._colorsTexture=u(e.colorsTexture.uuid)),void 0!==e.boundingSphere&&(o.boundingSphere=(new Sphere).fromJSON(e.boundingSphere)),void 0!==e.boundingBox&&(o.boundingBox=(new Box3).fromJSON(e.boundingBox));break;case"LOD":o=new LOD;break;case"Line":o=new Line(l(e.geometry),c(e.material));break;case"LineLoop":o=new LineLoop(l(e.geometry),c(e.material));break;case"LineSegments":o=new LineSegments(l(e.geometry),c(e.material));break;case"PointCloud":case"Points":o=new Points(l(e.geometry),c(e.material));break;case"Sprite":o=new Sprite(c(e.material));break;case"Group":o=new Group;break;case"Bone":o=new Bone;break;default:o=new Object3D}if(o.uuid=e.uuid,void 0!==e.name&&(o.name=e.name),void 0!==e.matrix?(o.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(o.matrixAutoUpdate=e.matrixAutoUpdate),o.matrixAutoUpdate&&o.matrix.decompose(o.position,o.quaternion,o.scale)):(void 0!==e.position&&o.position.fromArray(e.position),void 0!==e.rotation&&o.rotation.fromArray(e.rotation),void 0!==e.quaternion&&o.quaternion.fromArray(e.quaternion),void 0!==e.scale&&o.scale.fromArray(e.scale)),void 0!==e.up&&o.up.fromArray(e.up),void 0!==e.castShadow&&(o.castShadow=e.castShadow),void 0!==e.receiveShadow&&(o.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.intensity&&(o.shadow.intensity=e.shadow.intensity),void 0!==e.shadow.bias&&(o.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(o.shadow.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(o.shadow.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&o.shadow.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(o.shadow.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(o.visible=e.visible),void 0!==e.frustumCulled&&(o.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(o.renderOrder=e.renderOrder),void 0!==e.userData&&(o.userData=e.userData),void 0!==e.layers&&(o.layers.mask=e.layers),void 0!==e.children){const s=e.children;for(let e=0;e<s.length;e++)o.add(this.parseObject(s[e],t,i,n,r))}if(void 0!==e.animations){const t=e.animations;for(let e=0;e<t.length;e++){o.animations.push(r[t[e]])}}if("LOD"===e.type){void 0!==e.autoUpdate&&(o.autoUpdate=e.autoUpdate);const t=e.levels;for(let e=0;e<t.length;e++){const i=t[e],n=o.getObjectByProperty("uuid",i.object);void 0!==n&&o.addLevel(n,i.distance,i.hysteresis)}}return o}bindSkeletons(e,t){0!==Object.keys(t).length&&e.traverse((function(e){if(!0===e.isSkinnedMesh&&void 0!==e.skeleton){const i=t[e.skeleton];void 0===i?warn("ObjectLoader: No skeleton found with UUID:",e.skeleton):e.bind(i,e.bindMatrix)}}))}bindLightTargets(e){e.traverse((function(t){if(t.isDirectionalLight||t.isSpotLight){const i=e.getObjectByProperty("uuid",t.target);t.target=void 0!==i?i:new Object3D}}))}}const TEXTURE_MAPPING={UVMapping:UVMapping,CubeReflectionMapping:CubeReflectionMapping,CubeRefractionMapping:CubeRefractionMapping,EquirectangularReflectionMapping:EquirectangularReflectionMapping,EquirectangularRefractionMapping:EquirectangularRefractionMapping,CubeUVReflectionMapping:CubeUVReflectionMapping},TEXTURE_WRAPPING={RepeatWrapping:RepeatWrapping,ClampToEdgeWrapping:ClampToEdgeWrapping,MirroredRepeatWrapping:MirroredRepeatWrapping},TEXTURE_FILTER={NearestFilter:NearestFilter,NearestMipmapNearestFilter:NearestMipmapNearestFilter,NearestMipmapLinearFilter:NearestMipmapLinearFilter,LinearFilter:LinearFilter,LinearMipmapNearestFilter:LinearMipmapNearestFilter,LinearMipmapLinearFilter:LinearMipmapLinearFilter},_errorMap=new WeakMap;class ImageBitmapLoader extends Loader{constructor(e){super(e),this.isImageBitmapLoader=!0,"undefined"==typeof createImageBitmap&&warn("ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&warn("ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"},this._abortController=new AbortController}setOptions(e){return this.options=e,this}load(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,o=Cache.get(`image-bitmap:${e}`);if(void 0!==o)return r.manager.itemStart(e),o.then?void o.then((i=>{if(!0!==_errorMap.has(o))return t&&t(i),r.manager.itemEnd(e),i;n&&n(_errorMap.get(o)),r.manager.itemError(e),r.manager.itemEnd(e)})):(setTimeout((function(){t&&t(o),r.manager.itemEnd(e)}),0),o);const s={};s.credentials="anonymous"===this.crossOrigin?"same-origin":"include",s.headers=this.requestHeader,s.signal="function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal;const a=fetch(e,s).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,Object.assign(r.options,{colorSpaceConversion:"none"}))})).then((function(i){return Cache.add(`image-bitmap:${e}`,i),t&&t(i),r.manager.itemEnd(e),i})).catch((function(t){n&&n(t),_errorMap.set(a,t),Cache.remove(`image-bitmap:${e}`),r.manager.itemError(e),r.manager.itemEnd(e)}));Cache.add(`image-bitmap:${e}`,a),r.manager.itemStart(e)}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}let _context;class AudioContext{static getContext(){return void 0===_context&&(_context=new(window.AudioContext||window.webkitAudioContext)),_context}static setContext(e){_context=e}}class AudioLoader extends Loader{constructor(e){super(e)}load(e,t,i,n){const r=this,o=new FileLoader(this.manager);function s(t){n?n(t):error(t),r.manager.itemError(e)}o.setResponseType("arraybuffer"),o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(e){try{const i=e.slice(0);AudioContext.getContext().decodeAudioData(i,(function(e){t(e)})).catch(s)}catch(e){s(e)}}),i,n)}}const _eyeRight=new Matrix4,_eyeLeft=new Matrix4,_projectionMatrix=new Matrix4;class StereoCamera{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new PerspectiveCamera,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new PerspectiveCamera,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(e){const t=this._cache;if(t.focus!==e.focus||t.fov!==e.fov||t.aspect!==e.aspect*this.aspect||t.near!==e.near||t.far!==e.far||t.zoom!==e.zoom||t.eyeSep!==this.eyeSep){t.focus=e.focus,t.fov=e.fov,t.aspect=e.aspect*this.aspect,t.near=e.near,t.far=e.far,t.zoom=e.zoom,t.eyeSep=this.eyeSep,_projectionMatrix.copy(e.projectionMatrix);const i=t.eyeSep/2,n=i*t.near/t.focus,r=t.near*Math.tan(DEG2RAD*t.fov*.5)/t.zoom;let o,s;_eyeLeft.elements[12]=-i,_eyeRight.elements[12]=i,o=-r*t.aspect+n,s=r*t.aspect+n,_projectionMatrix.elements[0]=2*t.near/(s-o),_projectionMatrix.elements[8]=(s+o)/(s-o),this.cameraL.projectionMatrix.copy(_projectionMatrix),o=-r*t.aspect-n,s=r*t.aspect-n,_projectionMatrix.elements[0]=2*t.near/(s-o),_projectionMatrix.elements[8]=(s+o)/(s-o),this.cameraR.projectionMatrix.copy(_projectionMatrix)}this.cameraL.matrixWorld.copy(e.matrixWorld).multiply(_eyeLeft),this.cameraR.matrixWorld.copy(e.matrixWorld).multiply(_eyeRight)}}class ArrayCamera extends PerspectiveCamera{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class Clock{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=performance.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=performance.now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}const _position$1=new Vector3,_quaternion$1=new Quaternion,_scale$1=new Vector3,_forward=new Vector3,_up=new Vector3;class AudioListener extends Object3D{constructor(){super(),this.type="AudioListener",this.context=AudioContext.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new Clock}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(e){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}updateMatrixWorld(e){super.updateMatrixWorld(e);const t=this.context.listener;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(_position$1,_quaternion$1,_scale$1),_forward.set(0,0,-1).applyQuaternion(_quaternion$1),_up.set(0,1,0).applyQuaternion(_quaternion$1),t.positionX){const e=this.context.currentTime+this.timeDelta;t.positionX.linearRampToValueAtTime(_position$1.x,e),t.positionY.linearRampToValueAtTime(_position$1.y,e),t.positionZ.linearRampToValueAtTime(_position$1.z,e),t.forwardX.linearRampToValueAtTime(_forward.x,e),t.forwardY.linearRampToValueAtTime(_forward.y,e),t.forwardZ.linearRampToValueAtTime(_forward.z,e),t.upX.linearRampToValueAtTime(_up.x,e),t.upY.linearRampToValueAtTime(_up.y,e),t.upZ.linearRampToValueAtTime(_up.z,e)}else t.setPosition(_position$1.x,_position$1.y,_position$1.z),t.setOrientation(_forward.x,_forward.y,_forward.z,_up.x,_up.y,_up.z)}}class Audio extends Object3D{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(!0===this.isPlaying)return void warn("Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void warn("Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+e;const t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.loopStart=this.loopStart,t.loopEnd=this.loopEnd,t.onended=this.onEnded.bind(this),t.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=t,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this;warn("Audio: this Audio has no playback control.")}stop(e=0){if(!1!==this.hasPlaybackControl)return this._progress=0,null!==this.source&&(this.source.stop(this.context.currentTime+e),this.source.onended=null),this.isPlaying=!1,this;warn("Audio: this Audio has no playback control.")}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(!1!==this._connected){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}}getFilters(){return this.filters}setFilters(e){return e||(e=[]),!0===this._connected?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){return this.detune=e,!0===this.isPlaying&&void 0!==this.source.detune&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;warn("Audio: this Audio has no playback control.")}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1,this._progress=0}getLoop(){return!1===this.hasPlaybackControl?(warn("Audio: this Audio has no playback control."),!1):this.loop}setLoop(e){if(!1!==this.hasPlaybackControl)return this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this;warn("Audio: this Audio has no playback control.")}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}copy(e,t){return super.copy(e,t),"buffer"!==e.sourceType?(warn("Audio: Audio source type cannot be copied."),this):(this.autoplay=e.autoplay,this.buffer=e.buffer,this.detune=e.detune,this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.offset=e.offset,this.duration=e.duration,this.playbackRate=e.playbackRate,this.hasPlaybackControl=e.hasPlaybackControl,this.sourceType=e.sourceType,this.filters=e.filters.slice(),this)}clone(e){return new this.constructor(this.listener).copy(this,e)}}const _position=new Vector3,_quaternion$5=new Quaternion,_scale=new Vector3,_orientation=new Vector3;class PositionalAudio extends Audio{constructor(e){super(e),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}connect(){return super.connect(),this.panner.connect(this.gain),this}disconnect(){return super.disconnect(),this.panner.disconnect(this.gain),this}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(e){return this.panner.refDistance=e,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(e){return this.panner.rolloffFactor=e,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(e){return this.panner.distanceModel=e,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(e){return this.panner.maxDistance=e,this}setDirectionalCone(e,t,i){return this.panner.coneInnerAngle=e,this.panner.coneOuterAngle=t,this.panner.coneOuterGain=i,this}updateMatrixWorld(e){if(super.updateMatrixWorld(e),!0===this.hasPlaybackControl&&!1===this.isPlaying)return;this.matrixWorld.decompose(_position,_quaternion$5,_scale),_orientation.set(0,0,1).applyQuaternion(_quaternion$5);const t=this.panner;if(t.positionX){const e=this.context.currentTime+this.listener.timeDelta;t.positionX.linearRampToValueAtTime(_position.x,e),t.positionY.linearRampToValueAtTime(_position.y,e),t.positionZ.linearRampToValueAtTime(_position.z,e),t.orientationX.linearRampToValueAtTime(_orientation.x,e),t.orientationY.linearRampToValueAtTime(_orientation.y,e),t.orientationZ.linearRampToValueAtTime(_orientation.z,e)}else t.setPosition(_position.x,_position.y,_position.z),t.setOrientation(_orientation.x,_orientation.y,_orientation.z)}}class AudioAnalyser{constructor(e,t=2048){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=t,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let e=0;const t=this.getFrequencyData();for(let i=0;i<t.length;i++)e+=t[i];return e/t.length}}class PropertyMixer{constructor(e,t,i){let n,r,o;switch(this.binding=e,this.valueSize=i,t){case"quaternion":n=this._slerp,r=this._slerpAdditive,o=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*i),this._workIndex=5;break;case"string":case"bool":n=this._select,r=this._select,o=this._setAdditiveIdentityOther,this.buffer=new Array(5*i);break;default:n=this._lerp,r=this._lerpAdditive,o=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*i)}this._mixBufferRegion=n,this._mixBufferRegionAdditive=r,this._setIdentity=o,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,t){const i=this.buffer,n=this.valueSize,r=e*n+n;let o=this.cumulativeWeight;if(0===o){for(let e=0;e!==n;++e)i[r+e]=i[e];o=t}else{o+=t;this._mixBufferRegion(i,r,0,t/o,n)}this.cumulativeWeight=o}accumulateAdditive(e){const t=this.buffer,i=this.valueSize,n=i*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(t,n,0,e,i),this.cumulativeWeightAdditive+=e}apply(e){const t=this.valueSize,i=this.buffer,n=e*t+t,r=this.cumulativeWeight,o=this.cumulativeWeightAdditive,s=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,r<1){this._mixBufferRegion(i,n,t*this._origIndex,1-r,t)}o>0&&this._mixBufferRegionAdditive(i,n,this._addIndex*t,1,t);for(let e=t,r=t+t;e!==r;++e)if(i[e]!==i[e+t]){s.setValue(i,n);break}}saveOriginalState(){const e=this.buffer,t=this.valueSize,i=t*this._origIndex;this.binding.getValue(e,i);for(let n=t,r=i;n!==r;++n)e[n]=e[i+n%t];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){this.binding.setValue(this.buffer,3*this.valueSize)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,t=e+this.valueSize;for(let i=e;i<t;i++)this.buffer[i]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,t=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[t+i]=this.buffer[e+i]}_select(e,t,i,n,r){if(n>=.5)for(let n=0;n!==r;++n)e[t+n]=e[i+n]}_slerp(e,t,i,n){Quaternion.slerpFlat(e,t,e,t,e,i,n)}_slerpAdditive(e,t,i,n,r){const o=this._workIndex*r;Quaternion.multiplyQuaternionsFlat(e,o,e,t,e,i),Quaternion.slerpFlat(e,t,e,t,e,o,n)}_lerp(e,t,i,n,r){const o=1-n;for(let s=0;s!==r;++s){const r=t+s;e[r]=e[r]*o+e[i+s]*n}}_lerpAdditive(e,t,i,n,r){for(let o=0;o!==r;++o){const r=t+o;e[r]=e[r]+e[i+o]*n}}}const _RESERVED_CHARS_RE="\\[\\]\\.:\\/",_reservedRe=new RegExp("["+_RESERVED_CHARS_RE+"]","g"),_wordChar="[^"+_RESERVED_CHARS_RE+"]",_wordCharOrDot="[^"+_RESERVED_CHARS_RE.replace("\\.","")+"]",_directoryRe=/((?:WC+[\/:])*)/.source.replace("WC",_wordChar),_nodeRe=/(WCOD+)?/.source.replace("WCOD",_wordCharOrDot),_objectRe=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",_wordChar),_propertyRe=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",_wordChar),_trackRe=new RegExp("^"+_directoryRe+_nodeRe+_objectRe+_propertyRe+"$"),_supportedObjectNames=["material","materials","bones","map"];class Composite{constructor(e,t,i){const n=i||PropertyBinding.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,n)}getValue(e,t){this.bind();const i=this._bindings[this._targetGroup.nCachedObjects_];void 0!==i&&i.getValue(e,t)}setValue(e,t){const i=this._bindings;for(let n=this._targetGroup.nCachedObjects_,r=i.length;n!==r;++n)i[n].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}}class PropertyBinding{constructor(e,t,i){this.path=t,this.parsedPath=i||PropertyBinding.parseTrackName(t),this.node=PropertyBinding.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,i){return e&&e.isAnimationObjectGroup?new PropertyBinding.Composite(e,t,i):new PropertyBinding(e,t,i)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(_reservedRe,"")}static parseTrackName(e){const t=_trackRe.exec(e);if(null===t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const e=i.nodeName.substring(n+1);-1!==_supportedObjectNames.indexOf(e)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=e)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}static findNode(e,t){if(void 0===t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const i=e.skeleton.getBoneByName(t);if(void 0!==i)return i}if(e.children){const i=function(e){for(let n=0;n<e.length;n++){const r=e[n];if(r.name===t||r.uuid===t)return r;const o=i(r.children);if(o)return o}return null},n=i(e.children);if(n)return n}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)e[t++]=i[n]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,i=t.objectName,n=t.propertyName;let r=t.propertyIndex;if(e||(e=PropertyBinding.findNode(this.rootNode,t.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void warn("PropertyBinding: No target node found for track: "+this.path+".");if(i){let n=t.objectIndex;switch(i){case"materials":if(!e.material)return void error("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void error("PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void error("PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===n){n=t;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material)return void error("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.map)return void error("PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);e=e.material.map;break;default:if(void 0===e[i])return void error("PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[i]}if(void 0!==n){if(void 0===e[n])return void error("PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[n]}}const o=e[n];if(void 0===o){return void error("PropertyBinding: Trying to update property for track: "+t.nodeName+"."+n+" but it wasn't found.",e)}let s=this.Versioning.None;this.targetObject=e,!0===e.isMaterial?s=this.Versioning.NeedsUpdate:!0===e.isObject3D&&(s=this.Versioning.MatrixWorldNeedsUpdate);let a=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===n){if(!e.geometry)return void error("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.morphAttributes)return void error("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[r]&&(r=e.morphTargetDictionary[r])}a=this.BindingType.ArrayElement,this.resolvedProperty=o,this.propertyIndex=r}else void 0!==o.fromArray&&void 0!==o.toArray?(a=this.BindingType.HasFromToArray,this.resolvedProperty=o):Array.isArray(o)?(a=this.BindingType.EntireArray,this.resolvedProperty=o):this.propertyName=n;this.getValue=this.GetterByBindingType[a],this.setValue=this.SetterByBindingTypeAndVersioning[a][s]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}PropertyBinding.Composite=Composite,PropertyBinding.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},PropertyBinding.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},PropertyBinding.prototype.GetterByBindingType=[PropertyBinding.prototype._getValue_direct,PropertyBinding.prototype._getValue_array,PropertyBinding.prototype._getValue_arrayElement,PropertyBinding.prototype._getValue_toArray],PropertyBinding.prototype.SetterByBindingTypeAndVersioning=[[PropertyBinding.prototype._setValue_direct,PropertyBinding.prototype._setValue_direct_setNeedsUpdate,PropertyBinding.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[PropertyBinding.prototype._setValue_array,PropertyBinding.prototype._setValue_array_setNeedsUpdate,PropertyBinding.prototype._setValue_array_setMatrixWorldNeedsUpdate],[PropertyBinding.prototype._setValue_arrayElement,PropertyBinding.prototype._setValue_arrayElement_setNeedsUpdate,PropertyBinding.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[PropertyBinding.prototype._setValue_fromArray,PropertyBinding.prototype._setValue_fromArray_setNeedsUpdate,PropertyBinding.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class AnimationObjectGroup{constructor(){this.isAnimationObjectGroup=!0,this.uuid=generateUUID$1(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const e={};this._indicesByUUID=e;for(let t=0,i=arguments.length;t!==i;++t)e[arguments[t].uuid]=t;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const t=this;this.stats={objects:{get total(){return t._objects.length},get inUse(){return this.total-t.nCachedObjects_}},get bindingsPerObject(){return t._bindings.length}}}add(){const e=this._objects,t=this._indicesByUUID,i=this._paths,n=this._parsedPaths,r=this._bindings,o=r.length;let s,a=e.length,l=this.nCachedObjects_;for(let c=0,u=arguments.length;c!==u;++c){const u=arguments[c],h=u.uuid;let d=t[h];if(void 0===d){d=a++,t[h]=d,e.push(u);for(let e=0,t=o;e!==t;++e)r[e].push(new PropertyBinding(u,i[e],n[e]))}else if(d<l){s=e[d];const a=--l,c=e[a];t[c.uuid]=d,e[d]=c,t[h]=a,e[a]=u;for(let e=0,t=o;e!==t;++e){const t=r[e];let o=t[d];t[d]=t[a],void 0===o&&(o=new PropertyBinding(u,i[e],n[e])),t[a]=o}}else e[d]!==s&&error("AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=l}remove(){const e=this._objects,t=this._indicesByUUID,i=this._bindings,n=i.length;let r=this.nCachedObjects_;for(let o=0,s=arguments.length;o!==s;++o){const s=arguments[o],a=s.uuid,l=t[a];if(void 0!==l&&l>=r){const o=r++,c=e[o];t[c.uuid]=l,e[l]=c,t[a]=o,e[o]=s;for(let e=0,t=n;e!==t;++e){const t=i[e],n=t[l];t[l]=t[o],t[o]=n}}}this.nCachedObjects_=r}uncache(){const e=this._objects,t=this._indicesByUUID,i=this._bindings,n=i.length;let r=this.nCachedObjects_,o=e.length;for(let s=0,a=arguments.length;s!==a;++s){const a=arguments[s].uuid,l=t[a];if(void 0!==l)if(delete t[a],l<r){const s=--r,a=e[s],c=--o,u=e[c];t[a.uuid]=l,e[l]=a,t[u.uuid]=s,e[s]=u,e.pop();for(let e=0,t=n;e!==t;++e){const t=i[e],n=t[c];t[l]=t[s],t[s]=n,t.pop()}}else{const r=--o,s=e[r];r>0&&(t[s.uuid]=l),e[l]=s,e.pop();for(let e=0,t=n;e!==t;++e){const t=i[e];t[l]=t[r],t.pop()}}}this.nCachedObjects_=r}subscribe_(e,t){const i=this._bindingsIndicesByPath;let n=i[e];const r=this._bindings;if(void 0!==n)return r[n];const o=this._paths,s=this._parsedPaths,a=this._objects,l=this.nCachedObjects_,c=new Array(a.length);n=r.length,i[e]=n,o.push(e),s.push(t),r.push(c);for(let i=l,n=a.length;i!==n;++i){c[i]=new PropertyBinding(a[i],e,t)}return c}unsubscribe_(e){const t=this._bindingsIndicesByPath,i=t[e];if(void 0!==i){const n=this._paths,r=this._parsedPaths,o=this._bindings,s=o.length-1,a=o[s];t[e[s]]=i,o[i]=a,o.pop(),r[i]=r[s],r.pop(),n[i]=n[s],n.pop()}}}class AnimationAction{constructor(e,t,i=null,n=t.blendMode){this._mixer=e,this._clip=t,this._localRoot=i,this.blendMode=n;const r=t.tracks,o=r.length,s=new Array(o),a={endingStart:ZeroCurvatureEnding,endingEnd:ZeroCurvatureEnding};for(let e=0;e!==o;++e){const t=r[e].createInterpolant(null);s[e]=t,t.settings=a}this._interpolantSettings=a,this._interpolants=s,this._propertyBindings=new Array(o),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=LoopRepeat,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,t){return this.loop=e,this.repetitions=t,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,t,i=!1){if(e.fadeOut(t),this.fadeIn(t),!0===i){const i=this._clip.duration,n=e._clip.duration,r=i/n;e.warp(1,n/i,t),this.warp(r,1,t)}return this}crossFadeTo(e,t,i=!1){return e.crossFadeFrom(this,t,i)}stopFading(){const e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,t,i){const n=this._mixer,r=n.time,o=this.timeScale;let s=this._timeScaleInterpolant;null===s&&(s=n._lendControlInterpolant(),this._timeScaleInterpolant=s);const a=s.parameterPositions,l=s.sampleValues;return a[0]=r,a[1]=r+i,l[0]=e/o,l[1]=t/o,this}stopWarping(){const e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,t,i,n){if(!this.enabled)return void this._updateWeight(e);const r=this._startTime;if(null!==r){const n=(e-r)*i;n<0||0===i?t=0:(this._startTime=null,t=i*n)}t*=this._updateTimeScale(e);const o=this._updateTime(t),s=this._updateWeight(e);if(s>0){const e=this._interpolants,t=this._propertyBindings;if(this.blendMode===AdditiveAnimationBlendMode)for(let i=0,n=e.length;i!==n;++i)e[i].evaluate(o),t[i].accumulateAdditive(s);else for(let i=0,r=e.length;i!==r;++i)e[i].evaluate(o),t[i].accumulate(n,s)}}_updateWeight(e){let t=0;if(this.enabled){t=this.weight;const i=this._weightInterpolant;if(null!==i){const n=i.evaluate(e)[0];t*=n,e>i.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=t,t}_updateTimeScale(e){let t=0;if(!this.paused){t=this.timeScale;const i=this._timeScaleInterpolant;if(null!==i){t*=i.evaluate(e)[0],e>i.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t}_updateTime(e){const t=this._clip.duration,i=this.loop;let n=this.time+e,r=this._loopCount;const o=i===LoopPingPong;if(0===e)return-1===r||!o||1&~r?n:t-n;if(i===LoopOnce){-1===r&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(n>=t)n=t;else{if(!(n<0)){this.time=n;break e}n=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(-1===r&&(e>=0?(r=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),n>=t||n<0){const i=Math.floor(n/t);n-=t*i,r+=Math.abs(i);const s=this.repetitions-r;if(s<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,n=e>0?t:0,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(1===s){const t=e<0;this._setEndings(t,!t,o)}else this._setEndings(!1,!1,o);this._loopCount=r,this.time=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:i})}}else this.time=n;if(o&&!(1&~r))return t-n}return n}_setEndings(e,t,i){const n=this._interpolantSettings;i?(n.endingStart=ZeroSlopeEnding,n.endingEnd=ZeroSlopeEnding):(n.endingStart=e?this.zeroSlopeAtStart?ZeroSlopeEnding:ZeroCurvatureEnding:WrapAroundEnding,n.endingEnd=t?this.zeroSlopeAtEnd?ZeroSlopeEnding:ZeroCurvatureEnding:WrapAroundEnding)}_scheduleFading(e,t,i){const n=this._mixer,r=n.time;let o=this._weightInterpolant;null===o&&(o=n._lendControlInterpolant(),this._weightInterpolant=o);const s=o.parameterPositions,a=o.sampleValues;return s[0]=r,a[0]=t,s[1]=r+e,a[1]=i,this}}const _controlInterpolantsResultBuffer=new Float32Array(1);class AnimationMixer extends EventDispatcher{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,t){const i=e._localRoot||this._root,n=e._clip.tracks,r=n.length,o=e._propertyBindings,s=e._interpolants,a=i.uuid,l=this._bindingsByRootAndName;let c=l[a];void 0===c&&(c={},l[a]=c);for(let e=0;e!==r;++e){const r=n[e],l=r.name;let u=c[l];if(void 0!==u)++u.referenceCount,o[e]=u;else{if(u=o[e],void 0!==u){null===u._cacheIndex&&(++u.referenceCount,this._addInactiveBinding(u,a,l));continue}u=new PropertyMixer(PropertyBinding.create(i,l,t&&t._propertyBindings[e].binding.parsedPath),r.ValueTypeName,r.getValueSize()),++u.referenceCount,this._addInactiveBinding(u,a,l),o[e]=u}s[e].resultBuffer=u.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){const t=(e._localRoot||this._root).uuid,i=e._clip.uuid,n=this._actionsByClip[i];this._bindAction(e,n&&n.knownActions[0]),this._addInactiveAction(e,i,t)}const t=e._propertyBindings;for(let e=0,i=t.length;e!==i;++e){const i=t[e];0==i.useCount++&&(this._lendBinding(i),i.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const t=e._propertyBindings;for(let e=0,i=t.length;e!==i;++e){const i=t[e];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const t=e._cacheIndex;return null!==t&&t<this._nActiveActions}_addInactiveAction(e,t,i){const n=this._actions,r=this._actionsByClip;let o=r[t];if(void 0===o)o={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,r[t]=o;else{const t=o.knownActions;e._byClipCacheIndex=t.length,t.push(e)}e._cacheIndex=n.length,n.push(e),o.actionByRoot[i]=e}_removeInactiveAction(e){const t=this._actions,i=t[t.length-1],n=e._cacheIndex;i._cacheIndex=n,t[n]=i,t.pop(),e._cacheIndex=null;const r=e._clip.uuid,o=this._actionsByClip,s=o[r],a=s.knownActions,l=a[a.length-1],c=e._byClipCacheIndex;l._byClipCacheIndex=c,a[c]=l,a.pop(),e._byClipCacheIndex=null;delete s.actionByRoot[(e._localRoot||this._root).uuid],0===a.length&&delete o[r],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const t=e._propertyBindings;for(let e=0,i=t.length;e!==i;++e){const i=t[e];0==--i.referenceCount&&this._removeInactiveBinding(i)}}_lendAction(e){const t=this._actions,i=e._cacheIndex,n=this._nActiveActions++,r=t[n];e._cacheIndex=n,t[n]=e,r._cacheIndex=i,t[i]=r}_takeBackAction(e){const t=this._actions,i=e._cacheIndex,n=--this._nActiveActions,r=t[n];e._cacheIndex=n,t[n]=e,r._cacheIndex=i,t[i]=r}_addInactiveBinding(e,t,i){const n=this._bindingsByRootAndName,r=this._bindings;let o=n[t];void 0===o&&(o={},n[t]=o),o[i]=e,e._cacheIndex=r.length,r.push(e)}_removeInactiveBinding(e){const t=this._bindings,i=e.binding,n=i.rootNode.uuid,r=i.path,o=this._bindingsByRootAndName,s=o[n],a=t[t.length-1],l=e._cacheIndex;a._cacheIndex=l,t[l]=a,t.pop(),delete s[r],0===Object.keys(s).length&&delete o[n]}_lendBinding(e){const t=this._bindings,i=e._cacheIndex,n=this._nActiveBindings++,r=t[n];e._cacheIndex=n,t[n]=e,r._cacheIndex=i,t[i]=r}_takeBackBinding(e){const t=this._bindings,i=e._cacheIndex,n=--this._nActiveBindings,r=t[n];e._cacheIndex=n,t[n]=e,r._cacheIndex=i,t[i]=r}_lendControlInterpolant(){const e=this._controlInterpolants,t=this._nActiveControlInterpolants++;let i=e[t];return void 0===i&&(i=new LinearInterpolant(new Float32Array(2),new Float32Array(2),1,_controlInterpolantsResultBuffer),i.__cacheIndex=t,e[t]=i),i}_takeBackControlInterpolant(e){const t=this._controlInterpolants,i=e.__cacheIndex,n=--this._nActiveControlInterpolants,r=t[n];e.__cacheIndex=n,t[n]=e,r.__cacheIndex=i,t[i]=r}clipAction(e,t,i){const n=t||this._root,r=n.uuid;let o="string"==typeof e?AnimationClip.findByName(n,e):e;const s=null!==o?o.uuid:e,a=this._actionsByClip[s];let l=null;if(void 0===i&&(i=null!==o?o.blendMode:NormalAnimationBlendMode),void 0!==a){const e=a.actionByRoot[r];if(void 0!==e&&e.blendMode===i)return e;l=a.knownActions[0],null===o&&(o=l._clip)}if(null===o)return null;const c=new AnimationAction(this,o,t,i);return this._bindAction(c,l),this._addInactiveAction(c,s,r),c}existingAction(e,t){const i=t||this._root,n=i.uuid,r="string"==typeof e?AnimationClip.findByName(i,e):e,o=this._actionsByClip[r?r.uuid:e];return void 0!==o&&o.actionByRoot[n]||null}stopAllAction(){const e=this._actions;for(let t=this._nActiveActions-1;t>=0;--t)e[t].stop();return this}update(e){const t=this._actions,i=this._nActiveActions,n=this.time+=e*=this.timeScale,r=Math.sign(e),o=this._accuIndex^=1;for(let s=0;s!==i;++s){t[s]._update(n,e,r,o)}const s=this._bindings,a=this._nActiveBindings;for(let e=0;e!==a;++e)s[e].apply(o);return this}setTime(e){this.time=0;for(let e=0;e<this._actions.length;e++)this._actions[e].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const t=this._actions,i=e.uuid,n=this._actionsByClip,r=n[i];if(void 0!==r){const e=r.knownActions;for(let i=0,n=e.length;i!==n;++i){const n=e[i];this._deactivateAction(n);const r=n._cacheIndex,o=t[t.length-1];n._cacheIndex=null,n._byClipCacheIndex=null,o._cacheIndex=r,t[r]=o,t.pop(),this._removeInactiveBindingsForAction(n)}delete n[i]}}uncacheRoot(e){const t=e.uuid,i=this._actionsByClip;for(const e in i){const n=i[e].actionByRoot[t];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}const n=this._bindingsByRootAndName[t];if(void 0!==n)for(const e in n){const t=n[e];t.restoreOriginalState(),this._removeInactiveBinding(t)}}uncacheAction(e,t){const i=this.existingAction(e,t);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}}class RenderTarget3D extends RenderTarget{constructor(e=1,t=1,i=1,n={}){super(e,t,n),this.isRenderTarget3D=!0,this.depth=i,this.texture=new Data3DTexture(null,e,t,i),this._setTextureOptions(n),this.texture.isRenderTargetTexture=!0}}class Uniform{constructor(e){this.value=e}clone(){return new Uniform(void 0===this.value.clone?this.value:this.value.clone())}}let _id$3=0;class UniformsGroup extends EventDispatcher{constructor(){super(),this.isUniformsGroup=!0,Object.defineProperty(this,"id",{value:_id$3++}),this.name="",this.usage=StaticDrawUsage,this.uniforms=[]}add(e){return this.uniforms.push(e),this}remove(e){const t=this.uniforms.indexOf(e);return-1!==t&&this.uniforms.splice(t,1),this}setName(e){return this.name=e,this}setUsage(e){return this.usage=e,this}dispose(){this.dispatchEvent({type:"dispose"})}copy(e){this.name=e.name,this.usage=e.usage;const t=e.uniforms;this.uniforms.length=0;for(let e=0,i=t.length;e<i;e++){const i=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0;e<i.length;e++)this.uniforms.push(i[e].clone())}return this}clone(){return(new this.constructor).copy(this)}}class InstancedInterleavedBuffer extends InterleavedBuffer{constructor(e,t,i=1){super(e,t),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=i}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){const t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}class GLBufferAttribute{constructor(e,t,i,n,r,o=!1){this.isGLBufferAttribute=!0,this.name="",this.buffer=e,this.type=t,this.itemSize=i,this.elementSize=n,this.count=r,this.normalized=o,this.version=0}set needsUpdate(e){!0===e&&this.version++}setBuffer(e){return this.buffer=e,this}setType(e,t){return this.type=e,this.elementSize=t,this}setItemSize(e){return this.itemSize=e,this}setCount(e){return this.count=e,this}}const _matrix=new Matrix4;class Raycaster{constructor(e,t,i=0,n=1/0){this.ray=new Ray(e,t),this.near=i,this.far=n,this.camera=null,this.layers=new Layers,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):error("Raycaster: Unsupported camera type: "+t.type)}setFromXRController(e){return _matrix.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(_matrix),this}intersectObject(e,t=!0,i=[]){return intersect(e,this,i,t),i.sort(ascSort),i}intersectObjects(e,t=!0,i=[]){for(let n=0,r=e.length;n<r;n++)intersect(e[n],this,i,t);return i.sort(ascSort),i}}function ascSort(e,t){return e.distance-t.distance}function intersect(e,t,i,n){let r=!0;if(e.layers.test(t.layers)){!1===e.raycast(t,i)&&(r=!1)}if(!0===r&&!0===n){const n=e.children;for(let e=0,r=n.length;e<r;e++)intersect(n[e],t,i,!0)}}class Timer{constructor(){this._previousTime=0,this._currentTime=0,this._startTime=performance.now(),this._delta=0,this._elapsed=0,this._timescale=1,this._document=null,this._pageVisibilityHandler=null}connect(e){this._document=e,void 0!==e.hidden&&(this._pageVisibilityHandler=handleVisibilityChange.bind(this),e.addEventListener("visibilitychange",this._pageVisibilityHandler,!1))}disconnect(){null!==this._pageVisibilityHandler&&(this._document.removeEventListener("visibilitychange",this._pageVisibilityHandler),this._pageVisibilityHandler=null),this._document=null}getDelta(){return this._delta/1e3}getElapsed(){return this._elapsed/1e3}getTimescale(){return this._timescale}setTimescale(e){return this._timescale=e,this}reset(){return this._currentTime=performance.now()-this._startTime,this}dispose(){this.disconnect()}update(e){return null!==this._pageVisibilityHandler&&!0===this._document.hidden?this._delta=0:(this._previousTime=this._currentTime,this._currentTime=(void 0!==e?e:performance.now())-this._startTime,this._delta=(this._currentTime-this._previousTime)*this._timescale,this._elapsed+=this._delta),this}}function handleVisibilityChange(){!1===this._document.hidden&&this.reset()}class Spherical{constructor(e=1,t=0,i=0){this.radius=e,this.phi=t,this.theta=i}set(e,t,i){return this.radius=e,this.phi=t,this.theta=i,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=clamp(this.phi,e,Math.PI-e),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,i){return this.radius=Math.sqrt(e*e+t*t+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,i),this.phi=Math.acos(clamp(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class Cylindrical{constructor(e=1,t=0,i=0){this.radius=e,this.theta=t,this.y=i}set(e,t,i){return this.radius=e,this.theta=t,this.y=i,this}copy(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,i){return this.radius=Math.sqrt(e*e+i*i),this.theta=Math.atan2(e,i),this.y=t,this}clone(){return(new this.constructor).copy(this)}}class Matrix2{constructor(e,t,i,n){Matrix2.prototype.isMatrix2=!0,this.elements=[1,0,0,1],void 0!==e&&this.set(e,t,i,n)}identity(){return this.set(1,0,0,1),this}fromArray(e,t=0){for(let i=0;i<4;i++)this.elements[i]=e[i+t];return this}set(e,t,i,n){const r=this.elements;return r[0]=e,r[2]=t,r[1]=i,r[3]=n,this}}const _vector$4=new Vector2;class Box2{constructor(e=new Vector2(1/0,1/0),t=new Vector2(-1/0,-1/0)){this.isBox2=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=_vector$4.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(e){return this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,_vector$4).distanceTo(e)}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const _startP=new Vector3,_startEnd=new Vector3,_d1=new Vector3,_d2=new Vector3,_r=new Vector3,_c1=new Vector3,_c2=new Vector3;class Line3{constructor(e=new Vector3,t=new Vector3){this.start=e,this.end=t}set(e,t){return this.start.copy(e),this.end.copy(t),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t){return this.delta(t).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t){_startP.subVectors(e,this.start),_startEnd.subVectors(this.end,this.start);const i=_startEnd.dot(_startEnd);let n=_startEnd.dot(_startP)/i;return t&&(n=clamp(n,0,1)),n}closestPointToPoint(e,t,i){const n=this.closestPointToPointParameter(e,t);return this.delta(i).multiplyScalar(n).add(this.start)}distanceSqToLine3(e,t=_c1,i=_c2){const n=1e-8*1e-8;let r,o;const s=this.start,a=e.start,l=e.end;_d1.subVectors(this.end,s),_d2.subVectors(l,a),_r.subVectors(s,a);const c=_d1.dot(_d1),u=_d2.dot(_d2),h=_d2.dot(_r);if(c<=n&&u<=n)return t.copy(s),i.copy(a),t.sub(i),t.dot(t);if(c<=n)r=0,o=h/u,o=clamp(o,0,1);else{const e=_d1.dot(_r);if(u<=n)o=0,r=clamp(-e/c,0,1);else{const t=_d1.dot(_d2),i=c*u-t*t;r=0!==i?clamp((t*h-e*u)/i,0,1):0,o=(t*r+h)/u,o<0?(o=0,r=clamp(-e/c,0,1)):o>1&&(o=1,r=clamp((t-e)/c,0,1))}}return t.copy(s).add(_d1.multiplyScalar(r)),i.copy(a).add(_d2.multiplyScalar(o)),t.sub(i),t.dot(t)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}const _vector$3=new Vector3;class SpotLightHelper extends Object3D{constructor(e,t){super(),this.light=e,this.matrixAutoUpdate=!1,this.color=t,this.type="SpotLightHelper";const i=new BufferGeometry,n=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let e=0,t=1,i=32;e<i;e++,t++){const r=e/i*Math.PI*2,o=t/i*Math.PI*2;n.push(Math.cos(r),Math.sin(r),1,Math.cos(o),Math.sin(o),1)}i.setAttribute("position",new Float32BufferAttribute(n,3));const r=new LineBasicMaterial({fog:!1,toneMapped:!1});this.cone=new LineSegments(i,r),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1),this.parent?(this.parent.updateWorldMatrix(!0),this.matrix.copy(this.parent.matrixWorld).invert().multiply(this.light.matrixWorld)):this.matrix.copy(this.light.matrixWorld),this.matrixWorld.copy(this.light.matrixWorld);const e=this.light.distance?this.light.distance:1e3,t=e*Math.tan(this.light.angle);this.cone.scale.set(t,t,e),_vector$3.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(_vector$3),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}const _vector$2=new Vector3,_boneMatrix=new Matrix4,_matrixWorldInv=new Matrix4;class SkeletonHelper extends LineSegments{constructor(e){const t=getBoneList(e),i=new BufferGeometry,n=[],r=[];for(let e=0;e<t.length;e++){const i=t[e];i.parent&&i.parent.isBone&&(n.push(0,0,0),n.push(0,0,0),r.push(0,0,0),r.push(0,0,0))}i.setAttribute("position",new Float32BufferAttribute(n,3)),i.setAttribute("color",new Float32BufferAttribute(r,3));super(i,new LineBasicMaterial({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.isSkeletonHelper=!0,this.type="SkeletonHelper",this.root=e,this.bones=t,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;const o=new Color(255),s=new Color(65280);this.setColors(o,s)}updateMatrixWorld(e){const t=this.bones,i=this.geometry,n=i.getAttribute("position");_matrixWorldInv.copy(this.root.matrixWorld).invert();for(let e=0,i=0;e<t.length;e++){const r=t[e];r.parent&&r.parent.isBone&&(_boneMatrix.multiplyMatrices(_matrixWorldInv,r.matrixWorld),_vector$2.setFromMatrixPosition(_boneMatrix),n.setXYZ(i,_vector$2.x,_vector$2.y,_vector$2.z),_boneMatrix.multiplyMatrices(_matrixWorldInv,r.parent.matrixWorld),_vector$2.setFromMatrixPosition(_boneMatrix),n.setXYZ(i+1,_vector$2.x,_vector$2.y,_vector$2.z),i+=2)}i.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(e)}setColors(e,t){const i=this.geometry.getAttribute("color");for(let n=0;n<i.count;n+=2)i.setXYZ(n,e.r,e.g,e.b),i.setXYZ(n+1,t.r,t.g,t.b);return i.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}}function getBoneList(e){const t=[];!0===e.isBone&&t.push(e);for(let i=0;i<e.children.length;i++)t.push(...getBoneList(e.children[i]));return t}class PointLightHelper extends Mesh{constructor(e,t,i){super(new SphereGeometry(t,4,2),new MeshBasicMaterial({wireframe:!0,fog:!1,toneMapped:!1})),this.light=e,this.color=i,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)}}const _vector$1=new Vector3,_color1=new Color,_color2=new Color;class HemisphereLightHelper extends Object3D{constructor(e,t,i){super(),this.light=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,this.type="HemisphereLightHelper";const n=new OctahedronGeometry(t);n.rotateY(.5*Math.PI),this.material=new MeshBasicMaterial({wireframe:!0,fog:!1,toneMapped:!1}),void 0===this.color&&(this.material.vertexColors=!0);const r=n.getAttribute("position"),o=new Float32Array(3*r.count);n.setAttribute("color",new BufferAttribute(o,3)),this.add(new Mesh(n,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const e=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{const t=e.geometry.getAttribute("color");_color1.copy(this.light.color),_color2.copy(this.light.groundColor);for(let e=0,i=t.count;e<i;e++){const n=e<i/2?_color1:_color2;t.setXYZ(e,n.r,n.g,n.b)}t.needsUpdate=!0}this.light.updateWorldMatrix(!0,!1),e.lookAt(_vector$1.setFromMatrixPosition(this.light.matrixWorld).negate())}}class GridHelper extends LineSegments{constructor(e=10,t=10,i=4473924,n=8947848){i=new Color(i),n=new Color(n);const r=t/2,o=e/t,s=e/2,a=[],l=[];for(let e=0,c=0,u=-s;e<=t;e++,u+=o){a.push(-s,0,u,s,0,u),a.push(u,0,-s,u,0,s);const t=e===r?i:n;t.toArray(l,c),c+=3,t.toArray(l,c),c+=3,t.toArray(l,c),c+=3,t.toArray(l,c),c+=3}const c=new BufferGeometry;c.setAttribute("position",new Float32BufferAttribute(a,3)),c.setAttribute("color",new Float32BufferAttribute(l,3));super(c,new LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}class PolarGridHelper extends LineSegments{constructor(e=10,t=16,i=8,n=64,r=4473924,o=8947848){r=new Color(r),o=new Color(o);const s=[],a=[];if(t>1)for(let i=0;i<t;i++){const n=i/t*(2*Math.PI),l=Math.sin(n)*e,c=Math.cos(n)*e;s.push(0,0,0),s.push(l,0,c);const u=1&i?r:o;a.push(u.r,u.g,u.b),a.push(u.r,u.g,u.b)}for(let t=0;t<i;t++){const l=1&t?r:o,c=e-e/i*t;for(let e=0;e<n;e++){let t=e/n*(2*Math.PI),i=Math.sin(t)*c,r=Math.cos(t)*c;s.push(i,0,r),a.push(l.r,l.g,l.b),t=(e+1)/n*(2*Math.PI),i=Math.sin(t)*c,r=Math.cos(t)*c,s.push(i,0,r),a.push(l.r,l.g,l.b)}}const l=new BufferGeometry;l.setAttribute("position",new Float32BufferAttribute(s,3)),l.setAttribute("color",new Float32BufferAttribute(a,3));super(l,new LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}const _v1=new Vector3,_v2=new Vector3,_v3=new Vector3;class DirectionalLightHelper extends Object3D{constructor(e,t,i){super(),this.light=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,this.type="DirectionalLightHelper",void 0===t&&(t=1);let n=new BufferGeometry;n.setAttribute("position",new Float32BufferAttribute([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));const r=new LineBasicMaterial({fog:!1,toneMapped:!1});this.lightPlane=new Line(n,r),this.add(this.lightPlane),n=new BufferGeometry,n.setAttribute("position",new Float32BufferAttribute([0,0,0,0,0,1],3)),this.targetLine=new Line(n,r),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1),_v1.setFromMatrixPosition(this.light.matrixWorld),_v2.setFromMatrixPosition(this.light.target.matrixWorld),_v3.subVectors(_v2,_v1),this.lightPlane.lookAt(_v2),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(_v2),this.targetLine.scale.z=_v3.length()}}const _vector=new Vector3,_camera$1=new Camera;class CameraHelper extends LineSegments{constructor(e){const t=new BufferGeometry,i=new LineBasicMaterial({color:16777215,vertexColors:!0,toneMapped:!1}),n=[],r=[],o={};function s(e,t){a(e),a(t)}function a(e){n.push(0,0,0),r.push(0,0,0),void 0===o[e]&&(o[e]=[]),o[e].push(n.length/3-1)}s("n1","n2"),s("n2","n4"),s("n4","n3"),s("n3","n1"),s("f1","f2"),s("f2","f4"),s("f4","f3"),s("f3","f1"),s("n1","f1"),s("n2","f2"),s("n3","f3"),s("n4","f4"),s("p","n1"),s("p","n2"),s("p","n3"),s("p","n4"),s("u1","u2"),s("u2","u3"),s("u3","u1"),s("c","t"),s("p","c"),s("cn1","cn2"),s("cn3","cn4"),s("cf1","cf2"),s("cf3","cf4"),t.setAttribute("position",new Float32BufferAttribute(n,3)),t.setAttribute("color",new Float32BufferAttribute(r,3)),super(t,i),this.type="CameraHelper",this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=o,this.update();const l=new Color(16755200),c=new Color(16711680),u=new Color(43775),h=new Color(16777215),d=new Color(3355443);this.setColors(l,c,u,h,d)}setColors(e,t,i,n,r){const o=this.geometry.getAttribute("color");return o.setXYZ(0,e.r,e.g,e.b),o.setXYZ(1,e.r,e.g,e.b),o.setXYZ(2,e.r,e.g,e.b),o.setXYZ(3,e.r,e.g,e.b),o.setXYZ(4,e.r,e.g,e.b),o.setXYZ(5,e.r,e.g,e.b),o.setXYZ(6,e.r,e.g,e.b),o.setXYZ(7,e.r,e.g,e.b),o.setXYZ(8,e.r,e.g,e.b),o.setXYZ(9,e.r,e.g,e.b),o.setXYZ(10,e.r,e.g,e.b),o.setXYZ(11,e.r,e.g,e.b),o.setXYZ(12,e.r,e.g,e.b),o.setXYZ(13,e.r,e.g,e.b),o.setXYZ(14,e.r,e.g,e.b),o.setXYZ(15,e.r,e.g,e.b),o.setXYZ(16,e.r,e.g,e.b),o.setXYZ(17,e.r,e.g,e.b),o.setXYZ(18,e.r,e.g,e.b),o.setXYZ(19,e.r,e.g,e.b),o.setXYZ(20,e.r,e.g,e.b),o.setXYZ(21,e.r,e.g,e.b),o.setXYZ(22,e.r,e.g,e.b),o.setXYZ(23,e.r,e.g,e.b),o.setXYZ(24,t.r,t.g,t.b),o.setXYZ(25,t.r,t.g,t.b),o.setXYZ(26,t.r,t.g,t.b),o.setXYZ(27,t.r,t.g,t.b),o.setXYZ(28,t.r,t.g,t.b),o.setXYZ(29,t.r,t.g,t.b),o.setXYZ(30,t.r,t.g,t.b),o.setXYZ(31,t.r,t.g,t.b),o.setXYZ(32,i.r,i.g,i.b),o.setXYZ(33,i.r,i.g,i.b),o.setXYZ(34,i.r,i.g,i.b),o.setXYZ(35,i.r,i.g,i.b),o.setXYZ(36,i.r,i.g,i.b),o.setXYZ(37,i.r,i.g,i.b),o.setXYZ(38,n.r,n.g,n.b),o.setXYZ(39,n.r,n.g,n.b),o.setXYZ(40,r.r,r.g,r.b),o.setXYZ(41,r.r,r.g,r.b),o.setXYZ(42,r.r,r.g,r.b),o.setXYZ(43,r.r,r.g,r.b),o.setXYZ(44,r.r,r.g,r.b),o.setXYZ(45,r.r,r.g,r.b),o.setXYZ(46,r.r,r.g,r.b),o.setXYZ(47,r.r,r.g,r.b),o.setXYZ(48,r.r,r.g,r.b),o.setXYZ(49,r.r,r.g,r.b),o.needsUpdate=!0,this}update(){const e=this.geometry,t=this.pointMap;let i,n;if(_camera$1.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),!0===this.camera.reversedDepth)i=1,n=0;else if(this.camera.coordinateSystem===WebGLCoordinateSystem)i=-1,n=1;else{if(this.camera.coordinateSystem!==WebGPUCoordinateSystem)throw new Error("THREE.CameraHelper.update(): Invalid coordinate system: "+this.camera.coordinateSystem);i=0,n=1}setPoint("c",t,e,_camera$1,0,0,i),setPoint("t",t,e,_camera$1,0,0,n),setPoint("n1",t,e,_camera$1,-1,-1,i),setPoint("n2",t,e,_camera$1,1,-1,i),setPoint("n3",t,e,_camera$1,-1,1,i),setPoint("n4",t,e,_camera$1,1,1,i),setPoint("f1",t,e,_camera$1,-1,-1,n),setPoint("f2",t,e,_camera$1,1,-1,n),setPoint("f3",t,e,_camera$1,-1,1,n),setPoint("f4",t,e,_camera$1,1,1,n),setPoint("u1",t,e,_camera$1,.7,1.1,i),setPoint("u2",t,e,_camera$1,-.7,1.1,i),setPoint("u3",t,e,_camera$1,0,2,i),setPoint("cf1",t,e,_camera$1,-1,0,n),setPoint("cf2",t,e,_camera$1,1,0,n),setPoint("cf3",t,e,_camera$1,0,-1,n),setPoint("cf4",t,e,_camera$1,0,1,n),setPoint("cn1",t,e,_camera$1,-1,0,i),setPoint("cn2",t,e,_camera$1,1,0,i),setPoint("cn3",t,e,_camera$1,0,-1,i),setPoint("cn4",t,e,_camera$1,0,1,i),e.getAttribute("position").needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}}function setPoint(e,t,i,n,r,o,s){_vector.set(r,o,s).unproject(n);const a=t[e];if(void 0!==a){const e=i.getAttribute("position");for(let t=0,i=a.length;t<i;t++)e.setXYZ(a[t],_vector.x,_vector.y,_vector.z)}}const _box=new Box3;class BoxHelper extends LineSegments{constructor(e,t=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),r=new BufferGeometry;r.setIndex(new BufferAttribute(i,1)),r.setAttribute("position",new BufferAttribute(n,3)),super(r,new LineBasicMaterial({color:t,toneMapped:!1})),this.object=e,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(){if(void 0!==this.object&&_box.setFromObject(this.object),_box.isEmpty())return;const e=_box.min,t=_box.max,i=this.geometry.attributes.position,n=i.array;n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=e.x,n[4]=t.y,n[5]=t.z,n[6]=e.x,n[7]=e.y,n[8]=t.z,n[9]=t.x,n[10]=e.y,n[11]=t.z,n[12]=t.x,n[13]=t.y,n[14]=e.z,n[15]=e.x,n[16]=t.y,n[17]=e.z,n[18]=e.x,n[19]=e.y,n[20]=e.z,n[21]=t.x,n[22]=e.y,n[23]=e.z,i.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(e){return this.object=e,this.update(),this}copy(e,t){return super.copy(e,t),this.object=e.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class Box3Helper extends LineSegments{constructor(e,t=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new BufferGeometry;n.setIndex(new BufferAttribute(i,1)),n.setAttribute("position",new Float32BufferAttribute([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(n,new LineBasicMaterial({color:t,toneMapped:!1})),this.box=e,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}dispose(){this.geometry.dispose(),this.material.dispose()}}class PlaneHelper extends Line{constructor(e,t=1,i=16776960){const n=i,r=new BufferGeometry;r.setAttribute("position",new Float32BufferAttribute([1,-1,0,-1,1,0,-1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,-1,0,1,1,0],3)),r.computeBoundingSphere(),super(r,new LineBasicMaterial({color:n,toneMapped:!1})),this.type="PlaneHelper",this.plane=e,this.size=t;const o=new BufferGeometry;o.setAttribute("position",new Float32BufferAttribute([1,1,0,-1,1,0,-1,-1,0,1,1,0,-1,-1,0,1,-1,0],3)),o.computeBoundingSphere(),this.add(new Mesh(o,new MeshBasicMaterial({color:n,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(e){this.position.set(0,0,0),this.scale.set(.5*this.size,.5*this.size,1),this.lookAt(this.plane.normal),this.translateZ(-this.plane.constant),super.updateMatrixWorld(e)}dispose(){this.geometry.dispose(),this.material.dispose(),this.children[0].geometry.dispose(),this.children[0].material.dispose()}}const _axis=new Vector3;let _lineGeometry,_coneGeometry;class ArrowHelper extends Object3D{constructor(e=new Vector3(0,0,1),t=new Vector3(0,0,0),i=1,n=16776960,r=.2*i,o=.2*r){super(),this.type="ArrowHelper",void 0===_lineGeometry&&(_lineGeometry=new BufferGeometry,_lineGeometry.setAttribute("position",new Float32BufferAttribute([0,0,0,0,1,0],3)),_coneGeometry=new ConeGeometry(.5,1,5,1),_coneGeometry.translate(0,-.5,0)),this.position.copy(t),this.line=new Line(_lineGeometry,new LineBasicMaterial({color:n,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Mesh(_coneGeometry,new MeshBasicMaterial({color:n,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(i,r,o)}setDirection(e){if(e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{_axis.set(e.z,0,-e.x).normalize();const t=Math.acos(e.y);this.quaternion.setFromAxisAngle(_axis,t)}}setLength(e,t=.2*e,i=.2*t){this.line.scale.set(1,Math.max(1e-4,e-t),1),this.line.updateMatrix(),this.cone.scale.set(i,t,i),this.cone.position.y=e,this.cone.updateMatrix()}setColor(e){this.line.material.color.set(e),this.cone.material.color.set(e)}copy(e){return super.copy(e,!1),this.line.copy(e.line),this.cone.copy(e.cone),this}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),this.cone.geometry.dispose(),this.cone.material.dispose()}}class AxesHelper extends LineSegments{constructor(e=1){const t=[0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e],i=new BufferGeometry;i.setAttribute("position",new Float32BufferAttribute(t,3)),i.setAttribute("color",new Float32BufferAttribute([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));super(i,new LineBasicMaterial({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}setColors(e,t,i){const n=new Color,r=this.geometry.attributes.color.array;return n.set(e),n.toArray(r,0),n.toArray(r,3),n.set(t),n.toArray(r,6),n.toArray(r,9),n.set(i),n.toArray(r,12),n.toArray(r,15),this.geometry.attributes.color.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class ShapePath{constructor(){this.type="ShapePath",this.color=new Color,this.subPaths=[],this.currentPath=null}moveTo(e,t){return this.currentPath=new Path,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t),this}lineTo(e,t){return this.currentPath.lineTo(e,t),this}quadraticCurveTo(e,t,i,n){return this.currentPath.quadraticCurveTo(e,t,i,n),this}bezierCurveTo(e,t,i,n,r,o){return this.currentPath.bezierCurveTo(e,t,i,n,r,o),this}splineThru(e){return this.currentPath.splineThru(e),this}toShapes(e){function t(e,t){const i=t.length;let n=!1;for(let r=i-1,o=0;o<i;r=o++){let i=t[r],s=t[o],a=s.x-i.x,l=s.y-i.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(i=t[o],a=-a,s=t[r],l=-l),e.y<i.y||e.y>s.y)continue;if(e.y===i.y){if(e.x===i.x)return!0}else{const t=l*(e.x-i.x)-a*(e.y-i.y);if(0===t)return!0;if(t<0)continue;n=!n}}else{if(e.y!==i.y)continue;if(s.x<=e.x&&e.x<=i.x||i.x<=e.x&&e.x<=s.x)return!0}}return n}const i=ShapeUtils.isClockWise,n=this.subPaths;if(0===n.length)return[];let r,o,s;const a=[];if(1===n.length)return o=n[0],s=new Shape,s.curves=o.curves,a.push(s),a;let l=!i(n[0].getPoints());l=e?!l:l;const c=[],u=[];let h,d,p=[],f=0;u[f]=void 0,p[f]=[];for(let t=0,s=n.length;t<s;t++)o=n[t],h=o.getPoints(),r=i(h),r=e?!r:r,r?(!l&&u[f]&&f++,u[f]={s:new Shape,p:h},u[f].s.curves=o.curves,l&&f++,p[f]=[]):p[f].push({h:o,p:h[0]});if(!u[0])return function(e){const t=[];for(let i=0,n=e.length;i<n;i++){const n=e[i],r=new Shape;r.curves=n.curves,t.push(r)}return t}(n);if(u.length>1){let e=!1,i=0;for(let e=0,t=u.length;e<t;e++)c[e]=[];for(let n=0,r=u.length;n<r;n++){const r=p[n];for(let o=0;o<r.length;o++){const s=r[o];let a=!0;for(let r=0;r<u.length;r++)t(s.p,u[r].p)&&(n!==r&&i++,a?(a=!1,c[r].push(s)):e=!0);a&&c[n].push(s)}}i>0&&!1===e&&(p=c)}for(let e=0,t=u.length;e<t;e++){s=u[e].s,a.push(s),d=p[e];for(let e=0,t=d.length;e<t;e++)s.holes.push(d[e].h)}return a}}class Controls extends EventDispatcher{constructor(e,t=null){super(),this.object=e,this.domElement=t,this.enabled=!0,this.state=-1,this.keys={},this.mouseButtons={LEFT:null,MIDDLE:null,RIGHT:null},this.touches={ONE:null,TWO:null}}connect(e){void 0!==e?(null!==this.domElement&&this.disconnect(),this.domElement=e):warn("Controls: connect() now requires an element.")}disconnect(){}dispose(){}update(){}}function contain(e,t){const i=e.image&&e.image.width?e.image.width/e.image.height:1;return i>t?(e.repeat.x=1,e.repeat.y=i/t,e.offset.x=0,e.offset.y=(1-e.repeat.y)/2):(e.repeat.x=t/i,e.repeat.y=1,e.offset.x=(1-e.repeat.x)/2,e.offset.y=0),e}function cover(e,t){const i=e.image&&e.image.width?e.image.width/e.image.height:1;return i>t?(e.repeat.x=t/i,e.repeat.y=1,e.offset.x=(1-e.repeat.x)/2,e.offset.y=0):(e.repeat.x=1,e.repeat.y=i/t,e.offset.x=0,e.offset.y=(1-e.repeat.y)/2),e}function fill(e){return e.repeat.x=1,e.repeat.y=1,e.offset.x=0,e.offset.y=0,e}function getByteLength(e,t,i,n){const r=getTextureTypeByteLength(n);switch(i){case AlphaFormat:return e*t;case RedFormat:case RedIntegerFormat:return e*t/r.components*r.byteLength;case RGFormat:case RGIntegerFormat:return e*t*2/r.components*r.byteLength;case RGBFormat:return e*t*3/r.components*r.byteLength;case RGBAFormat:case RGBAIntegerFormat:return e*t*4/r.components*r.byteLength;case RGB_S3TC_DXT1_Format:case RGBA_S3TC_DXT1_Format:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case RGBA_S3TC_DXT3_Format:case RGBA_S3TC_DXT5_Format:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case RGB_PVRTC_2BPPV1_Format:case RGBA_PVRTC_2BPPV1_Format:return Math.max(e,16)*Math.max(t,8)/4;case RGB_PVRTC_4BPPV1_Format:case RGBA_PVRTC_4BPPV1_Format:return Math.max(e,8)*Math.max(t,8)/2;case RGB_ETC1_Format:case RGB_ETC2_Format:case R11_EAC_Format:case SIGNED_R11_EAC_Format:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case RGBA_ETC2_EAC_Format:case RG11_EAC_Format:case SIGNED_RG11_EAC_Format:case RGBA_ASTC_4x4_Format:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case RGBA_ASTC_5x4_Format:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case RGBA_ASTC_5x5_Format:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case RGBA_ASTC_6x5_Format:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case RGBA_ASTC_6x6_Format:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case RGBA_ASTC_8x5_Format:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case RGBA_ASTC_8x6_Format:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case RGBA_ASTC_8x8_Format:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case RGBA_ASTC_10x5_Format:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case RGBA_ASTC_10x6_Format:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case RGBA_ASTC_10x8_Format:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case RGBA_ASTC_10x10_Format:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case RGBA_ASTC_12x10_Format:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case RGBA_ASTC_12x12_Format:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case RGBA_BPTC_Format:case RGB_BPTC_SIGNED_Format:case RGB_BPTC_UNSIGNED_Format:return Math.ceil(e/4)*Math.ceil(t/4)*16;case RED_RGTC1_Format:case SIGNED_RED_RGTC1_Format:return Math.ceil(e/4)*Math.ceil(t/4)*8;case RED_GREEN_RGTC2_Format:case SIGNED_RED_GREEN_RGTC2_Format:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${i} format.`)}function getTextureTypeByteLength(e){switch(e){case UnsignedByteType:case ByteType:return{byteLength:1,components:1};case UnsignedShortType:case ShortType:case HalfFloatType:return{byteLength:2,components:1};case UnsignedShort4444Type:case UnsignedShort5551Type:return{byteLength:2,components:4};case UnsignedIntType:case IntType:case FloatType:return{byteLength:4,components:1};case UnsignedInt5999Type:case UnsignedInt101111Type:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${e}.`)}class TextureUtils{static contain(e,t){return contain(e,t)}static cover(e,t){return cover(e,t)}static fill(e){return fill(e)}static getByteLength(e,t,i,n){return getByteLength(e,t,i,n)}}
/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
function WebGLAnimation(){let e=null,t=!1,i=null,n=null;function r(t,o){i(t,o),n=e.requestAnimationFrame(r)}return{start:function(){!0!==t&&null!==i&&(n=e.requestAnimationFrame(r),t=!0)},stop:function(){e.cancelAnimationFrame(n),t=!1},setAnimationLoop:function(e){i=e},setContext:function(t){e=t}}}function WebGLAttributes(e){const t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(i){i.isInterleavedBufferAttribute&&(i=i.data);const n=t.get(i);n&&(e.deleteBuffer(n.buffer),t.delete(i))},update:function(i,n){if(i.isInterleavedBufferAttribute&&(i=i.data),i.isGLBufferAttribute){const e=t.get(i);return void((!e||e.version<i.version)&&t.set(i,{buffer:i.buffer,type:i.type,bytesPerElement:i.elementSize,version:i.version}))}const r=t.get(i);if(void 0===r)t.set(i,function(t,i){const n=t.array,r=t.usage,o=n.byteLength,s=e.createBuffer();let a;if(e.bindBuffer(i,s),e.bufferData(i,n,r),t.onUploadCallback(),n instanceof Float32Array)a=e.FLOAT;else if("undefined"!=typeof Float16Array&&n instanceof Float16Array)a=e.HALF_FLOAT;else if(n instanceof Uint16Array)a=t.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(n instanceof Int16Array)a=e.SHORT;else if(n instanceof Uint32Array)a=e.UNSIGNED_INT;else if(n instanceof Int32Array)a=e.INT;else if(n instanceof Int8Array)a=e.BYTE;else if(n instanceof Uint8Array)a=e.UNSIGNED_BYTE;else{if(!(n instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+n);a=e.UNSIGNED_BYTE}return{buffer:s,type:a,bytesPerElement:n.BYTES_PER_ELEMENT,version:t.version,size:o}}(i,n));else if(r.version<i.version){if(r.size!==i.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,i,n){const r=i.array,o=i.updateRanges;if(e.bindBuffer(n,t),0===o.length)e.bufferSubData(n,0,r);else{o.sort(((e,t)=>e.start-t.start));let t=0;for(let e=1;e<o.length;e++){const i=o[t],n=o[e];n.start<=i.start+i.count+1?i.count=Math.max(i.count,n.start+n.count-i.start):(++t,o[t]=n)}o.length=t+1;for(let t=0,i=o.length;t<i;t++){const i=o[t];e.bufferSubData(n,i.start*r.BYTES_PER_ELEMENT,r,i.start,i.count)}i.clearUpdateRanges()}i.onUploadCallback()}(r.buffer,i,n),r.version=i.version}}}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:REVISION}})),"undefined"!=typeof window&&(window.__THREE__?warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=REVISION);var alphahash_fragment="#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment="#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment="#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment="#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment="#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment="#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment="#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment="#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex="#ifdef USE_BATCHING\n\t#if ! defined( GL_ANGLE_multi_draw )\n\t#define gl_DrawID _gl_DrawID\n\tuniform int _gl_DrawID;\n\t#endif\n\tuniform highp sampler2D batchingTexture;\n\tuniform highp usampler2D batchingIdTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n\tfloat getIndirectIndex( const in int i ) {\n\t\tint size = textureSize( batchingIdTexture, 0 ).x;\n\t\tint x = i % size;\n\t\tint y = i / size;\n\t\treturn float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );\n\t}\n#endif\n#ifdef USE_BATCHING_COLOR\n\tuniform sampler2D batchingColorTexture;\n\tvec3 getBatchingColor( const in float i ) {\n\t\tint size = textureSize( batchingColorTexture, 0 ).x;\n\t\tint j = int( i );\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\treturn texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;\n\t}\n#endif",batching_vertex="#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );\n#endif",begin_vertex="vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex="vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs="float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment="#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment="#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment="#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment="#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex="#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex="#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment="#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment="#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex="#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex="#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif\n#ifdef USE_BATCHING_COLOR\n\tvec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );\n\tvColor.xyz *= batchingColor.xyz;\n#endif",common="#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment="#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex="vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex="#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex="#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment="#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE\n\t\temissiveColor = sRGBTransferEOTF( emissiveColor );\n\t#endif\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment="#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment="gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment="vec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferEOTF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}",envmap_fragment="#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment="#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform mat3 envMapRotation;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n#endif",envmap_pars_fragment="#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex="#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_vertex="#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex="#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex="#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment="#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment="#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment="#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_pars_fragment="#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment="LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment="varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin="uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif ( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",envmap_physical_pars_fragment="#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, pow4( roughness ) ) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",lights_toon_fragment="ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment="varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment="BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment="varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment="PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.diffuseContribution = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.metalness = metalnessFactor;\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor;\n\tmaterial.specularColorBlended = mix( material.specularColor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = vec3( 0.04 );\n\tmaterial.specularColorBlended = mix( material.specularColor, diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_DISPERSION\n\tmaterial.dispersion = dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.0001, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment="uniform sampler2D dfgLUT;\nstruct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tvec3 diffuseContribution;\n\tvec3 specularColor;\n\tvec3 specularColorBlended;\n\tfloat roughness;\n\tfloat metalness;\n\tfloat specularF90;\n\tfloat dispersion;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t\tvec3 iridescenceFresnelDielectric;\n\t\tvec3 iridescenceFresnelMetallic;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn v;\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColorBlended;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transpose( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat rInv = 1.0 / ( roughness + 0.1 );\n\tfloat a = -1.9362 + 1.0678 * roughness + 0.4573 * r2 - 0.8469 * rInv;\n\tfloat b = -0.6014 + 0.5538 * roughness - 0.4670 * r2 - 0.1255 * rInv;\n\tfloat DG = exp( a * dotNV + b );\n\treturn saturate( DG );\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 fab = texture2D( dfgLUT, vec2( roughness, dotNV ) ).rg;\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 fab = texture2D( dfgLUT, vec2( roughness, dotNV ) ).rg;\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\nvec3 BRDF_GGX_Multiscatter( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 singleScatter = BRDF_GGX( lightDir, viewDir, normal, material );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tvec2 dfgV = texture2D( dfgLUT, vec2( material.roughness, dotNV ) ).rg;\n\tvec2 dfgL = texture2D( dfgLUT, vec2( material.roughness, dotNL ) ).rg;\n\tvec3 FssEss_V = material.specularColorBlended * dfgV.x + material.specularF90 * dfgV.y;\n\tvec3 FssEss_L = material.specularColorBlended * dfgL.x + material.specularF90 * dfgL.y;\n\tfloat Ess_V = dfgV.x + dfgV.y;\n\tfloat Ess_L = dfgL.x + dfgL.y;\n\tfloat Ems_V = 1.0 - Ess_V;\n\tfloat Ems_L = 1.0 - Ess_L;\n\tvec3 Favg = material.specularColorBlended + ( 1.0 - material.specularColorBlended ) * 0.047619;\n\tvec3 Fms = FssEss_V * FssEss_L * Favg / ( 1.0 - Ems_V * Ems_L * Favg + EPSILON );\n\tfloat compensationFactor = Ems_V * Ems_L;\n\tvec3 multiScatter = Fms * compensationFactor;\n\treturn singleScatter + multiScatter;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColorBlended * t2.x + ( vec3( 1.0 ) - material.specularColorBlended ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseContribution * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n \n \t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n \n \t\tfloat sheenAlbedoV = IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n \t\tfloat sheenAlbedoL = IBLSheenBRDF( geometryNormal, directLight.direction, material.sheenRoughness );\n \n \t\tfloat sheenEnergyComp = 1.0 - max3( material.sheenColor ) * max( sheenAlbedoV, sheenAlbedoL );\n \n \t\tirradiance *= sheenEnergyComp;\n \n \t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX_Multiscatter( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseContribution );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 diffuse = irradiance * BRDF_Lambert( material.diffuseContribution );\n\t#ifdef USE_SHEEN\n\t\tfloat sheenAlbedo = IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t\tfloat sheenEnergyComp = 1.0 - max3( material.sheenColor ) * sheenAlbedo;\n\t\tdiffuse *= sheenEnergyComp;\n\t#endif\n\treflectedLight.indirectDiffuse += diffuse;\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness ) * RECIPROCAL_PI;\n \t#endif\n\tvec3 singleScatteringDielectric = vec3( 0.0 );\n\tvec3 multiScatteringDielectric = vec3( 0.0 );\n\tvec3 singleScatteringMetallic = vec3( 0.0 );\n\tvec3 multiScatteringMetallic = vec3( 0.0 );\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnelDielectric, material.roughness, singleScatteringDielectric, multiScatteringDielectric );\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.diffuseColor, material.specularF90, material.iridescence, material.iridescenceFresnelMetallic, material.roughness, singleScatteringMetallic, multiScatteringMetallic );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScatteringDielectric, multiScatteringDielectric );\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.diffuseColor, material.specularF90, material.roughness, singleScatteringMetallic, multiScatteringMetallic );\n\t#endif\n\tvec3 singleScattering = mix( singleScatteringDielectric, singleScatteringMetallic, material.metalness );\n\tvec3 multiScattering = mix( multiScatteringDielectric, multiScatteringMetallic, material.metalness );\n\tvec3 totalScatteringDielectric = singleScatteringDielectric + multiScatteringDielectric;\n\tvec3 diffuse = material.diffuseContribution * ( 1.0 - totalScatteringDielectric );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\tvec3 indirectSpecular = radiance * singleScattering;\n\tindirectSpecular += multiScattering * cosineWeightedIrradiance;\n\tvec3 indirectDiffuse = diffuse * cosineWeightedIrradiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenAlbedo = IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t\tfloat sheenEnergyComp = 1.0 - max3( material.sheenColor ) * sheenAlbedo;\n\t\tindirectSpecular *= sheenEnergyComp;\n\t\tindirectDiffuse *= sheenEnergyComp;\n\t#endif\n\treflectedLight.indirectSpecular += indirectSpecular;\n\treflectedLight.indirectDiffuse += indirectDiffuse;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin="\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnelDielectric = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceFresnelMetallic = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.diffuseColor );\n\t\tmaterial.iridescenceFresnel = mix( material.iridescenceFresnelDielectric, material.iridescenceFresnelMetallic, material.metalness );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS ) && ( defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_BASIC ) )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps="#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end="#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment="#if defined( USE_LOGARITHMIC_DEPTH_BUFFER )\n\tgl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment="#if defined( USE_LOGARITHMIC_DEPTH_BUFFER )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex="#ifdef USE_LOGARITHMIC_DEPTH_BUFFER\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_vertex="#ifdef USE_LOGARITHMIC_DEPTH_BUFFER\n\tvFragDepth = 1.0 + gl_Position.w;\n\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n#endif",map_fragment="#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment="#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment="#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment="#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment="float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment="#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex="#ifdef USE_INSTANCING_MORPH\n\tfloat morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\tfloat morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tmorphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;\n\t}\n#endif",morphcolor_vertex="#if defined( USE_MORPHCOLORS )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex="#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",morphtarget_pars_vertex="#ifdef USE_MORPHTARGETS\n\t#ifndef USE_INSTANCING_MORPH\n\t\tuniform float morphTargetBaseInfluence;\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t#endif\n\tuniform sampler2DArray morphTargetsTexture;\n\tuniform ivec2 morphTargetsTextureSize;\n\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t}\n#endif",morphtarget_vertex="#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",normal_fragment_begin="float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps="#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment="#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex="#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex="#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment="#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin="#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps="#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment="#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment="#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment="#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing="vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;\nconst float Inv255 = 1. / 255.;\nconst vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );\nconst vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );\nconst vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );\nconst vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );\nvec4 packDepthToRGBA( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec4( 0., 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec4( 1., 1., 1., 1. );\n\tfloat vuf;\n\tfloat af = modf( v * PackFactors.a, vuf );\n\tfloat bf = modf( vuf * ShiftRight8, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );\n}\nvec3 packDepthToRGB( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec3( 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec3( 1., 1., 1. );\n\tfloat vuf;\n\tfloat bf = modf( v * PackFactors.b, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec3( vuf * Inv255, gf * PackUpscale, bf );\n}\nvec2 packDepthToRG( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec2( 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec2( 1., 1. );\n\tfloat vuf;\n\tfloat gf = modf( v * 256., vuf );\n\treturn vec2( vuf * Inv255, gf );\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors4 );\n}\nfloat unpackRGBToDepth( const in vec3 v ) {\n\treturn dot( v, UnpackFactors3 );\n}\nfloat unpackRGToDepth( const in vec2 v ) {\n\treturn v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;\n}\nvec4 pack2HalfToRGBA( const in vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( const in vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment="#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex="vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment="#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment="#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment="float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment="#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment="#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tuniform sampler2DShadow directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\t#else\n\t\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\t#endif\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tuniform sampler2DShadow spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\t#else\n\t\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\t#endif\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tuniform samplerCubeShadow pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\t#elif defined( SHADOWMAP_TYPE_BASIC )\n\t\t\tuniform samplerCube pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\t#endif\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\tfloat interleavedGradientNoise( vec2 position ) {\n\t\t\treturn fract( 52.9829189 * fract( dot( position, vec2( 0.06711056, 0.00583715 ) ) ) );\n\t\t}\n\t\tvec2 vogelDiskSample( int sampleIndex, int samplesCount, float phi ) {\n\t\t\tconst float goldenAngle = 2.399963229728653;\n\t\t\tfloat r = sqrt( ( float( sampleIndex ) + 0.5 ) / float( samplesCount ) );\n\t\t\tfloat theta = float( sampleIndex ) * goldenAngle + phi;\n\t\t\treturn vec2( cos( theta ), sin( theta ) ) * r;\n\t\t}\n\t#endif\n\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\tfloat getShadow( sampler2DShadow shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\t\tfloat shadow = 1.0;\n\t\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\t\tshadowCoord.z += shadowBias;\n\t\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\t\tif ( frustumTest ) {\n\t\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\t\tfloat radius = shadowRadius * texelSize.x;\n\t\t\t\tfloat phi = interleavedGradientNoise( gl_FragCoord.xy ) * 6.28318530718;\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 0, 5, phi ) * radius, shadowCoord.z ) ) +\n\t\t\t\t\ttexture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 1, 5, phi ) * radius, shadowCoord.z ) ) +\n\t\t\t\t\ttexture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 2, 5, phi ) * radius, shadowCoord.z ) ) +\n\t\t\t\t\ttexture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 3, 5, phi ) * radius, shadowCoord.z ) ) +\n\t\t\t\t\ttexture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 4, 5, phi ) * radius, shadowCoord.z ) )\n\t\t\t\t) * 0.2;\n\t\t\t}\n\t\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t\t}\n\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\t\tfloat shadow = 1.0;\n\t\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\t\tshadowCoord.z += shadowBias;\n\t\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\t\tif ( frustumTest ) {\n\t\t\t\tvec2 distribution = texture2D( shadowMap, shadowCoord.xy ).rg;\n\t\t\t\tfloat mean = distribution.x;\n\t\t\t\tfloat variance = distribution.y * distribution.y;\n\t\t\t\t#ifdef USE_REVERSED_DEPTH_BUFFER\n\t\t\t\t\tfloat hard_shadow = step( mean, shadowCoord.z );\n\t\t\t\t#else\n\t\t\t\t\tfloat hard_shadow = step( shadowCoord.z, mean );\n\t\t\t\t#endif\n\t\t\t\tif ( hard_shadow == 1.0 ) {\n\t\t\t\t\tshadow = 1.0;\n\t\t\t\t} else {\n\t\t\t\t\tvariance = max( variance, 0.0000001 );\n\t\t\t\t\tfloat d = shadowCoord.z - mean;\n\t\t\t\t\tfloat p_max = variance / ( variance + d * d );\n\t\t\t\t\tp_max = clamp( ( p_max - 0.3 ) / 0.65, 0.0, 1.0 );\n\t\t\t\t\tshadow = max( hard_shadow, p_max );\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t\t}\n\t#else\n\t\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\t\tfloat shadow = 1.0;\n\t\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\t\tshadowCoord.z += shadowBias;\n\t\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\t\tif ( frustumTest ) {\n\t\t\t\tfloat depth = texture2D( shadowMap, shadowCoord.xy ).r;\n\t\t\t\t#ifdef USE_REVERSED_DEPTH_BUFFER\n\t\t\t\t\tshadow = step( depth, shadowCoord.z );\n\t\t\t\t#else\n\t\t\t\t\tshadow = step( shadowCoord.z, depth );\n\t\t\t\t#endif\n\t\t\t}\n\t\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t\t}\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t#if defined( SHADOWMAP_TYPE_PCF )\n\tfloat getPointShadow( samplerCubeShadow shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tfloat shadow = 1.0;\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\tvec3 absVec = abs( lightToPosition );\n\t\tfloat viewSpaceZ = max( max( absVec.x, absVec.y ), absVec.z );\n\t\tif ( viewSpaceZ - shadowCameraFar <= 0.0 && viewSpaceZ - shadowCameraNear >= 0.0 ) {\n\t\t\tfloat dp = ( shadowCameraFar * ( viewSpaceZ - shadowCameraNear ) ) / ( viewSpaceZ * ( shadowCameraFar - shadowCameraNear ) );\n\t\t\tdp += shadowBias;\n\t\t\tfloat texelSize = shadowRadius / shadowMapSize.x;\n\t\t\tvec3 absDir = abs( bd3D );\n\t\t\tvec3 tangent = absDir.x > absDir.z ? vec3( 0.0, 1.0, 0.0 ) : vec3( 1.0, 0.0, 0.0 );\n\t\t\ttangent = normalize( cross( bd3D, tangent ) );\n\t\t\tvec3 bitangent = cross( bd3D, tangent );\n\t\t\tfloat phi = interleavedGradientNoise( gl_FragCoord.xy ) * 6.28318530718;\n\t\t\tshadow = (\n\t\t\t\ttexture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 0, 5, phi ).x + bitangent * vogelDiskSample( 0, 5, phi ).y ) * texelSize, dp ) ) +\n\t\t\t\ttexture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 1, 5, phi ).x + bitangent * vogelDiskSample( 1, 5, phi ).y ) * texelSize, dp ) ) +\n\t\t\t\ttexture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 2, 5, phi ).x + bitangent * vogelDiskSample( 2, 5, phi ).y ) * texelSize, dp ) ) +\n\t\t\t\ttexture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 3, 5, phi ).x + bitangent * vogelDiskSample( 3, 5, phi ).y ) * texelSize, dp ) ) +\n\t\t\t\ttexture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 4, 5, phi ).x + bitangent * vogelDiskSample( 4, 5, phi ).y ) * texelSize, dp ) )\n\t\t\t) * 0.2;\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n\t#elif defined( SHADOWMAP_TYPE_BASIC )\n\tfloat getPointShadow( samplerCube shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tfloat shadow = 1.0;\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\tvec3 absVec = abs( lightToPosition );\n\t\tfloat viewSpaceZ = max( max( absVec.x, absVec.y ), absVec.z );\n\t\tif ( viewSpaceZ - shadowCameraFar <= 0.0 && viewSpaceZ - shadowCameraNear >= 0.0 ) {\n\t\t\tfloat dp = ( shadowCameraFar * ( viewSpaceZ - shadowCameraNear ) ) / ( viewSpaceZ * ( shadowCameraFar - shadowCameraNear ) );\n\t\t\tdp += shadowBias;\n\t\t\tfloat depth = textureCube( shadowMap, bd3D ).r;\n\t\t\t#ifdef USE_REVERSED_DEPTH_BUFFER\n\t\t\t\tshadow = step( depth, dp );\n\t\t\t#else\n\t\t\t\tshadow = step( dp, depth );\n\t\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n\t#endif\n\t#endif\n#endif",shadowmap_pars_vertex="#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex="#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment="float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0 && ( defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_BASIC ) )\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex="#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex="#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex="#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex="#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment="float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment="#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment="#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment="#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 CineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 NeutralToneMapping( vec3 color ) {\n\tconst float StartCompression = 0.8 - 0.04;\n\tconst float Desaturation = 0.15;\n\tcolor *= toneMappingExposure;\n\tfloat x = min( color.r, min( color.g, color.b ) );\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max( color.r, max( color.g, color.b ) );\n\tif ( peak < StartCompression ) return color;\n\tfloat d = 1. - StartCompression;\n\tfloat newPeak = 1. - d * d / ( peak + d - StartCompression );\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );\n\treturn mix( color, vec3( newPeak ), g );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment="#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseContribution, material.specularColorBlended, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment="#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec4 transmittedLight;\n\t\tvec3 transmittance;\n\t\t#ifdef USE_DISPERSION\n\t\t\tfloat halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;\n\t\t\tvec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );\n\t\t\tfor ( int i = 0; i < 3; i ++ ) {\n\t\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );\n\t\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\t\trefractionCoords += 1.0;\n\t\t\t\trefractionCoords /= 2.0;\n\t\t\t\tvec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );\n\t\t\t\ttransmittedLight[ i ] = transmissionSample[ i ];\n\t\t\t\ttransmittedLight.a += transmissionSample.a;\n\t\t\t\ttransmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];\n\t\t\t}\n\t\t\ttransmittedLight.a /= 3.0;\n\t\t#else\n\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\trefractionCoords += 1.0;\n\t\t\trefractionCoords /= 2.0;\n\t\t\ttransmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\t\ttransmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\t#endif\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment="#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex="#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex="#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex="#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif";const vertex$h="varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",fragment$h="uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",vertex$g="varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",fragment$g="#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",vertex$f="varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",fragment$f="uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",vertex$e="#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",fragment$e="#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\t#ifdef USE_REVERSED_DEPTH_BUFFER\n\t\tfloat fragCoordZ = vHighPrecisionZW[ 0 ] / vHighPrecisionZW[ 1 ];\n\t#else\n\t\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[ 0 ] / vHighPrecisionZW[ 1 ] + 0.5;\n\t#endif\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#elif DEPTH_PACKING == 3202\n\t\tgl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );\n\t#elif DEPTH_PACKING == 3203\n\t\tgl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );\n\t#endif\n}",vertex$d="#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",fragment$d="#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = vec4( dist, 0.0, 0.0, 1.0 );\n}",vertex$c="varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",fragment$c="uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",vertex$b="uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",fragment$b="uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",vertex$a="#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",fragment$a="uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",vertex$9="#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",fragment$9="#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",vertex$8="#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",fragment$8="#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",vertex$7="#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",fragment$7="#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( normalize( normal ) * 0.5 + 0.5, diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",vertex$6="#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",fragment$6="#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",vertex$5="#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",fragment$5="#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\n\tuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n \n\t\toutgoingLight = outgoingLight + sheenSpecularDirect + sheenSpecularIndirect;\n \n \t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",vertex$4="#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",fragment$4="#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",vertex$3="uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",fragment$3="uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",vertex$2="#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",fragment$2="uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",vertex$1="uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix[ 3 ];\n\tvec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",fragment$1="uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",ShaderChunk={alphahash_fragment:alphahash_fragment,alphahash_pars_fragment:alphahash_pars_fragment,alphamap_fragment:alphamap_fragment,alphamap_pars_fragment:alphamap_pars_fragment,alphatest_fragment:alphatest_fragment,alphatest_pars_fragment:alphatest_pars_fragment,aomap_fragment:aomap_fragment,aomap_pars_fragment:aomap_pars_fragment,batching_pars_vertex:batching_pars_vertex,batching_vertex:batching_vertex,begin_vertex:begin_vertex,beginnormal_vertex:beginnormal_vertex,bsdfs:bsdfs,iridescence_fragment:iridescence_fragment,bumpmap_pars_fragment:bumpmap_pars_fragment,clipping_planes_fragment:clipping_planes_fragment,clipping_planes_pars_fragment:clipping_planes_pars_fragment,clipping_planes_pars_vertex:clipping_planes_pars_vertex,clipping_planes_vertex:clipping_planes_vertex,color_fragment:color_fragment,color_pars_fragment:color_pars_fragment,color_pars_vertex:color_pars_vertex,color_vertex:color_vertex,common:common,cube_uv_reflection_fragment:cube_uv_reflection_fragment,defaultnormal_vertex:defaultnormal_vertex,displacementmap_pars_vertex:displacementmap_pars_vertex,displacementmap_vertex:displacementmap_vertex,emissivemap_fragment:emissivemap_fragment,emissivemap_pars_fragment:emissivemap_pars_fragment,colorspace_fragment:colorspace_fragment,colorspace_pars_fragment:colorspace_pars_fragment,envmap_fragment:envmap_fragment,envmap_common_pars_fragment:envmap_common_pars_fragment,envmap_pars_fragment:envmap_pars_fragment,envmap_pars_vertex:envmap_pars_vertex,envmap_physical_pars_fragment:envmap_physical_pars_fragment,envmap_vertex:envmap_vertex,fog_vertex:fog_vertex,fog_pars_vertex:fog_pars_vertex,fog_fragment:fog_fragment,fog_pars_fragment:fog_pars_fragment,gradientmap_pars_fragment:gradientmap_pars_fragment,lightmap_pars_fragment:lightmap_pars_fragment,lights_lambert_fragment:lights_lambert_fragment,lights_lambert_pars_fragment:lights_lambert_pars_fragment,lights_pars_begin:lights_pars_begin,lights_toon_fragment:lights_toon_fragment,lights_toon_pars_fragment:lights_toon_pars_fragment,lights_phong_fragment:lights_phong_fragment,lights_phong_pars_fragment:lights_phong_pars_fragment,lights_physical_fragment:lights_physical_fragment,lights_physical_pars_fragment:lights_physical_pars_fragment,lights_fragment_begin:lights_fragment_begin,lights_fragment_maps:lights_fragment_maps,lights_fragment_end:lights_fragment_end,logdepthbuf_fragment:logdepthbuf_fragment,logdepthbuf_pars_fragment:logdepthbuf_pars_fragment,logdepthbuf_pars_vertex:logdepthbuf_pars_vertex,logdepthbuf_vertex:logdepthbuf_vertex,map_fragment:map_fragment,map_pars_fragment:map_pars_fragment,map_particle_fragment:map_particle_fragment,map_particle_pars_fragment:map_particle_pars_fragment,metalnessmap_fragment:metalnessmap_fragment,metalnessmap_pars_fragment:metalnessmap_pars_fragment,morphinstance_vertex:morphinstance_vertex,morphcolor_vertex:morphcolor_vertex,morphnormal_vertex:morphnormal_vertex,morphtarget_pars_vertex:morphtarget_pars_vertex,morphtarget_vertex:morphtarget_vertex,normal_fragment_begin:normal_fragment_begin,normal_fragment_maps:normal_fragment_maps,normal_pars_fragment:normal_pars_fragment,normal_pars_vertex:normal_pars_vertex,normal_vertex:normal_vertex,normalmap_pars_fragment:normalmap_pars_fragment,clearcoat_normal_fragment_begin:clearcoat_normal_fragment_begin,clearcoat_normal_fragment_maps:clearcoat_normal_fragment_maps,clearcoat_pars_fragment:clearcoat_pars_fragment,iridescence_pars_fragment:iridescence_pars_fragment,opaque_fragment:opaque_fragment,packing:packing,premultiplied_alpha_fragment:premultiplied_alpha_fragment,project_vertex:project_vertex,dithering_fragment:dithering_fragment,dithering_pars_fragment:dithering_pars_fragment,roughnessmap_fragment:roughnessmap_fragment,roughnessmap_pars_fragment:roughnessmap_pars_fragment,shadowmap_pars_fragment:shadowmap_pars_fragment,shadowmap_pars_vertex:shadowmap_pars_vertex,shadowmap_vertex:shadowmap_vertex,shadowmask_pars_fragment:shadowmask_pars_fragment,skinbase_vertex:skinbase_vertex,skinning_pars_vertex:skinning_pars_vertex,skinning_vertex:skinning_vertex,skinnormal_vertex:skinnormal_vertex,specularmap_fragment:specularmap_fragment,specularmap_pars_fragment:specularmap_pars_fragment,tonemapping_fragment:tonemapping_fragment,tonemapping_pars_fragment:tonemapping_pars_fragment,transmission_fragment:transmission_fragment,transmission_pars_fragment:transmission_pars_fragment,uv_pars_fragment:uv_pars_fragment,uv_pars_vertex:uv_pars_vertex,uv_vertex:uv_vertex,worldpos_vertex:worldpos_vertex,background_vert:vertex$h,background_frag:fragment$h,backgroundCube_vert:vertex$g,backgroundCube_frag:fragment$g,cube_vert:vertex$f,cube_frag:fragment$f,depth_vert:vertex$e,depth_frag:fragment$e,distance_vert:vertex$d,distance_frag:fragment$d,equirect_vert:vertex$c,equirect_frag:fragment$c,linedashed_vert:vertex$b,linedashed_frag:fragment$b,meshbasic_vert:vertex$a,meshbasic_frag:fragment$a,meshlambert_vert:vertex$9,meshlambert_frag:fragment$9,meshmatcap_vert:vertex$8,meshmatcap_frag:fragment$8,meshnormal_vert:vertex$7,meshnormal_frag:fragment$7,meshphong_vert:vertex$6,meshphong_frag:fragment$6,meshphysical_vert:vertex$5,meshphysical_frag:fragment$5,meshtoon_vert:vertex$4,meshtoon_frag:fragment$4,points_vert:vertex$3,points_frag:fragment$3,shadow_vert:vertex$2,shadow_frag:fragment$2,sprite_vert:vertex$1,sprite_frag:fragment$1},UniformsLib={common:{diffuse:{value:new Color(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new Matrix3},alphaMap:{value:null},alphaMapTransform:{value:new Matrix3},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new Matrix3}},envmap:{envMap:{value:null},envMapRotation:{value:new Matrix3},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98},dfgLUT:{value:null}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new Matrix3}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new Matrix3}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new Matrix3},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new Matrix3},normalScale:{value:new Vector2(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new Matrix3},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new Matrix3}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new Matrix3}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new Matrix3}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Color(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Color(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new Matrix3},alphaTest:{value:0},uvTransform:{value:new Matrix3}},sprite:{diffuse:{value:new Color(16777215)},opacity:{value:1},center:{value:new Vector2(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new Matrix3},alphaMap:{value:null},alphaMapTransform:{value:new Matrix3},alphaTest:{value:0}}},ShaderLib={basic:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.fog]),vertexShader:ShaderChunk.meshbasic_vert,fragmentShader:ShaderChunk.meshbasic_frag},lambert:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)}}]),vertexShader:ShaderChunk.meshlambert_vert,fragmentShader:ShaderChunk.meshlambert_frag},phong:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.specularmap,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)},specular:{value:new Color(1118481)},shininess:{value:30}}]),vertexShader:ShaderChunk.meshphong_vert,fragmentShader:ShaderChunk.meshphong_frag},standard:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.envmap,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.roughnessmap,UniformsLib.metalnessmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:ShaderChunk.meshphysical_vert,fragmentShader:ShaderChunk.meshphysical_frag},toon:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.aomap,UniformsLib.lightmap,UniformsLib.emissivemap,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.gradientmap,UniformsLib.fog,UniformsLib.lights,{emissive:{value:new Color(0)}}]),vertexShader:ShaderChunk.meshtoon_vert,fragmentShader:ShaderChunk.meshtoon_frag},matcap:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,UniformsLib.fog,{matcap:{value:null}}]),vertexShader:ShaderChunk.meshmatcap_vert,fragmentShader:ShaderChunk.meshmatcap_frag},points:{uniforms:mergeUniforms([UniformsLib.points,UniformsLib.fog]),vertexShader:ShaderChunk.points_vert,fragmentShader:ShaderChunk.points_frag},dashed:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:ShaderChunk.linedashed_vert,fragmentShader:ShaderChunk.linedashed_frag},depth:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.displacementmap]),vertexShader:ShaderChunk.depth_vert,fragmentShader:ShaderChunk.depth_frag},normal:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.bumpmap,UniformsLib.normalmap,UniformsLib.displacementmap,{opacity:{value:1}}]),vertexShader:ShaderChunk.meshnormal_vert,fragmentShader:ShaderChunk.meshnormal_frag},sprite:{uniforms:mergeUniforms([UniformsLib.sprite,UniformsLib.fog]),vertexShader:ShaderChunk.sprite_vert,fragmentShader:ShaderChunk.sprite_frag},background:{uniforms:{uvTransform:{value:new Matrix3},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:ShaderChunk.background_vert,fragmentShader:ShaderChunk.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new Matrix3}},vertexShader:ShaderChunk.backgroundCube_vert,fragmentShader:ShaderChunk.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:ShaderChunk.cube_vert,fragmentShader:ShaderChunk.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:ShaderChunk.equirect_vert,fragmentShader:ShaderChunk.equirect_frag},distance:{uniforms:mergeUniforms([UniformsLib.common,UniformsLib.displacementmap,{referencePosition:{value:new Vector3},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:ShaderChunk.distance_vert,fragmentShader:ShaderChunk.distance_frag},shadow:{uniforms:mergeUniforms([UniformsLib.lights,UniformsLib.fog,{color:{value:new Color(0)},opacity:{value:1}}]),vertexShader:ShaderChunk.shadow_vert,fragmentShader:ShaderChunk.shadow_frag}};ShaderLib.physical={uniforms:mergeUniforms([ShaderLib.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new Matrix3},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new Matrix3},clearcoatNormalScale:{value:new Vector2(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new Matrix3},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new Matrix3},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new Matrix3},sheen:{value:0},sheenColor:{value:new Color(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new Matrix3},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new Matrix3},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new Matrix3},transmissionSamplerSize:{value:new Vector2},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new Matrix3},attenuationDistance:{value:0},attenuationColor:{value:new Color(0)},specularColor:{value:new Color(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new Matrix3},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new Matrix3},anisotropyVector:{value:new Vector2},anisotropyMap:{value:null},anisotropyMapTransform:{value:new Matrix3}}]),vertexShader:ShaderChunk.meshphysical_vert,fragmentShader:ShaderChunk.meshphysical_frag};const _rgb={r:0,b:0,g:0},_e1$1=new Euler,_m1$1=new Matrix4;function WebGLBackground(e,t,i,n,r,o,s){const a=new Color(0);let l,c,u=!0===o?0:1,h=null,d=0,p=null;function f(e){let n=!0===e.isScene?e.background:null;if(n&&n.isTexture){n=(e.backgroundBlurriness>0?i:t).get(n)}return n}function m(t,i){t.getRGB(_rgb,getUnlitUniformColorSpace(e)),n.buffers.color.setClear(_rgb.r,_rgb.g,_rgb.b,i,s)}return{getClearColor:function(){return a},setClearColor:function(e,t=1){a.set(e),u=t,m(a,u)},getClearAlpha:function(){return u},setClearAlpha:function(e){u=e,m(a,u)},render:function(t){let i=!1;const r=f(t);null===r?m(a,u):r&&r.isColor&&(m(r,1),i=!0);const o=e.xr.getEnvironmentBlendMode();"additive"===o?n.buffers.color.setClear(0,0,0,1,s):"alpha-blend"===o&&n.buffers.color.setClear(0,0,0,0,s),(e.autoClear||i)&&(n.buffers.depth.setTest(!0),n.buffers.depth.setMask(!0),n.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(t,i){const n=f(i);n&&(n.isCubeTexture||n.mapping===CubeUVReflectionMapping)?(void 0===c&&(c=new Mesh(new BoxGeometry(1,1,1),new ShaderMaterial({name:"BackgroundCubeMaterial",uniforms:cloneUniforms(ShaderLib.backgroundCube.uniforms),vertexShader:ShaderLib.backgroundCube.vertexShader,fragmentShader:ShaderLib.backgroundCube.fragmentShader,side:BackSide,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),c.geometry.deleteAttribute("normal"),c.geometry.deleteAttribute("uv"),c.onBeforeRender=function(e,t,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(c.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),r.update(c)),_e1$1.copy(i.backgroundRotation),_e1$1.x*=-1,_e1$1.y*=-1,_e1$1.z*=-1,n.isCubeTexture&&!1===n.isRenderTargetTexture&&(_e1$1.y*=-1,_e1$1.z*=-1),c.material.uniforms.envMap.value=n,c.material.uniforms.flipEnvMap.value=n.isCubeTexture&&!1===n.isRenderTargetTexture?-1:1,c.material.uniforms.backgroundBlurriness.value=i.backgroundBlurriness,c.material.uniforms.backgroundIntensity.value=i.backgroundIntensity,c.material.uniforms.backgroundRotation.value.setFromMatrix4(_m1$1.makeRotationFromEuler(_e1$1)),c.material.toneMapped=ColorManagement.getTransfer(n.colorSpace)!==SRGBTransfer,h===n&&d===n.version&&p===e.toneMapping||(c.material.needsUpdate=!0,h=n,d=n.version,p=e.toneMapping),c.layers.enableAll(),t.unshift(c,c.geometry,c.material,0,0,null)):n&&n.isTexture&&(void 0===l&&(l=new Mesh(new PlaneGeometry(2,2),new ShaderMaterial({name:"BackgroundMaterial",uniforms:cloneUniforms(ShaderLib.background.uniforms),vertexShader:ShaderLib.background.vertexShader,fragmentShader:ShaderLib.background.fragmentShader,side:FrontSide,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),r.update(l)),l.material.uniforms.t2D.value=n,l.material.uniforms.backgroundIntensity.value=i.backgroundIntensity,l.material.toneMapped=ColorManagement.getTransfer(n.colorSpace)!==SRGBTransfer,!0===n.matrixAutoUpdate&&n.updateMatrix(),l.material.uniforms.uvTransform.value.copy(n.matrix),h===n&&d===n.version&&p===e.toneMapping||(l.material.needsUpdate=!0,h=n,d=n.version,p=e.toneMapping),l.layers.enableAll(),t.unshift(l,l.geometry,l.material,0,0,null))},dispose:function(){void 0!==c&&(c.geometry.dispose(),c.material.dispose(),c=void 0),void 0!==l&&(l.geometry.dispose(),l.material.dispose(),l=void 0)}}}function WebGLBindingStates(e,t){const i=e.getParameter(e.MAX_VERTEX_ATTRIBS),n={},r=c(null);let o=r,s=!1;function a(t){return e.bindVertexArray(t)}function l(t){return e.deleteVertexArray(t)}function c(e){const t=[],n=[],r=[];for(let e=0;e<i;e++)t[e]=0,n[e]=0,r[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:n,attributeDivisors:r,object:e,attributes:{},index:null}}function u(){const e=o.newAttributes;for(let t=0,i=e.length;t<i;t++)e[t]=0}function h(e){d(e,0)}function d(t,i){const n=o.enabledAttributes,r=o.attributeDivisors;o.newAttributes[t]=1,0===n[t]&&(e.enableVertexAttribArray(t),n[t]=1),r[t]!==i&&(e.vertexAttribDivisor(t,i),r[t]=i)}function p(){const t=o.newAttributes,i=o.enabledAttributes;for(let n=0,r=i.length;n<r;n++)i[n]!==t[n]&&(e.disableVertexAttribArray(n),i[n]=0)}function f(t,i,n,r,o,s,a){!0===a?e.vertexAttribIPointer(t,i,n,o,s):e.vertexAttribPointer(t,i,n,r,o,s)}function m(){g(),s=!0,o!==r&&(o=r,a(o.object))}function g(){r.geometry=null,r.program=null,r.wireframe=!1}return{setup:function(i,r,l,m,g){let _=!1;const y=function(t,i,r){const o=!0===r.wireframe;let s=n[t.id];void 0===s&&(s={},n[t.id]=s);let a=s[i.id];void 0===a&&(a={},s[i.id]=a);let l=a[o];void 0===l&&(l=c(e.createVertexArray()),a[o]=l);return l}(m,l,r);o!==y&&(o=y,a(o.object)),_=function(e,t,i,n){const r=o.attributes,s=t.attributes;let a=0;const l=i.getAttributes();for(const t in l){if(l[t].location>=0){const i=r[t];let n=s[t];if(void 0===n&&("instanceMatrix"===t&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(n=e.instanceColor)),void 0===i)return!0;if(i.attribute!==n)return!0;if(n&&i.data!==n.data)return!0;a++}}return o.attributesNum!==a||o.index!==n}(i,m,l,g),_&&function(e,t,i,n){const r={},s=t.attributes;let a=0;const l=i.getAttributes();for(const t in l){if(l[t].location>=0){let i=s[t];void 0===i&&("instanceMatrix"===t&&e.instanceMatrix&&(i=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(i=e.instanceColor));const n={};n.attribute=i,i&&i.data&&(n.data=i.data),r[t]=n,a++}}o.attributes=r,o.attributesNum=a,o.index=n}(i,m,l,g),null!==g&&t.update(g,e.ELEMENT_ARRAY_BUFFER),(_||s)&&(s=!1,function(i,n,r,o){u();const s=o.attributes,a=r.getAttributes(),l=n.defaultAttributeValues;for(const n in a){const r=a[n];if(r.location>=0){let a=s[n];if(void 0===a&&("instanceMatrix"===n&&i.instanceMatrix&&(a=i.instanceMatrix),"instanceColor"===n&&i.instanceColor&&(a=i.instanceColor)),void 0!==a){const n=a.normalized,s=a.itemSize,l=t.get(a);if(void 0===l)continue;const c=l.buffer,u=l.type,p=l.bytesPerElement,m=u===e.INT||u===e.UNSIGNED_INT||a.gpuType===IntType;if(a.isInterleavedBufferAttribute){const t=a.data,l=t.stride,g=a.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<r.locationSize;e++)d(r.location+e,t.meshPerAttribute);!0!==i.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<r.locationSize;e++)h(r.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<r.locationSize;e++)f(r.location+e,s/r.locationSize,u,n,l*p,(g+s/r.locationSize*e)*p,m)}else{if(a.isInstancedBufferAttribute){for(let e=0;e<r.locationSize;e++)d(r.location+e,a.meshPerAttribute);!0!==i.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=a.meshPerAttribute*a.count)}else for(let e=0;e<r.locationSize;e++)h(r.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<r.locationSize;e++)f(r.location+e,s/r.locationSize,u,n,s*p,s/r.locationSize*e*p,m)}}else if(void 0!==l){const t=l[n];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(r.location,t);break;case 3:e.vertexAttrib3fv(r.location,t);break;case 4:e.vertexAttrib4fv(r.location,t);break;default:e.vertexAttrib1fv(r.location,t)}}}}p()}(i,r,l,m),null!==g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.get(g).buffer))},reset:m,resetDefaultState:g,dispose:function(){m();for(const e in n){const t=n[e];for(const e in t){const i=t[e];for(const e in i)l(i[e].object),delete i[e];delete t[e]}delete n[e]}},releaseStatesOfGeometry:function(e){if(void 0===n[e.id])return;const t=n[e.id];for(const e in t){const i=t[e];for(const e in i)l(i[e].object),delete i[e];delete t[e]}delete n[e.id]},releaseStatesOfProgram:function(e){for(const t in n){const i=n[t];if(void 0===i[e.id])continue;const r=i[e.id];for(const e in r)l(r[e].object),delete r[e];delete i[e.id]}},initAttributes:u,enableAttribute:h,disableUnusedAttributes:p}}function WebGLBufferRenderer(e,t,i){let n;function r(t,r,o){0!==o&&(e.drawArraysInstanced(n,t,r,o),i.update(r,n,o))}this.setMode=function(e){n=e},this.render=function(t,r){e.drawArrays(n,t,r),i.update(r,n,1)},this.renderInstances=r,this.renderMultiDraw=function(e,r,o){if(0===o)return;t.get("WEBGL_multi_draw").multiDrawArraysWEBGL(n,e,0,r,0,o);let s=0;for(let e=0;e<o;e++)s+=r[e];i.update(s,n,1)},this.renderMultiDrawInstances=function(e,o,s,a){if(0===s)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<e.length;t++)r(e[t],o[t],a[t]);else{l.multiDrawArraysInstancedWEBGL(n,e,0,o,0,a,0,s);let t=0;for(let e=0;e<s;e++)t+=o[e]*a[e];i.update(t,n,1)}}}function WebGLCapabilities(e,t,i,n){let r;function o(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let s=void 0!==i.precision?i.precision:"highp";const a=o(s);a!==s&&(warn("WebGLRenderer:",s,"not supported, using",a,"instead."),s=a);return{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==r)return r;if(!0===t.has("EXT_texture_filter_anisotropic")){const i=t.get("EXT_texture_filter_anisotropic");r=e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else r=0;return r},getMaxPrecision:o,textureFormatReadable:function(t){return t===RGBAFormat||n.convert(t)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(i){const r=i===HalfFloatType&&(t.has("EXT_color_buffer_half_float")||t.has("EXT_color_buffer_float"));return!(i!==UnsignedByteType&&n.convert(i)!==e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)&&i!==FloatType&&!r)},precision:s,logarithmicDepthBuffer:!0===i.logarithmicDepthBuffer,reversedDepthBuffer:!0===i.reversedDepthBuffer&&t.has("EXT_clip_control"),maxTextures:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),maxVertexTextures:e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),maxSamples:e.getParameter(e.MAX_SAMPLES),samples:e.getParameter(e.SAMPLES)}}function WebGLClipping(e){const t=this;let i=null,n=0,r=!1,o=!1;const s=new Plane$1,a=new Matrix3,l={value:null,needsUpdate:!1};function c(e,i,n,r){const o=null!==e?e.length:0;let c=null;if(0!==o){if(c=l.value,!0!==r||null===c){const t=n+4*o,r=i.matrixWorldInverse;a.getNormalMatrix(r),(null===c||c.length<t)&&(c=new Float32Array(t));for(let t=0,i=n;t!==o;++t,i+=4)s.copy(e[t]).applyMatrix4(r,a),s.normal.toArray(c,i),c[i+3]=s.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=o,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const i=0!==e.length||t||0!==n||r;return r=t,n=e.length,i},this.beginShadows=function(){o=!0,c(null)},this.endShadows=function(){o=!1},this.setGlobalState=function(e,t){i=c(e,t,0)},this.setState=function(s,a,u){const h=s.clippingPlanes,d=s.clipIntersection,p=s.clipShadows,f=e.get(s);if(!r||null===h||0===h.length||o&&!p)o?c(null):function(){l.value!==i&&(l.value=i,l.needsUpdate=n>0);t.numPlanes=n,t.numIntersection=0}();else{const e=o?0:n,t=4*e;let r=f.clippingState||null;l.value=r,r=c(h,a,t,u);for(let e=0;e!==t;++e)r[e]=i[e];f.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function WebGLCubeMaps(e){let t=new WeakMap;function i(e,t){return t===EquirectangularReflectionMapping?e.mapping=CubeReflectionMapping:t===EquirectangularRefractionMapping&&(e.mapping=CubeRefractionMapping),e}function n(e){const i=e.target;i.removeEventListener("dispose",n);const r=t.get(i);void 0!==r&&(t.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture){const o=r.mapping;if(o===EquirectangularReflectionMapping||o===EquirectangularRefractionMapping){if(t.has(r)){return i(t.get(r).texture,r.mapping)}{const o=r.image;if(o&&o.height>0){const s=new WebGLCubeRenderTarget(o.height);return s.fromEquirectangularTexture(e,r),t.set(r,s),r.addEventListener("dispose",n),i(s.texture,r.mapping)}return null}}}return r},dispose:function(){t=new WeakMap}}}const LOD_MIN=4,EXTRA_LOD_SIGMA=[.125,.215,.35,.446,.526,.582],MAX_SAMPLES=20,GGX_SAMPLES=256,_flatCamera=new OrthographicCamera,_clearColor=new Color;let _oldTarget=null,_oldActiveCubeFace=0,_oldActiveMipmapLevel=0,_oldXrEnabled=!1;const _origin=new Vector3;class PMREMGenerator{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._backgroundBox=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._blurMaterial=null,this._ggxMaterial=null}fromScene(e,t=0,i=.1,n=100,r={}){const{size:o=256,position:s=_origin}=r;_oldTarget=this._renderer.getRenderTarget(),_oldActiveCubeFace=this._renderer.getActiveCubeFace(),_oldActiveMipmapLevel=this._renderer.getActiveMipmapLevel(),_oldXrEnabled=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(o);const a=this._allocateTargets();return a.depthBuffer=!0,this._sceneToCubeUV(e,i,n,a,s),t>0&&this._blur(a,0,0,t),this._applyPMREM(a),this._cleanup(a),a}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=_getCubemapMaterial(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=_getEquirectMaterial(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._ggxMaterial&&this._ggxMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodMeshes.length;e++)this._lodMeshes[e].geometry.dispose()}_cleanup(e){this._renderer.setRenderTarget(_oldTarget,_oldActiveCubeFace,_oldActiveMipmapLevel),this._renderer.xr.enabled=_oldXrEnabled,e.scissorTest=!1,_setViewport(e,0,0,e.width,e.height)}_fromTexture(e,t){this._setSize(e.mapping===CubeReflectionMapping||e.mapping===CubeRefractionMapping?0===e.image.length?16:e.image[0].width||e.image[0].image.width:e.image.width/4),_oldTarget=this._renderer.getRenderTarget(),_oldActiveCubeFace=this._renderer.getActiveCubeFace(),_oldActiveMipmapLevel=this._renderer.getActiveMipmapLevel(),_oldXrEnabled=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const i=t||this._allocateTargets();return this._textureToCubeUV(e,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,i={magFilter:LinearFilter,minFilter:LinearFilter,generateMipmaps:!1,type:HalfFloatType,format:RGBAFormat,colorSpace:LinearSRGBColorSpace,depthBuffer:!1},n=_createRenderTarget(e,t,i);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=_createRenderTarget(e,t,i);const{_lodMax:n}=this;({lodMeshes:this._lodMeshes,sizeLods:this._sizeLods,sigmas:this._sigmas}=_createPlanes(n)),this._blurMaterial=_getBlurShader(n,e,t),this._ggxMaterial=_getGGXShader(n,e,t)}return n}_compileMaterial(e){const t=new Mesh(new BufferGeometry,e);this._renderer.compile(t,_flatCamera)}_sceneToCubeUV(e,t,i,n,r){const o=new PerspectiveCamera(90,1,t,i),s=[1,-1,1,1,1,1],a=[1,1,1,-1,-1,-1],l=this._renderer,c=l.autoClear,u=l.toneMapping;l.getClearColor(_clearColor),l.toneMapping=NoToneMapping,l.autoClear=!1;l.state.buffers.depth.getReversed()&&(l.setRenderTarget(n),l.clearDepth(),l.setRenderTarget(null)),null===this._backgroundBox&&(this._backgroundBox=new Mesh(new BoxGeometry,new MeshBasicMaterial({name:"PMREM.Background",side:BackSide,depthWrite:!1,depthTest:!1})));const h=this._backgroundBox,d=h.material;let p=!1;const f=e.background;f?f.isColor&&(d.color.copy(f),e.background=null,p=!0):(d.color.copy(_clearColor),p=!0);for(let t=0;t<6;t++){const i=t%3;0===i?(o.up.set(0,s[t],0),o.position.set(r.x,r.y,r.z),o.lookAt(r.x+a[t],r.y,r.z)):1===i?(o.up.set(0,0,s[t]),o.position.set(r.x,r.y,r.z),o.lookAt(r.x,r.y+a[t],r.z)):(o.up.set(0,s[t],0),o.position.set(r.x,r.y,r.z),o.lookAt(r.x,r.y,r.z+a[t]));const c=this._cubeSize;_setViewport(n,i*c,t>2?c:0,c,c),l.setRenderTarget(n),p&&l.render(h,o),l.render(e,o)}l.toneMapping=u,l.autoClear=c,e.background=f}_textureToCubeUV(e,t){const i=this._renderer,n=e.mapping===CubeReflectionMapping||e.mapping===CubeRefractionMapping;n?(null===this._cubemapMaterial&&(this._cubemapMaterial=_getCubemapMaterial()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=_getEquirectMaterial());const r=n?this._cubemapMaterial:this._equirectMaterial,o=this._lodMeshes[0];o.material=r;r.uniforms.envMap.value=e;const s=this._cubeSize;_setViewport(t,0,0,3*s,2*s),i.setRenderTarget(t),i.render(o,_flatCamera)}_applyPMREM(e){const t=this._renderer,i=t.autoClear;t.autoClear=!1;const n=this._lodMeshes.length;for(let t=1;t<n;t++)this._applyGGXFilter(e,t-1,t);t.autoClear=i}_applyGGXFilter(e,t,i){const n=this._renderer,r=this._pingPongRenderTarget,o=this._ggxMaterial,s=this._lodMeshes[i];s.material=o;const a=o.uniforms,l=i/(this._lodMeshes.length-1),c=t/(this._lodMeshes.length-1),u=Math.sqrt(l*l-c*c)*(0+1.25*l),{_lodMax:h}=this,d=this._sizeLods[i],p=3*d*(i>h-LOD_MIN?i-h+LOD_MIN:0),f=4*(this._cubeSize-d);a.envMap.value=e.texture,a.roughness.value=u,a.mipInt.value=h-t,_setViewport(r,p,f,3*d,2*d),n.setRenderTarget(r),n.render(s,_flatCamera),a.envMap.value=r.texture,a.roughness.value=0,a.mipInt.value=h-i,_setViewport(e,p,f,3*d,2*d),n.setRenderTarget(e),n.render(s,_flatCamera)}_blur(e,t,i,n,r){const o=this._pingPongRenderTarget;this._halfBlur(e,o,t,i,n,"latitudinal",r),this._halfBlur(o,e,i,i,n,"longitudinal",r)}_halfBlur(e,t,i,n,r,o,s){const a=this._renderer,l=this._blurMaterial;"latitudinal"!==o&&"longitudinal"!==o&&error("blur direction must be either latitudinal or longitudinal!");const c=this._lodMeshes[n];c.material=l;const u=l.uniforms,h=this._sizeLods[i]-1,d=isFinite(r)?Math.PI/(2*h):2*Math.PI/(2*MAX_SAMPLES-1),p=r/d,f=isFinite(r)?1+Math.floor(3*p):MAX_SAMPLES;f>MAX_SAMPLES&&warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${f} samples when the maximum is set to ${MAX_SAMPLES}`);const m=[];let g=0;for(let e=0;e<MAX_SAMPLES;++e){const t=e/p,i=Math.exp(-t*t/2);m.push(i),0===e?g+=i:e<f&&(g+=2*i)}for(let e=0;e<m.length;e++)m[e]=m[e]/g;u.envMap.value=e.texture,u.samples.value=f,u.weights.value=m,u.latitudinal.value="latitudinal"===o,s&&(u.poleAxis.value=s);const{_lodMax:_}=this;u.dTheta.value=d,u.mipInt.value=_-i;const y=this._sizeLods[n];_setViewport(t,3*y*(n>_-LOD_MIN?n-_+LOD_MIN:0),4*(this._cubeSize-y),3*y,2*y),a.setRenderTarget(t),a.render(c,_flatCamera)}}function _createPlanes(e){const t=[],i=[],n=[];let r=e;const o=e-LOD_MIN+1+EXTRA_LOD_SIGMA.length;for(let s=0;s<o;s++){const o=Math.pow(2,r);t.push(o);let a=1/o;s>e-LOD_MIN?a=EXTRA_LOD_SIGMA[s-e+LOD_MIN-1]:0===s&&(a=0),i.push(a);const l=1/(o-2),c=-l,u=1+l,h=[c,c,u,c,u,u,c,c,u,u,c,u],d=6,p=6,f=3,m=2,g=1,_=new Float32Array(f*p*d),y=new Float32Array(m*p*d),v=new Float32Array(g*p*d);for(let e=0;e<d;e++){const t=e%3*2/3-1,i=e>2?0:-1;_.set([t,i,0,t+2/3,i,0,t+2/3,i+1,0,t,i,0,t+2/3,i+1,0,t,i+1,0],f*p*e),y.set(h,m*p*e);v.set([e,e,e,e,e,e],g*p*e)}const x=new BufferGeometry;x.setAttribute("position",new BufferAttribute(_,f)),x.setAttribute("uv",new BufferAttribute(y,m)),x.setAttribute("faceIndex",new BufferAttribute(v,g)),n.push(new Mesh(x,null)),r>LOD_MIN&&r--}return{lodMeshes:n,sizeLods:t,sigmas:i}}function _createRenderTarget(e,t,i){const n=new WebGLRenderTarget(e,t,i);return n.texture.mapping=CubeUVReflectionMapping,n.texture.name="PMREM.cubeUv",n.scissorTest=!0,n}function _setViewport(e,t,i,n,r){e.viewport.set(t,i,n,r),e.scissor.set(t,i,n,r)}function _getGGXShader(e,t,i){return new ShaderMaterial({name:"PMREMGGXConvolution",defines:{GGX_SAMPLES:GGX_SAMPLES,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},roughness:{value:0},mipInt:{value:0}},vertexShader:_getCommonVertexShader(),fragmentShader:'\n\n\t\t\tprecision highp float;\n\t\t\tprecision highp int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform float roughness;\n\t\t\tuniform float mipInt;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\t#define PI 3.14159265359\n\n\t\t\t// Van der Corput radical inverse\n\t\t\tfloat radicalInverse_VdC(uint bits) {\n\t\t\t\tbits = (bits << 16u) | (bits >> 16u);\n\t\t\t\tbits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);\n\t\t\t\tbits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);\n\t\t\t\tbits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);\n\t\t\t\tbits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);\n\t\t\t\treturn float(bits) * 2.3283064365386963e-10; // / 0x100000000\n\t\t\t}\n\n\t\t\t// Hammersley sequence\n\t\t\tvec2 hammersley(uint i, uint N) {\n\t\t\t\treturn vec2(float(i) / float(N), radicalInverse_VdC(i));\n\t\t\t}\n\n\t\t\t// GGX VNDF importance sampling (Eric Heitz 2018)\n\t\t\t// "Sampling the GGX Distribution of Visible Normals"\n\t\t\t// https://jcgt.org/published/0007/04/01/\n\t\t\tvec3 importanceSampleGGX_VNDF(vec2 Xi, vec3 V, float roughness) {\n\t\t\t\tfloat alpha = roughness * roughness;\n\n\t\t\t\t// Section 3.2: Transform view direction to hemisphere configuration\n\t\t\t\tvec3 Vh = normalize(vec3(alpha * V.x, alpha * V.y, V.z));\n\n\t\t\t\t// Section 4.1: Orthonormal basis\n\t\t\t\tfloat lensq = Vh.x * Vh.x + Vh.y * Vh.y;\n\t\t\t\tvec3 T1 = lensq > 0.0 ? vec3(-Vh.y, Vh.x, 0.0) / sqrt(lensq) : vec3(1.0, 0.0, 0.0);\n\t\t\t\tvec3 T2 = cross(Vh, T1);\n\n\t\t\t\t// Section 4.2: Parameterization of projected area\n\t\t\t\tfloat r = sqrt(Xi.x);\n\t\t\t\tfloat phi = 2.0 * PI * Xi.y;\n\t\t\t\tfloat t1 = r * cos(phi);\n\t\t\t\tfloat t2 = r * sin(phi);\n\t\t\t\tfloat s = 0.5 * (1.0 + Vh.z);\n\t\t\t\tt2 = (1.0 - s) * sqrt(1.0 - t1 * t1) + s * t2;\n\n\t\t\t\t// Section 4.3: Reprojection onto hemisphere\n\t\t\t\tvec3 Nh = t1 * T1 + t2 * T2 + sqrt(max(0.0, 1.0 - t1 * t1 - t2 * t2)) * Vh;\n\n\t\t\t\t// Section 3.4: Transform back to ellipsoid configuration\n\t\t\t\treturn normalize(vec3(alpha * Nh.x, alpha * Nh.y, max(0.0, Nh.z)));\n\t\t\t}\n\n\t\t\tvoid main() {\n\t\t\t\tvec3 N = normalize(vOutputDirection);\n\t\t\t\tvec3 V = N; // Assume view direction equals normal for pre-filtering\n\n\t\t\t\tvec3 prefilteredColor = vec3(0.0);\n\t\t\t\tfloat totalWeight = 0.0;\n\n\t\t\t\t// For very low roughness, just sample the environment directly\n\t\t\t\tif (roughness < 0.001) {\n\t\t\t\t\tgl_FragColor = vec4(bilinearCubeUV(envMap, N, mipInt), 1.0);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Tangent space basis for VNDF sampling\n\t\t\t\tvec3 up = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);\n\t\t\t\tvec3 tangent = normalize(cross(up, N));\n\t\t\t\tvec3 bitangent = cross(N, tangent);\n\n\t\t\t\tfor(uint i = 0u; i < uint(GGX_SAMPLES); i++) {\n\t\t\t\t\tvec2 Xi = hammersley(i, uint(GGX_SAMPLES));\n\n\t\t\t\t\t// For PMREM, V = N, so in tangent space V is always (0, 0, 1)\n\t\t\t\t\tvec3 H_tangent = importanceSampleGGX_VNDF(Xi, vec3(0.0, 0.0, 1.0), roughness);\n\n\t\t\t\t\t// Transform H back to world space\n\t\t\t\t\tvec3 H = normalize(tangent * H_tangent.x + bitangent * H_tangent.y + N * H_tangent.z);\n\t\t\t\t\tvec3 L = normalize(2.0 * dot(V, H) * H - V);\n\n\t\t\t\t\tfloat NdotL = max(dot(N, L), 0.0);\n\n\t\t\t\t\tif(NdotL > 0.0) {\n\t\t\t\t\t\t// Sample environment at fixed mip level\n\t\t\t\t\t\t// VNDF importance sampling handles the distribution filtering\n\t\t\t\t\t\tvec3 sampleColor = bilinearCubeUV(envMap, L, mipInt);\n\n\t\t\t\t\t\t// Weight by NdotL for the split-sum approximation\n\t\t\t\t\t\t// VNDF PDF naturally accounts for the visible microfacet distribution\n\t\t\t\t\t\tprefilteredColor += sampleColor * NdotL;\n\t\t\t\t\t\ttotalWeight += NdotL;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (totalWeight > 0.0) {\n\t\t\t\t\tprefilteredColor = prefilteredColor / totalWeight;\n\t\t\t\t}\n\n\t\t\t\tgl_FragColor = vec4(prefilteredColor, 1.0);\n\t\t\t}\n\t\t',blending:NoBlending,depthTest:!1,depthWrite:!1})}function _getBlurShader(e,t,i){const n=new Float32Array(MAX_SAMPLES),r=new Vector3(0,1,0);return new ShaderMaterial({name:"SphericalGaussianBlur",defines:{n:MAX_SAMPLES,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:n},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r}},vertexShader:_getCommonVertexShader(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:NoBlending,depthTest:!1,depthWrite:!1})}function _getEquirectMaterial(){return new ShaderMaterial({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:_getCommonVertexShader(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:NoBlending,depthTest:!1,depthWrite:!1})}function _getCubemapMaterial(){return new ShaderMaterial({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:_getCommonVertexShader(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:NoBlending,depthTest:!1,depthWrite:!1})}function _getCommonVertexShader(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function WebGLCubeUVMaps(e){let t=new WeakMap,i=null;function n(e){const i=e.target;i.removeEventListener("dispose",n);const r=t.get(i);void 0!==r&&(t.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture){const o=r.mapping,s=o===EquirectangularReflectionMapping||o===EquirectangularRefractionMapping,a=o===CubeReflectionMapping||o===CubeRefractionMapping;if(s||a){let o=t.get(r);if(r.isRenderTargetTexture&&r.pmremVersion!==(void 0!==o?o.texture.pmremVersion:0))return null===i&&(i=new PMREMGenerator(e)),o=s?i.fromEquirectangular(r,o):i.fromCubemap(r,o),o.texture.pmremVersion=r.pmremVersion,t.set(r,o),o.texture;if(void 0!==o)return o.texture;{const l=r.image;return s&&l&&l.height>0||a&&l&&function(e){let t=0;const i=6;for(let n=0;n<i;n++)void 0!==e[n]&&t++;return t===i}(l)?(null===i&&(i=new PMREMGenerator(e)),o=s?i.fromEquirectangular(r):i.fromCubemap(r),o.texture.pmremVersion=r.pmremVersion,t.set(r,o),r.addEventListener("dispose",n),o.texture):null}}}return r},dispose:function(){t=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function WebGLExtensions(e){const t={};function i(i){if(void 0!==t[i])return t[i];const n=e.getExtension(i);return t[i]=n,n}return{has:function(e){return null!==i(e)},init:function(){i("EXT_color_buffer_float"),i("WEBGL_clip_cull_distance"),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("WEBGL_multisampled_render_to_texture"),i("WEBGL_render_shared_exponent")},get:function(e){const t=i(e);return null===t&&warnOnce("WebGLRenderer: "+e+" extension not supported."),t}}}function WebGLGeometries(e,t,i,n){const r={},o=new WeakMap;function s(e){const a=e.target;null!==a.index&&t.remove(a.index);for(const e in a.attributes)t.remove(a.attributes[e]);a.removeEventListener("dispose",s),delete r[a.id];const l=o.get(a);l&&(t.remove(l),o.delete(a)),n.releaseStatesOfGeometry(a),!0===a.isInstancedBufferGeometry&&delete a._maxInstanceCount,i.memory.geometries--}function a(e){const i=[],n=e.index,r=e.attributes.position;let s=0;if(null!==n){const e=n.array;s=n.version;for(let t=0,n=e.length;t<n;t+=3){const n=e[t+0],r=e[t+1],o=e[t+2];i.push(n,r,r,o,o,n)}}else{if(void 0===r)return;s=r.version;for(let e=0,t=r.array.length/3-1;e<t;e+=3){const t=e+0,n=e+1,r=e+2;i.push(t,n,n,r,r,t)}}const a=new(arrayNeedsUint32(i)?Uint32BufferAttribute:Uint16BufferAttribute)(i,1);a.version=s;const l=o.get(e);l&&t.remove(l),o.set(e,a)}return{get:function(e,t){return!0===r[t.id]||(t.addEventListener("dispose",s),r[t.id]=!0,i.memory.geometries++),t},update:function(i){const n=i.attributes;for(const i in n)t.update(n[i],e.ARRAY_BUFFER)},getWireframeAttribute:function(e){const t=o.get(e);if(t){const i=e.index;null!==i&&t.version<i.version&&a(e)}else a(e);return o.get(e)}}}function WebGLIndexedBufferRenderer(e,t,i){let n,r,o;function s(t,s,a){0!==a&&(e.drawElementsInstanced(n,s,r,t*o,a),i.update(s,n,a))}this.setMode=function(e){n=e},this.setIndex=function(e){r=e.type,o=e.bytesPerElement},this.render=function(t,s){e.drawElements(n,s,r,t*o),i.update(s,n,1)},this.renderInstances=s,this.renderMultiDraw=function(e,o,s){if(0===s)return;t.get("WEBGL_multi_draw").multiDrawElementsWEBGL(n,o,0,r,e,0,s);let a=0;for(let e=0;e<s;e++)a+=o[e];i.update(a,n,1)},this.renderMultiDrawInstances=function(e,a,l,c){if(0===l)return;const u=t.get("WEBGL_multi_draw");if(null===u)for(let t=0;t<e.length;t++)s(e[t]/o,a[t],c[t]);else{u.multiDrawElementsInstancedWEBGL(n,a,0,r,e,0,c,0,l);let t=0;for(let e=0;e<l;e++)t+=a[e]*c[e];i.update(t,n,1)}}}function WebGLInfo(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(i,n,r){switch(t.calls++,n){case e.TRIANGLES:t.triangles+=r*(i/3);break;case e.LINES:t.lines+=r*(i/2);break;case e.LINE_STRIP:t.lines+=r*(i-1);break;case e.LINE_LOOP:t.lines+=r*i;break;case e.POINTS:t.points+=r*i;break;default:error("WebGLInfo: Unknown draw mode:",n)}}}}function WebGLMorphtargets(e,t,i){const n=new WeakMap,r=new Vector4;return{update:function(o,s,a){const l=o.morphTargetInfluences,c=s.morphAttributes.position||s.morphAttributes.normal||s.morphAttributes.color,u=void 0!==c?c.length:0;let h=n.get(s);if(void 0===h||h.count!==u){void 0!==h&&h.texture.dispose();const d=void 0!==s.morphAttributes.position,p=void 0!==s.morphAttributes.normal,f=void 0!==s.morphAttributes.color,m=s.morphAttributes.position||[],g=s.morphAttributes.normal||[],_=s.morphAttributes.color||[];let y=0;!0===d&&(y=1),!0===p&&(y=2),!0===f&&(y=3);let v=s.attributes.position.count*y,x=1;v>t.maxTextureSize&&(x=Math.ceil(v/t.maxTextureSize),v=t.maxTextureSize);const b=new Float32Array(v*x*4*u),T=new DataArrayTexture(b,v,x,u);T.type=FloatType,T.needsUpdate=!0;const w=4*y;for(let S=0;S<u;S++){const A=m[S],M=g[S],I=_[S],C=v*x*4*S;for(let P=0;P<A.count;P++){const L=P*w;!0===d&&(r.fromBufferAttribute(A,P),b[C+L+0]=r.x,b[C+L+1]=r.y,b[C+L+2]=r.z,b[C+L+3]=0),!0===p&&(r.fromBufferAttribute(M,P),b[C+L+4]=r.x,b[C+L+5]=r.y,b[C+L+6]=r.z,b[C+L+7]=0),!0===f&&(r.fromBufferAttribute(I,P),b[C+L+8]=r.x,b[C+L+9]=r.y,b[C+L+10]=r.z,b[C+L+11]=4===I.itemSize?r.w:1)}}function E(){T.dispose(),n.delete(s),s.removeEventListener("dispose",E)}h={count:u,texture:T,size:new Vector2(v,x)},n.set(s,h),s.addEventListener("dispose",E)}if(!0===o.isInstancedMesh&&null!==o.morphTexture)a.getUniforms().setValue(e,"morphTexture",o.morphTexture,i);else{let R=0;for(let D=0;D<l.length;D++)R+=l[D];const O=s.morphTargetsRelative?1:1-R;a.getUniforms().setValue(e,"morphTargetBaseInfluence",O),a.getUniforms().setValue(e,"morphTargetInfluences",l)}a.getUniforms().setValue(e,"morphTargetsTexture",h.texture,i),a.getUniforms().setValue(e,"morphTargetsTextureSize",h.size)}}}function WebGLObjects(e,t,i,n){let r=new WeakMap;function o(e){const t=e.target;t.removeEventListener("dispose",o),i.remove(t.instanceMatrix),null!==t.instanceColor&&i.remove(t.instanceColor)}return{update:function(s){const a=n.render.frame,l=t.get(s,s.geometry);if(r.get(l)!==a&&(t.update(l),r.set(l,a)),s.isInstancedMesh&&(!1===s.hasEventListener("dispose",o)&&s.addEventListener("dispose",o),r.get(s)!==a&&(i.update(s.instanceMatrix,e.ARRAY_BUFFER),null!==s.instanceColor&&i.update(s.instanceColor,e.ARRAY_BUFFER),r.set(s,a))),s.isSkinnedMesh){const e=s.skeleton;r.get(e)!==a&&(e.update(),r.set(e,a))}return l},dispose:function(){r=new WeakMap}}}const toneMappingMap={[LinearToneMapping]:"LINEAR_TONE_MAPPING",[ReinhardToneMapping]:"REINHARD_TONE_MAPPING",[CineonToneMapping]:"CINEON_TONE_MAPPING",[ACESFilmicToneMapping]:"ACES_FILMIC_TONE_MAPPING",[AgXToneMapping]:"AGX_TONE_MAPPING",[NeutralToneMapping]:"NEUTRAL_TONE_MAPPING",[CustomToneMapping]:"CUSTOM_TONE_MAPPING"};function WebGLOutput(e,t,i,n,r){const o=new WebGLRenderTarget(t,i,{type:e,depthBuffer:n,stencilBuffer:r}),s=new WebGLRenderTarget(t,i,{type:HalfFloatType,depthBuffer:!1,stencilBuffer:!1}),a=new BufferGeometry;a.setAttribute("position",new Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),a.setAttribute("uv",new Float32BufferAttribute([0,2,0,0,2,0],2));const l=new RawShaderMaterial({uniforms:{tDiffuse:{value:null}},vertexShader:"\n\t\t\tprecision highp float;\n\n\t\t\tuniform mat4 modelViewMatrix;\n\t\t\tuniform mat4 projectionMatrix;\n\n\t\t\tattribute vec3 position;\n\t\t\tattribute vec2 uv;\n\n\t\t\tvarying vec2 vUv;\n\n\t\t\tvoid main() {\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t}",fragmentShader:"\n\t\t\tprecision highp float;\n\n\t\t\tuniform sampler2D tDiffuse;\n\n\t\t\tvarying vec2 vUv;\n\n\t\t\t#include <tonemapping_pars_fragment>\n\t\t\t#include <colorspace_pars_fragment>\n\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\n\t\t\t\t#ifdef LINEAR_TONE_MAPPING\n\t\t\t\t\tgl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );\n\t\t\t\t#elif defined( REINHARD_TONE_MAPPING )\n\t\t\t\t\tgl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );\n\t\t\t\t#elif defined( CINEON_TONE_MAPPING )\n\t\t\t\t\tgl_FragColor.rgb = CineonToneMapping( gl_FragColor.rgb );\n\t\t\t\t#elif defined( ACES_FILMIC_TONE_MAPPING )\n\t\t\t\t\tgl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );\n\t\t\t\t#elif defined( AGX_TONE_MAPPING )\n\t\t\t\t\tgl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );\n\t\t\t\t#elif defined( NEUTRAL_TONE_MAPPING )\n\t\t\t\t\tgl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );\n\t\t\t\t#elif defined( CUSTOM_TONE_MAPPING )\n\t\t\t\t\tgl_FragColor.rgb = CustomToneMapping( gl_FragColor.rgb );\n\t\t\t\t#endif\n\n\t\t\t\t#ifdef SRGB_TRANSFER\n\t\t\t\t\tgl_FragColor = sRGBTransferOETF( gl_FragColor );\n\t\t\t\t#endif\n\t\t\t}",depthTest:!1,depthWrite:!1}),c=new Mesh(a,l),u=new OrthographicCamera(-1,1,1,-1,0,1);let h,d=null,p=null,f=!1,m=null,g=[],_=!1;this.setSize=function(e,t){o.setSize(e,t),s.setSize(e,t);for(let i=0;i<g.length;i++){const n=g[i];n.setSize&&n.setSize(e,t)}},this.setEffects=function(e){g=e,_=g.length>0&&!0===g[0].isRenderPass;const t=o.width,i=o.height;for(let e=0;e<g.length;e++){const n=g[e];n.setSize&&n.setSize(t,i)}},this.begin=function(e,t){if(f)return!1;if(e.toneMapping===NoToneMapping&&0===g.length)return!1;if(m=t,null!==t){const e=t.width,i=t.height;o.width===e&&o.height===i||this.setSize(e,i)}return!1===_&&e.setRenderTarget(o),h=e.toneMapping,e.toneMapping=NoToneMapping,!0},this.hasRenderPass=function(){return _},this.end=function(e,t){e.toneMapping=h,f=!0;let i=o,n=s;for(let r=0;r<g.length;r++){const o=g[r];if(!1!==o.enabled&&(o.render(e,n,i,t),!1!==o.needsSwap)){const e=i;i=n,n=e}}if(d!==e.outputColorSpace||p!==e.toneMapping){d=e.outputColorSpace,p=e.toneMapping,l.defines={},ColorManagement.getTransfer(d)===SRGBTransfer&&(l.defines.SRGB_TRANSFER="");const t=toneMappingMap[p];t&&(l.defines[t]=""),l.needsUpdate=!0}l.uniforms.tDiffuse.value=i.texture,e.setRenderTarget(m),e.render(c,u),m=null,f=!1},this.isCompositing=function(){return f},this.dispose=function(){o.dispose(),s.dispose(),a.dispose(),l.dispose()}}const emptyTexture=new Texture,emptyShadowTexture=new DepthTexture(1,1),emptyArrayTexture=new DataArrayTexture,empty3dTexture=new Data3DTexture,emptyCubeTexture=new CubeTexture,arrayCacheF32=[],arrayCacheI32=[],mat4array=new Float32Array(16),mat3array=new Float32Array(9),mat2array=new Float32Array(4);function flatten(e,t,i){const n=e[0];if(n<=0||n>0)return e;const r=t*i;let o=arrayCacheF32[r];if(void 0===o&&(o=new Float32Array(r),arrayCacheF32[r]=o),0!==t){n.toArray(o,0);for(let n=1,r=0;n!==t;++n)r+=i,e[n].toArray(o,r)}return o}function arraysEqual(e,t){if(e.length!==t.length)return!1;for(let i=0,n=e.length;i<n;i++)if(e[i]!==t[i])return!1;return!0}function copyArray(e,t){for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}function allocTexUnits(e,t){let i=arrayCacheI32[t];void 0===i&&(i=new Int32Array(t),arrayCacheI32[t]=i);for(let n=0;n!==t;++n)i[n]=e.allocateTextureUnit();return i}function setValueV1f(e,t){const i=this.cache;i[0]!==t&&(e.uniform1f(this.addr,t),i[0]=t)}function setValueV2f(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(arraysEqual(i,t))return;e.uniform2fv(this.addr,t),copyArray(i,t)}}function setValueV3f(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else if(void 0!==t.r)i[0]===t.r&&i[1]===t.g&&i[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),i[0]=t.r,i[1]=t.g,i[2]=t.b);else{if(arraysEqual(i,t))return;e.uniform3fv(this.addr,t),copyArray(i,t)}}function setValueV4f(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(arraysEqual(i,t))return;e.uniform4fv(this.addr,t),copyArray(i,t)}}function setValueM2(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(i,t))return;e.uniformMatrix2fv(this.addr,!1,t),copyArray(i,t)}else{if(arraysEqual(i,n))return;mat2array.set(n),e.uniformMatrix2fv(this.addr,!1,mat2array),copyArray(i,n)}}function setValueM3(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(i,t))return;e.uniformMatrix3fv(this.addr,!1,t),copyArray(i,t)}else{if(arraysEqual(i,n))return;mat3array.set(n),e.uniformMatrix3fv(this.addr,!1,mat3array),copyArray(i,n)}}function setValueM4(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(arraysEqual(i,t))return;e.uniformMatrix4fv(this.addr,!1,t),copyArray(i,t)}else{if(arraysEqual(i,n))return;mat4array.set(n),e.uniformMatrix4fv(this.addr,!1,mat4array),copyArray(i,n)}}function setValueV1i(e,t){const i=this.cache;i[0]!==t&&(e.uniform1i(this.addr,t),i[0]=t)}function setValueV2i(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(arraysEqual(i,t))return;e.uniform2iv(this.addr,t),copyArray(i,t)}}function setValueV3i(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else{if(arraysEqual(i,t))return;e.uniform3iv(this.addr,t),copyArray(i,t)}}function setValueV4i(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(arraysEqual(i,t))return;e.uniform4iv(this.addr,t),copyArray(i,t)}}function setValueV1ui(e,t){const i=this.cache;i[0]!==t&&(e.uniform1ui(this.addr,t),i[0]=t)}function setValueV2ui(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(arraysEqual(i,t))return;e.uniform2uiv(this.addr,t),copyArray(i,t)}}function setValueV3ui(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else{if(arraysEqual(i,t))return;e.uniform3uiv(this.addr,t),copyArray(i,t)}}function setValueV4ui(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(arraysEqual(i,t))return;e.uniform4uiv(this.addr,t),copyArray(i,t)}}function setValueT1(e,t,i){const n=this.cache,r=i.allocateTextureUnit();let o;n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),this.type===e.SAMPLER_2D_SHADOW?(emptyShadowTexture.compareFunction=i.isReversedDepthBuffer()?GreaterEqualCompare:LessEqualCompare,o=emptyShadowTexture):o=emptyTexture,i.setTexture2D(t||o,r)}function setValueT3D1(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(t||empty3dTexture,r)}function setValueT6(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.setTextureCube(t||emptyCubeTexture,r)}function setValueT2DArray1(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(t||emptyArrayTexture,r)}function getSingularSetter(e){switch(e){case 5126:return setValueV1f;case 35664:return setValueV2f;case 35665:return setValueV3f;case 35666:return setValueV4f;case 35674:return setValueM2;case 35675:return setValueM3;case 35676:return setValueM4;case 5124:case 35670:return setValueV1i;case 35667:case 35671:return setValueV2i;case 35668:case 35672:return setValueV3i;case 35669:case 35673:return setValueV4i;case 5125:return setValueV1ui;case 36294:return setValueV2ui;case 36295:return setValueV3ui;case 36296:return setValueV4ui;case 35678:case 36198:case 36298:case 36306:case 35682:return setValueT1;case 35679:case 36299:case 36307:return setValueT3D1;case 35680:case 36300:case 36308:case 36293:return setValueT6;case 36289:case 36303:case 36311:case 36292:return setValueT2DArray1}}function setValueV1fArray(e,t){e.uniform1fv(this.addr,t)}function setValueV2fArray(e,t){const i=flatten(t,this.size,2);e.uniform2fv(this.addr,i)}function setValueV3fArray(e,t){const i=flatten(t,this.size,3);e.uniform3fv(this.addr,i)}function setValueV4fArray(e,t){const i=flatten(t,this.size,4);e.uniform4fv(this.addr,i)}function setValueM2Array(e,t){const i=flatten(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,i)}function setValueM3Array(e,t){const i=flatten(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,i)}function setValueM4Array(e,t){const i=flatten(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,i)}function setValueV1iArray(e,t){e.uniform1iv(this.addr,t)}function setValueV2iArray(e,t){e.uniform2iv(this.addr,t)}function setValueV3iArray(e,t){e.uniform3iv(this.addr,t)}function setValueV4iArray(e,t){e.uniform4iv(this.addr,t)}function setValueV1uiArray(e,t){e.uniform1uiv(this.addr,t)}function setValueV2uiArray(e,t){e.uniform2uiv(this.addr,t)}function setValueV3uiArray(e,t){e.uniform3uiv(this.addr,t)}function setValueV4uiArray(e,t){e.uniform4uiv(this.addr,t)}function setValueT1Array(e,t,i){const n=this.cache,r=t.length,o=allocTexUnits(i,r);let s;arraysEqual(n,o)||(e.uniform1iv(this.addr,o),copyArray(n,o)),s=this.type===e.SAMPLER_2D_SHADOW?emptyShadowTexture:emptyTexture;for(let e=0;e!==r;++e)i.setTexture2D(t[e]||s,o[e])}function setValueT3DArray(e,t,i){const n=this.cache,r=t.length,o=allocTexUnits(i,r);arraysEqual(n,o)||(e.uniform1iv(this.addr,o),copyArray(n,o));for(let e=0;e!==r;++e)i.setTexture3D(t[e]||empty3dTexture,o[e])}function setValueT6Array(e,t,i){const n=this.cache,r=t.length,o=allocTexUnits(i,r);arraysEqual(n,o)||(e.uniform1iv(this.addr,o),copyArray(n,o));for(let e=0;e!==r;++e)i.setTextureCube(t[e]||emptyCubeTexture,o[e])}function setValueT2DArrayArray(e,t,i){const n=this.cache,r=t.length,o=allocTexUnits(i,r);arraysEqual(n,o)||(e.uniform1iv(this.addr,o),copyArray(n,o));for(let e=0;e!==r;++e)i.setTexture2DArray(t[e]||emptyArrayTexture,o[e])}function getPureArraySetter(e){switch(e){case 5126:return setValueV1fArray;case 35664:return setValueV2fArray;case 35665:return setValueV3fArray;case 35666:return setValueV4fArray;case 35674:return setValueM2Array;case 35675:return setValueM3Array;case 35676:return setValueM4Array;case 5124:case 35670:return setValueV1iArray;case 35667:case 35671:return setValueV2iArray;case 35668:case 35672:return setValueV3iArray;case 35669:case 35673:return setValueV4iArray;case 5125:return setValueV1uiArray;case 36294:return setValueV2uiArray;case 36295:return setValueV3uiArray;case 36296:return setValueV4uiArray;case 35678:case 36198:case 36298:case 36306:case 35682:return setValueT1Array;case 35679:case 36299:case 36307:return setValueT3DArray;case 35680:case 36300:case 36308:case 36293:return setValueT6Array;case 36289:case 36303:case 36311:case 36292:return setValueT2DArrayArray}}class SingleUniform{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.type=t.type,this.setValue=getSingularSetter(t.type)}}class PureArrayUniform{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=getPureArraySetter(t.type)}}class StructuredUniform{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,i){const n=this.seq;for(let r=0,o=n.length;r!==o;++r){const o=n[r];o.setValue(e,t[o.id],i)}}}const RePathPart=/(\w+)(\])?(\[|\.)?/g;function addUniform(e,t){e.seq.push(t),e.map[t.id]=t}function parseUniform(e,t,i){const n=e.name,r=n.length;for(RePathPart.lastIndex=0;;){const o=RePathPart.exec(n);let s=o[1];const a=o[3];if("]"===o[2]&&(s|=0),void 0===a||"["===a&&RePathPart.lastIndex+2===r){addUniform(i,void 0===a?new SingleUniform(s,e,t):new PureArrayUniform(s,e,t));break}{let e=i.map[s];void 0===e&&(e=new StructuredUniform(s),addUniform(i,e)),i=e}}}class WebGLUniforms{constructor(e,t){this.seq=[],this.map={};const i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let n=0;n<i;++n){const i=e.getActiveUniform(t,n);parseUniform(i,e.getUniformLocation(t,i.name),this)}const n=[],r=[];for(const t of this.seq)t.type===e.SAMPLER_2D_SHADOW||t.type===e.SAMPLER_CUBE_SHADOW||t.type===e.SAMPLER_2D_ARRAY_SHADOW?n.push(t):r.push(t);n.length>0&&(this.seq=n.concat(r))}setValue(e,t,i,n){const r=this.map[t];void 0!==r&&r.setValue(e,i,n)}setOptional(e,t,i){const n=t[i];void 0!==n&&this.setValue(e,i,n)}static upload(e,t,i,n){for(let r=0,o=t.length;r!==o;++r){const o=t[r],s=i[o.id];!1!==s.needsUpdate&&o.setValue(e,s.value,n)}}static seqWithValue(e,t){const i=[];for(let n=0,r=e.length;n!==r;++n){const r=e[n];r.id in t&&i.push(r)}return i}}function WebGLShader(e,t,i){const n=e.createShader(t);return e.shaderSource(n,i),e.compileShader(n),n}const COMPLETION_STATUS_KHR=37297;let programIdCount=0;function handleSource(e,t){const i=e.split("\n"),n=[],r=Math.max(t-6,0),o=Math.min(t+6,i.length);for(let e=r;e<o;e++){const r=e+1;n.push(`${r===t?">":" "} ${r}: ${i[e]}`)}return n.join("\n")}const _m0=new Matrix3;function getEncodingComponents(e){ColorManagement._getMatrix(_m0,ColorManagement.workingColorSpace,e);const t=`mat3( ${_m0.elements.map((e=>e.toFixed(4)))} )`;switch(ColorManagement.getTransfer(e)){case LinearTransfer:return[t,"LinearTransferOETF"];case SRGBTransfer:return[t,"sRGBTransferOETF"];default:return warn("WebGLProgram: Unsupported color space: ",e),[t,"LinearTransferOETF"]}}function getShaderErrors(e,t,i){const n=e.getShaderParameter(t,e.COMPILE_STATUS),r=(e.getShaderInfoLog(t)||"").trim();if(n&&""===r)return"";const o=/ERROR: 0:(\d+)/.exec(r);if(o){const n=parseInt(o[1]);return i.toUpperCase()+"\n\n"+r+"\n\n"+handleSource(e.getShaderSource(t),n)}return r}function getTexelEncodingFunction(e,t){const i=getEncodingComponents(t);return[`vec4 ${e}( vec4 value ) {`,`\treturn ${i[1]}( vec4( value.rgb * ${i[0]}, value.a ) );`,"}"].join("\n")}const toneMappingFunctions={[LinearToneMapping]:"Linear",[ReinhardToneMapping]:"Reinhard",[CineonToneMapping]:"Cineon",[ACESFilmicToneMapping]:"ACESFilmic",[AgXToneMapping]:"AgX",[NeutralToneMapping]:"Neutral",[CustomToneMapping]:"Custom"};function getToneMappingFunction(e,t){const i=toneMappingFunctions[t];return void 0===i?(warn("WebGLProgram: Unsupported toneMapping:",t),"vec3 "+e+"( vec3 color ) { return LinearToneMapping( color ); }"):"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}const _v0=new Vector3;function getLuminanceFunction(){ColorManagement.getLuminanceCoefficients(_v0);return["float luminance( const in vec3 rgb ) {",`\tconst vec3 weights = vec3( ${_v0.x.toFixed(4)}, ${_v0.y.toFixed(4)}, ${_v0.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")}function generateVertexExtensions(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(filterEmptyLine).join("\n")}function generateDefines(e){const t=[];for(const i in e){const n=e[i];!1!==n&&t.push("#define "+i+" "+n)}return t.join("\n")}function fetchAttributeLocations(e,t){const i={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let r=0;r<n;r++){const n=e.getActiveAttrib(t,r),o=n.name;let s=1;n.type===e.FLOAT_MAT2&&(s=2),n.type===e.FLOAT_MAT3&&(s=3),n.type===e.FLOAT_MAT4&&(s=4),i[o]={type:n.type,location:e.getAttribLocation(t,o),locationSize:s}}return i}function filterEmptyLine(e){return""!==e}function replaceLightNums(e,t){const i=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function replaceClippingPlaneNums(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const includePattern=/^[ \t]*#include +<([\w\d./]+)>/gm;function resolveIncludes(e){return e.replace(includePattern,includeReplacer)}const shaderChunkMap=new Map;function includeReplacer(e,t){let i=ShaderChunk[t];if(void 0===i){const e=shaderChunkMap.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");i=ShaderChunk[e],warn('WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',t,e)}return resolveIncludes(i)}const unrollLoopPattern=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function unrollLoops(e){return e.replace(unrollLoopPattern,loopReplacer)}function loopReplacer(e,t,i,n){let r="";for(let e=parseInt(t);e<parseInt(i);e++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return r}function generatePrecision(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\tprecision ${e.precision} sampler3D;\n\tprecision ${e.precision} sampler2DArray;\n\tprecision ${e.precision} sampler2DShadow;\n\tprecision ${e.precision} samplerCubeShadow;\n\tprecision ${e.precision} sampler2DArrayShadow;\n\tprecision ${e.precision} isampler2D;\n\tprecision ${e.precision} isampler3D;\n\tprecision ${e.precision} isamplerCube;\n\tprecision ${e.precision} isampler2DArray;\n\tprecision ${e.precision} usampler2D;\n\tprecision ${e.precision} usampler3D;\n\tprecision ${e.precision} usamplerCube;\n\tprecision ${e.precision} usampler2DArray;\n\t`;return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}const shadowMapTypeDefines={[PCFShadowMap]:"SHADOWMAP_TYPE_PCF",[VSMShadowMap]:"SHADOWMAP_TYPE_VSM"};function generateShadowMapTypeDefine(e){return shadowMapTypeDefines[e.shadowMapType]||"SHADOWMAP_TYPE_BASIC"}const envMapTypeDefines={[CubeReflectionMapping]:"ENVMAP_TYPE_CUBE",[CubeRefractionMapping]:"ENVMAP_TYPE_CUBE",[CubeUVReflectionMapping]:"ENVMAP_TYPE_CUBE_UV"};function generateEnvMapTypeDefine(e){return!1===e.envMap?"ENVMAP_TYPE_CUBE":envMapTypeDefines[e.envMapMode]||"ENVMAP_TYPE_CUBE"}const envMapModeDefines={[CubeRefractionMapping]:"ENVMAP_MODE_REFRACTION"};function generateEnvMapModeDefine(e){return!1===e.envMap?"ENVMAP_MODE_REFLECTION":envMapModeDefines[e.envMapMode]||"ENVMAP_MODE_REFLECTION"}const envMapBlendingDefines={[MultiplyOperation]:"ENVMAP_BLENDING_MULTIPLY",[MixOperation]:"ENVMAP_BLENDING_MIX",[AddOperation]:"ENVMAP_BLENDING_ADD"};function generateEnvMapBlendingDefine(e){return!1===e.envMap?"ENVMAP_BLENDING_NONE":envMapBlendingDefines[e.combine]||"ENVMAP_BLENDING_NONE"}function generateCubeUVSize(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const i=Math.log2(t)-2,n=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,i),112)),texelHeight:n,maxMip:i}}function WebGLProgram(e,t,i,n){const r=e.getContext(),o=i.defines;let s=i.vertexShader,a=i.fragmentShader;const l=generateShadowMapTypeDefine(i),c=generateEnvMapTypeDefine(i),u=generateEnvMapModeDefine(i),h=generateEnvMapBlendingDefine(i),d=generateCubeUVSize(i),p=generateVertexExtensions(i),f=generateDefines(o),m=r.createProgram();let g,_,y=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(g=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,f].filter(filterEmptyLine).join("\n"),g.length>0&&(g+="\n"),_=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,f].filter(filterEmptyLine).join("\n"),_.length>0&&(_+="\n")):(g=[generatePrecision(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,f,i.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",i.batching?"#define USE_BATCHING":"",i.batchingColor?"#define USE_BATCHING_COLOR":"",i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.instancingMorph?"#define USE_INSTANCING_MORPH":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+u:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.displacementMap?"#define USE_DISPLACEMENTMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.mapUv?"#define MAP_UV "+i.mapUv:"",i.alphaMapUv?"#define ALPHAMAP_UV "+i.alphaMapUv:"",i.lightMapUv?"#define LIGHTMAP_UV "+i.lightMapUv:"",i.aoMapUv?"#define AOMAP_UV "+i.aoMapUv:"",i.emissiveMapUv?"#define EMISSIVEMAP_UV "+i.emissiveMapUv:"",i.bumpMapUv?"#define BUMPMAP_UV "+i.bumpMapUv:"",i.normalMapUv?"#define NORMALMAP_UV "+i.normalMapUv:"",i.displacementMapUv?"#define DISPLACEMENTMAP_UV "+i.displacementMapUv:"",i.metalnessMapUv?"#define METALNESSMAP_UV "+i.metalnessMapUv:"",i.roughnessMapUv?"#define ROUGHNESSMAP_UV "+i.roughnessMapUv:"",i.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+i.anisotropyMapUv:"",i.clearcoatMapUv?"#define CLEARCOATMAP_UV "+i.clearcoatMapUv:"",i.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+i.clearcoatNormalMapUv:"",i.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+i.clearcoatRoughnessMapUv:"",i.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+i.iridescenceMapUv:"",i.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+i.iridescenceThicknessMapUv:"",i.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+i.sheenColorMapUv:"",i.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+i.sheenRoughnessMapUv:"",i.specularMapUv?"#define SPECULARMAP_UV "+i.specularMapUv:"",i.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+i.specularColorMapUv:"",i.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+i.specularIntensityMapUv:"",i.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+i.transmissionMapUv:"",i.thicknessMapUv?"#define THICKNESSMAP_UV "+i.thicknessMapUv:"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.morphColors?"#define USE_MORPHCOLORS":"",i.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+i.morphTextureStride:"",i.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.logarithmicDepthBuffer?"#define USE_LOGARITHMIC_DEPTH_BUFFER":"",i.reversedDepthBuffer?"#define USE_REVERSED_DEPTH_BUFFER":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(filterEmptyLine).join("\n"),_=[generatePrecision(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,f,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.envMap?"#define "+u:"",i.envMap?"#define "+h:"",d?"#define CUBEUV_TEXEL_WIDTH "+d.texelWidth:"",d?"#define CUBEUV_TEXEL_HEIGHT "+d.texelHeight:"",d?"#define CUBEUV_MAX_MIP "+d.maxMip+".0":"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.dispersion?"#define USE_DISPERSION":"",i.iridescence?"#define USE_IRIDESCENCE":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.sheen?"#define USE_SHEEN":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor||i.batchingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",i.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",i.logarithmicDepthBuffer?"#define USE_LOGARITHMIC_DEPTH_BUFFER":"",i.reversedDepthBuffer?"#define USE_REVERSED_DEPTH_BUFFER":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",i.toneMapping!==NoToneMapping?"#define TONE_MAPPING":"",i.toneMapping!==NoToneMapping?ShaderChunk.tonemapping_pars_fragment:"",i.toneMapping!==NoToneMapping?getToneMappingFunction("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.opaque?"#define OPAQUE":"",ShaderChunk.colorspace_pars_fragment,getTexelEncodingFunction("linearToOutputTexel",i.outputColorSpace),getLuminanceFunction(),i.useDepthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(filterEmptyLine).join("\n")),s=resolveIncludes(s),s=replaceLightNums(s,i),s=replaceClippingPlaneNums(s,i),a=resolveIncludes(a),a=replaceLightNums(a,i),a=replaceClippingPlaneNums(a,i),s=unrollLoops(s),a=unrollLoops(a),!0!==i.isRawShaderMaterial&&(y="#version 300 es\n",g=[p,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,_=["#define varying in",i.glslVersion===GLSL3?"":"layout(location = 0) out highp vec4 pc_fragColor;",i.glslVersion===GLSL3?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+_);const v=y+_+a,x=WebGLShader(r,r.VERTEX_SHADER,y+g+s),b=WebGLShader(r,r.FRAGMENT_SHADER,v);function T(t){if(e.debug.checkShaderErrors){const i=r.getProgramInfoLog(m)||"",n=r.getShaderInfoLog(x)||"",o=r.getShaderInfoLog(b)||"",s=i.trim(),a=n.trim(),l=o.trim();let c=!0,u=!0;if(!1===r.getProgramParameter(m,r.LINK_STATUS))if(c=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(r,m,x,b);else{const e=getShaderErrors(r,x,"vertex"),i=getShaderErrors(r,b,"fragment");error("THREE.WebGLProgram: Shader Error "+r.getError()+" - VALIDATE_STATUS "+r.getProgramParameter(m,r.VALIDATE_STATUS)+"\n\nMaterial Name: "+t.name+"\nMaterial Type: "+t.type+"\n\nProgram Info Log: "+s+"\n"+e+"\n"+i)}else""!==s?warn("WebGLProgram: Program Info Log:",s):""!==a&&""!==l||(u=!1);u&&(t.diagnostics={runnable:c,programLog:s,vertexShader:{log:a,prefix:g},fragmentShader:{log:l,prefix:_}})}r.deleteShader(x),r.deleteShader(b),w=new WebGLUniforms(r,m),E=fetchAttributeLocations(r,m)}let w,E;r.attachShader(m,x),r.attachShader(m,b),void 0!==i.index0AttributeName?r.bindAttribLocation(m,0,i.index0AttributeName):!0===i.morphTargets&&r.bindAttribLocation(m,0,"position"),r.linkProgram(m),this.getUniforms=function(){return void 0===w&&T(this),w},this.getAttributes=function(){return void 0===E&&T(this),E};let S=!1===i.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===S&&(S=r.getProgramParameter(m,COMPLETION_STATUS_KHR)),S},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(m),this.program=void 0},this.type=i.shaderType,this.name=i.shaderName,this.id=programIdCount++,this.cacheKey=t,this.usedTimes=1,this.program=m,this.vertexShader=x,this.fragmentShader=b,this}let _id=0;class WebGLShaderCache{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.fragmentShader,i=this._getShaderStage(e.vertexShader),n=this._getShaderStage(t),r=this._getShaderCacheForMaterial(e);return!1===r.has(i)&&(r.add(i),i.usedTimes++),!1===r.has(n)&&(r.add(n),n.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const e of t)e.usedTimes--,0===e.usedTimes&&this.shaderCache.delete(e.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let i=t.get(e);return void 0===i&&(i=new Set,t.set(e,i)),i}_getShaderStage(e){const t=this.shaderCache;let i=t.get(e);return void 0===i&&(i=new WebGLShaderStage(e),t.set(e,i)),i}}class WebGLShaderStage{constructor(e){this.id=_id++,this.code=e,this.usedTimes=0}}function WebGLPrograms(e,t,i,n,r,o,s){const a=new Layers,l=new WebGLShaderCache,c=new Set,u=[],h=new Map,d=r.logarithmicDepthBuffer;let p=r.precision;const f={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distance",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function m(e){return c.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(o,a,u,h,g){const _=h.fog,y=g.geometry,v=(o.isMeshStandardMaterial?i:t).get(o.envMap||(o.isMeshStandardMaterial?h.environment:null)),x=v&&v.mapping===CubeUVReflectionMapping?v.image.height:null,b=f[o.type];null!==o.precision&&(p=r.getMaxPrecision(o.precision),p!==o.precision&&warn("WebGLProgram.getParameters:",o.precision,"not supported, using",p,"instead."));const T=y.morphAttributes.position||y.morphAttributes.normal||y.morphAttributes.color,w=void 0!==T?T.length:0;let E,S,A,M,I=0;if(void 0!==y.morphAttributes.position&&(I=1),void 0!==y.morphAttributes.normal&&(I=2),void 0!==y.morphAttributes.color&&(I=3),b){const e=ShaderLib[b];E=e.vertexShader,S=e.fragmentShader}else E=o.vertexShader,S=o.fragmentShader,l.update(o),A=l.getVertexShaderID(o),M=l.getFragmentShaderID(o);const C=e.getRenderTarget(),P=e.state.buffers.depth.getReversed(),L=!0===g.isInstancedMesh,R=!0===g.isBatchedMesh,O=!!o.map,D=!!v,B=!!o.aoMap,F=!!o.lightMap,N=!!o.bumpMap,k=!!o.normalMap,U=!!o.displacementMap,z=!!o.emissiveMap,V=!!o.metalnessMap,G=!!o.roughnessMap,j=o.anisotropy>0,H=o.clearcoat>0,$=o.iridescence>0,W=o.sheen>0,q=o.transmission>0,X=j&&!!o.anisotropyMap,Y=H&&!!o.clearcoatMap,Z=H&&!!o.clearcoatNormalMap,J=H&&!!o.clearcoatRoughnessMap,K=$&&!!o.iridescenceMap,Q=$&&!!o.iridescenceThicknessMap,ee=W&&!!o.sheenColorMap,te=W&&!!o.sheenRoughnessMap,ie=!!o.specularMap,ne=!!o.specularColorMap,re=!!o.specularIntensityMap,oe=q&&!!o.transmissionMap,se=q&&!!o.thicknessMap,ae=!!o.alphaMap,le=!!o.extensions;let ce=NoToneMapping;o.toneMapped&&(null!==C&&!0!==C.isXRRenderTarget||(ce=e.toneMapping));const ue={shaderID:b,shaderType:o.type,shaderName:o.name,vertexShader:E,fragmentShader:S,defines:o.defines,customVertexShaderID:A,customFragmentShaderID:M,isRawShaderMaterial:!0===o.isRawShaderMaterial,glslVersion:o.glslVersion,precision:p,batching:R,batchingColor:R&&null!==g._colorsTexture,instancing:L,instancingColor:L&&null!==g.instanceColor,instancingMorph:L&&null!==g.morphTexture,outputColorSpace:null===C?e.outputColorSpace:!0===C.isXRRenderTarget?C.texture.colorSpace:LinearSRGBColorSpace,alphaToCoverage:!!o.alphaToCoverage,map:O,matcap:!!o.matcap,envMap:D,envMapMode:D&&v.mapping,envMapCubeUVHeight:x,aoMap:B,lightMap:F,bumpMap:N,normalMap:k,displacementMap:U,emissiveMap:z,normalMapObjectSpace:k&&o.normalMapType===ObjectSpaceNormalMap,normalMapTangentSpace:k&&o.normalMapType===TangentSpaceNormalMap,metalnessMap:V,roughnessMap:G,anisotropy:j,anisotropyMap:X,clearcoat:H,clearcoatMap:Y,clearcoatNormalMap:Z,clearcoatRoughnessMap:J,dispersion:o.dispersion>0,iridescence:$,iridescenceMap:K,iridescenceThicknessMap:Q,sheen:W,sheenColorMap:ee,sheenRoughnessMap:te,specularMap:ie,specularColorMap:ne,specularIntensityMap:re,transmission:q,transmissionMap:oe,thicknessMap:se,gradientMap:!!o.gradientMap,opaque:!1===o.transparent&&o.blending===NormalBlending&&!1===o.alphaToCoverage,alphaMap:ae,alphaTest:o.alphaTest>0,alphaHash:!!o.alphaHash,combine:o.combine,mapUv:O&&m(o.map.channel),aoMapUv:B&&m(o.aoMap.channel),lightMapUv:F&&m(o.lightMap.channel),bumpMapUv:N&&m(o.bumpMap.channel),normalMapUv:k&&m(o.normalMap.channel),displacementMapUv:U&&m(o.displacementMap.channel),emissiveMapUv:z&&m(o.emissiveMap.channel),metalnessMapUv:V&&m(o.metalnessMap.channel),roughnessMapUv:G&&m(o.roughnessMap.channel),anisotropyMapUv:X&&m(o.anisotropyMap.channel),clearcoatMapUv:Y&&m(o.clearcoatMap.channel),clearcoatNormalMapUv:Z&&m(o.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:J&&m(o.clearcoatRoughnessMap.channel),iridescenceMapUv:K&&m(o.iridescenceMap.channel),iridescenceThicknessMapUv:Q&&m(o.iridescenceThicknessMap.channel),sheenColorMapUv:ee&&m(o.sheenColorMap.channel),sheenRoughnessMapUv:te&&m(o.sheenRoughnessMap.channel),specularMapUv:ie&&m(o.specularMap.channel),specularColorMapUv:ne&&m(o.specularColorMap.channel),specularIntensityMapUv:re&&m(o.specularIntensityMap.channel),transmissionMapUv:oe&&m(o.transmissionMap.channel),thicknessMapUv:se&&m(o.thicknessMap.channel),alphaMapUv:ae&&m(o.alphaMap.channel),vertexTangents:!!y.attributes.tangent&&(k||j),vertexColors:o.vertexColors,vertexAlphas:!0===o.vertexColors&&!!y.attributes.color&&4===y.attributes.color.itemSize,pointsUvs:!0===g.isPoints&&!!y.attributes.uv&&(O||ae),fog:!!_,useFog:!0===o.fog,fogExp2:!!_&&_.isFogExp2,flatShading:!0===o.flatShading&&!1===o.wireframe,sizeAttenuation:!0===o.sizeAttenuation,logarithmicDepthBuffer:d,reversedDepthBuffer:P,skinning:!0===g.isSkinnedMesh,morphTargets:void 0!==y.morphAttributes.position,morphNormals:void 0!==y.morphAttributes.normal,morphColors:void 0!==y.morphAttributes.color,morphTargetsCount:w,morphTextureStride:I,numDirLights:a.directional.length,numPointLights:a.point.length,numSpotLights:a.spot.length,numSpotLightMaps:a.spotLightMap.length,numRectAreaLights:a.rectArea.length,numHemiLights:a.hemi.length,numDirLightShadows:a.directionalShadowMap.length,numPointLightShadows:a.pointShadowMap.length,numSpotLightShadows:a.spotShadowMap.length,numSpotLightShadowsWithMaps:a.numSpotLightShadowsWithMaps,numLightProbes:a.numLightProbes,numClippingPlanes:s.numPlanes,numClipIntersection:s.numIntersection,dithering:o.dithering,shadowMapEnabled:e.shadowMap.enabled&&u.length>0,shadowMapType:e.shadowMap.type,toneMapping:ce,decodeVideoTexture:O&&!0===o.map.isVideoTexture&&ColorManagement.getTransfer(o.map.colorSpace)===SRGBTransfer,decodeVideoTextureEmissive:z&&!0===o.emissiveMap.isVideoTexture&&ColorManagement.getTransfer(o.emissiveMap.colorSpace)===SRGBTransfer,premultipliedAlpha:o.premultipliedAlpha,doubleSided:o.side===DoubleSide,flipSided:o.side===BackSide,useDepthPacking:o.depthPacking>=0,depthPacking:o.depthPacking||0,index0AttributeName:o.index0AttributeName,extensionClipCullDistance:le&&!0===o.extensions.clipCullDistance&&n.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(le&&!0===o.extensions.multiDraw||R)&&n.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:n.has("KHR_parallel_shader_compile"),customProgramCacheKey:o.customProgramCacheKey()};return ue.vertexUv1s=c.has(1),ue.vertexUv2s=c.has(2),ue.vertexUv3s=c.has(3),c.clear(),ue},getProgramCacheKey:function(t){const i=[];if(t.shaderID?i.push(t.shaderID):(i.push(t.customVertexShaderID),i.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)i.push(e),i.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(!function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(i,t),function(e,t){a.disableAll(),t.instancing&&a.enable(0);t.instancingColor&&a.enable(1);t.instancingMorph&&a.enable(2);t.matcap&&a.enable(3);t.envMap&&a.enable(4);t.normalMapObjectSpace&&a.enable(5);t.normalMapTangentSpace&&a.enable(6);t.clearcoat&&a.enable(7);t.iridescence&&a.enable(8);t.alphaTest&&a.enable(9);t.vertexColors&&a.enable(10);t.vertexAlphas&&a.enable(11);t.vertexUv1s&&a.enable(12);t.vertexUv2s&&a.enable(13);t.vertexUv3s&&a.enable(14);t.vertexTangents&&a.enable(15);t.anisotropy&&a.enable(16);t.alphaHash&&a.enable(17);t.batching&&a.enable(18);t.dispersion&&a.enable(19);t.batchingColor&&a.enable(20);t.gradientMap&&a.enable(21);e.push(a.mask),a.disableAll(),t.fog&&a.enable(0);t.useFog&&a.enable(1);t.flatShading&&a.enable(2);t.logarithmicDepthBuffer&&a.enable(3);t.reversedDepthBuffer&&a.enable(4);t.skinning&&a.enable(5);t.morphTargets&&a.enable(6);t.morphNormals&&a.enable(7);t.morphColors&&a.enable(8);t.premultipliedAlpha&&a.enable(9);t.shadowMapEnabled&&a.enable(10);t.doubleSided&&a.enable(11);t.flipSided&&a.enable(12);t.useDepthPacking&&a.enable(13);t.dithering&&a.enable(14);t.transmission&&a.enable(15);t.sheen&&a.enable(16);t.opaque&&a.enable(17);t.pointsUvs&&a.enable(18);t.decodeVideoTexture&&a.enable(19);t.decodeVideoTextureEmissive&&a.enable(20);t.alphaToCoverage&&a.enable(21);e.push(a.mask)}(i,t),i.push(e.outputColorSpace)),i.push(t.customProgramCacheKey),i.join()},getUniforms:function(e){const t=f[e.type];let i;if(t){i=UniformsUtils.clone(ShaderLib[t].uniforms)}else i=e.uniforms;return i},acquireProgram:function(t,i){let n=h.get(i);return void 0!==n?++n.usedTimes:(n=new WebGLProgram(e,i,t,o),u.push(n),h.set(i,n)),n},releaseProgram:function(e){if(0==--e.usedTimes){const t=u.indexOf(e);u[t]=u[u.length-1],u.pop(),h.delete(e.cacheKey),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:u,dispose:function(){l.dispose()}}}function WebGLProperties(){let e=new WeakMap;return{has:function(t){return e.has(t)},get:function(t){let i=e.get(t);return void 0===i&&(i={},e.set(t,i)),i},remove:function(t){e.delete(t)},update:function(t,i,n){e.get(t)[i]=n},dispose:function(){e=new WeakMap}}}function painterSortStable(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function reversePainterSortStable(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function WebGLRenderList(){const e=[];let t=0;const i=[],n=[],r=[];function o(i,n,r,o,s,a){let l=e[t];return void 0===l?(l={id:i.id,object:i,geometry:n,material:r,groupOrder:o,renderOrder:i.renderOrder,z:s,group:a},e[t]=l):(l.id=i.id,l.object=i,l.geometry=n,l.material=r,l.groupOrder=o,l.renderOrder=i.renderOrder,l.z=s,l.group=a),t++,l}return{opaque:i,transmissive:n,transparent:r,init:function(){t=0,i.length=0,n.length=0,r.length=0},push:function(e,t,s,a,l,c){const u=o(e,t,s,a,l,c);s.transmission>0?n.push(u):!0===s.transparent?r.push(u):i.push(u)},unshift:function(e,t,s,a,l,c){const u=o(e,t,s,a,l,c);s.transmission>0?n.unshift(u):!0===s.transparent?r.unshift(u):i.unshift(u)},finish:function(){for(let i=t,n=e.length;i<n;i++){const t=e[i];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){i.length>1&&i.sort(e||painterSortStable),n.length>1&&n.sort(t||reversePainterSortStable),r.length>1&&r.sort(t||reversePainterSortStable)}}}function WebGLRenderLists(){let e=new WeakMap;return{get:function(t,i){const n=e.get(t);let r;return void 0===n?(r=new WebGLRenderList,e.set(t,[r])):i>=n.length?(r=new WebGLRenderList,n.push(r)):r=n[i],r},dispose:function(){e=new WeakMap}}}function UniformsCache(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":i={direction:new Vector3,color:new Color};break;case"SpotLight":i={position:new Vector3,direction:new Vector3,color:new Color,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Vector3,color:new Color,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Vector3,skyColor:new Color,groundColor:new Color};break;case"RectAreaLight":i={color:new Color,position:new Vector3,halfWidth:new Vector3,halfHeight:new Vector3}}return e[t.id]=i,i}}}function ShadowUniformsCache(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":case"SpotLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"PointLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Vector2,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=i,i}}}let nextVersion=0;function shadowCastingAndTexturingLightsFirst(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function WebGLLights(e){const t=new UniformsCache,i=ShadowUniformsCache(),n={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)n.probe.push(new Vector3);const r=new Vector3,o=new Matrix4,s=new Matrix4;return{setup:function(r){let o=0,s=0,a=0;for(let e=0;e<9;e++)n.probe[e].set(0,0,0);let l=0,c=0,u=0,h=0,d=0,p=0,f=0,m=0,g=0,_=0,y=0;r.sort(shadowCastingAndTexturingLightsFirst);for(let e=0,v=r.length;e<v;e++){const v=r[e],x=v.color,b=v.intensity,T=v.distance;let w=null;if(v.shadow&&v.shadow.map&&(w=v.shadow.map.texture.format===RGFormat?v.shadow.map.texture:v.shadow.map.depthTexture||v.shadow.map.texture),v.isAmbientLight)o+=x.r*b,s+=x.g*b,a+=x.b*b;else if(v.isLightProbe){for(let e=0;e<9;e++)n.probe[e].addScaledVector(v.sh.coefficients[e],b);y++}else if(v.isDirectionalLight){const e=t.get(v);if(e.color.copy(v.color).multiplyScalar(v.intensity),v.castShadow){const e=v.shadow,t=i.get(v);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,n.directionalShadow[l]=t,n.directionalShadowMap[l]=w,n.directionalShadowMatrix[l]=v.shadow.matrix,p++}n.directional[l]=e,l++}else if(v.isSpotLight){const e=t.get(v);e.position.setFromMatrixPosition(v.matrixWorld),e.color.copy(x).multiplyScalar(b),e.distance=T,e.coneCos=Math.cos(v.angle),e.penumbraCos=Math.cos(v.angle*(1-v.penumbra)),e.decay=v.decay,n.spot[u]=e;const r=v.shadow;if(v.map&&(n.spotLightMap[g]=v.map,g++,r.updateMatrices(v),v.castShadow&&_++),n.spotLightMatrix[u]=r.matrix,v.castShadow){const e=i.get(v);e.shadowIntensity=r.intensity,e.shadowBias=r.bias,e.shadowNormalBias=r.normalBias,e.shadowRadius=r.radius,e.shadowMapSize=r.mapSize,n.spotShadow[u]=e,n.spotShadowMap[u]=w,m++}u++}else if(v.isRectAreaLight){const e=t.get(v);e.color.copy(x).multiplyScalar(b),e.halfWidth.set(.5*v.width,0,0),e.halfHeight.set(0,.5*v.height,0),n.rectArea[h]=e,h++}else if(v.isPointLight){const e=t.get(v);if(e.color.copy(v.color).multiplyScalar(v.intensity),e.distance=v.distance,e.decay=v.decay,v.castShadow){const e=v.shadow,t=i.get(v);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,n.pointShadow[c]=t,n.pointShadowMap[c]=w,n.pointShadowMatrix[c]=v.shadow.matrix,f++}n.point[c]=e,c++}else if(v.isHemisphereLight){const e=t.get(v);e.skyColor.copy(v.color).multiplyScalar(b),e.groundColor.copy(v.groundColor).multiplyScalar(b),n.hemi[d]=e,d++}}h>0&&(!0===e.has("OES_texture_float_linear")?(n.rectAreaLTC1=UniformsLib.LTC_FLOAT_1,n.rectAreaLTC2=UniformsLib.LTC_FLOAT_2):(n.rectAreaLTC1=UniformsLib.LTC_HALF_1,n.rectAreaLTC2=UniformsLib.LTC_HALF_2)),n.ambient[0]=o,n.ambient[1]=s,n.ambient[2]=a;const v=n.hash;v.directionalLength===l&&v.pointLength===c&&v.spotLength===u&&v.rectAreaLength===h&&v.hemiLength===d&&v.numDirectionalShadows===p&&v.numPointShadows===f&&v.numSpotShadows===m&&v.numSpotMaps===g&&v.numLightProbes===y||(n.directional.length=l,n.spot.length=u,n.rectArea.length=h,n.point.length=c,n.hemi.length=d,n.directionalShadow.length=p,n.directionalShadowMap.length=p,n.pointShadow.length=f,n.pointShadowMap.length=f,n.spotShadow.length=m,n.spotShadowMap.length=m,n.directionalShadowMatrix.length=p,n.pointShadowMatrix.length=f,n.spotLightMatrix.length=m+g-_,n.spotLightMap.length=g,n.numSpotLightShadowsWithMaps=_,n.numLightProbes=y,v.directionalLength=l,v.pointLength=c,v.spotLength=u,v.rectAreaLength=h,v.hemiLength=d,v.numDirectionalShadows=p,v.numPointShadows=f,v.numSpotShadows=m,v.numSpotMaps=g,v.numLightProbes=y,n.version=nextVersion++)},setupView:function(e,t){let i=0,a=0,l=0,c=0,u=0;const h=t.matrixWorldInverse;for(let t=0,d=e.length;t<d;t++){const d=e[t];if(d.isDirectionalLight){const e=n.directional[i];e.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(r),e.direction.transformDirection(h),i++}else if(d.isSpotLight){const e=n.spot[l];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(h),e.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(r),e.direction.transformDirection(h),l++}else if(d.isRectAreaLight){const e=n.rectArea[c];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(h),s.identity(),o.copy(d.matrixWorld),o.premultiply(h),s.extractRotation(o),e.halfWidth.set(.5*d.width,0,0),e.halfHeight.set(0,.5*d.height,0),e.halfWidth.applyMatrix4(s),e.halfHeight.applyMatrix4(s),c++}else if(d.isPointLight){const e=n.point[a];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(h),a++}else if(d.isHemisphereLight){const e=n.hemi[u];e.direction.setFromMatrixPosition(d.matrixWorld),e.direction.transformDirection(h),u++}}},state:n}}function WebGLRenderState(e){const t=new WebGLLights(e),i=[],n=[];const r={lightsArray:i,shadowsArray:n,camera:null,lights:t,transmissionRenderTarget:{}};return{init:function(e){r.camera=e,i.length=0,n.length=0},state:r,setupLights:function(){t.setup(i)},setupLightsView:function(e){t.setupView(i,e)},pushLight:function(e){i.push(e)},pushShadow:function(e){n.push(e)}}}function WebGLRenderStates(e){let t=new WeakMap;return{get:function(i,n=0){const r=t.get(i);let o;return void 0===r?(o=new WebGLRenderState(e),t.set(i,[o])):n>=r.length?(o=new WebGLRenderState(e),r.push(o)):o=r[n],o},dispose:function(){t=new WeakMap}}}const vertex="void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragment="uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ).rg;\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ).r;\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( max( 0.0, squared_mean - mean * mean ) );\n\tgl_FragColor = vec4( mean, std_dev, 0.0, 1.0 );\n}",_cubeDirections=[new Vector3(1,0,0),new Vector3(-1,0,0),new Vector3(0,1,0),new Vector3(0,-1,0),new Vector3(0,0,1),new Vector3(0,0,-1)],_cubeUps=[new Vector3(0,-1,0),new Vector3(0,-1,0),new Vector3(0,0,1),new Vector3(0,0,-1),new Vector3(0,-1,0),new Vector3(0,-1,0)],_projScreenMatrix=new Matrix4,_lightPositionWorld=new Vector3,_lookTarget=new Vector3;function WebGLShadowMap(e,t,i){let n=new Frustum;const r=new Vector2,o=new Vector2,s=new Vector4,a=new MeshDepthMaterial,l=new MeshDistanceMaterial,c={},u=i.maxTextureSize,h={[FrontSide]:BackSide,[BackSide]:FrontSide,[DoubleSide]:DoubleSide},d=new ShaderMaterial({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new Vector2},radius:{value:4}},vertexShader:vertex,fragmentShader:fragment}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const f=new BufferGeometry;f.setAttribute("position",new BufferAttribute(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const m=new Mesh(f,d),g=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=PCFShadowMap;let _=this.type;function y(i,n){const o=t.update(m);d.defines.VSM_SAMPLES!==i.blurSamples&&(d.defines.VSM_SAMPLES=i.blurSamples,p.defines.VSM_SAMPLES=i.blurSamples,d.needsUpdate=!0,p.needsUpdate=!0),null===i.mapPass&&(i.mapPass=new WebGLRenderTarget(r.x,r.y,{format:RGFormat,type:HalfFloatType})),d.uniforms.shadow_pass.value=i.map.depthTexture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,e.setRenderTarget(i.mapPass),e.clear(),e.renderBufferDirect(n,null,o,d,m,null),p.uniforms.shadow_pass.value=i.mapPass.texture,p.uniforms.resolution.value=i.mapSize,p.uniforms.radius.value=i.radius,e.setRenderTarget(i.map),e.clear(),e.renderBufferDirect(n,null,o,p,m,null)}function v(t,i,n,r){let o=null;const s=!0===n.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==s)o=s;else if(o=!0===n.isPointLight?l:a,e.localClippingEnabled&&!0===i.clipShadows&&Array.isArray(i.clippingPlanes)&&0!==i.clippingPlanes.length||i.displacementMap&&0!==i.displacementScale||i.alphaMap&&i.alphaTest>0||i.map&&i.alphaTest>0||!0===i.alphaToCoverage){const e=o.uuid,t=i.uuid;let n=c[e];void 0===n&&(n={},c[e]=n);let r=n[t];void 0===r&&(r=o.clone(),n[t]=r,i.addEventListener("dispose",b)),o=r}if(o.visible=i.visible,o.wireframe=i.wireframe,o.side=r===VSMShadowMap?null!==i.shadowSide?i.shadowSide:i.side:null!==i.shadowSide?i.shadowSide:h[i.side],o.alphaMap=i.alphaMap,o.alphaTest=!0===i.alphaToCoverage?.5:i.alphaTest,o.map=i.map,o.clipShadows=i.clipShadows,o.clippingPlanes=i.clippingPlanes,o.clipIntersection=i.clipIntersection,o.displacementMap=i.displacementMap,o.displacementScale=i.displacementScale,o.displacementBias=i.displacementBias,o.wireframeLinewidth=i.wireframeLinewidth,o.linewidth=i.linewidth,!0===n.isPointLight&&!0===o.isMeshDistanceMaterial){e.properties.get(o).light=n}return o}function x(i,r,o,s,a){if(!1===i.visible)return;if(i.layers.test(r.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&a===VSMShadowMap)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,i.matrixWorld);const n=t.update(i),l=i.material;if(Array.isArray(l)){const t=n.groups;for(let c=0,u=t.length;c<u;c++){const u=t[c],h=l[u.materialIndex];if(h&&h.visible){const t=v(i,h,s,a);i.onBeforeShadow(e,i,r,o,n,t,u),e.renderBufferDirect(o,null,n,t,i,u),i.onAfterShadow(e,i,r,o,n,t,u)}}}else if(l.visible){const t=v(i,l,s,a);i.onBeforeShadow(e,i,r,o,n,t,null),e.renderBufferDirect(o,null,n,t,i,null),i.onAfterShadow(e,i,r,o,n,t,null)}}const l=i.children;for(let e=0,t=l.length;e<t;e++)x(l[e],r,o,s,a)}function b(e){e.target.removeEventListener("dispose",b);for(const t in c){const i=c[t],n=e.target.uuid;if(n in i){i[n].dispose(),delete i[n]}}}this.render=function(t,i,a){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===t.length)return;t.type===PCFSoftShadowMap&&(warn("WebGLShadowMap: PCFSoftShadowMap has been deprecated. Using PCFShadowMap instead."),t.type=PCFShadowMap);const l=e.getRenderTarget(),c=e.getActiveCubeFace(),h=e.getActiveMipmapLevel(),d=e.state;d.setBlending(NoBlending),!0===d.buffers.depth.getReversed()?d.buffers.color.setClear(0,0,0,0):d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);const p=_!==this.type;p&&i.traverse((function(e){e.material&&(Array.isArray(e.material)?e.material.forEach((e=>e.needsUpdate=!0)):e.material.needsUpdate=!0)}));for(let l=0,c=t.length;l<c;l++){const c=t[l],h=c.shadow;if(void 0===h){warn("WebGLShadowMap:",c,"has no shadow.");continue}if(!1===h.autoUpdate&&!1===h.needsUpdate)continue;r.copy(h.mapSize);const f=h.getFrameExtents();if(r.multiply(f),o.copy(h.mapSize),(r.x>u||r.y>u)&&(r.x>u&&(o.x=Math.floor(u/f.x),r.x=o.x*f.x,h.mapSize.x=o.x),r.y>u&&(o.y=Math.floor(u/f.y),r.y=o.y*f.y,h.mapSize.y=o.y)),null===h.map||!0===p){if(null!==h.map&&(null!==h.map.depthTexture&&(h.map.depthTexture.dispose(),h.map.depthTexture=null),h.map.dispose()),this.type===VSMShadowMap){if(c.isPointLight){warn("WebGLShadowMap: VSM shadow maps are not supported for PointLights. Use PCF or BasicShadowMap instead.");continue}h.map=new WebGLRenderTarget(r.x,r.y,{format:RGFormat,type:HalfFloatType,minFilter:LinearFilter,magFilter:LinearFilter,generateMipmaps:!1}),h.map.texture.name=c.name+".shadowMap",h.map.depthTexture=new DepthTexture(r.x,r.y,FloatType),h.map.depthTexture.name=c.name+".shadowMapDepth",h.map.depthTexture.format=DepthFormat,h.map.depthTexture.compareFunction=null,h.map.depthTexture.minFilter=NearestFilter,h.map.depthTexture.magFilter=NearestFilter}else{c.isPointLight?(h.map=new WebGLCubeRenderTarget(r.x),h.map.depthTexture=new CubeDepthTexture(r.x,UnsignedIntType)):(h.map=new WebGLRenderTarget(r.x,r.y),h.map.depthTexture=new DepthTexture(r.x,r.y,UnsignedIntType)),h.map.depthTexture.name=c.name+".shadowMap",h.map.depthTexture.format=DepthFormat;const t=e.state.buffers.depth.getReversed();this.type===PCFShadowMap?(h.map.depthTexture.compareFunction=t?GreaterEqualCompare:LessEqualCompare,h.map.depthTexture.minFilter=LinearFilter,h.map.depthTexture.magFilter=LinearFilter):(h.map.depthTexture.compareFunction=null,h.map.depthTexture.minFilter=NearestFilter,h.map.depthTexture.magFilter=NearestFilter)}h.camera.updateProjectionMatrix()}const m=h.map.isWebGLCubeRenderTarget?6:1;for(let t=0;t<m;t++){if(h.map.isWebGLCubeRenderTarget)e.setRenderTarget(h.map,t),e.clear();else{0===t&&(e.setRenderTarget(h.map),e.clear());const i=h.getViewport(t);s.set(o.x*i.x,o.y*i.y,o.x*i.z,o.y*i.w),d.viewport(s)}if(c.isPointLight){const e=h.camera,i=h.matrix,n=c.distance||e.far;n!==e.far&&(e.far=n,e.updateProjectionMatrix()),_lightPositionWorld.setFromMatrixPosition(c.matrixWorld),e.position.copy(_lightPositionWorld),_lookTarget.copy(e.position),_lookTarget.add(_cubeDirections[t]),e.up.copy(_cubeUps[t]),e.lookAt(_lookTarget),e.updateMatrixWorld(),i.makeTranslation(-_lightPositionWorld.x,-_lightPositionWorld.y,-_lightPositionWorld.z),_projScreenMatrix.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),h._frustum.setFromProjectionMatrix(_projScreenMatrix,e.coordinateSystem,e.reversedDepth)}else h.updateMatrices(c);n=h.getFrustum(),x(i,a,h.camera,c,this.type)}!0!==h.isPointLightShadow&&this.type===VSMShadowMap&&y(h,a),h.needsUpdate=!1}_=this.type,g.needsUpdate=!1,e.setRenderTarget(l,c,h)}}const reversedFuncs={[NeverDepth]:AlwaysDepth,[LessDepth]:GreaterDepth,[EqualDepth]:NotEqualDepth,[LessEqualDepth]:GreaterEqualDepth,[AlwaysDepth]:NeverDepth,[GreaterDepth]:LessDepth,[NotEqualDepth]:EqualDepth,[GreaterEqualDepth]:LessEqualDepth};function WebGLState(e,t){const i=new function(){let t=!1;const i=new Vector4;let n=null;const r=new Vector4(0,0,0,0);return{setMask:function(i){n===i||t||(e.colorMask(i,i,i,i),n=i)},setLocked:function(e){t=e},setClear:function(t,n,o,s,a){!0===a&&(t*=s,n*=s,o*=s),i.set(t,n,o,s),!1===r.equals(i)&&(e.clearColor(t,n,o,s),r.copy(i))},reset:function(){t=!1,n=null,r.set(-1,0,0,0)}}},n=new function(){let i=!1,n=!1,r=null,o=null,s=null;return{setReversed:function(e){if(n!==e){const i=t.get("EXT_clip_control");i.clipControlEXT(i.LOWER_LEFT_EXT,e?i.ZERO_TO_ONE_EXT:i.NEGATIVE_ONE_TO_ONE_EXT),n=e;const r=s;s=null,this.setClear(r)}},getReversed:function(){return n},setTest:function(t){t?z(e.DEPTH_TEST):V(e.DEPTH_TEST)},setMask:function(t){r===t||i||(e.depthMask(t),r=t)},setFunc:function(t){if(n&&(t=reversedFuncs[t]),o!==t){switch(t){case NeverDepth:e.depthFunc(e.NEVER);break;case AlwaysDepth:e.depthFunc(e.ALWAYS);break;case LessDepth:e.depthFunc(e.LESS);break;case LessEqualDepth:e.depthFunc(e.LEQUAL);break;case EqualDepth:e.depthFunc(e.EQUAL);break;case GreaterEqualDepth:e.depthFunc(e.GEQUAL);break;case GreaterDepth:e.depthFunc(e.GREATER);break;case NotEqualDepth:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}o=t}},setLocked:function(e){i=e},setClear:function(t){s!==t&&(n&&(t=1-t),e.clearDepth(t),s=t)},reset:function(){i=!1,r=null,o=null,s=null,n=!1}}},r=new function(){let t=!1,i=null,n=null,r=null,o=null,s=null,a=null,l=null,c=null;return{setTest:function(i){t||(i?z(e.STENCIL_TEST):V(e.STENCIL_TEST))},setMask:function(n){i===n||t||(e.stencilMask(n),i=n)},setFunc:function(t,i,s){n===t&&r===i&&o===s||(e.stencilFunc(t,i,s),n=t,r=i,o=s)},setOp:function(t,i,n){s===t&&a===i&&l===n||(e.stencilOp(t,i,n),s=t,a=i,l=n)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,i=null,n=null,r=null,o=null,s=null,a=null,l=null,c=null}}},o=new WeakMap,s=new WeakMap;let a={},l={},c=new WeakMap,u=[],h=null,d=!1,p=null,f=null,m=null,g=null,_=null,y=null,v=null,x=new Color(0,0,0),b=0,T=!1,w=null,E=null,S=null,A=null,M=null;const I=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let C=!1,P=0;const L=e.getParameter(e.VERSION);-1!==L.indexOf("WebGL")?(P=parseFloat(/^WebGL (\d)/.exec(L)[1]),C=P>=1):-1!==L.indexOf("OpenGL ES")&&(P=parseFloat(/^OpenGL ES (\d)/.exec(L)[1]),C=P>=2);let R=null,O={};const D=e.getParameter(e.SCISSOR_BOX),B=e.getParameter(e.VIEWPORT),F=(new Vector4).fromArray(D),N=(new Vector4).fromArray(B);function k(t,i,n,r){const o=new Uint8Array(4),s=e.createTexture();e.bindTexture(t,s),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let s=0;s<n;s++)t===e.TEXTURE_3D||t===e.TEXTURE_2D_ARRAY?e.texImage3D(i,0,e.RGBA,1,1,r,0,e.RGBA,e.UNSIGNED_BYTE,o):e.texImage2D(i+s,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,o);return s}const U={};function z(t){!0!==a[t]&&(e.enable(t),a[t]=!0)}function V(t){!1!==a[t]&&(e.disable(t),a[t]=!1)}U[e.TEXTURE_2D]=k(e.TEXTURE_2D,e.TEXTURE_2D,1),U[e.TEXTURE_CUBE_MAP]=k(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),U[e.TEXTURE_2D_ARRAY]=k(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),U[e.TEXTURE_3D]=k(e.TEXTURE_3D,e.TEXTURE_3D,1,1),i.setClear(0,0,0,1),n.setClear(1),r.setClear(0),z(e.DEPTH_TEST),n.setFunc(LessEqualDepth),$(!1),W(CullFaceBack),z(e.CULL_FACE),H(NoBlending);const G={[AddEquation]:e.FUNC_ADD,[SubtractEquation]:e.FUNC_SUBTRACT,[ReverseSubtractEquation]:e.FUNC_REVERSE_SUBTRACT};G[MinEquation]=e.MIN,G[MaxEquation]=e.MAX;const j={[ZeroFactor]:e.ZERO,[OneFactor]:e.ONE,[SrcColorFactor]:e.SRC_COLOR,[SrcAlphaFactor]:e.SRC_ALPHA,[SrcAlphaSaturateFactor]:e.SRC_ALPHA_SATURATE,[DstColorFactor]:e.DST_COLOR,[DstAlphaFactor]:e.DST_ALPHA,[OneMinusSrcColorFactor]:e.ONE_MINUS_SRC_COLOR,[OneMinusSrcAlphaFactor]:e.ONE_MINUS_SRC_ALPHA,[OneMinusDstColorFactor]:e.ONE_MINUS_DST_COLOR,[OneMinusDstAlphaFactor]:e.ONE_MINUS_DST_ALPHA,[ConstantColorFactor]:e.CONSTANT_COLOR,[OneMinusConstantColorFactor]:e.ONE_MINUS_CONSTANT_COLOR,[ConstantAlphaFactor]:e.CONSTANT_ALPHA,[OneMinusConstantAlphaFactor]:e.ONE_MINUS_CONSTANT_ALPHA};function H(t,i,n,r,o,s,a,l,c,u){if(t!==NoBlending){if(!1===d&&(z(e.BLEND),d=!0),t===CustomBlending)o=o||i,s=s||n,a=a||r,i===f&&o===_||(e.blendEquationSeparate(G[i],G[o]),f=i,_=o),n===m&&r===g&&s===y&&a===v||(e.blendFuncSeparate(j[n],j[r],j[s],j[a]),m=n,g=r,y=s,v=a),!1!==l.equals(x)&&c===b||(e.blendColor(l.r,l.g,l.b,c),x.copy(l),b=c),p=t,T=!1;else if(t!==p||u!==T){if(f===AddEquation&&_===AddEquation||(e.blendEquation(e.FUNC_ADD),f=AddEquation,_=AddEquation),u)switch(t){case NormalBlending:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case AdditiveBlending:e.blendFunc(e.ONE,e.ONE);break;case SubtractiveBlending:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case MultiplyBlending:e.blendFuncSeparate(e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE);break;default:error("WebGLState: Invalid blending: ",t)}else switch(t){case NormalBlending:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case AdditiveBlending:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE,e.ONE,e.ONE);break;case SubtractiveBlending:error("WebGLState: SubtractiveBlending requires material.premultipliedAlpha = true");break;case MultiplyBlending:error("WebGLState: MultiplyBlending requires material.premultipliedAlpha = true");break;default:error("WebGLState: Invalid blending: ",t)}m=null,g=null,y=null,v=null,x.set(0,0,0),b=0,p=t,T=u}}else!0===d&&(V(e.BLEND),d=!1)}function $(t){w!==t&&(e.frontFace(t?e.CW:e.CCW),w=t)}function W(t){t!==CullFaceNone?(z(e.CULL_FACE),t!==E&&e.cullFace(t===CullFaceBack?e.BACK:t===CullFaceFront?e.FRONT:e.FRONT_AND_BACK)):V(e.CULL_FACE),E=t}function q(t,i,n){t?(z(e.POLYGON_OFFSET_FILL),A===i&&M===n||(e.polygonOffset(i,n),A=i,M=n)):V(e.POLYGON_OFFSET_FILL)}return{buffers:{color:i,depth:n,stencil:r},enable:z,disable:V,bindFramebuffer:function(t,i){return l[t]!==i&&(e.bindFramebuffer(t,i),l[t]=i,t===e.DRAW_FRAMEBUFFER&&(l[e.FRAMEBUFFER]=i),t===e.FRAMEBUFFER&&(l[e.DRAW_FRAMEBUFFER]=i),!0)},drawBuffers:function(t,i){let n=u,r=!1;if(t){n=c.get(i),void 0===n&&(n=[],c.set(i,n));const o=t.textures;if(n.length!==o.length||n[0]!==e.COLOR_ATTACHMENT0){for(let t=0,i=o.length;t<i;t++)n[t]=e.COLOR_ATTACHMENT0+t;n.length=o.length,r=!0}}else n[0]!==e.BACK&&(n[0]=e.BACK,r=!0);r&&e.drawBuffers(n)},useProgram:function(t){return h!==t&&(e.useProgram(t),h=t,!0)},setBlending:H,setMaterial:function(t,o){t.side===DoubleSide?V(e.CULL_FACE):z(e.CULL_FACE);let s=t.side===BackSide;o&&(s=!s),$(s),t.blending===NormalBlending&&!1===t.transparent?H(NoBlending):H(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),n.setFunc(t.depthFunc),n.setTest(t.depthTest),n.setMask(t.depthWrite),i.setMask(t.colorWrite);const a=t.stencilWrite;r.setTest(a),a&&(r.setMask(t.stencilWriteMask),r.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),r.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),q(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?z(e.SAMPLE_ALPHA_TO_COVERAGE):V(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:$,setCullFace:W,setLineWidth:function(t){t!==S&&(C&&e.lineWidth(t),S=t)},setPolygonOffset:q,setScissorTest:function(t){t?z(e.SCISSOR_TEST):V(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+I-1),R!==t&&(e.activeTexture(t),R=t)},bindTexture:function(t,i,n){void 0===n&&(n=null===R?e.TEXTURE0+I-1:R);let r=O[n];void 0===r&&(r={type:void 0,texture:void 0},O[n]=r),r.type===t&&r.texture===i||(R!==n&&(e.activeTexture(n),R=n),e.bindTexture(t,i||U[t]),r.type=t,r.texture=i)},unbindTexture:function(){const t=O[R];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D(...arguments)}catch(e){error("WebGLState:",e)}},compressedTexImage3D:function(){try{e.compressedTexImage3D(...arguments)}catch(e){error("WebGLState:",e)}},texImage2D:function(){try{e.texImage2D(...arguments)}catch(e){error("WebGLState:",e)}},texImage3D:function(){try{e.texImage3D(...arguments)}catch(e){error("WebGLState:",e)}},updateUBOMapping:function(t,i){let n=s.get(i);void 0===n&&(n=new WeakMap,s.set(i,n));let r=n.get(t);void 0===r&&(r=e.getUniformBlockIndex(i,t.name),n.set(t,r))},uniformBlockBinding:function(t,i){const n=s.get(i).get(t);o.get(i)!==n&&(e.uniformBlockBinding(i,n,t.__bindingPointIndex),o.set(i,n))},texStorage2D:function(){try{e.texStorage2D(...arguments)}catch(e){error("WebGLState:",e)}},texStorage3D:function(){try{e.texStorage3D(...arguments)}catch(e){error("WebGLState:",e)}},texSubImage2D:function(){try{e.texSubImage2D(...arguments)}catch(e){error("WebGLState:",e)}},texSubImage3D:function(){try{e.texSubImage3D(...arguments)}catch(e){error("WebGLState:",e)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D(...arguments)}catch(e){error("WebGLState:",e)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D(...arguments)}catch(e){error("WebGLState:",e)}},scissor:function(t){!1===F.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),F.copy(t))},viewport:function(t){!1===N.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),N.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),n.setReversed(!1),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),a={},R=null,O={},l={},c=new WeakMap,u=[],h=null,d=!1,p=null,f=null,m=null,g=null,_=null,y=null,v=null,x=new Color(0,0,0),b=0,T=!1,w=null,E=null,S=null,A=null,M=null,F.set(0,0,e.canvas.width,e.canvas.height),N.set(0,0,e.canvas.width,e.canvas.height),i.reset(),n.reset(),r.reset()}}}function WebGLTextures(e,t,i,n,r,o,s){const a=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),c=new Vector2,u=new WeakMap;let h;const d=new WeakMap;let p=!1;try{p="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function f(e,t){return p?new OffscreenCanvas(e,t):createElementNS("canvas")}function m(e,t,i){let n=1;const r=j(e);if((r.width>i||r.height>i)&&(n=i/Math.max(r.width,r.height)),n<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const i=Math.floor(n*r.width),o=Math.floor(n*r.height);void 0===h&&(h=f(i,o));const s=t?f(i,o):h;s.width=i,s.height=o;return s.getContext("2d").drawImage(e,0,0,i,o),warn("WebGLRenderer: Texture has been resized from ("+r.width+"x"+r.height+") to ("+i+"x"+o+")."),s}return"data"in e&&warn("WebGLRenderer: Image in DataTexture is too big ("+r.width+"x"+r.height+")."),e}return e}function g(e){return e.generateMipmaps}function _(t){e.generateMipmap(t)}function y(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function v(i,n,r,o,s=!1){if(null!==i){if(void 0!==e[i])return e[i];warn("WebGLRenderer: Attempt to use non-existing WebGL internal format '"+i+"'")}let a=n;if(n===e.RED&&(r===e.FLOAT&&(a=e.R32F),r===e.HALF_FLOAT&&(a=e.R16F),r===e.UNSIGNED_BYTE&&(a=e.R8)),n===e.RED_INTEGER&&(r===e.UNSIGNED_BYTE&&(a=e.R8UI),r===e.UNSIGNED_SHORT&&(a=e.R16UI),r===e.UNSIGNED_INT&&(a=e.R32UI),r===e.BYTE&&(a=e.R8I),r===e.SHORT&&(a=e.R16I),r===e.INT&&(a=e.R32I)),n===e.RG&&(r===e.FLOAT&&(a=e.RG32F),r===e.HALF_FLOAT&&(a=e.RG16F),r===e.UNSIGNED_BYTE&&(a=e.RG8)),n===e.RG_INTEGER&&(r===e.UNSIGNED_BYTE&&(a=e.RG8UI),r===e.UNSIGNED_SHORT&&(a=e.RG16UI),r===e.UNSIGNED_INT&&(a=e.RG32UI),r===e.BYTE&&(a=e.RG8I),r===e.SHORT&&(a=e.RG16I),r===e.INT&&(a=e.RG32I)),n===e.RGB_INTEGER&&(r===e.UNSIGNED_BYTE&&(a=e.RGB8UI),r===e.UNSIGNED_SHORT&&(a=e.RGB16UI),r===e.UNSIGNED_INT&&(a=e.RGB32UI),r===e.BYTE&&(a=e.RGB8I),r===e.SHORT&&(a=e.RGB16I),r===e.INT&&(a=e.RGB32I)),n===e.RGBA_INTEGER&&(r===e.UNSIGNED_BYTE&&(a=e.RGBA8UI),r===e.UNSIGNED_SHORT&&(a=e.RGBA16UI),r===e.UNSIGNED_INT&&(a=e.RGBA32UI),r===e.BYTE&&(a=e.RGBA8I),r===e.SHORT&&(a=e.RGBA16I),r===e.INT&&(a=e.RGBA32I)),n===e.RGB&&(r===e.UNSIGNED_INT_5_9_9_9_REV&&(a=e.RGB9_E5),r===e.UNSIGNED_INT_10F_11F_11F_REV&&(a=e.R11F_G11F_B10F)),n===e.RGBA){const t=s?LinearTransfer:ColorManagement.getTransfer(o);r===e.FLOAT&&(a=e.RGBA32F),r===e.HALF_FLOAT&&(a=e.RGBA16F),r===e.UNSIGNED_BYTE&&(a=t===SRGBTransfer?e.SRGB8_ALPHA8:e.RGBA8),r===e.UNSIGNED_SHORT_4_4_4_4&&(a=e.RGBA4),r===e.UNSIGNED_SHORT_5_5_5_1&&(a=e.RGB5_A1)}return a!==e.R16F&&a!==e.R32F&&a!==e.RG16F&&a!==e.RG32F&&a!==e.RGBA16F&&a!==e.RGBA32F||t.get("EXT_color_buffer_float"),a}function x(t,i){let n;return t?null===i||i===UnsignedIntType||i===UnsignedInt248Type?n=e.DEPTH24_STENCIL8:i===FloatType?n=e.DEPTH32F_STENCIL8:i===UnsignedShortType&&(n=e.DEPTH24_STENCIL8,warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===i||i===UnsignedIntType||i===UnsignedInt248Type?n=e.DEPTH_COMPONENT24:i===FloatType?n=e.DEPTH_COMPONENT32F:i===UnsignedShortType&&(n=e.DEPTH_COMPONENT16),n}function b(e,t){return!0===g(e)||e.isFramebufferTexture&&e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function T(e){const t=e.target;t.removeEventListener("dispose",T),function(e){const t=n.get(e);if(void 0===t.__webglInit)return;const i=e.source,r=d.get(i);if(r){const n=r[t.__cacheKey];n.usedTimes--,0===n.usedTimes&&E(e),0===Object.keys(r).length&&d.delete(i)}n.remove(e)}(t),t.isVideoTexture&&u.delete(t)}function w(t){const i=t.target;i.removeEventListener("dispose",w),function(t){const i=n.get(t);t.depthTexture&&(t.depthTexture.dispose(),n.remove(t.depthTexture));if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(i.__webglFramebuffer[t]))for(let n=0;n<i.__webglFramebuffer[t].length;n++)e.deleteFramebuffer(i.__webglFramebuffer[t][n]);else e.deleteFramebuffer(i.__webglFramebuffer[t]);i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer[t])}else{if(Array.isArray(i.__webglFramebuffer))for(let t=0;t<i.__webglFramebuffer.length;t++)e.deleteFramebuffer(i.__webglFramebuffer[t]);else e.deleteFramebuffer(i.__webglFramebuffer);if(i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&e.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer)for(let t=0;t<i.__webglColorRenderbuffer.length;t++)i.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(i.__webglColorRenderbuffer[t]);i.__webglDepthRenderbuffer&&e.deleteRenderbuffer(i.__webglDepthRenderbuffer)}const r=t.textures;for(let t=0,i=r.length;t<i;t++){const i=n.get(r[t]);i.__webglTexture&&(e.deleteTexture(i.__webglTexture),s.memory.textures--),n.remove(r[t])}n.remove(t)}(i)}function E(t){const i=n.get(t);e.deleteTexture(i.__webglTexture);delete d.get(t.source)[i.__cacheKey],s.memory.textures--}let S=0;function A(t,r){const o=n.get(t);if(t.isVideoTexture&&function(e){const t=s.render.frame;u.get(e)!==t&&(u.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&!0!==t.isExternalTexture&&t.version>0&&o.__version!==t.version){const e=t.image;if(null===e)warn("WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void O(o,t,r);warn("WebGLRenderer: Texture marked for update but image is incomplete")}}else t.isExternalTexture&&(o.__webglTexture=t.sourceTexture?t.sourceTexture:null);i.bindTexture(e.TEXTURE_2D,o.__webglTexture,e.TEXTURE0+r)}const M={[RepeatWrapping]:e.REPEAT,[ClampToEdgeWrapping]:e.CLAMP_TO_EDGE,[MirroredRepeatWrapping]:e.MIRRORED_REPEAT},I={[NearestFilter]:e.NEAREST,[NearestMipmapNearestFilter]:e.NEAREST_MIPMAP_NEAREST,[NearestMipmapLinearFilter]:e.NEAREST_MIPMAP_LINEAR,[LinearFilter]:e.LINEAR,[LinearMipmapNearestFilter]:e.LINEAR_MIPMAP_NEAREST,[LinearMipmapLinearFilter]:e.LINEAR_MIPMAP_LINEAR},C={[NeverCompare]:e.NEVER,[AlwaysCompare]:e.ALWAYS,[LessCompare]:e.LESS,[LessEqualCompare]:e.LEQUAL,[EqualCompare]:e.EQUAL,[GreaterEqualCompare]:e.GEQUAL,[GreaterCompare]:e.GREATER,[NotEqualCompare]:e.NOTEQUAL};function P(i,o){if(o.type!==FloatType||!1!==t.has("OES_texture_float_linear")||o.magFilter!==LinearFilter&&o.magFilter!==LinearMipmapNearestFilter&&o.magFilter!==NearestMipmapLinearFilter&&o.magFilter!==LinearMipmapLinearFilter&&o.minFilter!==LinearFilter&&o.minFilter!==LinearMipmapNearestFilter&&o.minFilter!==NearestMipmapLinearFilter&&o.minFilter!==LinearMipmapLinearFilter||warn("WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(i,e.TEXTURE_WRAP_S,M[o.wrapS]),e.texParameteri(i,e.TEXTURE_WRAP_T,M[o.wrapT]),i!==e.TEXTURE_3D&&i!==e.TEXTURE_2D_ARRAY||e.texParameteri(i,e.TEXTURE_WRAP_R,M[o.wrapR]),e.texParameteri(i,e.TEXTURE_MAG_FILTER,I[o.magFilter]),e.texParameteri(i,e.TEXTURE_MIN_FILTER,I[o.minFilter]),o.compareFunction&&(e.texParameteri(i,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,C[o.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(o.magFilter===NearestFilter)return;if(o.minFilter!==NearestMipmapLinearFilter&&o.minFilter!==LinearMipmapLinearFilter)return;if(o.type===FloatType&&!1===t.has("OES_texture_float_linear"))return;if(o.anisotropy>1||n.get(o).__currentAnisotropy){const s=t.get("EXT_texture_filter_anisotropic");e.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,r.getMaxAnisotropy())),n.get(o).__currentAnisotropy=o.anisotropy}}}function L(t,i){let n=!1;void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",T));const r=i.source;let o=d.get(r);void 0===o&&(o={},d.set(r,o));const a=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(i);if(a!==t.__cacheKey){void 0===o[a]&&(o[a]={texture:e.createTexture(),usedTimes:0},s.memory.textures++,n=!0),o[a].usedTimes++;const r=o[t.__cacheKey];void 0!==r&&(o[t.__cacheKey].usedTimes--,0===r.usedTimes&&E(i)),t.__cacheKey=a,t.__webglTexture=o[a].texture}return n}function R(e,t,i){return Math.floor(Math.floor(e/i)/t)}function O(t,s,a){let l=e.TEXTURE_2D;(s.isDataArrayTexture||s.isCompressedArrayTexture)&&(l=e.TEXTURE_2D_ARRAY),s.isData3DTexture&&(l=e.TEXTURE_3D);const c=L(t,s),u=s.source;i.bindTexture(l,t.__webglTexture,e.TEXTURE0+a);const h=n.get(u);if(u.version!==h.__version||!0===c){i.activeTexture(e.TEXTURE0+a);const t=ColorManagement.getPrimaries(ColorManagement.workingColorSpace),n=s.colorSpace===NoColorSpace?null:ColorManagement.getPrimaries(s.colorSpace),d=s.colorSpace===NoColorSpace||t===n?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,s.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,d);let p=m(s.image,!1,r.maxTextureSize);p=G(s,p);const f=o.convert(s.format,s.colorSpace),y=o.convert(s.type);let T,w=v(s.internalFormat,f,y,s.colorSpace,s.isVideoTexture);P(l,s);const E=s.mipmaps,S=!0!==s.isVideoTexture,A=void 0===h.__version||!0===c,M=u.dataReady,I=b(s,p);if(s.isDepthTexture)w=x(s.format===DepthStencilFormat,s.type),A&&(S?i.texStorage2D(e.TEXTURE_2D,1,w,p.width,p.height):i.texImage2D(e.TEXTURE_2D,0,w,p.width,p.height,0,f,y,null));else if(s.isDataTexture)if(E.length>0){S&&A&&i.texStorage2D(e.TEXTURE_2D,I,w,E[0].width,E[0].height);for(let t=0,n=E.length;t<n;t++)T=E[t],S?M&&i.texSubImage2D(e.TEXTURE_2D,t,0,0,T.width,T.height,f,y,T.data):i.texImage2D(e.TEXTURE_2D,t,w,T.width,T.height,0,f,y,T.data);s.generateMipmaps=!1}else S?(A&&i.texStorage2D(e.TEXTURE_2D,I,w,p.width,p.height),M&&function(t,n,r,o){const s=t.updateRanges;if(0===s.length)i.texSubImage2D(e.TEXTURE_2D,0,0,0,n.width,n.height,r,o,n.data);else{s.sort(((e,t)=>e.start-t.start));let a=0;for(let e=1;e<s.length;e++){const t=s[a],i=s[e],r=t.start+t.count,o=R(i.start,n.width,4),l=R(t.start,n.width,4);i.start<=r+1&&o===l&&R(i.start+i.count-1,n.width,4)===o?t.count=Math.max(t.count,i.start+i.count-t.start):(++a,s[a]=i)}s.length=a+1;const l=e.getParameter(e.UNPACK_ROW_LENGTH),c=e.getParameter(e.UNPACK_SKIP_PIXELS),u=e.getParameter(e.UNPACK_SKIP_ROWS);e.pixelStorei(e.UNPACK_ROW_LENGTH,n.width);for(let t=0,a=s.length;t<a;t++){const a=s[t],l=Math.floor(a.start/4),c=Math.ceil(a.count/4),u=l%n.width,h=Math.floor(l/n.width),d=c,p=1;e.pixelStorei(e.UNPACK_SKIP_PIXELS,u),e.pixelStorei(e.UNPACK_SKIP_ROWS,h),i.texSubImage2D(e.TEXTURE_2D,0,u,h,d,p,r,o,n.data)}t.clearUpdateRanges(),e.pixelStorei(e.UNPACK_ROW_LENGTH,l),e.pixelStorei(e.UNPACK_SKIP_PIXELS,c),e.pixelStorei(e.UNPACK_SKIP_ROWS,u)}}(s,p,f,y)):i.texImage2D(e.TEXTURE_2D,0,w,p.width,p.height,0,f,y,p.data);else if(s.isCompressedTexture)if(s.isCompressedArrayTexture){S&&A&&i.texStorage3D(e.TEXTURE_2D_ARRAY,I,w,E[0].width,E[0].height,p.depth);for(let t=0,n=E.length;t<n;t++)if(T=E[t],s.format!==RGBAFormat)if(null!==f)if(S){if(M)if(s.layerUpdates.size>0){const n=getByteLength(T.width,T.height,s.format,s.type);for(const r of s.layerUpdates){const o=T.data.subarray(r*n/T.data.BYTES_PER_ELEMENT,(r+1)*n/T.data.BYTES_PER_ELEMENT);i.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,r,T.width,T.height,1,f,o)}s.clearLayerUpdates()}else i.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,T.width,T.height,p.depth,f,T.data)}else i.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,w,T.width,T.height,p.depth,0,T.data,0,0);else warn("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else S?M&&i.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,T.width,T.height,p.depth,f,y,T.data):i.texImage3D(e.TEXTURE_2D_ARRAY,t,w,T.width,T.height,p.depth,0,f,y,T.data)}else{S&&A&&i.texStorage2D(e.TEXTURE_2D,I,w,E[0].width,E[0].height);for(let t=0,n=E.length;t<n;t++)T=E[t],s.format!==RGBAFormat?null!==f?S?M&&i.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,T.width,T.height,f,T.data):i.compressedTexImage2D(e.TEXTURE_2D,t,w,T.width,T.height,0,T.data):warn("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):S?M&&i.texSubImage2D(e.TEXTURE_2D,t,0,0,T.width,T.height,f,y,T.data):i.texImage2D(e.TEXTURE_2D,t,w,T.width,T.height,0,f,y,T.data)}else if(s.isDataArrayTexture)if(S){if(A&&i.texStorage3D(e.TEXTURE_2D_ARRAY,I,w,p.width,p.height,p.depth),M)if(s.layerUpdates.size>0){const t=getByteLength(p.width,p.height,s.format,s.type);for(const n of s.layerUpdates){const r=p.data.subarray(n*t/p.data.BYTES_PER_ELEMENT,(n+1)*t/p.data.BYTES_PER_ELEMENT);i.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,n,p.width,p.height,1,f,y,r)}s.clearLayerUpdates()}else i.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,p.width,p.height,p.depth,f,y,p.data)}else i.texImage3D(e.TEXTURE_2D_ARRAY,0,w,p.width,p.height,p.depth,0,f,y,p.data);else if(s.isData3DTexture)S?(A&&i.texStorage3D(e.TEXTURE_3D,I,w,p.width,p.height,p.depth),M&&i.texSubImage3D(e.TEXTURE_3D,0,0,0,0,p.width,p.height,p.depth,f,y,p.data)):i.texImage3D(e.TEXTURE_3D,0,w,p.width,p.height,p.depth,0,f,y,p.data);else if(s.isFramebufferTexture){if(A)if(S)i.texStorage2D(e.TEXTURE_2D,I,w,p.width,p.height);else{let t=p.width,n=p.height;for(let r=0;r<I;r++)i.texImage2D(e.TEXTURE_2D,r,w,t,n,0,f,y,null),t>>=1,n>>=1}}else if(E.length>0){if(S&&A){const t=j(E[0]);i.texStorage2D(e.TEXTURE_2D,I,w,t.width,t.height)}for(let t=0,n=E.length;t<n;t++)T=E[t],S?M&&i.texSubImage2D(e.TEXTURE_2D,t,0,0,f,y,T):i.texImage2D(e.TEXTURE_2D,t,w,f,y,T);s.generateMipmaps=!1}else if(S){if(A){const t=j(p);i.texStorage2D(e.TEXTURE_2D,I,w,t.width,t.height)}M&&i.texSubImage2D(e.TEXTURE_2D,0,0,0,f,y,p)}else i.texImage2D(e.TEXTURE_2D,0,w,f,y,p);g(s)&&_(l),h.__version=u.version,s.onUpdate&&s.onUpdate(s)}t.__version=s.version}function D(t,r,s,l,c,u){const h=o.convert(s.format,s.colorSpace),d=o.convert(s.type),p=v(s.internalFormat,h,d,s.colorSpace),f=n.get(r),m=n.get(s);if(m.__renderTarget=r,!f.__hasExternalTextures){const t=Math.max(1,r.width>>u),n=Math.max(1,r.height>>u);c===e.TEXTURE_3D||c===e.TEXTURE_2D_ARRAY?i.texImage3D(c,u,p,t,n,r.depth,0,h,d,null):i.texImage2D(c,u,p,t,n,0,h,d,null)}i.bindFramebuffer(e.FRAMEBUFFER,t),V(r)?a.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,c,m.__webglTexture,0,z(r)):(c===e.TEXTURE_2D||c>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,c,m.__webglTexture,u),i.bindFramebuffer(e.FRAMEBUFFER,null)}function B(t,i,n){if(e.bindRenderbuffer(e.RENDERBUFFER,t),i.depthBuffer){const r=i.depthTexture,o=x(i.stencilBuffer,r&&r.isDepthTexture?r.type:null),s=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;V(i)?a.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,z(i),o,i.width,i.height):n?e.renderbufferStorageMultisample(e.RENDERBUFFER,z(i),o,i.width,i.height):e.renderbufferStorage(e.RENDERBUFFER,o,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,s,e.RENDERBUFFER,t)}else{const t=i.textures;for(let r=0;r<t.length;r++){const s=t[r],l=o.convert(s.format,s.colorSpace),c=o.convert(s.type),u=v(s.internalFormat,l,c,s.colorSpace);V(i)?a.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,z(i),u,i.width,i.height):n?e.renderbufferStorageMultisample(e.RENDERBUFFER,z(i),u,i.width,i.height):e.renderbufferStorage(e.RENDERBUFFER,u,i.width,i.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function F(t,r,s){const l=!0===r.isWebGLCubeRenderTarget;if(i.bindFramebuffer(e.FRAMEBUFFER,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const c=n.get(r.depthTexture);if(c.__renderTarget=r,c.__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),l){if(void 0===c.__webglInit&&(c.__webglInit=!0,r.depthTexture.addEventListener("dispose",T)),void 0===c.__webglTexture){c.__webglTexture=e.createTexture(),i.bindTexture(e.TEXTURE_CUBE_MAP,c.__webglTexture),P(e.TEXTURE_CUBE_MAP,r.depthTexture);const t=o.convert(r.depthTexture.format),n=o.convert(r.depthTexture.type);let s;r.depthTexture.format===DepthFormat?s=e.DEPTH_COMPONENT24:r.depthTexture.format===DepthStencilFormat&&(s=e.DEPTH24_STENCIL8);for(let i=0;i<6;i++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,s,r.width,r.height,0,t,n,null)}}else A(r.depthTexture,0);const u=c.__webglTexture,h=z(r),d=l?e.TEXTURE_CUBE_MAP_POSITIVE_X+s:e.TEXTURE_2D,p=r.depthTexture.format===DepthStencilFormat?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;if(r.depthTexture.format===DepthFormat)V(r)?a.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,p,d,u,0,h):e.framebufferTexture2D(e.FRAMEBUFFER,p,d,u,0);else{if(r.depthTexture.format!==DepthStencilFormat)throw new Error("Unknown depthTexture format");V(r)?a.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,p,d,u,0,h):e.framebufferTexture2D(e.FRAMEBUFFER,p,d,u,0)}}function N(t){const r=n.get(t),o=!0===t.isWebGLCubeRenderTarget;if(r.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(r.__depthDisposeCallback&&r.__depthDisposeCallback(),e){const t=()=>{delete r.__boundDepthTexture,delete r.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),r.__depthDisposeCallback=t}r.__boundDepthTexture=e}if(t.depthTexture&&!r.__autoAllocateDepthBuffer)if(o)for(let e=0;e<6;e++)F(r.__webglFramebuffer[e],t,e);else{const e=t.texture.mipmaps;F(e&&e.length>0?r.__webglFramebuffer[0]:r.__webglFramebuffer,t,0)}else if(o){r.__webglDepthbuffer=[];for(let n=0;n<6;n++)if(i.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer[n]),void 0===r.__webglDepthbuffer[n])r.__webglDepthbuffer[n]=e.createRenderbuffer(),B(r.__webglDepthbuffer[n],t,!1);else{const i=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,o=r.__webglDepthbuffer[n];e.bindRenderbuffer(e.RENDERBUFFER,o),e.framebufferRenderbuffer(e.FRAMEBUFFER,i,e.RENDERBUFFER,o)}}else{const n=t.texture.mipmaps;if(i.bindFramebuffer(e.FRAMEBUFFER,n&&n.length>0?r.__webglFramebuffer[0]:r.__webglFramebuffer),void 0===r.__webglDepthbuffer)r.__webglDepthbuffer=e.createRenderbuffer(),B(r.__webglDepthbuffer,t,!1);else{const i=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,n=r.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,n),e.framebufferRenderbuffer(e.FRAMEBUFFER,i,e.RENDERBUFFER,n)}}i.bindFramebuffer(e.FRAMEBUFFER,null)}const k=[],U=[];function z(e){return Math.min(r.maxSamples,e.samples)}function V(e){const i=n.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==i.__useRenderToTexture}function G(e,t){const i=e.colorSpace,n=e.format,r=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||i!==LinearSRGBColorSpace&&i!==NoColorSpace&&(ColorManagement.getTransfer(i)===SRGBTransfer?n===RGBAFormat&&r===UnsignedByteType||warn("WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):error("WebGLTextures: Unsupported texture color space:",i)),t}function j(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(c.width=e.naturalWidth||e.width,c.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(c.width=e.displayWidth,c.height=e.displayHeight):(c.width=e.width,c.height=e.height),c}this.allocateTextureUnit=function(){const e=S;return e>=r.maxTextures&&warn("WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+r.maxTextures),S+=1,e},this.resetTextureUnits=function(){S=0},this.setTexture2D=A,this.setTexture2DArray=function(t,r){const o=n.get(t);!1===t.isRenderTargetTexture&&t.version>0&&o.__version!==t.version?O(o,t,r):(t.isExternalTexture&&(o.__webglTexture=t.sourceTexture?t.sourceTexture:null),i.bindTexture(e.TEXTURE_2D_ARRAY,o.__webglTexture,e.TEXTURE0+r))},this.setTexture3D=function(t,r){const o=n.get(t);!1===t.isRenderTargetTexture&&t.version>0&&o.__version!==t.version?O(o,t,r):i.bindTexture(e.TEXTURE_3D,o.__webglTexture,e.TEXTURE0+r)},this.setTextureCube=function(t,s){const a=n.get(t);!0!==t.isCubeDepthTexture&&t.version>0&&a.__version!==t.version?function(t,s,a){if(6!==s.image.length)return;const l=L(t,s),c=s.source;i.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+a);const u=n.get(c);if(c.version!==u.__version||!0===l){i.activeTexture(e.TEXTURE0+a);const t=ColorManagement.getPrimaries(ColorManagement.workingColorSpace),n=s.colorSpace===NoColorSpace?null:ColorManagement.getPrimaries(s.colorSpace),h=s.colorSpace===NoColorSpace||t===n?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,s.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,h);const d=s.isCompressedTexture||s.image[0].isCompressedTexture,p=s.image[0]&&s.image[0].isDataTexture,f=[];for(let e=0;e<6;e++)f[e]=d||p?p?s.image[e].image:s.image[e]:m(s.image[e],!0,r.maxCubemapSize),f[e]=G(s,f[e]);const y=f[0],x=o.convert(s.format,s.colorSpace),T=o.convert(s.type),w=v(s.internalFormat,x,T,s.colorSpace),E=!0!==s.isVideoTexture,S=void 0===u.__version||!0===l,A=c.dataReady;let M,I=b(s,y);if(P(e.TEXTURE_CUBE_MAP,s),d){E&&S&&i.texStorage2D(e.TEXTURE_CUBE_MAP,I,w,y.width,y.height);for(let t=0;t<6;t++){M=f[t].mipmaps;for(let n=0;n<M.length;n++){const r=M[n];s.format!==RGBAFormat?null!==x?E?A&&i.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,0,0,r.width,r.height,x,r.data):i.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,w,r.width,r.height,0,r.data):warn("WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):E?A&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,0,0,r.width,r.height,x,T,r.data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,w,r.width,r.height,0,x,T,r.data)}}}else{if(M=s.mipmaps,E&&S){M.length>0&&I++;const t=j(f[0]);i.texStorage2D(e.TEXTURE_CUBE_MAP,I,w,t.width,t.height)}for(let t=0;t<6;t++)if(p){E?A&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,f[t].width,f[t].height,x,T,f[t].data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,w,f[t].width,f[t].height,0,x,T,f[t].data);for(let n=0;n<M.length;n++){const r=M[n].image[t].image;E?A&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,0,0,r.width,r.height,x,T,r.data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,w,r.width,r.height,0,x,T,r.data)}}else{E?A&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,x,T,f[t]):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,w,x,T,f[t]);for(let n=0;n<M.length;n++){const r=M[n];E?A&&i.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,0,0,x,T,r.image[t]):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,n+1,w,x,T,r.image[t])}}}g(s)&&_(e.TEXTURE_CUBE_MAP),u.__version=c.version,s.onUpdate&&s.onUpdate(s)}t.__version=s.version}(a,t,s):i.bindTexture(e.TEXTURE_CUBE_MAP,a.__webglTexture,e.TEXTURE0+s)},this.rebindTextures=function(t,i,r){const o=n.get(t);void 0!==i&&D(o.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==r&&N(t)},this.setupRenderTarget=function(t){const r=t.texture,a=n.get(t),l=n.get(r);t.addEventListener("dispose",w);const c=t.textures,u=!0===t.isWebGLCubeRenderTarget,h=c.length>1;if(h||(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=r.version,s.memory.textures++),u){a.__webglFramebuffer=[];for(let t=0;t<6;t++)if(r.mipmaps&&r.mipmaps.length>0){a.__webglFramebuffer[t]=[];for(let i=0;i<r.mipmaps.length;i++)a.__webglFramebuffer[t][i]=e.createFramebuffer()}else a.__webglFramebuffer[t]=e.createFramebuffer()}else{if(r.mipmaps&&r.mipmaps.length>0){a.__webglFramebuffer=[];for(let t=0;t<r.mipmaps.length;t++)a.__webglFramebuffer[t]=e.createFramebuffer()}else a.__webglFramebuffer=e.createFramebuffer();if(h)for(let t=0,i=c.length;t<i;t++){const i=n.get(c[t]);void 0===i.__webglTexture&&(i.__webglTexture=e.createTexture(),s.memory.textures++)}if(t.samples>0&&!1===V(t)){a.__webglMultisampledFramebuffer=e.createFramebuffer(),a.__webglColorRenderbuffer=[],i.bindFramebuffer(e.FRAMEBUFFER,a.__webglMultisampledFramebuffer);for(let i=0;i<c.length;i++){const n=c[i];a.__webglColorRenderbuffer[i]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,a.__webglColorRenderbuffer[i]);const r=o.convert(n.format,n.colorSpace),s=o.convert(n.type),l=v(n.internalFormat,r,s,n.colorSpace,!0===t.isXRRenderTarget),u=z(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,u,l,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.RENDERBUFFER,a.__webglColorRenderbuffer[i])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(a.__webglDepthRenderbuffer=e.createRenderbuffer(),B(a.__webglDepthRenderbuffer,t,!0)),i.bindFramebuffer(e.FRAMEBUFFER,null)}}if(u){i.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),P(e.TEXTURE_CUBE_MAP,r);for(let i=0;i<6;i++)if(r.mipmaps&&r.mipmaps.length>0)for(let n=0;n<r.mipmaps.length;n++)D(a.__webglFramebuffer[i][n],t,r,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+i,n);else D(a.__webglFramebuffer[i],t,r,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+i,0);g(r)&&_(e.TEXTURE_CUBE_MAP),i.unbindTexture()}else if(h){for(let r=0,o=c.length;r<o;r++){const o=c[r],s=n.get(o);let l=e.TEXTURE_2D;(t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(l=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),i.bindTexture(l,s.__webglTexture),P(l,o),D(a.__webglFramebuffer,t,o,e.COLOR_ATTACHMENT0+r,l,0),g(o)&&_(l)}i.unbindTexture()}else{let n=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(n=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),i.bindTexture(n,l.__webglTexture),P(n,r),r.mipmaps&&r.mipmaps.length>0)for(let i=0;i<r.mipmaps.length;i++)D(a.__webglFramebuffer[i],t,r,e.COLOR_ATTACHMENT0,n,i);else D(a.__webglFramebuffer,t,r,e.COLOR_ATTACHMENT0,n,0);g(r)&&_(n),i.unbindTexture()}t.depthBuffer&&N(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let r=0,o=t.length;r<o;r++){const o=t[r];if(g(o)){const t=y(e),r=n.get(o).__webglTexture;i.bindTexture(t,r),_(t),i.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===V(t)){const r=t.textures,o=t.width,s=t.height;let a=e.COLOR_BUFFER_BIT;const c=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,u=n.get(t),h=r.length>1;if(h)for(let t=0;t<r.length;t++)i.bindFramebuffer(e.FRAMEBUFFER,u.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),i.bindFramebuffer(e.FRAMEBUFFER,u.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);i.bindFramebuffer(e.READ_FRAMEBUFFER,u.__webglMultisampledFramebuffer);const d=t.texture.mipmaps;i.bindFramebuffer(e.DRAW_FRAMEBUFFER,d&&d.length>0?u.__webglFramebuffer[0]:u.__webglFramebuffer);for(let i=0;i<r.length;i++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(a|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(a|=e.STENCIL_BUFFER_BIT)),h){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,u.__webglColorRenderbuffer[i]);const t=n.get(r[i]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,o,s,0,0,o,s,a,e.NEAREST),!0===l&&(k.length=0,U.length=0,k.push(e.COLOR_ATTACHMENT0+i),t.depthBuffer&&!1===t.resolveDepthBuffer&&(k.push(c),U.push(c),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,U)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,k))}if(i.bindFramebuffer(e.READ_FRAMEBUFFER,null),i.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),h)for(let t=0;t<r.length;t++){i.bindFramebuffer(e.FRAMEBUFFER,u.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,u.__webglColorRenderbuffer[t]);const o=n.get(r[t]).__webglTexture;i.bindFramebuffer(e.FRAMEBUFFER,u.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,o,0)}i.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&l){e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT])}},this.setupDepthRenderbuffer=N,this.setupFrameBufferTexture=D,this.useMultisampledRTT=V,this.isReversedDepthBuffer=function(){return i.buffers.depth.getReversed()}}function WebGLUtils(e,t){return{convert:function(i,n=NoColorSpace){let r;const o=ColorManagement.getTransfer(n);if(i===UnsignedByteType)return e.UNSIGNED_BYTE;if(i===UnsignedShort4444Type)return e.UNSIGNED_SHORT_4_4_4_4;if(i===UnsignedShort5551Type)return e.UNSIGNED_SHORT_5_5_5_1;if(i===UnsignedInt5999Type)return e.UNSIGNED_INT_5_9_9_9_REV;if(i===UnsignedInt101111Type)return e.UNSIGNED_INT_10F_11F_11F_REV;if(i===ByteType)return e.BYTE;if(i===ShortType)return e.SHORT;if(i===UnsignedShortType)return e.UNSIGNED_SHORT;if(i===IntType)return e.INT;if(i===UnsignedIntType)return e.UNSIGNED_INT;if(i===FloatType)return e.FLOAT;if(i===HalfFloatType)return e.HALF_FLOAT;if(i===AlphaFormat)return e.ALPHA;if(i===RGBFormat)return e.RGB;if(i===RGBAFormat)return e.RGBA;if(i===DepthFormat)return e.DEPTH_COMPONENT;if(i===DepthStencilFormat)return e.DEPTH_STENCIL;if(i===RedFormat)return e.RED;if(i===RedIntegerFormat)return e.RED_INTEGER;if(i===RGFormat)return e.RG;if(i===RGIntegerFormat)return e.RG_INTEGER;if(i===RGBAIntegerFormat)return e.RGBA_INTEGER;if(i===RGB_S3TC_DXT1_Format||i===RGBA_S3TC_DXT1_Format||i===RGBA_S3TC_DXT3_Format||i===RGBA_S3TC_DXT5_Format)if(o===SRGBTransfer){if(r=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===r)return null;if(i===RGB_S3TC_DXT1_Format)return r.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===RGBA_S3TC_DXT1_Format)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===RGBA_S3TC_DXT3_Format)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===RGBA_S3TC_DXT5_Format)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(r=t.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(i===RGB_S3TC_DXT1_Format)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===RGBA_S3TC_DXT1_Format)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===RGBA_S3TC_DXT3_Format)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===RGBA_S3TC_DXT5_Format)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(i===RGB_PVRTC_4BPPV1_Format||i===RGB_PVRTC_2BPPV1_Format||i===RGBA_PVRTC_4BPPV1_Format||i===RGBA_PVRTC_2BPPV1_Format){if(r=t.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(i===RGB_PVRTC_4BPPV1_Format)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===RGB_PVRTC_2BPPV1_Format)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===RGBA_PVRTC_4BPPV1_Format)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===RGBA_PVRTC_2BPPV1_Format)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(i===RGB_ETC1_Format||i===RGB_ETC2_Format||i===RGBA_ETC2_EAC_Format||i===R11_EAC_Format||i===SIGNED_R11_EAC_Format||i===RG11_EAC_Format||i===SIGNED_RG11_EAC_Format){if(r=t.get("WEBGL_compressed_texture_etc"),null===r)return null;if(i===RGB_ETC1_Format||i===RGB_ETC2_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ETC2:r.COMPRESSED_RGB8_ETC2;if(i===RGBA_ETC2_EAC_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC;if(i===R11_EAC_Format)return r.COMPRESSED_R11_EAC;if(i===SIGNED_R11_EAC_Format)return r.COMPRESSED_SIGNED_R11_EAC;if(i===RG11_EAC_Format)return r.COMPRESSED_RG11_EAC;if(i===SIGNED_RG11_EAC_Format)return r.COMPRESSED_SIGNED_RG11_EAC}if(i===RGBA_ASTC_4x4_Format||i===RGBA_ASTC_5x4_Format||i===RGBA_ASTC_5x5_Format||i===RGBA_ASTC_6x5_Format||i===RGBA_ASTC_6x6_Format||i===RGBA_ASTC_8x5_Format||i===RGBA_ASTC_8x6_Format||i===RGBA_ASTC_8x8_Format||i===RGBA_ASTC_10x5_Format||i===RGBA_ASTC_10x6_Format||i===RGBA_ASTC_10x8_Format||i===RGBA_ASTC_10x10_Format||i===RGBA_ASTC_12x10_Format||i===RGBA_ASTC_12x12_Format){if(r=t.get("WEBGL_compressed_texture_astc"),null===r)return null;if(i===RGBA_ASTC_4x4_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:r.COMPRESSED_RGBA_ASTC_4x4_KHR;if(i===RGBA_ASTC_5x4_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:r.COMPRESSED_RGBA_ASTC_5x4_KHR;if(i===RGBA_ASTC_5x5_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:r.COMPRESSED_RGBA_ASTC_5x5_KHR;if(i===RGBA_ASTC_6x5_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:r.COMPRESSED_RGBA_ASTC_6x5_KHR;if(i===RGBA_ASTC_6x6_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:r.COMPRESSED_RGBA_ASTC_6x6_KHR;if(i===RGBA_ASTC_8x5_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:r.COMPRESSED_RGBA_ASTC_8x5_KHR;if(i===RGBA_ASTC_8x6_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:r.COMPRESSED_RGBA_ASTC_8x6_KHR;if(i===RGBA_ASTC_8x8_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:r.COMPRESSED_RGBA_ASTC_8x8_KHR;if(i===RGBA_ASTC_10x5_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:r.COMPRESSED_RGBA_ASTC_10x5_KHR;if(i===RGBA_ASTC_10x6_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:r.COMPRESSED_RGBA_ASTC_10x6_KHR;if(i===RGBA_ASTC_10x8_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:r.COMPRESSED_RGBA_ASTC_10x8_KHR;if(i===RGBA_ASTC_10x10_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:r.COMPRESSED_RGBA_ASTC_10x10_KHR;if(i===RGBA_ASTC_12x10_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:r.COMPRESSED_RGBA_ASTC_12x10_KHR;if(i===RGBA_ASTC_12x12_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:r.COMPRESSED_RGBA_ASTC_12x12_KHR}if(i===RGBA_BPTC_Format||i===RGB_BPTC_SIGNED_Format||i===RGB_BPTC_UNSIGNED_Format){if(r=t.get("EXT_texture_compression_bptc"),null===r)return null;if(i===RGBA_BPTC_Format)return o===SRGBTransfer?r.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:r.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(i===RGB_BPTC_SIGNED_Format)return r.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(i===RGB_BPTC_UNSIGNED_Format)return r.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(i===RED_RGTC1_Format||i===SIGNED_RED_RGTC1_Format||i===RED_GREEN_RGTC2_Format||i===SIGNED_RED_GREEN_RGTC2_Format){if(r=t.get("EXT_texture_compression_rgtc"),null===r)return null;if(i===RED_RGTC1_Format)return r.COMPRESSED_RED_RGTC1_EXT;if(i===SIGNED_RED_RGTC1_Format)return r.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(i===RED_GREEN_RGTC2_Format)return r.COMPRESSED_RED_GREEN_RGTC2_EXT;if(i===SIGNED_RED_GREEN_RGTC2_Format)return r.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return i===UnsignedInt248Type?e.UNSIGNED_INT_24_8:void 0!==e[i]?e[i]:null}}}const _occlusion_vertex="\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",_occlusion_fragment="\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}";class WebXRDepthSensing{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t){if(null===this.texture){const i=new ExternalTexture(e.texture);e.depthNear===t.depthNear&&e.depthFar===t.depthFar||(this.depthNear=e.depthNear,this.depthFar=e.depthFar),this.texture=i}}getMesh(e){if(null!==this.texture&&null===this.mesh){const t=e.cameras[0].viewport,i=new ShaderMaterial({vertexShader:_occlusion_vertex,fragmentShader:_occlusion_fragment,uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new Mesh(new PlaneGeometry(20,20),i)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class WebXRManager extends EventDispatcher{constructor(e,t){super();const i=this;let n=null,r=1,o=null,s="local-floor",a=1,l=null,c=null,u=null,h=null,d=null,p=null;const f="undefined"!=typeof XRWebGLBinding,m=new WebXRDepthSensing,g={},_=t.getContextAttributes();let y=null,v=null;const x=[],b=[],T=new Vector2;let w=null;const E=new PerspectiveCamera;E.viewport=new Vector4;const S=new PerspectiveCamera;S.viewport=new Vector4;const A=[E,S],M=new ArrayCamera;let I=null,C=null;function P(e){const t=b.indexOf(e.inputSource);if(-1===t)return;const i=x[t];void 0!==i&&(i.update(e.inputSource,e.frame,l||o),i.dispatchEvent({type:e.type,data:e.inputSource}))}function L(){n.removeEventListener("select",P),n.removeEventListener("selectstart",P),n.removeEventListener("selectend",P),n.removeEventListener("squeeze",P),n.removeEventListener("squeezestart",P),n.removeEventListener("squeezeend",P),n.removeEventListener("end",L),n.removeEventListener("inputsourceschange",R);for(let e=0;e<x.length;e++){const t=b[e];null!==t&&(b[e]=null,x[e].disconnect(t))}I=null,C=null,m.reset();for(const e in g)delete g[e];e.setRenderTarget(y),d=null,h=null,u=null,n=null,v=null,N.stop(),i.isPresenting=!1,e.setPixelRatio(w),e.setSize(T.width,T.height,!1),i.dispatchEvent({type:"sessionend"})}function R(e){for(let t=0;t<e.removed.length;t++){const i=e.removed[t],n=b.indexOf(i);n>=0&&(b[n]=null,x[n].disconnect(i))}for(let t=0;t<e.added.length;t++){const i=e.added[t];let n=b.indexOf(i);if(-1===n){for(let e=0;e<x.length;e++){if(e>=b.length){b.push(i),n=e;break}if(null===b[e]){b[e]=i,n=e;break}}if(-1===n)break}const r=x[n];r&&r.connect(i)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=x[e];return void 0===t&&(t=new WebXRController,x[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=x[e];return void 0===t&&(t=new WebXRController,x[e]=t),t.getGripSpace()},this.getHand=function(e){let t=x[e];return void 0===t&&(t=new WebXRController,x[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){r=e,!0===i.isPresenting&&warn("WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){s=e,!0===i.isPresenting&&warn("WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return l||o},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==h?h:d},this.getBinding=function(){return null===u&&f&&(u=new XRWebGLBinding(n,t)),u},this.getFrame=function(){return p},this.getSession=function(){return n},this.setSession=async function(c){if(n=c,null!==n){y=e.getRenderTarget(),n.addEventListener("select",P),n.addEventListener("selectstart",P),n.addEventListener("selectend",P),n.addEventListener("squeeze",P),n.addEventListener("squeezestart",P),n.addEventListener("squeezeend",P),n.addEventListener("end",L),n.addEventListener("inputsourceschange",R),!0!==_.xrCompatible&&await t.makeXRCompatible(),w=e.getPixelRatio(),e.getSize(T);if(f&&"createProjectionLayer"in XRWebGLBinding.prototype){let i=null,o=null,s=null;_.depth&&(s=_.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,i=_.stencil?DepthStencilFormat:DepthFormat,o=_.stencil?UnsignedInt248Type:UnsignedIntType);const a={colorFormat:t.RGBA8,depthFormat:s,scaleFactor:r};u=this.getBinding(),h=u.createProjectionLayer(a),n.updateRenderState({layers:[h]}),e.setPixelRatio(1),e.setSize(h.textureWidth,h.textureHeight,!1),v=new WebGLRenderTarget(h.textureWidth,h.textureHeight,{format:RGBAFormat,type:UnsignedByteType,depthTexture:new DepthTexture(h.textureWidth,h.textureHeight,o,void 0,void 0,void 0,void 0,void 0,void 0,i),stencilBuffer:_.stencil,colorSpace:e.outputColorSpace,samples:_.antialias?4:0,resolveDepthBuffer:!1===h.ignoreDepthValues,resolveStencilBuffer:!1===h.ignoreDepthValues})}else{d=new XRWebGLLayer(n,t,{antialias:_.antialias,alpha:!0,depth:_.depth,stencil:_.stencil,framebufferScaleFactor:r}),n.updateRenderState({baseLayer:d}),e.setPixelRatio(1),e.setSize(d.framebufferWidth,d.framebufferHeight,!1),v=new WebGLRenderTarget(d.framebufferWidth,d.framebufferHeight,{format:RGBAFormat,type:UnsignedByteType,colorSpace:e.outputColorSpace,stencilBuffer:_.stencil,resolveDepthBuffer:!1===d.ignoreDepthValues,resolveStencilBuffer:!1===d.ignoreDepthValues})}v.isXRRenderTarget=!0,this.setFoveation(a),l=null,o=await n.requestReferenceSpace(s),N.setContext(n),N.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==n)return n.environmentBlendMode},this.getDepthTexture=function(){return m.getDepthTexture()};const O=new Vector3,D=new Vector3;function B(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===n)return;let t=e.near,i=e.far;null!==m.texture&&(m.depthNear>0&&(t=m.depthNear),m.depthFar>0&&(i=m.depthFar)),M.near=S.near=E.near=t,M.far=S.far=E.far=i,I===M.near&&C===M.far||(n.updateRenderState({depthNear:M.near,depthFar:M.far}),I=M.near,C=M.far),M.layers.mask=6|e.layers.mask,E.layers.mask=3&M.layers.mask,S.layers.mask=5&M.layers.mask;const r=e.parent,o=M.cameras;B(M,r);for(let e=0;e<o.length;e++)B(o[e],r);2===o.length?function(e,t,i){O.setFromMatrixPosition(t.matrixWorld),D.setFromMatrixPosition(i.matrixWorld);const n=O.distanceTo(D),r=t.projectionMatrix.elements,o=i.projectionMatrix.elements,s=r[14]/(r[10]-1),a=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],u=(r[8]-1)/r[0],h=(o[8]+1)/o[0],d=s*u,p=s*h,f=n/(-u+h),m=f*-u;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(f),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===r[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=s+f,i=a+f;e.projectionMatrix.makePerspective(d-m,p+(n-m),l*a/i*t,c*a/i*t,t,i),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(M,E,S):M.projectionMatrix.copy(E.projectionMatrix),function(e,t,i){null===i?e.matrix.copy(t.matrixWorld):(e.matrix.copy(i.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*RAD2DEG*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,M,r)},this.getCamera=function(){return M},this.getFoveation=function(){if(null!==h||null!==d)return a},this.setFoveation=function(e){a=e,null!==h&&(h.fixedFoveation=e),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==m.texture},this.getDepthSensingMesh=function(){return m.getMesh(M)},this.getCameraTexture=function(e){return g[e]};let F=null;const N=new WebGLAnimation;N.setAnimationLoop((function(t,r){if(c=r.getViewerPose(l||o),p=r,null!==c){const t=c.views;null!==d&&(e.setRenderTargetFramebuffer(v,d.framebuffer),e.setRenderTarget(v));let r=!1;t.length!==M.cameras.length&&(M.cameras.length=0,r=!0);for(let i=0;i<t.length;i++){const n=t[i];let o=null;if(null!==d)o=d.getViewport(n);else{const t=u.getViewSubImage(h,n);o=t.viewport,0===i&&(e.setRenderTargetTextures(v,t.colorTexture,t.depthStencilTexture),e.setRenderTarget(v))}let s=A[i];void 0===s&&(s=new PerspectiveCamera,s.layers.enable(i),s.viewport=new Vector4,A[i]=s),s.matrix.fromArray(n.transform.matrix),s.matrix.decompose(s.position,s.quaternion,s.scale),s.projectionMatrix.fromArray(n.projectionMatrix),s.projectionMatrixInverse.copy(s.projectionMatrix).invert(),s.viewport.set(o.x,o.y,o.width,o.height),0===i&&(M.matrix.copy(s.matrix),M.matrix.decompose(M.position,M.quaternion,M.scale)),!0===r&&M.cameras.push(s)}const o=n.enabledFeatures;if(o&&o.includes("depth-sensing")&&"gpu-optimized"==n.depthUsage&&f){u=i.getBinding();const e=u.getDepthInformation(t[0]);e&&e.isValid&&e.texture&&m.init(e,n.renderState)}if(o&&o.includes("camera-access")&&f){e.state.unbindTexture(),u=i.getBinding();for(let e=0;e<t.length;e++){const i=t[e].camera;if(i){let e=g[i];e||(e=new ExternalTexture,g[i]=e);const t=u.getCameraImage(i);e.sourceTexture=t}}}}for(let e=0;e<x.length;e++){const t=b[e],i=x[e];null!==t&&void 0!==i&&i.update(t,r,l||o)}F&&F(t,r),r.detectedPlanes&&i.dispatchEvent({type:"planesdetected",data:r}),p=null})),this.setAnimationLoop=function(e){F=e},this.dispose=function(){}}}const _e1=new Euler,_m1=new Matrix4;function WebGLMaterials(e,t){function i(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function n(e,n){e.opacity.value=n.opacity,n.color&&e.diffuse.value.copy(n.color),n.emissive&&e.emissive.value.copy(n.emissive).multiplyScalar(n.emissiveIntensity),n.map&&(e.map.value=n.map,i(n.map,e.mapTransform)),n.alphaMap&&(e.alphaMap.value=n.alphaMap,i(n.alphaMap,e.alphaMapTransform)),n.bumpMap&&(e.bumpMap.value=n.bumpMap,i(n.bumpMap,e.bumpMapTransform),e.bumpScale.value=n.bumpScale,n.side===BackSide&&(e.bumpScale.value*=-1)),n.normalMap&&(e.normalMap.value=n.normalMap,i(n.normalMap,e.normalMapTransform),e.normalScale.value.copy(n.normalScale),n.side===BackSide&&e.normalScale.value.negate()),n.displacementMap&&(e.displacementMap.value=n.displacementMap,i(n.displacementMap,e.displacementMapTransform),e.displacementScale.value=n.displacementScale,e.displacementBias.value=n.displacementBias),n.emissiveMap&&(e.emissiveMap.value=n.emissiveMap,i(n.emissiveMap,e.emissiveMapTransform)),n.specularMap&&(e.specularMap.value=n.specularMap,i(n.specularMap,e.specularMapTransform)),n.alphaTest>0&&(e.alphaTest.value=n.alphaTest);const r=t.get(n),o=r.envMap,s=r.envMapRotation;o&&(e.envMap.value=o,_e1.copy(s),_e1.x*=-1,_e1.y*=-1,_e1.z*=-1,o.isCubeTexture&&!1===o.isRenderTargetTexture&&(_e1.y*=-1,_e1.z*=-1),e.envMapRotation.value.setFromMatrix4(_m1.makeRotationFromEuler(_e1)),e.flipEnvMap.value=o.isCubeTexture&&!1===o.isRenderTargetTexture?-1:1,e.reflectivity.value=n.reflectivity,e.ior.value=n.ior,e.refractionRatio.value=n.refractionRatio),n.lightMap&&(e.lightMap.value=n.lightMap,e.lightMapIntensity.value=n.lightMapIntensity,i(n.lightMap,e.lightMapTransform)),n.aoMap&&(e.aoMap.value=n.aoMap,e.aoMapIntensity.value=n.aoMapIntensity,i(n.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(t,i){i.color.getRGB(t.fogColor.value,getUnlitUniformColorSpace(e)),i.isFog?(t.fogNear.value=i.near,t.fogFar.value=i.far):i.isFogExp2&&(t.fogDensity.value=i.density)},refreshMaterialUniforms:function(e,r,o,s,a){r.isMeshBasicMaterial||r.isMeshLambertMaterial?n(e,r):r.isMeshToonMaterial?(n(e,r),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,r)):r.isMeshPhongMaterial?(n(e,r),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,r)):r.isMeshStandardMaterial?(n(e,r),function(e,t){e.metalness.value=t.metalness,t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap,i(t.metalnessMap,e.metalnessMapTransform));e.roughness.value=t.roughness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap,i(t.roughnessMap,e.roughnessMapTransform));t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}(e,r),r.isMeshPhysicalMaterial&&function(e,t,n){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,i(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,i(t.sheenRoughnessMap,e.sheenRoughnessMapTransform)));t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,i(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,i(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,i(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),t.side===BackSide&&e.clearcoatNormalScale.value.negate()));t.dispersion>0&&(e.dispersion.value=t.dispersion);t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,i(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,i(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform)));t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=n.texture,e.transmissionSamplerSize.value.set(n.width,n.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,i(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,i(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor));t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,i(t.anisotropyMap,e.anisotropyMapTransform)));e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,i(t.specularColorMap,e.specularColorMapTransform));t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,i(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,r,a)):r.isMeshMatcapMaterial?(n(e,r),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,r)):r.isMeshDepthMaterial?n(e,r):r.isMeshDistanceMaterial?(n(e,r),function(e,i){const n=t.get(i).light;e.referencePosition.value.setFromMatrixPosition(n.matrixWorld),e.nearDistance.value=n.shadow.camera.near,e.farDistance.value=n.shadow.camera.far}(e,r)):r.isMeshNormalMaterial?n(e,r):r.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,i(t.map,e.mapTransform))}(e,r),r.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,r)):r.isPointsMaterial?function(e,t,n,r){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*n,e.scale.value=.5*r,t.map&&(e.map.value=t.map,i(t.map,e.uvTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,i(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,r,o,s):r.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,i(t.map,e.mapTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,i(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,r):r.isShadowMaterial?(e.color.value.copy(r.color),e.opacity.value=r.opacity):r.isShaderMaterial&&(r.uniformsNeedUpdate=!1)}}}function WebGLUniformsGroups(e,t,i,n){let r={},o={},s=[];const a=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function l(e,t,i,n){const r=e.value,o=t+"_"+i;if(void 0===n[o])return n[o]="number"==typeof r||"boolean"==typeof r?r:r.clone(),!0;{const e=n[o];if("number"==typeof r||"boolean"==typeof r){if(e!==r)return n[o]=r,!0}else if(!1===e.equals(r))return e.copy(r),!0}return!1}function c(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?warn("WebGLRenderer: Texture samplers can not be part of an uniforms group."):warn("WebGLRenderer: Unsupported uniform value type.",e),t}function u(t){const i=t.target;i.removeEventListener("dispose",u);const n=s.indexOf(i.__bindingPointIndex);s.splice(n,1),e.deleteBuffer(r[i.id]),delete r[i.id],delete o[i.id]}return{bind:function(e,t){n.uniformBlockBinding(e,t.program)},update:function(i,h){let d=r[i.id];void 0===d&&(!function(e){const t=e.uniforms;let i=0;const n=16;for(let e=0,r=t.length;e<r;e++){const r=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0,t=r.length;e<t;e++){const t=r[e],o=Array.isArray(t.value)?t.value:[t.value];for(let e=0,r=o.length;e<r;e++){const r=c(o[e]),s=i%n,a=s%r.boundary,l=s+a;i+=a,0!==l&&n-l<r.storage&&(i+=n-l),t.__data=new Float32Array(r.storage/Float32Array.BYTES_PER_ELEMENT),t.__offset=i,i+=r.storage}}}const r=i%n;r>0&&(i+=n-r);e.__size=i,e.__cache={}}(i),d=function(t){const i=function(){for(let e=0;e<a;e++)if(-1===s.indexOf(e))return s.push(e),e;return error("WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();t.__bindingPointIndex=i;const n=e.createBuffer(),r=t.__size,o=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,n),e.bufferData(e.UNIFORM_BUFFER,r,o),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,i,n),n}(i),r[i.id]=d,i.addEventListener("dispose",u)),n.updateUBOMapping(i,h.program);const p=t.render.frame;o[i.id]!==p&&(!function(t){const i=r[t.id],n=t.uniforms,o=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,i);for(let t=0,i=n.length;t<i;t++){const i=Array.isArray(n[t])?n[t]:[n[t]];for(let n=0,r=i.length;n<r;n++){const r=i[n];if(!0===l(r,t,n,o)){const t=r.__offset,i=Array.isArray(r.value)?r.value:[r.value];let n=0;for(let o=0;o<i.length;o++){const s=i[o],a=c(s);"number"==typeof s||"boolean"==typeof s?(r.__data[0]=s,e.bufferSubData(e.UNIFORM_BUFFER,t+n,r.__data)):s.isMatrix3?(r.__data[0]=s.elements[0],r.__data[1]=s.elements[1],r.__data[2]=s.elements[2],r.__data[3]=0,r.__data[4]=s.elements[3],r.__data[5]=s.elements[4],r.__data[6]=s.elements[5],r.__data[7]=0,r.__data[8]=s.elements[6],r.__data[9]=s.elements[7],r.__data[10]=s.elements[8],r.__data[11]=0):(s.toArray(r.__data,n),n+=a.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,r.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(i),o[i.id]=p)},dispose:function(){for(const t in r)e.deleteBuffer(r[t]);s=[],r={},o={}}}}const DATA=new Uint16Array([12469,15057,12620,14925,13266,14620,13807,14376,14323,13990,14545,13625,14713,13328,14840,12882,14931,12528,14996,12233,15039,11829,15066,11525,15080,11295,15085,10976,15082,10705,15073,10495,13880,14564,13898,14542,13977,14430,14158,14124,14393,13732,14556,13410,14702,12996,14814,12596,14891,12291,14937,11834,14957,11489,14958,11194,14943,10803,14921,10506,14893,10278,14858,9960,14484,14039,14487,14025,14499,13941,14524,13740,14574,13468,14654,13106,14743,12678,14818,12344,14867,11893,14889,11509,14893,11180,14881,10751,14852,10428,14812,10128,14765,9754,14712,9466,14764,13480,14764,13475,14766,13440,14766,13347,14769,13070,14786,12713,14816,12387,14844,11957,14860,11549,14868,11215,14855,10751,14825,10403,14782,10044,14729,9651,14666,9352,14599,9029,14967,12835,14966,12831,14963,12804,14954,12723,14936,12564,14917,12347,14900,11958,14886,11569,14878,11247,14859,10765,14828,10401,14784,10011,14727,9600,14660,9289,14586,8893,14508,8533,15111,12234,15110,12234,15104,12216,15092,12156,15067,12010,15028,11776,14981,11500,14942,11205,14902,10752,14861,10393,14812,9991,14752,9570,14682,9252,14603,8808,14519,8445,14431,8145,15209,11449,15208,11451,15202,11451,15190,11438,15163,11384,15117,11274,15055,10979,14994,10648,14932,10343,14871,9936,14803,9532,14729,9218,14645,8742,14556,8381,14461,8020,14365,7603,15273,10603,15272,10607,15267,10619,15256,10631,15231,10614,15182,10535,15118,10389,15042,10167,14963,9787,14883,9447,14800,9115,14710,8665,14615,8318,14514,7911,14411,7507,14279,7198,15314,9675,15313,9683,15309,9712,15298,9759,15277,9797,15229,9773,15166,9668,15084,9487,14995,9274,14898,8910,14800,8539,14697,8234,14590,7790,14479,7409,14367,7067,14178,6621,15337,8619,15337,8631,15333,8677,15325,8769,15305,8871,15264,8940,15202,8909,15119,8775,15022,8565,14916,8328,14804,8009,14688,7614,14569,7287,14448,6888,14321,6483,14088,6171,15350,7402,15350,7419,15347,7480,15340,7613,15322,7804,15287,7973,15229,8057,15148,8012,15046,7846,14933,7611,14810,7357,14682,7069,14552,6656,14421,6316,14251,5948,14007,5528,15356,5942,15356,5977,15353,6119,15348,6294,15332,6551,15302,6824,15249,7044,15171,7122,15070,7050,14949,6861,14818,6611,14679,6349,14538,6067,14398,5651,14189,5311,13935,4958,15359,4123,15359,4153,15356,4296,15353,4646,15338,5160,15311,5508,15263,5829,15188,6042,15088,6094,14966,6001,14826,5796,14678,5543,14527,5287,14377,4985,14133,4586,13869,4257,15360,1563,15360,1642,15358,2076,15354,2636,15341,3350,15317,4019,15273,4429,15203,4732,15105,4911,14981,4932,14836,4818,14679,4621,14517,4386,14359,4156,14083,3795,13808,3437,15360,122,15360,137,15358,285,15355,636,15344,1274,15322,2177,15281,2765,15215,3223,15120,3451,14995,3569,14846,3567,14681,3466,14511,3305,14344,3121,14037,2800,13753,2467,15360,0,15360,1,15359,21,15355,89,15346,253,15325,479,15287,796,15225,1148,15133,1492,15008,1749,14856,1882,14685,1886,14506,1783,14324,1608,13996,1398,13702,1183]);let lut=null;function getDFGLUT(){return null===lut&&(lut=new DataTexture(DATA,16,16,RGFormat,HalfFloatType),lut.name="DFG_LUT",lut.minFilter=LinearFilter,lut.magFilter=LinearFilter,lut.wrapS=ClampToEdgeWrapping,lut.wrapT=ClampToEdgeWrapping,lut.generateMipmaps=!1,lut.needsUpdate=!0),lut}class WebGLRenderer{constructor(e={}){const{canvas:t=createCanvasElement(),context:i=null,depth:n=!0,stencil:r=!1,alpha:o=!1,antialias:s=!1,premultipliedAlpha:a=!0,preserveDrawingBuffer:l=!1,powerPreference:c="default",failIfMajorPerformanceCaveat:u=!1,reversedDepthBuffer:h=!1,outputBufferType:d=UnsignedByteType}=e;let p;if(this.isWebGLRenderer=!0,null!==i){if("undefined"!=typeof WebGLRenderingContext&&i instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");p=i.getContextAttributes().alpha}else p=o;const f=d,m=new Set([RGBAIntegerFormat,RGIntegerFormat,RedIntegerFormat]),g=new Set([UnsignedByteType,UnsignedIntType,UnsignedShortType,UnsignedInt248Type,UnsignedShort4444Type,UnsignedShort5551Type]),_=new Uint32Array(4),y=new Int32Array(4);let v=null,x=null;const b=[],T=[];let w=null;this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=NoToneMapping,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const E=this;let S=!1;this._outputColorSpace=SRGBColorSpace;let A=0,M=0,I=null,C=-1,P=null;const L=new Vector4,R=new Vector4;let O=null;const D=new Color(0);let B=0,F=t.width,N=t.height,k=1,U=null,z=null;const V=new Vector4(0,0,F,N),G=new Vector4(0,0,F,N);let j=!1;const H=new Frustum;let $=!1,W=!1;const q=new Matrix4,X=new Vector3,Y=new Vector4,Z={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let J=!1;function K(){return null===I?k:1}let Q,ee,te,ie,ne,re,oe,se,ae,le,ce,ue,he,de,pe,fe,me,ge,_e,ye,ve,xe,be,Te,we=i;function Ee(e,i){return t.getContext(e,i)}try{const e={alpha:!0,depth:n,stencil:r,antialias:s,premultipliedAlpha:a,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:u};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${REVISION}`),t.addEventListener("webglcontextlost",Me,!1),t.addEventListener("webglcontextrestored",Ie,!1),t.addEventListener("webglcontextcreationerror",Ce,!1),null===we){const t="webgl2";if(we=Ee(t,e),null===we)throw Ee(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(e){throw error("WebGLRenderer: "+e.message),e}function Se(){Q=new WebGLExtensions(we),Q.init(),xe=new WebGLUtils(we,Q),ee=new WebGLCapabilities(we,Q,e,xe),te=new WebGLState(we,Q),ee.reversedDepthBuffer&&h&&te.buffers.depth.setReversed(!0),ie=new WebGLInfo(we),ne=new WebGLProperties,re=new WebGLTextures(we,Q,te,ne,ee,xe,ie),oe=new WebGLCubeMaps(E),se=new WebGLCubeUVMaps(E),ae=new WebGLAttributes(we),be=new WebGLBindingStates(we,ae),le=new WebGLGeometries(we,ae,ie,be),ce=new WebGLObjects(we,le,ae,ie),_e=new WebGLMorphtargets(we,ee,re),fe=new WebGLClipping(ne),ue=new WebGLPrograms(E,oe,se,Q,ee,be,fe),he=new WebGLMaterials(E,ne),de=new WebGLRenderLists,pe=new WebGLRenderStates(Q),ge=new WebGLBackground(E,oe,se,te,ce,p,a),me=new WebGLShadowMap(E,ce,ee),Te=new WebGLUniformsGroups(we,ie,ee,te),ye=new WebGLBufferRenderer(we,Q,ie),ve=new WebGLIndexedBufferRenderer(we,Q,ie),ie.programs=ue.programs,E.capabilities=ee,E.extensions=Q,E.properties=ne,E.renderLists=de,E.shadowMap=me,E.state=te,E.info=ie}Se(),f!==UnsignedByteType&&(w=new WebGLOutput(f,t.width,t.height,n,r));const Ae=new WebXRManager(E,we);function Me(e){e.preventDefault(),log("WebGLRenderer: Context Lost."),S=!0}function Ie(){log("WebGLRenderer: Context Restored."),S=!1;const e=ie.autoReset,t=me.enabled,i=me.autoUpdate,n=me.needsUpdate,r=me.type;Se(),ie.autoReset=e,me.enabled=t,me.autoUpdate=i,me.needsUpdate=n,me.type=r}function Ce(e){error("WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Pe(e){const t=e.target;t.removeEventListener("dispose",Pe),function(e){(function(e){const t=ne.get(e).programs;void 0!==t&&(t.forEach((function(e){ue.releaseProgram(e)})),e.isShaderMaterial&&ue.releaseShaderCache(e))})(e),ne.remove(e)}(t)}function Le(e,t,i){!0===e.transparent&&e.side===DoubleSide&&!1===e.forceSinglePass?(e.side=BackSide,e.needsUpdate=!0,Ve(e,t,i),e.side=FrontSide,e.needsUpdate=!0,Ve(e,t,i),e.side=DoubleSide):Ve(e,t,i)}this.xr=Ae,this.getContext=function(){return we},this.getContextAttributes=function(){return we.getContextAttributes()},this.forceContextLoss=function(){const e=Q.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=Q.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return k},this.setPixelRatio=function(e){void 0!==e&&(k=e,this.setSize(F,N,!1))},this.getSize=function(e){return e.set(F,N)},this.setSize=function(e,i,n=!0){Ae.isPresenting?warn("WebGLRenderer: Can't change size while VR device is presenting."):(F=e,N=i,t.width=Math.floor(e*k),t.height=Math.floor(i*k),!0===n&&(t.style.width=e+"px",t.style.height=i+"px"),null!==w&&w.setSize(t.width,t.height),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(e){return e.set(F*k,N*k).floor()},this.setDrawingBufferSize=function(e,i,n){F=e,N=i,k=n,t.width=Math.floor(e*n),t.height=Math.floor(i*n),this.setViewport(0,0,e,i)},this.setEffects=function(e){if(f!==UnsignedByteType){if(e)for(let t=0;t<e.length&&!0!==e[t].isOutputPass;t++);w.setEffects(e||[])}},this.getCurrentViewport=function(e){return e.copy(L)},this.getViewport=function(e){return e.copy(V)},this.setViewport=function(e,t,i,n){e.isVector4?V.set(e.x,e.y,e.z,e.w):V.set(e,t,i,n),te.viewport(L.copy(V).multiplyScalar(k).round())},this.getScissor=function(e){return e.copy(G)},this.setScissor=function(e,t,i,n){e.isVector4?G.set(e.x,e.y,e.z,e.w):G.set(e,t,i,n),te.scissor(R.copy(G).multiplyScalar(k).round())},this.getScissorTest=function(){return j},this.setScissorTest=function(e){te.setScissorTest(j=e)},this.setOpaqueSort=function(e){U=e},this.setTransparentSort=function(e){z=e},this.getClearColor=function(e){return e.copy(ge.getClearColor())},this.setClearColor=function(){ge.setClearColor(...arguments)},this.getClearAlpha=function(){return ge.getClearAlpha()},this.setClearAlpha=function(){ge.setClearAlpha(...arguments)},this.clear=function(e=!0,t=!0,i=!0){let n=0;if(e){let e=!1;if(null!==I){e=m.has(I.texture.format)}if(e){const e=g.has(I.texture.type),t=ge.getClearColor(),i=ge.getClearAlpha(),n=t.r,r=t.g,o=t.b;e?(_[0]=n,_[1]=r,_[2]=o,_[3]=i,we.clearBufferuiv(we.COLOR,0,_)):(y[0]=n,y[1]=r,y[2]=o,y[3]=i,we.clearBufferiv(we.COLOR,0,y))}else n|=we.COLOR_BUFFER_BIT}t&&(n|=we.DEPTH_BUFFER_BIT),i&&(n|=we.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),we.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",Me,!1),t.removeEventListener("webglcontextrestored",Ie,!1),t.removeEventListener("webglcontextcreationerror",Ce,!1),ge.dispose(),de.dispose(),pe.dispose(),ne.dispose(),oe.dispose(),se.dispose(),ce.dispose(),be.dispose(),Te.dispose(),ue.dispose(),Ae.dispose(),Ae.removeEventListener("sessionstart",Oe),Ae.removeEventListener("sessionend",De),Be.stop()},this.renderBufferDirect=function(e,t,i,n,r,o){null===t&&(t=Z);const s=r.isMesh&&r.matrixWorld.determinant()<0,a=function(e,t,i,n,r){!0!==t.isScene&&(t=Z);re.resetTextureUnits();const o=t.fog,s=n.isMeshStandardMaterial?t.environment:null,a=null===I?E.outputColorSpace:!0===I.isXRRenderTarget?I.texture.colorSpace:LinearSRGBColorSpace,l=(n.isMeshStandardMaterial?se:oe).get(n.envMap||s),c=!0===n.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,u=!!i.attributes.tangent&&(!!n.normalMap||n.anisotropy>0),h=!!i.morphAttributes.position,d=!!i.morphAttributes.normal,p=!!i.morphAttributes.color;let f=NoToneMapping;n.toneMapped&&(null!==I&&!0!==I.isXRRenderTarget||(f=E.toneMapping));const m=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color,g=void 0!==m?m.length:0,_=ne.get(n),y=x.state.lights;if(!0===$&&(!0===W||e!==P)){fe.setState(n,e,e===P&&n.id===C)}let v=!1;n.version===_.__version?_.needsLights&&_.lightsStateVersion!==y.state.version||_.outputColorSpace!==a||r.isBatchedMesh&&!1===_.batching?v=!0:r.isBatchedMesh||!0!==_.batching?r.isBatchedMesh&&!0===_.batchingColor&&null===r.colorTexture||r.isBatchedMesh&&!1===_.batchingColor&&null!==r.colorTexture||r.isInstancedMesh&&!1===_.instancing?v=!0:r.isInstancedMesh||!0!==_.instancing?r.isSkinnedMesh&&!1===_.skinning?v=!0:r.isSkinnedMesh||!0!==_.skinning?r.isInstancedMesh&&!0===_.instancingColor&&null===r.instanceColor||r.isInstancedMesh&&!1===_.instancingColor&&null!==r.instanceColor||r.isInstancedMesh&&!0===_.instancingMorph&&null===r.morphTexture||r.isInstancedMesh&&!1===_.instancingMorph&&null!==r.morphTexture||_.envMap!==l||!0===n.fog&&_.fog!==o?v=!0:void 0===_.numClippingPlanes||_.numClippingPlanes===fe.numPlanes&&_.numIntersection===fe.numIntersection?(_.vertexAlphas!==c||_.vertexTangents!==u||_.morphTargets!==h||_.morphNormals!==d||_.morphColors!==p||_.toneMapping!==f||_.morphTargetsCount!==g)&&(v=!0):v=!0:v=!0:v=!0:v=!0:(v=!0,_.__version=n.version);let b=_.currentProgram;!0===v&&(b=Ve(n,t,r));let T=!1,w=!1,S=!1;const A=b.getUniforms(),M=_.uniforms;te.useProgram(b.program)&&(T=!0,w=!0,S=!0);n.id!==C&&(C=n.id,w=!0);if(T||P!==e){te.buffers.depth.getReversed()&&!0!==e.reversedDepth&&(e._reversedDepth=!0,e.updateProjectionMatrix()),A.setValue(we,"projectionMatrix",e.projectionMatrix),A.setValue(we,"viewMatrix",e.matrixWorldInverse);const t=A.map.cameraPosition;void 0!==t&&t.setValue(we,X.setFromMatrixPosition(e.matrixWorld)),ee.logarithmicDepthBuffer&&A.setValue(we,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(n.isMeshPhongMaterial||n.isMeshToonMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial)&&A.setValue(we,"isOrthographic",!0===e.isOrthographicCamera),P!==e&&(P=e,w=!0,S=!0)}_.needsLights&&(y.state.directionalShadowMap.length>0&&A.setValue(we,"directionalShadowMap",y.state.directionalShadowMap,re),y.state.spotShadowMap.length>0&&A.setValue(we,"spotShadowMap",y.state.spotShadowMap,re),y.state.pointShadowMap.length>0&&A.setValue(we,"pointShadowMap",y.state.pointShadowMap,re));if(r.isSkinnedMesh){A.setOptional(we,r,"bindMatrix"),A.setOptional(we,r,"bindMatrixInverse");const e=r.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),A.setValue(we,"boneTexture",e.boneTexture,re))}r.isBatchedMesh&&(A.setOptional(we,r,"batchingTexture"),A.setValue(we,"batchingTexture",r._matricesTexture,re),A.setOptional(we,r,"batchingIdTexture"),A.setValue(we,"batchingIdTexture",r._indirectTexture,re),A.setOptional(we,r,"batchingColorTexture"),null!==r._colorsTexture&&A.setValue(we,"batchingColorTexture",r._colorsTexture,re));const L=i.morphAttributes;void 0===L.position&&void 0===L.normal&&void 0===L.color||_e.update(r,i,b);(w||_.receiveShadow!==r.receiveShadow)&&(_.receiveShadow=r.receiveShadow,A.setValue(we,"receiveShadow",r.receiveShadow));n.isMeshGouraudMaterial&&null!==n.envMap&&(M.envMap.value=l,M.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);n.isMeshStandardMaterial&&null===n.envMap&&null!==t.environment&&(M.envMapIntensity.value=t.environmentIntensity);void 0!==M.dfgLUT&&(M.dfgLUT.value=getDFGLUT());w&&(A.setValue(we,"toneMappingExposure",E.toneMappingExposure),_.needsLights&&((R=M).ambientLightColor.needsUpdate=O=S,R.lightProbe.needsUpdate=O,R.directionalLights.needsUpdate=O,R.directionalLightShadows.needsUpdate=O,R.pointLights.needsUpdate=O,R.pointLightShadows.needsUpdate=O,R.spotLights.needsUpdate=O,R.spotLightShadows.needsUpdate=O,R.rectAreaLights.needsUpdate=O,R.hemisphereLights.needsUpdate=O),o&&!0===n.fog&&he.refreshFogUniforms(M,o),he.refreshMaterialUniforms(M,n,k,N,x.state.transmissionRenderTarget[e.id]),WebGLUniforms.upload(we,Ge(_),M,re));var R,O;n.isShaderMaterial&&!0===n.uniformsNeedUpdate&&(WebGLUniforms.upload(we,Ge(_),M,re),n.uniformsNeedUpdate=!1);n.isSpriteMaterial&&A.setValue(we,"center",r.center);if(A.setValue(we,"modelViewMatrix",r.modelViewMatrix),A.setValue(we,"normalMatrix",r.normalMatrix),A.setValue(we,"modelMatrix",r.matrixWorld),n.isShaderMaterial||n.isRawShaderMaterial){const e=n.uniformsGroups;for(let t=0,i=e.length;t<i;t++){const i=e[t];Te.update(i,b),Te.bind(i,b)}}return b}(e,t,i,n,r);te.setMaterial(n,s);let l=i.index,c=1;if(!0===n.wireframe){if(l=le.getWireframeAttribute(i),void 0===l)return;c=2}const u=i.drawRange,h=i.attributes.position;let d=u.start*c,p=(u.start+u.count)*c;null!==o&&(d=Math.max(d,o.start*c),p=Math.min(p,(o.start+o.count)*c)),null!==l?(d=Math.max(d,0),p=Math.min(p,l.count)):null!=h&&(d=Math.max(d,0),p=Math.min(p,h.count));const f=p-d;if(f<0||f===1/0)return;let m;be.setup(r,n,a,i,l);let g=ye;if(null!==l&&(m=ae.get(l),g=ve,g.setIndex(m)),r.isMesh)!0===n.wireframe?(te.setLineWidth(n.wireframeLinewidth*K()),g.setMode(we.LINES)):g.setMode(we.TRIANGLES);else if(r.isLine){let e=n.linewidth;void 0===e&&(e=1),te.setLineWidth(e*K()),g.setMode(r.isLineSegments?we.LINES:r.isLineLoop?we.LINE_LOOP:we.LINE_STRIP)}else r.isPoints?g.setMode(we.POINTS):r.isSprite&&g.setMode(we.TRIANGLES);if(r.isBatchedMesh)if(null!==r._multiDrawInstances)warnOnce("WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),g.renderMultiDrawInstances(r._multiDrawStarts,r._multiDrawCounts,r._multiDrawCount,r._multiDrawInstances);else if(Q.get("WEBGL_multi_draw"))g.renderMultiDraw(r._multiDrawStarts,r._multiDrawCounts,r._multiDrawCount);else{const e=r._multiDrawStarts,t=r._multiDrawCounts,i=r._multiDrawCount,o=l?ae.get(l).bytesPerElement:1,s=ne.get(n).currentProgram.getUniforms();for(let n=0;n<i;n++)s.setValue(we,"_gl_DrawID",n),g.render(e[n]/o,t[n])}else if(r.isInstancedMesh)g.renderInstances(d,f,r.count);else if(i.isInstancedBufferGeometry){const e=Math.min(i.instanceCount,void 0!==i._maxInstanceCount?i._maxInstanceCount:1/0);g.renderInstances(d,f,e)}else g.render(d,f)},this.compile=function(e,t,i=null){null===i&&(i=e),x=pe.get(i),x.init(t),T.push(x),i.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(x.pushLight(e),e.castShadow&&x.pushShadow(e))})),e!==i&&e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(x.pushLight(e),e.castShadow&&x.pushShadow(e))})),x.setupLights();const n=new Set;return e.traverse((function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let r=0;r<t.length;r++){const o=t[r];Le(o,i,e),n.add(o)}else Le(t,i,e),n.add(t)})),x=T.pop(),n},this.compileAsync=function(e,t,i=null){const n=this.compile(e,t,i);return new Promise((t=>{function i(){n.forEach((function(e){ne.get(e).currentProgram.isReady()&&n.delete(e)})),0!==n.size?setTimeout(i,10):t(e)}null!==Q.get("KHR_parallel_shader_compile")?i():setTimeout(i,10)}))};let Re=null;function Oe(){Be.stop()}function De(){Be.start()}const Be=new WebGLAnimation;function Fe(e,t,i,n){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)i=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)x.pushLight(e),e.castShadow&&x.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||H.intersectsSprite(e)){n&&Y.setFromMatrixPosition(e.matrixWorld).applyMatrix4(q);const t=ce.update(e),r=e.material;r.visible&&v.push(e,t,r,i,Y.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||H.intersectsObject(e))){const t=ce.update(e),r=e.material;if(n&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),Y.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),Y.copy(t.boundingSphere.center)),Y.applyMatrix4(e.matrixWorld).applyMatrix4(q)),Array.isArray(r)){const n=t.groups;for(let o=0,s=n.length;o<s;o++){const s=n[o],a=r[s.materialIndex];a&&a.visible&&v.push(e,t,a,i,Y.z,s)}}else r.visible&&v.push(e,t,r,i,Y.z,null)}const r=e.children;for(let e=0,o=r.length;e<o;e++)Fe(r[e],t,i,n)}function Ne(e,t,i,n){const{opaque:r,transmissive:o,transparent:s}=e;x.setupLightsView(i),!0===$&&fe.setGlobalState(E.clippingPlanes,i),n&&te.viewport(L.copy(n)),r.length>0&&Ue(r,t,i),o.length>0&&Ue(o,t,i),s.length>0&&Ue(s,t,i),te.buffers.depth.setTest(!0),te.buffers.depth.setMask(!0),te.buffers.color.setMask(!0),te.setPolygonOffset(!1)}function ke(e,t,i,n){if(null!==(!0===i.isScene?i.overrideMaterial:null))return;if(void 0===x.state.transmissionRenderTarget[n.id]){const e=Q.has("EXT_color_buffer_half_float")||Q.has("EXT_color_buffer_float");x.state.transmissionRenderTarget[n.id]=new WebGLRenderTarget(1,1,{generateMipmaps:!0,type:e?HalfFloatType:UnsignedByteType,minFilter:LinearMipmapLinearFilter,samples:ee.samples,stencilBuffer:r,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:ColorManagement.workingColorSpace})}const o=x.state.transmissionRenderTarget[n.id],s=n.viewport||L;o.setSize(s.z*E.transmissionResolutionScale,s.w*E.transmissionResolutionScale);const a=E.getRenderTarget(),l=E.getActiveCubeFace(),c=E.getActiveMipmapLevel();E.setRenderTarget(o),E.getClearColor(D),B=E.getClearAlpha(),B<1&&E.setClearColor(16777215,.5),E.clear(),J&&ge.render(i);const u=E.toneMapping;E.toneMapping=NoToneMapping;const h=n.viewport;if(void 0!==n.viewport&&(n.viewport=void 0),x.setupLightsView(n),!0===$&&fe.setGlobalState(E.clippingPlanes,n),Ue(e,i,n),re.updateMultisampleRenderTarget(o),re.updateRenderTargetMipmap(o),!1===Q.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let r=0,o=t.length;r<o;r++){const o=t[r],{object:s,geometry:a,material:l,group:c}=o;if(l.side===DoubleSide&&s.layers.test(n.layers)){const t=l.side;l.side=BackSide,l.needsUpdate=!0,ze(s,i,n,a,l,c),l.side=t,l.needsUpdate=!0,e=!0}}!0===e&&(re.updateMultisampleRenderTarget(o),re.updateRenderTargetMipmap(o))}E.setRenderTarget(a,l,c),E.setClearColor(D,B),void 0!==h&&(n.viewport=h),E.toneMapping=u}function Ue(e,t,i){const n=!0===t.isScene?t.overrideMaterial:null;for(let r=0,o=e.length;r<o;r++){const o=e[r],{object:s,geometry:a,group:l}=o;let c=o.material;!0===c.allowOverride&&null!==n&&(c=n),s.layers.test(i.layers)&&ze(s,t,i,a,c,l)}}function ze(e,t,i,n,r,o){e.onBeforeRender(E,t,i,n,r,o),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),r.onBeforeRender(E,t,i,n,e,o),!0===r.transparent&&r.side===DoubleSide&&!1===r.forceSinglePass?(r.side=BackSide,r.needsUpdate=!0,E.renderBufferDirect(i,t,n,r,e,o),r.side=FrontSide,r.needsUpdate=!0,E.renderBufferDirect(i,t,n,r,e,o),r.side=DoubleSide):E.renderBufferDirect(i,t,n,r,e,o),e.onAfterRender(E,t,i,n,r,o)}function Ve(e,t,i){!0!==t.isScene&&(t=Z);const n=ne.get(e),r=x.state.lights,o=r.state.version,s=ue.getParameters(e,r.state,x.state.shadowsArray,t,i),a=ue.getProgramCacheKey(s);let l=n.programs;n.environment=e.isMeshStandardMaterial?t.environment:null,n.fog=t.fog,n.envMap=(e.isMeshStandardMaterial?se:oe).get(e.envMap||n.environment),n.envMapRotation=null!==n.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===l&&(e.addEventListener("dispose",Pe),l=new Map,n.programs=l);let c=l.get(a);if(void 0!==c){if(n.currentProgram===c&&n.lightsStateVersion===o)return je(e,s),c}else s.uniforms=ue.getUniforms(e),e.onBeforeCompile(s,E),c=ue.acquireProgram(s,a),l.set(a,c),n.uniforms=s.uniforms;const u=n.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(u.clippingPlanes=fe.uniform),je(e,s),n.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),n.lightsStateVersion=o,n.needsLights&&(u.ambientLightColor.value=r.state.ambient,u.lightProbe.value=r.state.probe,u.directionalLights.value=r.state.directional,u.directionalLightShadows.value=r.state.directionalShadow,u.spotLights.value=r.state.spot,u.spotLightShadows.value=r.state.spotShadow,u.rectAreaLights.value=r.state.rectArea,u.ltc_1.value=r.state.rectAreaLTC1,u.ltc_2.value=r.state.rectAreaLTC2,u.pointLights.value=r.state.point,u.pointLightShadows.value=r.state.pointShadow,u.hemisphereLights.value=r.state.hemi,u.directionalShadowMap.value=r.state.directionalShadowMap,u.directionalShadowMatrix.value=r.state.directionalShadowMatrix,u.spotShadowMap.value=r.state.spotShadowMap,u.spotLightMatrix.value=r.state.spotLightMatrix,u.spotLightMap.value=r.state.spotLightMap,u.pointShadowMap.value=r.state.pointShadowMap,u.pointShadowMatrix.value=r.state.pointShadowMatrix),n.currentProgram=c,n.uniformsList=null,c}function Ge(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=WebGLUniforms.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function je(e,t){const i=ne.get(e);i.outputColorSpace=t.outputColorSpace,i.batching=t.batching,i.batchingColor=t.batchingColor,i.instancing=t.instancing,i.instancingColor=t.instancingColor,i.instancingMorph=t.instancingMorph,i.skinning=t.skinning,i.morphTargets=t.morphTargets,i.morphNormals=t.morphNormals,i.morphColors=t.morphColors,i.morphTargetsCount=t.morphTargetsCount,i.numClippingPlanes=t.numClippingPlanes,i.numIntersection=t.numClipIntersection,i.vertexAlphas=t.vertexAlphas,i.vertexTangents=t.vertexTangents,i.toneMapping=t.toneMapping}Be.setAnimationLoop((function(e){Re&&Re(e)})),"undefined"!=typeof self&&Be.setContext(self),this.setAnimationLoop=function(e){Re=e,Ae.setAnimationLoop(e),null===e?Be.stop():Be.start()},Ae.addEventListener("sessionstart",Oe),Ae.addEventListener("sessionend",De),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return void error("WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===S)return;const i=null!==w&&(null===I||!0===Ae.enabled&&!0===Ae.isPresenting)&&w.begin(E,I);if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0!==Ae.enabled||!0!==Ae.isPresenting||null!==w&&!1!==w.isCompositing()||(!0===Ae.cameraAutoUpdate&&Ae.updateCamera(t),t=Ae.getCamera()),!0===e.isScene&&e.onBeforeRender(E,e,t,I),x=pe.get(e,T.length),x.init(t),T.push(x),q.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),H.setFromProjectionMatrix(q,WebGLCoordinateSystem,t.reversedDepth),W=this.localClippingEnabled,$=fe.init(this.clippingPlanes,W),v=de.get(e,b.length),v.init(),b.push(v),!0===Ae.enabled&&!0===Ae.isPresenting){const e=E.xr.getDepthSensingMesh();null!==e&&Fe(e,t,-1/0,E.sortObjects)}Fe(e,t,0,E.sortObjects),v.finish(),!0===E.sortObjects&&v.sort(U,z),J=!1===Ae.enabled||!1===Ae.isPresenting||!1===Ae.hasDepthSensing(),J&&ge.addToRenderList(v,e),this.info.render.frame++,!0===$&&fe.beginShadows();me.render(x.state.shadowsArray,e,t),!0===$&&fe.endShadows(),!0===this.info.autoReset&&this.info.reset();if(!1===(i&&w.hasRenderPass())){const i=v.opaque,n=v.transmissive;if(x.setupLights(),t.isArrayCamera){const r=t.cameras;if(n.length>0)for(let t=0,o=r.length;t<o;t++){ke(i,n,e,r[t])}J&&ge.render(e);for(let t=0,i=r.length;t<i;t++){const i=r[t];Ne(v,e,i,i.viewport)}}else n.length>0&&ke(i,n,e,t),J&&ge.render(e),Ne(v,e,t)}null!==I&&0===M&&(re.updateMultisampleRenderTarget(I),re.updateRenderTargetMipmap(I)),i&&w.end(E),!0===e.isScene&&e.onAfterRender(E,e,t),be.resetDefaultState(),C=-1,P=null,T.pop(),T.length>0?(x=T[T.length-1],!0===$&&fe.setGlobalState(E.clippingPlanes,x.state.camera)):x=null,b.pop(),v=b.length>0?b[b.length-1]:null},this.getActiveCubeFace=function(){return A},this.getActiveMipmapLevel=function(){return M},this.getRenderTarget=function(){return I},this.setRenderTargetTextures=function(e,t,i){const n=ne.get(e);n.__autoAllocateDepthBuffer=!1===e.resolveDepthBuffer,!1===n.__autoAllocateDepthBuffer&&(n.__useRenderToTexture=!1),ne.get(e.texture).__webglTexture=t,ne.get(e.depthTexture).__webglTexture=n.__autoAllocateDepthBuffer?void 0:i,n.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(e,t){const i=ne.get(e);i.__webglFramebuffer=t,i.__useDefaultFramebuffer=void 0===t};const He=we.createFramebuffer();this.setRenderTarget=function(e,t=0,i=0){I=e,A=t,M=i;let n=null,r=!1,o=!1;if(e){const s=ne.get(e);if(void 0!==s.__useDefaultFramebuffer)return te.bindFramebuffer(we.FRAMEBUFFER,s.__webglFramebuffer),L.copy(e.viewport),R.copy(e.scissor),O=e.scissorTest,te.viewport(L),te.scissor(R),te.setScissorTest(O),void(C=-1);if(void 0===s.__webglFramebuffer)re.setupRenderTarget(e);else if(s.__hasExternalTextures)re.rebindTextures(e,ne.get(e.texture).__webglTexture,ne.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(s.__boundDepthTexture!==t){if(null!==t&&ne.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");re.setupDepthRenderbuffer(e)}}const a=e.texture;(a.isData3DTexture||a.isDataArrayTexture||a.isCompressedArrayTexture)&&(o=!0);const l=ne.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=Array.isArray(l[t])?l[t][i]:l[t],r=!0):n=e.samples>0&&!1===re.useMultisampledRTT(e)?ne.get(e).__webglMultisampledFramebuffer:Array.isArray(l)?l[i]:l,L.copy(e.viewport),R.copy(e.scissor),O=e.scissorTest}else L.copy(V).multiplyScalar(k).floor(),R.copy(G).multiplyScalar(k).floor(),O=j;0!==i&&(n=He);if(te.bindFramebuffer(we.FRAMEBUFFER,n)&&te.drawBuffers(e,n),te.viewport(L),te.scissor(R),te.setScissorTest(O),r){const n=ne.get(e.texture);we.framebufferTexture2D(we.FRAMEBUFFER,we.COLOR_ATTACHMENT0,we.TEXTURE_CUBE_MAP_POSITIVE_X+t,n.__webglTexture,i)}else if(o){const n=t;for(let t=0;t<e.textures.length;t++){const r=ne.get(e.textures[t]);we.framebufferTextureLayer(we.FRAMEBUFFER,we.COLOR_ATTACHMENT0+t,r.__webglTexture,i,n)}}else if(null!==e&&0!==i){const t=ne.get(e.texture);we.framebufferTexture2D(we.FRAMEBUFFER,we.COLOR_ATTACHMENT0,we.TEXTURE_2D,t.__webglTexture,i)}C=-1},this.readRenderTargetPixels=function(e,t,i,n,r,o,s,a=0){if(!e||!e.isWebGLRenderTarget)return void error("WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=ne.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==s&&(l=l[s]),l){te.bindFramebuffer(we.FRAMEBUFFER,l);try{const s=e.textures[a],l=s.format,c=s.type;if(!ee.textureFormatReadable(l))return void error("WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!ee.textureTypeReadable(c))return void error("WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");t>=0&&t<=e.width-n&&i>=0&&i<=e.height-r&&(e.textures.length>1&&we.readBuffer(we.COLOR_ATTACHMENT0+a),we.readPixels(t,i,n,r,xe.convert(l),xe.convert(c),o))}finally{const e=null!==I?ne.get(I).__webglFramebuffer:null;te.bindFramebuffer(we.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,i,n,r,o,s,a=0){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=ne.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==s&&(l=l[s]),l){if(t>=0&&t<=e.width-n&&i>=0&&i<=e.height-r){te.bindFramebuffer(we.FRAMEBUFFER,l);const s=e.textures[a],c=s.format,u=s.type;if(!ee.textureFormatReadable(c))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!ee.textureTypeReadable(u))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");const h=we.createBuffer();we.bindBuffer(we.PIXEL_PACK_BUFFER,h),we.bufferData(we.PIXEL_PACK_BUFFER,o.byteLength,we.STREAM_READ),e.textures.length>1&&we.readBuffer(we.COLOR_ATTACHMENT0+a),we.readPixels(t,i,n,r,xe.convert(c),xe.convert(u),0);const d=null!==I?ne.get(I).__webglFramebuffer:null;te.bindFramebuffer(we.FRAMEBUFFER,d);const p=we.fenceSync(we.SYNC_GPU_COMMANDS_COMPLETE,0);return we.flush(),await probeAsync(we,p,4),we.bindBuffer(we.PIXEL_PACK_BUFFER,h),we.getBufferSubData(we.PIXEL_PACK_BUFFER,0,o),we.deleteBuffer(h),we.deleteSync(p),o}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,i=0){const n=Math.pow(2,-i),r=Math.floor(e.image.width*n),o=Math.floor(e.image.height*n),s=null!==t?t.x:0,a=null!==t?t.y:0;re.setTexture2D(e,0),we.copyTexSubImage2D(we.TEXTURE_2D,i,0,0,s,a,r,o),te.unbindTexture()};const $e=we.createFramebuffer(),We=we.createFramebuffer();this.copyTextureToTexture=function(e,t,i=null,n=null,r=0,o=null){let s,a,l,c,u,h,d,p,f;null===o&&(0!==r?(warnOnce("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),o=r,r=0):o=0);const m=e.isCompressedTexture?e.mipmaps[o]:e.image;if(null!==i)s=i.max.x-i.min.x,a=i.max.y-i.min.y,l=i.isBox3?i.max.z-i.min.z:1,c=i.min.x,u=i.min.y,h=i.isBox3?i.min.z:0;else{const t=Math.pow(2,-r);s=Math.floor(m.width*t),a=Math.floor(m.height*t),l=e.isDataArrayTexture?m.depth:e.isData3DTexture?Math.floor(m.depth*t):1,c=0,u=0,h=0}null!==n?(d=n.x,p=n.y,f=n.z):(d=0,p=0,f=0);const g=xe.convert(t.format),_=xe.convert(t.type);let y;t.isData3DTexture?(re.setTexture3D(t,0),y=we.TEXTURE_3D):t.isDataArrayTexture||t.isCompressedArrayTexture?(re.setTexture2DArray(t,0),y=we.TEXTURE_2D_ARRAY):(re.setTexture2D(t,0),y=we.TEXTURE_2D),we.pixelStorei(we.UNPACK_FLIP_Y_WEBGL,t.flipY),we.pixelStorei(we.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),we.pixelStorei(we.UNPACK_ALIGNMENT,t.unpackAlignment);const v=we.getParameter(we.UNPACK_ROW_LENGTH),x=we.getParameter(we.UNPACK_IMAGE_HEIGHT),b=we.getParameter(we.UNPACK_SKIP_PIXELS),T=we.getParameter(we.UNPACK_SKIP_ROWS),w=we.getParameter(we.UNPACK_SKIP_IMAGES);we.pixelStorei(we.UNPACK_ROW_LENGTH,m.width),we.pixelStorei(we.UNPACK_IMAGE_HEIGHT,m.height),we.pixelStorei(we.UNPACK_SKIP_PIXELS,c),we.pixelStorei(we.UNPACK_SKIP_ROWS,u),we.pixelStorei(we.UNPACK_SKIP_IMAGES,h);const E=e.isDataArrayTexture||e.isData3DTexture,S=t.isDataArrayTexture||t.isData3DTexture;if(e.isDepthTexture){const i=ne.get(e),n=ne.get(t),m=ne.get(i.__renderTarget),g=ne.get(n.__renderTarget);te.bindFramebuffer(we.READ_FRAMEBUFFER,m.__webglFramebuffer),te.bindFramebuffer(we.DRAW_FRAMEBUFFER,g.__webglFramebuffer);for(let i=0;i<l;i++)E&&(we.framebufferTextureLayer(we.READ_FRAMEBUFFER,we.COLOR_ATTACHMENT0,ne.get(e).__webglTexture,r,h+i),we.framebufferTextureLayer(we.DRAW_FRAMEBUFFER,we.COLOR_ATTACHMENT0,ne.get(t).__webglTexture,o,f+i)),we.blitFramebuffer(c,u,s,a,d,p,s,a,we.DEPTH_BUFFER_BIT,we.NEAREST);te.bindFramebuffer(we.READ_FRAMEBUFFER,null),te.bindFramebuffer(we.DRAW_FRAMEBUFFER,null)}else if(0!==r||e.isRenderTargetTexture||ne.has(e)){const i=ne.get(e),n=ne.get(t);te.bindFramebuffer(we.READ_FRAMEBUFFER,$e),te.bindFramebuffer(we.DRAW_FRAMEBUFFER,We);for(let e=0;e<l;e++)E?we.framebufferTextureLayer(we.READ_FRAMEBUFFER,we.COLOR_ATTACHMENT0,i.__webglTexture,r,h+e):we.framebufferTexture2D(we.READ_FRAMEBUFFER,we.COLOR_ATTACHMENT0,we.TEXTURE_2D,i.__webglTexture,r),S?we.framebufferTextureLayer(we.DRAW_FRAMEBUFFER,we.COLOR_ATTACHMENT0,n.__webglTexture,o,f+e):we.framebufferTexture2D(we.DRAW_FRAMEBUFFER,we.COLOR_ATTACHMENT0,we.TEXTURE_2D,n.__webglTexture,o),0!==r?we.blitFramebuffer(c,u,s,a,d,p,s,a,we.COLOR_BUFFER_BIT,we.NEAREST):S?we.copyTexSubImage3D(y,o,d,p,f+e,c,u,s,a):we.copyTexSubImage2D(y,o,d,p,c,u,s,a);te.bindFramebuffer(we.READ_FRAMEBUFFER,null),te.bindFramebuffer(we.DRAW_FRAMEBUFFER,null)}else S?e.isDataTexture||e.isData3DTexture?we.texSubImage3D(y,o,d,p,f,s,a,l,g,_,m.data):t.isCompressedArrayTexture?we.compressedTexSubImage3D(y,o,d,p,f,s,a,l,g,m.data):we.texSubImage3D(y,o,d,p,f,s,a,l,g,_,m):e.isDataTexture?we.texSubImage2D(we.TEXTURE_2D,o,d,p,s,a,g,_,m.data):e.isCompressedTexture?we.compressedTexSubImage2D(we.TEXTURE_2D,o,d,p,m.width,m.height,g,m.data):we.texSubImage2D(we.TEXTURE_2D,o,d,p,s,a,g,_,m);we.pixelStorei(we.UNPACK_ROW_LENGTH,v),we.pixelStorei(we.UNPACK_IMAGE_HEIGHT,x),we.pixelStorei(we.UNPACK_SKIP_PIXELS,b),we.pixelStorei(we.UNPACK_SKIP_ROWS,T),we.pixelStorei(we.UNPACK_SKIP_IMAGES,w),0===o&&t.generateMipmaps&&we.generateMipmap(y),te.unbindTexture()},this.initRenderTarget=function(e){void 0===ne.get(e).__webglFramebuffer&&re.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?re.setTextureCube(e,0):e.isData3DTexture?re.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?re.setTexture2DArray(e,0):re.setTexture2D(e,0),te.unbindTexture()},this.resetState=function(){A=0,M=0,I=null,te.reset(),be.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return WebGLCoordinateSystem}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=ColorManagement._getDrawingBufferColorSpace(e),t.unpackColorSpace=ColorManagement._getUnpackColorSpace()}}var three=Object.freeze({__proto__:null,ACESFilmicToneMapping:ACESFilmicToneMapping,AddEquation:AddEquation,AddOperation:AddOperation,AdditiveAnimationBlendMode:AdditiveAnimationBlendMode,AdditiveBlending:AdditiveBlending,AgXToneMapping:AgXToneMapping,AlphaFormat:AlphaFormat,AlwaysCompare:AlwaysCompare,AlwaysDepth:AlwaysDepth,AlwaysStencilFunc:AlwaysStencilFunc,AmbientLight:AmbientLight,AnimationAction:AnimationAction,AnimationClip:AnimationClip,AnimationLoader:AnimationLoader,AnimationMixer:AnimationMixer,AnimationObjectGroup:AnimationObjectGroup,AnimationUtils:AnimationUtils,ArcCurve:ArcCurve,ArrayCamera:ArrayCamera,ArrowHelper:ArrowHelper,AttachedBindMode:AttachedBindMode,Audio:Audio,AudioAnalyser:AudioAnalyser,AudioContext:AudioContext,AudioListener:AudioListener,AudioLoader:AudioLoader,AxesHelper:AxesHelper,BackSide:BackSide,BasicDepthPacking:BasicDepthPacking,BasicShadowMap:BasicShadowMap,BatchedMesh:BatchedMesh,Bone:Bone,BooleanKeyframeTrack:BooleanKeyframeTrack,Box2:Box2,Box3:Box3,Box3Helper:Box3Helper,BoxGeometry:BoxGeometry,BoxHelper:BoxHelper,BufferAttribute:BufferAttribute,BufferGeometry:BufferGeometry,BufferGeometryLoader:BufferGeometryLoader,ByteType:ByteType,Cache:Cache,Camera:Camera,CameraHelper:CameraHelper,CanvasTexture:CanvasTexture,CapsuleGeometry:CapsuleGeometry,CatmullRomCurve3:CatmullRomCurve3,CineonToneMapping:CineonToneMapping,CircleGeometry:CircleGeometry,ClampToEdgeWrapping:ClampToEdgeWrapping,Clock:Clock,Color:Color,ColorKeyframeTrack:ColorKeyframeTrack,ColorManagement:ColorManagement,CompressedArrayTexture:CompressedArrayTexture,CompressedCubeTexture:CompressedCubeTexture,CompressedTexture:CompressedTexture,CompressedTextureLoader:CompressedTextureLoader,ConeGeometry:ConeGeometry,ConstantAlphaFactor:ConstantAlphaFactor,ConstantColorFactor:ConstantColorFactor,Controls:Controls,CubeCamera:CubeCamera,CubeDepthTexture:CubeDepthTexture,CubeReflectionMapping:CubeReflectionMapping,CubeRefractionMapping:CubeRefractionMapping,CubeTexture:CubeTexture,CubeTextureLoader:CubeTextureLoader,CubeUVReflectionMapping:CubeUVReflectionMapping,CubicBezierCurve:CubicBezierCurve,CubicBezierCurve3:CubicBezierCurve3,CubicInterpolant:CubicInterpolant,CullFaceBack:CullFaceBack,CullFaceFront:CullFaceFront,CullFaceFrontBack:CullFaceFrontBack,CullFaceNone:CullFaceNone,Curve:Curve,CurvePath:CurvePath,CustomBlending:CustomBlending,CustomToneMapping:CustomToneMapping,CylinderGeometry:CylinderGeometry,Cylindrical:Cylindrical,Data3DTexture:Data3DTexture,DataArrayTexture:DataArrayTexture,DataTexture:DataTexture,DataTextureLoader:DataTextureLoader,DataUtils:DataUtils,DecrementStencilOp:DecrementStencilOp,DecrementWrapStencilOp:DecrementWrapStencilOp,DefaultLoadingManager:DefaultLoadingManager,DepthFormat:DepthFormat,DepthStencilFormat:DepthStencilFormat,DepthTexture:DepthTexture,DetachedBindMode:DetachedBindMode,DirectionalLight:DirectionalLight,DirectionalLightHelper:DirectionalLightHelper,DiscreteInterpolant:DiscreteInterpolant,DodecahedronGeometry:DodecahedronGeometry,DoubleSide:DoubleSide,DstAlphaFactor:DstAlphaFactor,DstColorFactor:DstColorFactor,DynamicCopyUsage:DynamicCopyUsage,DynamicDrawUsage:DynamicDrawUsage,DynamicReadUsage:DynamicReadUsage,EdgesGeometry:EdgesGeometry,EllipseCurve:EllipseCurve,EqualCompare:EqualCompare,EqualDepth:EqualDepth,EqualStencilFunc:EqualStencilFunc,EquirectangularReflectionMapping:EquirectangularReflectionMapping,EquirectangularRefractionMapping:EquirectangularRefractionMapping,Euler:Euler,EventDispatcher:EventDispatcher,ExternalTexture:ExternalTexture,ExtrudeGeometry:ExtrudeGeometry,FileLoader:FileLoader,Float16BufferAttribute:Float16BufferAttribute,Float32BufferAttribute:Float32BufferAttribute,FloatType:FloatType,Fog:Fog,FogExp2:FogExp2,FramebufferTexture:FramebufferTexture,FrontSide:FrontSide,Frustum:Frustum,FrustumArray:FrustumArray,GLBufferAttribute:GLBufferAttribute,GLSL1:GLSL1,GLSL3:GLSL3,GreaterCompare:GreaterCompare,GreaterDepth:GreaterDepth,GreaterEqualCompare:GreaterEqualCompare,GreaterEqualDepth:GreaterEqualDepth,GreaterEqualStencilFunc:GreaterEqualStencilFunc,GreaterStencilFunc:GreaterStencilFunc,GridHelper:GridHelper,Group:Group,HalfFloatType:HalfFloatType,HemisphereLight:HemisphereLight,HemisphereLightHelper:HemisphereLightHelper,IcosahedronGeometry:IcosahedronGeometry,ImageBitmapLoader:ImageBitmapLoader,ImageLoader:ImageLoader,ImageUtils:ImageUtils,IncrementStencilOp:IncrementStencilOp,IncrementWrapStencilOp:IncrementWrapStencilOp,InstancedBufferAttribute:InstancedBufferAttribute,InstancedBufferGeometry:InstancedBufferGeometry,InstancedInterleavedBuffer:InstancedInterleavedBuffer,InstancedMesh:InstancedMesh,Int16BufferAttribute:Int16BufferAttribute,Int32BufferAttribute:Int32BufferAttribute,Int8BufferAttribute:Int8BufferAttribute,IntType:IntType,InterleavedBuffer:InterleavedBuffer,InterleavedBufferAttribute:InterleavedBufferAttribute,Interpolant:Interpolant,InterpolateDiscrete:InterpolateDiscrete,InterpolateLinear:InterpolateLinear,InterpolateSmooth:InterpolateSmooth,InterpolationSamplingMode:InterpolationSamplingMode,InterpolationSamplingType:InterpolationSamplingType,InvertStencilOp:InvertStencilOp,KeepStencilOp:KeepStencilOp,KeyframeTrack:KeyframeTrack,LOD:LOD,LatheGeometry:LatheGeometry,Layers:Layers,LessCompare:LessCompare,LessDepth:LessDepth,LessEqualCompare:LessEqualCompare,LessEqualDepth:LessEqualDepth,LessEqualStencilFunc:LessEqualStencilFunc,LessStencilFunc:LessStencilFunc,Light:Light,LightProbe:LightProbe,Line:Line,Line3:Line3,LineBasicMaterial:LineBasicMaterial,LineCurve:LineCurve,LineCurve3:LineCurve3,LineDashedMaterial:LineDashedMaterial,LineLoop:LineLoop,LineSegments:LineSegments,LinearFilter:LinearFilter,LinearInterpolant:LinearInterpolant,LinearMipMapLinearFilter:LinearMipMapLinearFilter,LinearMipMapNearestFilter:LinearMipMapNearestFilter,LinearMipmapLinearFilter:LinearMipmapLinearFilter,LinearMipmapNearestFilter:LinearMipmapNearestFilter,LinearSRGBColorSpace:LinearSRGBColorSpace,LinearToneMapping:LinearToneMapping,LinearTransfer:LinearTransfer,Loader:Loader,LoaderUtils:LoaderUtils,LoadingManager:LoadingManager,LoopOnce:LoopOnce,LoopPingPong:LoopPingPong,LoopRepeat:LoopRepeat,MOUSE:MOUSE,Material:Material,MaterialLoader:MaterialLoader,MathUtils:MathUtils,Matrix2:Matrix2,Matrix3:Matrix3,Matrix4:Matrix4,MaxEquation:MaxEquation,Mesh:Mesh,MeshBasicMaterial:MeshBasicMaterial,MeshDepthMaterial:MeshDepthMaterial,MeshDistanceMaterial:MeshDistanceMaterial,MeshLambertMaterial:MeshLambertMaterial,MeshMatcapMaterial:MeshMatcapMaterial,MeshNormalMaterial:MeshNormalMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshPhysicalMaterial:MeshPhysicalMaterial,MeshStandardMaterial:MeshStandardMaterial,MeshToonMaterial:MeshToonMaterial,MinEquation:MinEquation,MirroredRepeatWrapping:MirroredRepeatWrapping,MixOperation:MixOperation,MultiplyBlending:MultiplyBlending,MultiplyOperation:MultiplyOperation,NearestFilter:NearestFilter,NearestMipMapLinearFilter:NearestMipMapLinearFilter,NearestMipMapNearestFilter:NearestMipMapNearestFilter,NearestMipmapLinearFilter:NearestMipmapLinearFilter,NearestMipmapNearestFilter:NearestMipmapNearestFilter,NeutralToneMapping:NeutralToneMapping,NeverCompare:NeverCompare,NeverDepth:NeverDepth,NeverStencilFunc:NeverStencilFunc,NoBlending:NoBlending,NoColorSpace:NoColorSpace,NoNormalPacking:NoNormalPacking,NoToneMapping:NoToneMapping,NormalAnimationBlendMode:NormalAnimationBlendMode,NormalBlending:NormalBlending,NormalGAPacking:NormalGAPacking,NormalRGPacking:NormalRGPacking,NotEqualCompare:NotEqualCompare,NotEqualDepth:NotEqualDepth,NotEqualStencilFunc:NotEqualStencilFunc,NumberKeyframeTrack:NumberKeyframeTrack,Object3D:Object3D,ObjectLoader:ObjectLoader,ObjectSpaceNormalMap:ObjectSpaceNormalMap,OctahedronGeometry:OctahedronGeometry,OneFactor:OneFactor,OneMinusConstantAlphaFactor:OneMinusConstantAlphaFactor,OneMinusConstantColorFactor:OneMinusConstantColorFactor,OneMinusDstAlphaFactor:OneMinusDstAlphaFactor,OneMinusDstColorFactor:OneMinusDstColorFactor,OneMinusSrcAlphaFactor:OneMinusSrcAlphaFactor,OneMinusSrcColorFactor:OneMinusSrcColorFactor,OrthographicCamera:OrthographicCamera,PCFShadowMap:PCFShadowMap,PCFSoftShadowMap:PCFSoftShadowMap,PMREMGenerator:PMREMGenerator,Path:Path,PerspectiveCamera:PerspectiveCamera,Plane:Plane$1,PlaneGeometry:PlaneGeometry,PlaneHelper:PlaneHelper,PointLight:PointLight,PointLightHelper:PointLightHelper,Points:Points,PointsMaterial:PointsMaterial,PolarGridHelper:PolarGridHelper,PolyhedronGeometry:PolyhedronGeometry,PositionalAudio:PositionalAudio,PropertyBinding:PropertyBinding,PropertyMixer:PropertyMixer,QuadraticBezierCurve:QuadraticBezierCurve,QuadraticBezierCurve3:QuadraticBezierCurve3,Quaternion:Quaternion,QuaternionKeyframeTrack:QuaternionKeyframeTrack,QuaternionLinearInterpolant:QuaternionLinearInterpolant,R11_EAC_Format:R11_EAC_Format,RED_GREEN_RGTC2_Format:RED_GREEN_RGTC2_Format,RED_RGTC1_Format:RED_RGTC1_Format,REVISION:REVISION,RG11_EAC_Format:RG11_EAC_Format,RGBADepthPacking:RGBADepthPacking,RGBAFormat:RGBAFormat,RGBAIntegerFormat:RGBAIntegerFormat,RGBA_ASTC_10x10_Format:RGBA_ASTC_10x10_Format,RGBA_ASTC_10x5_Format:RGBA_ASTC_10x5_Format,RGBA_ASTC_10x6_Format:RGBA_ASTC_10x6_Format,RGBA_ASTC_10x8_Format:RGBA_ASTC_10x8_Format,RGBA_ASTC_12x10_Format:RGBA_ASTC_12x10_Format,RGBA_ASTC_12x12_Format:RGBA_ASTC_12x12_Format,RGBA_ASTC_4x4_Format:RGBA_ASTC_4x4_Format,RGBA_ASTC_5x4_Format:RGBA_ASTC_5x4_Format,RGBA_ASTC_5x5_Format:RGBA_ASTC_5x5_Format,RGBA_ASTC_6x5_Format:RGBA_ASTC_6x5_Format,RGBA_ASTC_6x6_Format:RGBA_ASTC_6x6_Format,RGBA_ASTC_8x5_Format:RGBA_ASTC_8x5_Format,RGBA_ASTC_8x6_Format:RGBA_ASTC_8x6_Format,RGBA_ASTC_8x8_Format:RGBA_ASTC_8x8_Format,RGBA_BPTC_Format:RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:RGBA_ETC2_EAC_Format,RGBA_PVRTC_2BPPV1_Format:RGBA_PVRTC_2BPPV1_Format,RGBA_PVRTC_4BPPV1_Format:RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT1_Format:RGBA_S3TC_DXT1_Format,RGBA_S3TC_DXT3_Format:RGBA_S3TC_DXT3_Format,RGBA_S3TC_DXT5_Format:RGBA_S3TC_DXT5_Format,RGBDepthPacking:RGBDepthPacking,RGBFormat:RGBFormat,RGBIntegerFormat:RGBIntegerFormat,RGB_BPTC_SIGNED_Format:RGB_BPTC_SIGNED_Format,RGB_BPTC_UNSIGNED_Format:RGB_BPTC_UNSIGNED_Format,RGB_ETC1_Format:RGB_ETC1_Format,RGB_ETC2_Format:RGB_ETC2_Format,RGB_PVRTC_2BPPV1_Format:RGB_PVRTC_2BPPV1_Format,RGB_PVRTC_4BPPV1_Format:RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:RGB_S3TC_DXT1_Format,RGDepthPacking:RGDepthPacking,RGFormat:RGFormat,RGIntegerFormat:RGIntegerFormat,RawShaderMaterial:RawShaderMaterial,Ray:Ray,Raycaster:Raycaster,RectAreaLight:RectAreaLight,RedFormat:RedFormat,RedIntegerFormat:RedIntegerFormat,ReinhardToneMapping:ReinhardToneMapping,RenderTarget:RenderTarget,RenderTarget3D:RenderTarget3D,RepeatWrapping:RepeatWrapping,ReplaceStencilOp:ReplaceStencilOp,ReverseSubtractEquation:ReverseSubtractEquation,RingGeometry:RingGeometry,SIGNED_R11_EAC_Format:SIGNED_R11_EAC_Format,SIGNED_RED_GREEN_RGTC2_Format:SIGNED_RED_GREEN_RGTC2_Format,SIGNED_RED_RGTC1_Format:SIGNED_RED_RGTC1_Format,SIGNED_RG11_EAC_Format:SIGNED_RG11_EAC_Format,SRGBColorSpace:SRGBColorSpace,SRGBTransfer:SRGBTransfer,Scene:Scene,ShaderChunk:ShaderChunk,ShaderLib:ShaderLib,ShaderMaterial:ShaderMaterial,ShadowMaterial:ShadowMaterial,Shape:Shape,ShapeGeometry:ShapeGeometry,ShapePath:ShapePath,ShapeUtils:ShapeUtils,ShortType:ShortType,Skeleton:Skeleton,SkeletonHelper:SkeletonHelper,SkinnedMesh:SkinnedMesh,Source:Source,Sphere:Sphere,SphereGeometry:SphereGeometry,Spherical:Spherical,SphericalHarmonics3:SphericalHarmonics3,SplineCurve:SplineCurve,SpotLight:SpotLight,SpotLightHelper:SpotLightHelper,Sprite:Sprite,SpriteMaterial:SpriteMaterial,SrcAlphaFactor:SrcAlphaFactor,SrcAlphaSaturateFactor:SrcAlphaSaturateFactor,SrcColorFactor:SrcColorFactor,StaticCopyUsage:StaticCopyUsage,StaticDrawUsage:StaticDrawUsage,StaticReadUsage:StaticReadUsage,StereoCamera:StereoCamera,StreamCopyUsage:StreamCopyUsage,StreamDrawUsage:StreamDrawUsage,StreamReadUsage:StreamReadUsage,StringKeyframeTrack:StringKeyframeTrack,SubtractEquation:SubtractEquation,SubtractiveBlending:SubtractiveBlending,TOUCH:TOUCH,TangentSpaceNormalMap:TangentSpaceNormalMap,TetrahedronGeometry:TetrahedronGeometry,Texture:Texture,TextureLoader:TextureLoader,TextureUtils:TextureUtils,Timer:Timer,TimestampQuery:TimestampQuery,TorusGeometry:TorusGeometry,TorusKnotGeometry:TorusKnotGeometry,Triangle:Triangle,TriangleFanDrawMode:TriangleFanDrawMode,TriangleStripDrawMode:TriangleStripDrawMode,TrianglesDrawMode:TrianglesDrawMode,TubeGeometry:TubeGeometry,UVMapping:UVMapping,Uint16BufferAttribute:Uint16BufferAttribute,Uint32BufferAttribute:Uint32BufferAttribute,Uint8BufferAttribute:Uint8BufferAttribute,Uint8ClampedBufferAttribute:Uint8ClampedBufferAttribute,Uniform:Uniform,UniformsGroup:UniformsGroup,UniformsLib:UniformsLib,UniformsUtils:UniformsUtils,UnsignedByteType:UnsignedByteType,UnsignedInt101111Type:UnsignedInt101111Type,UnsignedInt248Type:UnsignedInt248Type,UnsignedInt5999Type:UnsignedInt5999Type,UnsignedIntType:UnsignedIntType,UnsignedShort4444Type:UnsignedShort4444Type,UnsignedShort5551Type:UnsignedShort5551Type,UnsignedShortType:UnsignedShortType,VSMShadowMap:VSMShadowMap,Vector2:Vector2,Vector3:Vector3,Vector4:Vector4,VectorKeyframeTrack:VectorKeyframeTrack,VideoFrameTexture:VideoFrameTexture,VideoTexture:VideoTexture,WebGL3DRenderTarget:WebGL3DRenderTarget,WebGLArrayRenderTarget:WebGLArrayRenderTarget,WebGLCoordinateSystem:WebGLCoordinateSystem,WebGLCubeRenderTarget:WebGLCubeRenderTarget,WebGLRenderTarget:WebGLRenderTarget,WebGLRenderer:WebGLRenderer,WebGLUtils:WebGLUtils,WebGPUCoordinateSystem:WebGPUCoordinateSystem,WebXRController:WebXRController,WireframeGeometry:WireframeGeometry,WrapAroundEnding:WrapAroundEnding,ZeroCurvatureEnding:ZeroCurvatureEnding,ZeroFactor:ZeroFactor,ZeroSlopeEnding:ZeroSlopeEnding,ZeroStencilOp:ZeroStencilOp,createCanvasElement:createCanvasElement,error:error,getConsoleFunction:getConsoleFunction,log:log,setConsoleFunction:setConsoleFunction,warn:warn,warnOnce:warnOnce});const SQRT3=Math.sqrt(3);class ThreeLayer{constructor(e){const t=this;t.implementation=e,t._tick=t._tick.bind(t),t._onResize=t._onResize.bind(t)}onAdd(e,t){const i=this,n=i.implementation,r=n.id,o=e.map;i.map=e,i.modelOrigin=e.getModelOrigin(),o.addLayer({id:r,type:"custom",renderingMode:"3d",onAdd:(t,r)=>{i._onAdd(t,r),n.onAdd&&n.onAdd(e,{renderer:i.renderer,scene:i.scene,camera:i.camera})},onRemove:(t,r)=>{i._onRemove(t,r),n.onRemove&&n.onRemove(e,{renderer:i.renderer,scene:i.scene,camera:i.camera})},prerender:()=>{n.prerender&&n.prerender(e,{renderer:i.renderer,scene:i.scene,camera:i.camera})},render:i._render.bind(i)},t||"poi"),o.setLayerZoomRange(r,n.minzoom,n.maxzoom)}_onAdd(e,t){const i=this,{_fov:n,width:r,height:o}=e.transform,s=i.renderer=new WebGLRenderer({canvas:e.getCanvas(),context:t}),a=i.scene=new Scene,l=valueOrDefault(i.implementation.lightColor,(new Color).copy(i.map.getLightColor())),c=i.light=new DirectionalLight(l,.8*Math.PI),u=i.ambientLight=new AmbientLight(l,.4*Math.PI);s.outputColorSpace=LinearSRGBColorSpace,s.autoClear=!1,a.add(c),a.add(u),a.add(new Mesh),i.mbox=e,i.camera=new PerspectiveCamera(MathUtils.radToDeg(n),r/o),e.on("resize",i._onResize),void 0===i.implementation.lightColor&&i._tick()}_tick(){const e=this,t=e.map,i=t.clock.getTime();if(Math.floor(i/6e4)!==Math.floor(e.lastRefresh/6e4)){const n=t.getLightColor();e.light.color.copy(n),e.ambientLight.color.copy(n),e.lastRefresh=i}e.mbox&&requestAnimationFrame(e._tick)}_onRemove(e){e.off("resize",this._onResize),delete this.mbox}_render(e,t){const{modelOrigin:i,mbox:n,renderer:r,camera:o,light:s,scene:a}=this,{_fov:l,_camera:c,_horizonShift:u,pixelsPerMeter:h,worldSize:d,_pitch:p,width:f,height:m}=n.transform,g=l/2,_=c.position[2]*d/Math.cos(p),y=_/u,v=1e3*h/Math.cos(p),x=o.far=Math.max(y,_+v),b=o.near=m/50,T=Math.tan(g)*b,w=T*f/m,E=(new Matrix4).fromArray(t),S=(new Matrix4).makeTranslation(i.x,i.y,0).scale(new Vector3(1,-1,1));o.projectionMatrix.makePerspective(-w,w,T,-T,b,x).clone().invert().multiply(E).multiply(S).invert().decompose(o.position,o.quaternion,o.scale);const A=MathUtils.degToRad(n.getBearing()+30);s.position.set(-Math.sin(A),-Math.cos(A),SQRT3).normalize(),r.resetState(),r.render(a,o)}_onResize(e){const t=this.camera,i=e.target.transform;t.aspect=i.width/i.height,t.updateProjectionMatrix()}}const INTERSECTION={OUTSIDE:-1,INTERSECTING:0,INSIDE:1};new Vector3$1,new Vector3$1;const scratchVector$6=new Vector3$1,scratchVector2$2=new Vector3$1;class BoundingSphere{constructor(e=[0,0,0],t=0){_defineProperty(this,"center",void 0),_defineProperty(this,"radius",void 0),this.radius=-0,this.center=new Vector3$1,this.fromCenterRadius(e,t)}fromCenterRadius(e,t){return this.center.from(e),this.radius=t,this}fromCornerPoints(e,t){return t=scratchVector$6.from(t),this.center=(new Vector3$1).from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}equals(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new BoundingSphere(this.center,this.radius)}union(e){const t=this.center,i=this.radius,n=e.radius,r=scratchVector$6.copy(e.center).subtract(t),o=r.magnitude();if(i>=o+n)return this.clone();if(n>=o+i)return e.clone();const s=.5*(i+o+n);return scratchVector2$2.copy(r).scale((-i+s)/o).add(t),this.center.copy(scratchVector2$2),this.radius=s,this}expand(e){const t=scratchVector$6.from(e).subtract(this.center).magnitude();return t>this.radius&&(this.radius=t),this}transform(e){this.center.transform(e);const t=getScaling(scratchVector$6,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}distanceSquaredTo(e){const t=this.distanceTo(e);return t*t}distanceTo(e){const t=scratchVector$6.from(e).subtract(this.center);return Math.max(0,t.len()-this.radius)}intersectPlane(e){const t=this.radius,i=e.normal.dot(this.center)+e.distance;return i<-t?INTERSECTION.OUTSIDE:i<t?INTERSECTION.INTERSECTING:INTERSECTION.INSIDE}}const scratchVector3$2=new Vector3$1,scratchOffset=new Vector3$1,scratchVectorU=new Vector3$1,scratchVectorV=new Vector3$1,scratchVectorW=new Vector3$1,scratchCorner=new Vector3$1,scratchToCenter=new Vector3$1,MATRIX3={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8};class OrientedBoundingBox{constructor(e=[0,0,0],t=[0,0,0,0,0,0,0,0,0]){_defineProperty(this,"center",void 0),_defineProperty(this,"halfAxes",void 0),this.center=(new Vector3$1).from(e),this.halfAxes=new Matrix3$1(t)}get halfSize(){const e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2);return[new Vector3$1(e).len(),new Vector3$1(t).len(),new Vector3$1(i).len()]}get quaternion(){const e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2),n=new Vector3$1(e).normalize(),r=new Vector3$1(t).normalize(),o=new Vector3$1(i).normalize();return(new Quaternion$1).fromMatrix3(new Matrix3$1([...n,...r,...o]))}fromCenterHalfSizeQuaternion(e,t,i){const n=new Quaternion$1(i),r=(new Matrix3$1).fromQuaternion(n);return r[0]=r[0]*t[0],r[1]=r[1]*t[0],r[2]=r[2]*t[0],r[3]=r[3]*t[1],r[4]=r[4]*t[1],r[5]=r[5]*t[1],r[6]=r[6]*t[2],r[7]=r[7]*t[2],r[8]=r[8]*t[2],this.center=(new Vector3$1).from(e),this.halfAxes=r,this}clone(){return new OrientedBoundingBox(this.center,this.halfAxes)}equals(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new BoundingSphere){const t=this.halfAxes,i=t.getColumn(0,scratchVectorU),n=t.getColumn(1,scratchVectorV),r=t.getColumn(2,scratchVectorW),o=scratchVector3$2.copy(i).add(n).add(r);return e.center.copy(this.center),e.radius=o.magnitude(),e}intersectPlane(e){const t=this.center,i=e.normal,n=this.halfAxes,r=i.x,o=i.y,s=i.z,a=Math.abs(r*n[MATRIX3.COLUMN0ROW0]+o*n[MATRIX3.COLUMN0ROW1]+s*n[MATRIX3.COLUMN0ROW2])+Math.abs(r*n[MATRIX3.COLUMN1ROW0]+o*n[MATRIX3.COLUMN1ROW1]+s*n[MATRIX3.COLUMN1ROW2])+Math.abs(r*n[MATRIX3.COLUMN2ROW0]+o*n[MATRIX3.COLUMN2ROW1]+s*n[MATRIX3.COLUMN2ROW2]),l=i.dot(t)+e.distance;return l<=-a?INTERSECTION.OUTSIDE:l>=a?INTERSECTION.INSIDE:INTERSECTION.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){const t=scratchOffset.from(e).subtract(this.center),i=this.halfAxes,n=i.getColumn(0,scratchVectorU),r=i.getColumn(1,scratchVectorV),o=i.getColumn(2,scratchVectorW),s=n.magnitude(),a=r.magnitude(),l=o.magnitude();n.normalize(),r.normalize(),o.normalize();let c,u=0;return c=Math.abs(t.dot(n))-s,c>0&&(u+=c*c),c=Math.abs(t.dot(r))-a,c>0&&(u+=c*c),c=Math.abs(t.dot(o))-l,c>0&&(u+=c*c),u}computePlaneDistances(e,t,i=[-0,-0]){let n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;const o=this.center,s=this.halfAxes,a=s.getColumn(0,scratchVectorU),l=s.getColumn(1,scratchVectorV),c=s.getColumn(2,scratchVectorW),u=scratchCorner.copy(a).add(l).add(c).add(o),h=scratchToCenter.copy(u).subtract(e);let d=t.dot(h);return n=Math.min(d,n),r=Math.max(d,r),u.copy(o).add(a).add(l).subtract(c),h.copy(u).subtract(e),d=t.dot(h),n=Math.min(d,n),r=Math.max(d,r),u.copy(o).add(a).subtract(l).add(c),h.copy(u).subtract(e),d=t.dot(h),n=Math.min(d,n),r=Math.max(d,r),u.copy(o).add(a).subtract(l).subtract(c),h.copy(u).subtract(e),d=t.dot(h),n=Math.min(d,n),r=Math.max(d,r),o.copy(u).subtract(a).add(l).add(c),h.copy(u).subtract(e),d=t.dot(h),n=Math.min(d,n),r=Math.max(d,r),o.copy(u).subtract(a).add(l).subtract(c),h.copy(u).subtract(e),d=t.dot(h),n=Math.min(d,n),r=Math.max(d,r),o.copy(u).subtract(a).subtract(l).add(c),h.copy(u).subtract(e),d=t.dot(h),n=Math.min(d,n),r=Math.max(d,r),o.copy(u).subtract(a).subtract(l).subtract(c),h.copy(u).subtract(e),d=t.dot(h),n=Math.min(d,n),r=Math.max(d,r),i[0]=n,i[1]=r,i}transform(e){this.center.transformAsPoint(e);const t=this.halfAxes.getColumn(0,scratchVectorU);t.transformAsPoint(e);const i=this.halfAxes.getColumn(1,scratchVectorV);i.transformAsPoint(e);const n=this.halfAxes.getColumn(2,scratchVectorW);return n.transformAsPoint(e),this.halfAxes=new Matrix3$1([...t,...i,...n]),this}getTransform(){throw new Error("not implemented")}}const scratchPosition$2=new Vector3$1,scratchNormal$2=new Vector3$1;class Plane{constructor(e=[0,0,1],t=0){_defineProperty(this,"normal",void 0),_defineProperty(this,"distance",void 0),this.normal=new Vector3$1,this.distance=-0,this.fromNormalDistance(e,t)}fromNormalDistance(e,t){return assert$6(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}fromPointNormal(e,t){e=scratchPosition$2.from(e),this.normal.from(t).normalize();const i=-this.normal.dot(e);return this.distance=i,this}fromCoefficients(e,t,i,n){return this.normal.set(e,t,i),assert$6(equals$1(this.normal.len(),1)),this.distance=n,this}clone(){return new Plane(this.normal,this.distance)}equals(e){return equals$1(this.distance,e.distance)&&equals$1(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){const t=scratchNormal$2.copy(this.normal).transformAsVector(e).normalize(),i=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(i,t)}projectPointOntoPlane(e,t=[0,0,0]){e=scratchPosition$2.from(e);const i=this.getPointDistance(e),n=scratchNormal$2.copy(this.normal).scale(i);return e.subtract(n).to(t)}}const faces=[new Vector3$1([1,0,0]),new Vector3$1([0,1,0]),new Vector3$1([0,0,1])],scratchPlaneCenter=new Vector3$1,scratchPlaneNormal=new Vector3$1;new Plane(new Vector3$1(1,0,0),0);class CullingVolume{constructor(e=[]){_defineProperty(this,"planes",void 0),this.planes=e}fromBoundingSphere(e){this.planes.length=2*faces.length;const t=e.center,i=e.radius;let n=0;for(const e of faces){let r=this.planes[n],o=this.planes[n+1];r||(r=this.planes[n]=new Plane),o||(o=this.planes[n+1]=new Plane);const s=scratchPlaneCenter.copy(e).scale(-i).add(t);e.dot(s),r.fromPointNormal(s,e);const a=scratchPlaneCenter.copy(e).scale(i).add(t),l=scratchPlaneNormal.copy(e).negate();l.dot(a),o.fromPointNormal(a,l),n+=2}return this}computeVisibility(e){let t=INTERSECTION.INSIDE;for(const i of this.planes){switch(e.intersectPlane(i)){case INTERSECTION.OUTSIDE:return INTERSECTION.OUTSIDE;case INTERSECTION.INTERSECTING:t=INTERSECTION.INTERSECTING}}return t}computeVisibilityWithPlaneMask(e,t){if(assert$6(Number.isFinite(t),"parentPlaneMask is required."),t===CullingVolume.MASK_OUTSIDE||t===CullingVolume.MASK_INSIDE)return t;let i=CullingVolume.MASK_INSIDE;const n=this.planes;for(let r=0;r<this.planes.length;++r){const o=r<31?1<<r:0;if(r<31&&!(t&o))continue;const s=e.intersectPlane(n[r]);if(s===INTERSECTION.OUTSIDE)return CullingVolume.MASK_OUTSIDE;s===INTERSECTION.INTERSECTING&&(i|=o)}return i}}_defineProperty(CullingVolume,"MASK_OUTSIDE",4294967295),_defineProperty(CullingVolume,"MASK_INSIDE",0),_defineProperty(CullingVolume,"MASK_INDETERMINATE",2147483647),new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1,new Vector3$1;const scratchMatrix=new Matrix3$1,scratchUnitary=new Matrix3$1,scratchDiagonal=new Matrix3$1,jMatrix=new Matrix3$1,jMatrixTranspose=new Matrix3$1;function computeEigenDecomposition(e,t={}){const i=_MathUtils.EPSILON20;let n=0,r=0;const o=scratchUnitary,s=scratchDiagonal;o.identity(),s.copy(e);const a=i*computeFrobeniusNorm(s);for(;r<10&&offDiagonalFrobeniusNorm(s)>a;)shurDecomposition(s,jMatrix),jMatrixTranspose.copy(jMatrix).transpose(),s.multiplyRight(jMatrix),s.multiplyLeft(jMatrixTranspose),o.multiplyRight(jMatrix),++n>2&&(++r,n=0);return t.unitary=o.toTarget(t.unitary),t.diagonal=s.toTarget(t.diagonal),t}function computeFrobeniusNorm(e){let t=0;for(let i=0;i<9;++i){const n=e[i];t+=n*n}return Math.sqrt(t)}const rowVal=[1,0,0],colVal=[2,2,1];function offDiagonalFrobeniusNorm(e){let t=0;for(let i=0;i<3;++i){const n=e[scratchMatrix.getElementIndex(colVal[i],rowVal[i])];t+=2*n*n}return Math.sqrt(t)}function shurDecomposition(e,t){const i=_MathUtils.EPSILON15;let n=0,r=1;for(let t=0;t<3;++t){const i=Math.abs(e[scratchMatrix.getElementIndex(colVal[t],rowVal[t])]);i>n&&(r=t,n=i)}const o=rowVal[r],s=colVal[r];let a=1,l=0;if(Math.abs(e[scratchMatrix.getElementIndex(s,o)])>i){const t=(e[scratchMatrix.getElementIndex(s,s)]-e[scratchMatrix.getElementIndex(o,o)])/2/e[scratchMatrix.getElementIndex(s,o)];let i;i=t<0?-1/(-t+Math.sqrt(1+t*t)):1/(t+Math.sqrt(1+t*t)),a=1/Math.sqrt(1+i*i),l=i*a}return Matrix3$1.IDENTITY.to(t),t[scratchMatrix.getElementIndex(o,o)]=t[scratchMatrix.getElementIndex(s,s)]=a,t[scratchMatrix.getElementIndex(s,o)]=l,t[scratchMatrix.getElementIndex(o,s)]=-l,t}const scratchVector2$1=new Vector3$1,scratchVector3$1=new Vector3$1,scratchVector4=new Vector3$1,scratchVector5=new Vector3$1,scratchVector6=new Vector3$1,scratchCovarianceResult=new Matrix3$1,scratchEigenResult={diagonal:new Matrix3$1,unitary:new Matrix3$1};function makeOrientedBoundingBoxFromPoints(e,t=new OrientedBoundingBox){if(!e||0===e.length)return t.halfAxes=new Matrix3$1([0,0,0,0,0,0,0,0,0]),t.center=new Vector3$1,t;const i=e.length,n=new Vector3$1(0,0,0);for(const t of e)n.add(t);const r=1/i;n.multiplyByScalar(r);let o=0,s=0,a=0,l=0,c=0,u=0;for(const t of e){const e=scratchVector2$1.copy(t).subtract(n);o+=e.x*e.x,s+=e.x*e.y,a+=e.x*e.z,l+=e.y*e.y,c+=e.y*e.z,u+=e.z*e.z}o*=r,s*=r,a*=r,l*=r,c*=r,u*=r;const h=scratchCovarianceResult;h[0]=o,h[1]=s,h[2]=a,h[3]=s,h[4]=l,h[5]=c,h[6]=a,h[7]=c,h[8]=u;const{unitary:d}=computeEigenDecomposition(h,scratchEigenResult),p=t.halfAxes.copy(d);let f=p.getColumn(0,scratchVector4),m=p.getColumn(1,scratchVector5),g=p.getColumn(2,scratchVector6),_=-Number.MAX_VALUE,y=-Number.MAX_VALUE,v=-Number.MAX_VALUE,x=Number.MAX_VALUE,b=Number.MAX_VALUE,T=Number.MAX_VALUE;for(const t of e)scratchVector2$1.copy(t),_=Math.max(scratchVector2$1.dot(f),_),y=Math.max(scratchVector2$1.dot(m),y),v=Math.max(scratchVector2$1.dot(g),v),x=Math.min(scratchVector2$1.dot(f),x),b=Math.min(scratchVector2$1.dot(m),b),T=Math.min(scratchVector2$1.dot(g),T);f=f.multiplyByScalar(.5*(x+_)),m=m.multiplyByScalar(.5*(b+y)),g=g.multiplyByScalar(.5*(T+v)),t.center.copy(f).add(m).add(g);const w=scratchVector3$1.set(_-x,y-b,v-T).multiplyByScalar(.5),E=new Matrix3$1([w[0],0,0,0,w[1],0,0,0,w[2]]);return t.halfAxes.multiplyRight(E),t}const RADIAN_PER_DEGREE=Math.PI/180,modelMatrix=new Float32Array(16),valueArray=new Float32Array(12);function calculateTransformMatrix(e,t,i){const n=t[0]*RADIAN_PER_DEGREE,r=t[1]*RADIAN_PER_DEGREE,o=t[2]*RADIAN_PER_DEGREE,s=Math.sin(o),a=Math.sin(n),l=Math.sin(r),c=Math.cos(o),u=Math.cos(n),h=Math.cos(r),d=i[0],p=i[1],f=i[2];e[0]=d*h*u,e[1]=d*l*u,e[2]=d*-a,e[3]=p*(-l*c+h*a*s),e[4]=p*(h*c+l*a*s),e[5]=p*u*s,e[6]=f*(l*s+h*a*c),e[7]=f*(-h*s+l*a*c),e[8]=f*u*c}function getExtendedMat3FromMat4(e){return e[0]=e[0],e[1]=e[1],e[2]=e[2],e[3]=e[4],e[4]=e[5],e[5]=e[6],e[6]=e[8],e[7]=e[9],e[8]=e[10],e[9]=e[12],e[10]=e[13],e[11]=e[14],e.subarray(0,12)}const MATRIX_ATTRIBUTES={size:12,accessor:["getOrientation","getScale","getTranslation","getTransformMatrix"],shaderAttributes:{instanceModelMatrix__LOCATION_0:{size:3,elementOffset:0},instanceModelMatrix__LOCATION_1:{size:3,elementOffset:3},instanceModelMatrix__LOCATION_2:{size:3,elementOffset:6},instanceTranslation:{size:3,elementOffset:9}},update(e,{startRow:t,endRow:i}){const{data:n,getOrientation:r,getScale:o,getTranslation:s,getTransformMatrix:a}=this.props,l=Array.isArray(a),c=l&&16===a.length,u=Array.isArray(o),h=Array.isArray(r),d=Array.isArray(s),p=c||!l&&Boolean(a(n[0]));e.constant=p?c:h&&u&&d;const f=e.value;if(e.constant){let t;if(p)modelMatrix.set(a),t=getExtendedMat3FromMat4(modelMatrix);else{t=valueArray;calculateTransformMatrix(t,r,o),t.set(s,9)}e.value=new Float32Array(t)}else{let l=t*e.size;const{iterable:m,objectInfo:g}=createIterable(n,t,i);for(const e of m){let t;if(g.index++,p)modelMatrix.set(c?a:a(e,g)),t=getExtendedMat3FromMat4(modelMatrix);else{t=valueArray;calculateTransformMatrix(t,h?r:r(e,g),u?o:o(e,g)),t.set(d?s:s(e,g),9)}f[l++]=t[0],f[l++]=t[1],f[l++]=t[2],f[l++]=t[3],f[l++]=t[4],f[l++]=t[5],f[l++]=t[6],f[l++]=t[7],f[l++]=t[8],f[l++]=t[9],f[l++]=t[10],f[l++]=t[11]}}}};function shouldComposeModelMatrix(e,t){return t===COORDINATE_SYSTEM.CARTESIAN||t===COORDINATE_SYSTEM.METER_OFFSETS||t===COORDINATE_SYSTEM.DEFAULT&&!e.isGeospatial}var vs$3="#version 300 es\n#define SHADER_NAME simple-mesh-layer-vs\nuniform float sizeScale;\nuniform bool composeModelMatrix;\nin vec3 positions;\nin vec3 normals;\nin vec3 colors;\nin vec2 texCoords;\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin mat3 instanceModelMatrix;\nin vec3 instanceTranslation;\nout vec2 vTexCoord;\nout vec3 cameraPosition;\nout vec3 normals_commonspace;\nout vec4 position_commonspace;\nout vec4 vColor;\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.uv = texCoords;\n  geometry.pickingColor = instancePickingColors;\n\n  vTexCoord = texCoords;\n  cameraPosition = project_uCameraPosition;\n  vColor = vec4(colors * instanceColors.rgb, instanceColors.a);\n\n  vec3 pos = (instanceModelMatrix * positions) * sizeScale + instanceTranslation;\n\n  if (composeModelMatrix) {\n    DECKGL_FILTER_SIZE(pos, geometry);\n    normals_commonspace = project_normal(instanceModelMatrix * normals);\n    geometry.worldPosition += pos;\n    gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), position_commonspace);\n    geometry.position = position_commonspace;\n  }\n  else {\n    pos = project_size(pos);\n    DECKGL_FILTER_SIZE(pos, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, position_commonspace);\n    geometry.position = position_commonspace;\n    normals_commonspace = project_normal(instanceModelMatrix * normals);\n  }\n\n  geometry.normal = normals_commonspace;\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs$3="#version 300 es\n#define SHADER_NAME simple-mesh-layer-fs\n\nprecision highp float;\n\nuniform bool hasTexture;\nuniform sampler2D sampler;\nuniform bool flatShading;\nuniform float opacity;\n\nin vec2 vTexCoord;\nin vec3 cameraPosition;\nin vec3 normals_commonspace;\nin vec4 position_commonspace;\nin vec4 vColor;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  geometry.uv = vTexCoord;\n\n  vec3 normal;\n  if (flatShading) {\n#ifdef DERIVATIVES_AVAILABLE\n    normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));\n#else\n    normal = vec3(0.0, 0.0, 1.0);\n#endif\n  } else {\n    normal = normals_commonspace;\n  }\n\n  vec4 color = hasTexture ? texture(sampler, vTexCoord) : vColor;\n  DECKGL_FILTER_COLOR(color, geometry);\n\n  vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);\n  fragColor = vec4(lightColor, color.a * opacity);\n}\n";function getMeshBoundingBox(e){let t=1/0,i=1/0,n=1/0,r=-1/0,o=-1/0,s=-1/0;const a=e.POSITION?e.POSITION.value:[],l=a&&a.length;for(let e=0;e<l;e+=3){const l=a[e],c=a[e+1],u=a[e+2];t=l<t?l:t,i=c<i?c:i,n=u<n?u:n,r=l>r?l:r,o=c>o?c:o,s=u>s?u:s}return[[t,i,n],[r,o,s]]}function assert$3(e,t){if(!e)throw new Error("loader assertion failed.")}class Schema{constructor(e,t){_defineProperty(this,"fields",void 0),_defineProperty(this,"metadata",void 0),assert$3(Array.isArray(e)),checkNames(e),this.fields=e,this.metadata=t||new Map}compareTo(e){if(this.metadata!==e.metadata)return!1;if(this.fields.length!==e.fields.length)return!1;for(let t=0;t<this.fields.length;++t)if(!this.fields[t].compareTo(e.fields[t]))return!1;return!0}select(){const e=Object.create(null);for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(const t of i)e[t]=!0;const r=this.fields.filter((t=>e[t.name]));return new Schema(r,this.metadata)}selectAt(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=t.map((e=>this.fields[e])).filter(Boolean);return new Schema(n,this.metadata)}assign(e){let t,i=this.metadata;if(e instanceof Schema){const n=e;t=n.fields,i=mergeMaps(mergeMaps(new Map,this.metadata),n.metadata)}else t=e;const n=Object.create(null);for(const e of this.fields)n[e.name]=e;for(const e of t)n[e.name]=e;const r=Object.values(n);return new Schema(r,i)}}function checkNames(e){const t={};for(const i of e)t[i.name]=!0}function mergeMaps(e,t){return new Map([...e||new Map,...t||new Map])}class Field{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Map;_defineProperty(this,"name",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"nullable",void 0),_defineProperty(this,"metadata",void 0),this.name=e,this.type=t,this.nullable=i,this.metadata=n}get typeId(){return this.type&&this.type.typeId}clone(){return new Field(this.name,this.type,this.nullable,this.metadata)}compareTo(e){return this.name===e.name&&this.type===e.type&&this.nullable===e.nullable&&this.metadata===e.metadata}toString(){return"".concat(this.type).concat(this.nullable?", nullable":"").concat(this.metadata?", metadata: ".concat(this.metadata):"")}}let Type=function(e){return e[e.NONE=0]="NONE",e[e.Null=1]="Null",e[e.Int=2]="Int",e[e.Float=3]="Float",e[e.Binary=4]="Binary",e[e.Utf8=5]="Utf8",e[e.Bool=6]="Bool",e[e.Decimal=7]="Decimal",e[e.Date=8]="Date",e[e.Time=9]="Time",e[e.Timestamp=10]="Timestamp",e[e.Interval=11]="Interval",e[e.List=12]="List",e[e.Struct=13]="Struct",e[e.Union=14]="Union",e[e.FixedSizeBinary=15]="FixedSizeBinary",e[e.FixedSizeList=16]="FixedSizeList",e[e.Map=17]="Map",e[e.Dictionary=-1]="Dictionary",e[e.Int8=-2]="Int8",e[e.Int16=-3]="Int16",e[e.Int32=-4]="Int32",e[e.Int64=-5]="Int64",e[e.Uint8=-6]="Uint8",e[e.Uint16=-7]="Uint16",e[e.Uint32=-8]="Uint32",e[e.Uint64=-9]="Uint64",e[e.Float16=-10]="Float16",e[e.Float32=-11]="Float32",e[e.Float64=-12]="Float64",e[e.DateDay=-13]="DateDay",e[e.DateMillisecond=-14]="DateMillisecond",e[e.TimestampSecond=-15]="TimestampSecond",e[e.TimestampMillisecond=-16]="TimestampMillisecond",e[e.TimestampMicrosecond=-17]="TimestampMicrosecond",e[e.TimestampNanosecond=-18]="TimestampNanosecond",e[e.TimeSecond=-19]="TimeSecond",e[e.TimeMillisecond=-20]="TimeMillisecond",e[e.TimeMicrosecond=-21]="TimeMicrosecond",e[e.TimeNanosecond=-22]="TimeNanosecond",e[e.DenseUnion=-23]="DenseUnion",e[e.SparseUnion=-24]="SparseUnion",e[e.IntervalDayTime=-25]="IntervalDayTime",e[e.IntervalYearMonth=-26]="IntervalYearMonth",e}({}),_Symbol$toStringTag,_Symbol$toStringTag2,_Symbol$toStringTag7;class DataType{static isNull(e){return e&&e.typeId===Type.Null}static isInt(e){return e&&e.typeId===Type.Int}static isFloat(e){return e&&e.typeId===Type.Float}static isBinary(e){return e&&e.typeId===Type.Binary}static isUtf8(e){return e&&e.typeId===Type.Utf8}static isBool(e){return e&&e.typeId===Type.Bool}static isDecimal(e){return e&&e.typeId===Type.Decimal}static isDate(e){return e&&e.typeId===Type.Date}static isTime(e){return e&&e.typeId===Type.Time}static isTimestamp(e){return e&&e.typeId===Type.Timestamp}static isInterval(e){return e&&e.typeId===Type.Interval}static isList(e){return e&&e.typeId===Type.List}static isStruct(e){return e&&e.typeId===Type.Struct}static isUnion(e){return e&&e.typeId===Type.Union}static isFixedSizeBinary(e){return e&&e.typeId===Type.FixedSizeBinary}static isFixedSizeList(e){return e&&e.typeId===Type.FixedSizeList}static isMap(e){return e&&e.typeId===Type.Map}static isDictionary(e){return e&&e.typeId===Type.Dictionary}get typeId(){return Type.NONE}compareTo(e){return this===e}}_Symbol$toStringTag=Symbol.toStringTag;class Int extends DataType{constructor(e,t){super(),_defineProperty(this,"isSigned",void 0),_defineProperty(this,"bitWidth",void 0),this.isSigned=e,this.bitWidth=t}get typeId(){return Type.Int}get[_Symbol$toStringTag](){return"Int"}toString(){return"".concat(this.isSigned?"I":"Ui","nt").concat(this.bitWidth)}}class Int8 extends Int{constructor(){super(!0,8)}}class Int16 extends Int{constructor(){super(!0,16)}}class Int32 extends Int{constructor(){super(!0,32)}}class Uint8 extends Int{constructor(){super(!1,8)}}class Uint16 extends Int{constructor(){super(!1,16)}}class Uint32 extends Int{constructor(){super(!1,32)}}const Precision={SINGLE:32,DOUBLE:64};_Symbol$toStringTag2=Symbol.toStringTag;class Float extends DataType{constructor(e){super(),_defineProperty(this,"precision",void 0),this.precision=e}get typeId(){return Type.Float}get[_Symbol$toStringTag2](){return"Float"}toString(){return"Float".concat(this.precision)}}class Float32 extends Float{constructor(){super(Precision.SINGLE)}}class Float64 extends Float{constructor(){super(Precision.DOUBLE)}}_Symbol$toStringTag7=Symbol.toStringTag;class FixedSizeList extends DataType{constructor(e,t){super(),_defineProperty(this,"listSize",void 0),_defineProperty(this,"children",void 0),this.listSize=e,this.children=[t]}get typeId(){return Type.FixedSizeList}get valueType(){return this.children[0].type}get valueField(){return this.children[0]}get[_Symbol$toStringTag7](){return"FixedSizeList"}toString(){return"FixedSizeList[".concat(this.listSize,"]<").concat(this.valueType,">")}}function getArrowTypeFromTypedArray(e){switch(e.constructor){case Int8Array:return new Int8;case Uint8Array:return new Uint8;case Int16Array:return new Int16;case Uint16Array:return new Uint16;case Int32Array:return new Int32;case Uint32Array:return new Uint32;case Float32Array:return new Float32;case Float64Array:return new Float64;default:throw new Error("array type not supported")}}function deduceMeshField(e,t,i){const n=getArrowTypeFromTypedArray(t.value),r=i||makeMeshAttributeMetadata(t);return new Field(e,new FixedSizeList(t.size,new Field("value",n)),!1,r)}function makeMeshAttributeMetadata(e){const t=new Map;return"byteOffset"in e&&t.set("byteOffset",e.byteOffset.toString(10)),"byteStride"in e&&t.set("byteStride",e.byteStride.toString(10)),"normalized"in e&&t.set("normalized",e.normalized.toString()),t}function validateGeometryAttributes$1(e,t){(e.COLOR_0||e.colors)&&t||(e.colors={constant:!0,value:new Float32Array([1,1,1])}),log$3.assert(e.positions||e.POSITION,'no "postions" or "POSITION" attribute in mesh')}function getGeometry(e,t){if(e.attributes)return validateGeometryAttributes$1(e.attributes,t),e instanceof Geometry?e:new Geometry(e);if(e.positions||e.POSITION)return validateGeometryAttributes$1(e,t),new Geometry({attributes:e});throw Error("Invalid mesh")}const DEFAULT_COLOR$1=[0,0,0,255],defaultProps$3={mesh:{type:"object",value:null,async:!0},texture:{type:"image",value:null,async:!0},sizeScale:{type:"number",value:1,min:0},_useMeshColors:{type:"boolean",value:!1},_instanced:!0,wireframe:!1,material:!0,getPosition:{type:"accessor",value:e=>e.position},getColor:{type:"accessor",value:DEFAULT_COLOR$1},getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]},textureParameters:{type:"object",ignore:!0}};class SimpleMeshLayer extends Layer{constructor(...e){super(...e),_defineProperty(this,"state",void 0)}getShaders(){const e=!isWebGL2$1(this.context.gl),t={};return hasFeature(this.context.gl,FEATURES$1.GLSL_DERIVATIVES)&&(t.DERIVATIVES_AVAILABLE=1),super.getShaders({vs:vs$3,fs:fs$3,modules:[project32,phongLighting,picking],transpileToGLSL100:e,defines:t})}getBounds(){var e;if(this.props._instanced)return super.getBounds();let t=this.state.positionBounds;if(t)return t;const{mesh:i}=this.props;if(!i)return null;if(t=null===(e=i.header)||void 0===e?void 0:e.boundingBox,!t){const{attributes:e}=getGeometry(i,this.props._useMeshColors);e.POSITION=e.POSITION||e.positions,t=getMeshBoundingBox(e)}return this.state.positionBounds=t,t}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{transition:!0,type:5130,fp64:this.use64bitPositions(),size:3,accessor:"getPosition"},instanceColors:{type:5121,transition:!0,size:this.props.colorFormat.length,normalized:!0,accessor:"getColor",defaultValue:[0,0,0,255]},instanceModelMatrix:MATRIX_ATTRIBUTES}),this.setState({emptyTexture:new Texture2D(this.context.gl,{data:new Uint8Array(4),width:1,height:1})})}updateState(e){super.updateState(e);const{props:t,oldProps:i,changeFlags:n}=e;if(t.mesh!==i.mesh||n.extensionsChanged){var r;if(this.state.positionBounds=null,null===(r=this.state.model)||void 0===r||r.delete(),t.mesh){this.state.model=this.getModel(t.mesh);const e=t.mesh.attributes||t.mesh;this.setState({hasNormals:Boolean(e.NORMAL||e.normals)})}this.getAttributeManager().invalidateAll()}t.texture!==i.texture&&this.setTexture(t.texture),this.state.model&&this.state.model.setDrawMode(this.props.wireframe?3:4)}finalizeState(e){super.finalizeState(e),this.state.emptyTexture.delete()}draw({uniforms:e}){if(!this.state.model)return;const{viewport:t}=this.context,{sizeScale:i,coordinateSystem:n,_instanced:r}=this.props;this.state.model.setUniforms(e).setUniforms({sizeScale:i,composeModelMatrix:!r||shouldComposeModelMatrix(t,n),flatShading:!this.state.hasNormals}).draw()}get isLoaded(){var e;return(null===(e=this.state)||void 0===e?void 0:e.model)&&super.isLoaded}getModel(e){const t=new Model(this.context.gl,{...this.getShaders(),id:this.props.id,geometry:getGeometry(e,this.props._useMeshColors),isInstanced:!0}),{texture:i}=this.props,{emptyTexture:n}=this.state;return t.setUniforms({sampler:i||n,hasTexture:Boolean(i)}),t}setTexture(e){const{emptyTexture:t,model:i}=this.state;i&&i.setUniforms({sampler:e||t,hasTexture:Boolean(e)})}}_defineProperty(SimpleMeshLayer,"defaultProps",defaultProps$3),_defineProperty(SimpleMeshLayer,"layerName","SimpleMeshLayer");class ScenegraphNode{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{id:t}=e;this.id=t||uid(this.constructor.name),this.display=!0,this.position=new Vector3$1,this.rotation=new Vector3$1,this.scale=new Vector3$1(1,1,1),this.matrix=new Matrix4$1,this.userData={},this.props={},this._setScenegraphNodeProps(e)}delete(){}setProps(e){return this._setScenegraphNodeProps(e),this}toString(){return"{type: ScenegraphNode, id: ".concat(this.id,")}")}getBounds(){return null}setPosition(e){return assert$8(3===e.length,"setPosition requires vector argument"),this.position=e,this}setRotation(e){return assert$8(3===e.length,"setRotation requires vector argument"),this.rotation=e,this}setScale(e){return assert$8(3===e.length,"setScale requires vector argument"),this.scale=e,this}setMatrix(e){!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?this.matrix.copy(e):this.matrix=e}setMatrixComponents(e){let{position:t,rotation:i,scale:n,update:r=!0}=e;return t&&this.setPosition(t),i&&this.setRotation(i),n&&this.setScale(n),r&&this.updateMatrix(),this}updateMatrix(){const e=this.position,t=this.rotation,i=this.scale;return this.matrix.identity(),this.matrix.translate(e),this.matrix.rotateXYZ(t),this.matrix.scale(i),this}update(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{position:t,rotation:i,scale:n}=e;return t&&this.setPosition(t),i&&this.setRotation(i),n&&this.setScale(n),this.updateMatrix(),this}getCoordinateUniforms(e,t){assert$8(e),t=t||this.matrix;const i=new Matrix4$1(e).multiplyRight(t),n=i.invert(),r=n.transpose();return{viewMatrix:e,modelMatrix:t,objectMatrix:t,worldMatrix:i,worldInverseMatrix:n,worldInverseTransposeMatrix:r}}_setScenegraphNodeProps(e){"display"in e&&(this.display=e.display),"position"in e&&this.setPosition(e.position),"rotation"in e&&this.setRotation(e.rotation),"scale"in e&&this.setScale(e.scale),"matrix"in e&&this.setMatrix(e.matrix),Object.assign(this.props,e)}}class GroupNode extends ScenegraphNode{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e=Array.isArray(e)?{children:e}:e;const{children:t=[]}=e;log$2.assert(t.every((e=>e instanceof ScenegraphNode)),"every child must an instance of ScenegraphNode"),super(e),this.children=t}add(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(const e of t)Array.isArray(e)?this.add(...e):this.children.push(e);return this}remove(e){const t=this.children,i=t.indexOf(e);return i>-1&&t.splice(i,1),this}removeAll(){return this.children=[],this}delete(){this.children.forEach((e=>e.delete())),this.removeAll(),super.delete()}getBounds(){const e=[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]];return this.traverse(((t,i)=>{let{worldMatrix:n}=i;const r=t.getBounds();if(!r)return;const[o,s]=r,a=new Vector3$1(o).add(s).divide([2,2,2]);n.transformAsPoint(a,a);const l=new Vector3$1(s).subtract(o).divide([2,2,2]);n.transformAsVector(l,l);for(let t=0;t<8;t++){const i=new Vector3$1(1&t?-1:1,2&t?-1:1,4&t?-1:1).multiply(l).add(a);for(let t=0;t<3;t++)e[0][t]=Math.min(e[0][t],i[t]),e[1][t]=Math.max(e[1][t],i[t])}})),Number.isFinite(e[0][0])?e:null}traverse(e){let{worldMatrix:t=new Matrix4$1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new Matrix4$1(t).multiplyRight(this.matrix);for(const t of this.children)t instanceof GroupNode?t.traverse(e,{worldMatrix:i}):e(t,{worldMatrix:i})}}const ATTRIBUTE_TYPE_TO_COMPONENTS$2={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY$1={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function accessorToJsArray(e){if(!e._animation){const t=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY$1[e.componentType],i=ATTRIBUTE_TYPE_TO_COMPONENTS$2[e.type],n=i*e.count,{buffer:r,byteOffset:o}=e.bufferView.data,s=new t(r,o+(e.byteOffset||0),n);if(1===i)e._animation=Array.from(s);else{const t=[];for(let e=0;e<s.length;e+=i)t.push(Array.from(s.slice(e,e+i)));e._animation=t}}return e._animation}const helperMatrix=new Matrix4$1;function applyTranslationRotationScale(e,t){if(t.matrix.identity(),e.translation&&t.matrix.translate(e.translation),e.rotation){const i=helperMatrix.fromQuaternion(e.rotation);t.matrix.multiplyRight(i)}e.scale&&t.matrix.scale(e.scale)}const quaternion=new Quaternion$1;function linearInterpolate(e,t,i,n,r){if("rotation"===t){quaternion.slerp({start:i,target:n,ratio:r});for(let i=0;i<quaternion.length;i++)e[t][i]=quaternion[i]}else for(let o=0;o<i.length;o++)e[t][o]=r*n[o]+(1-r)*i[o]}function cubicsplineInterpolate(e,t,i){let{p0:n,outTangent0:r,inTangent1:o,p1:s,tDiff:a,ratio:l}=i;for(let i=0;i<e[t].length;i++){const c=r[i]*a,u=o[i]*a;e[t][i]=(2*Math.pow(l,3)-3*Math.pow(l,2)+1)*n[i]+(Math.pow(l,3)-2*Math.pow(l,2)+l)*c+(-2*Math.pow(l,3)+3*Math.pow(l,2))*s[i]+(Math.pow(l,3)-Math.pow(l,2))*u}}function stepInterpolate(e,t,i){for(let n=0;n<i.length;n++)e[t][n]=i[n]}function interpolate(e,t,i,n){let{input:r,interpolation:o,output:s}=t;const a=e%r[r.length-1],l=r.findIndex((e=>e>=a)),c=Math.max(0,l-1);if(!Array.isArray(i[n]))switch(n){case"translation":i[n]=[0,0,0];break;case"rotation":i[n]=[0,0,0,1];break;case"scale":i[n]=[1,1,1];break;default:log$2.warn("Bad animation path ".concat(n))()}assert$8(i[n].length===s[c].length);const u=r[c],h=r[l];switch(o){case"STEP":stepInterpolate(i,n,s[c]);break;case"LINEAR":if(h>u){linearInterpolate(i,n,s[c],s[l],(a-u)/(h-u))}break;case"CUBICSPLINE":if(h>u){cubicsplineInterpolate(i,n,{p0:s[3*c+1],outTangent0:s[3*c+2],inTangent1:s[3*l+0],p1:s[3*l+1],tDiff:h-u,ratio:(a-u)/(h-u)})}break;default:log$2.warn("Interpolation ".concat(o," not supported"))()}}class GLTFAnimation{constructor(e){this.startTime=0,this.playing=!0,this.speed=1,this.channels=[],Object.assign(this,e)}animate(e){if(!this.playing)return;const t=(e/1e3-this.startTime)*this.speed;this.channels.forEach((e=>{let{sampler:i,target:n,path:r}=e;interpolate(t,i,n,r),applyTranslationRotationScale(n,n._node)}))}}class GLTFAnimator{constructor(e){this.animations=e.animations.map(((t,i)=>{const n=t.name||"Animation-".concat(i),r=t.samplers.map((t=>{let{input:i,interpolation:n="LINEAR",output:r}=t;return{input:accessorToJsArray(e.accessors[i]),interpolation:n,output:accessorToJsArray(e.accessors[r])}})),o=t.channels.map((t=>{let{sampler:i,target:n}=t;return{sampler:r[i],target:e.nodes[n.node],path:n.path}}));return new GLTFAnimation({name:n,channels:o})}))}animate(e){this.setTime(e)}setTime(e){this.animations.forEach((t=>t.animate(e)))}getAnimations(){return this.animations}}class ModelNode extends ScenegraphNode{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t),this.onBeforeRender=null,this.AfterRender=null,e instanceof Model?(this.model=e,this._setModelNodeProps(t)):this.model=new Model(e,t),this.bounds=null,this.managedResources=t.managedResources||[]}setProps(e){return super.setProps(e),this._setModelNodeProps(e),this}getBounds(){return this.bounds}delete(){this.model&&(this.model.delete(),this.model=null),this.managedResources.forEach((e=>e.delete())),this.managedResources=[]}draw(){return this.model.draw(...arguments)}setUniforms(){return this.model.setUniforms(...arguments),this}setAttributes(){return this.model.setAttributes(...arguments),this}updateModuleSettings(){return this.model.updateModuleSettings(...arguments),this}_setModelNodeProps(e){this.model.setProps(e)}}class GLTFMaterialParser{constructor(e,t){let{attributes:i,material:n,pbrDebug:r,imageBasedLightingEnvironment:o,lights:s,useTangents:a}=t;this.gl=e,this.defines={MANUAL_SRGB:1,SRGB_FAST_APPROXIMATION:1},hasFeature(e,FEATURES$1.GLSL_TEXTURE_LOD)&&(this.defines.USE_TEX_LOD=1),this.uniforms={u_Camera:[0,0,0],u_MetallicRoughnessValues:[1,1]},this.parameters={},this.generatedTextures=[],o&&(this.uniforms.u_DiffuseEnvSampler=o.getDiffuseEnvSampler(),this.uniforms.u_SpecularEnvSampler=o.getSpecularEnvSampler(),this.uniforms.u_brdfLUT=o.getBrdfTexture(),this.uniforms.u_ScaleIBLAmbient=[1,1]),r&&(this.uniforms.u_ScaleDiffBaseMR=[0,0,0,0],this.uniforms.u_ScaleFGDSpec=[0,0,0,0]),this.defineIfPresent(i.NORMAL,"HAS_NORMALS"),this.defineIfPresent(i.TANGENT&&a,"HAS_TANGENTS"),this.defineIfPresent(i.TEXCOORD_0,"HAS_UV"),this.defineIfPresent(o,"USE_IBL"),this.defineIfPresent(s,"USE_LIGHTS"),this.defineIfPresent(r,"PBR_DEBUG"),n&&this.parseMaterial(n)}defineIfPresent(e,t){e&&(this.defines[t]=1)}parseTexture(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const n=e.texture&&e.texture.sampler&&e.texture.sampler.parameters||{},r=e.texture.source.image;let o,s={};r.compressed?(o=r,s={[this.gl.TEXTURE_MIN_FILTER]:r.data.length>1?this.gl.LINEAR_MIPMAP_NEAREST:this.gl.LINEAR}):o={data:r};const a=new Texture2D(this.gl,{id:e.name||e.id,parameters:{...n,...s},pixelStore:{[this.gl.UNPACK_FLIP_Y_WEBGL]:!1},...o});this.uniforms[t]=a,this.defineIfPresent(i,i),this.generatedTextures.push(a)}parsePbrMetallicRoughness(e){e.baseColorTexture&&this.parseTexture(e.baseColorTexture,"u_BaseColorSampler","HAS_BASECOLORMAP"),this.uniforms.u_BaseColorFactor=e.baseColorFactor||[1,1,1,1],e.metallicRoughnessTexture&&this.parseTexture(e.metallicRoughnessTexture,"u_MetallicRoughnessSampler","HAS_METALROUGHNESSMAP");const{metallicFactor:t=1,roughnessFactor:i=1}=e;this.uniforms.u_MetallicRoughnessValues=[t,i]}parseMaterial(e){if(this.uniforms.pbr_uUnlit=Boolean(e.unlit),e.pbrMetallicRoughness&&this.parsePbrMetallicRoughness(e.pbrMetallicRoughness),e.normalTexture){this.parseTexture(e.normalTexture,"u_NormalSampler","HAS_NORMALMAP");const{scale:t=1}=e.normalTexture;this.uniforms.u_NormalScale=t}if(e.occlusionTexture){this.parseTexture(e.occlusionTexture,"u_OcclusionSampler","HAS_OCCLUSIONMAP");const{strength:t=1}=e.occlusionTexture;this.uniforms.u_OcclusionStrength=t}if(e.emissiveTexture&&(this.parseTexture(e.emissiveTexture,"u_EmissiveSampler","HAS_EMISSIVEMAP"),this.uniforms.u_EmissiveFactor=e.emissiveFactor||[0,0,0]),"MASK"===e.alphaMode){const{alphaCutoff:t=.5}=e;this.defines.ALPHA_CUTOFF=1,this.uniforms.u_AlphaCutoff=t}else"BLEND"===e.alphaMode&&(log$2.warn("BLEND alphaMode might not work well because it requires mesh sorting")(),Object.assign(this.parameters,{blend:!0,blendEquation:this.gl.FUNC_ADD,blendFunc:[this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA]}))}delete(){this.generatedTextures.forEach((e=>e.delete()))}}const vs$2="\n#if (__VERSION__ < 300)\n  #define _attr attribute\n#else\n  #define _attr in\n#endif\n\n  _attr vec4 POSITION;\n\n  #ifdef HAS_NORMALS\n    _attr vec4 NORMAL;\n  #endif\n\n  #ifdef HAS_TANGENTS\n    _attr vec4 TANGENT;\n  #endif\n\n  #ifdef HAS_UV\n    _attr vec2 TEXCOORD_0;\n  #endif\n\n  void main(void) {\n    vec4 _NORMAL = vec4(0.);\n    vec4 _TANGENT = vec4(0.);\n    vec2 _TEXCOORD_0 = vec2(0.);\n\n    #ifdef HAS_NORMALS\n      _NORMAL = NORMAL;\n    #endif\n\n    #ifdef HAS_TANGENTS\n      _TANGENT = TANGENT;\n    #endif\n\n    #ifdef HAS_UV\n      _TEXCOORD_0 = TEXCOORD_0;\n    #endif\n\n    pbr_setPositionNormalTangentUV(POSITION, _NORMAL, _TANGENT, _TEXCOORD_0);\n    gl_Position = u_MVPMatrix * POSITION;\n  }\n",fs$2="\n#if (__VERSION__ < 300)\n  #define fragmentColor gl_FragColor\n#else\n  out vec4 fragmentColor;\n#endif\n\n  void main(void) {\n    fragmentColor = pbr_filterColor(vec4(0));\n  }\n";function addVersionToShader(e,t){return isWebGL2$1(e)?"#version 300 es\n".concat(t):t}function createGLTFModel(e,t){const{id:i,drawMode:n,vertexCount:r,attributes:o,modelOptions:s}=t,a=new GLTFMaterialParser(e,t);log$2.info(4,"createGLTFModel defines: ",a.defines)();const l=[];l.push(...a.generatedTextures),l.push(...Object.values(o).map((e=>e.buffer)));const c=new ModelNode(e,{id:i,drawMode:n,vertexCount:r,modules:[pbr],parameters:a.parameters,vs:addVersionToShader(e,vs$2),fs:addVersionToShader(e,fs$2),managedResources:l,...s,defines:{...a.defines,...s.defines}});return c.setProps({attributes:o}),c.setUniforms(a.uniforms),c}const ATTRIBUTE_TYPE_TO_COMPONENTS$1={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},DEFAULT_OPTIONS={modelOptions:{},pbrDebug:!1,imageBasedLightingEnvironment:null,lights:!0,useTangents:!1};class GLTFInstantiator{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=e,this.options=Object.assign({},DEFAULT_OPTIONS,t)}instantiate(e){this.gltf=e;return(e.scenes||[]).map((e=>this.createScene(e)))}createAnimator(){return Array.isArray(this.gltf.animations)?new GLTFAnimator(this.gltf):null}createScene(e){const t=(e.nodes||[]).map((e=>this.createNode(e)));return new GroupNode({id:e.name||e.id,children:t})}createNode(e){if(!e._node){const t=(e.children||[]).map((e=>this.createNode(e)));e.mesh&&t.push(this.createMesh(e.mesh));const i=new GroupNode({id:e.name||e.id,children:t});if(e.matrix)i.setMatrix(e.matrix);else{if(i.matrix.identity(),e.translation&&i.matrix.translate(e.translation),e.rotation){const t=(new Matrix4$1).fromQuaternion(e.rotation);i.matrix.multiplyRight(t)}e.scale&&i.matrix.scale(e.scale)}e._node=i}return e._node}createMesh(e){if(!e._mesh){const t=(e.primitives||[]).map(((t,i)=>this.createPrimitive(t,i,e))),i=new GroupNode({id:e.name||e.id,children:t});e._mesh=i}return e._mesh}getVertexCount(e){log$2.warn("getVertexCount() not found")()}createPrimitive(e,t,i){const n=createGLTFModel(this.gl,Object.assign({id:e.name||"".concat(i.name||i.id,"-primitive-").concat(t),drawMode:e.mode||4,vertexCount:e.indices?e.indices.count:this.getVertexCount(e.attributes),attributes:this.createAttributes(e.attributes,e.indices),material:e.material},this.options));return n.bounds=[e.attributes.POSITION.min,e.attributes.POSITION.max],n}createAttributes(e,t){const i={};return Object.keys(e).forEach((t=>{i[t]=this.createAccessor(e[t],this.createBuffer(e[t],this.gl.ARRAY_BUFFER))})),t&&(i.indices=this.createAccessor(t,this.createBuffer(t,this.gl.ELEMENT_ARRAY_BUFFER))),log$2.info(4,"glTF Attributes",{attributes:e,indices:t,generated:i})(),i}createBuffer(e,t){e.bufferView||(e.bufferView={});const{bufferView:i}=e;return i.lumaBuffers||(i.lumaBuffers={}),i.lumaBuffers[t]||(i.lumaBuffers[t]=new Buffer(this.gl,{id:"from-".concat(i.id),data:i.data||e.value,target:t})),i.lumaBuffers[t]}createAccessor(e,t){return new Accessor({buffer:t,offset:e.byteOffset||0,stride:e.bufferView.byteStride||0,type:e.componentType,size:ATTRIBUTE_TYPE_TO_COMPONENTS$1[e.type]})}createSampler(e){return e}needsPOT(){return!1}}function createGLTFObjects(e,t,i){const n=new GLTFInstantiator(e,i);return{scenes:n.instantiate(t),animator:n.createAnimator()}}const VERSION$4="3.4.15",VERSION$3="3.4.15",VERSION$2="3.4.15",BASIS_CDN_ENCODER_WASM="https://unpkg.com/@loaders.gl/textures@".concat(VERSION$2,"/dist/libs/basis_encoder.wasm"),BASIS_CDN_ENCODER_JS="https://unpkg.com/@loaders.gl/textures@".concat(VERSION$2,"/dist/libs/basis_encoder.js");let loadBasisTranscoderPromise,loadBasisEncoderPromise;async function loadBasisTrascoderModule(e){const t=e.modules||{};return t.basis?t.basis:(loadBasisTranscoderPromise=loadBasisTranscoderPromise||loadBasisTrascoder(e),await loadBasisTranscoderPromise)}async function loadBasisTrascoder(e){let t=null,i=null;return[t,i]=await Promise.all([await loadLibrary("basis_transcoder.js","textures",e),await loadLibrary("basis_transcoder.wasm","textures",e)]),t=t||globalThis.BASIS,await initializeBasisTrascoderModule(t,i)}function initializeBasisTrascoderModule(e,t){const i={};return t&&(i.wasmBinary=t),new Promise((t=>{e(i).then((e=>{const{BasisFile:i,initializeBasis:n}=e;n(),t({BasisFile:i})}))}))}async function loadBasisEncoderModule(e){const t=e.modules||{};return t.basisEncoder?t.basisEncoder:(loadBasisEncoderPromise=loadBasisEncoderPromise||loadBasisEncoder(e),await loadBasisEncoderPromise)}async function loadBasisEncoder(e){let t=null,i=null;return[t,i]=await Promise.all([await loadLibrary(BASIS_CDN_ENCODER_JS,"textures",e),await loadLibrary(BASIS_CDN_ENCODER_WASM,"textures",e)]),t=t||globalThis.BASIS,await initializeBasisEncoderModule(t,i)}function initializeBasisEncoderModule(e,t){const i={};return t&&(i.wasmBinary=t),new Promise((t=>{e(i).then((e=>{const{BasisFile:i,KTX2File:n,initializeBasis:r,BasisEncoder:o}=e;r(),t({BasisFile:i,KTX2File:n,BasisEncoder:o})}))}))}const GL_EXTENSIONS_CONSTANTS={COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGBA_ASTC_4X4_KHR:37808},BROWSER_PREFIXES=["","WEBKIT_","MOZ_"],WEBGL_EXTENSIONS={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let formats=null;function getSupportedGPUTextureFormats(e){if(!formats){e=e||getWebGLContext()||void 0,formats=new Set;for(const t of BROWSER_PREFIXES)for(const i in WEBGL_EXTENSIONS)if(e&&e.getExtension("".concat(t).concat(i))){formats.add(WEBGL_EXTENSIONS[i])}}return formats}function getWebGLContext(){try{return document.createElement("canvas").getContext("webgl")}catch(e){return null}}var n,i,s,a,r,o,l,f;!function(e){e[e.NONE=0]="NONE",e[e.BASISLZ=1]="BASISLZ",e[e.ZSTD=2]="ZSTD",e[e.ZLIB=3]="ZLIB"}(n||(n={})),function(e){e[e.BASICFORMAT=0]="BASICFORMAT"}(i||(i={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.ETC1S=163]="ETC1S",e[e.UASTC=166]="UASTC"}(s||(s={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.SRGB=1]="SRGB"}(a||(a={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.LINEAR=1]="LINEAR",e[e.SRGB=2]="SRGB",e[e.ITU=3]="ITU",e[e.NTSC=4]="NTSC",e[e.SLOG=5]="SLOG",e[e.SLOG2=6]="SLOG2"}(r||(r={})),function(e){e[e.ALPHA_STRAIGHT=0]="ALPHA_STRAIGHT",e[e.ALPHA_PREMULTIPLIED=1]="ALPHA_PREMULTIPLIED"}(o||(o={})),function(e){e[e.RGB=0]="RGB",e[e.RRR=3]="RRR",e[e.GGG=4]="GGG",e[e.AAA=15]="AAA"}(l||(l={})),function(e){e[e.RGB=0]="RGB",e[e.RGBA=3]="RGBA",e[e.RRR=4]="RRR",e[e.RRRG=5]="RRRG"}(f||(f={}));const KTX2_ID=[171,75,84,88,32,50,48,187,13,10,26,10];function isKTX(e){const t=new Uint8Array(e);return!(t.byteLength<KTX2_ID.length||t[0]!==KTX2_ID[0]||t[1]!==KTX2_ID[1]||t[2]!==KTX2_ID[2]||t[3]!==KTX2_ID[3]||t[4]!==KTX2_ID[4]||t[5]!==KTX2_ID[5]||t[6]!==KTX2_ID[6]||t[7]!==KTX2_ID[7]||t[8]!==KTX2_ID[8]||t[9]!==KTX2_ID[9]||t[10]!==KTX2_ID[10]||t[11]!==KTX2_ID[11])}const OutputFormat={etc1:{basisFormat:0,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGB_ETC1_WEBGL},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGB_S3TC_DXT1_EXT},bc3:{basisFormat:3,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGBA_S3TC_DXT5_EXT},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGB_PVRTC_4BPPV1_IMG},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG},"astc-4x4":{basisFormat:10,compressed:!0,format:GL_EXTENSIONS_CONSTANTS.COMPRESSED_RGBA_ASTC_4X4_KHR},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};async function parseBasis(e,t){if("auto"===t.basis.containerFormat){if(isKTX(e)){return parseKTX2File((await loadBasisEncoderModule(t)).KTX2File,e,t)}const{BasisFile:i}=await loadBasisTrascoderModule(t);return parseBasisFile(i,e,t)}if("encoder"===t.basis.module){const i=await loadBasisEncoderModule(t);return"ktx2"===t.basis.containerFormat?parseKTX2File(i.KTX2File,e,t):parseBasisFile(i.BasisFile,e,t)}{const{BasisFile:i}=await loadBasisTrascoderModule(t);return parseBasisFile(i,e,t)}}function parseBasisFile(e,t,i){const n=new e(new Uint8Array(t));try{if(!n.startTranscoding())throw new Error("Failed to start basis transcoding");const e=n.getNumImages(),t=[];for(let r=0;r<e;r++){const e=n.getNumLevels(r),o=[];for(let t=0;t<e;t++)o.push(transcodeImage(n,r,t,i));t.push(o)}return t}finally{n.close(),n.delete()}}function transcodeImage(e,t,i,n){const r=e.getImageWidth(t,i),o=e.getImageHeight(t,i),s=e.getHasAlpha(),{compressed:a,format:l,basisFormat:c}=getBasisOptions(n,s),u=e.getImageTranscodedSizeInBytes(t,i,c),h=new Uint8Array(u);if(!e.transcodeImage(h,t,i,c,0,0))throw new Error("failed to start Basis transcoding");return{width:r,height:o,data:h,compressed:a,format:l,hasAlpha:s}}function parseKTX2File(e,t,i){const n=new e(new Uint8Array(t));try{if(!n.startTranscoding())throw new Error("failed to start KTX2 transcoding");const e=n.getLevels(),t=[];for(let r=0;r<e;r++){t.push(transcodeKTX2Image(n,r,i));break}return[t]}finally{n.close(),n.delete()}}function transcodeKTX2Image(e,t,i){const{alphaFlag:n,height:r,width:o}=e.getImageLevelInfo(t,0,0),{compressed:s,format:a,basisFormat:l}=getBasisOptions(i,n),c=e.getImageTranscodedSizeInBytes(t,0,0,l),u=new Uint8Array(c);if(!e.transcodeImage(u,t,0,0,l,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:o,height:r,data:u,compressed:s,levelSize:c,hasAlpha:n,format:a}}function getBasisOptions(e,t){let i=e&&e.basis&&e.basis.format;return"auto"===i&&(i=selectSupportedBasisFormat()),"object"==typeof i&&(i=t?i.alpha:i.noAlpha),i=i.toLowerCase(),OutputFormat[i]}function selectSupportedBasisFormat(){const e=getSupportedGPUTextureFormats();return e.has("astc")?"astc-4x4":e.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:e.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:e.has("etc1")?"etc1":e.has("etc2")?"etc2":"rgb565"}const BasisWorkerLoader={name:"Basis",id:isBrowser$2?"basis":"basis-nodejs",module:"textures",version:VERSION$3,worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}},BasisLoader={...BasisWorkerLoader,parse:parseBasis};function assert$2(e,t){if(!e)throw new Error(t||"assert failed: gltf")}function resolveUrl(e,t){if(e.startsWith("data:")||e.startsWith("http:")||e.startsWith("https:"))return e;const i=t.baseUri||t.uri;if(!i)throw new Error("'baseUri' must be provided to resolve relative url ".concat(e));return i.substr(0,i.lastIndexOf("/")+1)+e}function getTypedArrayForBufferView(e,t,i){const n=e.bufferViews[i];assert$2(n);const r=t[n.buffer];assert$2(r);return new Uint8Array(r.arrayBuffer,(n.byteOffset||0)+r.byteOffset,n.byteLength)}const TYPES=["SCALAR","VEC2","VEC3","VEC4"],ARRAY_CONSTRUCTOR_TO_WEBGL_CONSTANT=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],ARRAY_TO_COMPONENT_TYPE=new Map(ARRAY_CONSTRUCTOR_TO_WEBGL_CONSTANT),ATTRIBUTE_TYPE_TO_COMPONENTS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function getAccessorTypeFromSize(e){return TYPES[e-1]||TYPES[0]}function getComponentTypeFromArray(e){const t=ARRAY_TO_COMPONENT_TYPE.get(e.constructor);if(!t)throw new Error("Illegal typed array");return t}function getAccessorArrayTypeAndLength(e,t){const i=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY[e.componentType],n=ATTRIBUTE_TYPE_TO_COMPONENTS[e.type],r=e.count*n,o=e.count*n*ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE[e.componentType];return assert$2(o>=0&&o<=t.byteLength),{ArrayType:i,length:r,byteLength:o}}function getMemoryUsageGLTF(e){let{images:t,bufferViews:i}=e;t=t||[],i=i||[];const n=t.map((e=>e.bufferView));i=i.filter((e=>!n.includes(e)));const r=i.reduce(((e,t)=>e+t.byteLength),0),o=t.reduce(((e,t)=>{const{width:i,height:n}=t.image;return e+i*n}),0);return r+Math.ceil(4*o*1.33)}const DEFAULT_GLTF_JSON={asset:{version:"2.0",generator:"loaders.gl"},buffers:[]};class GLTFScenegraph{constructor(e){_defineProperty(this,"gltf",void 0),_defineProperty(this,"sourceBuffers",void 0),_defineProperty(this,"byteLength",void 0),this.gltf=e||{json:{...DEFAULT_GLTF_JSON},buffers:[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}getExtension(e){const t=this.getUsedExtensions().find((t=>t===e));return t?(this.json.extensions||{})[e]||!0:null}getRequiredExtension(e){const t=this.getRequiredExtensions().find((t=>t===e));return t?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getRemovedExtensions(){return this.json.extensionsRemoved||[]}getObjectExtension(e,t){return(e.extensions||{})[t]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,t){if("object"==typeof t)return t;const i=this.json[e]&&this.json[e][t];if(!i)throw new Error("glTF file error: Could not find ".concat(e,"[").concat(t,"]"));return i}getTypedArrayForBufferView(e){e=this.getBufferView(e);const t=this.gltf.buffers[e.buffer];assert$2(t);return new Uint8Array(t.arrayBuffer,(e.byteOffset||0)+t.byteOffset,e.byteLength)}getTypedArrayForAccessor(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),i=this.getBuffer(t.buffer).data,{ArrayType:n,length:r}=getAccessorArrayTypeAndLength(e,t);return new n(i,t.byteOffset+e.byteOffset,r)}getTypedArrayForImageData(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),i=this.getBuffer(t.buffer);return new Uint8Array(i.data,t.byteOffset||0,t.byteLength)}addApplicationData(e,t){return this.json[e]=t,this}addExtraData(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}addObjectExtension(e,t,i){return e.extensions=e.extensions||{},e.extensions[t]=i,this.registerUsedExtension(t),this}setObjectExtension(e,t,i){(e.extensions||{})[t]=i}removeObjectExtension(e,t){const i=e.extensions||{},n=i[t];return delete i[t],n}addExtension(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return assert$2(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}addRequiredExtension(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return assert$2(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find((t=>t===e))||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find((t=>t===e))||this.json.extensionsRequired.push(e)}removeExtension(e){if(!this.getExtension(e))return;this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e),this.json.extensions&&delete this.json.extensions[e],Array.isArray(this.json.extensionsRemoved)||(this.json.extensionsRemoved=[]);const t=this.json.extensionsRemoved;t.includes(e)||t.push(e)}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:t}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}addNode(e){const{meshIndex:t,matrix:i}=e;this.json.nodes=this.json.nodes||[];const n={mesh:t};return i&&(n.matrix=i),this.json.nodes.push(n),this.json.nodes.length-1}addMesh(e){const{attributes:t,indices:i,material:n,mode:r=4}=e,o={primitives:[{attributes:this._addAttributes(t),mode:r}]};if(i){const e=this._addIndices(i);o.primitives[0].indices=e}return Number.isFinite(n)&&(o.primitives[0].material=n),this.json.meshes=this.json.meshes||[],this.json.meshes.push(o),this.json.meshes.length-1}addPointCloud(e){const t={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(t),this.json.meshes.length-1}addImage(e,t){const i=getBinaryImageMetadata(e),n=t||(null==i?void 0:i.mimeType),r={bufferView:this.addBufferView(e),mimeType:n};return this.json.images=this.json.images||[],this.json.images.push(r),this.json.images.length-1}addBufferView(e){const t=e.byteLength;assert$2(Number.isFinite(t)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const i={buffer:0,byteOffset:this.byteLength,byteLength:t};return this.byteLength+=padToNBytes(t,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(i),this.json.bufferViews.length-1}addAccessor(e,t){const i={bufferView:e,type:getAccessorTypeFromSize(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(i),this.json.accessors.length-1}addBinaryBuffer(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{size:3};const i=this.addBufferView(e);let n={min:t.min,max:t.max};n.min&&n.max||(n=this._getAccessorMinMax(e,t.size));const r={size:t.size,componentType:getComponentTypeFromArray(e),count:Math.round(e.length/t.size),min:n.min,max:n.max};return this.addAccessor(i,Object.assign(r,t))}addTexture(e){const{imageIndex:t}=e,i={source:t};return this.json.textures=this.json.textures||[],this.json.textures.push(i),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){var e,t;this.gltf.buffers=[];const i=this.byteLength,n=new ArrayBuffer(i),r=new Uint8Array(n);let o=0;for(const e of this.sourceBuffers||[])o=copyToArray(e,r,o);null!==(e=this.json)&&void 0!==e&&null!==(t=e.buffers)&&void 0!==t&&t[0]?this.json.buffers[0].byteLength=i:this.json.buffers=[{byteLength:i}],this.gltf.binary=n,this.sourceBuffers=[n]}_removeStringFromArray(e,t){let i=!0;for(;i;){const n=e.indexOf(t);n>-1?e.splice(n,1):i=!1}}_addAttributes(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t={};for(const i in e){const n=e[i],r=this._getGltfAttributeName(i),o=this.addBinaryBuffer(n.value,n);t[r]=o}return t}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,t){const i={min:null,max:null};if(e.length<t)return i;i.min=[],i.max=[];const n=e.subarray(0,t);for(const e of n)i.min.push(e),i.max.push(e);for(let n=t;n<e.length;n+=t)for(let r=0;r<t;r++)i.min[0+r]=Math.min(i.min[0+r],e[n+r]),i.max[0+r]=Math.max(i.max[0+r],e[n+r]);return i}}const wasm_base="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",wasm_simd="B9h9z9tFBBBF8dL9gBB9gLaaaaaFa9gEaaaB9gGaaB9gFaFaEQSBBFBFFGEGEGIILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBNn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBcI9z9iqlBMc/j9JSIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMkRIbaG97FaK978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAnDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAnDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBRnCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBHiCFD9tAiAPD9OD9hD9RHiDQBTFtGmEYIPLdKeOnH8ZAIAQJDBIBHpCFD9tApAPD9OD9hD9RHpAIASJDBIBHyCFD9tAyAPD9OD9hD9RHyDQBTFtGmEYIPLdKeOnH8cDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAnD9uHnDyBjGBAEAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnA8ZA8cDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNiV8ZcpMyS8cQ8df8eb8fHdApAyDQNiV8ZcpMyS8cQ8df8eb8fHiDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/xLGEaK978jUUUUBCAlHE8kUUUUBGXGXAGCI9HQBGXAFC98ZHI9FQBABRGCBRLEXAGAGDBBBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMBBAGCTJRGALCIJHLAI9JQBMMAIAF9PQFAEAFCEZHLCGWHGqCBCTAGl/8MBAEABAICGWJHIAG/8cBBGXAL9FQBAEAEDBIBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMIBMAIAEAG/8cBBSFMABAFC98ZHGT+HUUUBAGAF9PQBAEAFCEZHICEWHLJCBCAALl/8MBAEABAGCEWJHGAL/8cBBAEAIT+HUUUBAGAEAL/8cBBMAECAJ8kUUUUBM+yEGGaO97GXAF9FQBCBRGEXABCTJHEAEDBBBHICBDtHLCUU98D8cFCUU98D8cEHKD9OABDBBBHOAIDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAOAIDQBFGENVcMTtmYi8ZpyHICTD+sFD/6FHND/gFAICTD+rFCTD+sFD/6FHVD/gFD/kFD/lFHI9DB/+g6DYAVAIALD+2FHLAVCUUUU94DtHcD9OD9RD/kFHVAVD/mFAIAID/mFANALANAcD9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHLD/kFCTD+rFAVAND/mFALD/kFCggEDtD9OD9QHVAIAND/mFALD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHIDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAOAKD9OAVAIDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM94FEa8jUUUUBCAlHE8kUUUUBABAFC98ZHIT+JUUUBGXAIAF9PQBAEAFCEZHLCEWHFJCBCAAFl/8MBAEABAICEWJHBAF/8cBBAEALT+JUUUBABAEAF/8cBBMAECAJ8kUUUUBM/hEIGaF97FaL978jUUUUBCTlRGGXAF9FQBCBREEXAGABDBBBHIABCTJHLDBBBHKDQILKOSQfbPden8c8d8e8fHOCTD+sFHNCID+rFDMIBAB9DBBU8/DY9D/zI818/DYANCEDtD9QD/6FD/nFHNAIAKDQBFGENVcMTtmYi8ZpyHICTD+rFCTD+sFD/6FD/mFHKAKD/mFANAICTD+sFD/6FD/mFHVAVD/mFANAOCTD+rFCTD+sFD/6FD/mFHOAOD/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHND/mF9DBBX9LDYHID/kFCggEDtHcD9OAVAND/mFAID/kFCTD+rFD9QHVAOAND/mFAID/kFCTD+rFAKAND/mFAID/kFAcD9OD9QHNDQBFTtGEmYILPdKOenHID8dBAGDBIBDyB+t+J83EBABCNJAID8dFAGDBIBDyF+t+J83EBALAVANDQNVi8ZcMpySQ8c8dfb8e8fHND8dBAGDBIBDyG+t+J83EBABCiJAND8dFAGDBIBDyE+t+J83EBABCAJRBAECIJHEAF9JQBMMM/3FGEaF978jUUUUBCoBlREGXAGCGrAF9sHIC98ZHL9FQBCBRGABRFEXAFAFDBBBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBAFCTJRFAGCIJHGAL9JQBMMGXALAI9PQBAEAICEZHGCGWHFqCBCoBAFl/8MBAEABALCGWJHLAF/8cBBGXAG9FQBAEAEDBIBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMIBMALAEAF/8cBBMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",detector=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),wasmpack=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),FILTERS={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},DECODERS={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function meshoptDecodeGltfBuffer(e,t,i,n,r){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"NONE";const s=await loadWasmInstance();decode$8(s,s.exports[DECODERS[r]],e,t,i,n,s.exports[FILTERS[o||"NONE"]])}let wasmPromise;async function loadWasmInstance(){return wasmPromise||(wasmPromise=loadWasmModule()),wasmPromise}async function loadWasmModule(){let e=wasm_base;WebAssembly.validate(detector)&&(e=wasm_simd);const t=await WebAssembly.instantiate(unpack(e),{});return await t.instance.exports.__wasm_call_ctors(),t.instance}function unpack(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;++i){const n=e.charCodeAt(i);t[i]=n>96?n-71:n>64?n-65:n>47?n+4:n>46?63:62}let i=0;for(let n=0;n<e.length;++n)t[i++]=t[n]<60?wasmpack[t[n]]:64*(t[n]-60)+t[++n];return t.buffer.slice(0,i)}function decode$8(e,t,i,n,r,o,s){const a=e.exports.sbrk,l=n+3&-4,c=a(l*r),u=a(o.length),h=new Uint8Array(e.exports.memory.buffer);h.set(o,u);const d=t(c,n,r,u,o.length);if(0===d&&s&&s(c,l,r),i.set(h.subarray(c,c+n*r)),a(c-a(0)),0!==d)throw new Error("Malformed buffer data: ".concat(d))}const EXT_MESHOPT_COMPRESSION="EXT_meshopt_compression",name$8=EXT_MESHOPT_COMPRESSION;async function decode$7(e,t){var i;const n=new GLTFScenegraph(e);if(null==t||null===(i=t.gltf)||void 0===i||!i.decompressMeshes)return;const r=[];for(const t of e.json.bufferViews||[])r.push(decodeMeshoptBufferView(n,t));await Promise.all(r),n.removeExtension(EXT_MESHOPT_COMPRESSION)}async function decodeMeshoptBufferView(e,t){const i=e.getObjectExtension(t,EXT_MESHOPT_COMPRESSION);if(i){const{byteOffset:n=0,byteLength:r=0,byteStride:o,count:s,mode:a,filter:l="NONE",buffer:c}=i,u=e.gltf.buffers[c],h=new Uint8Array(u.arrayBuffer,u.byteOffset+n,r),d=new Uint8Array(e.gltf.buffers[t.buffer].arrayBuffer,t.byteOffset,t.byteLength);return await meshoptDecodeGltfBuffer(d,s,o,h,a,l),d}return null}var EXT_meshopt_compression=Object.freeze({__proto__:null,decode:decode$7,name:name$8});let supportedImageFormats;getSupportedImageFormats().then((e=>{supportedImageFormats=e}));const EXT_TEXTURE_WEBP="EXT_texture_webp",name$7=EXT_TEXTURE_WEBP;function preprocess$3(e,t){const i=new GLTFScenegraph(e);if(!supportedImageFormats.has("image/webp")){if(i.getRequiredExtensions().includes(EXT_TEXTURE_WEBP))throw new Error("gltf: Required extension ".concat(EXT_TEXTURE_WEBP," not supported by browser"));return}const{json:n}=i;for(const e of n.textures||[]){const t=i.getObjectExtension(e,EXT_TEXTURE_WEBP);t&&(e.source=t.source),i.removeObjectExtension(e,EXT_TEXTURE_WEBP)}i.removeExtension(EXT_TEXTURE_WEBP)}var EXT_texture_webp=Object.freeze({__proto__:null,name:name$7,preprocess:preprocess$3});const KHR_TEXTURE_BASISU="KHR_texture_basisu",name$6=KHR_TEXTURE_BASISU;function preprocess$2(e,t){const i=new GLTFScenegraph(e),{json:n}=i;for(const e of n.textures||[]){const t=i.getObjectExtension(e,KHR_TEXTURE_BASISU);t&&(e.source=t.source),i.removeObjectExtension(e,KHR_TEXTURE_BASISU)}i.removeExtension(KHR_TEXTURE_BASISU)}var KHR_texture_basisu=Object.freeze({__proto__:null,name:name$6,preprocess:preprocess$2});const VERSION$1="3.4.15",DEFAULT_DRACO_OPTIONS={draco:{decoderType:"object"==typeof WebAssembly?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}},DracoLoader$1={name:"Draco",id:isBrowser$2?"draco":"draco-nodejs",module:"draco",shapes:["mesh"],version:VERSION$1,worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:DEFAULT_DRACO_OPTIONS};function getDracoSchema(e,t,i){const n=makeMetadata(t.metadata),r=[],o=transformAttributesLoaderData(t.attributes);for(const t in e){const i=getArrowFieldFromAttribute(t,e[t],o[t]);r.push(i)}if(i){const e=getArrowFieldFromAttribute("indices",i);r.push(e)}return new Schema(r,n)}function transformAttributesLoaderData(e){const t={};for(const i in e){const n=e[i];t[n.name||"undefined"]=n}return t}function getArrowFieldFromAttribute(e,t,i){return deduceMeshField(e,t,i?makeMetadata(i.metadata):void 0)}function makeMetadata(e){const t=new Map;for(const i in e)t.set("".concat(i,".string"),JSON.stringify(e[i]));return t}const DRACO_TO_GLTF_ATTRIBUTE_NAME_MAP={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},DRACO_DATA_TYPE_TO_TYPED_ARRAY_MAP={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array},INDEX_ITEM_SIZE=4;class DracoParser{constructor(e){_defineProperty(this,"draco",void 0),_defineProperty(this,"decoder",void 0),_defineProperty(this,"metadataQuerier",void 0),this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new this.draco.DecoderBuffer;i.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);const n=this.decoder.GetEncodedGeometryType(i),r=n===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let e;switch(n){case this.draco.TRIANGULAR_MESH:e=this.decoder.DecodeBufferToMesh(i,r);break;case this.draco.POINT_CLOUD:e=this.decoder.DecodeBufferToPointCloud(i,r);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!e.ok()||!r.ptr){const t="DRACO decompression failed: ".concat(e.error_msg());throw new Error(t)}const o=this._getDracoLoaderData(r,n,t),s=this._getMeshData(r,o,t),a=getMeshBoundingBox(s.attributes),l=getDracoSchema(s.attributes,o,s.indices);return{loader:"draco",loaderData:o,header:{vertexCount:r.num_points(),boundingBox:a},...s,schema:l}}finally{this.draco.destroy(i),r&&this.draco.destroy(r)}}_getDracoLoaderData(e,t,i){const n=this._getTopLevelMetadata(e),r=this._getDracoAttributes(e,i);return{geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:n,attributes:r}}_getDracoAttributes(e,t){const i={};for(let n=0;n<e.num_attributes();n++){const r=this.decoder.GetAttribute(e,n),o=this._getAttributeMetadata(e,n);i[r.unique_id()]={unique_id:r.unique_id(),attribute_type:r.attribute_type(),data_type:r.data_type(),num_components:r.num_components(),byte_offset:r.byte_offset(),byte_stride:r.byte_stride(),normalized:r.normalized(),attribute_index:n,metadata:o};const s=this._getQuantizationTransform(r,t);s&&(i[r.unique_id()].quantization_transform=s);const a=this._getOctahedronTransform(r,t);a&&(i[r.unique_id()].octahedron_transform=a)}return i}_getMeshData(e,t,i){const n=this._getMeshAttributes(t,e,i);if(!n.POSITION)throw new Error("DRACO: No position attribute found.");return e instanceof this.draco.Mesh?"triangle-strip"===i.topology?{topology:"triangle-strip",mode:4,attributes:n,indices:{value:this._getTriangleStripIndices(e),size:1}}:{topology:"triangle-list",mode:5,attributes:n,indices:{value:this._getTriangleListIndices(e),size:1}}:{topology:"point-list",mode:0,attributes:n}}_getMeshAttributes(e,t,i){const n={};for(const r of Object.values(e.attributes)){const e=this._deduceAttributeName(r,i);r.name=e;const{value:o,size:s}=this._getAttributeValues(t,r);n[e]={value:o,size:s,byteOffset:r.byte_offset,byteStride:r.byte_stride,normalized:r.normalized}}return n}_getTriangleListIndices(e){const t=3*e.num_faces(),i=t*INDEX_ITEM_SIZE,n=this.draco._malloc(i);try{return this.decoder.GetTrianglesUInt32Array(e,i,n),new Uint32Array(this.draco.HEAPF32.buffer,n,t).slice()}finally{this.draco._free(n)}}_getTriangleStripIndices(e){const t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),getUint32Array(t)}finally{this.draco.destroy(t)}}_getAttributeValues(e,t){const i=DRACO_DATA_TYPE_TO_TYPED_ARRAY_MAP[t.data_type],n=t.num_components,r=e.num_points()*n,o=r*i.BYTES_PER_ELEMENT,s=getDracoDataType(this.draco,i);let a;const l=this.draco._malloc(o);try{const n=this.decoder.GetAttribute(e,t.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,n,s,o,l),a=new i(this.draco.HEAPF32.buffer,l,r).slice()}finally{this.draco._free(l)}return{value:a,size:n}}_deduceAttributeName(e,t){const i=e.unique_id;for(const[e,n]of Object.entries(t.extraAttributes||{}))if(n===i)return e;const n=e.attribute_type;for(const e in DRACO_TO_GLTF_ATTRIBUTE_NAME_MAP){if(this.draco[e]===n)return DRACO_TO_GLTF_ATTRIBUTE_NAME_MAP[e]}const r=t.attributeNameEntry||"name";return e.metadata[r]?e.metadata[r].string:"CUSTOM_ATTRIBUTE_".concat(i)}_getTopLevelMetadata(e){const t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}_getAttributeMetadata(e,t){const i=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(i)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const t={},i=this.metadataQuerier.NumEntries(e);for(let n=0;n<i;n++){const i=this.metadataQuerier.GetEntryName(e,n);t[i]=this._getDracoMetadataField(e,i)}return t}_getDracoMetadataField(e,t){const i=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,i);const n=getInt32Array(i);return{int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:n}}finally{this.draco.destroy(i)}}_disableAttributeTransforms(e){const{quantizedAttributes:t=[],octahedronAttributes:i=[]}=e,n=[...t,...i];for(const e of n)this.decoder.SkipAttributeTransform(this.draco[e])}_getQuantizationTransform(e,t){const{quantizedAttributes:i=[]}=t,n=e.attribute_type();if(i.map((e=>this.decoder[e])).includes(n)){const t=new this.draco.AttributeQuantizationTransform;try{if(t.InitFromAttribute(e))return{quantization_bits:t.quantization_bits(),range:t.range(),min_values:new Float32Array([1,2,3]).map((e=>t.min_value(e)))}}finally{this.draco.destroy(t)}}return null}_getOctahedronTransform(e,t){const{octahedronAttributes:i=[]}=t,n=e.attribute_type();if(i.map((e=>this.decoder[e])).includes(n)){const t=new this.draco.AttributeQuantizationTransform;try{if(t.InitFromAttribute(e))return{quantization_bits:t.quantization_bits()}}finally{this.draco.destroy(t)}}return null}}function getDracoDataType(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32;default:return e.DT_INVALID}}function getInt32Array(e){const t=e.size(),i=new Int32Array(t);for(let n=0;n<t;n++)i[n]=e.GetValue(n);return i}function getUint32Array(e){const t=e.size(),i=new Int32Array(t);for(let n=0;n<t;n++)i[n]=e.GetValue(n);return i}const DRACO_DECODER_VERSION="1.5.5",STATIC_DECODER_URL="https://www.gstatic.com/draco/versioned/decoders/".concat(DRACO_DECODER_VERSION),DRACO_JS_DECODER_URL="".concat(STATIC_DECODER_URL,"/draco_decoder.js"),DRACO_WASM_WRAPPER_URL="".concat(STATIC_DECODER_URL,"/draco_wasm_wrapper.js"),DRACO_WASM_DECODER_URL="".concat(STATIC_DECODER_URL,"/draco_decoder.wasm");let loadDecoderPromise;async function loadDracoDecoderModule(e){const t=e.modules||{};return loadDecoderPromise=t.draco3d?loadDecoderPromise||t.draco3d.createDecoderModule({}).then((e=>({draco:e}))):loadDecoderPromise||loadDracoDecoder(e),await loadDecoderPromise}async function loadDracoDecoder(e){let t,i;if("js"===(e.draco&&e.draco.decoderType))t=await loadLibrary(DRACO_JS_DECODER_URL,"draco",e);else[t,i]=await Promise.all([await loadLibrary(DRACO_WASM_WRAPPER_URL,"draco",e),await loadLibrary(DRACO_WASM_DECODER_URL,"draco",e)]);return t=t||globalThis.DracoDecoderModule,await initializeDracoDecoder(t,i)}function initializeDracoDecoder(e,t){const i={};return t&&(i.wasmBinary=t),new Promise((t=>{e({...i,onModuleLoaded:e=>t({draco:e})})}))}const DracoLoader={...DracoLoader$1,parse:parse$2};async function parse$2(e,t){const{draco:i}=await loadDracoDecoderModule(t),n=new DracoParser(i);try{return n.parseSync(e,null==t?void 0:t.draco)}finally{n.destroy()}}function getGLTFAccessors(e){const t={};for(const i in e){if("indices"!==i){const n=getGLTFAccessor(e[i]);t[i]=n}}return t}function getGLTFAccessor(e){const{buffer:t,size:i,count:n}=getAccessorData(e);return{value:t,size:i,byteOffset:0,count:n,type:getAccessorTypeFromSize(i),componentType:getComponentTypeFromArray(t)}}function getAccessorData(e){let t=e,i=1,n=0;return e&&e.value&&(t=e.value,i=e.size||1),t&&(ArrayBuffer.isView(t)||(t=toTypedArray(t,Float32Array)),n=t.length/i),{buffer:t,size:i,count:n}}function toTypedArray(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e?Array.isArray(e)?new t(e):!i||e instanceof t?e:new t(e):null}const KHR_DRACO_MESH_COMPRESSION="KHR_draco_mesh_compression",name$5=KHR_DRACO_MESH_COMPRESSION;function preprocess$1(e,t,i){const n=new GLTFScenegraph(e);for(const e of makeMeshPrimitiveIterator(n))n.getObjectExtension(e,KHR_DRACO_MESH_COMPRESSION)}async function decode$6(e,t,i){var n;if(null==t||null===(n=t.gltf)||void 0===n||!n.decompressMeshes)return;const r=new GLTFScenegraph(e),o=[];for(const e of makeMeshPrimitiveIterator(r))r.getObjectExtension(e,KHR_DRACO_MESH_COMPRESSION)&&o.push(decompressPrimitive(r,e,t,i));await Promise.all(o),r.removeExtension(KHR_DRACO_MESH_COMPRESSION)}function encode$3(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new GLTFScenegraph(e);for(const e of i.json.meshes||[])compressMesh(e,t),i.addRequiredExtension(KHR_DRACO_MESH_COMPRESSION)}async function decompressPrimitive(e,t,i,n){const r=e.getObjectExtension(t,KHR_DRACO_MESH_COMPRESSION);if(!r)return;const o=e.getTypedArrayForBufferView(r.bufferView),s=sliceArrayBuffer(o.buffer,o.byteOffset),{parse:a}=n,l={...i};delete l["3d-tiles"];const c=await a(s,DracoLoader,l,n),u=getGLTFAccessors(c.attributes);for(const[i,n]of Object.entries(u))if(i in t.attributes){const r=e.getAccessor(t.attributes[i]);null!=r&&r.min&&null!=r&&r.max&&(n.min=r.min,n.max=r.max)}t.attributes=u,c.indices&&(t.indices=getGLTFAccessor(c.indices)),checkPrimitive(t)}function compressMesh(e,t){var i;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,r=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;if(!r.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const s=r.DracoWriter.encodeSync({attributes:e}),a=null==o||null===(i=o.parseSync)||void 0===i?void 0:i.call(o,{attributes:e}),l=r._addFauxAttributes(a.attributes),c=r.addBufferView(s);return{primitives:[{attributes:l,mode:n,extensions:{[KHR_DRACO_MESH_COMPRESSION]:{bufferView:c,attributes:l}}}]}}function checkPrimitive(e){if(!e.attributes&&Object.keys(e.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}function*makeMeshPrimitiveIterator(e){for(const t of e.json.meshes||[])for(const e of t.primitives)yield e}var KHR_draco_mesh_compression=Object.freeze({__proto__:null,decode:decode$6,encode:encode$3,name:name$5,preprocess:preprocess$1});const COMPONENTS$1={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},BYTES$1={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},EXT_MESHOPT_TRANSFORM="KHR_texture_transform",name$4=EXT_MESHOPT_TRANSFORM,scratchVector$5=new Vector3$1,scratchRotationMatrix=new Matrix3$1,scratchScaleMatrix=new Matrix3$1;async function decode$5(e,t){if(!new GLTFScenegraph(e).getExtension(EXT_MESHOPT_TRANSFORM))return;const i=e.json.materials||[];for(let t=0;t<i.length;t++)transformTexCoords(t,e)}function transformTexCoords(e,t){var i,n,r;const o=[],s=null===(i=t.json.materials)||void 0===i?void 0:i[e],a=null==s||null===(n=s.pbrMetallicRoughness)||void 0===n?void 0:n.baseColorTexture;a&&transformPrimitives(t,e,a,o);const l=null==s?void 0:s.emissiveTexture;l&&transformPrimitives(t,e,l,o);const c=null==s?void 0:s.normalTexture;c&&transformPrimitives(t,e,c,o);const u=null==s?void 0:s.occlusionTexture;u&&transformPrimitives(t,e,u,o);const h=null==s||null===(r=s.pbrMetallicRoughness)||void 0===r?void 0:r.metallicRoughnessTexture;h&&transformPrimitives(t,e,h,o)}function transformPrimitives(e,t,i,n){const r=getTransformParameters(i,n);if(!r)return;const o=e.json.meshes||[];for(const i of o)for(const n of i.primitives){const i=n.material;Number.isFinite(i)&&t===i&&transformPrimitive(e,n,r)}}function getTransformParameters(e,t){var i;const n=null===(i=e.extensions)||void 0===i?void 0:i[EXT_MESHOPT_TRANSFORM],{texCoord:r=0}=e,{texCoord:o=r}=n;if(!(-1!==t.findIndex((e=>{let[t,i]=e;return t===r&&i===o})))){const i=makeTransformationMatrix(n);return r!==o&&(e.texCoord=o),t.push([r,o]),{originalTexCoord:r,texCoord:o,matrix:i}}return null}function transformPrimitive(e,t,i){const{originalTexCoord:n,texCoord:r,matrix:o}=i,s=t.attributes["TEXCOORD_".concat(n)];if(Number.isFinite(s)){var a;const i=null===(a=e.json.accessors)||void 0===a?void 0:a[s];if(i&&i.bufferView){var l;const s=null===(l=e.json.bufferViews)||void 0===l?void 0:l[i.bufferView];if(s){const{arrayBuffer:a,byteOffset:l}=e.buffers[s.buffer],c=(l||0)+(i.byteOffset||0)+(s.byteOffset||0),{ArrayType:u,length:h}=getAccessorArrayTypeAndLength(i,s),d=COMPONENTS$1[i.type],p=s.byteStride||BYTES$1[i.componentType]*d,f=new Float32Array(h);for(let e=0;e<i.count;e++){const t=new u(a,c+e*p,2);scratchVector$5.set(t[0],t[1],1),scratchVector$5.transformByMatrix3(o),f.set([scratchVector$5[0],scratchVector$5[1]],e*d)}n===r?updateGltf(i,s,e.buffers,f):createAttribute(r,i,t,e,f)}}}}function updateGltf(e,t,i,n){e.componentType=5126,i.push({arrayBuffer:n.buffer,byteOffset:0,byteLength:n.buffer.byteLength}),t.buffer=i.length-1,t.byteLength=n.buffer.byteLength,t.byteOffset=0,delete t.byteStride}function createAttribute(e,t,i,n,r){n.buffers.push({arrayBuffer:r.buffer,byteOffset:0,byteLength:r.buffer.byteLength});const o=n.json.bufferViews;if(!o)return;o.push({buffer:n.buffers.length-1,byteLength:r.buffer.byteLength,byteOffset:0});const s=n.json.accessors;s&&(s.push({bufferView:(null==o?void 0:o.length)-1,byteOffset:0,componentType:5126,count:t.count,type:"VEC2"}),i.attributes["TEXCOORD_".concat(e)]=s.length-1)}function makeTransformationMatrix(e){const{offset:t=[0,0],rotation:i=0,scale:n=[1,1]}=e,r=(new Matrix3$1).set(1,0,0,0,1,0,t[0],t[1],1),o=scratchRotationMatrix.set(Math.cos(i),Math.sin(i),0,-Math.sin(i),Math.cos(i),0,0,0,1),s=scratchScaleMatrix.set(n[0],0,0,0,n[1],0,0,0,1);return r.multiplyRight(o).multiplyRight(s)}var KHR_texture_transform=Object.freeze({__proto__:null,decode:decode$5,name:name$4});const KHR_LIGHTS_PUNCTUAL="KHR_lights_punctual",name$3=KHR_LIGHTS_PUNCTUAL;async function decode$4(e){const t=new GLTFScenegraph(e),{json:i}=t,n=t.getExtension(KHR_LIGHTS_PUNCTUAL);n&&(t.json.lights=n.lights,t.removeExtension(KHR_LIGHTS_PUNCTUAL));for(const e of i.nodes||[]){const i=t.getObjectExtension(e,KHR_LIGHTS_PUNCTUAL);i&&(e.light=i.light),t.removeObjectExtension(e,KHR_LIGHTS_PUNCTUAL)}}async function encode$2(e){const t=new GLTFScenegraph(e),{json:i}=t;if(i.lights){const e=t.addExtension(KHR_LIGHTS_PUNCTUAL);assert$2(!e.lights),e.lights=i.lights,delete i.lights}if(t.json.lights){for(const e of t.json.lights){t.addObjectExtension(e.node,KHR_LIGHTS_PUNCTUAL,e)}delete t.json.lights}}var KHR_lights_punctual=Object.freeze({__proto__:null,decode:decode$4,encode:encode$2,name:name$3});const KHR_MATERIALS_UNLIT="KHR_materials_unlit",name$2=KHR_MATERIALS_UNLIT;async function decode$3(e){const t=new GLTFScenegraph(e),{json:i}=t;for(const e of i.materials||[]){e.extensions&&e.extensions.KHR_materials_unlit&&(e.unlit=!0),t.removeObjectExtension(e,KHR_MATERIALS_UNLIT)}t.removeExtension(KHR_MATERIALS_UNLIT)}function encode$1(e){const t=new GLTFScenegraph(e),{json:i}=t;if(t.materials)for(const e of i.materials||[])e.unlit&&(delete e.unlit,t.addObjectExtension(e,KHR_MATERIALS_UNLIT,{}),t.addExtension(KHR_MATERIALS_UNLIT))}var KHR_materials_unlit=Object.freeze({__proto__:null,decode:decode$3,encode:encode$1,name:name$2});const KHR_TECHNIQUES_WEBGL="KHR_techniques_webgl",name$1=KHR_TECHNIQUES_WEBGL;async function decode$2(e){const t=new GLTFScenegraph(e),{json:i}=t,n=t.getExtension(KHR_TECHNIQUES_WEBGL);if(n){const e=resolveTechniques(n,t);for(const n of i.materials||[]){const i=t.getObjectExtension(n,KHR_TECHNIQUES_WEBGL);i&&(n.technique=Object.assign({},i,e[i.technique]),n.technique.values=resolveValues(n.technique,t)),t.removeObjectExtension(n,KHR_TECHNIQUES_WEBGL)}t.removeExtension(KHR_TECHNIQUES_WEBGL)}}async function encode(e,t){}function resolveTechniques(e,t){const{programs:i=[],shaders:n=[],techniques:r=[]}=e,o=new TextDecoder;return n.forEach((e=>{if(!Number.isFinite(e.bufferView))throw new Error("KHR_techniques_webgl: no shader code");e.code=o.decode(t.getTypedArrayForBufferView(e.bufferView))})),i.forEach((e=>{e.fragmentShader=n[e.fragmentShader],e.vertexShader=n[e.vertexShader]})),r.forEach((e=>{e.program=i[e.program]})),r}function resolveValues(e,t){const i=Object.assign({},e.values);return Object.keys(e.uniforms||{}).forEach((t=>{e.uniforms[t].value&&!(t in i)&&(i[t]=e.uniforms[t].value)})),Object.keys(i).forEach((e=>{"object"==typeof i[e]&&void 0!==i[e].index&&(i[e].texture=t.getTexture(i[e].index))})),i}var KHR_techniques_webgl=Object.freeze({__proto__:null,decode:decode$2,encode:encode,name:name$1});const EXT_FEATURE_METADATA="EXT_feature_metadata",name=EXT_FEATURE_METADATA;async function decode$1(e){decodeExtFeatureMetadata(new GLTFScenegraph(e))}function decodeExtFeatureMetadata(e){var t;const i=e.getExtension(EXT_FEATURE_METADATA),n=null==i||null===(t=i.schema)||void 0===t?void 0:t.classes,r=null==i?void 0:i.featureTables;if(n&&r)for(const t in n){const i=n[t],o=findFeatureTableByName(r,t);o&&handleFeatureTableProperties(e,o,i)}}function handleFeatureTableProperties(e,t,i){for(const r in i.properties){var n;const o=null==t||null===(n=t.properties)||void 0===n?void 0:n[r];if(o){const n=getPropertyDataFromBinarySource(e,i.properties[r],t.count,o);o.data=n}}}function getPropertyDataFromBinarySource(e,t,i,n){let r=e.getTypedArrayForBufferView(n.bufferView);switch(t.type){case"STRING":r=getStringAttributes(r,e.getTypedArrayForBufferView(n.stringOffsetBufferView),i);break}return r}function findFeatureTableByName(e,t){for(const i in e){const n=e[i];if(n.class===t)return n}return null}function getStringAttributes(e,t,i){const n=[],r=new TextDecoder("utf8");let o=0;for(let s=0;s<i;s++){const i=t[4*(s+1)]-t[4*s],a=e.subarray(o,i+o),l=r.decode(a);n.push(l),o+=i}return n}var EXT_feature_metadata=Object.freeze({__proto__:null,decode:decode$1,name:name});const EXTENSIONS$1=[EXT_meshopt_compression,EXT_texture_webp,KHR_texture_basisu,KHR_draco_mesh_compression,KHR_lights_punctual,KHR_materials_unlit,KHR_techniques_webgl,KHR_texture_transform,EXT_feature_metadata];function preprocessExtensions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const n=EXTENSIONS$1.filter((e=>useExtension(e.name,t)));for(const o of n){var r;null===(r=o.preprocess)||void 0===r||r.call(o,e,t,i)}}async function decodeExtensions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const n=EXTENSIONS$1.filter((e=>useExtension(e.name,t)));for(const o of n){var r;await(null===(r=o.decode)||void 0===r?void 0:r.call(o,e,t,i))}}function useExtension(e,t){var i;const n=(null==t||null===(i=t.gltf)||void 0===i?void 0:i.excludeExtensions)||{};return!(e in n&&!n[e])}const KHR_BINARY_GLTF="KHR_binary_glTF";function preprocess(e){const t=new GLTFScenegraph(e),{json:i}=t;for(const e of i.images||[]){const i=t.getObjectExtension(e,KHR_BINARY_GLTF);i&&Object.assign(e,i),t.removeObjectExtension(e,KHR_BINARY_GLTF)}i.buffers&&i.buffers[0]&&delete i.buffers[0].uri,t.removeExtension(KHR_BINARY_GLTF)}const GLTF_ARRAYS={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},GLTF_KEYS={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class GLTFV1Normalizer{constructor(){_defineProperty(this,"idToIndexMap",{animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}}),_defineProperty(this,"json",void 0)}normalize(e,t){this.json=e.json;const i=e.json;switch(i.asset&&i.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return}if(!t.normalize)throw new Error("glTF v1 is not supported.");this._addAsset(i),this._convertTopLevelObjectsToArrays(i),preprocess(e),this._convertObjectIdsToArrayIndices(i),this._updateObjects(i),this._updateMaterial(i)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const t in GLTF_ARRAYS)this._convertTopLevelObjectToArray(e,t)}_convertTopLevelObjectToArray(e,t){const i=e[t];if(i&&!Array.isArray(i)){e[t]=[];for(const n in i){const r=i[n];r.id=r.id||n;const o=e[t].length;e[t].push(r),this.idToIndexMap[t][n]=o}}}_convertObjectIdsToArrayIndices(e){for(const t in GLTF_ARRAYS)this._convertIdsToIndices(e,t);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const t of e.textures)this._convertTextureIds(t);for(const t of e.meshes)this._convertMeshIds(t);for(const t of e.nodes)this._convertNodeIds(t);for(const t of e.scenes)this._convertSceneIds(t)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const t of e.primitives){const{attributes:e,indices:i,material:n}=t;for(const t in e)e[t]=this._convertIdToIndex(e[t],"accessor");i&&(t.indices=this._convertIdToIndex(i,"accessor")),n&&(t.material=this._convertIdToIndex(n,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map((e=>this._convertIdToIndex(e,"node")))),e.meshes&&(e.meshes=e.meshes.map((e=>this._convertIdToIndex(e,"mesh"))))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map((e=>this._convertIdToIndex(e,"node"))))}_convertIdsToIndices(e,t){e[t]||(e[t]=[]);for(const i of e[t])for(const e in i){const t=this._convertIdToIndex(i[e],e);i[e]=t}}_convertIdToIndex(e,t){const i=GLTF_KEYS[t];if(i in this.idToIndexMap){const n=this.idToIndexMap[i][e];if(!Number.isFinite(n))throw new Error("gltf v1: failed to resolve ".concat(t," with id ").concat(e));return n}return e}_updateObjects(e){for(const e of this.json.buffers)delete e.type}_updateMaterial(e){for(const r of e.materials){var t,i,n;r.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const o=(null===(t=r.values)||void 0===t?void 0:t.tex)||(null===(i=r.values)||void 0===i?void 0:i.texture2d_0)||(null===(n=r.values)||void 0===n?void 0:n.diffuseTex),s=e.textures.findIndex((e=>e.id===o));-1!==s&&(r.pbrMetallicRoughness.baseColorTexture={index:s})}}}function normalizeGLTFV1(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(new GLTFV1Normalizer).normalize(e,t)}const COMPONENTS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},BYTES={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},GL_SAMPLER={TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,REPEAT:10497,LINEAR:9729,NEAREST_MIPMAP_LINEAR:9986},SAMPLER_PARAMETER_GLTF_TO_GL={magFilter:GL_SAMPLER.TEXTURE_MAG_FILTER,minFilter:GL_SAMPLER.TEXTURE_MIN_FILTER,wrapS:GL_SAMPLER.TEXTURE_WRAP_S,wrapT:GL_SAMPLER.TEXTURE_WRAP_T},DEFAULT_SAMPLER={[GL_SAMPLER.TEXTURE_MAG_FILTER]:GL_SAMPLER.LINEAR,[GL_SAMPLER.TEXTURE_MIN_FILTER]:GL_SAMPLER.NEAREST_MIPMAP_LINEAR,[GL_SAMPLER.TEXTURE_WRAP_S]:GL_SAMPLER.REPEAT,[GL_SAMPLER.TEXTURE_WRAP_T]:GL_SAMPLER.REPEAT};function getBytesFromComponentType(e){return BYTES[e]}function getSizeFromAccessorType(e){return COMPONENTS[e]}class GLTFPostProcessor{constructor(){_defineProperty(this,"baseUri",""),_defineProperty(this,"json",{}),_defineProperty(this,"buffers",[]),_defineProperty(this,"images",[])}postProcess(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{json:i,buffers:n=[],images:r=[],baseUri:o=""}=e;return assert$2(i),this.baseUri=o,this.json=i,this.buffers=n,this.images=r,this._resolveTree(this.json,t),this.json}_resolveTree(e){e.bufferViews&&(e.bufferViews=e.bufferViews.map(((e,t)=>this._resolveBufferView(e,t)))),e.images&&(e.images=e.images.map(((e,t)=>this._resolveImage(e,t)))),e.samplers&&(e.samplers=e.samplers.map(((e,t)=>this._resolveSampler(e,t)))),e.textures&&(e.textures=e.textures.map(((e,t)=>this._resolveTexture(e,t)))),e.accessors&&(e.accessors=e.accessors.map(((e,t)=>this._resolveAccessor(e,t)))),e.materials&&(e.materials=e.materials.map(((e,t)=>this._resolveMaterial(e,t)))),e.meshes&&(e.meshes=e.meshes.map(((e,t)=>this._resolveMesh(e,t)))),e.nodes&&(e.nodes=e.nodes.map(((e,t)=>this._resolveNode(e,t)))),e.skins&&(e.skins=e.skins.map(((e,t)=>this._resolveSkin(e,t)))),e.scenes&&(e.scenes=e.scenes.map(((e,t)=>this._resolveScene(e,t)))),void 0!==e.scene&&(e.scene=e.scenes[this.json.scene])}getScene(e){return this._get("scenes",e)}getNode(e){return this._get("nodes",e)}getSkin(e){return this._get("skins",e)}getMesh(e){return this._get("meshes",e)}getMaterial(e){return this._get("materials",e)}getAccessor(e){return this._get("accessors",e)}getCamera(e){return null}getTexture(e){return this._get("textures",e)}getSampler(e){return this._get("samplers",e)}getImage(e){return this._get("images",e)}getBufferView(e){return this._get("bufferViews",e)}getBuffer(e){return this._get("buffers",e)}_get(e,t){if("object"==typeof t)return t;return this.json[e]&&this.json[e][t]}_resolveScene(e,t){return e.id=e.id||"scene-".concat(t),e.nodes=(e.nodes||[]).map((e=>this.getNode(e))),e}_resolveNode(e,t){return e.id=e.id||"node-".concat(t),e.children&&(e.children=e.children.map((e=>this.getNode(e)))),void 0!==e.mesh?e.mesh=this.getMesh(e.mesh):void 0!==e.meshes&&e.meshes.length&&(e.mesh=e.meshes.reduce(((e,t)=>{const i=this.getMesh(t);return e.id=i.id,e.primitives=e.primitives.concat(i.primitives),e}),{primitives:[]})),void 0!==e.camera&&(e.camera=this.getCamera(e.camera)),void 0!==e.skin&&(e.skin=this.getSkin(e.skin)),e}_resolveSkin(e,t){return e.id=e.id||"skin-".concat(t),e.inverseBindMatrices=this.getAccessor(e.inverseBindMatrices),e}_resolveMesh(e,t){return e.id=e.id||"mesh-".concat(t),e.primitives&&(e.primitives=e.primitives.map((e=>{const t=(e={...e}).attributes;e.attributes={};for(const i in t)e.attributes[i]=this.getAccessor(t[i]);return void 0!==e.indices&&(e.indices=this.getAccessor(e.indices)),void 0!==e.material&&(e.material=this.getMaterial(e.material)),e}))),e}_resolveMaterial(e,t){if(e.id=e.id||"material-".concat(t),e.normalTexture&&(e.normalTexture={...e.normalTexture},e.normalTexture.texture=this.getTexture(e.normalTexture.index)),e.occlusionTexture&&(e.occlustionTexture={...e.occlustionTexture},e.occlusionTexture.texture=this.getTexture(e.occlusionTexture.index)),e.emissiveTexture&&(e.emmisiveTexture={...e.emmisiveTexture},e.emissiveTexture.texture=this.getTexture(e.emissiveTexture.index)),e.emissiveFactor||(e.emissiveFactor=e.emmisiveTexture?[1,1,1]:[0,0,0]),e.pbrMetallicRoughness){e.pbrMetallicRoughness={...e.pbrMetallicRoughness};const t=e.pbrMetallicRoughness;t.baseColorTexture&&(t.baseColorTexture={...t.baseColorTexture},t.baseColorTexture.texture=this.getTexture(t.baseColorTexture.index)),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture={...t.metallicRoughnessTexture},t.metallicRoughnessTexture.texture=this.getTexture(t.metallicRoughnessTexture.index))}return e}_resolveAccessor(e,t){if(e.id=e.id||"accessor-".concat(t),void 0!==e.bufferView&&(e.bufferView=this.getBufferView(e.bufferView)),e.bytesPerComponent=getBytesFromComponentType(e.componentType),e.components=getSizeFromAccessorType(e.type),e.bytesPerElement=e.bytesPerComponent*e.components,e.bufferView){const t=e.bufferView.buffer,{ArrayType:i,byteLength:n}=getAccessorArrayTypeAndLength(e,e.bufferView),r=(e.bufferView.byteOffset||0)+(e.byteOffset||0)+t.byteOffset;let o=t.arrayBuffer.slice(r,r+n);e.bufferView.byteStride&&(o=this._getValueFromInterleavedBuffer(t,r,e.bufferView.byteStride,e.bytesPerElement,e.count)),e.value=new i(o)}return e}_getValueFromInterleavedBuffer(e,t,i,n,r){const o=new Uint8Array(r*n);for(let s=0;s<r;s++){const r=t+s*i;o.set(new Uint8Array(e.arrayBuffer.slice(r,r+n)),s*n)}return o.buffer}_resolveTexture(e,t){return e.id=e.id||"texture-".concat(t),e.sampler="sampler"in e?this.getSampler(e.sampler):DEFAULT_SAMPLER,e.source=this.getImage(e.source),e}_resolveSampler(e,t){e.id=e.id||"sampler-".concat(t),e.parameters={};for(const t in e){const i=this._enumSamplerParameter(t);void 0!==i&&(e.parameters[i]=e[t])}return e}_enumSamplerParameter(e){return SAMPLER_PARAMETER_GLTF_TO_GL[e]}_resolveImage(e,t){e.id=e.id||"image-".concat(t),void 0!==e.bufferView&&(e.bufferView=this.getBufferView(e.bufferView));const i=this.images[t];return i&&(e.image=i),e}_resolveBufferView(e,t){const i=e.buffer,n={id:"bufferView-".concat(t),...e,buffer:this.buffers[i]};let r=this.buffers[i].byteOffset||0;return"byteOffset"in e&&(r+=e.byteOffset),n.data=new Uint8Array(this.buffers[i].arrayBuffer,r,e.byteLength),n}_resolveCamera(e,t){return e.id=e.id||"camera-".concat(t),e}}function postProcessGLTF(e,t){return(new GLTFPostProcessor).postProcess(e,t)}const MAGIC_glTF=1735152710,GLB_FILE_HEADER_SIZE=12,GLB_CHUNK_HEADER_SIZE=8,GLB_CHUNK_TYPE_JSON=1313821514,GLB_CHUNK_TYPE_BIN=5130562,GLB_CHUNK_TYPE_JSON_XVIZ_DEPRECATED=0,GLB_CHUNK_TYPE_BIX_XVIZ_DEPRECATED=1,GLB_V1_CONTENT_FORMAT_JSON=0,LE=!0;function getMagicString$1(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return"".concat(String.fromCharCode(e.getUint8(t+0))).concat(String.fromCharCode(e.getUint8(t+1))).concat(String.fromCharCode(e.getUint8(t+2))).concat(String.fromCharCode(e.getUint8(t+3)))}function isGLB(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const n=new DataView(e),{magic:r=MAGIC_glTF}=i,o=n.getUint32(t,!1);return o===r||o===MAGIC_glTF}function parseGLBSync(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=new DataView(t),r=getMagicString$1(n,i+0),o=n.getUint32(i+4,LE),s=n.getUint32(i+8,LE);switch(Object.assign(e,{header:{byteOffset:i,byteLength:s,hasBinChunk:!1},type:r,version:o,json:{},binChunks:[]}),i+=GLB_FILE_HEADER_SIZE,e.version){case 1:return parseGLBV1(e,n,i);case 2:return parseGLBV2(e,n,i,{});default:throw new Error("Invalid GLB version ".concat(e.version,". Only supports v1 and v2."))}}function parseGLBV1(e,t,i){assert$c(e.header.byteLength>GLB_FILE_HEADER_SIZE+GLB_CHUNK_HEADER_SIZE);const n=t.getUint32(i+0,LE),r=t.getUint32(i+4,LE);return i+=GLB_CHUNK_HEADER_SIZE,assert$c(r===GLB_V1_CONTENT_FORMAT_JSON),parseJSONChunk(e,t,i,n),i+=n,i+=parseBINChunk(e,t,i,e.header.byteLength)}function parseGLBV2(e,t,i,n){return assert$c(e.header.byteLength>GLB_FILE_HEADER_SIZE+GLB_CHUNK_HEADER_SIZE),parseGLBChunksSync(e,t,i,n),i+e.header.byteLength}function parseGLBChunksSync(e,t,i,n){for(;i+8<=e.header.byteLength;){const r=t.getUint32(i+0,LE),o=t.getUint32(i+4,LE);switch(i+=GLB_CHUNK_HEADER_SIZE,o){case GLB_CHUNK_TYPE_JSON:parseJSONChunk(e,t,i,r);break;case GLB_CHUNK_TYPE_BIN:parseBINChunk(e,t,i,r);break;case GLB_CHUNK_TYPE_JSON_XVIZ_DEPRECATED:n.strict||parseJSONChunk(e,t,i,r);break;case GLB_CHUNK_TYPE_BIX_XVIZ_DEPRECATED:n.strict||parseBINChunk(e,t,i,r)}i+=padToNBytes(r,4)}return i}function parseJSONChunk(e,t,i,n){const r=new Uint8Array(t.buffer,i,n),o=new TextDecoder("utf8").decode(r);return e.json=JSON.parse(o),padToNBytes(n,4)}function parseBINChunk(e,t,i,n){return e.header.hasBinChunk=!0,e.binChunks.push({byteOffset:i,byteLength:n,arrayBuffer:t.buffer}),padToNBytes(n,4)}async function parseGLTF(e,t){var i,n,r,o;let s=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0;parseGLTFContainerSync(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s),normalizeGLTFV1(e,{normalize:null==s||null===(i=s.gltf)||void 0===i?void 0:i.normalize}),preprocessExtensions(e,s,a);const l=[];if(null!=s&&null!==(n=s.gltf)&&void 0!==n&&n.loadBuffers&&e.json.buffers&&await loadBuffers(e,s,a),null!=s&&null!==(r=s.gltf)&&void 0!==r&&r.loadImages){const t=loadImages(e,s,a);l.push(t)}const c=decodeExtensions(e,s,a);return l.push(c),await Promise.all(l),null!=s&&null!==(o=s.gltf)&&void 0!==o&&o.postProcess?postProcessGLTF(e,s):e}function parseGLTFContainerSync(e,t,i,n){if(n.uri&&(e.baseUri=n.uri),t instanceof ArrayBuffer&&!isGLB(t,i,n)){t=(new TextDecoder).decode(t)}if("string"==typeof t)e.json=parseJSON(t);else if(t instanceof ArrayBuffer){const r={};i=parseGLBSync(r,t,i,n.glb),assert$2("glTF"===r.type,"Invalid GLB magic string ".concat(r.type)),e._glb=r,e.json=r.json}else assert$2(!1,"GLTF: must be ArrayBuffer or string");if(e.buffers=new Array((e.json.buffers||[]).length).fill(null),e._glb&&e._glb.header.hasBinChunk){const{binChunks:t}=e._glb;e.buffers[0]={arrayBuffer:t[0].arrayBuffer,byteOffset:t[0].byteOffset,byteLength:t[0].byteLength}}e.images=new Array((e.json.images||[]).length).fill({})}async function loadBuffers(e,t,i){const n=e.json.buffers||[];for(let s=0;s<n.length;++s){const a=n[s];if(a.uri){var r,o;const{fetch:n}=i;assert$2(n);const l=resolveUrl(a.uri,t),c=await(null==i||null===(r=i.fetch)||void 0===r?void 0:r.call(i,l)),u=await(null==c||null===(o=c.arrayBuffer)||void 0===o?void 0:o.call(c));e.buffers[s]={arrayBuffer:u,byteOffset:0,byteLength:u.byteLength},delete a.uri}else null===e.buffers[s]&&(e.buffers[s]={arrayBuffer:new ArrayBuffer(a.byteLength),byteOffset:0,byteLength:a.byteLength})}}async function loadImages(e,t,i){const n=getReferencesImageIndices(e),r=e.json.images||[],o=[];for(const s of n)o.push(loadImage(e,r[s],s,t,i));return await Promise.all(o)}function getReferencesImageIndices(e){const t=new Set,i=e.json.textures||[];for(const e of i)void 0!==e.source&&t.add(e.source);return Array.from(t).sort()}async function loadImage(e,t,i,n,r){const{fetch:o,parse:s}=r;let a;if(t.uri&&!t.hasOwnProperty("bufferView")){const e=resolveUrl(t.uri,n),i=await o(e);a=await i.arrayBuffer(),t.bufferView={data:a}}if(Number.isFinite(t.bufferView)){const i=getTypedArrayForBufferView(e.json,e.buffers,t.bufferView);a=sliceArrayBuffer(i.buffer,i.byteOffset,i.byteLength)}assert$2(a,"glTF image has no data");let l=await s(a,[ImageLoader$1,BasisLoader],{mimeType:t.mimeType,basis:n.basis||{format:selectSupportedBasisFormat()}},r);l&&l[0]&&(l={compressed:!0,mipmaps:!1,width:l[0].width,height:l[0].height,data:l[0]}),e.images=e.images||[],e.images[i]=l}const GLTFLoader$1={name:"glTF",id:"gltf",module:"gltf",version:VERSION$4,extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:parse$1,options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0,postProcess:!0},log:console},deprecatedOptions:{fetchImages:"gltf.loadImages",createImages:"gltf.loadImages",decompress:"gltf.decompressMeshes",postProcess:"gltf.postProcess",gltf:{decompress:"gltf.decompressMeshes"}}};async function parse$1(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;t={...GLTFLoader$1.options,...t},t.gltf={...GLTFLoader$1.options.gltf,...t.gltf};const{byteOffset:n=0}=t;return await parseGLTF({},e,n,t,i)}async function waitForGLTFAssets(e){const t=[];return e.scenes.forEach((e=>{e.traverse((e=>{Object.values(e.model.getUniforms()).forEach((e=>{!1===e.loaded&&t.push(e)}))}))})),await waitWhileCondition((()=>t.some((e=>!e.loaded))))}async function waitWhileCondition(e){for(;e();)await new Promise((e=>requestAnimationFrame(e)))}var vs$1="#version 300 es\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin mat3 instanceModelMatrix;\nin vec3 instanceTranslation;\nuniform float sizeScale;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform mat4 sceneModelMatrix;\nuniform bool composeModelMatrix;\nin vec4 POSITION;\n\n#ifdef HAS_UV\n  in vec2 TEXCOORD_0;\n#endif\n\n#ifdef MODULE_PBR\n  #ifdef HAS_NORMALS\n    in vec4 NORMAL;\n  #endif\n#endif\nout vec4 vColor;\n#ifndef MODULE_PBR\n  #ifdef HAS_UV\n    out vec2 vTEXCOORD_0;\n  #endif\n#endif\nvoid main(void) {\n  #if defined(HAS_UV) && !defined(MODULE_PBR)\n    vTEXCOORD_0 = TEXCOORD_0;\n    geometry.uv = vTEXCOORD_0;\n  #endif\n\n  geometry.worldPosition = instancePositions;\n  geometry.pickingColor = instancePickingColors;\n\n  vec3 normal = vec3(0.0, 0.0, 1.0);\n  #ifdef MODULE_PBR\n    #ifdef HAS_NORMALS\n      normal = instanceModelMatrix * (sceneModelMatrix * vec4(NORMAL.xyz, 0.0)).xyz;\n    #endif\n  #endif\n\n  float originalSize = project_size_to_pixel(sizeScale);\n  float clampedSize = clamp(originalSize, sizeMinPixels, sizeMaxPixels);\n\n  vec3 pos = (instanceModelMatrix * (sceneModelMatrix * POSITION).xyz) * sizeScale * (clampedSize / originalSize) + instanceTranslation;\n  if(composeModelMatrix) {\n    DECKGL_FILTER_SIZE(pos, geometry);\n    geometry.normal = project_normal(normal);\n    geometry.worldPosition += pos;\n    gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n  }\n  else {\n    pos = project_size(pos);\n    DECKGL_FILTER_SIZE(pos, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, geometry.position);\n    geometry.normal = project_normal(normal);\n  }\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  #ifdef MODULE_PBR\n    pbr_vPosition = geometry.position.xyz;\n    #ifdef HAS_NORMALS\n      pbr_vNormal = geometry.normal;\n    #endif\n\n    #ifdef HAS_UV\n      pbr_vUV = TEXCOORD_0;\n    #else\n      pbr_vUV = vec2(0., 0.);\n    #endif\n    geometry.uv = pbr_vUV;\n  #endif\n\n  vColor = instanceColors;\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs$1="#version 300 es\nuniform float opacity;\nin vec4 vColor;\n\nout vec4 fragmentColor;\n#ifndef MODULE_PBR\n  #if defined(HAS_UV) && defined(HAS_BASECOLORMAP)\n    in vec2 vTEXCOORD_0;\n    uniform sampler2D u_BaseColorSampler;\n  #endif\n#endif\n\nvoid main(void) {\n  #ifdef MODULE_PBR\n    fragmentColor = vColor * pbr_filterColor(vec4(0));\n    geometry.uv = pbr_vUV;\n  #else\n    #if defined(HAS_UV) && defined(HAS_BASECOLORMAP)\n      fragmentColor = vColor * texture2D(u_BaseColorSampler, vTEXCOORD_0);\n      geometry.uv = vTEXCOORD_0;\n    #else\n      fragmentColor = vColor;\n    #endif\n  #endif\n\n  fragmentColor.a *= opacity;\n  DECKGL_FILTER_COLOR(fragmentColor, geometry);\n}\n";const DEFAULT_COLOR=[255,255,255,255],defaultProps$2={scenegraph:{type:"object",value:null,async:!0},getScene:e=>e&&e.scenes?"object"==typeof e.scene?e.scene:e.scenes[e.scene||0]:e,getAnimator:e=>e&&e.animator,_animations:null,sizeScale:{type:"number",value:1,min:0},sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getPosition:{type:"accessor",value:e=>e.position},getColor:{type:"accessor",value:DEFAULT_COLOR},_lighting:"flat",_imageBasedLightingEnvironment:null,getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]},loaders:[GLTFLoader$1]};class ScenegraphLayer extends Layer{constructor(...e){super(...e),_defineProperty(this,"state",void 0)}getShaders(){const e=[project32,picking];return"pbr"===this.props._lighting&&e.push(pbr),super.getShaders({vs:vs$1,fs:fs$1,modules:e})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),accessor:"getPosition",transition:!0},instanceColors:{type:5121,size:this.props.colorFormat.length,accessor:"getColor",normalized:!0,defaultValue:DEFAULT_COLOR,transition:!0},instanceModelMatrix:MATRIX_ATTRIBUTES})}updateState(e){super.updateState(e);const{props:t,oldProps:i}=e;t.scenegraph!==i.scenegraph?this._updateScenegraph():t._animations!==i._animations&&this._applyAnimationsProp(this.state.scenegraph,this.state.animator,t._animations)}finalizeState(e){super.finalizeState(e),this._deleteScenegraph()}get isLoaded(){var e;return(null===(e=this.state)||void 0===e?void 0:e.scenegraph)&&super.isLoaded}_updateScenegraph(){const e=this.props,{gl:t}=this.context;let i=null;if(e.scenegraph instanceof ScenegraphNode)i={scenes:[e.scenegraph]};else if(e.scenegraph&&!e.scenegraph.gltf){const n=e.scenegraph,r=createGLTFObjects(t,n,this._getModelOptions());i={gltf:n,...r},waitForGLTFAssets(r).then((()=>this.setNeedsRedraw()))}else e.scenegraph&&(log$3.deprecated("ScenegraphLayer.props.scenegraph","Use GLTFLoader instead of GLTFScenegraphLoader")(),i=e.scenegraph);const n={layer:this,gl:t},r=e.getScene(i,n),o=e.getAnimator(i,n);r instanceof ScenegraphNode?(this._deleteScenegraph(),this._applyAllAttributes(r),this._applyAnimationsProp(r,o,e._animations),this.setState({scenegraph:r,animator:o})):null!==r&&log$3.warn("invalid scenegraph:",r)()}_applyAllAttributes(e){if(this.state.attributesAvailable){const t=this.getAttributeManager().getAttributes();e.traverse((e=>{this._setModelAttributes(e.model,t)}))}}_applyAnimationsProp(e,t,i){if(!e||!t||!i)return;const n=t.getAnimations();Object.keys(i).sort().forEach((e=>{const t=i[e];if("*"===e)n.forEach((e=>{Object.assign(e,t)}));else if(Number.isFinite(Number(e))){const i=Number(e);i>=0&&i<n.length?Object.assign(n[i],t):log$3.warn("animation ".concat(e," not found"))()}else{const i=n.find((({name:t})=>t===e));i?Object.assign(i,t):log$3.warn("animation ".concat(e," not found"))()}}))}_deleteScenegraph(){const{scenegraph:e}=this.state;e instanceof ScenegraphNode&&e.delete()}_getModelOptions(){const{_imageBasedLightingEnvironment:e}=this.props;let t=null;return e&&(t="function"==typeof e?e({gl:this.context.gl,layer:this}):e),{gl:this.context.gl,waitForFullLoad:!0,imageBasedLightingEnvironment:t,modelOptions:{isInstanced:!0,transpileToGLSL100:!isWebGL2$1(this.context.gl),...this.getShaders()},useTangents:!1}}updateAttributes(e){this.setState({attributesAvailable:!0}),this.state.scenegraph&&this.state.scenegraph.traverse((t=>{this._setModelAttributes(t.model,e)}))}draw({moduleParameters:e=null,parameters:t={},context:i}){if(!this.state.scenegraph)return;this.props._animations&&this.state.animator&&(this.state.animator.animate(i.timeline.getTime()),this.setNeedsRedraw());const{viewport:n}=this.context,{sizeScale:r,sizeMinPixels:o,sizeMaxPixels:s,opacity:a,coordinateSystem:l}=this.props,c=this.getNumInstances();this.state.scenegraph.traverse(((i,{worldMatrix:u})=>{i.model.setInstanceCount(c),i.updateModuleSettings(e),i.draw({parameters:t,uniforms:{sizeScale:r,opacity:a,sizeMinPixels:o,sizeMaxPixels:s,composeModelMatrix:shouldComposeModelMatrix(n,l),sceneModelMatrix:u,u_Camera:i.model.getUniforms().project_uCameraPosition}})}))}}_defineProperty(ScenegraphLayer,"defaultProps",defaultProps$2),_defineProperty(ScenegraphLayer,"layerName","ScenegraphLayer");var vs="#version 300 es\n#define SHADER_NAME simple-mesh-layer-vs\nuniform float sizeScale;\nuniform bool composeModelMatrix;\nuniform bool pickFeatureIds;\nin vec3 positions;\nin vec3 normals;\nin vec3 colors;\nin vec2 texCoords;\nin vec4 uvRegions;\nin vec3 featureIdsPickingColors;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin mat3 instanceModelMatrix;\nout vec2 vTexCoord;\nout vec3 cameraPosition;\nout vec3 normals_commonspace;\nout vec4 position_commonspace;\nout vec4 vColor;\n\nvec2 applyUVRegion(vec2 uv) {\n  #ifdef HAS_UV_REGIONS\n    return fract(uv) * (uvRegions.zw - uvRegions.xy) + uvRegions.xy;\n  #else\n    return uv;\n  #endif\n}\n\nvoid main(void) {\n  vec2 uv = applyUVRegion(texCoords);\n  geometry.uv = uv;\n\n  if (pickFeatureIds) {\n    geometry.pickingColor = featureIdsPickingColors;\n  } else {\n    geometry.pickingColor = instancePickingColors;\n  }\n\n  vTexCoord = uv;\n  cameraPosition = project_uCameraPosition;\n  vColor = vec4(colors * instanceColors.rgb, instanceColors.a);\n\n  vec3 pos = (instanceModelMatrix * positions) * sizeScale;\n  vec3 projectedPosition = project_position(positions);\n  position_commonspace = vec4(projectedPosition, 1.0);\n  gl_Position = project_common_position_to_clipspace(position_commonspace);\n\n  geometry.position = position_commonspace;\n  normals_commonspace = project_normal(instanceModelMatrix * normals);\n  geometry.normal = normals_commonspace;\n\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  #ifdef MODULE_PBR\n    pbr_vPosition = geometry.position.xyz;\n    #ifdef HAS_NORMALS\n      pbr_vNormal = geometry.normal;\n    #endif\n\n    #ifdef HAS_UV\n      pbr_vUV = uv;\n    #else\n      pbr_vUV = vec2(0., 0.);\n    #endif\n    geometry.uv = pbr_vUV;\n  #endif\n\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs="#version 300 es\n#define SHADER_NAME simple-mesh-layer-fs\n\nprecision highp float;\n\nuniform bool hasTexture;\nuniform sampler2D sampler;\nuniform bool flatShading;\nuniform float opacity;\n\nin vec2 vTexCoord;\nin vec3 cameraPosition;\nin vec3 normals_commonspace;\nin vec4 position_commonspace;\nin vec4 vColor;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  \n#ifdef MODULE_PBR\n\n  fragColor = vColor * pbr_filterColor(vec4(0));\n  geometry.uv = pbr_vUV;\n  fragColor.a *= opacity;\n\n#else\n\n  geometry.uv = vTexCoord;\n\n  vec3 normal;\n  if (flatShading) {\n#ifdef DERIVATIVES_AVAILABLE\n    normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));\n#else\n    normal = vec3(0.0, 0.0, 1.0);\n#endif\n  } else {\n    normal = normals_commonspace;\n  }\n\n  vec4 color = hasTexture ? texture(sampler, vTexCoord) : vColor;\n  vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);\n  fragColor = vec4(lightColor, color.a * opacity);\n\n#endif\n\n  DECKGL_FILTER_COLOR(fragColor, geometry);\n}\n";function validateGeometryAttributes(e){e.COLOR_0||e.colors||(e.colors={constant:!0,value:new Float32Array([1,1,1])})}const defaultProps$1={pbrMaterial:{type:"object",value:null},featureIds:{type:"array",value:null,optional:!0}};class MeshLayer extends SimpleMeshLayer{getShaders(){const e=super.getShaders();return e.modules.push(pbr),{...e,vs:vs,fs:fs}}initializeState(){const{featureIds:e}=this.props;super.initializeState();const t=this.getAttributeManager();e&&t.add({featureIdsPickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateFeatureIdsPickingColors}})}updateState(e){super.updateState(e);const{props:t,oldProps:i}=e;t.pbrMaterial!==i.pbrMaterial&&this.updatePbrMaterialUniforms(t.pbrMaterial)}draw(e){const{featureIds:t}=this.props;this.state.model&&(this.state.model.setUniforms({u_Camera:this.state.model.getUniforms().project_uCameraPosition,pickFeatureIds:Boolean(t)}),super.draw(e))}getModel(e){const{id:t,pbrMaterial:i}=this.props,n=this.parseMaterial(i,e);this.setState({materialParser:n});const r=this.getShaders();validateGeometryAttributes(e.attributes);return new Model(this.context.gl,{...this.getShaders(),id:t,geometry:e,defines:{...r.defines,...null==n?void 0:n.defines,HAS_UV_REGIONS:e.attributes.uvRegions},parameters:null==n?void 0:n.parameters,isInstanced:!0})}updatePbrMaterialUniforms(e){const{model:t}=this.state;if(t){const{mesh:i}=this.props,n=this.parseMaterial(e,i);this.setState({materialParser:n}),t.setUniforms(n.uniforms)}}parseMaterial(e,t){var i;const n=Boolean(e.pbrMetallicRoughness&&e.pbrMetallicRoughness.baseColorTexture);return null===(i=this.state.materialParser)||void 0===i||i.delete(),new GLTFMaterialParser(this.context.gl,{attributes:{NORMAL:t.attributes.normals,TEXCOORD_0:t.attributes.texCoords},material:{unlit:n,...e},pbrDebug:!1,imageBasedLightingEnvironment:null,lights:!0,useTangents:!1})}calculateFeatureIdsPickingColors(e){const t=this.props.featureIds,i=new Uint8ClampedArray(t.length*e.size),n=[];for(let e=0;e<t.length;e++)this.encodePickingColor(t[e],n),i[3*e]=n[0],i[3*e+1]=n[1],i[3*e+2]=n[2];e.value=i}finalizeState(e){var t;super.finalizeState(e),null===(t=this.state.materialParser)||void 0===t||t.delete(),this.setState({materialParser:null})}}_defineProperty(MeshLayer,"layerName","MeshLayer"),_defineProperty(MeshLayer,"defaultProps",defaultProps$1);const WGS84_RADIUS_X$1=6378137,WGS84_RADIUS_Y$1=6378137,WGS84_RADIUS_Z$1=6356752.314245179;function identity(e){return e}function fromCartographic(e,t=[],i=identity){return"longitude"in e?(t[0]=i(e.longitude),t[1]=i(e.latitude),t[2]=e.height):"x"in e?(t[0]=i(e.x),t[1]=i(e.y),t[2]=e.z):(t[0]=i(e[0]),t[1]=i(e[1]),t[2]=e[2]),t}function fromCartographicToRadians(e,t=[]){return fromCartographic(e,t,config._cartographicRadians?identity:toRadians)}function toCartographic(e,t,i=identity){return"longitude"in t?(t.longitude=i(e[0]),t.latitude=i(e[1]),t.height=e[2]):"x"in t?(t.x=i(e[0]),t.y=i(e[1]),t.z=e[2]):(t[0]=i(e[0]),t[1]=i(e[1]),t[2]=e[2]),t}function toCartographicFromRadians(e,t){return toCartographic(e,t,config._cartographicRadians?identity:toDegrees)}new Vector3$1;const scratchVector$4=new Vector3$1,scaleToGeodeticSurfaceIntersection=new Vector3$1,scaleToGeodeticSurfaceGradient=new Vector3$1;function scaleToGeodeticSurface(e,t,i=[]){const{oneOverRadii:n,oneOverRadiiSquared:r,centerToleranceSquared:o}=t;scratchVector$4.from(e);const s=scratchVector$4.x,a=scratchVector$4.y,l=scratchVector$4.z,c=n.x,u=n.y,h=n.z,d=s*s*c*c,p=a*a*u*u,f=l*l*h*h,m=d+p+f,g=Math.sqrt(1/m);if(!Number.isFinite(g))return;const _=scaleToGeodeticSurfaceIntersection;if(_.copy(e).scale(g),m<o)return _.to(i);const y=r.x,v=r.y,x=r.z,b=scaleToGeodeticSurfaceGradient;b.set(_.x*y*2,_.y*v*2,_.z*x*2);let T,w,E,S,A=(1-g)*scratchVector$4.len()/(.5*b.len()),M=0;do{A-=M,T=1/(1+A*y),w=1/(1+A*v),E=1/(1+A*x);const e=T*T,t=w*w,i=E*E;S=d*e+p*t+f*i-1;M=S/(-2*(d*(e*T)*y+p*(t*w)*v+f*(i*E)*x))}while(Math.abs(S)>_MathUtils.EPSILON12);return scratchVector$4.scale([T,w,E]).to(i)}const EPSILON14=1e-14,scratchOrigin=new Vector3$1,VECTOR_PRODUCT_LOCAL_FRAME={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},degeneratePositionLocalFrame={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},scratchAxisVectors={east:new Vector3$1,north:new Vector3$1,up:new Vector3$1,west:new Vector3$1,south:new Vector3$1,down:new Vector3$1},scratchVector1=new Vector3$1,scratchVector2=new Vector3$1,scratchVector3=new Vector3$1;function localFrameToFixedFrame(e,t,i,n,r,o){const s=VECTOR_PRODUCT_LOCAL_FRAME[t]&&VECTOR_PRODUCT_LOCAL_FRAME[t][i];let a,l,c;assert$6(s&&(!n||n===s));const u=scratchOrigin.copy(r);if(equals$1(u.x,0,EPSILON14)&&equals$1(u.y,0,EPSILON14)){const e=Math.sign(u.z);a=scratchVector1.fromArray(degeneratePositionLocalFrame[t]),"east"!==t&&"west"!==t&&a.scale(e),l=scratchVector2.fromArray(degeneratePositionLocalFrame[i]),"east"!==i&&"west"!==i&&l.scale(e),c=scratchVector3.fromArray(degeneratePositionLocalFrame[n]),"east"!==n&&"west"!==n&&c.scale(e)}else{const{up:r,east:o,north:s}=scratchAxisVectors;o.set(-u.y,u.x,0).normalize(),e.geodeticSurfaceNormal(u,r),s.copy(r).cross(o);const{down:h,west:d,south:p}=scratchAxisVectors;h.copy(r).scale(-1),d.copy(o).scale(-1),p.copy(s).scale(-1),a=scratchAxisVectors[t],l=scratchAxisVectors[i],c=scratchAxisVectors[n]}return o[0]=a.x,o[1]=a.y,o[2]=a.z,o[3]=0,o[4]=l.x,o[5]=l.y,o[6]=l.z,o[7]=0,o[8]=c.x,o[9]=c.y,o[10]=c.z,o[11]=0,o[12]=u.x,o[13]=u.y,o[14]=u.z,o[15]=1,o}const scratchVector$3=new Vector3$1,scratchNormal$1=new Vector3$1,scratchK=new Vector3$1,scratchPosition$1=new Vector3$1,scratchHeight=new Vector3$1,scratchCartesian=new Vector3$1;class Ellipsoid{constructor(e=0,t=0,i=0){_defineProperty(this,"radii",void 0),_defineProperty(this,"radiiSquared",void 0),_defineProperty(this,"radiiToTheFourth",void 0),_defineProperty(this,"oneOverRadii",void 0),_defineProperty(this,"oneOverRadiiSquared",void 0),_defineProperty(this,"minimumRadius",void 0),_defineProperty(this,"maximumRadius",void 0),_defineProperty(this,"centerToleranceSquared",_MathUtils.EPSILON1),_defineProperty(this,"squaredXOverSquaredZ",void 0),assert$6(e>=0),assert$6(t>=0),assert$6(i>=0),this.radii=new Vector3$1(e,t,i),this.radiiSquared=new Vector3$1(e*e,t*t,i*i),this.radiiToTheFourth=new Vector3$1(e*e*e*e,t*t*t*t,i*i*i*i),this.oneOverRadii=new Vector3$1(0===e?0:1/e,0===t?0:1/t,0===i?0:1/i),this.oneOverRadiiSquared=new Vector3$1(0===e?0:1/(e*e),0===t?0:1/(t*t),0===i?0:1/(i*i)),this.minimumRadius=Math.min(e,t,i),this.maximumRadius=Math.max(e,t,i),0!==this.radiiSquared.z&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(e){return this===e||Boolean(e&&this.radii.equals(e.radii))}toString(){return this.radii.toString()}cartographicToCartesian(e,t=[0,0,0]){const i=scratchNormal$1,n=scratchK,[,,r]=e;this.geodeticSurfaceNormalCartographic(e,i),n.copy(this.radiiSquared).scale(i);const o=Math.sqrt(i.dot(n));return n.scale(1/o),i.scale(r),n.add(i),n.to(t)}cartesianToCartographic(e,t=[0,0,0]){scratchCartesian.from(e);const i=this.scaleToGeodeticSurface(scratchCartesian,scratchPosition$1);if(!i)return;const n=this.geodeticSurfaceNormal(i,scratchNormal$1),r=scratchHeight;r.copy(scratchCartesian).subtract(i);return toCartographicFromRadians([Math.atan2(n.y,n.x),Math.asin(n.z),Math.sign(dot$2(r,scratchCartesian))*length$2(r)],t)}eastNorthUpToFixedFrame(e,t=new Matrix4$1){return localFrameToFixedFrame(this,"east","north","up",e,t)}localFrameToFixedFrame(e,t,i,n,r=new Matrix4$1){return localFrameToFixedFrame(this,e,t,i,n,r)}geocentricSurfaceNormal(e,t=[0,0,0]){return scratchVector$3.from(e).normalize().to(t)}geodeticSurfaceNormalCartographic(e,t=[0,0,0]){const i=fromCartographicToRadians(e),n=i[0],r=i[1],o=Math.cos(r);return scratchVector$3.set(o*Math.cos(n),o*Math.sin(n),Math.sin(r)).normalize(),scratchVector$3.to(t)}geodeticSurfaceNormal(e,t=[0,0,0]){return scratchVector$3.from(e).scale(this.oneOverRadiiSquared).normalize().to(t)}scaleToGeodeticSurface(e,t){return scaleToGeodeticSurface(e,this,t)}scaleToGeocentricSurface(e,t=[0,0,0]){scratchPosition$1.from(e);const i=scratchPosition$1.x,n=scratchPosition$1.y,r=scratchPosition$1.z,o=this.oneOverRadiiSquared,s=1/Math.sqrt(i*i*o.x+n*n*o.y+r*r*o.z);return scratchPosition$1.multiplyScalar(s).to(t)}transformPositionToScaledSpace(e,t=[0,0,0]){return scratchPosition$1.from(e).scale(this.oneOverRadii).to(t)}transformPositionFromScaledSpace(e,t=[0,0,0]){return scratchPosition$1.from(e).scale(this.radii).to(t)}getSurfaceNormalIntersectionWithZAxis(e,t=0,i=[0,0,0]){assert$6(equals$1(this.radii.x,this.radii.y,_MathUtils.EPSILON15)),assert$6(this.radii.z>0),scratchPosition$1.from(e);const n=scratchPosition$1.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(n)>=this.radii.z-t))return scratchPosition$1.set(0,0,n).to(i)}}_defineProperty(Ellipsoid,"WGS84",new Ellipsoid(WGS84_RADIUS_X$1,WGS84_RADIUS_Y$1,WGS84_RADIUS_Z$1));class DoublyLinkedListNode{constructor(e,t,i){_defineProperty(this,"item",void 0),_defineProperty(this,"previous",void 0),_defineProperty(this,"next",void 0),this.item=e,this.previous=t,this.next=i}}class DoublyLinkedList{constructor(){_defineProperty(this,"head",null),_defineProperty(this,"tail",null),_defineProperty(this,"_length",0)}get length(){return this._length}add(e){const t=new DoublyLinkedListNode(e,this.tail,null);return this.tail?(this.tail.next=t,this.tail=t):(this.head=t,this.tail=t),++this._length,t}remove(e){e&&(e.previous&&e.next?(e.previous.next=e.next,e.next.previous=e.previous):e.previous?(e.previous.next=null,this.tail=e.previous):e.next?(e.next.previous=null,this.head=e.next):(this.head=null,this.tail=null),e.next=null,e.previous=null,--this._length)}splice(e,t){e!==t&&(this.remove(t),this._insert(e,t))}_insert(e,t){const i=e.next;e.next=t,this.tail===e?this.tail=t:i.previous=t,t.next=i,t.previous=e,++this._length}}class TilesetCache{constructor(){_defineProperty(this,"_list",void 0),_defineProperty(this,"_sentinel",void 0),_defineProperty(this,"_trimTiles",void 0),this._list=new DoublyLinkedList,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(e){const t=e._cacheNode;t&&this._list.splice(this._sentinel,t)}add(e,t,i){t._cacheNode||(t._cacheNode=this._list.add(t),i&&i(e,t))}unloadTile(e,t,i){const n=t._cacheNode;n&&(this._list.remove(n),t._cacheNode=null,i&&i(e,t))}unloadTiles(e,t){const i=this._trimTiles;this._trimTiles=!1;const n=1024*e.maximumMemoryUsage*1024,r=this._sentinel;let o=this._list.head;for(;o!==r&&(e.gpuMemoryUsageInBytes>n||i);){const i=o.item;o=o.next,this.unloadTile(e,i,t)}}trim(){this._trimTiles=!0}}function calculateTransformProps(e,t){assert$c(e),assert$c(t);const{rtcCenter:i,gltfUpAxis:n}=t,{computedTransform:r,boundingVolume:{center:o}}=e;let s=new Matrix4$1(r);switch(i&&s.translate(i),n){case"Z":break;case"Y":const e=(new Matrix4$1).rotateX(Math.PI/2);s=s.multiplyRight(e);break;case"X":const t=(new Matrix4$1).rotateY(-Math.PI/2);s=s.multiplyRight(t)}t.isQuantized&&s.translate(t.quantizedVolumeOffset).scale(t.quantizedVolumeScale);const a=new Vector3$1(o);t.cartesianModelMatrix=s,t.cartesianOrigin=a;const l=Ellipsoid.WGS84.cartesianToCartographic(a,new Vector3$1),c=Ellipsoid.WGS84.eastNorthUpToFixedFrame(a).invert();t.cartographicModelMatrix=c.multiplyRight(s),t.cartographicOrigin=l,t.coordinateSystem||(t.modelMatrix=t.cartographicModelMatrix)}const scratchVector$2=new Vector3$1,scratchPosition=new Vector3$1,cullingVolume=new CullingVolume([new Plane,new Plane,new Plane,new Plane,new Plane,new Plane]);function getFrameState(e,t){const{cameraDirection:i,cameraUp:n,height:r}=e,{metersPerUnit:o}=e.distanceScales,s=worldToCartesian(e,e.center),a=Ellipsoid.WGS84.eastNorthUpToFixedFrame(s),l=e.unprojectPosition(e.cameraPosition),c=Ellipsoid.WGS84.cartographicToCartesian(l,new Vector3$1),u=new Vector3$1(a.transformAsVector(new Vector3$1(i).scale(o))).normalize(),h=new Vector3$1(a.transformAsVector(new Vector3$1(n).scale(o))).normalize();commonSpacePlanesToWGS84(e);const d=e.constructor,{longitude:p,latitude:f,width:m,bearing:g,zoom:_}=e;return{camera:{position:c,direction:u,up:h},viewport:e,topDownViewport:new d({longitude:p,latitude:f,height:r,width:m,bearing:g,zoom:_,pitch:0}),height:r,cullingVolume:cullingVolume,frameNumber:t,sseDenominator:1.15}}function limitSelectedTiles(e,t,i){if(0===i||e.length<=i)return[e,[]];const n=[],{longitude:r,latitude:o}=t.viewport;for(const[t,i]of e.entries()){const[e,s]=i.header.mbs,a=Math.abs(r-e),l=Math.abs(o-s),c=Math.sqrt(l*l+a*a);n.push([t,c])}const s=n.sort(((e,t)=>e[1]-t[1])),a=[];for(let t=0;t<i;t++)a.push(e[s[t][0]]);const l=[];for(let t=i;t<s.length;t++)l.push(e[s[t][0]]);return[a,l]}function commonSpacePlanesToWGS84(e){const t=e.getFrustumPlanes(),i=closestPointOnPlane(t.near,e.cameraPosition),n=worldToCartesian(e,i),r=worldToCartesian(e,e.cameraPosition,scratchPosition);let o=0;cullingVolume.planes[o++].fromPointNormal(n,scratchVector$2.copy(n).subtract(r));for(const r in t){if("near"===r)continue;const s=worldToCartesian(e,closestPointOnPlane(t[r],i,scratchPosition),scratchPosition);cullingVolume.planes[o++].fromPointNormal(s,scratchVector$2.copy(n).subtract(s))}}function closestPointOnPlane(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Vector3$1;const n=e.normal.dot(t);return i.copy(e.normal).scale(e.distance-n).add(t),i}function worldToCartesian(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Vector3$1;const n=e.unprojectPosition(t);return Ellipsoid.WGS84.cartographicToCartesian(n,i)}const WGS84_RADIUS_X=6378137,WGS84_RADIUS_Y=6378137,WGS84_RADIUS_Z=6356752.314245179,scratchVector$1=new Vector3$1;function getZoomFromBoundingVolume(e,t){if(e instanceof OrientedBoundingBox){const{halfAxes:i}=e,n=getObbSize(i);return Math.log2(WGS84_RADIUS_Z/(n+t[2]))}if(e instanceof BoundingSphere){const{radius:i}=e;return Math.log2(WGS84_RADIUS_Z/(i+t[2]))}if(e.width&&e.height){const{width:t,height:i}=e;return(Math.log2(WGS84_RADIUS_X/t)+Math.log2(WGS84_RADIUS_Y/i))/2}return 1}function getZoomFromFullExtent(e,t,i){const n=Ellipsoid.WGS84.cartographicToCartesian([e.xmax,e.ymax,e.zmax],new Vector3$1),r=Math.sqrt(Math.pow(n[0]-i[0],2)+Math.pow(n[1]-i[1],2)+Math.pow(n[2]-i[2],2));return Math.log2(WGS84_RADIUS_Z/(r+t[2]))}function getZoomFromExtent(e,t,i){const[n,r,o,s]=e;return getZoomFromFullExtent({xmax:o,ymax:s,zmax:0},t,i)}function getObbSize(e){e.getColumn(0,scratchVector$1);const t=e.getColumn(1),i=e.getColumn(2);return scratchVector$1.add(t).add(i).len()}const TILE_CONTENT_STATE={UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5},TILE_REFINEMENT={ADD:1,REPLACE:2},TILE_TYPE={EMPTY:"empty",SCENEGRAPH:"scenegraph",POINTCLOUD:"pointcloud",MESH:"mesh"},TILESET_TYPE={I3S:"I3S",TILES3D:"TILES3D"},LOD_METRIC_TYPE={GEOMETRIC_ERROR:"geometricError"},TILE3D_OPTIMIZATION_HINT={USE_OPTIMIZATION:1};function defined$3(e){return null!=e}const scratchPoint=new Vector3$1,scratchScale=new Vector3$1,scratchNorthWest=new Vector3$1,scratchSouthEast=new Vector3$1;function createBoundingVolume(e,t,i){if(assert$c(e,"3D Tile: boundingVolume must be defined"),e.box)return createBox(e.box,t,i);if(e.region){const[t,i,n,r,o,s]=e.region,a=Ellipsoid.WGS84.cartographicToCartesian([degrees(t),degrees(r),o],scratchNorthWest),l=Ellipsoid.WGS84.cartographicToCartesian([degrees(n),degrees(i),s],scratchSouthEast),c=(new Vector3$1).addVectors(a,l).multiplyScalar(.5),u=(new Vector3$1).subVectors(a,l).len()/2;return createSphere([c[0],c[1],c[2],u],new Matrix4$1)}if(e.sphere)return createSphere(e.sphere,t,i);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function getCartographicBounds(e,t){if(e.box)return orientedBoundingBoxToCartographicBounds(t);if(e.region){const[t,i,n,r,o,s]=e.region;return[[degrees(t),degrees(i),o],[degrees(n),degrees(r),s]]}if(e.sphere)return boundingSphereToCartographicBounds(t);throw new Error("Unkown boundingVolume type")}function createBox(e,t,i){const n=new Vector3$1(e[0],e[1],e[2]);t.transform(n,n);let r=[];if(10===e.length){const t=e.slice(3,6),i=new Quaternion$1;i.fromArray(e,6);const n=new Vector3$1([1,0,0]),o=new Vector3$1([0,1,0]),s=new Vector3$1([0,0,1]);n.transformByQuaternion(i),n.scale(t[0]),o.transformByQuaternion(i),o.scale(t[1]),s.transformByQuaternion(i),s.scale(t[2]),r=[...n.toArray(),...o.toArray(),...s.toArray()]}else r=[...e.slice(3,6),...e.slice(6,9),...e.slice(9,12)];const o=t.transformAsVector(r.slice(0,3)),s=t.transformAsVector(r.slice(3,6)),a=t.transformAsVector(r.slice(6,9)),l=new Matrix3$1([o[0],o[1],o[2],s[0],s[1],s[2],a[0],a[1],a[2]]);return defined$3(i)?(i.center=n,i.halfAxes=l,i):new OrientedBoundingBox(n,l)}function createSphere(e,t,i){const n=new Vector3$1(e[0],e[1],e[2]);t.transform(n,n);const r=t.getScale(scratchScale),o=Math.max(Math.max(r[0],r[1]),r[2]),s=e[3]*o;return defined$3(i)?(i.center=n,i.radius=s,i):new BoundingSphere(n,s)}function orientedBoundingBoxToCartographicBounds(e){const t=emptyCartographicBounds(),{halfAxes:i}=e,n=new Vector3$1(i.getColumn(0)),r=new Vector3$1(i.getColumn(1)),o=new Vector3$1(i.getColumn(2));for(let i=0;i<2;i++){for(let i=0;i<2;i++){for(let i=0;i<2;i++)scratchPoint.copy(e.center),scratchPoint.add(n),scratchPoint.add(r),scratchPoint.add(o),addToCartographicBounds(t,scratchPoint),o.negate();r.negate()}n.negate()}return t}function boundingSphereToCartographicBounds(e){const t=emptyCartographicBounds(),{center:i,radius:n}=e,r=Ellipsoid.WGS84.scaleToGeodeticSurface(i,scratchPoint);let o;o=r?Ellipsoid.WGS84.geodeticSurfaceNormal(r):new Vector3$1(0,0,1);let s=new Vector3$1(o[2],-o[1],0);s.len()>0?s.normalize():s=new Vector3$1(0,1,0);const a=s.clone().cross(o);for(const e of[s,a,o]){scratchScale.copy(e).scale(n);for(let e=0;e<2;e++)scratchPoint.copy(i),scratchPoint.add(scratchScale),addToCartographicBounds(t,scratchPoint),scratchScale.negate()}return t}function emptyCartographicBounds(){return[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]]}function addToCartographicBounds(e,t){Ellipsoid.WGS84.cartesianToCartographic(t,scratchPoint),e[0][0]=Math.min(e[0][0],scratchPoint[0]),e[0][1]=Math.min(e[0][1],scratchPoint[1]),e[0][2]=Math.min(e[0][2],scratchPoint[2]),e[1][0]=Math.max(e[1][0],scratchPoint[0]),e[1][1]=Math.max(e[1][1],scratchPoint[1]),e[1][2]=Math.max(e[1][2],scratchPoint[2])}function fog(e,t){const i=e*t;return 1-Math.exp(-i*i)}function getDynamicScreenSpaceError(e,t){if(e.dynamicScreenSpaceError&&e.dynamicScreenSpaceErrorComputedDensity){const i=e.dynamicScreenSpaceErrorFactor;return fog(t,e.dynamicScreenSpaceErrorComputedDensity)*i}return 0}function getTiles3DScreenSpaceError(e,t,i){const n=e.tileset,r=i?e.parent&&e.parent.lodMetricValue||e.lodMetricValue:e.lodMetricValue;if(0===r)return 0;const o=Math.max(e._distanceToCamera,1e-7),{height:s,sseDenominator:a}=t,{viewDistanceScale:l}=n.options;let c=r*s*(l||1)/(o*a);return c-=getDynamicScreenSpaceError(n,o),c}new Vector3$1,new Vector3$1,new Matrix4$1,new Vector3$1,new Vector3$1,new Vector3$1;const cameraPositionCartesian=new Vector3$1,toEye=new Vector3$1,cameraPositionEnu=new Vector3$1,extraVertexEnu=new Vector3$1,projectedOriginVector=new Vector3$1,enuToCartesianMatrix=new Matrix4$1,cartesianToEnuMatrix=new Matrix4$1;function getLodStatus(e,t){if(0===e.lodMetricValue||isNaN(e.lodMetricValue))return"DIG";const i=2*getProjectedRadius(e,t);return i<2?"OUT":!e.header.children||i<=e.lodMetricValue?"DRAW":e.header.children?"DIG":"OUT"}function getProjectedRadius(e,t){const{topDownViewport:i}=t,n=e.header.mbs[1],r=e.header.mbs[0],o=e.header.mbs[2],s=e.header.mbs[3],a=[...e.boundingVolume.center],l=i.unprojectPosition(i.cameraPosition);Ellipsoid.WGS84.cartographicToCartesian(l,cameraPositionCartesian),toEye.copy(cameraPositionCartesian).subtract(a).normalize(),Ellipsoid.WGS84.eastNorthUpToFixedFrame(a,enuToCartesianMatrix),cartesianToEnuMatrix.copy(enuToCartesianMatrix).invert(),cameraPositionEnu.copy(cameraPositionCartesian).transform(cartesianToEnuMatrix);const c=Math.sqrt(cameraPositionEnu[0]*cameraPositionEnu[0]+cameraPositionEnu[1]*cameraPositionEnu[1]);extraVertexEnu.copy([cameraPositionEnu[0],cameraPositionEnu[1],c*c/cameraPositionEnu[2]]);const u=extraVertexEnu.transform(enuToCartesianMatrix).subtract(a).normalize(),h=toEye.cross(u).normalize().scale(s).add(a),d=Ellipsoid.WGS84.cartesianToCartographic(h),p=i.project([r,n,o]),f=i.project(d);return projectedOriginVector.copy(p).subtract(f).magnitude()}function get3dTilesOptions(e){return{assetGltfUpAxis:e.asset&&e.asset.gltfUpAxis||"Y"}}class ManagedArray{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;_defineProperty(this,"_map",new Map),_defineProperty(this,"_array",void 0),_defineProperty(this,"_length",void 0),this._array=new Array(e),this._length=e}get length(){return this._length}set length(e){this._length=e,e>this._array.length&&(this._array.length=e)}get values(){return this._array}get(e){return assert$c(e<this._array.length),this._array[e]}set(e,t){assert$c(e>=0),e>=this.length&&(this.length=e+1),this._map.has(this._array[e])&&this._map.delete(this._array[e]),this._array[e]=t,this._map.set(t,e)}delete(e){const t=this._map.get(e);t>=0&&(this._array.splice(t,1),this._map.delete(e),this.length--)}peek(){return this._array[this._length-1]}push(e){if(!this._map.has(e)){const t=this.length++;this._array[t]=e,this._map.set(e,t)}}pop(){const e=this._array[--this.length];return this._map.delete(e),e}reserve(e){assert$c(e>=0),e>this._array.length&&(this._array.length=e)}resize(e){assert$c(e>=0),this.length=e}trim(e){null==e&&(e=this.length),this._array.length=e}reset(){this._array=[],this._map=new Map,this._length=0}find(e){return this._map.has(e)}}const DEFAULT_PROPS$1={loadSiblings:!1,skipLevelOfDetail:!1,maximumScreenSpaceError:2,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class TilesetTraverser{traversalFinished(e){return!0}constructor(e){_defineProperty(this,"options",void 0),_defineProperty(this,"root",null),_defineProperty(this,"selectedTiles",{}),_defineProperty(this,"requestedTiles",{}),_defineProperty(this,"emptyTiles",{}),_defineProperty(this,"lastUpdate",(new Date).getTime()),_defineProperty(this,"updateDebounceTime",1e3),_defineProperty(this,"_traversalStack",new ManagedArray),_defineProperty(this,"_emptyTraversalStack",new ManagedArray),_defineProperty(this,"_frameNumber",null),this.options={...DEFAULT_PROPS$1,...e}}traverse(e,t,i){this.root=e,this.options={...this.options,...i},this.reset(),this.updateTile(e,t),this._frameNumber=t.frameNumber,this.executeTraversal(e,t)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(e,t){const i=this._traversalStack;for(e._selectionDepth=1,i.push(e);i.length>0;){const e=i.pop();let n=!1;this.canTraverse(e,t)&&(this.updateChildTiles(e,t),n=this.updateAndPushChildren(e,t,i,e.hasRenderContent?e._selectionDepth+1:e._selectionDepth));const r=e.parent,o=Boolean(!r||r._shouldRefine),s=!n;e.hasRenderContent?e.refine===TILE_REFINEMENT.ADD?(this.loadTile(e,t),this.selectTile(e,t)):e.refine===TILE_REFINEMENT.REPLACE&&(this.loadTile(e,t),s&&this.selectTile(e,t)):(this.emptyTiles[e.id]=e,this.loadTile(e,t),s&&this.selectTile(e,t)),this.touchTile(e,t),e._shouldRefine=n&&o}const n=(new Date).getTime();(this.traversalFinished(t)||n-this.lastUpdate>this.updateDebounceTime)&&(this.lastUpdate=n,this.options.onTraversalEnd(t))}updateChildTiles(e,t){const i=e.children;for(const e of i)this.updateTile(e,t)}updateAndPushChildren(e,t,i,n){const{loadSiblings:r,skipLevelOfDetail:o}=this.options,s=e.children;s.sort(this.compareDistanceToCamera.bind(this));const a=e.refine===TILE_REFINEMENT.REPLACE&&e.hasRenderContent&&!o;let l=!1,c=!0;for(const e of s)if(e._selectionDepth=n,e.isVisibleAndInRequestVolume?(i.find(e)&&i.delete(e),i.push(e),l=!0):(a||r)&&(this.loadTile(e,t),this.touchTile(e,t)),a){let i;if(i=!!e._inRequestVolume&&(e.hasRenderContent?e.contentAvailable:this.executeEmptyTraversal(e,t)),c=c&&i,!c)return!1}return l||(c=!1),c}updateTile(e,t){this.updateTileVisibility(e,t)}selectTile(e,t){this.shouldSelectTile(e)&&(e._selectedFrame=t.frameNumber,this.selectedTiles[e.id]=e)}loadTile(e,t){this.shouldLoadTile(e)&&(e._requestedFrame=t.frameNumber,e._priority=e._getPriority(),this.requestedTiles[e.id]=e)}touchTile(e,t){e.tileset._cache.touch(e),e._touchedFrame=t.frameNumber}canTraverse(e,t){return!!e.hasChildren&&(e.hasTilesetContent?!e.contentExpired:!(!(arguments.length>3&&void 0!==arguments[3]&&arguments[3])&&!e.isVisibleAndInRequestVolume)&&this.shouldRefine(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2]))}shouldLoadTile(e){return e.hasUnloadedContent||e.contentExpired}shouldSelectTile(e){return e.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(e,t){let i=e._screenSpaceError;return arguments.length>2&&void 0!==arguments[2]&&arguments[2]&&(i=e.getScreenSpaceError(t,!0)),i>this.options.maximumScreenSpaceError}updateTileVisibility(e,t){const i=[];if(this.options.viewportTraversersMap)for(const e in this.options.viewportTraversersMap){this.options.viewportTraversersMap[e]===t.viewport.id&&i.push(e)}else i.push(t.viewport.id);e.updateVisibility(t,i)}compareDistanceToCamera(e,t){return e._distanceToCamera-t._distanceToCamera}anyChildrenVisible(e,t){let i=!1;for(const n of e.children)n.updateVisibility(t),i=i||n.isVisibleAndInRequestVolume;return i}executeEmptyTraversal(e,t){let i=!0;const n=this._emptyTraversalStack;for(n.push(e);n.length>0&&i;){const e=n.pop();this.updateTile(e,t),e.isVisibleAndInRequestVolume||this.loadTile(e,t),this.touchTile(e,t);if(!e.hasRenderContent&&this.canTraverse(e,t,!1,!0)){const t=e.children;for(const e of t)n.find(e)&&n.delete(e),n.push(e)}else e.contentAvailable||e.hasEmptyContent||(i=!1)}return i}}const scratchVector=new Vector3$1;function defined$2(e){return null!=e}class Tile3D{constructor(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";_defineProperty(this,"tileset",void 0),_defineProperty(this,"header",void 0),_defineProperty(this,"id",void 0),_defineProperty(this,"url",void 0),_defineProperty(this,"parent",void 0),_defineProperty(this,"refine",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"contentUrl",void 0),_defineProperty(this,"lodMetricType","geometricError"),_defineProperty(this,"lodMetricValue",0),_defineProperty(this,"boundingVolume",null),_defineProperty(this,"content",null),_defineProperty(this,"contentState",TILE_CONTENT_STATE.UNLOADED),_defineProperty(this,"gpuMemoryUsageInBytes",0),_defineProperty(this,"children",[]),_defineProperty(this,"depth",0),_defineProperty(this,"viewportIds",[]),_defineProperty(this,"transform",new Matrix4$1),_defineProperty(this,"extensions",null),_defineProperty(this,"implicitTiling",null),_defineProperty(this,"userData",{}),_defineProperty(this,"computedTransform",void 0),_defineProperty(this,"hasEmptyContent",!1),_defineProperty(this,"hasTilesetContent",!1),_defineProperty(this,"traverser",new TilesetTraverser({})),_defineProperty(this,"_cacheNode",null),_defineProperty(this,"_frameNumber",null),_defineProperty(this,"_expireDate",null),_defineProperty(this,"_expiredContent",null),_defineProperty(this,"_boundingBox",void 0),_defineProperty(this,"_distanceToCamera",0),_defineProperty(this,"_screenSpaceError",0),_defineProperty(this,"_visibilityPlaneMask",void 0),_defineProperty(this,"_visible",void 0),_defineProperty(this,"_contentBoundingVolume",void 0),_defineProperty(this,"_viewerRequestVolume",void 0),_defineProperty(this,"_initialTransform",new Matrix4$1),_defineProperty(this,"_priority",0),_defineProperty(this,"_selectedFrame",0),_defineProperty(this,"_requestedFrame",0),_defineProperty(this,"_selectionDepth",0),_defineProperty(this,"_touchedFrame",0),_defineProperty(this,"_centerZDepth",0),_defineProperty(this,"_shouldRefine",!1),_defineProperty(this,"_stackLength",0),_defineProperty(this,"_visitedFrame",0),_defineProperty(this,"_inRequestVolume",!1),_defineProperty(this,"_lodJudge",null),this.header=t,this.tileset=e,this.id=n||t.id,this.url=t.url,this.parent=i,this.refine=this._getRefine(t.refine),this.type=t.type,this.contentUrl=t.contentUrl,this._initializeLodMetric(t),this._initializeTransforms(t),this._initializeBoundingVolumes(t),this._initializeContent(t),this._initializeRenderingState(t),Object.seal(this)}destroy(){this.header=null}isDestroyed(){return null===this.header}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===TILE_CONTENT_STATE.READY||this.hasEmptyContent}get contentAvailable(){return Boolean(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===TILE_CONTENT_STATE.UNLOADED}get contentExpired(){return this.contentState===TILE_CONTENT_STATE.EXPIRED}get contentFailed(){return this.contentState===TILE_CONTENT_STATE.FAILED}get distanceToCamera(){return this._distanceToCamera}get screenSpaceError(){return this._screenSpaceError}get boundingBox(){return this._boundingBox||(this._boundingBox=getCartographicBounds(this.header.boundingVolume,this.boundingVolume)),this._boundingBox}getScreenSpaceError(e,t){switch(this.tileset.type){case TILESET_TYPE.I3S:return getProjectedRadius(this,e);case TILESET_TYPE.TILES3D:return getTiles3DScreenSpaceError(this,e,t);default:throw new Error("Unsupported tileset type")}}unselect(){this._selectedFrame=0}_getGpuMemoryUsageInBytes(){return this.content.gpuMemoryUsageInBytes||this.content.byteLength||0}_getPriority(){const e=this.tileset._traverser,{skipLevelOfDetail:t}=e.options,i=this.refine===TILE_REFINEMENT.ADD||t;if(i&&!this.isVisible&&void 0!==this._visible)return-1;if(this.tileset._frameNumber-this._touchedFrame>=1)return-1;if(this.contentState===TILE_CONTENT_STATE.UNLOADED)return-1;const n=this.parent;return Math.max((e.root?e.root._screenSpaceError:0)-(n&&(!i||0===this._screenSpaceError||n.hasTilesetContent)?n._screenSpaceError:this._screenSpaceError),0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=TILE_CONTENT_STATE.LOADING;const e=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!e)return this.contentState=TILE_CONTENT_STATE.UNLOADED,!1;try{const e=this.tileset.getTileUrl(this.contentUrl),t=this.tileset.loader,i={...this.tileset.loadOptions,[t.id]:{...this.tileset.loadOptions[t.id],isTileset:"json"===this.type,...this._getLoaderSpecificOptions(t.id)}};return this.content=await load(e,t,i),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=TILE_CONTENT_STATE.READY,this._onContentLoaded(),!0}catch(e){throw this.contentState=TILE_CONTENT_STATE.FAILED,e}finally{e.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=TILE_CONTENT_STATE.UNLOADED,!0}updateVisibility(e,t){if(this._frameNumber===e.frameNumber)return;const i=this.parent,n=i?i._visibilityPlaneMask:CullingVolume.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){this._updateTransform(i?i.computedTransform:this.tileset.modelMatrix)}this._distanceToCamera=this.distanceToTile(e),this._screenSpaceError=this.getScreenSpaceError(e,!1),this._visibilityPlaneMask=this.visibility(e,n),this._visible=this._visibilityPlaneMask!==CullingVolume.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(e),this._frameNumber=e.frameNumber,this.viewportIds=t}visibility(e,t){const{cullingVolume:i}=e,{boundingVolume:n}=this;return i.computeVisibilityWithPlaneMask(n,t)}contentVisibility(){return!0}distanceToTile(e){return Math.sqrt(Math.max(this.boundingVolume.distanceSquaredTo(e.camera.position),0))}cameraSpaceZDepth(e){let{camera:t}=e;return scratchVector.subVectors(this.boundingVolume.center,t.position),t.direction.dot(scratchVector)}insideViewerRequestVolume(e){const t=this._viewerRequestVolume;return!t||t.distanceSquaredTo(e.camera.position)<=0}updateExpiration(){if(defined$2(this._expireDate)&&this.contentReady&&!this.hasEmptyContent){const e=Date.now();Date.lessThan(this._expireDate,e)&&(this.contentState=TILE_CONTENT_STATE.EXPIRED,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(e){this.lodMetricType="lodMetricType"in e?e.lodMetricType:this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,this.lodMetricValue="lodMetricValue"in e?e.lodMetricValue:this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue}_initializeTransforms(e){this.transform=e.transform?new Matrix4$1(e.transform):new Matrix4$1;const t=this.parent,i=this.tileset,n=t&&t.computedTransform?t.computedTransform.clone():i.modelMatrix.clone();this.computedTransform=new Matrix4$1(n).multiplyRight(this.transform);const r=t&&t._initialTransform?t._initialTransform.clone():new Matrix4$1;this._initialTransform=new Matrix4$1(r).multiplyRight(this.transform)}_initializeBoundingVolumes(e){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(e)}_initializeContent(e){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=TILE_CONTENT_STATE.UNLOADED,this.hasTilesetContent=!1,e.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(e){this.depth=e.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=CullingVolume.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(e){return e||this.parent&&this.parent.refine||TILE_REFINEMENT.REPLACE}_isTileset(){return-1!==this.contentUrl.indexOf(".json")}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0}this._isTileset()?this.hasTilesetContent=!0:this.gpuMemoryUsageInBytes=this._getGpuMemoryUsageInBytes()}_updateBoundingVolume(e){this.boundingVolume=createBoundingVolume(e.boundingVolume,this.computedTransform,this.boundingVolume);const t=e.content;t&&(t.boundingVolume&&(this._contentBoundingVolume=createBoundingVolume(t.boundingVolume,this.computedTransform,this._contentBoundingVolume)),e.viewerRequestVolume&&(this._viewerRequestVolume=createBoundingVolume(e.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Matrix4$1).clone().multiplyRight(this.transform);!e.equals(this.computedTransform)&&(this.computedTransform=e,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(e){return"i3s"===e?{...this.tileset.options.i3s,_tileOptions:{attributeUrls:this.header.attributeUrls,textureUrl:this.header.textureUrl,textureFormat:this.header.textureFormat,textureLoaderOptions:this.header.textureLoaderOptions,materialDefinition:this.header.materialDefinition,isDracoGeometry:this.header.isDracoGeometry,mbs:this.header.mbs},_tilesetOptions:{store:this.tileset.tileset.store,attributeStorageInfo:this.tileset.tileset.attributeStorageInfo,fields:this.tileset.tileset.fields},isTileHeader:!1}:get3dTilesOptions(this.tileset.tileset)}}class Tileset3DTraverser extends TilesetTraverser{compareDistanceToCamera(e,t){return 0===t._distanceToCamera&&0===e._distanceToCamera?t._centerZDepth-e._centerZDepth:t._distanceToCamera-e._distanceToCamera}updateTileVisibility(e,t){if(super.updateTileVisibility(e,t),!e.isVisibleAndInRequestVolume)return;const i=e.children.length>0;if(e.hasTilesetContent&&i){const i=e.children[0];return this.updateTileVisibility(i,t),void(e._visible=i._visible)}if(this.meetsScreenSpaceErrorEarly(e,t))return void(e._visible=!1);e.refine===TILE_REFINEMENT.REPLACE&&e._optimChildrenWithinParent===TILE3D_OPTIMIZATION_HINT.USE_OPTIMIZATION&&i&&!this.anyChildrenVisible(e,t)&&(e._visible=!1)}meetsScreenSpaceErrorEarly(e,t){const{parent:i}=e;return!(!i||i.hasTilesetContent||i.refine!==TILE_REFINEMENT.ADD)&&!this.shouldRefine(e,t,!0)}}class I3SPendingTilesRegister{constructor(){_defineProperty(this,"frameNumberMap",new Map)}register(e,t){const i=this.frameNumberMap.get(e)||new Map,n=i.get(t)||0;i.set(t,n+1),this.frameNumberMap.set(e,i)}deregister(e,t){const i=this.frameNumberMap.get(e);if(!i)return;const n=i.get(t)||1;i.set(t,n-1)}isZero(e,t){var i;return 0===((null===(i=this.frameNumberMap.get(e))||void 0===i?void 0:i.get(t))||0)}}const STATUS={REQUESTED:"REQUESTED",COMPLETED:"COMPLETED",ERROR:"ERROR"};class I3STileManager{constructor(){_defineProperty(this,"_statusMap",void 0),_defineProperty(this,"pendingTilesRegister",new I3SPendingTilesRegister),this._statusMap={}}add(e,t,i,n){if(!this._statusMap[t]){const{frameNumber:r,viewport:{id:o}}=n;this._statusMap[t]={request:e,callback:i,key:t,frameState:n,status:STATUS.REQUESTED},this.pendingTilesRegister.register(o,r),e().then((e=>{this._statusMap[t].status=STATUS.COMPLETED;const{frameNumber:i,viewport:{id:r}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(r,i),this._statusMap[t].callback(e,n)})).catch((e=>{this._statusMap[t].status=STATUS.ERROR;const{frameNumber:n,viewport:{id:r}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(r,n),i(e)}))}}update(e,t){if(this._statusMap[e]){const{frameNumber:i,viewport:{id:n}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(n,i);const{frameNumber:r,viewport:{id:o}}=t;this.pendingTilesRegister.register(o,r),this._statusMap[e].frameState=t}}find(e){return this._statusMap[e]}hasPendingTiles(e,t){return!this.pendingTilesRegister.isZero(e,t)}}class I3STilesetTraverser extends TilesetTraverser{constructor(e){super(e),_defineProperty(this,"_tileManager",void 0),this._tileManager=new I3STileManager}traversalFinished(e){return!this._tileManager.hasPendingTiles(e.viewport.id,this._frameNumber||0)}shouldRefine(e,t){return e._lodJudge=getLodStatus(e,t),"DIG"===e._lodJudge}updateChildTiles(e,t){const i=e.header.children||[],n=e.children,r=e.tileset;for(const o of i){const i="".concat(o.id,"-").concat(t.viewport.id),s=n&&n.find((e=>e.id===i));if(s)s&&this.updateTile(s,t);else{let n=()=>this._loadTile(o.id,r);this._tileManager.find(i)?this._tileManager.update(i,t):(r.tileset.nodePages&&(n=()=>r.tileset.nodePagesTile.formTileFromNodePages(o.id)),this._tileManager.add(n,i,(t=>this._onTileLoad(t,e,i)),t))}}return!1}async _loadTile(e,t){const{loader:i}=t,n=t.getTileUrl("".concat(t.url,"/nodes/").concat(e)),r={...t.loadOptions,i3s:{...t.loadOptions.i3s,isTileHeader:!0}};return await load(n,i,r)}_onTileLoad(e,t,i){const n=new Tile3D(t.tileset,e,t,i);t.children.push(n);const r=this._tileManager.find(n.id).frameState;this.updateTile(n,r),this._frameNumber===r.frameNumber&&(this.traversalFinished(r)||(new Date).getTime()-this.lastUpdate>this.updateDebounceTime)&&this.executeTraversal(n,r)}}const DEFAULT_PROPS={description:"",ellipsoid:Ellipsoid.WGS84,modelMatrix:new Matrix4$1,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,maximumTilesSelected:0,debounceTime:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:e=>e,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},TILES_TOTAL="Tiles In Tileset(s)",TILES_IN_MEMORY="Tiles In Memory",TILES_IN_VIEW="Tiles In View",TILES_RENDERABLE="Tiles To Render",TILES_LOADED="Tiles Loaded",TILES_LOADING="Tiles Loading",TILES_UNLOADED="Tiles Unloaded",TILES_LOAD_FAILED="Failed Tile Loads",POINTS_COUNT="Points/Vertices",TILES_GPU_MEMORY="Tile Memory Use";class Tileset3D{constructor(e,t){_defineProperty(this,"options",void 0),_defineProperty(this,"loadOptions",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"tileset",void 0),_defineProperty(this,"loader",void 0),_defineProperty(this,"url",void 0),_defineProperty(this,"basePath",void 0),_defineProperty(this,"modelMatrix",void 0),_defineProperty(this,"ellipsoid",void 0),_defineProperty(this,"lodMetricType",void 0),_defineProperty(this,"lodMetricValue",void 0),_defineProperty(this,"refine",void 0),_defineProperty(this,"root",null),_defineProperty(this,"roots",{}),_defineProperty(this,"asset",{}),_defineProperty(this,"description",""),_defineProperty(this,"properties",void 0),_defineProperty(this,"extras",null),_defineProperty(this,"attributions",{}),_defineProperty(this,"credits",{}),_defineProperty(this,"stats",void 0),_defineProperty(this,"contentFormats",{draco:!1,meshopt:!1,dds:!1,ktx2:!1}),_defineProperty(this,"cartographicCenter",null),_defineProperty(this,"cartesianCenter",null),_defineProperty(this,"zoom",1),_defineProperty(this,"boundingVolume",null),_defineProperty(this,"dynamicScreenSpaceErrorComputedDensity",0),_defineProperty(this,"maximumMemoryUsage",32),_defineProperty(this,"gpuMemoryUsageInBytes",0),_defineProperty(this,"_frameNumber",0),_defineProperty(this,"_queryParams",{}),_defineProperty(this,"_extensionsUsed",[]),_defineProperty(this,"_tiles",{}),_defineProperty(this,"_pendingCount",0),_defineProperty(this,"selectedTiles",[]),_defineProperty(this,"traverseCounter",0),_defineProperty(this,"geometricError",0),_defineProperty(this,"lastUpdatedVieports",null),_defineProperty(this,"_requestedTiles",[]),_defineProperty(this,"_emptyTiles",[]),_defineProperty(this,"frameStateData",{}),_defineProperty(this,"_traverser",void 0),_defineProperty(this,"_cache",new TilesetCache),_defineProperty(this,"_requestScheduler",void 0),_defineProperty(this,"updatePromise",null),_defineProperty(this,"tilesetInitializationPromise",void 0),this.options={...DEFAULT_PROPS,...t},this.tileset=e,this.loader=e.loader,this.type=e.type,this.url=e.url,this.basePath=e.basePath||dirname(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=e.lodMetricType,this.lodMetricValue=e.lodMetricValue,this.refine=e.root.refine,this.loadOptions=this.options.loadOptions||{},this._traverser=this._initializeTraverser(),this._requestScheduler=new RequestScheduler({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this.stats=new Stats({id:this.url}),this._initializeStats(),this.tilesetInitializationPromise=this._initializeTileSet(e)}destroy(){this._destroy()}isLoaded(){return 0===this._pendingCount&&0!==this._frameNumber&&0===this._requestedTiles.length}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return new URLSearchParams(this._queryParams).toString()}setProps(e){this.options={...this.options,...e}}setOptions(e){this.options={...this.options,...e}}getTileUrl(e){return e.startsWith("data:")?e:"".concat(e).concat(e.includes("?")?"&":"?").concat(this.queryParams)}hasExtension(e){return Boolean(this._extensionsUsed.indexOf(e)>-1)}update(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.tilesetInitializationPromise.then((()=>{!e&&this.lastUpdatedVieports?e=this.lastUpdatedVieports:this.lastUpdatedVieports=e,e&&this.doUpdate(e)}))}async selectTiles(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return await this.tilesetInitializationPromise,e&&(this.lastUpdatedVieports=e),this.updatePromise||(this.updatePromise=new Promise((e=>{setTimeout((()=>{this.lastUpdatedVieports&&this.doUpdate(this.lastUpdatedVieports),e(this._frameNumber),this.updatePromise=null}),this.options.debounceTime)}))),this.updatePromise}doUpdate(e){if("loadTiles"in this.options&&!this.options.loadTiles)return;if(this.traverseCounter>0)return;const t=e instanceof Array?e:[e];this._cache.reset(),this._frameNumber++,this.traverseCounter=t.length;const i=[];for(const e of t){const t=e.id;this._needTraverse(t)?i.push(t):this.traverseCounter--}for(const e of t){const t=e.id;if(this.roots[t]||(this.roots[t]=this._initializeTileHeaders(this.tileset,null)),!i.includes(t))continue;const n=getFrameState(e,this._frameNumber);this._traverser.traverse(this.roots[t],n,this.options)}}_needTraverse(e){let t=e;return this.options.viewportTraversersMap&&(t=this.options.viewportTraversersMap[e]),t===e}_onTraversalEnd(e){const t=e.viewport.id;this.frameStateData[t]||(this.frameStateData[t]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const i=this.frameStateData[t],n=Object.values(this._traverser.selectedTiles),[r,o]=limitSelectedTiles(n,e,this.options.maximumTilesSelected);i.selectedTiles=r;for(const e of o)e.unselect();i._requestedTiles=Object.values(this._traverser.requestedTiles),i._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,this.traverseCounter>0||this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const e in this.frameStateData){const t=this.frameStateData[e];this.selectedTiles=this.selectedTiles.concat(t.selectedTiles),this._requestedTiles=this._requestedTiles.concat(t._requestedTiles),this._emptyTiles=this._emptyTiles.concat(t._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const e of this.selectedTiles)this._tiles[e.id]=e;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(e,t){if(e.length!==t.length)return!0;const i=new Set(e.map((e=>e.id))),n=new Set(t.map((e=>e.id)));let r=e.filter((e=>!n.has(e.id))).length>0;return r=r||t.filter((e=>!i.has(e.id))).length>0,r}_loadTiles(){for(const e of this._requestedTiles)e.contentUnloaded&&this._loadTile(e)}_unloadTiles(){this._cache.unloadTiles(this,((e,t)=>e._unloadTile(t)))}_updateStats(){let e=0,t=0;for(const i of this.selectedTiles)i.contentAvailable&&i.content&&(e++,t+=i.content.pointCount?i.content.pointCount:i.content.vertexCount);this.stats.get(TILES_IN_VIEW).count=this.selectedTiles.length,this.stats.get(TILES_RENDERABLE).count=e,this.stats.get(POINTS_COUNT).count=t}async _initializeTileSet(e){this.type===TILESET_TYPE.I3S&&(this.calculateViewPropsI3S(),e.root=await e.root),this.root=this._initializeTileHeaders(e,null),this.type===TILESET_TYPE.TILES3D&&(this._initializeTiles3DTileset(e),this.calculateViewPropsTiles3D()),this.type===TILESET_TYPE.I3S&&this._initializeI3STileset()}calculateViewPropsI3S(){var e;const t=this.tileset.fullExtent;if(t){const{xmin:e,xmax:i,ymin:n,ymax:r,zmin:o,zmax:s}=t;return this.cartographicCenter=new Vector3$1(e+(i-e)/2,n+(r-n)/2,o+(s-o)/2),this.cartesianCenter=Ellipsoid.WGS84.cartographicToCartesian(this.cartographicCenter,new Vector3$1),void(this.zoom=getZoomFromFullExtent(t,this.cartographicCenter,this.cartesianCenter))}const i=null===(e=this.tileset.store)||void 0===e?void 0:e.extent;if(i){const[e,t,n,r]=i;return this.cartographicCenter=new Vector3$1(e+(n-e)/2,t+(r-t)/2,0),this.cartesianCenter=Ellipsoid.WGS84.cartographicToCartesian(this.cartographicCenter,new Vector3$1),void(this.zoom=getZoomFromExtent(i,this.cartographicCenter,this.cartesianCenter))}this.cartographicCenter=new Vector3$1,this.zoom=1}calculateViewPropsTiles3D(){const e=this.root,{center:t}=e.boundingVolume;if(!t)return this.cartographicCenter=new Vector3$1,void(this.zoom=1);this.cartographicCenter=0!==t[0]||0!==t[1]||0!==t[2]?Ellipsoid.WGS84.cartesianToCartographic(t,new Vector3$1):new Vector3$1(0,0,-Ellipsoid.WGS84.radii[0]),this.cartesianCenter=t,this.zoom=getZoomFromBoundingVolume(e.boundingVolume,this.cartographicCenter)}_initializeStats(){this.stats.get(TILES_TOTAL),this.stats.get(TILES_LOADING),this.stats.get(TILES_IN_MEMORY),this.stats.get(TILES_IN_VIEW),this.stats.get(TILES_RENDERABLE),this.stats.get(TILES_LOADED),this.stats.get(TILES_UNLOADED),this.stats.get(TILES_LOAD_FAILED),this.stats.get(POINTS_COUNT),this.stats.get(TILES_GPU_MEMORY,"memory")}_initializeTileHeaders(e,t){const i=new Tile3D(this,e.root,t);if(t&&(t.children.push(i),i.depth=t.depth+1),this.type===TILESET_TYPE.TILES3D){const e=[];for(e.push(i);e.length>0;){const t=e.pop();this.stats.get(TILES_TOTAL).incrementCount();const i=t.header.children||[];for(const r of i){var n;const i=new Tile3D(this,r,t);if(null!==(n=i.contentUrl)&&void 0!==n&&n.includes("?session=")){const e=new URL(i.contentUrl).searchParams.get("session");e&&(this._queryParams.session=e)}t.children.push(i),i.depth=t.depth+1,e.push(i)}}}return i}_initializeTraverser(){let e;switch(this.type){case TILESET_TYPE.TILES3D:e=Tileset3DTraverser;break;case TILESET_TYPE.I3S:e=I3STilesetTraverser;break;default:e=TilesetTraverser}return new e({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(e){this._destroySubtree(e)}async _loadTile(e){let t;try{this._onStartTileLoading(),t=await e.loadContent()}catch(t){this._onTileLoadError(e,t instanceof Error?t:new Error("load failed"))}finally{this._onEndTileLoading(),this._onTileLoad(e,t)}}_onTileLoadError(e,t){this.stats.get(TILES_LOAD_FAILED).incrementCount();const i=t.message||t.toString();this.options.onTileError(e,i,e.url)}_onTileLoad(e,t){if(t){if(this.type===TILESET_TYPE.I3S){var i,n;const e=(null===(i=this.tileset)||void 0===i||null===(n=i.nodePagesTile)||void 0===n?void 0:n.nodesInNodePages)||0;this.stats.get(TILES_TOTAL).reset(),this.stats.get(TILES_TOTAL).addCount(e)}e&&e.content&&calculateTransformProps(e,e.content),this.updateContentTypes(e),this._addTileToCache(e),this.options.onTileLoad(e)}}updateContentTypes(e){if(this.type===TILESET_TYPE.I3S)switch(e.header.isDracoGeometry&&(this.contentFormats.draco=!0),e.header.textureFormat){case"dds":this.contentFormats.dds=!0;break;case"ktx2":this.contentFormats.ktx2=!0}else if(this.type===TILESET_TYPE.TILES3D){var t;const{extensionsRemoved:i=[]}=(null===(t=e.content)||void 0===t?void 0:t.gltf)||{};i.includes("KHR_draco_mesh_compression")&&(this.contentFormats.draco=!0),i.includes("EXT_meshopt_compression")&&(this.contentFormats.meshopt=!0),i.includes("KHR_texture_basisu")&&(this.contentFormats.ktx2=!0)}}_onStartTileLoading(){this._pendingCount++,this.stats.get(TILES_LOADING).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(TILES_LOADING).decrementCount()}_addTileToCache(e){this._cache.add(this,e,(t=>t._updateCacheStats(e)))}_updateCacheStats(e){this.stats.get(TILES_LOADED).incrementCount(),this.stats.get(TILES_IN_MEMORY).incrementCount(),this.gpuMemoryUsageInBytes+=e.gpuMemoryUsageInBytes||0,this.stats.get(TILES_GPU_MEMORY).count=this.gpuMemoryUsageInBytes}_unloadTile(e){this.gpuMemoryUsageInBytes-=e.gpuMemoryUsageInBytes||0,this.stats.get(TILES_IN_MEMORY).decrementCount(),this.stats.get(TILES_UNLOADED).incrementCount(),this.stats.get(TILES_GPU_MEMORY).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(e),e.unloadContent()}_destroy(){const e=[];for(this.root&&e.push(this.root);e.length>0;){const t=e.pop();for(const i of t.children)e.push(i);this._destroyTile(t)}this.root=null}_destroySubtree(e){const t=e,i=[];for(i.push(t);i.length>0;){e=i.pop();for(const t of e.children)i.push(t);e!==t&&this._destroyTile(e)}t.children=[]}_destroyTile(e){this._cache.unloadTile(this,e),this._unloadTile(e),e.destroy()}_initializeTiles3DTileset(e){if(e.queryString){const t=new URLSearchParams(e.queryString),i=Object.fromEntries(t.entries());this._queryParams={...this._queryParams,...i}}if(this.asset=e.asset,!this.asset)throw new Error("Tileset must have an asset property.");if("0.0"!==this.asset.version&&"1.0"!==this.asset.version)throw new Error("The tileset must be 3D Tiles version 0.0 or 1.0.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=e.properties,this.geometricError=e.geometricError,this._extensionsUsed=e.extensionsUsed||[],this.extras=e.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}const VERSION="3.4.15",TILE3D_TYPE={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GLTF:"glTF"};function getStringFromArrayBuffer(e,t,i){assert$c(e instanceof ArrayBuffer);const n=new TextDecoder("utf8"),r=new Uint8Array(e,t,i);return n.decode(r)}function getMagicString(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=new DataView(e);return"".concat(String.fromCharCode(i.getUint8(t+0))).concat(String.fromCharCode(i.getUint8(t+1))).concat(String.fromCharCode(i.getUint8(t+2))).concat(String.fromCharCode(i.getUint8(t+3)))}const GL_PRIMITIVE_MODE={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},GL_TYPE={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},GL$1={...GL_PRIMITIVE_MODE,...GL_TYPE},GL_TYPE_TO_ARRAY_TYPE={[GL_TYPE.DOUBLE]:Float64Array,[GL_TYPE.FLOAT]:Float32Array,[GL_TYPE.UNSIGNED_SHORT]:Uint16Array,[GL_TYPE.UNSIGNED_INT]:Uint32Array,[GL_TYPE.UNSIGNED_BYTE]:Uint8Array,[GL_TYPE.BYTE]:Int8Array,[GL_TYPE.SHORT]:Int16Array,[GL_TYPE.INT]:Int32Array},NAME_TO_GL_TYPE={DOUBLE:GL_TYPE.DOUBLE,FLOAT:GL_TYPE.FLOAT,UNSIGNED_SHORT:GL_TYPE.UNSIGNED_SHORT,UNSIGNED_INT:GL_TYPE.UNSIGNED_INT,UNSIGNED_BYTE:GL_TYPE.UNSIGNED_BYTE,BYTE:GL_TYPE.BYTE,SHORT:GL_TYPE.SHORT,INT:GL_TYPE.INT},ERR_TYPE_CONVERSION="Failed to convert GL type";class GLType{static fromTypedArray(e){e=ArrayBuffer.isView(e)?e.constructor:e;for(const t in GL_TYPE_TO_ARRAY_TYPE){if(GL_TYPE_TO_ARRAY_TYPE[t]===e)return t}throw new Error(ERR_TYPE_CONVERSION)}static fromName(e){const t=NAME_TO_GL_TYPE[e];if(!t)throw new Error(ERR_TYPE_CONVERSION);return t}static getArrayType(e){switch(e){case GL_TYPE.UNSIGNED_SHORT_5_6_5:case GL_TYPE.UNSIGNED_SHORT_4_4_4_4:case GL_TYPE.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const t=GL_TYPE_TO_ARRAY_TYPE[e];if(!t)throw new Error(ERR_TYPE_CONVERSION);return t}}static getByteSize(e){return GLType.getArrayType(e).BYTES_PER_ELEMENT}static validate(e){return Boolean(GLType.getArrayType(e))}static createTypedArray(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3?arguments[3]:void 0;void 0===n&&(n=(t.byteLength-i)/GLType.getByteSize(e));return new(GLType.getArrayType(e))(t,i,n)}}function assert$1(e,t){if(!e)throw new Error("math.gl assertion failed. ".concat(t))}function decodeRGB565(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];const i=e>>5&63,n=31&e;return t[0]=(e>>11&31)<<3,t[1]=i<<2,t[2]=n<<3,t}function fromSNorm(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:255;return clamp$2(e,0,t)/t*2-1}function signNotZero(e){return e<0?-1:1}function octDecodeInRange(e,t,i,n){if(assert$1(n),e<0||e>i||t<0||t>i)throw new Error("x and y must be unsigned normalized integers between 0 and ".concat(i));if(n.x=fromSNorm(e,i),n.y=fromSNorm(t,i),n.z=1-(Math.abs(n.x)+Math.abs(n.y)),n.z<0){const e=n.x;n.x=(1-Math.abs(n.y))*signNotZero(e),n.y=(1-Math.abs(e))*signNotZero(n.y)}return n.normalize()}function octDecode(e,t,i){return octDecodeInRange(e,t,255,i)}new Vector2$1,new Vector3$1,new Vector2$1,new Vector2$1;class Tile3DFeatureTable{constructor(e,t){_defineProperty(this,"json",void 0),_defineProperty(this,"buffer",void 0),_defineProperty(this,"featuresLength",0),_defineProperty(this,"_cachedTypedArrays",{}),this.json=e,this.buffer=t}getExtension(e){return this.json.extensions&&this.json.extensions[e]}hasProperty(e){return Boolean(this.json[e])}getGlobalProperty(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:GL$1.UNSIGNED_INT,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const n=this.json[e];return n&&Number.isFinite(n.byteOffset)?this._getTypedArrayFromBinary(e,t,i,1,n.byteOffset):n}getPropertyArray(e,t,i){const n=this.json[e];return n&&Number.isFinite(n.byteOffset)?("componentType"in n&&(t=GLType.fromName(n.componentType)),this._getTypedArrayFromBinary(e,t,i,this.featuresLength,n.byteOffset)):this._getTypedArrayFromArray(e,t,n)}getProperty(e,t,i,n,r){const o=this.json[e];if(!o)return o;const s=this.getPropertyArray(e,t,i);if(1===i)return s[n];for(let e=0;e<i;++e)r[e]=s[i*n+e];return r}_getTypedArrayFromBinary(e,t,i,n,r){const o=this._cachedTypedArrays;let s=o[e];return s||(s=GLType.createTypedArray(t,this.buffer.buffer,this.buffer.byteOffset+r,n*i),o[e]=s),s}_getTypedArrayFromArray(e,t,i){const n=this._cachedTypedArrays;let r=n[e];return r||(r=GLType.createTypedArray(t,i),n[e]=r),r}}const COMPONENTS_PER_ATTRIBUTE={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},UNPACKER={SCALAR:(e,t)=>e[t],VEC2:(e,t)=>[e[2*t+0],e[2*t+1]],VEC3:(e,t)=>[e[3*t+0],e[3*t+1],e[3*t+2]],VEC4:(e,t)=>[e[4*t+0],e[4*t+1],e[4*t+2],e[4*t+3]],MAT2:(e,t)=>[e[4*t+0],e[4*t+1],e[4*t+2],e[4*t+3]],MAT3:(e,t)=>[e[9*t+0],e[9*t+1],e[9*t+2],e[9*t+3],e[9*t+4],e[9*t+5],e[9*t+6],e[9*t+7],e[9*t+8]],MAT4:(e,t)=>[e[16*t+0],e[16*t+1],e[16*t+2],e[16*t+3],e[16*t+4],e[16*t+5],e[16*t+6],e[16*t+7],e[16*t+8],e[16*t+9],e[16*t+10],e[16*t+11],e[16*t+12],e[16*t+13],e[16*t+14],e[16*t+15]]},PACKER={SCALAR:(e,t,i)=>{t[i]=e},VEC2:(e,t,i)=>{t[2*i+0]=e[0],t[2*i+1]=e[1]},VEC3:(e,t,i)=>{t[3*i+0]=e[0],t[3*i+1]=e[1],t[3*i+2]=e[2]},VEC4:(e,t,i)=>{t[4*i+0]=e[0],t[4*i+1]=e[1],t[4*i+2]=e[2],t[4*i+3]=e[3]},MAT2:(e,t,i)=>{t[4*i+0]=e[0],t[4*i+1]=e[1],t[4*i+2]=e[2],t[4*i+3]=e[3]},MAT3:(e,t,i)=>{t[9*i+0]=e[0],t[9*i+1]=e[1],t[9*i+2]=e[2],t[9*i+3]=e[3],t[9*i+4]=e[4],t[9*i+5]=e[5],t[9*i+6]=e[6],t[9*i+7]=e[7],t[9*i+8]=e[8],t[9*i+9]=e[9]},MAT4:(e,t,i)=>{t[16*i+0]=e[0],t[16*i+1]=e[1],t[16*i+2]=e[2],t[16*i+3]=e[3],t[16*i+4]=e[4],t[16*i+5]=e[5],t[16*i+6]=e[6],t[16*i+7]=e[7],t[16*i+8]=e[8],t[16*i+9]=e[9],t[16*i+10]=e[10],t[16*i+11]=e[11],t[16*i+12]=e[12],t[16*i+13]=e[13],t[16*i+14]=e[14],t[16*i+15]=e[15]}};function createTypedArrayFromAccessor(e,t,i,n){const{componentType:r}=e;assert$c(e.componentType);const o="string"==typeof r?GLType.fromName(r):r,s=COMPONENTS_PER_ATTRIBUTE[e.type],a=UNPACKER[e.type],l=PACKER[e.type];return{values:GLType.createTypedArray(o,t,i+=e.byteOffset,s*n),type:o,size:s,unpacker:a,packer:l}}const defined$1=e=>void 0!==e;function initializeHierarchy(e,t,i){if(!t)return null;let n=e.getExtension("3DTILES_batch_table_hierarchy");const r=t.HIERARCHY;return r&&(t.extensions=t.extensions||{},t.extensions["3DTILES_batch_table_hierarchy"]=r,n=r),n?initializeHierarchyValues(n,i):null}function initializeHierarchyValues(e,t){let i,n,r;const o=e.instancesLength,s=e.classes;let a,l=e.classIds,c=e.parentCounts,u=e.parentIds,h=o;if(defined$1(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,r=getBinaryAccessor(l),l=r.createArrayBufferView(t.buffer,t.byteOffset+l.byteOffset,o)),defined$1(c))for(defined$1(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,r=getBinaryAccessor(c),c=r.createArrayBufferView(t.buffer,t.byteOffset+c.byteOffset,o)),a=new Uint16Array(o),h=0,i=0;i<o;++i)a[i]=h,h+=c[i];defined$1(u)&&defined$1(u.byteOffset)&&(u.componentType=defaultValue(u.componentType,GL.UNSIGNED_SHORT),u.type=AttributeType.SCALAR,r=getBinaryAccessor(u),u=r.createArrayBufferView(t.buffer,t.byteOffset+u.byteOffset,h));const d=s.length;for(i=0;i<d;++i){const e=s[i].instances,n=getBinaryProperties(s[i].length,e,t);s[i].instances=combine(n,e)}const p=new Array(d).fill(0),f=new Uint16Array(o);for(i=0;i<o;++i)n=l[i],f[i]=p[n],++p[n];const m={classes:s,classIds:l,classIndexes:f,parentCounts:c,parentIndexes:a,parentIds:u};return validateHierarchy(m),m}function traverseHierarchy(e,t,i){if(!e)return;const n=e.parentCounts;return e.parentIds?i(e,t):n>0?traverseHierarchyMultipleParents(e,t,i):traverseHierarchySingleParent(e,t,i)}function traverseHierarchyMultipleParents(e,t,i){const n=e.parentCounts,r=e.parentIds,o=e.parentIndexes,s=scratchVisited;s.length=Math.max(s.length,e.classIds.length);const a=++marker,l=scratchStack;for(l.length=0,l.push(t);l.length>0;){if(s[t=l.pop()]===a)continue;s[t]=a;const c=i(e,t);if(defined$1(c))return c;const u=n[t],h=o[t];for(let e=0;e<u;++e){const i=r[h+e];i!==t&&l.push(i)}}return null}function traverseHierarchySingleParent(e,t,i){let n=!0;for(;n;){const r=i(e,t);if(defined$1(r))return r;const o=e.parentIds[t];n=o!==t,t=o}throw new Error("traverseHierarchySingleParent")}function validateHierarchy(e){const t=e.classIds.length;for(let i=0;i<t;++i)validateInstance(e,i,stack)}function validateInstance(e,t,i){const n=e.parentCounts,r=e.parentIds,o=e.parentIndexes,s=e.classIds.length;if(!defined$1(r))return;assert(t<s,"Parent index ".concat(t," exceeds the total number of instances: ").concat(s)),assert(-1===i.indexOf(t),"Circular dependency detected in the batch table hierarchy."),i.push(t);const a=defined$1(n)?n[t]:1,l=defined$1(n)?o[t]:t;for(let n=0;n<a;++n){const o=r[l+n];o!==t&&validateInstance(e,o,i)}i.pop(t)}function defined(e){return null!=e}const clone=(e,t)=>e,IGNORED_PROPERTY_FIELDS={HIERARCHY:!0,extensions:!0,extras:!0};class Tile3DBatchTableParser{constructor(e,t,i){var n;let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};_defineProperty(this,"json",void 0),_defineProperty(this,"binary",void 0),_defineProperty(this,"featureCount",void 0),_defineProperty(this,"_extensions",void 0),_defineProperty(this,"_properties",void 0),_defineProperty(this,"_binaryProperties",void 0),_defineProperty(this,"_hierarchy",void 0),assert$c(i>=0),this.json=e||{},this.binary=t,this.featureCount=i,this._extensions=(null===(n=this.json)||void 0===n?void 0:n.extensions)||{},this._properties={};for(const e in this.json)IGNORED_PROPERTY_FIELDS[e]||(this._properties[e]=this.json[e]);this._binaryProperties=this._initializeBinaryProperties(),r["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=initializeHierarchy(this,this.json,this.binary))}getExtension(e){return this.json&&this.json.extensions&&this.json.extensions[e]}memorySizeInBytes(){return 0}isClass(e,t){if(this._checkBatchId(e),assert$c("string"==typeof t,t),this._hierarchy){return defined(traverseHierarchy(this._hierarchy,e,((e,i)=>e.classes[e.classIds[i]].name===t)))}return!1}isExactClass(e,t){return assert$c("string"==typeof t,t),this.getExactClassName(e)===t}getExactClassName(e){if(this._checkBatchId(e),this._hierarchy){return this._hierarchy.classes[this._hierarchy.classIds[e]].name}}hasProperty(e,t){return this._checkBatchId(e),assert$c("string"==typeof t,t),defined(this._properties[t])||this._hasPropertyInHierarchy(e,t)}getPropertyNames(e,t){this._checkBatchId(e),(t=defined(t)?t:[]).length=0;const i=Object.keys(this._properties);return t.push(...i),this._hierarchy&&this._getPropertyNamesInHierarchy(e,t),t}getProperty(e,t){if(this._checkBatchId(e),assert$c("string"==typeof t,t),this._binaryProperties){const i=this._binaryProperties[t];if(defined(i))return this._getBinaryProperty(i,e)}const i=this._properties[t];if(defined(i))return clone(i[e]);if(this._hierarchy){const i=this._getHierarchyProperty(e,t);if(defined(i))return i}}setProperty(e,t,i){const n=this.featureCount;if(this._checkBatchId(e),assert$c("string"==typeof t,t),this._binaryProperties){const n=this._binaryProperties[t];if(n)return void this._setBinaryProperty(n,e,i)}if(this._hierarchy&&this._setHierarchyProperty(this,e,t,i))return;let r=this._properties[t];defined(r)||(this._properties[t]=new Array(n),r=this._properties[t]),r[e]=clone(i)}_checkBatchId(e){if(!(e>=0&&e<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(e,t){return e.unpack(e.typedArray,t)}_setBinaryProperty(e,t,i){e.pack(i,e.typedArray,t)}_initializeBinaryProperties(){let e=null;for(const t in this._properties){const i=this._initializeBinaryProperty(t,this._properties[t]);i&&(e=e||{},e[t]=i)}return e}_initializeBinaryProperty(e,t){if("byteOffset"in t){const i=t;assert$c(this.binary,"Property ".concat(e," requires a batch table binary.")),assert$c(i.type,"Property ".concat(e," requires a type."));const n=createTypedArrayFromAccessor(i,this.binary.buffer,0|this.binary.byteOffset,this.featureCount);return{typedArray:n.values,componentCount:n.size,unpack:n.unpacker,pack:n.packer}}return null}_hasPropertyInHierarchy(e,t){if(!this._hierarchy)return!1;const i=traverseHierarchy(this._hierarchy,e,((e,i)=>defined(e.classes[e.classIds[i]].instances[t])));return defined(i)}_getPropertyNamesInHierarchy(e,t){traverseHierarchy(this._hierarchy,e,((e,i)=>{const n=e.classes[e.classIds[i]].instances;for(const e in n)n.hasOwnProperty(e)&&-1===t.indexOf(e)&&t.push(e)}))}_getHierarchyProperty(e,t){return traverseHierarchy(this._hierarchy,e,((e,i)=>{const n=e.classIndexes[i],r=e.classes[e.classIds[i]].instances[t];return defined(r)?defined(r.typedArray)?this._getBinaryProperty(r,n):clone(r[n]):null}))}_setHierarchyProperty(e,t,i,n){const r=traverseHierarchy(this._hierarchy,t,((e,r)=>{const o=e.classIndexes[r],s=e.classes[e.classIds[r]].instances[i];return!!defined(s)&&(assert$c(r===t,'Inherited property "'.concat(i,'" is read-only.')),defined(s.typedArray)?this._setBinaryProperty(s,o,n):s[o]=clone(n),!0)}));return defined(r)}}const SIZEOF_UINT32$1=4;function parse3DTileHeaderSync(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=new DataView(t);if(e.magic=n.getUint32(i,!0),i+=SIZEOF_UINT32$1,e.version=n.getUint32(i,!0),i+=SIZEOF_UINT32$1,e.byteLength=n.getUint32(i,!0),i+=SIZEOF_UINT32$1,1!==e.version)throw new Error("3D Tile Version ".concat(e.version," not supported"));return i}const SIZEOF_UINT32=4;function parse3DTileTablesHeaderSync(e,t,i){const n=new DataView(t);let r;e.header=e.header||{};let o=n.getUint32(i,!0),s=n.getUint32(i+=SIZEOF_UINT32,!0),a=n.getUint32(i+=SIZEOF_UINT32,!0),l=n.getUint32(i+=SIZEOF_UINT32,!0);return i+=SIZEOF_UINT32,a>=570425344?(i-=2*SIZEOF_UINT32,r=o,a=s,l=0,o=0,s=0):l>=570425344&&(i-=SIZEOF_UINT32,r=a,a=o,l=s,o=0,s=0),e.header.featureTableJsonByteLength=o,e.header.featureTableBinaryByteLength=s,e.header.batchTableJsonByteLength=a,e.header.batchTableBinaryByteLength=l,e.header.batchLength=r,i}function parse3DTileTablesSync(e,t,i,n){return i=parse3DTileBatchTable(e,t,i=parse3DTileFeatureTable(e,t,i))}function parse3DTileFeatureTable(e,t,i,n){const{featureTableJsonByteLength:r,featureTableBinaryByteLength:o,batchLength:s}=e.header;if(e.featureTableJson={BATCH_LENGTH:s||0},r>0){const n=getStringFromArrayBuffer(t,i,r);e.featureTableJson=JSON.parse(n)}return i+=r,e.featureTableBinary=new Uint8Array(t,i,o),i+=o}function parse3DTileBatchTable(e,t,i,n){const{batchTableJsonByteLength:r,batchTableBinaryByteLength:o}=e.header;if(r>0){const n=getStringFromArrayBuffer(t,i,r);e.batchTableJson=JSON.parse(n),i+=r,o>0&&(e.batchTableBinary=new Uint8Array(t,i,o),e.batchTableBinary=new Uint8Array(e.batchTableBinary),i+=o)}return i}function normalize3DTileColorAttribute(e,t,i){if(!(t||e&&e.batchIds&&i))return null;const{batchIds:n,isRGB565:r,pointCount:o}=e;if(n&&i){const e=new Uint8ClampedArray(3*o);for(let t=0;t<o;t++){const r=i.getProperty(n[t],"dimensions").map((e=>255*e));e[3*t]=r[0],e[3*t+1]=r[1],e[3*t+2]=r[2]}return{type:GL$1.UNSIGNED_BYTE,value:e,size:3,normalized:!0}}if(r){const e=new Uint8ClampedArray(3*o);for(let i=0;i<o;i++){const n=decodeRGB565(t[i]);e[3*i]=n[0],e[3*i+1]=n[1],e[3*i+2]=n[2]}return{type:GL$1.UNSIGNED_BYTE,value:e,size:3,normalized:!0}}return t&&t.length===3*o?{type:GL$1.UNSIGNED_BYTE,value:t,size:3,normalized:!0}:{type:GL$1.UNSIGNED_BYTE,value:t,size:4,normalized:!0}}const scratchNormal=new Vector3$1;function normalize3DTileNormalAttribute(e,t){if(!t)return null;if(e.isOctEncoded16P){const i=new Float32Array(3*e.pointsLength);for(let n=0;n<e.pointsLength;n++)octDecode(t[2*n],t[2*n+1],scratchNormal),scratchNormal.toArray(i,3*n);return{type:GL$1.FLOAT,size:2,value:i}}return{type:GL$1.FLOAT,size:2,value:t}}function normalize3DTilePositionAttribute(e,t,i){return e.isQuantized?i["3d-tiles"]&&i["3d-tiles"].decodeQuantizedPositions?(e.isQuantized=!1,decodeQuantizedPositions(e,t)):{type:GL$1.UNSIGNED_SHORT,value:t,size:3,normalized:!0}:t}function decodeQuantizedPositions(e,t){const i=new Vector3$1,n=new Float32Array(3*e.pointCount);for(let r=0;r<e.pointCount;r++)i.set(t[3*r],t[3*r+1],t[3*r+2]).scale(1/e.quantizedRange).multiply(e.quantizedVolumeScale).add(e.quantizedVolumeOffset).toArray(n,3*r);return n}async function parsePointCloud3DTile(e,t,i,n,r){i=parse3DTileTablesSync(e,t,i=parse3DTileTablesHeaderSync(e,t,i=parse3DTileHeaderSync(e,t,i))),initializeTile(e);const{featureTable:o,batchTable:s}=parsePointCloudTables(e);return await parseDraco(e,o,s,n,r),parsePositions(e,o,n),parseColors(e,o,s),parseNormals(e,o),i}function initializeTile(e){e.attributes={positions:null,colors:null,normals:null,batchIds:null},e.isQuantized=!1,e.isTranslucent=!1,e.isRGB565=!1,e.isOctEncoded16P=!1}function parsePointCloudTables(e){const t=new Tile3DFeatureTable(e.featureTableJson,e.featureTableBinary),i=t.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(i))throw new Error("POINTS_LENGTH must be defined");t.featuresLength=i,e.featuresLength=i,e.pointsLength=i,e.pointCount=i,e.rtcCenter=t.getGlobalProperty("RTC_CENTER",GL$1.FLOAT,3);return{featureTable:t,batchTable:parseBatchIds(e,t)}}function parsePositions(e,t,i){if(!e.attributes.positions)if(t.hasProperty("POSITION"))e.attributes.positions=t.getPropertyArray("POSITION",GL$1.FLOAT,3);else if(t.hasProperty("POSITION_QUANTIZED")){const n=t.getPropertyArray("POSITION_QUANTIZED",GL$1.UNSIGNED_SHORT,3);if(e.isQuantized=!0,e.quantizedRange=65535,e.quantizedVolumeScale=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",GL$1.FLOAT,3),!e.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(e.quantizedVolumeOffset=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",GL$1.FLOAT,3),!e.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");e.attributes.positions=normalize3DTilePositionAttribute(e,n,i)}if(!e.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}function parseColors(e,t,i){if(!e.attributes.colors){let n=null;t.hasProperty("RGBA")?(n=t.getPropertyArray("RGBA",GL$1.UNSIGNED_BYTE,4),e.isTranslucent=!0):t.hasProperty("RGB")?n=t.getPropertyArray("RGB",GL$1.UNSIGNED_BYTE,3):t.hasProperty("RGB565")&&(n=t.getPropertyArray("RGB565",GL$1.UNSIGNED_SHORT,1),e.isRGB565=!0),e.attributes.colors=normalize3DTileColorAttribute(e,n,i)}t.hasProperty("CONSTANT_RGBA")&&(e.constantRGBA=t.getGlobalProperty("CONSTANT_RGBA",GL$1.UNSIGNED_BYTE,4))}function parseNormals(e,t){if(!e.attributes.normals){let i=null;t.hasProperty("NORMAL")?i=t.getPropertyArray("NORMAL",GL$1.FLOAT,3):t.hasProperty("NORMAL_OCT16P")&&(i=t.getPropertyArray("NORMAL_OCT16P",GL$1.UNSIGNED_BYTE,2),e.isOctEncoded16P=!0),e.attributes.normals=normalize3DTileNormalAttribute(e,i)}}function parseBatchIds(e,t){let i=null;if(!e.batchIds&&t.hasProperty("BATCH_ID")&&(e.batchIds=t.getPropertyArray("BATCH_ID",GL$1.UNSIGNED_SHORT,1),e.batchIds)){const n=t.getGlobalProperty("BATCH_LENGTH");if(!n)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:r,batchTableBinary:o}=e;i=new Tile3DBatchTableParser(r,o,n)}return i}async function parseDraco(e,t,i,n,r){let o,s,a;const l=e.batchTableJson&&e.batchTableJson.extensions&&e.batchTableJson.extensions["3DTILES_draco_point_compression"];l&&(a=l.properties);const c=t.getExtension("3DTILES_draco_point_compression");if(c){s=c.properties;const t=c.byteOffset,i=c.byteLength;if(!s||!Number.isFinite(t)||!i)throw new Error("Draco properties, byteOffset, and byteLength must be defined");o=e.featureTableBinary.slice(t,t+i),e.hasPositions=Number.isFinite(s.POSITION),e.hasColors=Number.isFinite(s.RGB)||Number.isFinite(s.RGBA),e.hasNormals=Number.isFinite(s.NORMAL),e.hasBatchIds=Number.isFinite(s.BATCH_ID),e.isTranslucent=Number.isFinite(s.RGBA)}if(!o)return!0;const u={buffer:o,properties:{...s,...a},batchTableProperties:a};return await loadDraco(e,u,n,r)}async function loadDraco(e,t,i,n){const{parse:r}=n,o={...i,draco:{...i.draco,extraAttributes:t.batchTableProperties||{}}};delete o["3d-tiles"];const s=await r(t.buffer,DracoLoader,o),a=s.attributes.POSITION&&s.attributes.POSITION.value,l=s.attributes.COLOR_0&&s.attributes.COLOR_0.value,c=s.attributes.NORMAL&&s.attributes.NORMAL.value,u=s.attributes.BATCH_ID&&s.attributes.BATCH_ID.value,h=c&&s.attributes.NORMAL.value.quantization;if(a&&s.attributes.POSITION.value.quantization){const t=s.POSITION.data.quantization,i=t.range;e.quantizedVolumeScale=new Vector3$1(i,i,i),e.quantizedVolumeOffset=new Vector3$1(t.minValues),e.quantizedRange=(1<<t.quantizationBits)-1,e.isQuantizedDraco=!0}h&&(e.octEncodedRange=(1<<s.NORMAL.data.quantization.quantizationBits)-1,e.isOctEncodedDraco=!0);const d={};if(t.batchTableProperties)for(const e of Object.keys(t.batchTableProperties))s.attributes[e]&&s.attributes[e].value&&(d[e.toLowerCase()]=s.attributes[e].value);e.attributes={positions:a,colors:normalize3DTileColorAttribute(e,l,void 0),normals:c,batchIds:u,...d}}const GLTF_FORMAT={URI:0,EMBEDDED:1};function parse3DTileGLTFViewSync(e,t,i,n){e.rotateYtoZ=!0;const r=e.byteOffset+e.byteLength-i;if(0===r)throw new Error("glTF byte length must be greater than 0.");return e.gltfUpAxis=n["3d-tiles"]&&n["3d-tiles"].assetGltfUpAxis?n["3d-tiles"].assetGltfUpAxis:"Y",e.gltfArrayBuffer=sliceArrayBuffer(t,i,r),e.gltfByteOffset=0,e.gltfByteLength=r,e.byteOffset+e.byteLength}async function extractGLTF(e,t,i,n){const r=i["3d-tiles"]||{};if(extractGLTFBufferOrURL(e,t),r.loadGLTF){const{parse:t,fetch:r}=n;e.gltfUrl&&(e.gltfArrayBuffer=await r(e.gltfUrl,i),e.gltfByteOffset=0),e.gltfArrayBuffer&&(e.gltf=await t(e.gltfArrayBuffer,GLTFLoader$1,i,n),e.gpuMemoryUsageInBytes=getMemoryUsageGLTF(e.gltf),delete e.gltfArrayBuffer,delete e.gltfByteOffset,delete e.gltfByteLength)}}function extractGLTFBufferOrURL(e,t,i){switch(t){case GLTF_FORMAT.URI:const t=new Uint8Array(e.gltfArrayBuffer,e.gltfByteOffset),i=(new TextDecoder).decode(t);e.gltfUrl=i.replace(/[\s\0]+$/,""),delete e.gltfArrayBuffer,delete e.gltfByteOffset,delete e.gltfByteLength;break;case GLTF_FORMAT.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}async function parseBatchedModel3DTile(e,t,i,n,r){var o;i=parseBatchedModel(e,t,i,n),await extractGLTF(e,GLTF_FORMAT.EMBEDDED,n,r);const s=null==e||null===(o=e.gltf)||void 0===o?void 0:o.extensions;return s&&s.CESIUM_RTC&&(e.rtcCenter=s.CESIUM_RTC.center),i}function parseBatchedModel(e,t,i,n,r){i=parse3DTileGLTFViewSync(e,t,i=parse3DTileTablesSync(e,t,i=parse3DTileTablesHeaderSync(e,t,i=parse3DTileHeaderSync(e,t,i))),n);const o=new Tile3DFeatureTable(e.featureTableJson,e.featureTableBinary);return e.rtcCenter=o.getGlobalProperty("RTC_CENTER",GL$1.FLOAT,3),i}async function parseInstancedModel3DTile(e,t,i,n,r){return i=parseInstancedModel(e,t,i,n),await extractGLTF(e,e.gltfFormat,n,r),i}function parseInstancedModel(e,t,i,n,r){if(i=parse3DTileHeaderSync(e,t,i),1!==e.version)throw new Error("Instanced 3D Model version ".concat(e.version," is not supported"));i=parse3DTileTablesHeaderSync(e,t,i);const o=new DataView(t);if(e.gltfFormat=o.getUint32(i,!0),i=parse3DTileGLTFViewSync(e,t,i=parse3DTileTablesSync(e,t,i+=4),n),0===e.featureTableJsonByteLength)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const s=new Tile3DFeatureTable(e.featureTableJson,e.featureTableBinary),a=s.getGlobalProperty("INSTANCES_LENGTH");if(s.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");e.eastNorthUp=s.getGlobalProperty("EAST_NORTH_UP"),e.rtcCenter=s.getGlobalProperty("RTC_CENTER",GL$1.FLOAT,3);return extractInstancedAttributes(e,s,new Tile3DBatchTableParser(e.batchTableJson,e.batchTableBinary,a),a),i}function extractInstancedAttributes(e,t,i,n){const r={instances:new Array(n),batchTable:e._batchTable}.instances,o=new Vector3$1;new Vector3$1,new Vector3$1,new Vector3$1;const s=new Matrix3$1,a=new Quaternion$1,l=new Vector3$1,c={},u=new Matrix4$1,h=[],d=[],p=new Vector3$1,f=new Vector3$1;for(let i=0;i<n;i++){let n;if(t.hasProperty("POSITION"))n=t.getProperty("POSITION",GL$1.FLOAT,3,i,o);else if(t.hasProperty("POSITION_QUANTIZED")){n=t.getProperty("POSITION_QUANTIZED",GL$1.UNSIGNED_SHORT,3,i,o);const e=t.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",GL$1.FLOAT,3,p);if(!e)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const r=t.getGlobalProperty("QUANTIZED_VOLUME_SCALE",GL$1.FLOAT,3,f);if(!r)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const s=65535;for(let t=0;t<3;t++)n[t]=n[t]/s*r[t]+e[t]}if(!n)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(o.copy(n),c.translation=o,e.normalUp=t.getProperty("NORMAL_UP",GL$1.FLOAT,3,i,h),e.normalRight=t.getProperty("NORMAL_RIGHT",GL$1.FLOAT,3,i,d),e.normalUp){if(!e.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");e.hasCustomOrientation=!0}else{if(e.octNormalUp=t.getProperty("NORMAL_UP_OCT32P",GL$1.UNSIGNED_SHORT,2,h),e.octNormalRight=t.getProperty("NORMAL_RIGHT_OCT32P",GL$1.UNSIGNED_SHORT,2,d),e.octNormalUp){if(!e.octNormalRight)throw new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");throw new Error("i3dm: oct-encoded orientation not implemented")}e.eastNorthUp?(Ellipsoid.WGS84.eastNorthUpToFixedFrame(o,u),u.getRotationMatrix3(s)):s.identity()}a.fromMatrix3(s),c.rotation=a,l.set(1,1,1);const m=t.getProperty("SCALE",GL$1.FLOAT,1,i);Number.isFinite(m)&&l.multiplyByScalar(m);const g=t.getProperty("SCALE_NON_UNIFORM",GL$1.FLOAT,3,i,h);g&&l.scale(g),c.scale=l;let _=t.getProperty("BATCH_ID",GL$1.UNSIGNED_SHORT,1,i);void 0===_&&(_=i);const y=(new Matrix4$1).fromQuaternion(c.rotation);u.identity(),u.translate(c.translation),u.multiplyRight(y),u.scale(c.scale);const v=u.clone();r[i]={modelMatrix:v,batchId:_}}e.instances=r}async function parseComposite3DTile(e,t,i,n,r,o){i=parse3DTileHeaderSync(e,t,i);const s=new DataView(t);for(e.tilesLength=s.getUint32(i,!0),i+=4,e.tiles=[];e.tiles.length<e.tilesLength&&e.byteLength-i>12;){const s={};e.tiles.push(s),i=await o(t,i,n,r,s)}return i}async function parseGltf3DTile(e,t,i,n){e.rotateYtoZ=!0,e.gltfUpAxis=i["3d-tiles"]&&i["3d-tiles"].assetGltfUpAxis?i["3d-tiles"].assetGltfUpAxis:"Y";const{parse:r}=n;e.gltf=await r(t,GLTFLoader$1,i,n),e.gpuMemoryUsageInBytes=getMemoryUsageGLTF(e.gltf)}async function parse3DTile(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};switch(r.byteOffset=t,r.type=getMagicString(e,t),r.type){case TILE3D_TYPE.COMPOSITE:return await parseComposite3DTile(r,e,t,i,n,parse3DTile);case TILE3D_TYPE.BATCHED_3D_MODEL:return await parseBatchedModel3DTile(r,e,t,i,n);case TILE3D_TYPE.GLTF:return await parseGltf3DTile(r,e,i,n);case TILE3D_TYPE.INSTANCED_3D_MODEL:return await parseInstancedModel3DTile(r,e,t,i,n);case TILE3D_TYPE.POINT_CLOUD:return await parsePointCloud3DTile(r,e,t,i,n);default:throw new Error("3DTileLoader: unknown type ".concat(r.type))}}const SUBTREE_FILE_MAGIC=1952609651,SUBTREE_FILE_VERSION=1;async function parse3DTilesSubtree(e,t,i){if(new Uint32Array(e.slice(0,4))[0]!==SUBTREE_FILE_MAGIC)throw new Error("Wrong subtree file magic number");if(new Uint32Array(e.slice(4,8))[0]!==SUBTREE_FILE_VERSION)throw new Error("Wrong subtree file verson, must be 1");const n=parseUint64Value(e.slice(8,16)),r=new Uint8Array(e,24,n),o=new TextDecoder("utf8").decode(r),s=JSON.parse(o),a=parseUint64Value(e.slice(16,24));let l=new ArrayBuffer(0);return a&&(l=e.slice(24+n)),"bufferView"in s.tileAvailability&&(s.tileAvailability.explicitBitstream=await getExplicitBitstream(s,"tileAvailability",l,i)),"bufferView"in s.contentAvailability&&(s.contentAvailability.explicitBitstream=await getExplicitBitstream(s,"contentAvailability",l,i)),"bufferView"in s.childSubtreeAvailability&&(s.childSubtreeAvailability.explicitBitstream=await getExplicitBitstream(s,"childSubtreeAvailability",l,i)),s}function resolveBufferUri(e,t){if(t.startsWith("http")){const i=new URL(e,t);return decodeURI(i.toString())}const i="http://".concat(t),n=new URL(e,i);return"/".concat(n.host).concat(n.pathname)}async function getExplicitBitstream(e,t,i,n){const r=e.bufferViews[e[t].bufferView],o=e.buffers[r.buffer];if(null==n||!n.url||!n.fetch)throw new Error("Url is not provided");if(!n.fetch)throw new Error("fetch is not provided");if(o.uri){const e=resolveBufferUri(o.uri,null==n?void 0:n.url),t=await n.fetch(e),i=await t.arrayBuffer();return new Uint8Array(i,r.byteOffset,r.byteLength)}return new Uint8Array(i,r.byteOffset,r.byteLength)}function parseUint64Value(e){const t=new DataView(e);return t.getUint32(0,!0)+2**32*t.getUint32(4,!0)}const Tile3DSubtreeLoader={id:"3d-tiles-subtree",name:"3D Tiles Subtree",module:"3d-tiles",version:VERSION,extensions:["subtree"],mimeTypes:["application/octet-stream"],tests:["subtree"],parse:parse3DTilesSubtree,options:{}};
/**
 * @license
 * Copyright 2009 The Closure Library Authors
 * Copyright 2020 Daniel Wirtz / The long.js Authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */var wasm=null;try{wasm=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(e){}function Long(e,t,i){this.low=0|e,this.high=0|t,this.unsigned=!!i}function isLong(e){return!0===(e&&e.__isLong__)}function ctz32(e){var t=Math.clz32(e&-e);return e?31-t:t}Object.defineProperty(Long.prototype,"__isLong__",{value:!0}),Long.isLong=isLong;var INT_CACHE={},UINT_CACHE={};function fromInt(e,t){var i,n,r;return t?(r=0<=(e>>>=0)&&e<256)&&(n=UINT_CACHE[e])?n:(i=fromBits(e,0,!0),r&&(UINT_CACHE[e]=i),i):(r=-128<=(e|=0)&&e<128)&&(n=INT_CACHE[e])?n:(i=fromBits(e,e<0?-1:0,!1),r&&(INT_CACHE[e]=i),i)}function fromNumber(e,t){if(isNaN(e))return t?UZERO:ZERO;if(t){if(e<0)return UZERO;if(e>=TWO_PWR_64_DBL)return MAX_UNSIGNED_VALUE}else{if(e<=-TWO_PWR_63_DBL)return MIN_VALUE;if(e+1>=TWO_PWR_63_DBL)return MAX_VALUE}return e<0?fromNumber(-e,t).neg():fromBits(e%TWO_PWR_32_DBL|0,e/TWO_PWR_32_DBL|0,t)}function fromBits(e,t,i){return new Long(e,t,i)}Long.fromInt=fromInt,Long.fromNumber=fromNumber,Long.fromBits=fromBits;var pow_dbl=Math.pow;function fromString(e,t,i){if(0===e.length)throw Error("empty string");if("number"==typeof t?(i=t,t=!1):t=!!t,"NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return t?UZERO:ZERO;if((i=i||10)<2||36<i)throw RangeError("radix");var n;if((n=e.indexOf("-"))>0)throw Error("interior hyphen");if(0===n)return fromString(e.substring(1),t,i).neg();for(var r=fromNumber(pow_dbl(i,8)),o=ZERO,s=0;s<e.length;s+=8){var a=Math.min(8,e.length-s),l=parseInt(e.substring(s,s+a),i);if(a<8){var c=fromNumber(pow_dbl(i,a));o=o.mul(c).add(fromNumber(l))}else o=(o=o.mul(r)).add(fromNumber(l))}return o.unsigned=t,o}function fromValue(e,t){return"number"==typeof e?fromNumber(e,t):"string"==typeof e?fromString(e,t):fromBits(e.low,e.high,"boolean"==typeof t?t:e.unsigned)}Long.fromString=fromString,Long.fromValue=fromValue;var TWO_PWR_16_DBL=65536,TWO_PWR_24_DBL=1<<24,TWO_PWR_32_DBL=TWO_PWR_16_DBL*TWO_PWR_16_DBL,TWO_PWR_64_DBL=TWO_PWR_32_DBL*TWO_PWR_32_DBL,TWO_PWR_63_DBL=TWO_PWR_64_DBL/2,TWO_PWR_24=fromInt(TWO_PWR_24_DBL),ZERO=fromInt(0);Long.ZERO=ZERO;var UZERO=fromInt(0,!0);Long.UZERO=UZERO;var ONE=fromInt(1);Long.ONE=ONE;var UONE=fromInt(1,!0);Long.UONE=UONE;var NEG_ONE=fromInt(-1);Long.NEG_ONE=NEG_ONE;var MAX_VALUE=fromBits(-1,2147483647,!1);Long.MAX_VALUE=MAX_VALUE;var MAX_UNSIGNED_VALUE=fromBits(-1,-1,!0);Long.MAX_UNSIGNED_VALUE=MAX_UNSIGNED_VALUE;var MIN_VALUE=fromBits(0,-2147483648,!1);Long.MIN_VALUE=MIN_VALUE;var LongPrototype=Long.prototype;LongPrototype.toInt=function(){return this.unsigned?this.low>>>0:this.low},LongPrototype.toNumber=function(){return this.unsigned?(this.high>>>0)*TWO_PWR_32_DBL+(this.low>>>0):this.high*TWO_PWR_32_DBL+(this.low>>>0)},LongPrototype.toString=function(e){if((e=e||10)<2||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(MIN_VALUE)){var t=fromNumber(e),i=this.div(t),n=i.mul(t).sub(this);return i.toString(e)+n.toInt().toString(e)}return"-"+this.neg().toString(e)}for(var r=fromNumber(pow_dbl(e,6),this.unsigned),o=this,s="";;){var a=o.div(r),l=(o.sub(a.mul(r)).toInt()>>>0).toString(e);if((o=a).isZero())return l+s;for(;l.length<6;)l="0"+l;s=""+l+s}},LongPrototype.getHighBits=function(){return this.high},LongPrototype.getHighBitsUnsigned=function(){return this.high>>>0},LongPrototype.getLowBits=function(){return this.low},LongPrototype.getLowBitsUnsigned=function(){return this.low>>>0},LongPrototype.getNumBitsAbs=function(){if(this.isNegative())return this.eq(MIN_VALUE)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,t=31;t>0&&!(e&1<<t);t--);return 0!=this.high?t+33:t+1},LongPrototype.isZero=function(){return 0===this.high&&0===this.low},LongPrototype.eqz=LongPrototype.isZero,LongPrototype.isNegative=function(){return!this.unsigned&&this.high<0},LongPrototype.isPositive=function(){return this.unsigned||this.high>=0},LongPrototype.isOdd=function(){return!(1&~this.low)},LongPrototype.isEven=function(){return!(1&this.low)},LongPrototype.equals=function(e){return isLong(e)||(e=fromValue(e)),(this.unsigned===e.unsigned||this.high>>>31!=1||e.high>>>31!=1)&&(this.high===e.high&&this.low===e.low)},LongPrototype.eq=LongPrototype.equals,LongPrototype.notEquals=function(e){return!this.eq(e)},LongPrototype.neq=LongPrototype.notEquals,LongPrototype.ne=LongPrototype.notEquals,LongPrototype.lessThan=function(e){return this.comp(e)<0},LongPrototype.lt=LongPrototype.lessThan,LongPrototype.lessThanOrEqual=function(e){return this.comp(e)<=0},LongPrototype.lte=LongPrototype.lessThanOrEqual,LongPrototype.le=LongPrototype.lessThanOrEqual,LongPrototype.greaterThan=function(e){return this.comp(e)>0},LongPrototype.gt=LongPrototype.greaterThan,LongPrototype.greaterThanOrEqual=function(e){return this.comp(e)>=0},LongPrototype.gte=LongPrototype.greaterThanOrEqual,LongPrototype.ge=LongPrototype.greaterThanOrEqual,LongPrototype.compare=function(e){if(isLong(e)||(e=fromValue(e)),this.eq(e))return 0;var t=this.isNegative(),i=e.isNegative();return t&&!i?-1:!t&&i?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},LongPrototype.comp=LongPrototype.compare,LongPrototype.negate=function(){return!this.unsigned&&this.eq(MIN_VALUE)?MIN_VALUE:this.not().add(ONE)},LongPrototype.neg=LongPrototype.negate,LongPrototype.add=function(e){isLong(e)||(e=fromValue(e));var t=0,i=0,n=0,r=0;return n+=(r+=(65535&this.low)+(65535&e.low))>>>16,i+=(n+=(this.low>>>16)+(e.low>>>16))>>>16,t+=(i+=(65535&this.high)+(65535&e.high))>>>16,t+=(this.high>>>16)+(e.high>>>16),fromBits((n&=65535)<<16|(r&=65535),(t&=65535)<<16|(i&=65535),this.unsigned)},LongPrototype.subtract=function(e){return isLong(e)||(e=fromValue(e)),this.add(e.neg())},LongPrototype.sub=LongPrototype.subtract,LongPrototype.multiply=function(e){if(this.isZero())return this;if(isLong(e)||(e=fromValue(e)),wasm)return fromBits(wasm.mul(this.low,this.high,e.low,e.high),wasm.get_high(),this.unsigned);if(e.isZero())return this.unsigned?UZERO:ZERO;if(this.eq(MIN_VALUE))return e.isOdd()?MIN_VALUE:ZERO;if(e.eq(MIN_VALUE))return this.isOdd()?MIN_VALUE:ZERO;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(TWO_PWR_24)&&e.lt(TWO_PWR_24))return fromNumber(this.toNumber()*e.toNumber(),this.unsigned);var t=65535&this.high,i=this.low>>>16,n=65535&this.low,r=65535&e.high,o=e.low>>>16,s=65535&e.low,a=0,l=0,c=0,u=0;return c+=(u+=n*s)>>>16,l+=(c+=i*s)>>>16,c&=65535,l+=(c+=n*o)>>>16,a+=(l+=t*s)>>>16,l&=65535,a+=(l+=i*o)>>>16,l&=65535,a+=(l+=n*r)>>>16,a+=(this.high>>>16)*s+t*o+i*r+n*(e.high>>>16),fromBits((c&=65535)<<16|(u&=65535),(a&=65535)<<16|(l&=65535),this.unsigned)},LongPrototype.mul=LongPrototype.multiply,LongPrototype.divide=function(e){if(isLong(e)||(e=fromValue(e)),e.isZero())throw Error("division by zero");var t,i,n;if(wasm)return this.unsigned||-2147483648!==this.high||-1!==e.low||-1!==e.high?fromBits((this.unsigned?wasm.div_u:wasm.div_s)(this.low,this.high,e.low,e.high),wasm.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?UZERO:ZERO;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return UZERO;if(e.gt(this.shru(1)))return UONE;n=UZERO}else{if(this.eq(MIN_VALUE))return e.eq(ONE)||e.eq(NEG_ONE)?MIN_VALUE:e.eq(MIN_VALUE)?ONE:(t=this.shr(1).div(e).shl(1)).eq(ZERO)?e.isNegative()?ONE:NEG_ONE:(i=this.sub(e.mul(t)),n=t.add(i.div(e)));if(e.eq(MIN_VALUE))return this.unsigned?UZERO:ZERO;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();n=ZERO}for(i=this;i.gte(e);){t=Math.max(1,Math.floor(i.toNumber()/e.toNumber()));for(var r=Math.ceil(Math.log(t)/Math.LN2),o=r<=48?1:pow_dbl(2,r-48),s=fromNumber(t),a=s.mul(e);a.isNegative()||a.gt(i);)a=(s=fromNumber(t-=o,this.unsigned)).mul(e);s.isZero()&&(s=ONE),n=n.add(s),i=i.sub(a)}return n},LongPrototype.div=LongPrototype.divide,LongPrototype.modulo=function(e){return isLong(e)||(e=fromValue(e)),wasm?fromBits((this.unsigned?wasm.rem_u:wasm.rem_s)(this.low,this.high,e.low,e.high),wasm.get_high(),this.unsigned):this.sub(this.div(e).mul(e))},LongPrototype.mod=LongPrototype.modulo,LongPrototype.rem=LongPrototype.modulo,LongPrototype.not=function(){return fromBits(~this.low,~this.high,this.unsigned)},LongPrototype.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32},LongPrototype.clz=LongPrototype.countLeadingZeros,LongPrototype.countTrailingZeros=function(){return this.low?ctz32(this.low):ctz32(this.high)+32},LongPrototype.ctz=LongPrototype.countTrailingZeros,LongPrototype.and=function(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low&e.low,this.high&e.high,this.unsigned)},LongPrototype.or=function(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low|e.low,this.high|e.high,this.unsigned)},LongPrototype.xor=function(e){return isLong(e)||(e=fromValue(e)),fromBits(this.low^e.low,this.high^e.high,this.unsigned)},LongPrototype.shiftLeft=function(e){return isLong(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?fromBits(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):fromBits(0,this.low<<e-32,this.unsigned)},LongPrototype.shl=LongPrototype.shiftLeft,LongPrototype.shiftRight=function(e){return isLong(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?fromBits(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):fromBits(this.high>>e-32,this.high>=0?0:-1,this.unsigned)},LongPrototype.shr=LongPrototype.shiftRight,LongPrototype.shiftRightUnsigned=function(e){return isLong(e)&&(e=e.toInt()),0==(e&=63)?this:e<32?fromBits(this.low>>>e|this.high<<32-e,this.high>>>e,this.unsigned):fromBits(32===e?this.high:this.high>>>e-32,0,this.unsigned)},LongPrototype.shru=LongPrototype.shiftRightUnsigned,LongPrototype.shr_u=LongPrototype.shiftRightUnsigned,LongPrototype.rotateLeft=function(e){var t;return isLong(e)&&(e=e.toInt()),0==(e&=63)?this:32===e?fromBits(this.high,this.low,this.unsigned):e<32?fromBits(this.low<<e|this.high>>>(t=32-e),this.high<<e|this.low>>>t,this.unsigned):fromBits(this.high<<(e-=32)|this.low>>>(t=32-e),this.low<<e|this.high>>>t,this.unsigned)},LongPrototype.rotl=LongPrototype.rotateLeft,LongPrototype.rotateRight=function(e){var t;return isLong(e)&&(e=e.toInt()),0==(e&=63)?this:32===e?fromBits(this.high,this.low,this.unsigned):e<32?fromBits(this.high<<(t=32-e)|this.low>>>e,this.low<<t|this.high>>>e,this.unsigned):fromBits(this.low<<(t=32-(e-=32))|this.high>>>e,this.high<<t|this.low>>>e,this.unsigned)},LongPrototype.rotr=LongPrototype.rotateRight,LongPrototype.toSigned=function(){return this.unsigned?fromBits(this.low,this.high,!1):this},LongPrototype.toUnsigned=function(){return this.unsigned?this:fromBits(this.low,this.high,!0)},LongPrototype.toBytes=function(e){return e?this.toBytesLE():this.toBytesBE()},LongPrototype.toBytesLE=function(){var e=this.high,t=this.low;return[255&t,t>>>8&255,t>>>16&255,t>>>24,255&e,e>>>8&255,e>>>16&255,e>>>24]},LongPrototype.toBytesBE=function(){var e=this.high,t=this.low;return[e>>>24,e>>>16&255,e>>>8&255,255&e,t>>>24,t>>>16&255,t>>>8&255,255&t]},Long.fromBytes=function(e,t,i){return i?Long.fromBytesLE(e,t):Long.fromBytesBE(e,t)},Long.fromBytesLE=function(e,t){return new Long(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,t)},Long.fromBytesBE=function(e,t){return new Long(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],t)};const MAXIMUM_TOKEN_LENGTH=16;function getS2CellIdFromToken(e){"X"===e&&(e="");const t=e.padEnd(MAXIMUM_TOKEN_LENGTH,"0");return Long.fromString(t,!0,16)}function getS2TokenFromCellId(e){if(e.isZero())return"X";let t=e.countTrailingZeros();t=(t-t%4)/4;const i=t;t*=4;const n=e.shiftRightUnsigned(t).toString(16).replace(/0+$/,"");return Array(17-i-n.length).join("0")+n}function getS2ChildCellId(e,t){const i=lsb(e).shiftRightUnsigned(2);return e.add(Long.fromNumber(2*t+1-4).multiply(i))}function lsb(e){return e.and(e.not().add(1))}const FACE_BITS=3,MAX_LEVEL=30,POS_BITS=2*MAX_LEVEL+1,RADIAN_TO_DEGREE=180/Math.PI;function getS2CellFromQuadKey(e){if(0===e.length)throw new Error("Invalid Hilbert quad key ".concat(e));const t=e.split("/"),i=parseInt(t[0],10),n=t[1],r=n.length;let o=0;const s=[0,0];for(let e=r-1;e>=0;e--){o=r-e;const t=n[e];let i=0,a=0;"1"===t?a=1:"2"===t?(i=1,a=1):"3"===t&&(i=1);const l=Math.pow(2,o-1);rotateAndFlipQuadrant(l,s,i,a),s[0]+=l*i,s[1]+=l*a}if(i%2==1){const e=s[0];s[0]=s[1],s[1]=e}return{face:i,ij:s,level:o}}function getS2QuadkeyFromCellId(e){if(e.isZero())return"";let t=e.toString(2);for(;t.length<FACE_BITS+POS_BITS;)t="0"+t;const i=t.lastIndexOf("1"),n=t.substring(0,3),r=t.substring(3,i),o=r.length/2,s=Long.fromString(n,!0,2).toString(10);let a="";if(0!==o)for(a=Long.fromString(r,!0,2).toString(4);a.length<o;)a="0"+a;return"".concat(s,"/").concat(a)}function IJToST(e,t,i){const n=1<<t;return[(e[0]+i[0])/n,(e[1]+i[1])/n]}function singleSTtoUV(e){return e>=.5?1/3*(4*e*e-1):1/3*(1-4*(1-e)*(1-e))}function STToUV(e){return[singleSTtoUV(e[0]),singleSTtoUV(e[1])]}function FaceUVToXYZ(e,t){let[i,n]=t;switch(e){case 0:return[1,i,n];case 1:return[-i,1,n];case 2:return[-i,-n,1];case 3:return[-1,-n,-i];case 4:return[n,-1,-i];case 5:return[n,i,-1];default:throw new Error("Invalid face")}}function XYZToLngLat(e){let[t,i,n]=e;const r=Math.atan2(n,Math.sqrt(t*t+i*i));return[Math.atan2(i,t)*RADIAN_TO_DEGREE,r*RADIAN_TO_DEGREE]}function rotateAndFlipQuadrant(e,t,i,n){if(0===n){1===i&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);const n=t[0];t[0]=t[1],t[1]=n}}function getS2LngLatFromS2Cell(e){const t=STToUV(IJToST(e.ij,e.level,[.5,.5]));return XYZToLngLat(FaceUVToXYZ(e.face,t))}const MAX_RESOLUTION=100;function getS2BoundaryFlatFromS2Cell(e){const{face:t,ij:i,level:n}=e,r=[[0,0],[0,1],[1,1],[1,0],[0,0]],o=Math.max(1,Math.ceil(MAX_RESOLUTION*Math.pow(2,-n))),s=new Float64Array(4*o*2+2);let a=0,l=0;for(let e=0;e<4;e++){const c=r[e].slice(0),u=r[e+1],h=(u[0]-c[0])/o,d=(u[1]-c[1])/o;for(let e=0;e<o;e++){c[0]+=h,c[1]+=d;const e=XYZToLngLat(FaceUVToXYZ(t,STToUV(IJToST(i,n,c))));Math.abs(e[1])>89.999&&(e[0]=l);const r=e[0]-l;e[0]+=r>180?-360:r<-180?360:0,s[a++]=e[0],s[a++]=e[1],l=e[0]}}return s[a++]=s[0],s[a++]=s[1],s}function getS2Cell(e){return getS2CellFromQuadKey(getS2QuadKey(e))}function getS2QuadKey(e){if(e.indexOf("/")>0)return e;return getS2QuadkeyFromCellId(getS2CellIdFromToken(e))}function getS2LngLat(e){return getS2LngLatFromS2Cell(getS2Cell(e))}function getS2Region(e){let t;if(2===e.face||5===e.face){let i=null,n=0;for(let t=0;t<4;t++){const r=getS2BoundaryFlatFromS2Cell(getS2Cell("".concat(e.face,"/").concat(t)));null==i&&(i=new Float64Array(4*r.length)),i.set(r,n),n+=r.length}t=get2DRegionFromS2Corners(i)}else{t=get2DRegionFromS2Corners(getS2BoundaryFlatFromS2Cell(e))}return t}function get2DRegionFromS2Corners(e){if(e.length%2!=0)throw new Error("Invalid corners");const t=[],i=[];for(let n=0;n<e.length;n+=2)t.push(e[n]),i.push(e[n+1]);return t.sort(((e,t)=>e-t)),i.sort(((e,t)=>e-t)),{west:t[0],east:t[t.length-1],north:i[i.length-1],south:i[0]}}function getS2OrientedBoundingBoxCornerPoints(e,t){const i=(null==t?void 0:t.minimumHeight)||0,n=(null==t?void 0:t.maximumHeight)||0,r=getS2Region(getS2Cell(e)),o=r.west,s=r.south,a=r.east,l=r.north,c=[];return c.push(new Vector3$1(o,l,i)),c.push(new Vector3$1(a,l,i)),c.push(new Vector3$1(a,s,i)),c.push(new Vector3$1(o,s,i)),c.push(new Vector3$1(o,l,n)),c.push(new Vector3$1(a,l,n)),c.push(new Vector3$1(a,s,n)),c.push(new Vector3$1(o,s,n)),c}function convertS2BoundingVolumetoOBB(e){const t=e.token,i={minimumHeight:e.minimumHeight,maximumHeight:e.maximumHeight},n=getS2OrientedBoundingBoxCornerPoints(t,i),r=getS2LngLat(t),o=Ellipsoid.WGS84.cartographicToCartesian([r[0],r[1],i.maximumHeight]),s=new Vector3$1(o[0],o[1],o[2]);n.push(s);const a=makeOrientedBoundingBoxFromPoints(n);return[...a.center,...a.halfAxes]}const QUADTREE_DEVISION_COUNT=4,OCTREE_DEVISION_COUNT=8,SUBDIVISION_COUNT_MAP={QUADTREE:QUADTREE_DEVISION_COUNT,OCTREE:OCTREE_DEVISION_COUNT};function getChildS2VolumeBox(e,t,i){if(null!=e&&e.box){const n=getS2TokenFromCellId(getS2ChildCellId(getS2CellIdFromToken(e.s2VolumeInfo.token),t)),r={...e.s2VolumeInfo};if(r.token=n,"OCTREE"===i){const t=e.s2VolumeInfo,i=t.maximumHeight-t.minimumHeight,n=i/2,r=t.minimumHeight+i/2;t.minimumHeight=r-n,t.maximumHeight=r+n}return{box:convertS2BoundingVolumetoOBB(r),s2VolumeInfo:r}}}async function parseImplicitTiles(e){const{options:t,parentData:i={mortonIndex:0,x:0,y:0,z:0},childIndex:n=0,globalData:r={level:0,mortonIndex:0,x:0,y:0,z:0},s2VolumeBox:o}=e;let{subtree:s,level:a=0}=e;const{subdivisionScheme:l,subtreeLevels:c,maximumLevel:u,contentUrlTemplate:h,subtreesUriTemplate:d,basePath:p}=t,f={children:[],lodMetricValue:0,contentUrl:""},m=SUBDIVISION_COUNT_MAP[l],g=1&n,_=n>>1&1,y=n>>2&1,v=(m**a-1)/(m-1);let x=concatBits(i.mortonIndex,n),b=v+x,T=concatBits(i.x,g),w=concatBits(i.y,_),E=concatBits(i.z,y),S=!1;a+1>c&&(S=getAvailabilityResult(s.childSubtreeAvailability,x));const A=concatBits(r.x,T),M=concatBits(r.y,w),I=concatBits(r.z,E),C=a+r.level;if(S){const e=replaceContentUrlTemplate("".concat(p,"/").concat(d),C,A,M,I);s=await load(e,Tile3DSubtreeLoader),r.mortonIndex=x,r.x=T,r.y=w,r.z=E,r.level=a,x=0,b=0,T=0,w=0,E=0,a=0}if(!getAvailabilityResult(s.tileAvailability,b)||a>u)return f;getAvailabilityResult(s.contentAvailability,b)&&(f.contentUrl=replaceContentUrlTemplate(h,C,A,M,I));const P=a+1,L={mortonIndex:x,x:T,y:w,z:E};for(let e=0;e<m;e++){const i=getChildS2VolumeBox(o,e,l),n=await parseImplicitTiles({subtree:s,options:t,parentData:L,childIndex:e,level:P,globalData:r,s2VolumeBox:i});if(n.contentUrl||n.children.length){const e=formatTileData(n,C+1,{childTileX:T,childTileY:w,childTileZ:E},t,o);f.children.push(e)}}return f}function getAvailabilityResult(e,t){return"constant"in e?Boolean(e.constant):!!e.explicitBitstream&&getBooleanValueFromBitstream(t,e.explicitBitstream)}function formatTileData(e,t,i,n,r){const{basePath:o,refine:s,getRefine:a,lodMetricType:l,getTileType:c,rootLodMetricValue:u,rootBoundingVolume:h}=n,d=e.contentUrl&&e.contentUrl.replace("".concat(o,"/"),""),p=u/2**t,f=calculateBoundingVolumeForChildTile(t,null!=r&&r.box?{box:r.box}:h,i);return{children:e.children,contentUrl:e.contentUrl,content:{uri:d},id:e.contentUrl,refine:a(s),type:c(e),lodMetricType:l,lodMetricValue:p,geometricError:p,transform:e.transform,boundingVolume:f}}function calculateBoundingVolumeForChildTile(e,t,i){if(t.region){const{childTileX:n,childTileY:r,childTileZ:o}=i,[s,a,l,c,u,h]=t.region,d=2**e,p=(l-s)/d,f=(c-a)/d,m=(h-u)/d,[g,_]=[s+p*n,s+p*(n+1)],[y,v]=[a+f*r,a+f*(r+1)],[x,b]=[u+m*o,u+m*(o+1)];return{region:[g,y,_,v,x,b]}}if(t.box)return t;throw new Error("Unsupported bounding volume type ".concat(t))}function concatBits(e,t){return parseInt(e.toString(2)+t.toString(2),2)}function replaceContentUrlTemplate(e,t,i,n,r){const o=generateMapUrl({level:t,x:i,y:n,z:r});return e.replace(/{level}|{x}|{y}|{z}/gi,(e=>o[e]))}function generateMapUrl(e){const t={};for(const i in e)t["{".concat(i,"}")]=e[i];return t}function getBooleanValueFromBitstream(e,t){return 1===(t[Math.floor(e/8)]>>e%8&1)}function getTileType(e){if(!e.contentUrl)return TILE_TYPE.EMPTY;const t=e.contentUrl.split("?")[0].split(".").pop();switch(t){case"pnts":return TILE_TYPE.POINTCLOUD;case"i3dm":case"b3dm":case"glb":case"gltf":return TILE_TYPE.SCENEGRAPH;default:return t}}function getRefine(e){switch(e){case"REPLACE":case"replace":return TILE_REFINEMENT.REPLACE;case"ADD":case"add":return TILE_REFINEMENT.ADD;default:return e}}function resolveUri(e,t){if(/^[a-z][0-9a-z+.-]*:/i.test(t)){const i=new URL(e,"".concat(t,"/"));return decodeURI(i.toString())}return e.startsWith("/")?e:"".concat(t,"/").concat(e)}function normalizeTileData(e,t){if(!e)return null;if(e.content){e.contentUrl=resolveUri(e.content.uri||e.content.url,t.basePath)}return e.id=e.contentUrl,e.lodMetricType=LOD_METRIC_TYPE.GEOMETRIC_ERROR,e.lodMetricValue=e.geometricError,e.transformMatrix=e.transform,e.type=getTileType(e),e.refine=getRefine(e.refine),e}async function normalizeTileHeaders(e,t){const i=e.basePath;let n;const r=getImplicitTilingExtensionData(null==e?void 0:e.root);n=r&&e.root?await normalizeImplicitTileHeaders(e.root,e,r,t):normalizeTileData(e.root,e);const o=[];for(o.push(n);o.length>0;){const n=(o.pop()||{}).children||[];for(let r of n){const n=getImplicitTilingExtensionData(r);n?r=await normalizeImplicitTileHeaders(r,e,n,t):normalizeTileData(r,{basePath:i}),o.push(r)}}return n}async function normalizeImplicitTileHeaders(e,t,i,n){var r,o;const s=t.basePath,{subdivisionScheme:a,maximumLevel:l,subtreeLevels:c,subtrees:{uri:u}}=i,h=resolveUri(replaceContentUrlTemplate(u,0,0,0,0),s),d=await load(h,Tile3DSubtreeLoader,n),p=resolveUri(e.content.uri,s),f=null==t||null===(r=t.root)||void 0===r?void 0:r.refine,m=e.geometricError,g=null===(o=e.boundingVolume.extensions)||void 0===o?void 0:o["3DTILES_bounding_volume_S2"];if(g){const t=convertS2BoundingVolumetoOBB(g);e.boundingVolume={box:t,s2VolumeInfo:g}}const _={contentUrlTemplate:p,subtreesUriTemplate:u,subdivisionScheme:a,subtreeLevels:c,maximumLevel:l,refine:f,basePath:s,lodMetricType:LOD_METRIC_TYPE.GEOMETRIC_ERROR,rootLodMetricValue:m,rootBoundingVolume:e.boundingVolume,getTileType:getTileType,getRefine:getRefine};return await normalizeImplicitTileData(e,d,_)}async function normalizeImplicitTileData(e,t,i){if(!e)return null;e.lodMetricType=LOD_METRIC_TYPE.GEOMETRIC_ERROR,e.lodMetricValue=e.geometricError,e.transformMatrix=e.transform;const{children:n,contentUrl:r}=await parseImplicitTiles({subtree:t,options:i,s2VolumeBox:e});return r&&(e.contentUrl=r,e.content={uri:r.replace("".concat(i.basePath,"/"),"")}),e.refine=getRefine(e.refine),e.type=getTileType(e),e.children=n,e.id=e.contentUrl,e}function getImplicitTilingExtensionData(e){var t;return(null==e||null===(t=e.extensions)||void 0===t?void 0:t["3DTILES_implicit_tiling"])||(null==e?void 0:e.implicitTiling)}const Tiles3DLoader={id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:VERSION,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:parse,options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};function getBaseUri(e){return dirname(e.url)}async function parseTile(e,t,i){const n={featureIds:null};return await parse3DTile(e,0,t,i,n),n}async function parseTileset(e,t,i){var n;const r=JSON.parse((new TextDecoder).decode(e));return r.loader=t.loader||Tiles3DLoader,r.url=i.url,r.queryString=i.queryString,r.basePath=getBaseUri(r),r.root=await normalizeTileHeaders(r,t),r.type=TILESET_TYPE.TILES3D,r.lodMetricType=LOD_METRIC_TYPE.GEOMETRIC_ERROR,r.lodMetricValue=(null===(n=r.root)||void 0===n?void 0:n.lodMetricValue)||0,r}async function parse(e,t,i){const n=t["3d-tiles"]||{};let r;return r="auto"===n.isTileset?i.url&&-1!==i.url.indexOf(".json"):n.isTileset,e=r?await parseTileset(e,t,i):await parseTile(e,t,i)}const SINGLE_DATA=[0],defaultProps={getPointColor:{type:"accessor",value:[0,0,0,255]},pointSize:1,data:"",loader:Tiles3DLoader,onTilesetLoad:{type:"function",value:e=>{}},onTileLoad:{type:"function",value:e=>{}},onTileUnload:{type:"function",value:e=>{}},onTileError:{type:"function",value:(e,t,i)=>{}},_getMeshColor:{type:"function",value:e=>[255,255,255]}};let Tile3DLayer$1=class extends CompositeLayer{constructor(...e){super(...e),_defineProperty(this,"state",void 0)}initializeState(){"onTileLoadFail"in this.props&&log$3.removed("onTileLoadFail","onTileError")(),this.state={layerMap:{},tileset3d:null,activeViewports:{},lastUpdatedViewports:null}}get isLoaded(){var e,t;return Boolean((null===(e=this.state)||void 0===e||null===(t=e.tileset3d)||void 0===t?void 0:t.isLoaded())&&super.isLoaded)}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({props:e,oldProps:t,changeFlags:i}){if(e.data&&e.data!==t.data&&this._loadTileset(e.data),i.viewportChanged){const{activeViewports:e}=this.state;Object.keys(e).length&&(this._updateTileset(e),this.state.lastUpdatedViewports=e,this.state.activeViewports={})}if(i.propsChanged){const{layerMap:e}=this.state;for(const t in e)e[t].needsUpdate=!0}}activateViewport(e){const{activeViewports:t,lastUpdatedViewports:i}=this.state;this.internalState.viewport=e,t[e.id]=e;const n=null==i?void 0:i[e.id];n&&e.equals(n)||(this.setChangeFlags({viewportChanged:!0}),this.setNeedsUpdate())}getPickingInfo({info:e,sourceLayer:t}){const i=t&&t.props.tile;return e.picked&&(e.object=i),e.sourceTile=i,e}filterSubLayer({layer:e,viewport:t}){const{tile:i}=e.props,{id:n}=t;return i.selected&&i.viewportIds.includes(n)}_updateAutoHighlight(e){const t=e.sourceTile,i=this.state.layerMap[null==t?void 0:t.id];i&&i.layer&&i.layer.updateAutoHighlight(e)}async _loadTileset(e){const{loadOptions:t={}}=this.props;let i=this.props.loader||this.props.loaders;Array.isArray(i)&&(i=i[0]);const n={loadOptions:{...t}};let r=e;if(i.preload){const o=await i.preload(e,t);o.url&&(r=o.url),o.headers&&(n.loadOptions.fetch={...n.loadOptions.fetch,headers:o.headers}),Object.assign(n,o)}const o=await load(r,i,n.loadOptions),s=new Tileset3D(o,{onTileLoad:this._onTileLoad.bind(this),onTileUnload:this._onTileUnload.bind(this),onTileError:this.props.onTileError,...n});this.setState({tileset3d:s,layerMap:{}}),this._updateTileset(this.state.activeViewports),this.props.onTilesetLoad(s)}_onTileLoad(e){const{lastUpdatedViewports:t}=this.state;this.props.onTileLoad(e),this._updateTileset(t),this.setNeedsUpdate()}_onTileUnload(e){delete this.state.layerMap[e.id],this.props.onTileUnload(e)}_updateTileset(e){if(!e)return;const{tileset3d:t}=this.state,{timeline:i}=this.context,n=Object.keys(e).length;i&&n&&t&&t.selectTiles(Object.values(e)).then((e=>{this.state.frameNumber!==e&&this.setState({frameNumber:e})}))}_getSubLayer(e,t){if(!e.content)return null;switch(e.type){case TILE_TYPE.POINTCLOUD:return this._makePointCloudLayer(e,t);case TILE_TYPE.SCENEGRAPH:return this._make3DModelLayer(e);case TILE_TYPE.MESH:return this._makeSimpleMeshLayer(e,t);default:throw new Error("Tile3DLayer: Failed to render layer of type ".concat(e.content.type))}}_makePointCloudLayer(e,t){const{attributes:i,pointCount:n,constantRGBA:r,cartographicOrigin:o,modelMatrix:s}=e.content,{positions:a,normals:l,colors:c}=i;if(!a)return null;const u=t&&t.props.data||{header:{vertexCount:n},attributes:{POSITION:a,NORMAL:l,COLOR_0:c}},{pointSize:h,getPointColor:d}=this.props;return new(this.getSubLayerClass("pointcloud",PointCloudLayer))({pointSize:h},this.getSubLayerProps({id:"pointcloud"}),{id:"".concat(this.id,"-pointcloud-").concat(e.id),tile:e,data:u,coordinateSystem:COORDINATE_SYSTEM.METER_OFFSETS,coordinateOrigin:o,modelMatrix:s,getColor:r||d,_offset:0})}_make3DModelLayer(e){const{gltf:t,instances:i,cartographicOrigin:n,modelMatrix:r}=e.content;return new(this.getSubLayerClass("scenegraph",ScenegraphLayer))({_lighting:"pbr"},this.getSubLayerProps({id:"scenegraph"}),{id:"".concat(this.id,"-scenegraph-").concat(e.id),tile:e,data:i||SINGLE_DATA,scenegraph:t,coordinateSystem:COORDINATE_SYSTEM.METER_OFFSETS,coordinateOrigin:n,modelMatrix:r,getTransformMatrix:e=>e.modelMatrix,getPosition:[0,0,0],_offset:0})}_makeSimpleMeshLayer(e,t){const i=e.content,{attributes:n,indices:r,modelMatrix:o,cartographicOrigin:s,coordinateSystem:a=COORDINATE_SYSTEM.METER_OFFSETS,material:l,featureIds:c}=i,{_getMeshColor:u}=this.props,h=t&&t.props.mesh||new Geometry({drawMode:4,attributes:getMeshGeometry(n),indices:r});return new(this.getSubLayerClass("mesh",MeshLayer))(this.getSubLayerProps({id:"mesh"}),{id:"".concat(this.id,"-mesh-").concat(e.id),tile:e,mesh:h,data:SINGLE_DATA,getColor:u(e),pbrMaterial:l,modelMatrix:o,coordinateOrigin:s,coordinateSystem:a,featureIds:c,_offset:0})}renderLayers(){const{tileset3d:e,layerMap:t}=this.state;return e?e.tiles.map((e=>{const i=t[e.id]=t[e.id]||{tile:e};let{layer:n}=i;return e.selected&&(n?i.needsUpdate&&(n=this._getSubLayer(e,n),i.needsUpdate=!1):n=this._getSubLayer(e)),i.layer=n,n})).filter(Boolean):null}};function getMeshGeometry(e){const t={};return t.positions={...e.positions,value:new Float32Array(e.positions.value)},e.normals&&(t.normals=e.normals),e.texCoords&&(t.texCoords=e.texCoords),e.colors&&(t.colors=e.colors),e.uvRegions&&(t.uvRegions=e.uvRegions),t}_defineProperty(Tile3DLayer$1,"defaultProps",defaultProps),_defineProperty(Tile3DLayer$1,"layerName","Tile3DLayer");class Tile3DLayer{constructor(e){const t=this;t.implementation=e,t._tick=t._tick.bind(t)}onAdd(e,t){const i=this,n=i.implementation,r=Object.assign({},n,{type:Tile3DLayer$1}),o=n.lightColor,s=i.ambientLight=new AmbientLight$1({color:o,intensity:3}),a=i.directionalLight=new DirectionalLight$1({color:o,intensity:9,direction:[0,0,-1]}),l=e.map;i.map=e,delete r.lightColor,delete r.minzoom,delete r.maxzoom,l.addLayer(new MapboxLayer(r),t||"poi"),l.setLayerZoomRange(n.id,n.minzoom,n.maxzoom),l.__deck.props.effects=[new LightingEffect({ambientLight:s,directionalLight:a})],void 0===o&&i._tick()}_tick(){const e=this,{map:t,ambientLight:i,directionalLight:n}=e,r=t.clock.getTime();if(Math.floor(r/6e4)!==Math.floor(e.lastRefresh/6e4)){const{r:o,g:s,b:a}=t.getLightColor(),l=[Math.round(255*o),Math.round(255*s),Math.round(255*a)],c=t.getCenter(),u=SunCalc.getPosition(r,c.lat,c.lng),h=Math.PI+u.azimuth,d=-u.altitude;i.color=l,n.color=l,n.direction=[Math.sin(h)*Math.cos(d),Math.cos(h)*Math.cos(d),-Math.sin(d)],e.lastRefresh=r}t.map.getLayer(e.implementation.id)&&requestAnimationFrame(e._tick)}}const _camera=new OrthographicCamera(-1,1,1,-1,0,1);class FullscreenTriangleGeometry extends BufferGeometry{constructor(){super(),this.setAttribute("position",new Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Float32BufferAttribute([0,2,0,0,2,0],2))}}const _geometry=new FullscreenTriangleGeometry;class FullScreenQuad{constructor(e){this._mesh=new Mesh(_geometry,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,_camera)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}var computeFragmentShader="uniform int zoom;uniform int time;uniform int timeOffset;uniform float opacityGround;uniform float opacityUnderground;uniform usampler2D textureRoute0;uniform sampler2D textureRoute1;uniform usampler2D textureObject0;uniform sampler2D textureObject1;uniform sampler2D textureData0;uniform sampler2D textureData1;layout (location=0) out vec4 outPosition0;layout (location=1) out vec4 outPosition1;uvec4 fetchRoute0( uint index ) {ivec2 ref=ivec2( int( index % chunkSize ),int( index/chunkSize ) );return texelFetch( textureRoute0,ref,0 );}vec2 fetchRoute1( uint index ) {ivec2 ref=ivec2( int( index % chunkSize ),int( index/chunkSize ) );return texelFetch( textureRoute1,ref,0 ).rg;}uvec4 fetchObject0( uint index ) {ivec2 ref=ivec2( int( index % chunkSize ),int( index/chunkSize ) );return texelFetch( textureObject0,ref,0 );}vec4 fetchObject1( uint index ) {ivec2 ref=ivec2( int( index % chunkSize ),int( index/chunkSize ) );return texelFetch( textureObject1,ref,0 );}vec4 fetchData0( uint index ) {ivec2 ref=ivec2( int( index % chunkSize ),int( index/chunkSize ) );return texelFetch( textureData0,ref,0 );}vec4 fetchData1( uint index ) {ivec2 ref=ivec2( int( index % chunkSize ),int( index/chunkSize ) );return texelFetch( textureData1,ref,0 );}/***Returns the index of the node at the distance*@param distance-the distance*@param offset-the offset in the route texture*@param length-the length of nodes*@returns the index of the node at the distance*/uint indexOfNodeAt( float distance,uint offset,uint length ) {uint start=0u;uint end=length-1u;uint center;bool finished;bool firstHalf;for ( int i=0; i < loopCount; i++) {finished=start==end-1u;center=( start+end )/2u;firstHalf=distance < fetchRoute1( offset+center*3u ).r;start=finished || firstHalf ? start : center;end=finished || ! firstHalf ? end : center;}return offset+start*3u;}void main() {uint instanceID=uint( gl_FragCoord.y )*chunkSize+uint( gl_FragCoord.x );uint index=instanceID*2u;uvec4 object0=fetchObject0( index );uvec4 object1=fetchObject0( index+1u );vec4 object2=fetchObject1( index );vec4 object3=fetchObject1( index+1u );uint objectType=object0.x;uint routeID=object0.y;uint colorID=object0.z;int startTime=int( object0.w );int endTime=int( object1.x );int fadeAnimationStartTime=int( object1.y );uint fadeAnimationType=object1.z;float sectionIndex=object2.x;float nextSectionIndex=object2.y;float accelerationTime=object2.z;float acceleration=object2.w;float decelerationTime=object3.x;float deceleration=object3.y;vec4 data0=fetchData0( instanceID );vec4 data1=fetchData1( instanceID );vec3 prevPosition=data0.xyz;float prevRotateZ=data1.x;float prevRotateX=data1.y;int opacityAnimationStartTime=int( data1.z );uint routeSubID=objectType==0u ? uint( zoom-13 ) : 0u;uvec4 header=fetchRoute0( routeID+routeSubID );uint offset=header.z;vec2 distances=objectType==2u ? vec2( 0.0 ) : fetchRoute1( offset+uint( sectionIndex )/2u );float sectionDistance=objectType==2u ? sectionIndex : uint( sectionIndex ) % 2u==0u ? distances.r : distances.g;distances=objectType==2u ? vec2( 0.0 ) : fetchRoute1( offset+uint( nextSectionIndex )/2u );float nextSectionDistance=objectType==2u ? nextSectionIndex : uint( nextSectionIndex ) % 2u==0u ? distances.r : distances.g;float elapsed=float( clamp( timeOffset-startTime,0,endTime-startTime ) );float left=float( clamp( endTime-timeOffset,0,endTime-startTime ) );float a=elapsed < accelerationTime ? acceleration/2.0*elapsed*elapsed :\nleft < decelerationTime ? 1.0-deceleration/2.0*left*left :\nmax( acceleration*accelerationTime,deceleration*decelerationTime)*( elapsed-accelerationTime/2.0 );float distance=mix( sectionDistance,nextSectionDistance,a );index=indexOfNodeAt( distance,header.x,header.y );vec2 section0=fetchRoute1( index );vec2 section1=fetchRoute1(++index );vec2 section2=fetchRoute1(++index );vec2 section3=fetchRoute1(++index );vec2 section4=fetchRoute1(++index );float baseDistance=section0.r;vec3 currentPosition=vec3( section0.g,section1.r,section1.g );float rotateZ=section2.r;float rotateX=section2.g;float nextDistance=section3.r;vec3 nextPosition=vec3( section3.g,section4.r,section4.g );a=nextDistance !=baseDistance ? ( distance-baseDistance )/( nextDistance-baseDistance ) : 0.0;vec3 position=mix( currentPosition,nextPosition,a );bool prevGround=prevPosition.z >=0.0;bool ground=position.z >=0.0;opacityAnimationStartTime=time >=fadeAnimationStartTime+fadeDuration && ( ( prevGround && ! ground ) || ( ! prevGround && ground ) ) ? time : opacityAnimationStartTime;a=clamp( float( time-opacityAnimationStartTime )/float( fadeDuration ),0.0,1.0 );float opacity0=mix( ground ? opacityUnderground : opacityGround,ground ? opacityGround : opacityUnderground,a );a=clamp( float( time-fadeAnimationStartTime )/float( fadeDuration ),0.0,1.0 );bool fadingIn=fadeAnimationType==1u;bool fadingOut=fadeAnimationType==2u;float opacity1=mix( fadingOut ? 1.0 : 0.0,fadingIn ? 1.0 : 0.0,a );float opacity=opacity0*opacity1;position=fadingOut ? prevPosition : position;rotateZ=fadingOut ? prevRotateZ : rotateZ;rotateX=fadingOut ? prevRotateX : rotateX;outPosition0=vec4( position,float( colorID ) );outPosition1=vec4( rotateZ,rotateX,opacityAnimationStartTime,opacity );}",computeVertexShader="void main() {gl_Position=vec4( position,1.0 );}";const PROPS={ubyte4:{TypedArray:Uint8Array,format:RGBAFormat,type:UnsignedByteType,unit:4},uint4:{TypedArray:Uint32Array,format:RGBAIntegerFormat,type:UnsignedIntType,unit:4},float4:{TypedArray:Float32Array,format:RGBAFormat,type:FloatType,unit:4},float2:{TypedArray:Float32Array,format:RGFormat,type:FloatType,unit:2}};class LinearDataTexture extends DataTexture{constructor(...e){if("number"==typeof e[0]){const[t,i,n]=e,{TypedArray:r,format:o,type:s,unit:a}=PROPS[i],l=Math.ceil(t/n);super(new r(n*l*a),n,l,o,s),Object.assign(this.userData,{size:t,TypedArray:r,unit:a}),this.needsUpdate=!0}else if(2===e.length){const[t,i]=e,{image:n,userData:r,format:o,type:s}=t,{data:a,width:l}=n,{size:c,TypedArray:u,unit:h}=r,d=c+i,p=Math.ceil(d/l);let f;p===n.height?f=a:(f=new u(l*p*h),f.set(a)),super(f,l,p,o,s),Object.assign(this.userData,{size:d,TypedArray:u,unit:h}),this.needsUpdate=!0}else{const[t,i,n]=e,{image:r,userData:o,format:s,type:a}=t,{data:l,width:c}=r,{size:u,TypedArray:h,unit:d}=o,p=u-n,f=Math.ceil(p/c);let m;f===r.height?m=l:(m=new h(c*f*d),m.set(l.subarray(0,i*d)),m.set(l.subarray((i+n)*d,u*d),i*d)),super(m,c,f,s,a),Object.assign(this.userData,{size:p,TypedArray:h,unit:d}),this.needsUpdate=!0}}get size(){return this.userData.size}}class ObjectData{constructor(e,t){const i=this,n=t.chunkSize;i.uintTexture=new LinearDataTexture(2*e,"uint4",n),i.floatTexture=new LinearDataTexture(2*e,"float4",n),i.count=e,i.start=0}add(e,t,i,n,r,o){const s=this,{uintTexture:a,floatTexture:l}=s,c=a.image.data,u=l.image.data;for(let h=s.start,d=s.count;h<d;h++){const d=8*h;if(0===c[d+6])return c.set([e,t,i,864e5,864e5,performance.now(),1,o],d),u.set([n,r],d),a.needsUpdate=!0,l.needsUpdate=!0,s.start=h+1,h}}update(e,t,i,n,r,o,s,a,l){const{uintTexture:c,floatTexture:u}=this,h=u.image.data,d=8*e;c.image.data.set([n,n+r],d+3),h.set([t,i,o,s,a,l],d),c.needsUpdate=!0,u.needsUpdate=!0}remove(e){return new Promise((t=>{const i=this,n=i.uintTexture,r=n.image.data,o=8*e;r.set([performance.now(),2],o+5),n.needsUpdate=!0,animation.start({complete:()=>{r.set([0,0],o+6),n.needsUpdate=!0,i.start=Math.min(e,i.start),t()},duration:configs.fadeDuration})}))}setMarked(e){this.marked=e}setTracked(e){this.tracked=e}getIDs(e){const t=this,i=t.uintTexture.image.data,n={body:[],delayMarker:[],outline:[]},r={body:[],delayMarker:[],outline:[]},o={body:[],outline:[]},s={body:[],outline:[]};for(let a=0,l=t.count;a<l;a++){const l=8*a;if(0!==i[l+6]){const c=i[l],u=i[l+7],h=0===c?e[4*a+2]<0?n:r:1===c?o:s;h.body.push(a),1===u&&h.delayMarker.push(a),a!==t.marked&&a!==t.tracked||h.outline.push(a)}}return n.body.sort(((e,t)=>e%256-t%256)),r.body.sort(((e,t)=>e%256-t%256)),[n,r,o,s]}dispose(){this.uintTexture.dispose(),this.floatTexture.dispose()}}class RouteData{constructor(e){const t=this,i=e.chunkSize;t.modelOrigin=e.modelOrigin,t.uintTexture=new LinearDataTexture(0,"uint4",i),t.floatTexture=new LinearDataTexture(0,"float2",i),t.groups=new Map,t.groupCount=0,t.freeIndices=[],t.freeBundledIndices=[],t.lookup=new Map,t.loopCount=0}addGroup(e){const t=this,{modelOrigin:i,lookup:n}=t,r=[],o=[],s=t.uintTexture.size;let a=0,l=t.floatTexture.size,c=0,u=1;for(const{id:i,feature:l}of e){const e=Array.isArray(l),h=e?t.freeBundledIndices:t.freeIndices;let d;h.length>0?d=h.pop():(d=s+a,a+=e?l.length:1),r.push(i),n.set(i,{index:d,bundled:e});for(const t of e?l:[l]){const e=t.properties,i=t.geometry.coordinates,n=e["station-offsets"]||[0,e.length];o.push({index:d,coords:i,distances:e.distances,sectionOffsets:n}),d+=1,c+=3*i.length+Math.ceil(n.length/2),u=Math.max(u,i.length)}}t.groups.set(t.groupCount,{ids:r,floatTextureOffset:l,floatTextureSize:c}),t.loopCount=Math.max(t.loopCount,Math.ceil(Math.log2(u)));const h=new LinearDataTexture(t.uintTexture,a),d=new LinearDataTexture(t.floatTexture,c);t.uintTexture.dispose(),t.floatTexture.dispose(),t.uintTexture=h,t.floatTexture=d;const p=h.image.data,f=d.image.data;for(const{index:e,coords:t,distances:n,sectionOffsets:r}of o){p.set([l,t.length,l+3*t.length],4*e);for(let e=0,r=t.length;e<r;e++){const r=t[e],o=mapboxGlExports.MercatorCoordinate.fromLngLat(r,r[2]||0),[s,a,,c]=n[e];f.set([s,o.x-i.x,-(o.y-i.y),o.z-i.z,MathUtils.degToRad(-a),c],2*l+6*e)}f.set(r,2*l+6*t.length),l+=Math.ceil(3*t.length+r.length/2)}return h.needsUpdate=!0,d.needsUpdate=!0,t.groupCount++}removeGroup(e){const t=this,{uintTexture:i,groups:n,lookup:r}=t,{ids:o,floatTextureOffset:s,floatTextureSize:a}=n.get(e),l=i.image.data;n.delete(e);for(const e of n.values())e.floatTextureOffset>=s+a&&(e.floatTextureOffset-=a);for(const e of o){const{index:i,bundled:n}=r.get(e);(n?t.freeBundledIndices:t.freeIndices).push(i),r.delete(e)}const c=new LinearDataTexture(t.floatTexture,s,a);t.floatTexture.dispose(),t.floatTexture=c;for(let e=0,t=i.size;e<t;e++){const t=4*e;l[t]>=s+a&&(l[t]-=a),l[t+2]>=s+a&&(l[t+2]-=a)}i.needsUpdate=!0,c.needsUpdate=!0}getIndex(e){return this.lookup.get(e).index}dispose(){this.uintTexture.dispose(),this.floatTexture.dispose()}}class ColorData{constructor(e){const t=this;t.texture=new LinearDataTexture(0,"ubyte4",e.chunkSize),t.groups=new Map,t.groupCount=0,t.freeIndices=[],t.lookup=new Map}addGroup(e){const t=this,{freeIndices:i,lookup:n}=t,r=[],o=[],s=t.texture.size/4;let a=0;for(const{id:t,color:l}of e){let e;i.length>0?e=i.pop():(e=s+a,a+=1),r.push(t),n.set(t,{index:e}),o.push({index:e,color:l})}t.groups.set(t.groupCount,{ids:r});const l=new LinearDataTexture(t.texture,4*a);t.texture.dispose(),t.texture=l;const c=l.image.data;for(const{index:e,color:t}of o){const i=Array.isArray(t)?t:[t];c.set([...colorToRGBArray(i[0]),255,...colorToRGBArray(i[1]||i[0]),255,...colorToRGBArray(i[2]||i[0]),255,...colorToRGBArray(i[3]||"#00ff00"),255],16*e)}return l.needsUpdate=!0,t.groupCount++}removeGroup(e){const{groups:t,freeIndices:i,lookup:n}=this,r=t.get(e).ids;t.delete(e);for(const e of r)i.push(n.get(e).index),n.delete(e)}getIndex(e){return this.lookup.get(e).index}dispose(){this.texture.dispose()}}class ComputeRenderer{constructor(e,t){const i=this,n=t.chunkSize,r=Math.ceil(e/n),o=i.dtObject=new ObjectData(e,t),s=i.dtRoute=new RouteData(t);i.dtColor=new ColorData(t),i.modelOrigin=t.modelOrigin,i.loopCount=0;const a=i.uniforms={zoom:{value:0},time:{value:performance.now()},timeOffset:{value:0},opacityGround:{value:.9},opacityUnderground:{value:.225},textureObject0:{value:o.uintTexture},textureObject1:{value:o.floatTexture},textureRoute0:{value:s.uintTexture},textureRoute1:{value:s.floatTexture},textureData0:{value:null},textureData1:{value:null}},l=i.material=new ShaderMaterial({uniforms:a,vertexShader:computeVertexShader,fragmentShader:computeFragmentShader,defines:{chunkSize:`${n}u`,loopCount:i.loopCount,fadeDuration:configs.fadeDuration},glslVersion:GLSL3});i.quad=new FullScreenQuad(l),i.dataVariable=[];for(let e=0;e<2;e++)i.dataVariable[e]=new WebGLRenderTarget(n,r,{wrapS:ClampToEdgeWrapping,wrapT:ClampToEdgeWrapping,minFilter:NearestFilter,magFilter:NearestFilter,format:RGBAFormat,type:FloatType,depthBuffer:!1,count:2});i.marked=-1,i.tracked=-1,i.currentTextureIndex=0,i.buffer=new Float32Array(n*r*4)}compute(e,t){const i=this,{dataVariable:n,currentTextureIndex:r}=i,o=i.currentTextureIndex=0===r?1:0,s=n[r],a=n[o],l=i.uniforms,c=e.renderer;l.zoom.value=t,l.time.value=performance.now(),l.textureData0.value=s.textures[0],l.textureData1.value=s.textures[1];const u=c.getRenderTarget(),h=c.xr.enabled,d=c.shadowMap.autoUpdate;return c.resetState(),c.xr.enabled=!1,c.shadowMap.autoUpdate=!1,c.setRenderTarget(a),i.quad.render(c),c.xr.enabled=h,c.shadowMap.autoUpdate=d,c.setRenderTarget(u),c.resetState(),[...a.textures,i.dtColor.texture]}addRouteGroup(e){const{dtRoute:t,uniforms:i,material:n}=this,r=t.addGroup(e);return i.textureRoute0.value=t.uintTexture,i.textureRoute1.value=t.floatTexture,n.defines.loopCount=this.loopCount=t.loopCount,n.needsUpdate=!0,r}removeRouteGroup(e){const t=this.dtRoute;t.removeGroup(e),this.uniforms.textureRoute1.value=t.floatTexture}getRouteIndex(e){return this.dtRoute.getIndex(e)}addColorGroup(e){return this.dtColor.addGroup(e)}removeColorGroup(e){this.dtColor.removeGroup(e)}getColorIndex(e){return this.dtColor.getIndex(e)}addInstance(e,t,i,n,r,o){return this.dtObject.add(e,t,i,n,r,o)}updateInstance(e,t,i,n,r,o,s,a,l){this.dtObject.update(e,t,i,n,r,o,s,a,l)}removeInstance(e){return this.dtObject.remove(e)}setMarked(e){this.dtObject.setMarked(e)}setTracked(e){this.dtObject.setTracked(e)}getInstanceIDs(e){const t=this,i=t.dataVariable[t.currentTextureIndex],n=t.buffer;return e.renderer.readRenderTargetPixels(i,0,0,i.width,i.height,n),t.dtObject.getIDs(n)}getInstancePosition(e){const t=this,i=t.uniforms,n=i.timeOffset.value,r=t.dtObject.uintTexture.image.data,o=t.dtObject.floatTexture.image.data,s=r[8*e],a=r[8*e+3],l=r[8*e+4],c=o[8*e],u=o[8*e+1],h=o[8*e+2],d=o[8*e+3],p=o[8*e+4],f=o[8*e+5],m=r[8*e+1]+(0===s?i.zoom.value-13:0),g=t.dtRoute.uintTexture.image.data,_=t.dtRoute.floatTexture.image.data,y=g[4*m+2],v=2===s?c:_[2*y+c],x=2===s?u:_[2*y+u],b=clamp$3(n-a,0,l-a),T=clamp$3(l-n,0,l-a);let w;w=b<h?d/2*b*b:T<p?1-f/2*T*T:Math.max(d*h,f*p)*(b-h/2);const E=lerp$5(v,x,w),S=g[4*m];let A,M=0,I=g[4*m+1]-1;for(let e=0;e<t.loopCount&&M!==I-1;e++)A=Math.floor((M+I)/2),E<_[2*(S+3*A)]?I=A:M=A;const C=S+3*M,P=_[2*C],L=_[2*C+2],R=_[2*C+3],O=_[2*C+4],D=_[2*C+6],B=_[2*C+8],F=_[2*C+9],N=D!==P?(E-P)/(D-P):0,k=lerp$5(_[2*C+1],_[2*C+7],N),U=lerp$5(L,B,N),z=lerp$5(R,F,N),V=t.modelOrigin,G=new mapboxGlExports.MercatorCoordinate(V.x+k,V.y-U,V.z+z),j=MathUtils.radToDeg(-O);return{coord:G.toLngLat(),altitude:G.toAltitude(),bearing:j+(c<u?0:180),_t:w}}setOpacity(e){const t=this.uniforms;t.opacityGround.value=e.ground,t.opacityUnderground.value=e.underground}getOpacity(){const e=this.uniforms;return{ground:e.opacityGround.value,underground:e.opacityUnderground.value}}setTimeOffset(e){this.uniforms.timeOffset.value=e}dispose(){const e=this;e.dtObject.dispose(),e.dtRoute.dispose(),e.dtColor.dispose(),e.quad.dispose(),e.material.dispose();for(let t=0;t<2;t++)e.dataVariable[t].dispose()}}function mergeGeometries(e,t=!1){const i=null!==e[0].index,n=new Set(Object.keys(e[0].attributes)),r=new Set(Object.keys(e[0].morphAttributes)),o={},s={},a=e[0].morphTargetsRelative,l=new BufferGeometry;let c=0;for(let u=0;u<e.length;++u){const h=e[u];let d=0;if(i!==(null!==h.index))return null;for(const e in h.attributes){if(!n.has(e))return null;void 0===o[e]&&(o[e]=[]),o[e].push(h.attributes[e]),d++}if(d!==n.size)return null;if(a!==h.morphTargetsRelative)return null;for(const e in h.morphAttributes){if(!r.has(e))return null;void 0===s[e]&&(s[e]=[]),s[e].push(h.morphAttributes[e])}if(t){let e;if(i)e=h.index.count;else{if(void 0===h.attributes.position)return null;e=h.attributes.position.count}l.addGroup(c,e,u),c+=e}}if(i){let t=0;const i=[];for(let n=0;n<e.length;++n){const r=e[n].index;for(let e=0;e<r.count;++e)i.push(r.getX(e)+t);t+=e[n].attributes.position.count}l.setIndex(i)}for(const e in o){const t=mergeAttributes(o[e]);if(!t)return null;l.setAttribute(e,t)}for(const e in s){const t=s[e][0].length;if(0===t)break;l.morphAttributes=l.morphAttributes||{},l.morphAttributes[e]=[];for(let i=0;i<t;++i){const t=[];for(let n=0;n<s[e].length;++n)t.push(s[e][n][i]);const n=mergeAttributes(t);if(!n)return null;l.morphAttributes[e].push(n)}}return l}function mergeAttributes(e){let t,i,n,r=-1,o=0;for(let s=0;s<e.length;++s){const a=e[s];if(void 0===t&&(t=a.array.constructor),t!==a.array.constructor)return null;if(void 0===i&&(i=a.itemSize),i!==a.itemSize)return null;if(void 0===n&&(n=a.normalized),n!==a.normalized)return null;if(-1===r&&(r=a.gpuType),r!==a.gpuType)return null;o+=a.count*i}const s=new t(o),a=new BufferAttribute(s,i,n);let l=0;for(let t=0;t<e.length;++t){const n=e[t];if(n.isInterleavedBufferAttribute){const e=l/i;for(let t=0,r=n.count;t<r;t++)for(let r=0;r<i;r++){const i=n.getComponent(t,r);a.setComponent(t+e,r,i)}}else s.set(n.array,l);l+=n.count*i}return void 0!==r&&(a.gpuType=r),a}function toTrianglesDrawMode(e,t){if(t===TrianglesDrawMode)return e;if(t===TriangleFanDrawMode||t===TriangleStripDrawMode){let i=e.getIndex();if(null===i){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),i=e.getIndex()}const n=i.count-2,r=[];if(t===TriangleFanDrawMode)for(let e=1;e<=n;e++)r.push(i.getX(0)),r.push(i.getX(e)),r.push(i.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(r.push(i.getX(e)),r.push(i.getX(e+1)),r.push(i.getX(e+2))):(r.push(i.getX(e+2)),r.push(i.getX(e+1)),r.push(i.getX(e)));const o=e.clone();return o.setIndex(r),o.clearGroups(),o}return e}const groupIndices=new Float32Array([].concat(...[0,1,2].map((e=>Array(24).fill(e)))));class AircraftGeometry extends BufferGeometry{constructor(e=1,t=1,i=1,n=.1){super();const r=[new BoxGeometry(e,t,i),new BoxGeometry(t,e,n),new BoxGeometry(n,e,i)],o=mergeGeometries(r);this.copy(o),this.setAttribute("groupIndex",new BufferAttribute(groupIndices,1)),r.forEach((e=>e.dispose())),o.dispose()}}class CarGeometry extends BufferGeometry{constructor(e=1,t=1,i=1){super();const n=this,r=[],o=[],s=[],a=[],l=[];let c=0;function u(e,t,i,n,u,h,d,p,f,m,g){const _=h/f,y=d/m,v=h/2,x=d/2,b=p/2,T=new Vector3;let w=0;for(let h=0;h<m;h++)for(let d=0;d<f;d++){for(let r=0;r<4;r++){const c=d+Math.floor(r/2),E=h+Math.floor((r+1)/2)%2;T[e]=(c*_-v)*n,T[t]=(E*y-x)*u,T[i]=b,o.push(T.x,T.y,T.z),T[e]=0,T[t]=0,T[i]=p>0?1:-1,s.push(T.x,T.y,T.z),a.push(c/f,1-E/m),l.push(g[w])}r.push(c,c+1,c+3),r.push(c+1,c+2,c+3),w+=1,c+=4}}u("z","y","x",-1,-1,i,t,e,3,1,[0,1,2]),u("z","y","x",1,-1,i,t,-e,3,1,[2,1,0]),u("x","z","y",1,1,e,i,t,1,3,[5,4,3]),u("x","z","y",1,-1,e,i,-t,1,3,[3,4,5]),u("x","y","z",1,-1,e,t,i,1,1,[0]),u("x","y","z",-1,-1,e,t,-i,1,1,[3]),n.setIndex(r),n.setAttribute("position",new BufferAttribute(new Float32Array(o),3)),n.setAttribute("normal",new BufferAttribute(new Float32Array(s),3)),n.setAttribute("uv",new BufferAttribute(new Float32Array(a),2)),n.setAttribute("groupIndex",new BufferAttribute(new Float32Array(l),1))}}class InstancedGeometry extends InstancedBufferGeometry{constructor(e,t){super();const i=this,n=new InstancedBufferAttribute(new Int32Array(t),1).setUsage(DynamicDrawUsage);i.instanceCount=0;for(const t of Object.keys(e.attributes))i.attributes[t]=e.attributes[t].clone();i.index=e.index.clone(),i.setAttribute("instanceID",n)}setInstanceIDs(e){const t=this.getAttribute("instanceID"),i=e.length;t.array.set(e),t.addUpdateRange(0,i),t.needsUpdate=!0,this.instanceCount=i}}var commonVertexShaderChunk="#include <common>\nuniform float zoom;uniform float cameraZ;uniform float modelScale;uniform sampler2D textureData0;uniform sampler2D textureData1;uniform sampler2D textureColor;attribute int instanceID;\n#ifndef BUS\nattribute float groupIndex;\n#endif\nfloat getScale( float zoom,float modelScale) {return pow( 2.0,14.0-clamp( zoom,13.0,19.0 ) )*modelScale*100.0;}\n#ifndef BUS\nmat3 rotateX( float angle ) {float s=sin( angle );float c=cos( angle );return mat3(\n1.0,0.0,0.0,0.0,c,s,0.0,-s,c\n);}\n#endif\nmat3 rotateZ( float angle ) {float s=sin( angle );float c=cos( angle );return mat3(\nc,s,0.0,-s,c,0.0,0.0,0.0,1.0\n);}varying vec3 vInstanceColor;varying float vInstanceOpacity;",colorVertexShaderChunk="#include <color_vertex>\nint width=textureSize( textureData0,0 ).x;ivec2 reference=ivec2( instanceID % width,instanceID/width );vec4 data0=texelFetch( textureData0,reference,0 );vec4 data1=texelFetch( textureData1,reference,0 );vec3 translation=data0.xyz;int colorID=int( data0.w );float rotationX=data1.y;float rotationZ=data1.x;float opacity0=data1.w;width=textureSize( textureColor,0 ).x;reference=ivec2( colorID*4 % width,colorID*4/width );vec3 color0=texelFetch( textureColor,reference,0 ).rgb;reference=ivec2( ( colorID*4+1 ) % width,( colorID*4+1 )/width );vec3 color1=texelFetch( textureColor,reference,0 ).rgb;reference=ivec2( ( colorID*4+2 ) % width,( colorID*4+2 )/width );vec3 color2=texelFetch( textureColor,reference,0 ).rgb;reference=ivec2( ( colorID*4+3 ) % width,( colorID*4+3 )/width );vec3 color3=texelFetch( textureColor,reference,0 ).rgb;\n#ifdef CAR\nfloat mod3=mod( groupIndex,3.0 );vec3 null=vec3( 0.0,1.0,0.0 );vInstanceColor=groupIndex >=3.0 && color3 !=null ? color3 : mod3==0.0 ? color0 : mod3==1.0 ? color1 : color2;\n#endif\n#ifdef AIRCRAFT\nvInstanceColor=groupIndex < 2.0 ? color0 : color1;\n#endif\n#ifdef BUS\nvInstanceColor=color0;\n#endif\nvInstanceOpacity=opacity0;",beginnormalVertexShaderChunk="#ifdef BUS\nvec3 objectNormal=rotateZ( rotationZ )*vec3( normal );\n#else\nvec3 objectNormal=rotateZ( rotationZ )*rotateX( rotationX )*vec3( normal );\n#endif",beginVertexShaderChunk="float zoom0=zoom+log2( cameraZ/abs( cameraZ-translation.z ) );float scale0=getScale( zoom0,modelScale );\n#ifdef AIRCRAFT\nfloat scale=0.06/0.285*modelScale*100.0;float offsetY=groupIndex==2.0 ? 0.44-1.32*max( scale/scale0,1.0 ) : 0.0;float offsetZ=groupIndex==2.0 ? 0.88 : 0.0;float scaleX=groupIndex==1.0 ? max( scale0,scale ) : scale0;float scaleY=groupIndex==0.0 ? max( scale0,scale ) : scale0;vec3 position0=( position+vec3( 0.0,offsetY,offsetZ ) )*vec3( scaleX,scaleY,scale0 );\n#else\nvec3 position0=position*scale0;\n#endif\nposition0=position0*( 1.0+float( instanceID % 256 )/256.0*0.03 );\n#ifdef BUS\nvec3 transformed=rotateZ( rotationZ )*position0+translation+vec3( 0.0,0.0,0.3*scale0 );\n#else\nvec3 transformed=rotateZ( rotationZ )*rotateX( rotationX )*position0+translation+vec3( 0.0,0.0,0.44*scale0 );\n#endif",commonFragmentShaderChunk="#include <common>\nvarying vec3 vInstanceColor;varying float vInstanceOpacity;",diffuseColorFragmentShaderChunk="vec4 diffuseColor=vec4( diffuse*vInstanceColor,opacity*vInstanceOpacity );",outlineFragmentShader="varying float vInstanceOpacity;void main() {gl_FragColor=vec4( 1.0,1.0,1.0,vInstanceOpacity );}",outlineVertexShader="uniform float zoom;uniform float cameraZ;uniform float modelScale;uniform sampler2D textureData0;uniform sampler2D textureData1;uniform int marked;uniform int tracked;uniform float intensity;attribute int instanceID;\n#ifdef AIRCRAFT\nattribute float groupIndex;\n#endif\nfloat getScale( float zoom,float modelScale) {return pow( 2.0,14.0-clamp( zoom,13.0,19.0 ) )*modelScale*100.0;}\n#ifndef BUS\nmat3 rotateX( float angle ) {float s=sin( angle );float c=cos( angle );return mat3(\n1.0,0.0,0.0,0.0,c,s,0.0,-s,c\n);}\n#endif\nmat3 rotateZ( float angle ) {float s=sin( angle );float c=cos( angle );return mat3(\nc,s,0.0,-s,c,0.0,0.0,0.0,1.0\n);}varying float vInstanceOpacity;void main() {int width=textureSize( textureData0,0 ).x;ivec2 reference=ivec2( instanceID % width,instanceID/width );vec4 data0=texelFetch( textureData0,reference,0 );vec4 data1=texelFetch( textureData1,reference,0 );vec3 translation=data0.xyz;float rotationX=data1.y;float rotationZ=data1.x;float outline=instanceID==marked ? 1.0 : instanceID==tracked ? intensity : 0.0;float zoom0=zoom+log2( cameraZ/abs( cameraZ-translation.z ) );float scale0=getScale( zoom0,modelScale );\n#ifdef AIRCRAFT\nfloat scale=0.06/0.285*modelScale*100.0;float offsetY=groupIndex==2.0 ? 0.44-1.32*max( scale/scale0,1.0 ) : 0.0;float offsetZ=groupIndex==2.0 ? 0.88 : 0.0;float scaleX=groupIndex==1.0 ? max( scale0,scale ) : scale0;float scaleY=groupIndex==0.0 ? max( scale0,scale ) : scale0;vec3 position0=( position+vec3( 0.0,offsetY,offsetZ ) )*vec3( scaleX,scaleY,scale0 );\n#else\nvec3 position0=position*scale0;\n#endif\nposition0=position0*( 1.0+float( instanceID % 256 )/256.0*0.03 );position0=position0+0.1*scale0*sign( position );\n#ifdef BUS\nvec3 transformed=rotateZ( rotationZ )*position0+translation+vec3( 0.0,0.0,0.3*scale0 );\n#else\nvec3 transformed=rotateZ( rotationZ )*rotateX( rotationX )*position0+translation+vec3( 0.0,0.0,0.44*scale0 );\n#endif\ngl_Position=projectionMatrix*modelViewMatrix*vec4( transformed,1.0 );vInstanceOpacity=outline;}",pickingFragmentShader="varying vec3 vIdColor;void main() {gl_FragColor=vec4( vIdColor,1.0 );}",pickingVertexShader="uniform float zoom;uniform float cameraZ;uniform float modelScale;uniform sampler2D textureData0;uniform sampler2D textureData1;attribute int instanceID;\n#ifdef AIRCRAFT\nattribute float groupIndex;\n#endif\nfloat getScale( float zoom,float modelScale) {return pow( 2.0,14.0-clamp( zoom,13.0,19.0 ) )*modelScale*100.0;}\n#ifndef BUS\nmat3 rotateX( float angle ) {float s=sin( angle );float c=cos( angle );return mat3(\n1.0,0.0,0.0,0.0,c,s,0.0,-s,c\n);}\n#endif\nmat3 rotateZ( float angle ) {float s=sin( angle );float c=cos( angle );return mat3(\nc,s,0.0,-s,c,0.0,0.0,0.0,1.0\n);}varying vec3 vIdColor;void main() {int width=textureSize( textureData0,0 ).x;ivec2 reference=ivec2( instanceID % width,instanceID/width );vec4 data0=texelFetch( textureData0,reference,0 );vec4 data1=texelFetch( textureData1,reference,0 );vec3 translation=data0.xyz;float rotationX=data1.y;float rotationZ=data1.x;float opacity0=data1.w;vec3 idColor=vec3( ivec3( instanceID/65536 % 256,instanceID/256 % 256,instanceID % 256 ) )/256.0+0.5/256.0;float zoom0=zoom+log2( cameraZ/abs( cameraZ-translation.z ) );float scale0=getScale( zoom0,modelScale );\n#ifdef AIRCRAFT\nfloat scale=0.06/0.285*modelScale*100.0;float offsetY=groupIndex==2.0 ? 0.44-1.32*max( scale/scale0,1.0 ) : 0.0;float offsetZ=groupIndex==2.0 ? 0.88 : 0.0;float scaleX=groupIndex==1.0 ? max( scale0,scale ) : scale0;float scaleY=groupIndex==0.0 ? max( scale0,scale ) : scale0;vec3 position0=( position+vec3( 0.0,offsetY,offsetZ ) )*vec3( scaleX,scaleY,scale0 );\n#else\nvec3 position0=position*scale0;\n#endif\nposition0=position0*( 1.0+float( instanceID % 256 )/256.0*0.03 );\n#ifdef BUS\nvec3 transformed=rotateZ( rotationZ )*position0+translation+vec3( 0.0,0.0,0.3*scale0 );\n#else\nvec3 transformed=rotateZ( rotationZ )*rotateX( rotationX )*position0+translation+vec3( 0.0,0.0,0.44*scale0 );\n#endif\ngl_Position=projectionMatrix*modelViewMatrix*vec4( transformed,1.0 );vIdColor=idColor;}",delayMarkerFragmentShader="uniform float base;varying float vIntensity;void main() {vec3 color=mix( vec3( base ),vec3( 1.0,0.6,0.0 ),vIntensity );gl_FragColor=vec4( color,1.0 );}",delayMarkerVertexShader="uniform float zoom;uniform float cameraZ;uniform float modelScale;uniform sampler2D textureData0;uniform sampler2D textureData1;attribute int instanceID;float getScale( float zoom,float modelScale) {return pow( 2.0,14.0-clamp( zoom,13.0,19.0 ) )*modelScale*100.0;}varying float vIntensity;void main() {int width=textureSize( textureData0,0 ).x;ivec2 reference=ivec2( instanceID % width,instanceID/width );vec4 data0=texelFetch( textureData0,reference,0 );vec4 data1=texelFetch( textureData1,reference,0 );vec3 translation=data0.xyz;float opacity0=data1.w;float delay=1.0;float zoom0=zoom+log2( cameraZ/abs( cameraZ-translation.z ) );float scale=getScale( zoom0,modelScale );vec3 transformed=position*scale+translation+vec3( 0.0,0.0,0.44*scale );gl_Position=projectionMatrix*modelViewMatrix*vec4( transformed,delay );vec3 vNormal=normalize( normalMatrix*normal );vec3 vNormel=normalize( vec3( modelViewMatrix*vec4( transformed,1.0 ) ) );vIntensity=( 1.0+dot( vNormal,vNormel ) )*opacity0;}";class MeshSet{constructor(e,t,i){const n=this,r="CAR"===e?new CarGeometry(.88,1.76,.88):"AIRCRAFT"===e?new AircraftGeometry(.88,2.64,.88,.1):new BoxGeometry(.6,1.2,.6),o="CAR"===e?new BoxGeometry(.88,1.76,.88):void 0,s=n.uniforms={zoom:{value:i.zoom},cameraZ:{value:i.cameraZ},modelScale:{value:i.modelScale},textureData0:{value:null},textureData1:{value:null},textureColor:{value:null}},a=n.geometry=new InstancedGeometry(r,t),l=n.material=new MeshLambertMaterial({transparent:!0});l.onBeforeCompile=t=>{Object.assign(t.uniforms,s),t.vertexShader=t.vertexShader.replace("#include <common>",commonVertexShaderChunk).replace("#include <color_vertex>",colorVertexShaderChunk).replace("#include <beginnormal_vertex>",beginnormalVertexShaderChunk).replace("#include <begin_vertex>",beginVertexShaderChunk),t.fragmentShader=t.fragmentShader.replace("#include <common>",commonFragmentShaderChunk).replace("vec4 diffuseColor = vec4( diffuse, opacity );",diffuseColorFragmentShaderChunk),t.defines={[e]:!0}},l.customProgramCacheKey=()=>e;const c=n.mesh=new Mesh(a,l);c.updateMatrix(),c.matrixAutoUpdate=!1,c.frustumCulled=!1;const u=n.pickingMaterial=new ShaderMaterial({uniforms:s,vertexShader:pickingVertexShader,fragmentShader:pickingFragmentShader,defines:{[e]:!0}}),h=n.pickingMesh=new Mesh(a,u);h.updateMatrix(),h.matrixAutoUpdate=!1,h.frustumCulled=!1;const d=n.outlineGeometry=new InstancedGeometry(o||r,2),p=n.outlineMaterial=new ShaderMaterial({uniforms:Object.assign({},s,{marked:{value:-1},tracked:{value:-1},intensity:{value:0}}),vertexShader:outlineVertexShader,fragmentShader:outlineFragmentShader,defines:{[e]:!0},transparent:!0,side:BackSide}),f=n.outlineMesh=new Mesh(d,p);if(f.updateMatrix(),f.matrixAutoUpdate=!1,f.frustumCulled=!1,r.dispose(),o&&o.dispose(),"CAR"===e){const e=new SphereGeometry(1.8,32,32),i=n.delayMarkerGeometry=new InstancedGeometry(e,t),r=n.delayMarkerMaterial=new ShaderMaterial({uniforms:Object.assign({},s,{base:{value:1}}),vertexShader:delayMarkerVertexShader,fragmentShader:delayMarkerFragmentShader,blending:MultiplyBlending,premultipliedAlpha:!0,depthWrite:!1}),o=n.delayMarkerMesh=new Mesh(i,r);o.updateMatrix(),o.matrixAutoUpdate=!1,o.frustumCulled=!1,e.dispose()}}getMesh(){return this.mesh}getPickingMesh(){return this.pickingMesh}getOutlineMesh(){return this.outlineMesh}getDelayMarkerMesh(){return this.delayMarkerMesh}refreshCameraParams(e){const t=this.uniforms;t.zoom.value=e.zoom,t.cameraZ.value=e.cameraZ}setTextures(e){const t=this.uniforms;t.textureData0.value=e[0],t.textureData1.value=e[1],t.textureColor.value=e[2],this.outlineMaterial.uniforms.intensity.value=blink()}setInstanceIDs(e){const t=this,i=t.delayMarkerGeometry;t.geometry.setInstanceIDs(e.body),t.outlineGeometry.setInstanceIDs(e.outline),i&&i.setInstanceIDs(e.delayMarker)}setMarkedInstanceID(e){this.outlineMaterial.uniforms.marked.value=e}setTrackedInstanceID(e){this.outlineMaterial.uniforms.tracked.value=e}refreshDelayMarkerMesh(e){const{delayMarkerMaterial:t,delayMarkerMesh:i}=this;t&&(t.uniforms.base.value=e?0:1),i&&(i.material.blending=e?AdditiveBlending:MultiplyBlending)}dispose(){const e=this,{delayMarkerGeometry:t,delayMarkerMaterial:i}=e;e.geometry.dispose(),e.material.dispose(),e.pickingMaterial.dispose(),e.outlineGeometry.dispose(),e.outlineMaterial.dispose(),t&&t.dispose(),i&&i.dispose()}}const MAX_UG_CARS=1e3,MAX_OG_CARS=2500,MAX_AIRCRAFTS=200,MAX_BUSES=4e3;class TrafficLayer{constructor(e){const t=this;t.id=e.id,t.type="three",t.lightColor="white",t.objects=new Map,t.onCameraChanged=t.onCameraChanged.bind(t)}onAdd(e,t){const i=this,n=t.scene,r=e.getModelOrigin(),o=t.renderer.capabilities.maxTextureSize,s={zoom:e.getZoom(),cameraZ:e.map.getFreeCameraOptions().position.z,modelScale:e.getModelScale()};i.map=e,i.context=t,i.computeRenderer=new ComputeRenderer(MAX_UG_CARS+MAX_OG_CARS+MAX_AIRCRAFTS+MAX_BUSES,{modelOrigin:r,chunkSize:o});const a=i.ugCarMeshSet=new MeshSet("CAR",MAX_UG_CARS,s),l=i.ogCarMeshSet=new MeshSet("CAR",MAX_OG_CARS,s),c=i.aircraftMeshSet=new MeshSet("AIRCRAFT",MAX_AIRCRAFTS,s),u=i.busMeshSet=new MeshSet("BUS",MAX_BUSES,s);n.add(a.getMesh()),n.add(l.getMesh()),n.add(c.getMesh()),n.add(u.getMesh()),n.add(a.getDelayMarkerMesh()),n.add(l.getDelayMarkerMesh()),n.add(a.getOutlineMesh()),n.add(l.getOutlineMesh()),n.add(c.getOutlineMesh()),n.add(u.getOutlineMesh());const h=i.ugPickingScene=new Scene;h.background=new Color(16777215),h.add(a.getPickingMesh());const d=i.ogPickingScene=new Scene;d.background=new Color(16777215),d.add(l.getPickingMesh()),d.add(c.getPickingMesh()),d.add(u.getPickingMesh()),i.pickingTexture=new WebGLRenderTarget(1,1),i.pixelBuffer=new Uint8Array(4),i.animationID=animation.start({callback:()=>{i.needsUpdateInstances=!0},frameRate:1}),e.on("zoom",i.onCameraChanged),e.on("pitch",i.onCameraChanged)}onRemove(e){const t=this;t.computeRenderer.dispose(),t.ugCarMeshSet.dispose(),t.ogCarMeshSet.dispose(),t.aircraftMeshSet.dispose(),t.busMeshSet.dispose(),t.pickingTexture.dispose(),animation.stop(t.animationID),e.off("zoom",t.onCameraChanged),e.off("pitch",t.onCameraChanged)}prerender(e,t){const i=this,n=i.computeRenderer.compute(t,e.layerZoom);if(i.ugCarMeshSet.setTextures(n),i.ogCarMeshSet.setTextures(n),i.aircraftMeshSet.setTextures(n),i.busMeshSet.setTextures(n),i.needsUpdateInstances){const[e,n,r,o]=i.computeRenderer.getInstanceIDs(t);i.ugCarMeshSet.setInstanceIDs(e),i.ogCarMeshSet.setInstanceIDs(n),i.aircraftMeshSet.setInstanceIDs(r),i.busMeshSet.setInstanceIDs(o),delete i.needsUpdateInstances}}onCameraChanged(){const e=this,t=e.map,i={zoom:t.getZoom(),cameraZ:t.map.getFreeCameraOptions().position.z};e.ugCarMeshSet.refreshCameraParams(i),e.ogCarMeshSet.refreshCameraParams(i),e.aircraftMeshSet.refreshCameraParams(i),e.busMeshSet.refreshCameraParams(i)}setMode(e,t){const i=this,n=i.computeRenderer.getOpacity();let r,o;"none"!==t&&"edit"!==t?r=o=.1:"underground"===e?(r=.9,o=.225):(r=.225,o=.9),animation.start({callback:(e,t)=>{i.computeRenderer.setOpacity({ground:lerp$5(n.ground,o,e/t),underground:lerp$5(n.underground,r,e/t)}),i.refreshDelayMarkers(!0)},duration:configs.transitionDuration})}addRouteGroup(e){return this.computeRenderer.addRouteGroup(e)}removeRouteGroup(e){this.computeRenderer.removeRouteGroup(e)}addColorGroup(e){return this.computeRenderer.addColorGroup(e)}removeColorGroup(e){this.computeRenderer.removeColorGroup(e)}addObject(e){const t=this;let i,n,r,o,s,a;if("train"===e.type){const{id:l,r:c,v:u,ad:h}=e;i=0,n=t.computeRenderer.getRouteIndex(c.id),h&&h.color?(e.colorGroupIndex=t.computeRenderer.addColorGroup([{id:l,color:h.color}]),r=t.computeRenderer.getColorIndex(l)):r=t.computeRenderer.getColorIndex(u?u.id:c.id),o=e.sectionIndex,s=o+e.sectionLength,a=e.delay?1:0}else if("flight"===e.type){const{a:a,feature:l}=e;i=1,n=t.computeRenderer.getRouteIndex(l.properties.id),r=t.computeRenderer.getColorIndex(a.id),o=0,s=1}else{const{gtfsId:a,feature:l,offsets:c}=e;i=2,n=t.computeRenderer.getRouteIndex(`${a}.${l.properties.id}`),r=t.computeRenderer.getColorIndex(a),o=c[e.sectionIndex],s=c[e.sectionIndex+e.sectionLength]}const l=e.instanceID=t.computeRenderer.addInstance(i,n,r,o,s,a);t.objects.set(l,e),Object.assign(e,t.getObjectPosition(e)),t.needsUpdateInstances=!0}updateObject(e,t,i,n,r,o,s){const a=this;let l,c;if("train"===e.type)l=e.sectionIndex,c=l+e.sectionLength;else if("flight"===e.type)l=0,c=1;else{const t=e.offsets;l=t[e.sectionIndex],c=t[e.sectionIndex+e.sectionLength]}a.computeRenderer.updateInstance(e.instanceID,l,c,t,i,n,r,o,s),Object.assign(e,a.getObjectPosition(e)),a.needsUpdateInstances=!0}getObjectPosition(e){return this.computeRenderer.getInstancePosition(e.instanceID)}removeObject(e){const t=this,{instanceID:i,colorGroupIndex:n}=e;return void 0!==i?(t.objects.delete(i),delete e.instanceID,t.computeRenderer.removeInstance(i).then((()=>{void 0!==n&&(t.computeRenderer.removeColorGroup(n),delete e.colorGroupIndex),t.needsUpdateInstances=!0}))):Promise.resolve()}pickObject(e,t){const i=this,{pickingTexture:n,pixelBuffer:r}=i,{renderer:o,camera:s}=i.context,a=o.getContext(),l=window.devicePixelRatio,c="underground"===e?i.ugPickingScene:i.ogPickingScene;return s.setViewOffset(a.drawingBufferWidth,a.drawingBufferHeight,t.x*l|0,t.y*l|0,1,1),o.resetState(),o.setRenderTarget(n),o.render(c,s),o.setRenderTarget(null),o.resetState(),s.clearViewOffset(),o.readRenderTargetPixels(n,0,0,1,1,r),i.objects.get(r[0]<<16|r[1]<<8|r[2])}refreshDelayMarkers(e){const t=this,i=hasDarkBackground(t.map.map,e);t.ugCarMeshSet.refreshDelayMarkerMesh(i),t.ogCarMeshSet.refreshDelayMarkerMesh(i)}setTimeOffset(e){this.computeRenderer.setTimeOffset(e)}markObject(e){const t=this,i=e?e.instanceID:-1;t.computeRenderer.setMarked(i),t.ugCarMeshSet.setMarkedInstanceID(i),t.ogCarMeshSet.setMarkedInstanceID(i),t.aircraftMeshSet.setMarkedInstanceID(i),t.busMeshSet.setMarkedInstanceID(i),t.needsUpdateInstances=!0}trackObject(e){const t=this,i=e?e.instanceID:-1;t.computeRenderer.setTracked(i),t.ugCarMeshSet.setTrackedInstanceID(i),t.ogCarMeshSet.setTrackedInstanceID(i),t.aircraftMeshSet.setTrackedInstanceID(i),t.busMeshSet.setTrackedInstanceID(i),t.needsUpdateInstances=!0}project(e,t){const{map:i,context:n}=this,{width:r,height:o}=i.map.transform,{x:s,y:a,z:l}=i.getModelPosition(e,t),{x:c,y:u}=new Vector3(s,a,l).project(n.camera);return new mapboxGlExports.Point((c+1)/2*r,(1-u)/2*o)}}
/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const proxyMarker=Symbol("Comlink.proxy"),createEndpoint=Symbol("Comlink.endpoint"),releaseProxy=Symbol("Comlink.releaseProxy"),finalizer=Symbol("Comlink.finalizer"),throwMarker=Symbol("Comlink.thrown"),isObject$2=e=>"object"==typeof e&&null!==e||"function"==typeof e,proxyTransferHandler={canHandle:e=>isObject$2(e)&&e[proxyMarker],serialize(e){const{port1:t,port2:i}=new MessageChannel;return expose(e,t),[i,[i]]},deserialize:e=>(e.start(),wrap(e))},throwTransferHandler={canHandle:e=>isObject$2(e)&&throwMarker in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}},transferHandlers=new Map([["proxy",proxyTransferHandler],["throw",throwTransferHandler]]);function isAllowedOrigin(e,t){for(const i of e){if(t===i||"*"===i)return!0;if(i instanceof RegExp&&i.test(t))return!0}return!1}function expose(e,t=globalThis,i=["*"]){t.addEventListener("message",(function n(r){if(!r||!r.data)return;if(!isAllowedOrigin(i,r.origin))return void console.warn(`Invalid origin '${r.origin}' for comlink proxy`);const{id:o,type:s,path:a}=Object.assign({path:[]},r.data),l=(r.data.argumentList||[]).map(fromWireValue);let c;try{const t=a.slice(0,-1).reduce(((e,t)=>e[t]),e),i=a.reduce(((e,t)=>e[t]),e);switch(s){case"GET":c=i;break;case"SET":t[a.slice(-1)[0]]=fromWireValue(r.data.value),c=!0;break;case"APPLY":c=i.apply(t,l);break;case"CONSTRUCT":c=proxy(new i(...l));break;case"ENDPOINT":{const{port1:t,port2:i}=new MessageChannel;expose(e,i),c=transfer(t,[t])}break;case"RELEASE":c=void 0;break;default:return}}catch(e){c={value:e,[throwMarker]:0}}Promise.resolve(c).catch((e=>({value:e,[throwMarker]:0}))).then((i=>{const[r,a]=toWireValue(i);t.postMessage(Object.assign(Object.assign({},r),{id:o}),a),"RELEASE"===s&&(t.removeEventListener("message",n),closeEndPoint(t),finalizer in e&&"function"==typeof e[finalizer]&&e[finalizer]())})).catch((e=>{const[i,n]=toWireValue({value:new TypeError("Unserializable return value"),[throwMarker]:0});t.postMessage(Object.assign(Object.assign({},i),{id:o}),n)}))})),t.start&&t.start()}function isMessagePort(e){return"MessagePort"===e.constructor.name}function closeEndPoint(e){isMessagePort(e)&&e.close()}function wrap(e,t){const i=new Map;return e.addEventListener("message",(function(e){const{data:t}=e;if(!t||!t.id)return;const n=i.get(t.id);if(n)try{n(t)}finally{i.delete(t.id)}})),createProxy(e,i,[],t)}function throwIfProxyReleased(e){if(e)throw new Error("Proxy has been released and is not useable")}function releaseEndpoint(e){return requestResponseMessage(e,new Map,{type:"RELEASE"}).then((()=>{closeEndPoint(e)}))}const proxyCounter=new WeakMap,proxyFinalizers="FinalizationRegistry"in globalThis&&new FinalizationRegistry((e=>{const t=(proxyCounter.get(e)||0)-1;proxyCounter.set(e,t),0===t&&releaseEndpoint(e)}));function registerProxy(e,t){const i=(proxyCounter.get(t)||0)+1;proxyCounter.set(t,i),proxyFinalizers&&proxyFinalizers.register(e,t,e)}function unregisterProxy(e){proxyFinalizers&&proxyFinalizers.unregister(e)}function createProxy(e,t,i=[],n=function(){}){let r=!1;const o=new Proxy(n,{get(n,s){if(throwIfProxyReleased(r),s===releaseProxy)return()=>{unregisterProxy(o),releaseEndpoint(e),t.clear(),r=!0};if("then"===s){if(0===i.length)return{then:()=>o};const n=requestResponseMessage(e,t,{type:"GET",path:i.map((e=>e.toString()))}).then(fromWireValue);return n.then.bind(n)}return createProxy(e,t,[...i,s])},set(n,o,s){throwIfProxyReleased(r);const[a,l]=toWireValue(s);return requestResponseMessage(e,t,{type:"SET",path:[...i,o].map((e=>e.toString())),value:a},l).then(fromWireValue)},apply(n,o,s){throwIfProxyReleased(r);const a=i[i.length-1];if(a===createEndpoint)return requestResponseMessage(e,t,{type:"ENDPOINT"}).then(fromWireValue);if("bind"===a)return createProxy(e,t,i.slice(0,-1));const[l,c]=processArguments(s);return requestResponseMessage(e,t,{type:"APPLY",path:i.map((e=>e.toString())),argumentList:l},c).then(fromWireValue)},construct(n,o){throwIfProxyReleased(r);const[s,a]=processArguments(o);return requestResponseMessage(e,t,{type:"CONSTRUCT",path:i.map((e=>e.toString())),argumentList:s},a).then(fromWireValue)}});return registerProxy(o,e),o}function myFlat(e){return Array.prototype.concat.apply([],e)}function processArguments(e){const t=e.map(toWireValue);return[t.map((e=>e[0])),myFlat(t.map((e=>e[1])))]}const transferCache=new WeakMap;function transfer(e,t){return transferCache.set(e,t),e}function proxy(e){return Object.assign(e,{[proxyMarker]:!0})}function toWireValue(e){for(const[t,i]of transferHandlers)if(i.canHandle(e)){const[n,r]=i.serialize(e);return[{type:"HANDLER",name:t,value:n},r]}return[{type:"RAW",value:e},transferCache.get(e)||[]]}function fromWireValue(e){switch(e.type){case"HANDLER":return transferHandlers.get(e.name).deserialize(e.value);case"RAW":return e.value}}function requestResponseMessage(e,t,i,n){return new Promise((r=>{const o=generateUUID();t.set(o,r),e.start&&e.start(),e.postMessage(Object.assign({id:o},i),n)}))}function generateUUID(){return new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-")}var geobuf$1={},encode_1,hasRequiredEncode,decode_1,hasRequiredDecode,hasRequiredGeobuf;function requireEncode(){if(hasRequiredEncode)return encode_1;hasRequiredEncode=1,encode_1=function(s,l){e={},i=[],t=0,n=0,r=1,a(s),r=Math.min(r,o);for(var c=Math.ceil(Math.log(r)/Math.LN10),u=0;u<i.length;u++)l.writeStringField(1,i[u]);2!==n&&l.writeVarintField(2,n);6!==c&&l.writeVarintField(3,c);"FeatureCollection"===s.type?l.writeMessage(4,d,s):"Feature"===s.type?l.writeMessage(5,p,s):l.writeMessage(6,f,s);return e=null,l.finish()};var e,t,i,n,r,o=1e6,s={Point:0,MultiPoint:1,LineString:2,MultiLineString:3,Polygon:4,MultiPolygon:5,GeometryCollection:6};function a(e){var t,i;if("FeatureCollection"===e.type)for(t=0;t<e.features.length;t++)a(e.features[t]);else if("Feature"===e.type)for(i in null!==e.geometry&&a(e.geometry),e.properties)h(i);else if("Point"===e.type)u(e.coordinates);else if("MultiPoint"===e.type)c(e.coordinates);else if("GeometryCollection"===e.type)for(t=0;t<e.geometries.length;t++)a(e.geometries[t]);else if("LineString"===e.type)c(e.coordinates);else if("Polygon"===e.type||"MultiLineString"===e.type)l(e.coordinates);else if("MultiPolygon"===e.type)for(t=0;t<e.coordinates.length;t++)l(e.coordinates[t]);for(i in e)x(i,e.type)||h(i)}function l(e){for(var t=0;t<e.length;t++)c(e[t])}function c(e){for(var t=0;t<e.length;t++)u(e[t])}function u(e){n=Math.max(n,e.length);for(var t=0;t<e.length;t++)for(;Math.round(e[t]*r)/r!==e[t]&&r<o;)r*=10}function h(n){void 0===e[n]&&(i.push(n),e[n]=t++)}function d(e,t){for(var i=0;i<e.features.length;i++)t.writeMessage(1,p,e.features[i]);m(e,t,!0)}function p(e,t){null!==e.geometry&&t.writeMessage(1,f,e.geometry),void 0!==e.id&&("number"==typeof e.id&&e.id%1==0?t.writeSVarintField(12,e.id):t.writeStringField(11,e.id)),e.properties&&m(e.properties,t),m(e,t,!0)}function f(e,t){t.writeVarintField(1,s[e.type]);var i=e.coordinates;if("Point"===e.type)!function(e,t){for(var i=[],o=0;o<n;o++)i.push(Math.round(e[o]*r));t.writePackedSVarint(3,i)}(i,t);else if("MultiPoint"===e.type)_(i,t);else if("LineString"===e.type)_(i,t);else if("MultiLineString"===e.type)y(i,t);else if("Polygon"===e.type)y(i,t,!0);else if("MultiPolygon"===e.type)!function(e,t){var i,n,r=e.length;if(1!==r||1!==e[0].length){var o=[r];for(i=0;i<r;i++)for(o.push(e[i].length),n=0;n<e[i].length;n++)o.push(e[i][n].length-1);t.writePackedVarint(2,o)}var s=[];for(i=0;i<r;i++)for(n=0;n<e[i].length;n++)v(s,e[i][n],!0);t.writePackedSVarint(3,s)}(i,t);else if("GeometryCollection"===e.type)for(var o=0;o<e.geometries.length;o++)t.writeMessage(4,f,e.geometries[o]);m(e,t,!0)}function m(t,i,n){var r=[],o=0;for(var s in t)n&&x(s,t.type)||(i.writeMessage(13,g,t[s]),r.push(e[s]),r.push(o++));i.writePackedVarint(n?15:14,r)}function g(e,t){if(null!==e){var i=typeof e;"string"===i?t.writeStringField(1,e):"boolean"===i?t.writeBooleanField(5,e):"object"===i?t.writeStringField(6,JSON.stringify(e)):"number"===i&&(e%1!=0?t.writeDoubleField(2,e):e>=0?t.writeVarintField(3,e):t.writeVarintField(4,-e))}}function _(e,t){var i=[];v(i,e),t.writePackedSVarint(3,i)}function y(e,t,i){var n,r=e.length;if(1!==r){var o=[];for(n=0;n<r;n++)o.push(e[n].length-(i?1:0));t.writePackedVarint(2,o)}var s=[];for(n=0;n<r;n++)v(s,e[n],i);t.writePackedSVarint(3,s)}function v(e,t,i){var o,s,a=t.length-(i?1:0),l=new Array(n);for(s=0;s<n;s++)l[s]=0;for(o=0;o<a;o++)for(s=0;s<n;s++){var c=Math.round(t[o][s]*r)-l[s];e.push(c),l[s]+=c}}function x(e,t){if("type"===e)return!0;if("FeatureCollection"===t){if("features"===e)return!0}else if("Feature"===t){if("id"===e||"properties"===e||"geometry"===e)return!0}else if("GeometryCollection"===t){if("geometries"===e)return!0}else if("coordinates"===e)return!0;return!1}return encode_1}function requireDecode(){if(hasRequiredDecode)return decode_1;var e,t,i,n,r;hasRequiredDecode=1;var o=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeometryCollection"];function s(t,i,o){1===t?e.push(o.readString()):2===t?n=o.readVarint():3===t?r=Math.pow(10,o.readVarint()):4===t?function(e,t){t.type="FeatureCollection",t.features=[],e.readMessage(c,t)}(o,i):5===t?a(o,i):6===t&&l(o,i)}function a(e,t){t.type="Feature";var i=e.readMessage(u,t);return"geometry"in i||(i.geometry=null),i}function l(e,t){return t.type="Point",e.readMessage(h,t)}function c(e,i,n){1===e?i.features.push(a(n,{})):13===e?t.push(d(n)):15===e&&p(n,i)}function u(e,i,n){1===e?i.geometry=l(n,{}):11===e?i.id=n.readString():12===e?i.id=n.readSVarint():13===e?t.push(d(n)):14===e?i.properties=p(n,{}):15===e&&p(n,i)}function h(e,n,s){1===e?n.type=o[s.readVarint()]:2===e?i=s.readPackedVarint():3===e?function(e,t,n){"Point"===n?e.coordinates=function(e){var t=e.readVarint()+e.pos,i=[];for(;e.pos<t;)i.push(e.readSVarint()/r);return i}(t):"MultiPoint"===n||"LineString"===n?e.coordinates=m(t):"MultiLineString"===n?e.coordinates=g(t):"Polygon"===n?e.coordinates=g(t,!0):"MultiPolygon"===n&&(e.coordinates=function(e){var t=e.readVarint()+e.pos;if(!i)return[[f(e,t,null,!0)]];for(var n=[],r=1,o=0;o<i[0];o++){for(var s=[],a=0;a<i[r];a++)s.push(f(e,t,i[r+1+a],!0));r+=i[r]+1,n.push(s)}return i=null,n}(t))}(n,s,n.type):4===e?(n.geometries=n.geometries||[],n.geometries.push(l(s,{}))):13===e?t.push(d(s)):15===e&&p(s,n)}function d(e){for(var t=e.readVarint()+e.pos,i=null;e.pos<t;){var n=e.readVarint()>>3;1===n?i=e.readString():2===n?i=e.readDouble():3===n?i=e.readVarint():4===n?i=-e.readVarint():5===n?i=e.readBoolean():6===n&&(i=JSON.parse(e.readString()))}return i}function p(i,n){for(var r=i.readVarint()+i.pos;i.pos<r;)n[e[i.readVarint()]]=t[i.readVarint()];return t=[],n}function f(e,t,i,o){var s,a,l=0,c=[],u=[];for(a=0;a<n;a++)u[a]=0;for(;i?l<i:e.pos<t;){for(s=[],a=0;a<n;a++)u[a]+=e.readSVarint(),s[a]=u[a]/r;c.push(s),l++}return o&&c.push(c[0]),c}function m(e){return f(e,e.readVarint()+e.pos)}function g(e,t){var n=e.readVarint()+e.pos;if(!i)return[f(e,n,null,t)];for(var r=[],o=0;o<i.length;o++)r.push(f(e,n,i[o],t));return i=null,r}return decode_1=function(o){n=2,r=Math.pow(10,6),i=null,e=[],t=[];var a=o.readFields(s,{});return e=null,a}}function requireGeobuf(){return hasRequiredGeobuf||(hasRequiredGeobuf=1,geobuf$1.encode=requireEncode(),geobuf$1.decode=requireDecode()),geobuf$1}var geobufExports=requireGeobuf(),geobuf=getDefaultExportFromCjs(geobufExports),indexMinimal={},minimal$1={},aspromise,hasRequiredAspromise;function requireAspromise(){if(hasRequiredAspromise)return aspromise;return hasRequiredAspromise=1,aspromise=function(e,t){var i=new Array(arguments.length-1),n=0,r=2,o=!0;for(;r<arguments.length;)i[n++]=arguments[r++];return new Promise((function(r,s){i[n]=function(e){if(o)if(o=!1,e)s(e);else{for(var t=new Array(arguments.length-1),i=0;i<t.length;)t[i++]=arguments[i];r.apply(null,t)}};try{e.apply(t||null,i)}catch(e){o&&(o=!1,s(e))}}))},aspromise}var base64={},hasRequiredBase64,eventemitter,hasRequiredEventemitter,float,hasRequiredFloat,inquire_1,hasRequiredInquire;function requireBase64(){return hasRequiredBase64||(hasRequiredBase64=1,function(e){var t=e;t.length=function(e){var t=e.length;if(!t)return 0;for(var i=0;--t%4>1&&"="===e.charAt(t);)++i;return Math.ceil(3*e.length)/4-i};for(var i=new Array(64),n=new Array(123),r=0;r<64;)n[i[r]=r<26?r+65:r<52?r+71:r<62?r-4:r-59|43]=r++;t.encode=function(e,t,n){for(var r,o=null,s=[],a=0,l=0;t<n;){var c=e[t++];switch(l){case 0:s[a++]=i[c>>2],r=(3&c)<<4,l=1;break;case 1:s[a++]=i[r|c>>4],r=(15&c)<<2,l=2;break;case 2:s[a++]=i[r|c>>6],s[a++]=i[63&c],l=0}a>8191&&((o||(o=[])).push(String.fromCharCode.apply(String,s)),a=0)}return l&&(s[a++]=i[r],s[a++]=61,1===l&&(s[a++]=61)),o?(a&&o.push(String.fromCharCode.apply(String,s.slice(0,a))),o.join("")):String.fromCharCode.apply(String,s.slice(0,a))};var o="invalid encoding";t.decode=function(e,t,i){for(var r,s=i,a=0,l=0;l<e.length;){var c=e.charCodeAt(l++);if(61===c&&a>1)break;if(void 0===(c=n[c]))throw Error(o);switch(a){case 0:r=c,a=1;break;case 1:t[i++]=r<<2|(48&c)>>4,r=c,a=2;break;case 2:t[i++]=(15&r)<<4|(60&c)>>2,r=c,a=3;break;case 3:t[i++]=(3&r)<<6|c,a=0}}if(1===a)throw Error(o);return i-s},t.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}}(base64)),base64}function requireEventemitter(){if(hasRequiredEventemitter)return eventemitter;function e(){this._listeners={}}return hasRequiredEventemitter=1,eventemitter=e,e.prototype.on=function(e,t,i){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:i||this}),this},e.prototype.off=function(e,t){if(void 0===e)this._listeners={};else if(void 0===t)this._listeners[e]=[];else for(var i=this._listeners[e],n=0;n<i.length;)i[n].fn===t?i.splice(n,1):++n;return this},e.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var i=[],n=1;n<arguments.length;)i.push(arguments[n++]);for(n=0;n<t.length;)t[n].fn.apply(t[n++].ctx,i)}return this},eventemitter}function requireFloat(){if(hasRequiredFloat)return float;function e(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),i=new Uint8Array(t.buffer),n=128===i[3];function r(e,n,r){t[0]=e,n[r]=i[0],n[r+1]=i[1],n[r+2]=i[2],n[r+3]=i[3]}function o(e,n,r){t[0]=e,n[r]=i[3],n[r+1]=i[2],n[r+2]=i[1],n[r+3]=i[0]}function s(e,n){return i[0]=e[n],i[1]=e[n+1],i[2]=e[n+2],i[3]=e[n+3],t[0]}function a(e,n){return i[3]=e[n],i[2]=e[n+1],i[1]=e[n+2],i[0]=e[n+3],t[0]}e.writeFloatLE=n?r:o,e.writeFloatBE=n?o:r,e.readFloatLE=n?s:a,e.readFloatBE=n?a:s}():function(){function o(e,t,i,n){var r=t<0?1:0;if(r&&(t=-t),0===t)e(1/t>0?0:2147483648,i,n);else if(isNaN(t))e(2143289344,i,n);else if(t>34028234663852886e22)e((r<<31|2139095040)>>>0,i,n);else if(t<11754943508222875e-54)e((r<<31|Math.round(t/1401298464324817e-60))>>>0,i,n);else{var o=Math.floor(Math.log(t)/Math.LN2);e((r<<31|o+127<<23|8388607&Math.round(t*Math.pow(2,-o)*8388608))>>>0,i,n)}}function s(e,t,i){var n=e(t,i),r=2*(n>>31)+1,o=n>>>23&255,s=8388607&n;return 255===o?s?NaN:r*(1/0):0===o?1401298464324817e-60*r*s:r*Math.pow(2,o-150)*(s+8388608)}e.writeFloatLE=o.bind(null,t),e.writeFloatBE=o.bind(null,i),e.readFloatLE=s.bind(null,n),e.readFloatBE=s.bind(null,r)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),i=new Uint8Array(t.buffer),n=128===i[7];function r(e,n,r){t[0]=e,n[r]=i[0],n[r+1]=i[1],n[r+2]=i[2],n[r+3]=i[3],n[r+4]=i[4],n[r+5]=i[5],n[r+6]=i[6],n[r+7]=i[7]}function o(e,n,r){t[0]=e,n[r]=i[7],n[r+1]=i[6],n[r+2]=i[5],n[r+3]=i[4],n[r+4]=i[3],n[r+5]=i[2],n[r+6]=i[1],n[r+7]=i[0]}function s(e,n){return i[0]=e[n],i[1]=e[n+1],i[2]=e[n+2],i[3]=e[n+3],i[4]=e[n+4],i[5]=e[n+5],i[6]=e[n+6],i[7]=e[n+7],t[0]}function a(e,n){return i[7]=e[n],i[6]=e[n+1],i[5]=e[n+2],i[4]=e[n+3],i[3]=e[n+4],i[2]=e[n+5],i[1]=e[n+6],i[0]=e[n+7],t[0]}e.writeDoubleLE=n?r:o,e.writeDoubleBE=n?o:r,e.readDoubleLE=n?s:a,e.readDoubleBE=n?a:s}():function(){function o(e,t,i,n,r,o){var s=n<0?1:0;if(s&&(n=-n),0===n)e(0,r,o+t),e(1/n>0?0:2147483648,r,o+i);else if(isNaN(n))e(0,r,o+t),e(2146959360,r,o+i);else if(n>17976931348623157e292)e(0,r,o+t),e((s<<31|2146435072)>>>0,r,o+i);else{var a;if(n<22250738585072014e-324)e((a=n/5e-324)>>>0,r,o+t),e((s<<31|a/4294967296)>>>0,r,o+i);else{var l=Math.floor(Math.log(n)/Math.LN2);1024===l&&(l=1023),e(4503599627370496*(a=n*Math.pow(2,-l))>>>0,r,o+t),e((s<<31|l+1023<<20|1048576*a&1048575)>>>0,r,o+i)}}}function s(e,t,i,n,r){var o=e(n,r+t),s=e(n,r+i),a=2*(s>>31)+1,l=s>>>20&2047,c=4294967296*(1048575&s)+o;return 2047===l?c?NaN:a*(1/0):0===l?5e-324*a*c:a*Math.pow(2,l-1075)*(c+4503599627370496)}e.writeDoubleLE=o.bind(null,t,0,4),e.writeDoubleBE=o.bind(null,i,4,0),e.readDoubleLE=s.bind(null,n,0,4),e.readDoubleBE=s.bind(null,r,4,0)}(),e}function t(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24}function i(e,t,i){t[i]=e>>>24,t[i+1]=e>>>16&255,t[i+2]=e>>>8&255,t[i+3]=255&e}function n(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function r(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}return hasRequiredFloat=1,float=e(e)}function requireInquire(){if(hasRequiredInquire)return inquire_1;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}return hasRequiredInquire=1,inquire_1=inquire,inquire_1}var utf8={},hasRequiredUtf8,pool_1,hasRequiredPool,longbits,hasRequiredLongbits,hasRequiredMinimal$1,writer,hasRequiredWriter,writer_buffer,hasRequiredWriter_buffer,reader,hasRequiredReader,reader_buffer,hasRequiredReader_buffer;function requireUtf8(){return hasRequiredUtf8||(hasRequiredUtf8=1,function(e){var t=e;t.length=function(e){for(var t=0,i=0,n=0;n<e.length;++n)(i=e.charCodeAt(n))<128?t+=1:i<2048?t+=2:55296==(64512&i)&&56320==(64512&e.charCodeAt(n+1))?(++n,t+=4):t+=3;return t},t.read=function(e,t,i){if(i-t<1)return"";for(var n,r=null,o=[],s=0;t<i;)(n=e[t++])<128?o[s++]=n:n>191&&n<224?o[s++]=(31&n)<<6|63&e[t++]:n>239&&n<365?(n=((7&n)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,o[s++]=55296+(n>>10),o[s++]=56320+(1023&n)):o[s++]=(15&n)<<12|(63&e[t++])<<6|63&e[t++],s>8191&&((r||(r=[])).push(String.fromCharCode.apply(String,o)),s=0);return r?(s&&r.push(String.fromCharCode.apply(String,o.slice(0,s))),r.join("")):String.fromCharCode.apply(String,o.slice(0,s))},t.write=function(e,t,i){for(var n,r,o=i,s=0;s<e.length;++s)(n=e.charCodeAt(s))<128?t[i++]=n:n<2048?(t[i++]=n>>6|192,t[i++]=63&n|128):55296==(64512&n)&&56320==(64512&(r=e.charCodeAt(s+1)))?(++s,t[i++]=(n=65536+((1023&n)<<10)+(1023&r))>>18|240,t[i++]=n>>12&63|128,t[i++]=n>>6&63|128,t[i++]=63&n|128):(t[i++]=n>>12|224,t[i++]=n>>6&63|128,t[i++]=63&n|128);return i-o}}(utf8)),utf8}function requirePool(){if(hasRequiredPool)return pool_1;return hasRequiredPool=1,pool_1=function(e,t,i){var n=i||8192,r=n>>>1,o=null,s=n;return function(i){if(i<1||i>r)return e(i);s+i>n&&(o=e(n),s=0);var a=t.call(o,s,s+=i);return 7&s&&(s=1+(7|s)),a}}}function requireLongbits(){if(hasRequiredLongbits)return longbits;hasRequiredLongbits=1,longbits=t;var e=requireMinimal$1();function t(e,t){this.lo=e>>>0,this.hi=t>>>0}var i=t.zero=new t(0,0);i.toNumber=function(){return 0},i.zzEncode=i.zzDecode=function(){return this},i.length=function(){return 1};var n=t.zeroHash="\0\0\0\0\0\0\0\0";t.fromNumber=function(e){if(0===e)return i;var n=e<0;n&&(e=-e);var r=e>>>0,o=(e-r)/4294967296>>>0;return n&&(o=~o>>>0,r=~r>>>0,++r>4294967295&&(r=0,++o>4294967295&&(o=0))),new t(r,o)},t.from=function(n){if("number"==typeof n)return t.fromNumber(n);if(e.isString(n)){if(!e.Long)return t.fromNumber(parseInt(n,10));n=e.Long.fromString(n)}return n.low||n.high?new t(n.low>>>0,n.high>>>0):i},t.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,i=~this.hi>>>0;return t||(i=i+1>>>0),-(t+4294967296*i)}return this.lo+4294967296*this.hi},t.prototype.toLong=function(t){return e.Long?new e.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var r=String.prototype.charCodeAt;return t.fromHash=function(e){return e===n?i:new t((r.call(e,0)|r.call(e,1)<<8|r.call(e,2)<<16|r.call(e,3)<<24)>>>0,(r.call(e,4)|r.call(e,5)<<8|r.call(e,6)<<16|r.call(e,7)<<24)>>>0)},t.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},t.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},t.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},t.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,i=this.hi>>>24;return 0===i?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:i<128?9:10},longbits}function requireMinimal$1(){return hasRequiredMinimal$1||(hasRequiredMinimal$1=1,function(e){var t=e;function i(e,t,i){for(var n=Object.keys(t),r=0;r<n.length;++r)void 0!==e[n[r]]&&i||(e[n[r]]=t[n[r]]);return e}function n(e){function t(e,n){if(!(this instanceof t))return new t(e,n);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),n&&i(this,n)}return t.prototype=Object.create(Error.prototype,{constructor:{value:t,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return e},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),t}t.asPromise=requireAspromise(),t.base64=requireBase64(),t.EventEmitter=requireEventemitter(),t.float=requireFloat(),t.inquire=requireInquire(),t.utf8=requireUtf8(),t.pool=requirePool(),t.LongBits=requireLongbits(),t.isNode=Boolean(void 0!==commonjsGlobal&&commonjsGlobal&&commonjsGlobal.process&&commonjsGlobal.process.versions&&commonjsGlobal.process.versions.node),t.global=t.isNode&&commonjsGlobal||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||minimal$1,t.emptyArray=Object.freeze?Object.freeze([]):[],t.emptyObject=Object.freeze?Object.freeze({}):{},t.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},t.isString=function(e){return"string"==typeof e||e instanceof String},t.isObject=function(e){return e&&"object"==typeof e},t.isset=t.isSet=function(e,t){var i=e[t];return!(null==i||!e.hasOwnProperty(t))&&("object"!=typeof i||(Array.isArray(i)?i.length:Object.keys(i).length)>0)},t.Buffer=function(){try{var e=t.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),t._Buffer_from=null,t._Buffer_allocUnsafe=null,t.newBuffer=function(e){return"number"==typeof e?t.Buffer?t._Buffer_allocUnsafe(e):new t.Array(e):t.Buffer?t._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},t.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,t.Long=t.global.dcodeIO&&t.global.dcodeIO.Long||t.global.Long||t.inquire("long"),t.key2Re=/^true|false|0|1$/,t.key32Re=/^-?(?:0|[1-9][0-9]*)$/,t.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,t.longToHash=function(e){return e?t.LongBits.from(e).toHash():t.LongBits.zeroHash},t.longFromHash=function(e,i){var n=t.LongBits.fromHash(e);return t.Long?t.Long.fromBits(n.lo,n.hi,i):n.toNumber(Boolean(i))},t.merge=i,t.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},t.newError=n,t.ProtocolError=n("ProtocolError"),t.oneOfGetter=function(e){for(var t={},i=0;i<e.length;++i)t[e[i]]=1;return function(){for(var e=Object.keys(this),i=e.length-1;i>-1;--i)if(1===t[e[i]]&&null!=this[e[i]])return e[i]}},t.oneOfSetter=function(e){return function(t){for(var i=0;i<e.length;++i)e[i]!==t&&delete this[e[i]]}},t.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},t._configure=function(){var e=t.Buffer;e?(t._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,i){return new e(t,i)},t._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):t._Buffer_from=t._Buffer_allocUnsafe=null}}(minimal$1)),minimal$1}function requireWriter(){if(hasRequiredWriter)return writer;hasRequiredWriter=1,writer=l;var e,t=requireMinimal$1(),i=t.LongBits,n=t.base64,r=t.utf8;function o(e,t,i){this.fn=e,this.len=t,this.next=void 0,this.val=i}function s(){}function a(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function l(){this.len=0,this.head=new o(s,0,0),this.tail=this.head,this.states=null}var c=function(){return t.Buffer?function(){return(l.create=function(){return new e})()}:function(){return new l}};function u(e,t,i){t[i]=255&e}function h(e,t){this.len=e,this.next=void 0,this.val=t}function d(e,t,i){for(;e.hi;)t[i++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[i++]=127&e.lo|128,e.lo=e.lo>>>7;t[i++]=e.lo}function p(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24}l.create=c(),l.alloc=function(e){return new t.Array(e)},t.Array!==Array&&(l.alloc=t.pool(l.alloc,t.Array.prototype.subarray)),l.prototype._push=function(e,t,i){return this.tail=this.tail.next=new o(e,t,i),this.len+=t,this},(h.prototype=Object.create(o.prototype)).fn=function(e,t,i){for(;e>127;)t[i++]=127&e|128,e>>>=7;t[i]=e},l.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new h((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},l.prototype.int32=function(e){return e<0?this._push(d,10,i.fromNumber(e)):this.uint32(e)},l.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},l.prototype.uint64=function(e){var t=i.from(e);return this._push(d,t.length(),t)},l.prototype.int64=l.prototype.uint64,l.prototype.sint64=function(e){var t=i.from(e).zzEncode();return this._push(d,t.length(),t)},l.prototype.bool=function(e){return this._push(u,1,e?1:0)},l.prototype.sfixed32=l.prototype.fixed32=function(e){return this._push(p,4,e>>>0)},l.prototype.fixed64=function(e){var t=i.from(e);return this._push(p,4,t.lo)._push(p,4,t.hi)},l.prototype.sfixed64=l.prototype.fixed64,l.prototype.float=function(e){return this._push(t.float.writeFloatLE,4,e)},l.prototype.double=function(e){return this._push(t.float.writeDoubleLE,8,e)};var f=t.Array.prototype.set?function(e,t,i){t.set(e,i)}:function(e,t,i){for(var n=0;n<e.length;++n)t[i+n]=e[n]};return l.prototype.bytes=function(e){var i=e.length>>>0;if(!i)return this._push(u,1,0);if(t.isString(e)){var r=l.alloc(i=n.length(e));n.decode(e,r,0),e=r}return this.uint32(i)._push(f,i,e)},l.prototype.string=function(e){var t=r.length(e);return t?this.uint32(t)._push(r.write,t,e):this._push(u,1,0)},l.prototype.fork=function(){return this.states=new a(this),this.head=this.tail=new o(s,0,0),this.len=0,this},l.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new o(s,0,0),this.len=0),this},l.prototype.ldelim=function(){var e=this.head,t=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=e.next,this.tail=t,this.len+=i),this},l.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),i=0;e;)e.fn(e.val,t,i),i+=e.len,e=e.next;return t},l._configure=function(t){e=t,l.create=c(),e._configure()},writer}function requireWriter_buffer(){if(hasRequiredWriter_buffer)return writer_buffer;hasRequiredWriter_buffer=1,writer_buffer=i;var e=requireWriter();(i.prototype=Object.create(e.prototype)).constructor=i;var t=requireMinimal$1();function i(){e.call(this)}function n(e,i,n){e.length<40?t.utf8.write(e,i,n):i.utf8Write?i.utf8Write(e,n):i.write(e,n)}return i._configure=function(){i.alloc=t._Buffer_allocUnsafe,i.writeBytesBuffer=t.Buffer&&t.Buffer.prototype instanceof Uint8Array&&"set"===t.Buffer.prototype.set.name?function(e,t,i){t.set(e,i)}:function(e,t,i){if(e.copy)e.copy(t,i,0,e.length);else for(var n=0;n<e.length;)t[i++]=e[n++]}},i.prototype.bytes=function(e){t.isString(e)&&(e=t._Buffer_from(e,"base64"));var n=e.length>>>0;return this.uint32(n),n&&this._push(i.writeBytesBuffer,n,e),this},i.prototype.string=function(e){var i=t.Buffer.byteLength(e);return this.uint32(i),i&&this._push(n,i,e),this},i._configure(),writer_buffer}function requireReader(){if(hasRequiredReader)return reader;hasRequiredReader=1,reader=o;var e,t=requireMinimal$1(),i=t.LongBits,n=t.utf8;function r(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function o(e){this.buf=e,this.pos=0,this.len=e.length}var s,a="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new o(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new o(e);throw Error("illegal buffer")},l=function(){return t.Buffer?function(i){return(o.create=function(i){return t.Buffer.isBuffer(i)?new e(i):a(i)})(i)}:a};function c(){var e=new i(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw r(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw r(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function u(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function h(){if(this.pos+8>this.len)throw r(this,8);return new i(u(this.buf,this.pos+=4),u(this.buf,this.pos+=4))}return o.create=l(),o.prototype._slice=t.Array.prototype.subarray||t.Array.prototype.slice,o.prototype.uint32=(s=4294967295,function(){if(s=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return s;if(s=(s|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return s;if(s=(s|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return s;if(s=(s|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return s;if(s=(s|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return s;if((this.pos+=5)>this.len)throw this.pos=this.len,r(this,10);return s}),o.prototype.int32=function(){return 0|this.uint32()},o.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)},o.prototype.bool=function(){return 0!==this.uint32()},o.prototype.fixed32=function(){if(this.pos+4>this.len)throw r(this,4);return u(this.buf,this.pos+=4)},o.prototype.sfixed32=function(){if(this.pos+4>this.len)throw r(this,4);return 0|u(this.buf,this.pos+=4)},o.prototype.float=function(){if(this.pos+4>this.len)throw r(this,4);var e=t.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},o.prototype.double=function(){if(this.pos+8>this.len)throw r(this,4);var e=t.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},o.prototype.bytes=function(){var e=this.uint32(),i=this.pos,n=this.pos+e;if(n>this.len)throw r(this,e);if(this.pos+=e,Array.isArray(this.buf))return this.buf.slice(i,n);if(i===n){var o=t.Buffer;return o?o.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,i,n)},o.prototype.string=function(){var e=this.bytes();return n.read(e,0,e.length)},o.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw r(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw r(this)}while(128&this.buf[this.pos++]);return this},o.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},o._configure=function(i){e=i,o.create=l(),e._configure();var n=t.Long?"toLong":"toNumber";t.merge(o.prototype,{int64:function(){return c.call(this)[n](!1)},uint64:function(){return c.call(this)[n](!0)},sint64:function(){return c.call(this).zzDecode()[n](!1)},fixed64:function(){return h.call(this)[n](!0)},sfixed64:function(){return h.call(this)[n](!1)}})},reader}function requireReader_buffer(){if(hasRequiredReader_buffer)return reader_buffer;hasRequiredReader_buffer=1,reader_buffer=i;var e=requireReader();(i.prototype=Object.create(e.prototype)).constructor=i;var t=requireMinimal$1();function i(t){e.call(this,t)}return i._configure=function(){t.Buffer&&(i.prototype._slice=t.Buffer.prototype.slice)},i.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))},i._configure(),reader_buffer}var rpc={},service,hasRequiredService,hasRequiredRpc,roots,hasRequiredRoots,hasRequiredIndexMinimal,minimal,hasRequiredMinimal,gtfsRealtime,hasRequiredGtfsRealtime;function requireService(){if(hasRequiredService)return service;hasRequiredService=1,service=t;var e=requireMinimal$1();function t(t,i,n){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");e.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(i),this.responseDelimited=Boolean(n)}return(t.prototype=Object.create(e.EventEmitter.prototype)).constructor=t,t.prototype.rpcCall=function t(i,n,r,o,s){if(!o)throw TypeError("request must be specified");var a=this;if(!s)return e.asPromise(t,a,i,n,r,o);if(a.rpcImpl)try{return a.rpcImpl(i,n[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),(function(e,t){if(e)return a.emit("error",e,i),s(e);if(null!==t){if(!(t instanceof r))try{t=r[a.responseDelimited?"decodeDelimited":"decode"](t)}catch(e){return a.emit("error",e,i),s(e)}return a.emit("data",t,i),s(null,t)}a.end(!0)}))}catch(e){return a.emit("error",e,i),void setTimeout((function(){s(e)}),0)}else setTimeout((function(){s(Error("already ended"))}),0)},t.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},service}function requireRpc(){return hasRequiredRpc||(hasRequiredRpc=1,rpc.Service=requireService()),rpc}function requireRoots(){return hasRequiredRoots?roots:(hasRequiredRoots=1,roots={})}function requireIndexMinimal(){return hasRequiredIndexMinimal||(hasRequiredIndexMinimal=1,function(e){var t=e;function i(){t.util._configure(),t.Writer._configure(t.BufferWriter),t.Reader._configure(t.BufferReader)}t.build="minimal",t.Writer=requireWriter(),t.BufferWriter=requireWriter_buffer(),t.Reader=requireReader(),t.BufferReader=requireReader_buffer(),t.util=requireMinimal$1(),t.rpc=requireRpc(),t.roots=requireRoots(),t.configure=i,i()}(indexMinimal)),indexMinimal}function requireMinimal(){return hasRequiredMinimal?minimal:(hasRequiredMinimal=1,minimal=requireIndexMinimal())}function requireGtfsRealtime(){if(hasRequiredGtfsRealtime)return gtfsRealtime;hasRequiredGtfsRealtime=1;var e,t=requireMinimal(),i=t.Reader,n=t.Writer,r=t.util,o=t.roots.default||(t.roots.default={});return o.transit_realtime=((e={}).FeedMessage=function(){function e(e){if(this.entity=[],e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.header=null,e.prototype.entity=r.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=n.create()),o.transit_realtime.FeedHeader.encode(e.header,t.uint32(10).fork()).ldelim(),null!=e.entity&&e.entity.length)for(var i=0;i<e.entity.length;++i)o.transit_realtime.FeedEntity.encode(e.entity[i],t.uint32(18).fork()).ldelim();return t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new o.transit_realtime.FeedMessage;e.pos<n;){var a=e.uint32();switch(a>>>3){case 1:s.header=o.transit_realtime.FeedHeader.decode(e,e.uint32());break;case 2:s.entity&&s.entity.length||(s.entity=[]),s.entity.push(o.transit_realtime.FeedEntity.decode(e,e.uint32()));break;default:e.skipType(7&a)}}if(!s.hasOwnProperty("header"))throw r.ProtocolError("missing required 'header'",{instance:s});return s},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(i=o.transit_realtime.FeedHeader.verify(e.header))return"header."+i;if(null!=e.entity&&e.hasOwnProperty("entity")){if(!Array.isArray(e.entity))return"entity: array expected";for(var t=0;t<e.entity.length;++t){var i;if(i=o.transit_realtime.FeedEntity.verify(e.entity[t]))return"entity."+i}}return null},e.fromObject=function(e){if(e instanceof o.transit_realtime.FeedMessage)return e;var t=new o.transit_realtime.FeedMessage;if(null!=e.header){if("object"!=typeof e.header)throw TypeError(".transit_realtime.FeedMessage.header: object expected");t.header=o.transit_realtime.FeedHeader.fromObject(e.header)}if(e.entity){if(!Array.isArray(e.entity))throw TypeError(".transit_realtime.FeedMessage.entity: array expected");t.entity=[];for(var i=0;i<e.entity.length;++i){if("object"!=typeof e.entity[i])throw TypeError(".transit_realtime.FeedMessage.entity: object expected");t.entity[i]=o.transit_realtime.FeedEntity.fromObject(e.entity[i])}}return t},e.toObject=function(e,t){t||(t={});var i={};if((t.arrays||t.defaults)&&(i.entity=[]),t.defaults&&(i.header=null),null!=e.header&&e.hasOwnProperty("header")&&(i.header=o.transit_realtime.FeedHeader.toObject(e.header,t)),e.entity&&e.entity.length){i.entity=[];for(var n=0;n<e.entity.length;++n)i.entity[n]=o.transit_realtime.FeedEntity.toObject(e.entity[n],t)}return i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.FeedMessage"},e}(),e.FeedHeader=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}var s,a;return e.prototype.gtfsRealtimeVersion="",e.prototype.incrementality=0,e.prototype.timestamp=r.Long?r.Long.fromBits(0,0,!0):0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),t.uint32(10).string(e.gtfsRealtimeVersion),null!=e.incrementality&&Object.hasOwnProperty.call(e,"incrementality")&&t.uint32(16).int32(e.incrementality),null!=e.timestamp&&Object.hasOwnProperty.call(e,"timestamp")&&t.uint32(24).uint64(e.timestamp),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new o.transit_realtime.FeedHeader;e.pos<n;){var a=e.uint32();switch(a>>>3){case 1:s.gtfsRealtimeVersion=e.string();break;case 2:s.incrementality=e.int32();break;case 3:s.timestamp=e.uint64();break;default:e.skipType(7&a)}}if(!s.hasOwnProperty("gtfsRealtimeVersion"))throw r.ProtocolError("missing required 'gtfsRealtimeVersion'",{instance:s});return s},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(!r.isString(e.gtfsRealtimeVersion))return"gtfsRealtimeVersion: string expected";if(null!=e.incrementality&&e.hasOwnProperty("incrementality"))switch(e.incrementality){default:return"incrementality: enum value expected";case 0:case 1:}return null!=e.timestamp&&e.hasOwnProperty("timestamp")&&!(r.isInteger(e.timestamp)||e.timestamp&&r.isInteger(e.timestamp.low)&&r.isInteger(e.timestamp.high))?"timestamp: integer|Long expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.FeedHeader)return e;var t=new o.transit_realtime.FeedHeader;switch(null!=e.gtfsRealtimeVersion&&(t.gtfsRealtimeVersion=String(e.gtfsRealtimeVersion)),e.incrementality){default:if("number"==typeof e.incrementality){t.incrementality=e.incrementality;break}break;case"FULL_DATASET":case 0:t.incrementality=0;break;case"DIFFERENTIAL":case 1:t.incrementality=1}return null!=e.timestamp&&(r.Long?(t.timestamp=r.Long.fromValue(e.timestamp)).unsigned=!0:"string"==typeof e.timestamp?t.timestamp=parseInt(e.timestamp,10):"number"==typeof e.timestamp?t.timestamp=e.timestamp:"object"==typeof e.timestamp&&(t.timestamp=new r.LongBits(e.timestamp.low>>>0,e.timestamp.high>>>0).toNumber(!0))),t},e.toObject=function(e,t){t||(t={});var i={};if(t.defaults)if(i.gtfsRealtimeVersion="",i.incrementality=t.enums===String?"FULL_DATASET":0,r.Long){var n=new r.Long(0,0,!0);i.timestamp=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else i.timestamp=t.longs===String?"0":0;return null!=e.gtfsRealtimeVersion&&e.hasOwnProperty("gtfsRealtimeVersion")&&(i.gtfsRealtimeVersion=e.gtfsRealtimeVersion),null!=e.incrementality&&e.hasOwnProperty("incrementality")&&(i.incrementality=t.enums===String?void 0===o.transit_realtime.FeedHeader.Incrementality[e.incrementality]?e.incrementality:o.transit_realtime.FeedHeader.Incrementality[e.incrementality]:e.incrementality),null!=e.timestamp&&e.hasOwnProperty("timestamp")&&(i.timestamp="number"==typeof e.timestamp?t.longs===String?String(e.timestamp):e.timestamp:t.longs===String?r.Long.prototype.toString.call(e.timestamp):t.longs===Number?new r.LongBits(e.timestamp.low>>>0,e.timestamp.high>>>0).toNumber(!0):e.timestamp),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.FeedHeader"},e.Incrementality=(s={},(a=Object.create(s))[s[0]="FULL_DATASET"]=0,a[s[1]="DIFFERENTIAL"]=1,a),e}(),e.FeedEntity=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.id="",e.prototype.isDeleted=!1,e.prototype.tripUpdate=null,e.prototype.vehicle=null,e.prototype.alert=null,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),t.uint32(10).string(e.id),null!=e.isDeleted&&Object.hasOwnProperty.call(e,"isDeleted")&&t.uint32(16).bool(e.isDeleted),null!=e.tripUpdate&&Object.hasOwnProperty.call(e,"tripUpdate")&&o.transit_realtime.TripUpdate.encode(e.tripUpdate,t.uint32(26).fork()).ldelim(),null!=e.vehicle&&Object.hasOwnProperty.call(e,"vehicle")&&o.transit_realtime.VehiclePosition.encode(e.vehicle,t.uint32(34).fork()).ldelim(),null!=e.alert&&Object.hasOwnProperty.call(e,"alert")&&o.transit_realtime.Alert.encode(e.alert,t.uint32(42).fork()).ldelim(),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new o.transit_realtime.FeedEntity;e.pos<n;){var a=e.uint32();switch(a>>>3){case 1:s.id=e.string();break;case 2:s.isDeleted=e.bool();break;case 3:s.tripUpdate=o.transit_realtime.TripUpdate.decode(e,e.uint32());break;case 4:s.vehicle=o.transit_realtime.VehiclePosition.decode(e,e.uint32());break;case 5:s.alert=o.transit_realtime.Alert.decode(e,e.uint32());break;default:e.skipType(7&a)}}if(!s.hasOwnProperty("id"))throw r.ProtocolError("missing required 'id'",{instance:s});return s},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":r.isString(e.id)?null!=e.isDeleted&&e.hasOwnProperty("isDeleted")&&"boolean"!=typeof e.isDeleted?"isDeleted: boolean expected":null!=e.tripUpdate&&e.hasOwnProperty("tripUpdate")&&(t=o.transit_realtime.TripUpdate.verify(e.tripUpdate))?"tripUpdate."+t:null!=e.vehicle&&e.hasOwnProperty("vehicle")&&(t=o.transit_realtime.VehiclePosition.verify(e.vehicle))?"vehicle."+t:null!=e.alert&&e.hasOwnProperty("alert")&&(t=o.transit_realtime.Alert.verify(e.alert))?"alert."+t:null:"id: string expected";var t},e.fromObject=function(e){if(e instanceof o.transit_realtime.FeedEntity)return e;var t=new o.transit_realtime.FeedEntity;if(null!=e.id&&(t.id=String(e.id)),null!=e.isDeleted&&(t.isDeleted=Boolean(e.isDeleted)),null!=e.tripUpdate){if("object"!=typeof e.tripUpdate)throw TypeError(".transit_realtime.FeedEntity.tripUpdate: object expected");t.tripUpdate=o.transit_realtime.TripUpdate.fromObject(e.tripUpdate)}if(null!=e.vehicle){if("object"!=typeof e.vehicle)throw TypeError(".transit_realtime.FeedEntity.vehicle: object expected");t.vehicle=o.transit_realtime.VehiclePosition.fromObject(e.vehicle)}if(null!=e.alert){if("object"!=typeof e.alert)throw TypeError(".transit_realtime.FeedEntity.alert: object expected");t.alert=o.transit_realtime.Alert.fromObject(e.alert)}return t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.id="",i.isDeleted=!1,i.tripUpdate=null,i.vehicle=null,i.alert=null),null!=e.id&&e.hasOwnProperty("id")&&(i.id=e.id),null!=e.isDeleted&&e.hasOwnProperty("isDeleted")&&(i.isDeleted=e.isDeleted),null!=e.tripUpdate&&e.hasOwnProperty("tripUpdate")&&(i.tripUpdate=o.transit_realtime.TripUpdate.toObject(e.tripUpdate,t)),null!=e.vehicle&&e.hasOwnProperty("vehicle")&&(i.vehicle=o.transit_realtime.VehiclePosition.toObject(e.vehicle,t)),null!=e.alert&&e.hasOwnProperty("alert")&&(i.alert=o.transit_realtime.Alert.toObject(e.alert,t)),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.FeedEntity"},e}(),e.TripUpdate=function(){function e(e){if(this.stopTimeUpdate=[],e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.trip=null,e.prototype.vehicle=null,e.prototype.stopTimeUpdate=r.emptyArray,e.prototype.timestamp=r.Long?r.Long.fromBits(0,0,!0):0,e.prototype.delay=0,e.prototype.tripProperties=null,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=n.create()),o.transit_realtime.TripDescriptor.encode(e.trip,t.uint32(10).fork()).ldelim(),null!=e.stopTimeUpdate&&e.stopTimeUpdate.length)for(var i=0;i<e.stopTimeUpdate.length;++i)o.transit_realtime.TripUpdate.StopTimeUpdate.encode(e.stopTimeUpdate[i],t.uint32(18).fork()).ldelim();return null!=e.vehicle&&Object.hasOwnProperty.call(e,"vehicle")&&o.transit_realtime.VehicleDescriptor.encode(e.vehicle,t.uint32(26).fork()).ldelim(),null!=e.timestamp&&Object.hasOwnProperty.call(e,"timestamp")&&t.uint32(32).uint64(e.timestamp),null!=e.delay&&Object.hasOwnProperty.call(e,"delay")&&t.uint32(40).int32(e.delay),null!=e.tripProperties&&Object.hasOwnProperty.call(e,"tripProperties")&&o.transit_realtime.TripUpdate.TripProperties.encode(e.tripProperties,t.uint32(50).fork()).ldelim(),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new o.transit_realtime.TripUpdate;e.pos<n;){var a=e.uint32();switch(a>>>3){case 1:s.trip=o.transit_realtime.TripDescriptor.decode(e,e.uint32());break;case 3:s.vehicle=o.transit_realtime.VehicleDescriptor.decode(e,e.uint32());break;case 2:s.stopTimeUpdate&&s.stopTimeUpdate.length||(s.stopTimeUpdate=[]),s.stopTimeUpdate.push(o.transit_realtime.TripUpdate.StopTimeUpdate.decode(e,e.uint32()));break;case 4:s.timestamp=e.uint64();break;case 5:s.delay=e.int32();break;case 6:s.tripProperties=o.transit_realtime.TripUpdate.TripProperties.decode(e,e.uint32());break;default:e.skipType(7&a)}}if(!s.hasOwnProperty("trip"))throw r.ProtocolError("missing required 'trip'",{instance:s});return s},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(i=o.transit_realtime.TripDescriptor.verify(e.trip))return"trip."+i;if(null!=e.vehicle&&e.hasOwnProperty("vehicle")&&(i=o.transit_realtime.VehicleDescriptor.verify(e.vehicle)))return"vehicle."+i;if(null!=e.stopTimeUpdate&&e.hasOwnProperty("stopTimeUpdate")){if(!Array.isArray(e.stopTimeUpdate))return"stopTimeUpdate: array expected";for(var t=0;t<e.stopTimeUpdate.length;++t){var i;if(i=o.transit_realtime.TripUpdate.StopTimeUpdate.verify(e.stopTimeUpdate[t]))return"stopTimeUpdate."+i}}return null!=e.timestamp&&e.hasOwnProperty("timestamp")&&!(r.isInteger(e.timestamp)||e.timestamp&&r.isInteger(e.timestamp.low)&&r.isInteger(e.timestamp.high))?"timestamp: integer|Long expected":null!=e.delay&&e.hasOwnProperty("delay")&&!r.isInteger(e.delay)?"delay: integer expected":null!=e.tripProperties&&e.hasOwnProperty("tripProperties")&&(i=o.transit_realtime.TripUpdate.TripProperties.verify(e.tripProperties))?"tripProperties."+i:null},e.fromObject=function(e){if(e instanceof o.transit_realtime.TripUpdate)return e;var t=new o.transit_realtime.TripUpdate;if(null!=e.trip){if("object"!=typeof e.trip)throw TypeError(".transit_realtime.TripUpdate.trip: object expected");t.trip=o.transit_realtime.TripDescriptor.fromObject(e.trip)}if(null!=e.vehicle){if("object"!=typeof e.vehicle)throw TypeError(".transit_realtime.TripUpdate.vehicle: object expected");t.vehicle=o.transit_realtime.VehicleDescriptor.fromObject(e.vehicle)}if(e.stopTimeUpdate){if(!Array.isArray(e.stopTimeUpdate))throw TypeError(".transit_realtime.TripUpdate.stopTimeUpdate: array expected");t.stopTimeUpdate=[];for(var i=0;i<e.stopTimeUpdate.length;++i){if("object"!=typeof e.stopTimeUpdate[i])throw TypeError(".transit_realtime.TripUpdate.stopTimeUpdate: object expected");t.stopTimeUpdate[i]=o.transit_realtime.TripUpdate.StopTimeUpdate.fromObject(e.stopTimeUpdate[i])}}if(null!=e.timestamp&&(r.Long?(t.timestamp=r.Long.fromValue(e.timestamp)).unsigned=!0:"string"==typeof e.timestamp?t.timestamp=parseInt(e.timestamp,10):"number"==typeof e.timestamp?t.timestamp=e.timestamp:"object"==typeof e.timestamp&&(t.timestamp=new r.LongBits(e.timestamp.low>>>0,e.timestamp.high>>>0).toNumber(!0))),null!=e.delay&&(t.delay=0|e.delay),null!=e.tripProperties){if("object"!=typeof e.tripProperties)throw TypeError(".transit_realtime.TripUpdate.tripProperties: object expected");t.tripProperties=o.transit_realtime.TripUpdate.TripProperties.fromObject(e.tripProperties)}return t},e.toObject=function(e,t){t||(t={});var i={};if((t.arrays||t.defaults)&&(i.stopTimeUpdate=[]),t.defaults){if(i.trip=null,i.vehicle=null,r.Long){var n=new r.Long(0,0,!0);i.timestamp=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else i.timestamp=t.longs===String?"0":0;i.delay=0,i.tripProperties=null}if(null!=e.trip&&e.hasOwnProperty("trip")&&(i.trip=o.transit_realtime.TripDescriptor.toObject(e.trip,t)),e.stopTimeUpdate&&e.stopTimeUpdate.length){i.stopTimeUpdate=[];for(var s=0;s<e.stopTimeUpdate.length;++s)i.stopTimeUpdate[s]=o.transit_realtime.TripUpdate.StopTimeUpdate.toObject(e.stopTimeUpdate[s],t)}return null!=e.vehicle&&e.hasOwnProperty("vehicle")&&(i.vehicle=o.transit_realtime.VehicleDescriptor.toObject(e.vehicle,t)),null!=e.timestamp&&e.hasOwnProperty("timestamp")&&(i.timestamp="number"==typeof e.timestamp?t.longs===String?String(e.timestamp):e.timestamp:t.longs===String?r.Long.prototype.toString.call(e.timestamp):t.longs===Number?new r.LongBits(e.timestamp.low>>>0,e.timestamp.high>>>0).toNumber(!0):e.timestamp),null!=e.delay&&e.hasOwnProperty("delay")&&(i.delay=e.delay),null!=e.tripProperties&&e.hasOwnProperty("tripProperties")&&(i.tripProperties=o.transit_realtime.TripUpdate.TripProperties.toObject(e.tripProperties,t)),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TripUpdate"},e.StopTimeEvent=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.delay=0,e.prototype.time=r.Long?r.Long.fromBits(0,0,!1):0,e.prototype.uncertainty=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.delay&&Object.hasOwnProperty.call(e,"delay")&&t.uint32(8).int32(e.delay),null!=e.time&&Object.hasOwnProperty.call(e,"time")&&t.uint32(16).int64(e.time),null!=e.uncertainty&&Object.hasOwnProperty.call(e,"uncertainty")&&t.uint32(24).int32(e.uncertainty),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.TripUpdate.StopTimeEvent;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.delay=e.int32();break;case 2:r.time=e.int64();break;case 3:r.uncertainty=e.int32();break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.delay&&e.hasOwnProperty("delay")&&!r.isInteger(e.delay)?"delay: integer expected":null!=e.time&&e.hasOwnProperty("time")&&!(r.isInteger(e.time)||e.time&&r.isInteger(e.time.low)&&r.isInteger(e.time.high))?"time: integer|Long expected":null!=e.uncertainty&&e.hasOwnProperty("uncertainty")&&!r.isInteger(e.uncertainty)?"uncertainty: integer expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.TripUpdate.StopTimeEvent)return e;var t=new o.transit_realtime.TripUpdate.StopTimeEvent;return null!=e.delay&&(t.delay=0|e.delay),null!=e.time&&(r.Long?(t.time=r.Long.fromValue(e.time)).unsigned=!1:"string"==typeof e.time?t.time=parseInt(e.time,10):"number"==typeof e.time?t.time=e.time:"object"==typeof e.time&&(t.time=new r.LongBits(e.time.low>>>0,e.time.high>>>0).toNumber())),null!=e.uncertainty&&(t.uncertainty=0|e.uncertainty),t},e.toObject=function(e,t){t||(t={});var i={};if(t.defaults){if(i.delay=0,r.Long){var n=new r.Long(0,0,!1);i.time=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else i.time=t.longs===String?"0":0;i.uncertainty=0}return null!=e.delay&&e.hasOwnProperty("delay")&&(i.delay=e.delay),null!=e.time&&e.hasOwnProperty("time")&&(i.time="number"==typeof e.time?t.longs===String?String(e.time):e.time:t.longs===String?r.Long.prototype.toString.call(e.time):t.longs===Number?new r.LongBits(e.time.low>>>0,e.time.high>>>0).toNumber():e.time),null!=e.uncertainty&&e.hasOwnProperty("uncertainty")&&(i.uncertainty=e.uncertainty),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TripUpdate.StopTimeEvent"},e}(),e.StopTimeUpdate=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}var s,a;return e.prototype.stopSequence=0,e.prototype.stopId="",e.prototype.arrival=null,e.prototype.departure=null,e.prototype.scheduleRelationship=0,e.prototype.stopTimeProperties=null,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.stopSequence&&Object.hasOwnProperty.call(e,"stopSequence")&&t.uint32(8).uint32(e.stopSequence),null!=e.arrival&&Object.hasOwnProperty.call(e,"arrival")&&o.transit_realtime.TripUpdate.StopTimeEvent.encode(e.arrival,t.uint32(18).fork()).ldelim(),null!=e.departure&&Object.hasOwnProperty.call(e,"departure")&&o.transit_realtime.TripUpdate.StopTimeEvent.encode(e.departure,t.uint32(26).fork()).ldelim(),null!=e.stopId&&Object.hasOwnProperty.call(e,"stopId")&&t.uint32(34).string(e.stopId),null!=e.scheduleRelationship&&Object.hasOwnProperty.call(e,"scheduleRelationship")&&t.uint32(40).int32(e.scheduleRelationship),null!=e.stopTimeProperties&&Object.hasOwnProperty.call(e,"stopTimeProperties")&&o.transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties.encode(e.stopTimeProperties,t.uint32(50).fork()).ldelim(),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.TripUpdate.StopTimeUpdate;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.stopSequence=e.uint32();break;case 4:r.stopId=e.string();break;case 2:r.arrival=o.transit_realtime.TripUpdate.StopTimeEvent.decode(e,e.uint32());break;case 3:r.departure=o.transit_realtime.TripUpdate.StopTimeEvent.decode(e,e.uint32());break;case 5:r.scheduleRelationship=e.int32();break;case 6:r.stopTimeProperties=o.transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties.decode(e,e.uint32());break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.stopSequence&&e.hasOwnProperty("stopSequence")&&!r.isInteger(e.stopSequence))return"stopSequence: integer expected";if(null!=e.stopId&&e.hasOwnProperty("stopId")&&!r.isString(e.stopId))return"stopId: string expected";var t;if(null!=e.arrival&&e.hasOwnProperty("arrival")&&(t=o.transit_realtime.TripUpdate.StopTimeEvent.verify(e.arrival)))return"arrival."+t;if(null!=e.departure&&e.hasOwnProperty("departure")&&(t=o.transit_realtime.TripUpdate.StopTimeEvent.verify(e.departure)))return"departure."+t;if(null!=e.scheduleRelationship&&e.hasOwnProperty("scheduleRelationship"))switch(e.scheduleRelationship){default:return"scheduleRelationship: enum value expected";case 0:case 1:case 2:case 3:}return null!=e.stopTimeProperties&&e.hasOwnProperty("stopTimeProperties")&&(t=o.transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties.verify(e.stopTimeProperties))?"stopTimeProperties."+t:null},e.fromObject=function(e){if(e instanceof o.transit_realtime.TripUpdate.StopTimeUpdate)return e;var t=new o.transit_realtime.TripUpdate.StopTimeUpdate;if(null!=e.stopSequence&&(t.stopSequence=e.stopSequence>>>0),null!=e.stopId&&(t.stopId=String(e.stopId)),null!=e.arrival){if("object"!=typeof e.arrival)throw TypeError(".transit_realtime.TripUpdate.StopTimeUpdate.arrival: object expected");t.arrival=o.transit_realtime.TripUpdate.StopTimeEvent.fromObject(e.arrival)}if(null!=e.departure){if("object"!=typeof e.departure)throw TypeError(".transit_realtime.TripUpdate.StopTimeUpdate.departure: object expected");t.departure=o.transit_realtime.TripUpdate.StopTimeEvent.fromObject(e.departure)}switch(e.scheduleRelationship){default:if("number"==typeof e.scheduleRelationship){t.scheduleRelationship=e.scheduleRelationship;break}break;case"SCHEDULED":case 0:t.scheduleRelationship=0;break;case"SKIPPED":case 1:t.scheduleRelationship=1;break;case"NO_DATA":case 2:t.scheduleRelationship=2;break;case"UNSCHEDULED":case 3:t.scheduleRelationship=3}if(null!=e.stopTimeProperties){if("object"!=typeof e.stopTimeProperties)throw TypeError(".transit_realtime.TripUpdate.StopTimeUpdate.stopTimeProperties: object expected");t.stopTimeProperties=o.transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties.fromObject(e.stopTimeProperties)}return t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.stopSequence=0,i.arrival=null,i.departure=null,i.stopId="",i.scheduleRelationship=t.enums===String?"SCHEDULED":0,i.stopTimeProperties=null),null!=e.stopSequence&&e.hasOwnProperty("stopSequence")&&(i.stopSequence=e.stopSequence),null!=e.arrival&&e.hasOwnProperty("arrival")&&(i.arrival=o.transit_realtime.TripUpdate.StopTimeEvent.toObject(e.arrival,t)),null!=e.departure&&e.hasOwnProperty("departure")&&(i.departure=o.transit_realtime.TripUpdate.StopTimeEvent.toObject(e.departure,t)),null!=e.stopId&&e.hasOwnProperty("stopId")&&(i.stopId=e.stopId),null!=e.scheduleRelationship&&e.hasOwnProperty("scheduleRelationship")&&(i.scheduleRelationship=t.enums===String?void 0===o.transit_realtime.TripUpdate.StopTimeUpdate.ScheduleRelationship[e.scheduleRelationship]?e.scheduleRelationship:o.transit_realtime.TripUpdate.StopTimeUpdate.ScheduleRelationship[e.scheduleRelationship]:e.scheduleRelationship),null!=e.stopTimeProperties&&e.hasOwnProperty("stopTimeProperties")&&(i.stopTimeProperties=o.transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties.toObject(e.stopTimeProperties,t)),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TripUpdate.StopTimeUpdate"},e.ScheduleRelationship=(s={},(a=Object.create(s))[s[0]="SCHEDULED"]=0,a[s[1]="SKIPPED"]=1,a[s[2]="NO_DATA"]=2,a[s[3]="UNSCHEDULED"]=3,a),e.StopTimeProperties=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.assignedStopId="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.assignedStopId&&Object.hasOwnProperty.call(e,"assignedStopId")&&t.uint32(10).string(e.assignedStopId),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties;e.pos<n;){var s=e.uint32();s>>>3==1?r.assignedStopId=e.string():e.skipType(7&s)}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.assignedStopId&&e.hasOwnProperty("assignedStopId")&&!r.isString(e.assignedStopId)?"assignedStopId: string expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties)return e;var t=new o.transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties;return null!=e.assignedStopId&&(t.assignedStopId=String(e.assignedStopId)),t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.assignedStopId=""),null!=e.assignedStopId&&e.hasOwnProperty("assignedStopId")&&(i.assignedStopId=e.assignedStopId),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TripUpdate.StopTimeUpdate.StopTimeProperties"},e}(),e}(),e.TripProperties=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.tripId="",e.prototype.startDate="",e.prototype.startTime="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.tripId&&Object.hasOwnProperty.call(e,"tripId")&&t.uint32(10).string(e.tripId),null!=e.startDate&&Object.hasOwnProperty.call(e,"startDate")&&t.uint32(18).string(e.startDate),null!=e.startTime&&Object.hasOwnProperty.call(e,"startTime")&&t.uint32(26).string(e.startTime),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.TripUpdate.TripProperties;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.tripId=e.string();break;case 2:r.startDate=e.string();break;case 3:r.startTime=e.string();break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.tripId&&e.hasOwnProperty("tripId")&&!r.isString(e.tripId)?"tripId: string expected":null!=e.startDate&&e.hasOwnProperty("startDate")&&!r.isString(e.startDate)?"startDate: string expected":null!=e.startTime&&e.hasOwnProperty("startTime")&&!r.isString(e.startTime)?"startTime: string expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.TripUpdate.TripProperties)return e;var t=new o.transit_realtime.TripUpdate.TripProperties;return null!=e.tripId&&(t.tripId=String(e.tripId)),null!=e.startDate&&(t.startDate=String(e.startDate)),null!=e.startTime&&(t.startTime=String(e.startTime)),t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.tripId="",i.startDate="",i.startTime=""),null!=e.tripId&&e.hasOwnProperty("tripId")&&(i.tripId=e.tripId),null!=e.startDate&&e.hasOwnProperty("startDate")&&(i.startDate=e.startDate),null!=e.startTime&&e.hasOwnProperty("startTime")&&(i.startTime=e.startTime),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TripUpdate.TripProperties"},e}(),e}(),e.VehiclePosition=function(){function e(e){if(this.multiCarriageDetails=[],e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}var s,a;return e.prototype.trip=null,e.prototype.vehicle=null,e.prototype.position=null,e.prototype.currentStopSequence=0,e.prototype.stopId="",e.prototype.currentStatus=2,e.prototype.timestamp=r.Long?r.Long.fromBits(0,0,!0):0,e.prototype.congestionLevel=0,e.prototype.occupancyStatus=0,e.prototype.occupancyPercentage=0,e.prototype.multiCarriageDetails=r.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=n.create()),null!=e.trip&&Object.hasOwnProperty.call(e,"trip")&&o.transit_realtime.TripDescriptor.encode(e.trip,t.uint32(10).fork()).ldelim(),null!=e.position&&Object.hasOwnProperty.call(e,"position")&&o.transit_realtime.Position.encode(e.position,t.uint32(18).fork()).ldelim(),null!=e.currentStopSequence&&Object.hasOwnProperty.call(e,"currentStopSequence")&&t.uint32(24).uint32(e.currentStopSequence),null!=e.currentStatus&&Object.hasOwnProperty.call(e,"currentStatus")&&t.uint32(32).int32(e.currentStatus),null!=e.timestamp&&Object.hasOwnProperty.call(e,"timestamp")&&t.uint32(40).uint64(e.timestamp),null!=e.congestionLevel&&Object.hasOwnProperty.call(e,"congestionLevel")&&t.uint32(48).int32(e.congestionLevel),null!=e.stopId&&Object.hasOwnProperty.call(e,"stopId")&&t.uint32(58).string(e.stopId),null!=e.vehicle&&Object.hasOwnProperty.call(e,"vehicle")&&o.transit_realtime.VehicleDescriptor.encode(e.vehicle,t.uint32(66).fork()).ldelim(),null!=e.occupancyStatus&&Object.hasOwnProperty.call(e,"occupancyStatus")&&t.uint32(72).int32(e.occupancyStatus),null!=e.occupancyPercentage&&Object.hasOwnProperty.call(e,"occupancyPercentage")&&t.uint32(80).uint32(e.occupancyPercentage),null!=e.multiCarriageDetails&&e.multiCarriageDetails.length)for(var i=0;i<e.multiCarriageDetails.length;++i)o.transit_realtime.VehiclePosition.CarriageDetails.encode(e.multiCarriageDetails[i],t.uint32(90).fork()).ldelim();return t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.VehiclePosition;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.trip=o.transit_realtime.TripDescriptor.decode(e,e.uint32());break;case 8:r.vehicle=o.transit_realtime.VehicleDescriptor.decode(e,e.uint32());break;case 2:r.position=o.transit_realtime.Position.decode(e,e.uint32());break;case 3:r.currentStopSequence=e.uint32();break;case 7:r.stopId=e.string();break;case 4:r.currentStatus=e.int32();break;case 5:r.timestamp=e.uint64();break;case 6:r.congestionLevel=e.int32();break;case 9:r.occupancyStatus=e.int32();break;case 10:r.occupancyPercentage=e.uint32();break;case 11:r.multiCarriageDetails&&r.multiCarriageDetails.length||(r.multiCarriageDetails=[]),r.multiCarriageDetails.push(o.transit_realtime.VehiclePosition.CarriageDetails.decode(e,e.uint32()));break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.trip&&e.hasOwnProperty("trip")&&(i=o.transit_realtime.TripDescriptor.verify(e.trip)))return"trip."+i;if(null!=e.vehicle&&e.hasOwnProperty("vehicle")&&(i=o.transit_realtime.VehicleDescriptor.verify(e.vehicle)))return"vehicle."+i;if(null!=e.position&&e.hasOwnProperty("position")&&(i=o.transit_realtime.Position.verify(e.position)))return"position."+i;if(null!=e.currentStopSequence&&e.hasOwnProperty("currentStopSequence")&&!r.isInteger(e.currentStopSequence))return"currentStopSequence: integer expected";if(null!=e.stopId&&e.hasOwnProperty("stopId")&&!r.isString(e.stopId))return"stopId: string expected";if(null!=e.currentStatus&&e.hasOwnProperty("currentStatus"))switch(e.currentStatus){default:return"currentStatus: enum value expected";case 0:case 1:case 2:}if(null!=e.timestamp&&e.hasOwnProperty("timestamp")&&!(r.isInteger(e.timestamp)||e.timestamp&&r.isInteger(e.timestamp.low)&&r.isInteger(e.timestamp.high)))return"timestamp: integer|Long expected";if(null!=e.congestionLevel&&e.hasOwnProperty("congestionLevel"))switch(e.congestionLevel){default:return"congestionLevel: enum value expected";case 0:case 1:case 2:case 3:case 4:}if(null!=e.occupancyStatus&&e.hasOwnProperty("occupancyStatus"))switch(e.occupancyStatus){default:return"occupancyStatus: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:}if(null!=e.occupancyPercentage&&e.hasOwnProperty("occupancyPercentage")&&!r.isInteger(e.occupancyPercentage))return"occupancyPercentage: integer expected";if(null!=e.multiCarriageDetails&&e.hasOwnProperty("multiCarriageDetails")){if(!Array.isArray(e.multiCarriageDetails))return"multiCarriageDetails: array expected";for(var t=0;t<e.multiCarriageDetails.length;++t){var i;if(i=o.transit_realtime.VehiclePosition.CarriageDetails.verify(e.multiCarriageDetails[t]))return"multiCarriageDetails."+i}}return null},e.fromObject=function(e){if(e instanceof o.transit_realtime.VehiclePosition)return e;var t=new o.transit_realtime.VehiclePosition;if(null!=e.trip){if("object"!=typeof e.trip)throw TypeError(".transit_realtime.VehiclePosition.trip: object expected");t.trip=o.transit_realtime.TripDescriptor.fromObject(e.trip)}if(null!=e.vehicle){if("object"!=typeof e.vehicle)throw TypeError(".transit_realtime.VehiclePosition.vehicle: object expected");t.vehicle=o.transit_realtime.VehicleDescriptor.fromObject(e.vehicle)}if(null!=e.position){if("object"!=typeof e.position)throw TypeError(".transit_realtime.VehiclePosition.position: object expected");t.position=o.transit_realtime.Position.fromObject(e.position)}switch(null!=e.currentStopSequence&&(t.currentStopSequence=e.currentStopSequence>>>0),null!=e.stopId&&(t.stopId=String(e.stopId)),e.currentStatus){case"INCOMING_AT":case 0:t.currentStatus=0;break;case"STOPPED_AT":case 1:t.currentStatus=1;break;default:if("number"==typeof e.currentStatus){t.currentStatus=e.currentStatus;break}break;case"IN_TRANSIT_TO":case 2:t.currentStatus=2}switch(null!=e.timestamp&&(r.Long?(t.timestamp=r.Long.fromValue(e.timestamp)).unsigned=!0:"string"==typeof e.timestamp?t.timestamp=parseInt(e.timestamp,10):"number"==typeof e.timestamp?t.timestamp=e.timestamp:"object"==typeof e.timestamp&&(t.timestamp=new r.LongBits(e.timestamp.low>>>0,e.timestamp.high>>>0).toNumber(!0))),e.congestionLevel){default:if("number"==typeof e.congestionLevel){t.congestionLevel=e.congestionLevel;break}break;case"UNKNOWN_CONGESTION_LEVEL":case 0:t.congestionLevel=0;break;case"RUNNING_SMOOTHLY":case 1:t.congestionLevel=1;break;case"STOP_AND_GO":case 2:t.congestionLevel=2;break;case"CONGESTION":case 3:t.congestionLevel=3;break;case"SEVERE_CONGESTION":case 4:t.congestionLevel=4}switch(e.occupancyStatus){default:if("number"==typeof e.occupancyStatus){t.occupancyStatus=e.occupancyStatus;break}break;case"EMPTY":case 0:t.occupancyStatus=0;break;case"MANY_SEATS_AVAILABLE":case 1:t.occupancyStatus=1;break;case"FEW_SEATS_AVAILABLE":case 2:t.occupancyStatus=2;break;case"STANDING_ROOM_ONLY":case 3:t.occupancyStatus=3;break;case"CRUSHED_STANDING_ROOM_ONLY":case 4:t.occupancyStatus=4;break;case"FULL":case 5:t.occupancyStatus=5;break;case"NOT_ACCEPTING_PASSENGERS":case 6:t.occupancyStatus=6;break;case"NO_DATA_AVAILABLE":case 7:t.occupancyStatus=7;break;case"NOT_BOARDABLE":case 8:t.occupancyStatus=8}if(null!=e.occupancyPercentage&&(t.occupancyPercentage=e.occupancyPercentage>>>0),e.multiCarriageDetails){if(!Array.isArray(e.multiCarriageDetails))throw TypeError(".transit_realtime.VehiclePosition.multiCarriageDetails: array expected");t.multiCarriageDetails=[];for(var i=0;i<e.multiCarriageDetails.length;++i){if("object"!=typeof e.multiCarriageDetails[i])throw TypeError(".transit_realtime.VehiclePosition.multiCarriageDetails: object expected");t.multiCarriageDetails[i]=o.transit_realtime.VehiclePosition.CarriageDetails.fromObject(e.multiCarriageDetails[i])}}return t},e.toObject=function(e,t){t||(t={});var i={};if((t.arrays||t.defaults)&&(i.multiCarriageDetails=[]),t.defaults){if(i.trip=null,i.position=null,i.currentStopSequence=0,i.currentStatus=t.enums===String?"IN_TRANSIT_TO":2,r.Long){var n=new r.Long(0,0,!0);i.timestamp=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else i.timestamp=t.longs===String?"0":0;i.congestionLevel=t.enums===String?"UNKNOWN_CONGESTION_LEVEL":0,i.stopId="",i.vehicle=null,i.occupancyStatus=t.enums===String?"EMPTY":0,i.occupancyPercentage=0}if(null!=e.trip&&e.hasOwnProperty("trip")&&(i.trip=o.transit_realtime.TripDescriptor.toObject(e.trip,t)),null!=e.position&&e.hasOwnProperty("position")&&(i.position=o.transit_realtime.Position.toObject(e.position,t)),null!=e.currentStopSequence&&e.hasOwnProperty("currentStopSequence")&&(i.currentStopSequence=e.currentStopSequence),null!=e.currentStatus&&e.hasOwnProperty("currentStatus")&&(i.currentStatus=t.enums===String?void 0===o.transit_realtime.VehiclePosition.VehicleStopStatus[e.currentStatus]?e.currentStatus:o.transit_realtime.VehiclePosition.VehicleStopStatus[e.currentStatus]:e.currentStatus),null!=e.timestamp&&e.hasOwnProperty("timestamp")&&(i.timestamp="number"==typeof e.timestamp?t.longs===String?String(e.timestamp):e.timestamp:t.longs===String?r.Long.prototype.toString.call(e.timestamp):t.longs===Number?new r.LongBits(e.timestamp.low>>>0,e.timestamp.high>>>0).toNumber(!0):e.timestamp),null!=e.congestionLevel&&e.hasOwnProperty("congestionLevel")&&(i.congestionLevel=t.enums===String?void 0===o.transit_realtime.VehiclePosition.CongestionLevel[e.congestionLevel]?e.congestionLevel:o.transit_realtime.VehiclePosition.CongestionLevel[e.congestionLevel]:e.congestionLevel),null!=e.stopId&&e.hasOwnProperty("stopId")&&(i.stopId=e.stopId),null!=e.vehicle&&e.hasOwnProperty("vehicle")&&(i.vehicle=o.transit_realtime.VehicleDescriptor.toObject(e.vehicle,t)),null!=e.occupancyStatus&&e.hasOwnProperty("occupancyStatus")&&(i.occupancyStatus=t.enums===String?void 0===o.transit_realtime.VehiclePosition.OccupancyStatus[e.occupancyStatus]?e.occupancyStatus:o.transit_realtime.VehiclePosition.OccupancyStatus[e.occupancyStatus]:e.occupancyStatus),null!=e.occupancyPercentage&&e.hasOwnProperty("occupancyPercentage")&&(i.occupancyPercentage=e.occupancyPercentage),e.multiCarriageDetails&&e.multiCarriageDetails.length){i.multiCarriageDetails=[];for(var s=0;s<e.multiCarriageDetails.length;++s)i.multiCarriageDetails[s]=o.transit_realtime.VehiclePosition.CarriageDetails.toObject(e.multiCarriageDetails[s],t)}return i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.VehiclePosition"},e.VehicleStopStatus=(s={},(a=Object.create(s))[s[0]="INCOMING_AT"]=0,a[s[1]="STOPPED_AT"]=1,a[s[2]="IN_TRANSIT_TO"]=2,a),e.CongestionLevel=function(){var e={},t=Object.create(e);return t[e[0]="UNKNOWN_CONGESTION_LEVEL"]=0,t[e[1]="RUNNING_SMOOTHLY"]=1,t[e[2]="STOP_AND_GO"]=2,t[e[3]="CONGESTION"]=3,t[e[4]="SEVERE_CONGESTION"]=4,t}(),e.OccupancyStatus=function(){var e={},t=Object.create(e);return t[e[0]="EMPTY"]=0,t[e[1]="MANY_SEATS_AVAILABLE"]=1,t[e[2]="FEW_SEATS_AVAILABLE"]=2,t[e[3]="STANDING_ROOM_ONLY"]=3,t[e[4]="CRUSHED_STANDING_ROOM_ONLY"]=4,t[e[5]="FULL"]=5,t[e[6]="NOT_ACCEPTING_PASSENGERS"]=6,t[e[7]="NO_DATA_AVAILABLE"]=7,t[e[8]="NOT_BOARDABLE"]=8,t}(),e.CarriageDetails=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.id="",e.prototype.label="",e.prototype.occupancyStatus=7,e.prototype.occupancyPercentage=-1,e.prototype.carriageSequence=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.id&&Object.hasOwnProperty.call(e,"id")&&t.uint32(10).string(e.id),null!=e.label&&Object.hasOwnProperty.call(e,"label")&&t.uint32(18).string(e.label),null!=e.occupancyStatus&&Object.hasOwnProperty.call(e,"occupancyStatus")&&t.uint32(24).int32(e.occupancyStatus),null!=e.occupancyPercentage&&Object.hasOwnProperty.call(e,"occupancyPercentage")&&t.uint32(32).int32(e.occupancyPercentage),null!=e.carriageSequence&&Object.hasOwnProperty.call(e,"carriageSequence")&&t.uint32(40).uint32(e.carriageSequence),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.VehiclePosition.CarriageDetails;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.id=e.string();break;case 2:r.label=e.string();break;case 3:r.occupancyStatus=e.int32();break;case 4:r.occupancyPercentage=e.int32();break;case 5:r.carriageSequence=e.uint32();break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.id&&e.hasOwnProperty("id")&&!r.isString(e.id))return"id: string expected";if(null!=e.label&&e.hasOwnProperty("label")&&!r.isString(e.label))return"label: string expected";if(null!=e.occupancyStatus&&e.hasOwnProperty("occupancyStatus"))switch(e.occupancyStatus){default:return"occupancyStatus: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:}return null!=e.occupancyPercentage&&e.hasOwnProperty("occupancyPercentage")&&!r.isInteger(e.occupancyPercentage)?"occupancyPercentage: integer expected":null!=e.carriageSequence&&e.hasOwnProperty("carriageSequence")&&!r.isInteger(e.carriageSequence)?"carriageSequence: integer expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.VehiclePosition.CarriageDetails)return e;var t=new o.transit_realtime.VehiclePosition.CarriageDetails;switch(null!=e.id&&(t.id=String(e.id)),null!=e.label&&(t.label=String(e.label)),e.occupancyStatus){case"EMPTY":case 0:t.occupancyStatus=0;break;case"MANY_SEATS_AVAILABLE":case 1:t.occupancyStatus=1;break;case"FEW_SEATS_AVAILABLE":case 2:t.occupancyStatus=2;break;case"STANDING_ROOM_ONLY":case 3:t.occupancyStatus=3;break;case"CRUSHED_STANDING_ROOM_ONLY":case 4:t.occupancyStatus=4;break;case"FULL":case 5:t.occupancyStatus=5;break;case"NOT_ACCEPTING_PASSENGERS":case 6:t.occupancyStatus=6;break;default:if("number"==typeof e.occupancyStatus){t.occupancyStatus=e.occupancyStatus;break}break;case"NO_DATA_AVAILABLE":case 7:t.occupancyStatus=7;break;case"NOT_BOARDABLE":case 8:t.occupancyStatus=8}return null!=e.occupancyPercentage&&(t.occupancyPercentage=0|e.occupancyPercentage),null!=e.carriageSequence&&(t.carriageSequence=e.carriageSequence>>>0),t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.id="",i.label="",i.occupancyStatus=t.enums===String?"NO_DATA_AVAILABLE":7,i.occupancyPercentage=-1,i.carriageSequence=0),null!=e.id&&e.hasOwnProperty("id")&&(i.id=e.id),null!=e.label&&e.hasOwnProperty("label")&&(i.label=e.label),null!=e.occupancyStatus&&e.hasOwnProperty("occupancyStatus")&&(i.occupancyStatus=t.enums===String?void 0===o.transit_realtime.VehiclePosition.OccupancyStatus[e.occupancyStatus]?e.occupancyStatus:o.transit_realtime.VehiclePosition.OccupancyStatus[e.occupancyStatus]:e.occupancyStatus),null!=e.occupancyPercentage&&e.hasOwnProperty("occupancyPercentage")&&(i.occupancyPercentage=e.occupancyPercentage),null!=e.carriageSequence&&e.hasOwnProperty("carriageSequence")&&(i.carriageSequence=e.carriageSequence),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.VehiclePosition.CarriageDetails"},e}(),e}(),e.Alert=function(){function e(e){if(this.activePeriod=[],this.informedEntity=[],e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}var s,a;return e.prototype.activePeriod=r.emptyArray,e.prototype.informedEntity=r.emptyArray,e.prototype.cause=1,e.prototype.effect=8,e.prototype.url=null,e.prototype.headerText=null,e.prototype.descriptionText=null,e.prototype.ttsHeaderText=null,e.prototype.ttsDescriptionText=null,e.prototype.severityLevel=1,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=n.create()),null!=e.activePeriod&&e.activePeriod.length)for(var i=0;i<e.activePeriod.length;++i)o.transit_realtime.TimeRange.encode(e.activePeriod[i],t.uint32(10).fork()).ldelim();if(null!=e.informedEntity&&e.informedEntity.length)for(i=0;i<e.informedEntity.length;++i)o.transit_realtime.EntitySelector.encode(e.informedEntity[i],t.uint32(42).fork()).ldelim();return null!=e.cause&&Object.hasOwnProperty.call(e,"cause")&&t.uint32(48).int32(e.cause),null!=e.effect&&Object.hasOwnProperty.call(e,"effect")&&t.uint32(56).int32(e.effect),null!=e.url&&Object.hasOwnProperty.call(e,"url")&&o.transit_realtime.TranslatedString.encode(e.url,t.uint32(66).fork()).ldelim(),null!=e.headerText&&Object.hasOwnProperty.call(e,"headerText")&&o.transit_realtime.TranslatedString.encode(e.headerText,t.uint32(82).fork()).ldelim(),null!=e.descriptionText&&Object.hasOwnProperty.call(e,"descriptionText")&&o.transit_realtime.TranslatedString.encode(e.descriptionText,t.uint32(90).fork()).ldelim(),null!=e.ttsHeaderText&&Object.hasOwnProperty.call(e,"ttsHeaderText")&&o.transit_realtime.TranslatedString.encode(e.ttsHeaderText,t.uint32(98).fork()).ldelim(),null!=e.ttsDescriptionText&&Object.hasOwnProperty.call(e,"ttsDescriptionText")&&o.transit_realtime.TranslatedString.encode(e.ttsDescriptionText,t.uint32(106).fork()).ldelim(),null!=e.severityLevel&&Object.hasOwnProperty.call(e,"severityLevel")&&t.uint32(112).int32(e.severityLevel),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.Alert;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.activePeriod&&r.activePeriod.length||(r.activePeriod=[]),r.activePeriod.push(o.transit_realtime.TimeRange.decode(e,e.uint32()));break;case 5:r.informedEntity&&r.informedEntity.length||(r.informedEntity=[]),r.informedEntity.push(o.transit_realtime.EntitySelector.decode(e,e.uint32()));break;case 6:r.cause=e.int32();break;case 7:r.effect=e.int32();break;case 8:r.url=o.transit_realtime.TranslatedString.decode(e,e.uint32());break;case 10:r.headerText=o.transit_realtime.TranslatedString.decode(e,e.uint32());break;case 11:r.descriptionText=o.transit_realtime.TranslatedString.decode(e,e.uint32());break;case 12:r.ttsHeaderText=o.transit_realtime.TranslatedString.decode(e,e.uint32());break;case 13:r.ttsDescriptionText=o.transit_realtime.TranslatedString.decode(e,e.uint32());break;case 14:r.severityLevel=e.int32();break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.activePeriod&&e.hasOwnProperty("activePeriod")){if(!Array.isArray(e.activePeriod))return"activePeriod: array expected";for(var t=0;t<e.activePeriod.length;++t)if(i=o.transit_realtime.TimeRange.verify(e.activePeriod[t]))return"activePeriod."+i}if(null!=e.informedEntity&&e.hasOwnProperty("informedEntity")){if(!Array.isArray(e.informedEntity))return"informedEntity: array expected";for(t=0;t<e.informedEntity.length;++t)if(i=o.transit_realtime.EntitySelector.verify(e.informedEntity[t]))return"informedEntity."+i}if(null!=e.cause&&e.hasOwnProperty("cause"))switch(e.cause){default:return"cause: enum value expected";case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:}if(null!=e.effect&&e.hasOwnProperty("effect"))switch(e.effect){default:return"effect: enum value expected";case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:}var i;if(null!=e.url&&e.hasOwnProperty("url")&&(i=o.transit_realtime.TranslatedString.verify(e.url)))return"url."+i;if(null!=e.headerText&&e.hasOwnProperty("headerText")&&(i=o.transit_realtime.TranslatedString.verify(e.headerText)))return"headerText."+i;if(null!=e.descriptionText&&e.hasOwnProperty("descriptionText")&&(i=o.transit_realtime.TranslatedString.verify(e.descriptionText)))return"descriptionText."+i;if(null!=e.ttsHeaderText&&e.hasOwnProperty("ttsHeaderText")&&(i=o.transit_realtime.TranslatedString.verify(e.ttsHeaderText)))return"ttsHeaderText."+i;if(null!=e.ttsDescriptionText&&e.hasOwnProperty("ttsDescriptionText")&&(i=o.transit_realtime.TranslatedString.verify(e.ttsDescriptionText)))return"ttsDescriptionText."+i;if(null!=e.severityLevel&&e.hasOwnProperty("severityLevel"))switch(e.severityLevel){default:return"severityLevel: enum value expected";case 1:case 2:case 3:case 4:}return null},e.fromObject=function(e){if(e instanceof o.transit_realtime.Alert)return e;var t=new o.transit_realtime.Alert;if(e.activePeriod){if(!Array.isArray(e.activePeriod))throw TypeError(".transit_realtime.Alert.activePeriod: array expected");t.activePeriod=[];for(var i=0;i<e.activePeriod.length;++i){if("object"!=typeof e.activePeriod[i])throw TypeError(".transit_realtime.Alert.activePeriod: object expected");t.activePeriod[i]=o.transit_realtime.TimeRange.fromObject(e.activePeriod[i])}}if(e.informedEntity){if(!Array.isArray(e.informedEntity))throw TypeError(".transit_realtime.Alert.informedEntity: array expected");for(t.informedEntity=[],i=0;i<e.informedEntity.length;++i){if("object"!=typeof e.informedEntity[i])throw TypeError(".transit_realtime.Alert.informedEntity: object expected");t.informedEntity[i]=o.transit_realtime.EntitySelector.fromObject(e.informedEntity[i])}}switch(e.cause){default:if("number"==typeof e.cause){t.cause=e.cause;break}break;case"UNKNOWN_CAUSE":case 1:t.cause=1;break;case"OTHER_CAUSE":case 2:t.cause=2;break;case"TECHNICAL_PROBLEM":case 3:t.cause=3;break;case"STRIKE":case 4:t.cause=4;break;case"DEMONSTRATION":case 5:t.cause=5;break;case"ACCIDENT":case 6:t.cause=6;break;case"HOLIDAY":case 7:t.cause=7;break;case"WEATHER":case 8:t.cause=8;break;case"MAINTENANCE":case 9:t.cause=9;break;case"CONSTRUCTION":case 10:t.cause=10;break;case"POLICE_ACTIVITY":case 11:t.cause=11;break;case"MEDICAL_EMERGENCY":case 12:t.cause=12}switch(e.effect){case"NO_SERVICE":case 1:t.effect=1;break;case"REDUCED_SERVICE":case 2:t.effect=2;break;case"SIGNIFICANT_DELAYS":case 3:t.effect=3;break;case"DETOUR":case 4:t.effect=4;break;case"ADDITIONAL_SERVICE":case 5:t.effect=5;break;case"MODIFIED_SERVICE":case 6:t.effect=6;break;case"OTHER_EFFECT":case 7:t.effect=7;break;default:if("number"==typeof e.effect){t.effect=e.effect;break}break;case"UNKNOWN_EFFECT":case 8:t.effect=8;break;case"STOP_MOVED":case 9:t.effect=9;break;case"NO_EFFECT":case 10:t.effect=10;break;case"ACCESSIBILITY_ISSUE":case 11:t.effect=11}if(null!=e.url){if("object"!=typeof e.url)throw TypeError(".transit_realtime.Alert.url: object expected");t.url=o.transit_realtime.TranslatedString.fromObject(e.url)}if(null!=e.headerText){if("object"!=typeof e.headerText)throw TypeError(".transit_realtime.Alert.headerText: object expected");t.headerText=o.transit_realtime.TranslatedString.fromObject(e.headerText)}if(null!=e.descriptionText){if("object"!=typeof e.descriptionText)throw TypeError(".transit_realtime.Alert.descriptionText: object expected");t.descriptionText=o.transit_realtime.TranslatedString.fromObject(e.descriptionText)}if(null!=e.ttsHeaderText){if("object"!=typeof e.ttsHeaderText)throw TypeError(".transit_realtime.Alert.ttsHeaderText: object expected");t.ttsHeaderText=o.transit_realtime.TranslatedString.fromObject(e.ttsHeaderText)}if(null!=e.ttsDescriptionText){if("object"!=typeof e.ttsDescriptionText)throw TypeError(".transit_realtime.Alert.ttsDescriptionText: object expected");t.ttsDescriptionText=o.transit_realtime.TranslatedString.fromObject(e.ttsDescriptionText)}switch(e.severityLevel){default:if("number"==typeof e.severityLevel){t.severityLevel=e.severityLevel;break}break;case"UNKNOWN_SEVERITY":case 1:t.severityLevel=1;break;case"INFO":case 2:t.severityLevel=2;break;case"WARNING":case 3:t.severityLevel=3;break;case"SEVERE":case 4:t.severityLevel=4}return t},e.toObject=function(e,t){t||(t={});var i={};if((t.arrays||t.defaults)&&(i.activePeriod=[],i.informedEntity=[]),t.defaults&&(i.cause=t.enums===String?"UNKNOWN_CAUSE":1,i.effect=t.enums===String?"UNKNOWN_EFFECT":8,i.url=null,i.headerText=null,i.descriptionText=null,i.ttsHeaderText=null,i.ttsDescriptionText=null,i.severityLevel=t.enums===String?"UNKNOWN_SEVERITY":1),e.activePeriod&&e.activePeriod.length){i.activePeriod=[];for(var n=0;n<e.activePeriod.length;++n)i.activePeriod[n]=o.transit_realtime.TimeRange.toObject(e.activePeriod[n],t)}if(e.informedEntity&&e.informedEntity.length)for(i.informedEntity=[],n=0;n<e.informedEntity.length;++n)i.informedEntity[n]=o.transit_realtime.EntitySelector.toObject(e.informedEntity[n],t);return null!=e.cause&&e.hasOwnProperty("cause")&&(i.cause=t.enums===String?void 0===o.transit_realtime.Alert.Cause[e.cause]?e.cause:o.transit_realtime.Alert.Cause[e.cause]:e.cause),null!=e.effect&&e.hasOwnProperty("effect")&&(i.effect=t.enums===String?void 0===o.transit_realtime.Alert.Effect[e.effect]?e.effect:o.transit_realtime.Alert.Effect[e.effect]:e.effect),null!=e.url&&e.hasOwnProperty("url")&&(i.url=o.transit_realtime.TranslatedString.toObject(e.url,t)),null!=e.headerText&&e.hasOwnProperty("headerText")&&(i.headerText=o.transit_realtime.TranslatedString.toObject(e.headerText,t)),null!=e.descriptionText&&e.hasOwnProperty("descriptionText")&&(i.descriptionText=o.transit_realtime.TranslatedString.toObject(e.descriptionText,t)),null!=e.ttsHeaderText&&e.hasOwnProperty("ttsHeaderText")&&(i.ttsHeaderText=o.transit_realtime.TranslatedString.toObject(e.ttsHeaderText,t)),null!=e.ttsDescriptionText&&e.hasOwnProperty("ttsDescriptionText")&&(i.ttsDescriptionText=o.transit_realtime.TranslatedString.toObject(e.ttsDescriptionText,t)),null!=e.severityLevel&&e.hasOwnProperty("severityLevel")&&(i.severityLevel=t.enums===String?void 0===o.transit_realtime.Alert.SeverityLevel[e.severityLevel]?e.severityLevel:o.transit_realtime.Alert.SeverityLevel[e.severityLevel]:e.severityLevel),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.Alert"},e.Cause=(s={},(a=Object.create(s))[s[1]="UNKNOWN_CAUSE"]=1,a[s[2]="OTHER_CAUSE"]=2,a[s[3]="TECHNICAL_PROBLEM"]=3,a[s[4]="STRIKE"]=4,a[s[5]="DEMONSTRATION"]=5,a[s[6]="ACCIDENT"]=6,a[s[7]="HOLIDAY"]=7,a[s[8]="WEATHER"]=8,a[s[9]="MAINTENANCE"]=9,a[s[10]="CONSTRUCTION"]=10,a[s[11]="POLICE_ACTIVITY"]=11,a[s[12]="MEDICAL_EMERGENCY"]=12,a),e.Effect=function(){var e={},t=Object.create(e);return t[e[1]="NO_SERVICE"]=1,t[e[2]="REDUCED_SERVICE"]=2,t[e[3]="SIGNIFICANT_DELAYS"]=3,t[e[4]="DETOUR"]=4,t[e[5]="ADDITIONAL_SERVICE"]=5,t[e[6]="MODIFIED_SERVICE"]=6,t[e[7]="OTHER_EFFECT"]=7,t[e[8]="UNKNOWN_EFFECT"]=8,t[e[9]="STOP_MOVED"]=9,t[e[10]="NO_EFFECT"]=10,t[e[11]="ACCESSIBILITY_ISSUE"]=11,t}(),e.SeverityLevel=function(){var e={},t=Object.create(e);return t[e[1]="UNKNOWN_SEVERITY"]=1,t[e[2]="INFO"]=2,t[e[3]="WARNING"]=3,t[e[4]="SEVERE"]=4,t}(),e}(),e.TimeRange=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.start=r.Long?r.Long.fromBits(0,0,!0):0,e.prototype.end=r.Long?r.Long.fromBits(0,0,!0):0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.start&&Object.hasOwnProperty.call(e,"start")&&t.uint32(8).uint64(e.start),null!=e.end&&Object.hasOwnProperty.call(e,"end")&&t.uint32(16).uint64(e.end),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.TimeRange;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.start=e.uint64();break;case 2:r.end=e.uint64();break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.start&&e.hasOwnProperty("start")&&!(r.isInteger(e.start)||e.start&&r.isInteger(e.start.low)&&r.isInteger(e.start.high))?"start: integer|Long expected":null!=e.end&&e.hasOwnProperty("end")&&!(r.isInteger(e.end)||e.end&&r.isInteger(e.end.low)&&r.isInteger(e.end.high))?"end: integer|Long expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.TimeRange)return e;var t=new o.transit_realtime.TimeRange;return null!=e.start&&(r.Long?(t.start=r.Long.fromValue(e.start)).unsigned=!0:"string"==typeof e.start?t.start=parseInt(e.start,10):"number"==typeof e.start?t.start=e.start:"object"==typeof e.start&&(t.start=new r.LongBits(e.start.low>>>0,e.start.high>>>0).toNumber(!0))),null!=e.end&&(r.Long?(t.end=r.Long.fromValue(e.end)).unsigned=!0:"string"==typeof e.end?t.end=parseInt(e.end,10):"number"==typeof e.end?t.end=e.end:"object"==typeof e.end&&(t.end=new r.LongBits(e.end.low>>>0,e.end.high>>>0).toNumber(!0))),t},e.toObject=function(e,t){t||(t={});var i={};if(t.defaults){if(r.Long){var n=new r.Long(0,0,!0);i.start=t.longs===String?n.toString():t.longs===Number?n.toNumber():n}else i.start=t.longs===String?"0":0;r.Long?(n=new r.Long(0,0,!0),i.end=t.longs===String?n.toString():t.longs===Number?n.toNumber():n):i.end=t.longs===String?"0":0}return null!=e.start&&e.hasOwnProperty("start")&&(i.start="number"==typeof e.start?t.longs===String?String(e.start):e.start:t.longs===String?r.Long.prototype.toString.call(e.start):t.longs===Number?new r.LongBits(e.start.low>>>0,e.start.high>>>0).toNumber(!0):e.start),null!=e.end&&e.hasOwnProperty("end")&&(i.end="number"==typeof e.end?t.longs===String?String(e.end):e.end:t.longs===String?r.Long.prototype.toString.call(e.end):t.longs===Number?new r.LongBits(e.end.low>>>0,e.end.high>>>0).toNumber(!0):e.end),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TimeRange"},e}(),e.Position=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.latitude=0,e.prototype.longitude=0,e.prototype.bearing=0,e.prototype.odometer=0,e.prototype.speed=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),t.uint32(13).float(e.latitude),t.uint32(21).float(e.longitude),null!=e.bearing&&Object.hasOwnProperty.call(e,"bearing")&&t.uint32(29).float(e.bearing),null!=e.odometer&&Object.hasOwnProperty.call(e,"odometer")&&t.uint32(33).double(e.odometer),null!=e.speed&&Object.hasOwnProperty.call(e,"speed")&&t.uint32(45).float(e.speed),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new o.transit_realtime.Position;e.pos<n;){var a=e.uint32();switch(a>>>3){case 1:s.latitude=e.float();break;case 2:s.longitude=e.float();break;case 3:s.bearing=e.float();break;case 4:s.odometer=e.double();break;case 5:s.speed=e.float();break;default:e.skipType(7&a)}}if(!s.hasOwnProperty("latitude"))throw r.ProtocolError("missing required 'latitude'",{instance:s});if(!s.hasOwnProperty("longitude"))throw r.ProtocolError("missing required 'longitude'",{instance:s});return s},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":"number"!=typeof e.latitude?"latitude: number expected":"number"!=typeof e.longitude?"longitude: number expected":null!=e.bearing&&e.hasOwnProperty("bearing")&&"number"!=typeof e.bearing?"bearing: number expected":null!=e.odometer&&e.hasOwnProperty("odometer")&&"number"!=typeof e.odometer?"odometer: number expected":null!=e.speed&&e.hasOwnProperty("speed")&&"number"!=typeof e.speed?"speed: number expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.Position)return e;var t=new o.transit_realtime.Position;return null!=e.latitude&&(t.latitude=Number(e.latitude)),null!=e.longitude&&(t.longitude=Number(e.longitude)),null!=e.bearing&&(t.bearing=Number(e.bearing)),null!=e.odometer&&(t.odometer=Number(e.odometer)),null!=e.speed&&(t.speed=Number(e.speed)),t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.latitude=0,i.longitude=0,i.bearing=0,i.odometer=0,i.speed=0),null!=e.latitude&&e.hasOwnProperty("latitude")&&(i.latitude=t.json&&!isFinite(e.latitude)?String(e.latitude):e.latitude),null!=e.longitude&&e.hasOwnProperty("longitude")&&(i.longitude=t.json&&!isFinite(e.longitude)?String(e.longitude):e.longitude),null!=e.bearing&&e.hasOwnProperty("bearing")&&(i.bearing=t.json&&!isFinite(e.bearing)?String(e.bearing):e.bearing),null!=e.odometer&&e.hasOwnProperty("odometer")&&(i.odometer=t.json&&!isFinite(e.odometer)?String(e.odometer):e.odometer),null!=e.speed&&e.hasOwnProperty("speed")&&(i.speed=t.json&&!isFinite(e.speed)?String(e.speed):e.speed),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.Position"},e}(),e.TripDescriptor=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}var s,a;return e.prototype.tripId="",e.prototype.routeId="",e.prototype.directionId=0,e.prototype.startTime="",e.prototype.startDate="",e.prototype.scheduleRelationship=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.tripId&&Object.hasOwnProperty.call(e,"tripId")&&t.uint32(10).string(e.tripId),null!=e.startTime&&Object.hasOwnProperty.call(e,"startTime")&&t.uint32(18).string(e.startTime),null!=e.startDate&&Object.hasOwnProperty.call(e,"startDate")&&t.uint32(26).string(e.startDate),null!=e.scheduleRelationship&&Object.hasOwnProperty.call(e,"scheduleRelationship")&&t.uint32(32).int32(e.scheduleRelationship),null!=e.routeId&&Object.hasOwnProperty.call(e,"routeId")&&t.uint32(42).string(e.routeId),null!=e.directionId&&Object.hasOwnProperty.call(e,"directionId")&&t.uint32(48).uint32(e.directionId),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.TripDescriptor;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.tripId=e.string();break;case 5:r.routeId=e.string();break;case 6:r.directionId=e.uint32();break;case 2:r.startTime=e.string();break;case 3:r.startDate=e.string();break;case 4:r.scheduleRelationship=e.int32();break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.tripId&&e.hasOwnProperty("tripId")&&!r.isString(e.tripId))return"tripId: string expected";if(null!=e.routeId&&e.hasOwnProperty("routeId")&&!r.isString(e.routeId))return"routeId: string expected";if(null!=e.directionId&&e.hasOwnProperty("directionId")&&!r.isInteger(e.directionId))return"directionId: integer expected";if(null!=e.startTime&&e.hasOwnProperty("startTime")&&!r.isString(e.startTime))return"startTime: string expected";if(null!=e.startDate&&e.hasOwnProperty("startDate")&&!r.isString(e.startDate))return"startDate: string expected";if(null!=e.scheduleRelationship&&e.hasOwnProperty("scheduleRelationship"))switch(e.scheduleRelationship){default:return"scheduleRelationship: enum value expected";case 0:case 1:case 2:case 3:case 5:case 6:}return null},e.fromObject=function(e){if(e instanceof o.transit_realtime.TripDescriptor)return e;var t=new o.transit_realtime.TripDescriptor;switch(null!=e.tripId&&(t.tripId=String(e.tripId)),null!=e.routeId&&(t.routeId=String(e.routeId)),null!=e.directionId&&(t.directionId=e.directionId>>>0),null!=e.startTime&&(t.startTime=String(e.startTime)),null!=e.startDate&&(t.startDate=String(e.startDate)),e.scheduleRelationship){default:if("number"==typeof e.scheduleRelationship){t.scheduleRelationship=e.scheduleRelationship;break}break;case"SCHEDULED":case 0:t.scheduleRelationship=0;break;case"ADDED":case 1:t.scheduleRelationship=1;break;case"UNSCHEDULED":case 2:t.scheduleRelationship=2;break;case"CANCELED":case 3:t.scheduleRelationship=3;break;case"REPLACEMENT":case 5:t.scheduleRelationship=5;break;case"DUPLICATED":case 6:t.scheduleRelationship=6}return t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.tripId="",i.startTime="",i.startDate="",i.scheduleRelationship=t.enums===String?"SCHEDULED":0,i.routeId="",i.directionId=0),null!=e.tripId&&e.hasOwnProperty("tripId")&&(i.tripId=e.tripId),null!=e.startTime&&e.hasOwnProperty("startTime")&&(i.startTime=e.startTime),null!=e.startDate&&e.hasOwnProperty("startDate")&&(i.startDate=e.startDate),null!=e.scheduleRelationship&&e.hasOwnProperty("scheduleRelationship")&&(i.scheduleRelationship=t.enums===String?void 0===o.transit_realtime.TripDescriptor.ScheduleRelationship[e.scheduleRelationship]?e.scheduleRelationship:o.transit_realtime.TripDescriptor.ScheduleRelationship[e.scheduleRelationship]:e.scheduleRelationship),null!=e.routeId&&e.hasOwnProperty("routeId")&&(i.routeId=e.routeId),null!=e.directionId&&e.hasOwnProperty("directionId")&&(i.directionId=e.directionId),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TripDescriptor"},e.ScheduleRelationship=(s={},(a=Object.create(s))[s[0]="SCHEDULED"]=0,a[s[1]="ADDED"]=1,a[s[2]="UNSCHEDULED"]=2,a[s[3]="CANCELED"]=3,a[s[5]="REPLACEMENT"]=5,a[s[6]="DUPLICATED"]=6,a),e}(),e.VehicleDescriptor=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.id="",e.prototype.label="",e.prototype.licensePlate="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.id&&Object.hasOwnProperty.call(e,"id")&&t.uint32(10).string(e.id),null!=e.label&&Object.hasOwnProperty.call(e,"label")&&t.uint32(18).string(e.label),null!=e.licensePlate&&Object.hasOwnProperty.call(e,"licensePlate")&&t.uint32(26).string(e.licensePlate),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.VehicleDescriptor;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.id=e.string();break;case 2:r.label=e.string();break;case 3:r.licensePlate=e.string();break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.id&&e.hasOwnProperty("id")&&!r.isString(e.id)?"id: string expected":null!=e.label&&e.hasOwnProperty("label")&&!r.isString(e.label)?"label: string expected":null!=e.licensePlate&&e.hasOwnProperty("licensePlate")&&!r.isString(e.licensePlate)?"licensePlate: string expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.VehicleDescriptor)return e;var t=new o.transit_realtime.VehicleDescriptor;return null!=e.id&&(t.id=String(e.id)),null!=e.label&&(t.label=String(e.label)),null!=e.licensePlate&&(t.licensePlate=String(e.licensePlate)),t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.id="",i.label="",i.licensePlate=""),null!=e.id&&e.hasOwnProperty("id")&&(i.id=e.id),null!=e.label&&e.hasOwnProperty("label")&&(i.label=e.label),null!=e.licensePlate&&e.hasOwnProperty("licensePlate")&&(i.licensePlate=e.licensePlate),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.VehicleDescriptor"},e}(),e.EntitySelector=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.agencyId="",e.prototype.routeId="",e.prototype.routeType=0,e.prototype.trip=null,e.prototype.stopId="",e.prototype.directionId=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),null!=e.agencyId&&Object.hasOwnProperty.call(e,"agencyId")&&t.uint32(10).string(e.agencyId),null!=e.routeId&&Object.hasOwnProperty.call(e,"routeId")&&t.uint32(18).string(e.routeId),null!=e.routeType&&Object.hasOwnProperty.call(e,"routeType")&&t.uint32(24).int32(e.routeType),null!=e.trip&&Object.hasOwnProperty.call(e,"trip")&&o.transit_realtime.TripDescriptor.encode(e.trip,t.uint32(34).fork()).ldelim(),null!=e.stopId&&Object.hasOwnProperty.call(e,"stopId")&&t.uint32(42).string(e.stopId),null!=e.directionId&&Object.hasOwnProperty.call(e,"directionId")&&t.uint32(48).uint32(e.directionId),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.EntitySelector;e.pos<n;){var s=e.uint32();switch(s>>>3){case 1:r.agencyId=e.string();break;case 2:r.routeId=e.string();break;case 3:r.routeType=e.int32();break;case 4:r.trip=o.transit_realtime.TripDescriptor.decode(e,e.uint32());break;case 5:r.stopId=e.string();break;case 6:r.directionId=e.uint32();break;default:e.skipType(7&s)}}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.agencyId&&e.hasOwnProperty("agencyId")&&!r.isString(e.agencyId))return"agencyId: string expected";if(null!=e.routeId&&e.hasOwnProperty("routeId")&&!r.isString(e.routeId))return"routeId: string expected";if(null!=e.routeType&&e.hasOwnProperty("routeType")&&!r.isInteger(e.routeType))return"routeType: integer expected";if(null!=e.trip&&e.hasOwnProperty("trip")){var t=o.transit_realtime.TripDescriptor.verify(e.trip);if(t)return"trip."+t}return null!=e.stopId&&e.hasOwnProperty("stopId")&&!r.isString(e.stopId)?"stopId: string expected":null!=e.directionId&&e.hasOwnProperty("directionId")&&!r.isInteger(e.directionId)?"directionId: integer expected":null},e.fromObject=function(e){if(e instanceof o.transit_realtime.EntitySelector)return e;var t=new o.transit_realtime.EntitySelector;if(null!=e.agencyId&&(t.agencyId=String(e.agencyId)),null!=e.routeId&&(t.routeId=String(e.routeId)),null!=e.routeType&&(t.routeType=0|e.routeType),null!=e.trip){if("object"!=typeof e.trip)throw TypeError(".transit_realtime.EntitySelector.trip: object expected");t.trip=o.transit_realtime.TripDescriptor.fromObject(e.trip)}return null!=e.stopId&&(t.stopId=String(e.stopId)),null!=e.directionId&&(t.directionId=e.directionId>>>0),t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.agencyId="",i.routeId="",i.routeType=0,i.trip=null,i.stopId="",i.directionId=0),null!=e.agencyId&&e.hasOwnProperty("agencyId")&&(i.agencyId=e.agencyId),null!=e.routeId&&e.hasOwnProperty("routeId")&&(i.routeId=e.routeId),null!=e.routeType&&e.hasOwnProperty("routeType")&&(i.routeType=e.routeType),null!=e.trip&&e.hasOwnProperty("trip")&&(i.trip=o.transit_realtime.TripDescriptor.toObject(e.trip,t)),null!=e.stopId&&e.hasOwnProperty("stopId")&&(i.stopId=e.stopId),null!=e.directionId&&e.hasOwnProperty("directionId")&&(i.directionId=e.directionId),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.EntitySelector"},e}(),e.TranslatedString=function(){function e(e){if(this.translation=[],e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.translation=r.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=n.create()),null!=e.translation&&e.translation.length)for(var i=0;i<e.translation.length;++i)o.transit_realtime.TranslatedString.Translation.encode(e.translation[i],t.uint32(10).fork()).ldelim();return t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,r=new o.transit_realtime.TranslatedString;e.pos<n;){var s=e.uint32();s>>>3==1?(r.translation&&r.translation.length||(r.translation=[]),r.translation.push(o.transit_realtime.TranslatedString.Translation.decode(e,e.uint32()))):e.skipType(7&s)}return r},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.translation&&e.hasOwnProperty("translation")){if(!Array.isArray(e.translation))return"translation: array expected";for(var t=0;t<e.translation.length;++t){var i=o.transit_realtime.TranslatedString.Translation.verify(e.translation[t]);if(i)return"translation."+i}}return null},e.fromObject=function(e){if(e instanceof o.transit_realtime.TranslatedString)return e;var t=new o.transit_realtime.TranslatedString;if(e.translation){if(!Array.isArray(e.translation))throw TypeError(".transit_realtime.TranslatedString.translation: array expected");t.translation=[];for(var i=0;i<e.translation.length;++i){if("object"!=typeof e.translation[i])throw TypeError(".transit_realtime.TranslatedString.translation: object expected");t.translation[i]=o.transit_realtime.TranslatedString.Translation.fromObject(e.translation[i])}}return t},e.toObject=function(e,t){t||(t={});var i={};if((t.arrays||t.defaults)&&(i.translation=[]),e.translation&&e.translation.length){i.translation=[];for(var n=0;n<e.translation.length;++n)i.translation[n]=o.transit_realtime.TranslatedString.Translation.toObject(e.translation[n],t)}return i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TranslatedString"},e.Translation=function(){function e(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)null!=e[t[i]]&&(this[t[i]]=e[t[i]])}return e.prototype.text="",e.prototype.language="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=n.create()),t.uint32(10).string(e.text),null!=e.language&&Object.hasOwnProperty.call(e,"language")&&t.uint32(18).string(e.language),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof i||(e=i.create(e));for(var n=void 0===t?e.len:e.pos+t,s=new o.transit_realtime.TranslatedString.Translation;e.pos<n;){var a=e.uint32();switch(a>>>3){case 1:s.text=e.string();break;case 2:s.language=e.string();break;default:e.skipType(7&a)}}if(!s.hasOwnProperty("text"))throw r.ProtocolError("missing required 'text'",{instance:s});return s},e.decodeDelimited=function(e){return e instanceof i||(e=new i(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":r.isString(e.text)?null!=e.language&&e.hasOwnProperty("language")&&!r.isString(e.language)?"language: string expected":null:"text: string expected"},e.fromObject=function(e){if(e instanceof o.transit_realtime.TranslatedString.Translation)return e;var t=new o.transit_realtime.TranslatedString.Translation;return null!=e.text&&(t.text=String(e.text)),null!=e.language&&(t.language=String(e.language)),t},e.toObject=function(e,t){t||(t={});var i={};return t.defaults&&(i.text="",i.language=""),null!=e.text&&e.hasOwnProperty("text")&&(i.text=e.text),null!=e.language&&e.hasOwnProperty("language")&&(i.language=e.language),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,t.util.toJSONOptions)},e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/transit_realtime.TranslatedString.Translation"},e}(),e}(),e),gtfsRealtime=o}var gtfsRealtimeExports=requireGtfsRealtime(),GtfsRealtimeBindings=getDefaultExportFromCjs(gtfsRealtimeExports);const SHIFT_LEFT_32=4294967296,SHIFT_RIGHT_32=1/SHIFT_LEFT_32,TEXT_DECODER_MIN_LENGTH=12,utf8TextDecoder="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8"),PBF_VARINT=0,PBF_FIXED64=1,PBF_BYTES=2,PBF_FIXED32=5;class Pbf{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,i=this.length){for(;this.pos<i;){const i=this.readVarint(),n=i>>3,r=this.pos;this.type=7&i,e(n,t,this),this.pos===r&&this.skip(i)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*SHIFT_LEFT_32;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*SHIFT_LEFT_32;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let i,n;return n=t[this.pos++],i=127&n,n<128?i:(n=t[this.pos++],i|=(127&n)<<7,n<128?i:(n=t[this.pos++],i|=(127&n)<<14,n<128?i:(n=t[this.pos++],i|=(127&n)<<21,n<128?i:(n=t[this.pos],i|=(15&n)<<28,readVarintRemainder(i,e,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2==1?(e+1)/-2:e/2}readBoolean(){return Boolean(this.readVarint())}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=TEXT_DECODER_MIN_LENGTH&&utf8TextDecoder?utf8TextDecoder.decode(this.buf.subarray(t,e)):readUtf8(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const i=this.readPackedEnd();for(;this.pos<i;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return this.type===PBF_BYTES?this.readVarint()+this.pos:this.pos+1}skip(e){const t=7&e;if(t===PBF_VARINT)for(;this.buf[this.pos++]>127;);else if(t===PBF_BYTES)this.pos=this.readVarint()+this.pos;else if(t===PBF_FIXED32)this.pos+=4;else{if(t!==PBF_FIXED64)throw new Error(`Unimplemented type: ${t}`);this.pos+=8}}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const e=new Uint8Array(t);e.set(this.buf),this.buf=e,this.dataView=new DataView(e.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*SHIFT_RIGHT_32),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*SHIFT_RIGHT_32),!0),this.pos+=8}writeVarint(e){(e=+e||0)>268435455||e<0?writeBigVarint(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))}writeSVarint(e){this.writeVarint(e<0?2*-e-1:2*e)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(4*e.length),this.pos++;const t=this.pos;this.pos=writeUtf8(this.buf,e,this.pos);const i=this.pos-t;i>=128&&makeRoomForExtraLength(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let i=0;i<t;i++)this.buf[this.pos++]=e[i]}writeRawMessage(e,t){this.pos++;const i=this.pos;e(t,this);const n=this.pos-i;n>=128&&makeRoomForExtraLength(i,n,this),this.pos=i-1,this.writeVarint(n),this.pos+=n}writeMessage(e,t,i){this.writeTag(e,PBF_BYTES),this.writeRawMessage(t,i)}writePackedVarint(e,t){t.length&&this.writeMessage(e,writePackedVarint,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,writePackedSVarint,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,writePackedBoolean,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,writePackedFloat,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,writePackedDouble,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,writePackedFixed32,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,writePackedSFixed32,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,writePackedFixed64,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,writePackedSFixed64,t)}writeBytesField(e,t){this.writeTag(e,PBF_BYTES),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,PBF_FIXED32),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,PBF_FIXED32),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,PBF_FIXED64),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,PBF_FIXED64),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,PBF_VARINT),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,PBF_VARINT),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,PBF_BYTES),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,PBF_FIXED32),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,PBF_FIXED64),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}}function readVarintRemainder(e,t,i){const n=i.buf;let r,o;if(o=n[i.pos++],r=(112&o)>>4,o<128)return toNum(e,r,t);if(o=n[i.pos++],r|=(127&o)<<3,o<128)return toNum(e,r,t);if(o=n[i.pos++],r|=(127&o)<<10,o<128)return toNum(e,r,t);if(o=n[i.pos++],r|=(127&o)<<17,o<128)return toNum(e,r,t);if(o=n[i.pos++],r|=(127&o)<<24,o<128)return toNum(e,r,t);if(o=n[i.pos++],r|=(1&o)<<31,o<128)return toNum(e,r,t);throw new Error("Expected varint not more than 10 bytes")}function toNum(e,t,i){return i?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function writeBigVarint(e,t){let i,n;if(e>=0?(i=e%4294967296|0,n=e/4294967296|0):(i=~(-e%4294967296),n=~(-e/4294967296),4294967295^i?i=i+1|0:(i=0,n=n+1|0)),e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),writeBigVarintLow(i,n,t),writeBigVarintHigh(n,t)}function writeBigVarintLow(e,t,i){i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,i.buf[i.pos]=127&(e>>>=7)}function writeBigVarintHigh(e,t){const i=(7&e)<<4;t.buf[t.pos++]|=i|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e)))))}function makeRoomForExtraLength(e,t,i){const n=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));i.realloc(n);for(let t=i.pos-1;t>=e;t--)i.buf[t+n]=i.buf[t]}function writePackedVarint(e,t){for(let i=0;i<e.length;i++)t.writeVarint(e[i])}function writePackedSVarint(e,t){for(let i=0;i<e.length;i++)t.writeSVarint(e[i])}function writePackedFloat(e,t){for(let i=0;i<e.length;i++)t.writeFloat(e[i])}function writePackedDouble(e,t){for(let i=0;i<e.length;i++)t.writeDouble(e[i])}function writePackedBoolean(e,t){for(let i=0;i<e.length;i++)t.writeBoolean(e[i])}function writePackedFixed32(e,t){for(let i=0;i<e.length;i++)t.writeFixed32(e[i])}function writePackedSFixed32(e,t){for(let i=0;i<e.length;i++)t.writeSFixed32(e[i])}function writePackedFixed64(e,t){for(let i=0;i<e.length;i++)t.writeFixed64(e[i])}function writePackedSFixed64(e,t){for(let i=0;i<e.length;i++)t.writeSFixed64(e[i])}function readUtf8(e,t,i){let n="",r=t;for(;r<i;){const t=e[r];let o,s,a,l=null,c=t>239?4:t>223?3:t>191?2:1;if(r+c>i)break;1===c?t<128&&(l=t):2===c?(o=e[r+1],128==(192&o)&&(l=(31&t)<<6|63&o,l<=127&&(l=null))):3===c?(o=e[r+1],s=e[r+2],128==(192&o)&&128==(192&s)&&(l=(15&t)<<12|(63&o)<<6|63&s,(l<=2047||l>=55296&&l<=57343)&&(l=null))):4===c&&(o=e[r+1],s=e[r+2],a=e[r+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(l=(15&t)<<18|(63&o)<<12|(63&s)<<6|63&a,(l<=65535||l>=1114112)&&(l=null))),null===l?(l=65533,c=1):l>65535&&(l-=65536,n+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),n+=String.fromCharCode(l),r+=c}return n}function writeUtf8(e,t,i){for(let n,r,o=0;o<t.length;o++){if(n=t.charCodeAt(o),n>55295&&n<57344){if(!r){n>56319||o+1===t.length?(e[i++]=239,e[i++]=191,e[i++]=189):r=n;continue}if(n<56320){e[i++]=239,e[i++]=191,e[i++]=189,r=n;continue}n=r-55296<<10|n-56320|65536,r=null}else r&&(e[i++]=239,e[i++]=191,e[i++]=189,r=null);n<128?e[i++]=n:(n<2048?e[i++]=n>>6|192:(n<65536?e[i++]=n>>12|224:(e[i++]=n>>18|240,e[i++]=n>>12&63|128),e[i++]=n>>6&63|128),e[i++]=63&n|128)}return i}function decode(e){return e.readFields(((e,t,i)=>{1===e&&(t.agency=i.readString()),2===e&&t.stops.push(i.readFields(((e,t,i)=>{1===e?t.id=i.readString():2===e?t.name=i.readString():3===e&&(t.coord=i.readPackedDouble())}),{},i.readVarint()+i.pos)),3===e&&t.routes.push(i.readFields(((e,t,i)=>{1===e?t.id=i.readString():2===e?t.shortName=i.readString():3===e?t.longName=i.readString():4===e?t.color=i.readString():5===e?t.textColor=i.readString():6===e&&t.shapes.push(i.readString())}),{shapes:[]},i.readVarint()+i.pos)),4===e&&t.trips.push(i.readFields(((e,t,i)=>{1===e?t.id=i.readString():2===e?t.route=i.readString():3===e?t.shape=i.readString():4===e?i.readPackedVarint(t.departureTimes,!0):5===e?t.stops.push(i.readString()):6===e?i.readPackedVarint(t.stopSequences,!0):7===e&&t.headsigns.push(i.readString())}),{departureTimes:[],stops:[],stopSequences:[],headsigns:[]},i.readVarint()+i.pos)),5===e&&(t.version=i.readString())}),{stops:[],routes:[],trips:[]})}const RAILWAYS_FOR_TRAINS={odpt:["Toei.Asakusa","Toei.Mita","Toei.Shinjuku","Toei.Oedo","Toei.Arakawa"],challenge2025:["Keikyu.Main","Keikyu.Airport","Keikyu.Daishi","Keikyu.Zushi","Keikyu.Kurihama","Tobu.TobuSkytree","Tobu.TobuSkytreeBranch","Tobu.Isesaki","Tobu.Nikko","Tobu.TobuUrbanPark","Tobu.Kameido","Tobu.Daishi","Tobu.Tojo","Tobu.Ogose"]},OPERATORS_FOR_TRAININFORMATION={odpt:["TWR","TokyoMetro","Toei","YokohamaMunicipal","MIR","TamaMonorail"],challenge2025:["jre-is","Tokyu","Keikyu","Tobu","Seibu","Keio"]},RAILWAY_SOBURAPID="JR-East.SobuRapid",TRAINTYPE_JREAST_LIMITEDEXPRESS="JR-East.LimitedExpress";function getTimetableFileName(e){return`timetable-${"Weekday"===e.getCalendar()?"weekday":"holiday"}.json.gz`}function getExtraTimetableFileNames(e){const t=e.getCalendar();return"Saturday"===t?["timetable-saturday.json.gz"]:"Holiday"===t?["timetable-sunday-holiday.json.gz"]:[]}function adjustTrainID(e,t,i){return t===TRAINTYPE_JREAST_LIMITEDEXPRESS&&i[0].match(/NaritaAirportTerminal1|Takao|Ofuna|Omiya|Ikebukuro|Shinjuku/)?e.replace(/JR-East\.(NaritaAirportBranch|Narita|Sobu)/,RAILWAY_SOBURAPID):e}function loadStaticData(e,t,i){return Promise.all([loadJSON(`assets/dictionary-${t}.json`),...["railways.json.gz","stations.json.gz","features.json.gz","rail-directions.json.gz","train-types.json.gz","train-vehicles.json.gz","operators.json.gz","airports.json.gz","flight-statuses.json.gz","poi.json.gz"].map((t=>`${e}/${t}`)).map(loadJSON),i.then((t=>Promise.all([getTimetableFileName(t),...getExtraTimetableFileNames(t)].map((t=>`${e}/${t}`)).map(loadJSON))))]).then((e=>({dict:e[0],railwayData:e[1],stationData:e[2],featureCollection:e[3],railDirectionData:e[4],trainTypeData:e[5],trainVehicleData:e[6],operatorData:e[7],airportData:e[8],flightStatusData:e[9],poiData:e[10],timetableData:[].concat(...e[11])})))}function loadTimetableData(e,t){return Promise.all([getTimetableFileName(t),...getExtraTimetableFileNames(t)].map((t=>`${e}/${t}`)).map(loadJSON)).then((e=>[].concat(...e)))}function loadDynamicTrainData(e){const t=new Map,i=[],n=[];for(const t of Object.keys(RAILWAYS_FOR_TRAINS)){const i=configs.apiUrl[t],r=e[t];if("odpt"===t||"challenge2025"===t){const e=RAILWAYS_FOR_TRAINS[t].map((e=>`odpt.Railway:${e}`)).join(",");n.push(`${i}odpt:Train?odpt:railway=${e}&acl:consumerKey=${r}`)}}n.push(configs.tidUrl);for(const t of Object.keys(OPERATORS_FOR_TRAININFORMATION)){const i=configs.apiUrl[t],r=e[t];if("odpt"===t||"challenge2025"===t){const e=OPERATORS_FOR_TRAININFORMATION[t].map((e=>`odpt.Operator:${e}`)).join(",");n.push(`${i}odpt:TrainInformation?odpt:operator=${e}&acl:consumerKey=${r}`)}}return n.push(configs.trainInfoUrl),Promise.all(n.map(loadJSON)).then((e=>{for(const i of[...e.shift(),...e.shift()]){const e=removePrefix(i["odpt:trainType"]),n=removePrefix(i["odpt:destinationStation"]),r=adjustTrainID(removePrefix(i["owl:sameAs"]),e,n);t.set(r,{id:r,o:removePrefix(i["odpt:operator"]),r:removePrefix(i["odpt:railway"]),y:e,n:i["odpt:trainNumber"],os:removePrefix(i["odpt:originStation"]),d:removePrefix(i["odpt:railDirection"]),ds:n,ts:removePrefix(i["odpt:toStation"]),fs:removePrefix(i["odpt:fromStation"]),delay:1e3*(i["odpt:delay"]||0),carComposition:i["odpt:carComposition"],date:i["dc:date"].replace(/([\d\-])T([\d:]+).*/,"$1 $2")})}for(const i of e.shift()){const e=i.id;t.has(e)?Object.assign(t.get(e),i):t.set(e,i)}for(const t of[...e.shift(),...e.shift()])i.push({operator:removePrefix(t["odpt:operator"]),railway:removePrefix(t["odpt:railway"]),status:t["odpt:trainInformationStatus"],text:t["odpt:trainInformationText"]});for(const t of e.shift())i.push(t);return{trainData:Array.from(t.values()),trainInfoData:i}}))}function loadDynamicFlightData(){return Promise.all([configs.atisUrl,configs.flightUrl].map(loadJSON)).then((e=>({atisData:e[0],flightData:e[1]})))}function loadBusData(e,t,i){const n=URL.createObjectURL(new Blob(['!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";var t=6371008.8,e={meters:t,metres:t,millimeters:6371008800,millimetres:6371008800,centimeters:637100880,centimetres:637100880,kilometers:6371.0088,kilometres:6371.0088,miles:3958.761333810546,nauticalmiles:t/1852,inches:39.37*t,yards:5825721.287490856,feet:20902260.511392,radians:1,degrees:57.22891354143274};function n(t,e,n){if(!l(n=n||{}))throw new Error("options is invalid");var i=n.bbox,r=n.id;if(void 0===t)throw new Error("geometry is required");if(e&&e.constructor!==Object)throw new Error("properties must be an Object");i&&c(i),r&&h(r);var o={type:"Feature"};return r&&(o.id=r),i&&(o.bbox=i),o.properties=e||{},o.geometry=t,o}function i(t,e,i){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!u(t[0])||!u(t[1]))throw new Error("coordinates must contain numbers");return n({type:"Point",coordinates:t},e,i)}function r(t,e,i){if(!t)throw new Error("coordinates is required");if(t.length<2)throw new Error("coordinates must be an array of two or more positions");if(!u(t[0][1])||!u(t[0][1]))throw new Error("coordinates must contain numbers");return n({type:"LineString",coordinates:t},e,i)}function o(t,e){if(!l(e=e||{}))throw new Error("options is invalid");var n=e.bbox,i=e.id;if(!t)throw new Error("No features passed");if(!Array.isArray(t))throw new Error("features must be an Array");n&&c(n),i&&h(i);var r={type:"FeatureCollection"};return i&&(r.id=i),n&&(r.bbox=n),r.features=t,r}function s(t,n){if(null==t)throw new Error("radians is required");if(n&&"string"!=typeof n)throw new Error("units must be a string");var i=e[n||"kilometers"];if(!i)throw new Error(n+" units is invalid");return t*i}function a(t){if(null==t)throw new Error("degrees is required");return t%360*Math.PI/180}function u(t){return!isNaN(t)&&null!==t&&!Array.isArray(t)}function l(t){return!!t&&t.constructor===Object}function c(t){if(!t)throw new Error("bbox is required");if(!Array.isArray(t))throw new Error("bbox must be an Array");if(4!==t.length&&6!==t.length)throw new Error("bbox must be an Array of 4 or 6 numbers");t.forEach((function(t){if(!u(t))throw new Error("bbox must only contain numbers")}))}function h(t){if(!t)throw new Error("id is required");if(-1===["string","number"].indexOf(typeof t))throw new Error("id must be a number or a string")}function p(t,e,n){if(null!==t)for(var i,r,o,s,a,u,l,c,h=0,f=0,g=t.type,d="FeatureCollection"===g,y="Feature"===g,_=d?t.features.length:1,m=0;m<_;m++){a=(c=!!(l=d?t.features[m].geometry:y?t.geometry:t)&&"GeometryCollection"===l.type)?l.geometries.length:1;for(var v=0;v<a;v++){var x=0,I=0;if(null!==(s=c?l.geometries[v]:l)){u=s.coordinates;var E=s.type;switch(h=0,E){case null:break;case"Point":if(!1===e(u,f,m,x,I))return!1;f++,x++;break;case"LineString":case"MultiPoint":for(i=0;i<u.length;i++){if(!1===e(u[i],f,m,x,I))return!1;f++,"MultiPoint"===E&&x++}"LineString"===E&&x++;break;case"Polygon":case"MultiLineString":for(i=0;i<u.length;i++){for(r=0;r<u[i].length-h;r++){if(!1===e(u[i][r],f,m,x,I))return!1;f++}"MultiLineString"===E&&x++,"Polygon"===E&&I++}"Polygon"===E&&x++;break;case"MultiPolygon":for(i=0;i<u.length;i++){for("MultiPolygon"===E&&(I=0),r=0;r<u[i].length;r++){for(o=0;o<u[i][r].length-h;o++){if(!1===e(u[i][r][o],f,m,x,I))return!1;f++}I++}x++}break;case"GeometryCollection":for(i=0;i<s.geometries.length;i++)if(!1===p(s.geometries[i],e))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function f(t,e){if("Feature"===t.type)e(t,0);else if("FeatureCollection"===t.type)for(var n=0;n<t.features.length&&!1!==e(t.features[n],n);n++);}function g(t,e){var n,i,r,o,s,a,u,l,c,h,p=0,f="FeatureCollection"===t.type,g="Feature"===t.type,d=f?t.features.length:1;for(n=0;n<d;n++){for(l=f?t.features[n].properties:g?t.properties:{},c=f?t.features[n].bbox:g?t.bbox:void 0,h=f?t.features[n].id:g?t.id:void 0,s=(u=!!(a=f?t.features[n].geometry:g?t.geometry:t)&&"GeometryCollection"===a.type)?a.geometries.length:1,r=0;r<s;r++)if(null!==(o=u?a.geometries[r]:a))switch(o.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===e(o,p,l,c,h))return!1;break;case"GeometryCollection":for(i=0;i<o.geometries.length;i++)if(!1===e(o.geometries[i],p,l,c,h))return!1;break;default:throw new Error("Unknown Geometry Type")}else if(!1===e(null,p,l,c,h))return!1;p++}}function d(t){var e=[1/0,1/0,-1/0,-1/0];return p(t,(function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])})),e}function y(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function _(t){if(Object.prototype.hasOwnProperty.call(t,"__esModule"))return t;var e=t.default;if("function"==typeof e){var n=function t(){var n=!1;try{n=this instanceof t}catch{}return n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};n.prototype=e.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(t).forEach((function(e){var i=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(n,e,i.get?i:{enumerable:!0,get:function(){return t[e]}})})),n}var m,v={exports:{}};var x=(m||(m=1,function(t){function e(){}function n(t){this.message=t||""}function i(t){this.message=t||""}function r(t){this.message=t||""}function o(){}function s(t){return null===t?Dt:t.color}function a(t){return null===t?null:t.parent}function u(t,e){null!==t&&(t.color=e)}function l(t){return null===t?null:t.left}function c(t){return null===t?null:t.right}function h(){this.root_=null,this.size_=0}function p(){}function f(){this.array_=[],arguments[0]instanceof xt&&this.addAll(arguments[0])}function g(){}function d(t){this.message=t||""}function y(){this.array_=[]}"fill"in Array.prototype||Object.defineProperty(Array.prototype,"fill",{configurable:!0,value:function(t){if(null==this)throw new TypeError(this+" is not an object");var e=Object(this),n=Math.max(Math.min(e.length,9007199254740991),0)||0,i=1 in arguments&&parseInt(Number(arguments[1]),10)||0;i=i<0?Math.max(n+i,0):Math.min(i,n);var r=2 in arguments&&void 0!==arguments[2]?parseInt(Number(arguments[2]),10)||0:n;for(r=r<0?Math.max(n+arguments[2],0):Math.min(r,n);i<r;)e[i]=t,++i;return e},writable:!0}),Number.isFinite=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},Number.parseFloat=Number.parseFloat||parseFloat,Number.isNaN=Number.isNaN||function(t){return t!=t},Math.trunc=Math.trunc||function(t){return t<0?Math.ceil(t):Math.floor(t)};var _=function(){};_.prototype.interfaces_=function(){return[]},_.prototype.getClass=function(){return _},_.prototype.equalsWithTolerance=function(t,e,n){return Math.abs(t-e)<=n};var m=function(t){function e(e){t.call(this,e),this.name="IllegalArgumentException",this.message=e,this.stack=(new t).stack}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Error),v=function(){},x={MAX_VALUE:{configurable:!0}};v.isNaN=function(t){return Number.isNaN(t)},v.doubleToLongBits=function(t){return t},v.longBitsToDouble=function(t){return t},v.isInfinite=function(t){return!Number.isFinite(t)},x.MAX_VALUE.get=function(){return Number.MAX_VALUE},Object.defineProperties(v,x);var I=function(){},E=function(){},N=function(){},w=function t(){if(this.x=null,this.y=null,this.z=null,0===arguments.length)this.x=0,this.y=0,this.z=t.NULL_ORDINATE;else if(1===arguments.length){var e=arguments[0];this.x=e.x,this.y=e.y,this.z=e.z}else 2===arguments.length?(this.x=arguments[0],this.y=arguments[1],this.z=t.NULL_ORDINATE):3===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2])},C={DimensionalComparator:{configurable:!0},serialVersionUID:{configurable:!0},NULL_ORDINATE:{configurable:!0},X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0}};w.prototype.setOrdinate=function(t,e){switch(t){case w.X:this.x=e;break;case w.Y:this.y=e;break;case w.Z:this.z=e;break;default:throw new m("Invalid ordinate index: "+t)}},w.prototype.equals2D=function(){if(1===arguments.length){var t=arguments[0];return this.x===t.x&&this.y===t.y}if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!_.equalsWithTolerance(this.x,e.x,n)&&!!_.equalsWithTolerance(this.y,e.y,n)}},w.prototype.getOrdinate=function(t){switch(t){case w.X:return this.x;case w.Y:return this.y;case w.Z:return this.z}throw new m("Invalid ordinate index: "+t)},w.prototype.equals3D=function(t){return this.x===t.x&&this.y===t.y&&(this.z===t.z||v.isNaN(this.z))&&v.isNaN(t.z)},w.prototype.equals=function(t){return t instanceof w&&this.equals2D(t)},w.prototype.equalInZ=function(t,e){return _.equalsWithTolerance(this.z,t.z,e)},w.prototype.compareTo=function(t){return this.x<t.x?-1:this.x>t.x?1:this.y<t.y?-1:this.y>t.y?1:0},w.prototype.clone=function(){},w.prototype.copy=function(){return new w(this)},w.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"},w.prototype.distance3D=function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return Math.sqrt(e*e+n*n+i*i)},w.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},w.prototype.hashCode=function(){var t=17;return 37*(t=37*t+w.hashCode(this.x))+w.hashCode(this.y)},w.prototype.setCoordinate=function(t){this.x=t.x,this.y=t.y,this.z=t.z},w.prototype.interfaces_=function(){return[I,E,e]},w.prototype.getClass=function(){return w},w.hashCode=function(){if(1===arguments.length)return v.doubleToLongBits(arguments[0]),Math.trunc(0)},C.DimensionalComparator.get=function(){return S},C.serialVersionUID.get=function(){return 0x5cbf2c235c7e5800},C.NULL_ORDINATE.get=function(){return v.NaN},C.X.get=function(){return 0},C.Y.get=function(){return 1},C.Z.get=function(){return 2},Object.defineProperties(w,C);var S=function(t){if(this._dimensionsToTest=2,0===arguments.length);else if(1===arguments.length){var e=arguments[0];if(2!==e&&3!==e)throw new m("only 2 or 3 dimensions may be specified");this._dimensionsToTest=e}};S.prototype.compare=function(t,e){var n=t,i=e,r=S.compare(n.x,i.x);if(0!==r)return r;var o=S.compare(n.y,i.y);return 0!==o?o:this._dimensionsToTest<=2?0:S.compare(n.z,i.z)},S.prototype.interfaces_=function(){return[N]},S.prototype.getClass=function(){return S},S.compare=function(t,e){return t<e?-1:t>e?1:v.isNaN(t)?v.isNaN(e)?0:-1:v.isNaN(e)?1:0};var b=function(){};b.prototype.create=function(){},b.prototype.interfaces_=function(){return[]},b.prototype.getClass=function(){return b};var L=function(){},O={INTERIOR:{configurable:!0},BOUNDARY:{configurable:!0},EXTERIOR:{configurable:!0},NONE:{configurable:!0}};L.prototype.interfaces_=function(){return[]},L.prototype.getClass=function(){return L},L.toLocationSymbol=function(t){switch(t){case L.EXTERIOR:return"e";case L.BOUNDARY:return"b";case L.INTERIOR:return"i";case L.NONE:return"-"}throw new m("Unknown location value: "+t)},O.INTERIOR.get=function(){return 0},O.BOUNDARY.get=function(){return 1},O.EXTERIOR.get=function(){return 2},O.NONE.get=function(){return-1},Object.defineProperties(L,O);var P=function(t,e){return t.interfaces_&&t.interfaces_().indexOf(e)>-1},T=function(){},M={LOG_10:{configurable:!0}};T.prototype.interfaces_=function(){return[]},T.prototype.getClass=function(){return T},T.log10=function(t){var e=Math.log(t);return v.isInfinite(e)||v.isNaN(e)?e:e/T.LOG_10},T.min=function(t,e,n,i){var r=t;return e<r&&(r=e),n<r&&(r=n),i<r&&(r=i),r},T.clamp=function(){if("number"==typeof arguments[2]&&"number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1],n=arguments[2];return t<e?e:t>n?n:t}if(Number.isInteger(arguments[2])&&Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var i=arguments[0],r=arguments[1],o=arguments[2];return i<r?r:i>o?o:i}},T.wrap=function(t,e){return t<0?e- -t%e:t%e},T.max=function(){if(3===arguments.length){var t=arguments[1],e=arguments[2],n=arguments[0];return t>n&&(n=t),e>n&&(n=e),n}if(4===arguments.length){var i=arguments[1],r=arguments[2],o=arguments[3],s=arguments[0];return i>s&&(s=i),r>s&&(s=r),o>s&&(s=o),s}},T.average=function(t,e){return(t+e)/2},M.LOG_10.get=function(){return Math.log(10)},Object.defineProperties(T,M);var R=function(t){this.str=t};R.prototype.append=function(t){this.str+=t},R.prototype.setCharAt=function(t,e){this.str=this.str.substr(0,t)+e+this.str.substr(t+1)},R.prototype.toString=function(t){return this.str};var D=function(t){this.value=t};D.prototype.intValue=function(){return this.value},D.prototype.compareTo=function(t){return this.value<t?-1:this.value>t?1:0},D.isNaN=function(t){return Number.isNaN(t)};var A=function(){};A.isWhitespace=function(t){return t<=32&&t>=0||127===t},A.toUpperCase=function(t){return t.toUpperCase()};var F=function t(){this._hi=0,this._lo=0,0===arguments.length?this.init(0):1===arguments.length?"number"==typeof arguments[0]||arguments[0]instanceof t?this.init(arguments[0]):"string"==typeof arguments[0]&&t.call(this,t.parse(arguments[0])):2===arguments.length&&this.init(arguments[0],arguments[1])},G={PI:{configurable:!0},TWO_PI:{configurable:!0},PI_2:{configurable:!0},E:{configurable:!0},NaN:{configurable:!0},EPS:{configurable:!0},SPLIT:{configurable:!0},MAX_PRINT_DIGITS:{configurable:!0},TEN:{configurable:!0},ONE:{configurable:!0},SCI_NOT_EXPONENT_CHAR:{configurable:!0},SCI_NOT_ZERO:{configurable:!0}};F.prototype.le=function(t){return(this._hi<t._hi||this._hi===t._hi)&&this._lo<=t._lo},F.prototype.extractSignificantDigits=function(t,e){var n=this.abs(),i=F.magnitude(n._hi),r=F.TEN.pow(i);(n=n.divide(r)).gt(F.TEN)?(n=n.divide(F.TEN),i+=1):n.lt(F.ONE)&&(n=n.multiply(F.TEN),i-=1);for(var o=i+1,s=new R,a=F.MAX_PRINT_DIGITS-1,u=0;u<=a;u++){t&&u===o&&s.append(".");var l=Math.trunc(n._hi);if(l<0)break;var c=!1,h=0;l>9?(c=!0,h="9"):h="0"+l,s.append(h),n=n.subtract(F.valueOf(l)).multiply(F.TEN),c&&n.selfAdd(F.TEN);var p=!0,f=F.magnitude(n._hi);if(f<0&&Math.abs(f)>=a-u&&(p=!1),!p)break}return e[0]=i,s.toString()},F.prototype.sqr=function(){return this.multiply(this)},F.prototype.doubleValue=function(){return this._hi+this._lo},F.prototype.subtract=function(){return arguments[0]instanceof F?this.add(arguments[0].negate()):"number"==typeof arguments[0]?this.add(-arguments[0]):void 0},F.prototype.equals=function(){if(1===arguments.length){var t=arguments[0];return this._hi===t._hi&&this._lo===t._lo}},F.prototype.isZero=function(){return 0===this._hi&&0===this._lo},F.prototype.selfSubtract=function(){if(arguments[0]instanceof F){var t=arguments[0];return this.isNaN()?this:this.selfAdd(-t._hi,-t._lo)}if("number"==typeof arguments[0]){var e=arguments[0];return this.isNaN()?this:this.selfAdd(-e,0)}},F.prototype.getSpecialNumberString=function(){return this.isZero()?"0.0":this.isNaN()?"NaN ":null},F.prototype.min=function(t){return this.le(t)?this:t},F.prototype.selfDivide=function(){if(1===arguments.length){if(arguments[0]instanceof F){var t=arguments[0];return this.selfDivide(t._hi,t._lo)}if("number"==typeof arguments[0])return this.selfDivide(arguments[0],0)}else if(2===arguments.length){var e=arguments[0],n=null,i=null,r=null,o=null,s=null,a=null,u=null,l=null;return this._hi=l=(s=this._hi/e)+(a=(this._hi-(u=s*e)-(l=(n=(a=F.SPLIT*s)-(n=a-s))*(r=(l=F.SPLIT*e)-(r=l-e))-u+n*(o=e-r)+(i=s-n)*r+i*o)+this._lo-s*arguments[1])/e),this._lo=s-l+a,this}},F.prototype.dump=function(){return"DD<"+this._hi+", "+this._lo+">"},F.prototype.divide=function(){if(arguments[0]instanceof F){var t=arguments[0],e=null,n=null,i=null,r=null,o=null,s=null,a=null,u=null;return n=(o=this._hi/t._hi)-(e=(s=F.SPLIT*o)-(e=s-o)),u=e*(i=(u=F.SPLIT*t._hi)-(i=u-t._hi))-(a=o*t._hi)+e*(r=t._hi-i)+n*i+n*r,new F(u=o+(s=(this._hi-a-u+this._lo-o*t._lo)/t._hi),o-u+s)}if("number"==typeof arguments[0]){var l=arguments[0];return v.isNaN(l)?F.createNaN():F.copy(this).selfDivide(l,0)}},F.prototype.ge=function(t){return(this._hi>t._hi||this._hi===t._hi)&&this._lo>=t._lo},F.prototype.pow=function(t){if(0===t)return F.valueOf(1);var e=new F(this),n=F.valueOf(1),i=Math.abs(t);if(i>1)for(;i>0;)i%2==1&&n.selfMultiply(e),(i/=2)>0&&(e=e.sqr());else n=e;return t<0?n.reciprocal():n},F.prototype.ceil=function(){if(this.isNaN())return F.NaN;var t=Math.ceil(this._hi),e=0;return t===this._hi&&(e=Math.ceil(this._lo)),new F(t,e)},F.prototype.compareTo=function(t){return this._hi<t._hi?-1:this._hi>t._hi?1:this._lo<t._lo?-1:this._lo>t._lo?1:0},F.prototype.rint=function(){return this.isNaN()?this:this.add(.5).floor()},F.prototype.setValue=function(){return arguments[0]instanceof F||"number"==typeof arguments[0]?(this.init(arguments[0]),this):void 0},F.prototype.max=function(t){return this.ge(t)?this:t},F.prototype.sqrt=function(){if(this.isZero())return F.valueOf(0);if(this.isNegative())return F.NaN;var t=1/Math.sqrt(this._hi),e=F.valueOf(this._hi*t),n=this.subtract(e.sqr())._hi*(.5*t);return e.add(n)},F.prototype.selfAdd=function(){if(1===arguments.length){if(arguments[0]instanceof F){var t=arguments[0];return this.selfAdd(t._hi,t._lo)}if("number"==typeof arguments[0]){var e=arguments[0],n=null,i=null,r=null,o=null,s=null;return this._hi=(n=(r=this._hi+e)+(s=e-(o=r-this._hi)+(this._hi-(r-o))+this._lo))+(i=s+(r-n)),this._lo=i+(n-this._hi),this}}else if(2===arguments.length){var a=arguments[0],u=arguments[1],l=null,c=null,h=null,p=null,f=null,g=null,d=null;f=(p=this._hi+a)-(g=p-this._hi),h=(c=this._lo+u)-(d=c-this._lo);var y=(l=p+(g=(f=a-g+(this._hi-f))+c))+(g=(h=u-d+(this._lo-h))+(g+(p-l))),_=g+(l-y);return this._hi=y,this._lo=_,this}},F.prototype.selfMultiply=function(){if(1===arguments.length){if(arguments[0]instanceof F){var t=arguments[0];return this.selfMultiply(t._hi,t._lo)}if("number"==typeof arguments[0])return this.selfMultiply(arguments[0],0)}else if(2===arguments.length){var e=arguments[0],n=null,i=null,r=null,o=null,s=null,a=null;n=(s=F.SPLIT*this._hi)-this._hi,n=s-n;var u=(s=this._hi*e)+(a=n*(r=(a=F.SPLIT*e)-(r=a-e))-s+n*(o=e-r)+(i=this._hi-n)*r+i*o+(this._hi*arguments[1]+this._lo*e)),l=a+(n=s-u);return this._hi=u,this._lo=l,this}},F.prototype.selfSqr=function(){return this.selfMultiply(this)},F.prototype.floor=function(){if(this.isNaN())return F.NaN;var t=Math.floor(this._hi),e=0;return t===this._hi&&(e=Math.floor(this._lo)),new F(t,e)},F.prototype.negate=function(){return this.isNaN()?this:new F(-this._hi,-this._lo)},F.prototype.clone=function(){},F.prototype.multiply=function(){if(arguments[0]instanceof F){var t=arguments[0];return t.isNaN()?F.createNaN():F.copy(this).selfMultiply(t)}if("number"==typeof arguments[0]){var e=arguments[0];return v.isNaN(e)?F.createNaN():F.copy(this).selfMultiply(e,0)}},F.prototype.isNaN=function(){return v.isNaN(this._hi)},F.prototype.intValue=function(){return Math.trunc(this._hi)},F.prototype.toString=function(){var t=F.magnitude(this._hi);return t>=-3&&t<=20?this.toStandardNotation():this.toSciNotation()},F.prototype.toStandardNotation=function(){var t=this.getSpecialNumberString();if(null!==t)return t;var e=new Array(1).fill(null),n=this.extractSignificantDigits(!0,e),i=e[0]+1,r=n;return"."===n.charAt(0)?r="0"+n:i<0?r="0."+F.stringOfChar("0",-i)+n:-1===n.indexOf(".")&&(r=n+F.stringOfChar("0",i-n.length)+".0"),this.isNegative()?"-"+r:r},F.prototype.reciprocal=function(){var t=null,e=null,n=null,i=null,r=null,o=null,s=null,a=null;e=(r=1/this._hi)-(t=(o=F.SPLIT*r)-(t=o-r)),n=(a=F.SPLIT*this._hi)-this._hi;var u=r+(o=(1-(s=r*this._hi)-(a=t*(n=a-n)-s+t*(i=this._hi-n)+e*n+e*i)-r*this._lo)/this._hi);return new F(u,r-u+o)},F.prototype.toSciNotation=function(){if(this.isZero())return F.SCI_NOT_ZERO;var t=this.getSpecialNumberString();if(null!==t)return t;var e=new Array(1).fill(null),n=this.extractSignificantDigits(!1,e),i=F.SCI_NOT_EXPONENT_CHAR+e[0];if("0"===n.charAt(0))throw new Error("Found leading zero: "+n);var r="";n.length>1&&(r=n.substring(1));var o=n.charAt(0)+"."+r;return this.isNegative()?"-"+o+i:o+i},F.prototype.abs=function(){return this.isNaN()?F.NaN:this.isNegative()?this.negate():new F(this)},F.prototype.isPositive=function(){return(this._hi>0||0===this._hi)&&this._lo>0},F.prototype.lt=function(t){return(this._hi<t._hi||this._hi===t._hi)&&this._lo<t._lo},F.prototype.add=function(){if(arguments[0]instanceof F){var t=arguments[0];return F.copy(this).selfAdd(t)}if("number"==typeof arguments[0]){var e=arguments[0];return F.copy(this).selfAdd(e)}},F.prototype.init=function(){if(1===arguments.length){if("number"==typeof arguments[0])this._hi=arguments[0],this._lo=0;else if(arguments[0]instanceof F){var t=arguments[0];this._hi=t._hi,this._lo=t._lo}}else if(2===arguments.length){var e=arguments[1];this._hi=arguments[0],this._lo=e}},F.prototype.gt=function(t){return(this._hi>t._hi||this._hi===t._hi)&&this._lo>t._lo},F.prototype.isNegative=function(){return(this._hi<0||0===this._hi)&&this._lo<0},F.prototype.trunc=function(){return this.isNaN()?F.NaN:this.isPositive()?this.floor():this.ceil()},F.prototype.signum=function(){return this._hi>0?1:this._hi<0?-1:this._lo>0?1:this._lo<0?-1:0},F.prototype.interfaces_=function(){return[e,I,E]},F.prototype.getClass=function(){return F},F.sqr=function(t){return F.valueOf(t).selfMultiply(t)},F.valueOf=function(){return"string"==typeof arguments[0]?F.parse(arguments[0]):"number"==typeof arguments[0]?new F(arguments[0]):void 0},F.sqrt=function(t){return F.valueOf(t).sqrt()},F.parse=function(t){for(var e=0,n=t.length;A.isWhitespace(t.charAt(e));)e++;var i=!1;if(e<n){var r=t.charAt(e);"-"!==r&&"+"!==r||(e++,"-"===r&&(i=!0))}for(var o=new F,s=0,a=0,u=0;!(e>=n);){var l=t.charAt(e);if(e++,A.isDigit(l)){var c=l-"0";o.selfMultiply(F.TEN),o.selfAdd(c),s++}else{if("."!==l){if("e"===l||"E"===l){var h=t.substring(e);try{u=D.parseInt(h)}catch(e){throw e instanceof Error?new Error("Invalid exponent "+h+" in string "+t):e}break}throw new Error("Unexpected character \'"+l+"\' at position "+e+" in string "+t)}a=s}}var p=o,f=s-a-u;if(0===f)p=o;else if(f>0){var g=F.TEN.pow(f);p=o.divide(g)}else if(f<0){var d=F.TEN.pow(-f);p=o.multiply(d)}return i?p.negate():p},F.createNaN=function(){return new F(v.NaN,v.NaN)},F.copy=function(t){return new F(t)},F.magnitude=function(t){var e=Math.abs(t),n=Math.log(e)/Math.log(10),i=Math.trunc(Math.floor(n));return 10*Math.pow(10,i)<=e&&(i+=1),i},F.stringOfChar=function(t,e){for(var n=new R,i=0;i<e;i++)n.append(t);return n.toString()},G.PI.get=function(){return new F(3.141592653589793,12246467991473532e-32)},G.TWO_PI.get=function(){return new F(6.283185307179586,24492935982947064e-32)},G.PI_2.get=function(){return new F(1.5707963267948966,6123233995736766e-32)},G.E.get=function(){return new F(2.718281828459045,14456468917292502e-32)},G.NaN.get=function(){return new F(v.NaN,v.NaN)},G.EPS.get=function(){return 123259516440783e-46},G.SPLIT.get=function(){return 134217729},G.MAX_PRINT_DIGITS.get=function(){return 32},G.TEN.get=function(){return F.valueOf(10)},G.ONE.get=function(){return F.valueOf(1)},G.SCI_NOT_EXPONENT_CHAR.get=function(){return"E"},G.SCI_NOT_ZERO.get=function(){return"0.0E0"},Object.defineProperties(F,G);var V=function(){},B={DP_SAFE_EPSILON:{configurable:!0}};V.prototype.interfaces_=function(){return[]},V.prototype.getClass=function(){return V},V.orientationIndex=function(t,e,n){var i=V.orientationIndexFilter(t,e,n);if(i<=1)return i;var r=F.valueOf(e.x).selfAdd(-t.x),o=F.valueOf(e.y).selfAdd(-t.y),s=F.valueOf(n.x).selfAdd(-e.x),a=F.valueOf(n.y).selfAdd(-e.y);return r.selfMultiply(a).selfSubtract(o.selfMultiply(s)).signum()},V.signOfDet2x2=function(t,e,n,i){return t.multiply(i).selfSubtract(e.multiply(n)).signum()},V.intersection=function(t,e,n,i){var r=F.valueOf(i.y).selfSubtract(n.y).selfMultiply(F.valueOf(e.x).selfSubtract(t.x)),o=F.valueOf(i.x).selfSubtract(n.x).selfMultiply(F.valueOf(e.y).selfSubtract(t.y)),s=r.subtract(o),a=F.valueOf(i.x).selfSubtract(n.x).selfMultiply(F.valueOf(t.y).selfSubtract(n.y)),u=F.valueOf(i.y).selfSubtract(n.y).selfMultiply(F.valueOf(t.x).selfSubtract(n.x)),l=a.subtract(u).selfDivide(s).doubleValue(),c=F.valueOf(t.x).selfAdd(F.valueOf(e.x).selfSubtract(t.x).selfMultiply(l)).doubleValue(),h=F.valueOf(e.x).selfSubtract(t.x).selfMultiply(F.valueOf(t.y).selfSubtract(n.y)),p=F.valueOf(e.y).selfSubtract(t.y).selfMultiply(F.valueOf(t.x).selfSubtract(n.x)),f=h.subtract(p).selfDivide(s).doubleValue(),g=F.valueOf(n.y).selfAdd(F.valueOf(i.y).selfSubtract(n.y).selfMultiply(f)).doubleValue();return new w(c,g)},V.orientationIndexFilter=function(t,e,n){var i=null,r=(t.x-n.x)*(e.y-n.y),o=(t.y-n.y)*(e.x-n.x),s=r-o;if(r>0){if(o<=0)return V.signum(s);i=r+o}else{if(!(r<0))return V.signum(s);if(o>=0)return V.signum(s);i=-r-o}var a=V.DP_SAFE_EPSILON*i;return s>=a||-s>=a?V.signum(s):2},V.signum=function(t){return t>0?1:t<0?-1:0},B.DP_SAFE_EPSILON.get=function(){return 1e-15},Object.defineProperties(V,B);var q=function(){},U={X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0},M:{configurable:!0}};U.X.get=function(){return 0},U.Y.get=function(){return 1},U.Z.get=function(){return 2},U.M.get=function(){return 3},q.prototype.setOrdinate=function(t,e,n){},q.prototype.size=function(){},q.prototype.getOrdinate=function(t,e){},q.prototype.getCoordinate=function(){},q.prototype.getCoordinateCopy=function(t){},q.prototype.getDimension=function(){},q.prototype.getX=function(t){},q.prototype.clone=function(){},q.prototype.expandEnvelope=function(t){},q.prototype.copy=function(){},q.prototype.getY=function(t){},q.prototype.toCoordinateArray=function(){},q.prototype.interfaces_=function(){return[E]},q.prototype.getClass=function(){return q},Object.defineProperties(q,U);var k=function(){},z=function(t){function e(){t.call(this,"Projective point not representable on the Cartesian plane.")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(k),X=function(){};X.arraycopy=function(t,e,n,i,r){for(var o=0,s=e;s<e+r;s++)n[i+o]=t[s],o++},X.getProperty=function(t){return{"line.separator":"\\n"}[t]};var Y=function t(){if(this.x=null,this.y=null,this.w=null,0===arguments.length)this.x=0,this.y=0,this.w=1;else if(1===arguments.length){var e=arguments[0];this.x=e.x,this.y=e.y,this.w=1}else if(2===arguments.length){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var n=arguments[1];this.x=arguments[0],this.y=n,this.w=1}else if(arguments[0]instanceof t&&arguments[1]instanceof t){var i=arguments[0],r=arguments[1];this.x=i.y*r.w-r.y*i.w,this.y=r.x*i.w-i.x*r.w,this.w=i.x*r.y-r.x*i.y}else if(arguments[0]instanceof w&&arguments[1]instanceof w){var o=arguments[0],s=arguments[1];this.x=o.y-s.y,this.y=s.x-o.x,this.w=o.x*s.y-s.x*o.y}}else if(3===arguments.length){var a=arguments[1],u=arguments[2];this.x=arguments[0],this.y=a,this.w=u}else if(4===arguments.length){var l=arguments[0],c=arguments[1],h=arguments[2],p=arguments[3],f=l.y-c.y,g=c.x-l.x,d=l.x*c.y-c.x*l.y,y=h.y-p.y,_=p.x-h.x,m=h.x*p.y-p.x*h.y;this.x=g*m-_*d,this.y=y*d-f*m,this.w=f*_-y*g}};Y.prototype.getY=function(){var t=this.y/this.w;if(v.isNaN(t)||v.isInfinite(t))throw new z;return t},Y.prototype.getX=function(){var t=this.x/this.w;if(v.isNaN(t)||v.isInfinite(t))throw new z;return t},Y.prototype.getCoordinate=function(){var t=new w;return t.x=this.getX(),t.y=this.getY(),t},Y.prototype.interfaces_=function(){return[]},Y.prototype.getClass=function(){return Y},Y.intersection=function(t,e,n,i){var r=t.y-e.y,o=e.x-t.x,s=t.x*e.y-e.x*t.y,a=n.y-i.y,u=i.x-n.x,l=n.x*i.y-i.x*n.y,c=r*u-a*o,h=(o*l-u*s)/c,p=(a*s-r*l)/c;if(v.isNaN(h)||v.isInfinite(h)||v.isNaN(p)||v.isInfinite(p))throw new z;return new w(h,p)};var j=function t(){if(this._minx=null,this._maxx=null,this._miny=null,this._maxy=null,0===arguments.length)this.init();else if(1===arguments.length)if(arguments[0]instanceof w){var e=arguments[0];this.init(e.x,e.x,e.y,e.y)}else arguments[0]instanceof t&&this.init(arguments[0]);else if(2===arguments.length){var n=arguments[0],i=arguments[1];this.init(n.x,i.x,n.y,i.y)}else 4===arguments.length&&this.init(arguments[0],arguments[1],arguments[2],arguments[3])},H={serialVersionUID:{configurable:!0}};j.prototype.getArea=function(){return this.getWidth()*this.getHeight()},j.prototype.equals=function(t){if(!(t instanceof j))return!1;var e=t;return this.isNull()?e.isNull():this._maxx===e.getMaxX()&&this._maxy===e.getMaxY()&&this._minx===e.getMinX()&&this._miny===e.getMinY()},j.prototype.intersection=function(t){return this.isNull()||t.isNull()||!this.intersects(t)?new j:new j(this._minx>t._minx?this._minx:t._minx,this._maxx<t._maxx?this._maxx:t._maxx,this._miny>t._miny?this._miny:t._miny,this._maxy<t._maxy?this._maxy:t._maxy)},j.prototype.isNull=function(){return this._maxx<this._minx},j.prototype.getMaxX=function(){return this._maxx},j.prototype.covers=function(){if(1===arguments.length){if(arguments[0]instanceof w){var t=arguments[0];return this.covers(t.x,t.y)}if(arguments[0]instanceof j){var e=arguments[0];return!this.isNull()&&!e.isNull()&&e.getMinX()>=this._minx&&e.getMaxX()<=this._maxx&&e.getMinY()>=this._miny&&e.getMaxY()<=this._maxy}}else if(2===arguments.length){var n=arguments[0],i=arguments[1];return!this.isNull()&&n>=this._minx&&n<=this._maxx&&i>=this._miny&&i<=this._maxy}},j.prototype.intersects=function(){if(1===arguments.length){if(arguments[0]instanceof j){var t=arguments[0];return!this.isNull()&&!t.isNull()&&!(t._minx>this._maxx||t._maxx<this._minx||t._miny>this._maxy||t._maxy<this._miny)}if(arguments[0]instanceof w){var e=arguments[0];return this.intersects(e.x,e.y)}}else if(2===arguments.length){var n=arguments[0],i=arguments[1];return!this.isNull()&&!(n>this._maxx||n<this._minx||i>this._maxy||i<this._miny)}},j.prototype.getMinY=function(){return this._miny},j.prototype.getMinX=function(){return this._minx},j.prototype.expandToInclude=function(){if(1===arguments.length){if(arguments[0]instanceof w){var t=arguments[0];this.expandToInclude(t.x,t.y)}else if(arguments[0]instanceof j){var e=arguments[0];if(e.isNull())return null;this.isNull()?(this._minx=e.getMinX(),this._maxx=e.getMaxX(),this._miny=e.getMinY(),this._maxy=e.getMaxY()):(e._minx<this._minx&&(this._minx=e._minx),e._maxx>this._maxx&&(this._maxx=e._maxx),e._miny<this._miny&&(this._miny=e._miny),e._maxy>this._maxy&&(this._maxy=e._maxy))}}else if(2===arguments.length){var n=arguments[0],i=arguments[1];this.isNull()?(this._minx=n,this._maxx=n,this._miny=i,this._maxy=i):(n<this._minx&&(this._minx=n),n>this._maxx&&(this._maxx=n),i<this._miny&&(this._miny=i),i>this._maxy&&(this._maxy=i))}},j.prototype.minExtent=function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t<e?t:e},j.prototype.getWidth=function(){return this.isNull()?0:this._maxx-this._minx},j.prototype.compareTo=function(t){var e=t;return this.isNull()?e.isNull()?0:-1:e.isNull()?1:this._minx<e._minx?-1:this._minx>e._minx?1:this._miny<e._miny?-1:this._miny>e._miny?1:this._maxx<e._maxx?-1:this._maxx>e._maxx?1:this._maxy<e._maxy?-1:this._maxy>e._maxy?1:0},j.prototype.translate=function(t,e){if(this.isNull())return null;this.init(this.getMinX()+t,this.getMaxX()+t,this.getMinY()+e,this.getMaxY()+e)},j.prototype.toString=function(){return"Env["+this._minx+" : "+this._maxx+", "+this._miny+" : "+this._maxy+"]"},j.prototype.setToNull=function(){this._minx=0,this._maxx=-1,this._miny=0,this._maxy=-1},j.prototype.getHeight=function(){return this.isNull()?0:this._maxy-this._miny},j.prototype.maxExtent=function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t>e?t:e},j.prototype.expandBy=function(){if(1===arguments.length){var t=arguments[0];this.expandBy(t,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.isNull())return null;this._minx-=e,this._maxx+=e,this._miny-=n,this._maxy+=n,(this._minx>this._maxx||this._miny>this._maxy)&&this.setToNull()}},j.prototype.contains=function(){if(1===arguments.length){if(arguments[0]instanceof j)return this.covers(arguments[0]);if(arguments[0]instanceof w)return this.covers(arguments[0])}else if(2===arguments.length)return this.covers(arguments[0],arguments[1])},j.prototype.centre=function(){return this.isNull()?null:new w((this.getMinX()+this.getMaxX())/2,(this.getMinY()+this.getMaxY())/2)},j.prototype.init=function(){if(0===arguments.length)this.setToNull();else if(1===arguments.length){if(arguments[0]instanceof w){var t=arguments[0];this.init(t.x,t.x,t.y,t.y)}else if(arguments[0]instanceof j){var e=arguments[0];this._minx=e._minx,this._maxx=e._maxx,this._miny=e._miny,this._maxy=e._maxy}}else if(2===arguments.length){var n=arguments[0],i=arguments[1];this.init(n.x,i.x,n.y,i.y)}else if(4===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2],a=arguments[3];r<o?(this._minx=r,this._maxx=o):(this._minx=o,this._maxx=r),s<a?(this._miny=s,this._maxy=a):(this._miny=a,this._maxy=s)}},j.prototype.getMaxY=function(){return this._maxy},j.prototype.distance=function(t){if(this.intersects(t))return 0;var e=0;this._maxx<t._minx?e=t._minx-this._maxx:this._minx>t._maxx&&(e=this._minx-t._maxx);var n=0;return this._maxy<t._miny?n=t._miny-this._maxy:this._miny>t._maxy&&(n=this._miny-t._maxy),0===e?n:0===n?e:Math.sqrt(e*e+n*n)},j.prototype.hashCode=function(){var t=17;return 37*(t=37*(t=37*(t=37*t+w.hashCode(this._minx))+w.hashCode(this._maxx))+w.hashCode(this._miny))+w.hashCode(this._maxy)},j.prototype.interfaces_=function(){return[I,e]},j.prototype.getClass=function(){return j},j.intersects=function(){if(3===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2];return n.x>=(t.x<e.x?t.x:e.x)&&n.x<=(t.x>e.x?t.x:e.x)&&n.y>=(t.y<e.y?t.y:e.y)&&n.y<=(t.y>e.y?t.y:e.y)}if(4===arguments.length){var i=arguments[0],r=arguments[1],o=arguments[2],s=arguments[3],a=Math.min(o.x,s.x),u=Math.max(o.x,s.x),l=Math.min(i.x,r.x),c=Math.max(i.x,r.x);return!(l>u||c<a||(a=Math.min(o.y,s.y),u=Math.max(o.y,s.y),l=Math.min(i.y,r.y),c=Math.max(i.y,r.y),l>u||c<a))}},H.serialVersionUID.get=function(){return 0x51845cd552189800},Object.defineProperties(j,H);var W={typeStr:/^\\s*(\\w+)\\s*\\(\\s*(.*)\\s*\\)\\s*$/,emptyTypeStr:/^\\s*(\\w+)\\s*EMPTY\\s*$/,spaces:/\\s+/,parenComma:/\\)\\s*,\\s*\\(/,doubleParenComma:/\\)\\s*\\)\\s*,\\s*\\(\\s*\\(/,trimParens:/^\\s*\\(?(.*?)\\)?\\s*$/},J=function(t){this.geometryFactory=t||new _e};J.prototype.read=function(t){var e,n;t=t.replace(/[\\n\\r]/g," ");var i=W.typeStr.exec(t);if(-1!==t.search("EMPTY")&&((i=W.emptyTypeStr.exec(t))[2]=void 0),i&&(n=i[1].toLowerCase(),Q[n]&&(e=Q[n].apply(this,[i[2]]))),void 0===e)throw new Error("Could not parse WKT "+t);return e},J.prototype.write=function(t){return this.extractGeometry(t)},J.prototype.extractGeometry=function(t){var e=t.getGeometryType().toLowerCase();if(!K[e])return null;var n=e.toUpperCase();return t.isEmpty()?n+" EMPTY":n+"("+K[e].apply(this,[t])+")"};var K={coordinate:function(t){return t.x+" "+t.y},point:function(t){return K.coordinate.call(this,t._coordinates._coordinates[0])},multipoint:function(t){for(var e=[],n=0,i=t._geometries.length;n<i;++n)e.push("("+K.point.apply(this,[t._geometries[n]])+")");return e.join(",")},linestring:function(t){for(var e=[],n=0,i=t._points._coordinates.length;n<i;++n)e.push(K.coordinate.apply(this,[t._points._coordinates[n]]));return e.join(",")},linearring:function(t){for(var e=[],n=0,i=t._points._coordinates.length;n<i;++n)e.push(K.coordinate.apply(this,[t._points._coordinates[n]]));return e.join(",")},multilinestring:function(t){for(var e=[],n=0,i=t._geometries.length;n<i;++n)e.push("("+K.linestring.apply(this,[t._geometries[n]])+")");return e.join(",")},polygon:function(t){var e=[];e.push("("+K.linestring.apply(this,[t._shell])+")");for(var n=0,i=t._holes.length;n<i;++n)e.push("("+K.linestring.apply(this,[t._holes[n]])+")");return e.join(",")},multipolygon:function(t){for(var e=[],n=0,i=t._geometries.length;n<i;++n)e.push("("+K.polygon.apply(this,[t._geometries[n]])+")");return e.join(",")},geometrycollection:function(t){for(var e=[],n=0,i=t._geometries.length;n<i;++n)e.push(this.extractGeometry(t._geometries[n]));return e.join(",")}},Q={point:function(t){if(void 0===t)return this.geometryFactory.createPoint();var e=t.trim().split(W.spaces);return this.geometryFactory.createPoint(new w(Number.parseFloat(e[0]),Number.parseFloat(e[1])))},multipoint:function(t){if(void 0===t)return this.geometryFactory.createMultiPoint();for(var e,n=t.trim().split(","),i=[],r=0,o=n.length;r<o;++r)e=n[r].replace(W.trimParens,"$1"),i.push(Q.point.apply(this,[e]));return this.geometryFactory.createMultiPoint(i)},linestring:function(t){if(void 0===t)return this.geometryFactory.createLineString();for(var e,n=t.trim().split(","),i=[],r=0,o=n.length;r<o;++r)e=n[r].trim().split(W.spaces),i.push(new w(Number.parseFloat(e[0]),Number.parseFloat(e[1])));return this.geometryFactory.createLineString(i)},linearring:function(t){if(void 0===t)return this.geometryFactory.createLinearRing();for(var e,n=t.trim().split(","),i=[],r=0,o=n.length;r<o;++r)e=n[r].trim().split(W.spaces),i.push(new w(Number.parseFloat(e[0]),Number.parseFloat(e[1])));return this.geometryFactory.createLinearRing(i)},multilinestring:function(t){if(void 0===t)return this.geometryFactory.createMultiLineString();for(var e,n=t.trim().split(W.parenComma),i=[],r=0,o=n.length;r<o;++r)e=n[r].replace(W.trimParens,"$1"),i.push(Q.linestring.apply(this,[e]));return this.geometryFactory.createMultiLineString(i)},polygon:function(t){if(void 0===t)return this.geometryFactory.createPolygon();for(var e,n,i,r,o=t.trim().split(W.parenComma),s=[],a=0,u=o.length;a<u;++a)e=o[a].replace(W.trimParens,"$1"),n=Q.linestring.apply(this,[e]),i=this.geometryFactory.createLinearRing(n._points),0===a?r=i:s.push(i);return this.geometryFactory.createPolygon(r,s)},multipolygon:function(t){if(void 0===t)return this.geometryFactory.createMultiPolygon();for(var e,n=t.trim().split(W.doubleParenComma),i=[],r=0,o=n.length;r<o;++r)e=n[r].replace(W.trimParens,"$1"),i.push(Q.polygon.apply(this,[e]));return this.geometryFactory.createMultiPolygon(i)},geometrycollection:function(t){if(void 0===t)return this.geometryFactory.createGeometryCollection();for(var e=(t=t.replace(/,\\s*([A-Za-z])/g,"|$1")).trim().split("|"),n=[],i=0,r=e.length;i<r;++i)n.push(this.read(e[i]));return this.geometryFactory.createGeometryCollection(n)}},$=function(t){this.parser=new J(t)};$.prototype.write=function(t){return this.parser.write(t)},$.toLineString=function(t,e){if(2!==arguments.length)throw new Error("Not implemented");return"LINESTRING ( "+t.x+" "+t.y+", "+e.x+" "+e.y+" )"};var Z=function(t){function e(e){t.call(this,e),this.name="RuntimeException",this.message=e,this.stack=(new t).stack}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Error),tt=function(t){function e(){t.call(this),0===arguments.length?t.call(this):1===arguments.length&&t.call(this,arguments[0])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Z),et=function(){};et.prototype.interfaces_=function(){return[]},et.prototype.getClass=function(){return et},et.shouldNeverReachHere=function(){if(0===arguments.length)et.shouldNeverReachHere(null);else if(1===arguments.length){var t=arguments[0];throw new tt("Should never reach here"+(null!==t?": "+t:""))}},et.isTrue=function(){var t;if(1===arguments.length)et.isTrue(arguments[0],null);else if(2===arguments.length&&(t=arguments[1],!arguments[0]))throw null===t?new tt:new tt(t)},et.equals=function(){var t,e,n;if(2===arguments.length)et.equals(t=arguments[0],e=arguments[1],null);else if(3===arguments.length&&(n=arguments[2],!(e=arguments[1]).equals(t=arguments[0])))throw new tt("Expected "+t+" but encountered "+e+(null!==n?": "+n:""))};var nt=function(){this._result=null,this._inputLines=Array(2).fill().map((function(){return Array(2)})),this._intPt=new Array(2).fill(null),this._intLineIndex=null,this._isProper=null,this._pa=null,this._pb=null,this._precisionModel=null,this._intPt[0]=new w,this._intPt[1]=new w,this._pa=this._intPt[0],this._pb=this._intPt[1],this._result=0},it={DONT_INTERSECT:{configurable:!0},DO_INTERSECT:{configurable:!0},COLLINEAR:{configurable:!0},NO_INTERSECTION:{configurable:!0},POINT_INTERSECTION:{configurable:!0},COLLINEAR_INTERSECTION:{configurable:!0}};nt.prototype.getIndexAlongSegment=function(t,e){return this.computeIntLineIndex(),this._intLineIndex[t][e]},nt.prototype.getTopologySummary=function(){var t=new R;return this.isEndPoint()&&t.append(" endpoint"),this._isProper&&t.append(" proper"),this.isCollinear()&&t.append(" collinear"),t.toString()},nt.prototype.computeIntersection=function(t,e,n,i){this._inputLines[0][0]=t,this._inputLines[0][1]=e,this._inputLines[1][0]=n,this._inputLines[1][1]=i,this._result=this.computeIntersect(t,e,n,i)},nt.prototype.getIntersectionNum=function(){return this._result},nt.prototype.computeIntLineIndex=function(){if(0===arguments.length)null===this._intLineIndex&&(this._intLineIndex=Array(2).fill().map((function(){return Array(2)})),this.computeIntLineIndex(0),this.computeIntLineIndex(1));else if(1===arguments.length){var t=arguments[0];this.getEdgeDistance(t,0)>this.getEdgeDistance(t,1)?(this._intLineIndex[t][0]=0,this._intLineIndex[t][1]=1):(this._intLineIndex[t][0]=1,this._intLineIndex[t][1]=0)}},nt.prototype.isProper=function(){return this.hasIntersection()&&this._isProper},nt.prototype.setPrecisionModel=function(t){this._precisionModel=t},nt.prototype.isInteriorIntersection=function(){if(0===arguments.length)return!!this.isInteriorIntersection(0)||!!this.isInteriorIntersection(1);if(1===arguments.length){for(var t=arguments[0],e=0;e<this._result;e++)if(!this._intPt[e].equals2D(this._inputLines[t][0])&&!this._intPt[e].equals2D(this._inputLines[t][1]))return!0;return!1}},nt.prototype.getIntersection=function(t){return this._intPt[t]},nt.prototype.isEndPoint=function(){return this.hasIntersection()&&!this._isProper},nt.prototype.hasIntersection=function(){return this._result!==nt.NO_INTERSECTION},nt.prototype.getEdgeDistance=function(t,e){return nt.computeEdgeDistance(this._intPt[e],this._inputLines[t][0],this._inputLines[t][1])},nt.prototype.isCollinear=function(){return this._result===nt.COLLINEAR_INTERSECTION},nt.prototype.toString=function(){return $.toLineString(this._inputLines[0][0],this._inputLines[0][1])+" - "+$.toLineString(this._inputLines[1][0],this._inputLines[1][1])+this.getTopologySummary()},nt.prototype.getEndpoint=function(t,e){return this._inputLines[t][e]},nt.prototype.isIntersection=function(t){for(var e=0;e<this._result;e++)if(this._intPt[e].equals2D(t))return!0;return!1},nt.prototype.getIntersectionAlongSegment=function(t,e){return this.computeIntLineIndex(),this._intPt[this._intLineIndex[t][e]]},nt.prototype.interfaces_=function(){return[]},nt.prototype.getClass=function(){return nt},nt.computeEdgeDistance=function(t,e,n){var i=Math.abs(n.x-e.x),r=Math.abs(n.y-e.y),o=-1;if(t.equals(e))o=0;else if(t.equals(n))o=i>r?i:r;else{var s=Math.abs(t.x-e.x),a=Math.abs(t.y-e.y);0!==(o=i>r?s:a)||t.equals(e)||(o=Math.max(s,a))}return et.isTrue(!(0===o&&!t.equals(e)),"Bad distance calculation"),o},nt.nonRobustComputeEdgeDistance=function(t,e,n){var i=t.x-e.x,r=t.y-e.y,o=Math.sqrt(i*i+r*r);return et.isTrue(!(0===o&&!t.equals(e)),"Invalid distance calculation"),o},it.DONT_INTERSECT.get=function(){return 0},it.DO_INTERSECT.get=function(){return 1},it.COLLINEAR.get=function(){return 2},it.NO_INTERSECTION.get=function(){return 0},it.POINT_INTERSECTION.get=function(){return 1},it.COLLINEAR_INTERSECTION.get=function(){return 2},Object.defineProperties(nt,it);var rt=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isInSegmentEnvelopes=function(t){var e=new j(this._inputLines[0][0],this._inputLines[0][1]),n=new j(this._inputLines[1][0],this._inputLines[1][1]);return e.contains(t)&&n.contains(t)},e.prototype.computeIntersection=function(){if(3!==arguments.length)return t.prototype.computeIntersection.apply(this,arguments);var e=arguments[0],n=arguments[1],i=arguments[2];if(this._isProper=!1,j.intersects(n,i,e)&&0===at.orientationIndex(n,i,e)&&0===at.orientationIndex(i,n,e))return this._isProper=!0,(e.equals(n)||e.equals(i))&&(this._isProper=!1),this._result=t.POINT_INTERSECTION,null;this._result=t.NO_INTERSECTION},e.prototype.normalizeToMinimum=function(t,e,n,i,r){r.x=this.smallestInAbsValue(t.x,e.x,n.x,i.x),r.y=this.smallestInAbsValue(t.y,e.y,n.y,i.y),t.x-=r.x,t.y-=r.y,e.x-=r.x,e.y-=r.y,n.x-=r.x,n.y-=r.y,i.x-=r.x,i.y-=r.y},e.prototype.safeHCoordinateIntersection=function(t,n,i,r){var o=null;try{o=Y.intersection(t,n,i,r)}catch(s){if(!(s instanceof z))throw s;o=e.nearestEndpoint(t,n,i,r)}return o},e.prototype.intersection=function(t,n,i,r){var o=this.intersectionWithNormalization(t,n,i,r);return this.isInSegmentEnvelopes(o)||(o=new w(e.nearestEndpoint(t,n,i,r))),null!==this._precisionModel&&this._precisionModel.makePrecise(o),o},e.prototype.smallestInAbsValue=function(t,e,n,i){var r=t,o=Math.abs(r);return Math.abs(e)<o&&(r=e,o=Math.abs(e)),Math.abs(n)<o&&(r=n,o=Math.abs(n)),Math.abs(i)<o&&(r=i),r},e.prototype.checkDD=function(t,e,n,i,r){var o=V.intersection(t,e,n,i),s=this.isInSegmentEnvelopes(o);X.out.println("DD in env = "+s+"  --------------------- "+o),r.distance(o)>1e-4&&X.out.println("Distance = "+r.distance(o))},e.prototype.intersectionWithNormalization=function(t,e,n,i){var r=new w(t),o=new w(e),s=new w(n),a=new w(i),u=new w;this.normalizeToEnvCentre(r,o,s,a,u);var l=this.safeHCoordinateIntersection(r,o,s,a);return l.x+=u.x,l.y+=u.y,l},e.prototype.computeCollinearIntersection=function(e,n,i,r){var o=j.intersects(e,n,i),s=j.intersects(e,n,r),a=j.intersects(i,r,e),u=j.intersects(i,r,n);return o&&s?(this._intPt[0]=i,this._intPt[1]=r,t.COLLINEAR_INTERSECTION):a&&u?(this._intPt[0]=e,this._intPt[1]=n,t.COLLINEAR_INTERSECTION):o&&a?(this._intPt[0]=i,this._intPt[1]=e,!i.equals(e)||s||u?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):o&&u?(this._intPt[0]=i,this._intPt[1]=n,!i.equals(n)||s||a?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):s&&a?(this._intPt[0]=r,this._intPt[1]=e,!r.equals(e)||o||u?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):s&&u?(this._intPt[0]=r,this._intPt[1]=n,!r.equals(n)||o||a?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):t.NO_INTERSECTION},e.prototype.normalizeToEnvCentre=function(t,e,n,i,r){var o=t.x<e.x?t.x:e.x,s=t.y<e.y?t.y:e.y,a=t.x>e.x?t.x:e.x,u=t.y>e.y?t.y:e.y,l=n.x<i.x?n.x:i.x,c=n.y<i.y?n.y:i.y,h=n.x>i.x?n.x:i.x,p=n.y>i.y?n.y:i.y,f=((s>c?s:c)+(u<p?u:p))/2;r.x=((o>l?o:l)+(a<h?a:h))/2,r.y=f,t.x-=r.x,t.y-=r.y,e.x-=r.x,e.y-=r.y,n.x-=r.x,n.y-=r.y,i.x-=r.x,i.y-=r.y},e.prototype.computeIntersect=function(e,n,i,r){if(this._isProper=!1,!j.intersects(e,n,i,r))return t.NO_INTERSECTION;var o=at.orientationIndex(e,n,i),s=at.orientationIndex(e,n,r);if(o>0&&s>0||o<0&&s<0)return t.NO_INTERSECTION;var a=at.orientationIndex(i,r,e),u=at.orientationIndex(i,r,n);return a>0&&u>0||a<0&&u<0?t.NO_INTERSECTION:0===o&&0===s&&0===a&&0===u?this.computeCollinearIntersection(e,n,i,r):(0===o||0===s||0===a||0===u?(this._isProper=!1,e.equals2D(i)||e.equals2D(r)?this._intPt[0]=e:n.equals2D(i)||n.equals2D(r)?this._intPt[0]=n:0===o?this._intPt[0]=new w(i):0===s?this._intPt[0]=new w(r):0===a?this._intPt[0]=new w(e):0===u&&(this._intPt[0]=new w(n))):(this._isProper=!0,this._intPt[0]=this.intersection(e,n,i,r)),t.POINT_INTERSECTION)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.nearestEndpoint=function(t,e,n,i){var r=t,o=at.distancePointLine(t,n,i),s=at.distancePointLine(e,n,i);return s<o&&(o=s,r=e),(s=at.distancePointLine(n,t,e))<o&&(o=s,r=n),(s=at.distancePointLine(i,t,e))<o&&(o=s,r=i),r},e}(nt),ot=function(){};ot.prototype.interfaces_=function(){return[]},ot.prototype.getClass=function(){return ot},ot.orientationIndex=function(t,e,n){return ot.signOfDet2x2(e.x-t.x,e.y-t.y,n.x-e.x,n.y-e.y)},ot.signOfDet2x2=function(t,e,n,i){var r=null,o=null,s=null;if(r=1,0===t||0===i)return 0===e||0===n?0:e>0?n>0?-r:r:n>0?r:-r;if(0===e||0===n)return i>0?t>0?r:-r:t>0?-r:r;if(e>0?i>0?e<=i||(r=-r,o=t,t=n,n=o,o=e,e=i,i=o):e<=-i?(r=-r,n=-n,i=-i):(o=t,t=-n,n=o,o=e,e=-i,i=o):i>0?-e<=i?(r=-r,t=-t,e=-e):(o=-t,t=n,n=o,o=-e,e=i,i=o):e>=i?(t=-t,e=-e,n=-n,i=-i):(r=-r,o=-t,t=-n,n=o,o=-e,e=-i,i=o),t>0){if(!(n>0))return r;if(!(t<=n))return r}else{if(n>0)return-r;if(!(t>=n))return-r;r=-r,t=-t,n=-n}for(;;){if((i-=(s=Math.floor(n/t))*e)<0)return-r;if(i>e)return r;if(t>(n-=s*t)+n){if(e<i+i)return r}else{if(e>i+i)return-r;n=t-n,i=e-i,r=-r}if(0===i)return 0===n?0:-r;if(0===n)return r;if((e-=(s=Math.floor(t/n))*i)<0)return r;if(e>i)return-r;if(n>(t-=s*n)+t){if(i<e+e)return-r}else{if(i>e+e)return r;t=n-t,e=i-e,r=-r}if(0===e)return 0===t?0:r;if(0===t)return-r}};var st=function(){this._p=null,this._crossingCount=0,this._isPointOnSegment=!1,this._p=arguments[0]};st.prototype.countSegment=function(t,e){if(t.x<this._p.x&&e.x<this._p.x)return null;if(this._p.x===e.x&&this._p.y===e.y)return this._isPointOnSegment=!0,null;if(t.y===this._p.y&&e.y===this._p.y){var n=t.x,i=e.x;return n>i&&(n=e.x,i=t.x),this._p.x>=n&&this._p.x<=i&&(this._isPointOnSegment=!0),null}if(t.y>this._p.y&&e.y<=this._p.y||e.y>this._p.y&&t.y<=this._p.y){var r=t.y-this._p.y,o=e.y-this._p.y,s=ot.signOfDet2x2(t.x-this._p.x,r,e.x-this._p.x,o);if(0===s)return this._isPointOnSegment=!0,null;o<r&&(s=-s),s>0&&this._crossingCount++}},st.prototype.isPointInPolygon=function(){return this.getLocation()!==L.EXTERIOR},st.prototype.getLocation=function(){return this._isPointOnSegment?L.BOUNDARY:this._crossingCount%2==1?L.INTERIOR:L.EXTERIOR},st.prototype.isOnSegment=function(){return this._isPointOnSegment},st.prototype.interfaces_=function(){return[]},st.prototype.getClass=function(){return st},st.locatePointInRing=function(){if(arguments[0]instanceof w&&P(arguments[1],q)){for(var t=arguments[1],e=new st(arguments[0]),n=new w,i=new w,r=1;r<t.size();r++)if(t.getCoordinate(r,n),t.getCoordinate(r-1,i),e.countSegment(n,i),e.isOnSegment())return e.getLocation();return e.getLocation()}if(arguments[0]instanceof w&&arguments[1]instanceof Array){for(var o=arguments[1],s=new st(arguments[0]),a=1;a<o.length;a++)if(s.countSegment(o[a],o[a-1]),s.isOnSegment())return s.getLocation();return s.getLocation()}};var at=function(){},ut={CLOCKWISE:{configurable:!0},RIGHT:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},LEFT:{configurable:!0},COLLINEAR:{configurable:!0},STRAIGHT:{configurable:!0}};at.prototype.interfaces_=function(){return[]},at.prototype.getClass=function(){return at},at.orientationIndex=function(t,e,n){return V.orientationIndex(t,e,n)},at.signedArea=function(){if(arguments[0]instanceof Array){var t=arguments[0];if(t.length<3)return 0;for(var e=0,n=t[0].x,i=1;i<t.length-1;i++)e+=(t[i].x-n)*(t[i-1].y-t[i+1].y);return e/2}if(P(arguments[0],q)){var r=arguments[0],o=r.size();if(o<3)return 0;var s=new w,a=new w,u=new w;r.getCoordinate(0,a),r.getCoordinate(1,u);var l=a.x;u.x-=l;for(var c=0,h=1;h<o-1;h++)s.y=a.y,a.x=u.x,a.y=u.y,r.getCoordinate(h+1,u),u.x-=l,c+=a.x*(s.y-u.y);return c/2}},at.distanceLineLine=function(t,e,n,i){if(t.equals(e))return at.distancePointLine(t,n,i);if(n.equals(i))return at.distancePointLine(i,t,e);var r=!1;if(j.intersects(t,e,n,i)){var o=(e.x-t.x)*(i.y-n.y)-(e.y-t.y)*(i.x-n.x);if(0===o)r=!0;else{var s=((t.y-n.y)*(e.x-t.x)-(t.x-n.x)*(e.y-t.y))/o,a=((t.y-n.y)*(i.x-n.x)-(t.x-n.x)*(i.y-n.y))/o;(a<0||a>1||s<0||s>1)&&(r=!0)}}else r=!0;return r?T.min(at.distancePointLine(t,n,i),at.distancePointLine(e,n,i),at.distancePointLine(n,t,e),at.distancePointLine(i,t,e)):0},at.isPointInRing=function(t,e){return at.locatePointInRing(t,e)!==L.EXTERIOR},at.computeLength=function(t){var e=t.size();if(e<=1)return 0;var n=0,i=new w;t.getCoordinate(0,i);for(var r=i.x,o=i.y,s=1;s<e;s++){t.getCoordinate(s,i);var a=i.x,u=i.y,l=a-r,c=u-o;n+=Math.sqrt(l*l+c*c),r=a,o=u}return n},at.isCCW=function(t){var e=t.length-1;if(e<3)throw new m("Ring has fewer than 4 points, so orientation cannot be determined");for(var n=t[0],i=0,r=1;r<=e;r++){var o=t[r];o.y>n.y&&(n=o,i=r)}var s=i;do{(s-=1)<0&&(s=e)}while(t[s].equals2D(n)&&s!==i);var a=i;do{a=(a+1)%e}while(t[a].equals2D(n)&&a!==i);var u=t[s],l=t[a];if(u.equals2D(n)||l.equals2D(n)||u.equals2D(l))return!1;var c=at.computeOrientation(u,n,l);return 0===c?u.x>l.x:c>0},at.locatePointInRing=function(t,e){return st.locatePointInRing(t,e)},at.distancePointLinePerpendicular=function(t,e,n){var i=(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y);return Math.abs(((e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y))/i)*Math.sqrt(i)},at.computeOrientation=function(t,e,n){return at.orientationIndex(t,e,n)},at.distancePointLine=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];if(0===e.length)throw new m("Line array must contain at least one vertex");for(var n=t.distance(e[0]),i=0;i<e.length-1;i++){var r=at.distancePointLine(t,e[i],e[i+1]);r<n&&(n=r)}return n}if(3===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2];if(s.x===a.x&&s.y===a.y)return o.distance(s);var u=(a.x-s.x)*(a.x-s.x)+(a.y-s.y)*(a.y-s.y),l=((o.x-s.x)*(a.x-s.x)+(o.y-s.y)*(a.y-s.y))/u;return l<=0?o.distance(s):l>=1?o.distance(a):Math.abs(((s.y-o.y)*(a.x-s.x)-(s.x-o.x)*(a.y-s.y))/u)*Math.sqrt(u)}},at.isOnLine=function(t,e){for(var n=new rt,i=1;i<e.length;i++)if(n.computeIntersection(t,e[i-1],e[i]),n.hasIntersection())return!0;return!1},ut.CLOCKWISE.get=function(){return-1},ut.RIGHT.get=function(){return at.CLOCKWISE},ut.COUNTERCLOCKWISE.get=function(){return 1},ut.LEFT.get=function(){return at.COUNTERCLOCKWISE},ut.COLLINEAR.get=function(){return 0},ut.STRAIGHT.get=function(){return at.COLLINEAR},Object.defineProperties(at,ut);var lt=function(){};lt.prototype.filter=function(t){},lt.prototype.interfaces_=function(){return[]},lt.prototype.getClass=function(){return lt};var ct=function(){var t=arguments[0];this._envelope=null,this._factory=null,this._SRID=null,this._userData=null,this._factory=t,this._SRID=t.getSRID()},ht={serialVersionUID:{configurable:!0},SORTINDEX_POINT:{configurable:!0},SORTINDEX_MULTIPOINT:{configurable:!0},SORTINDEX_LINESTRING:{configurable:!0},SORTINDEX_LINEARRING:{configurable:!0},SORTINDEX_MULTILINESTRING:{configurable:!0},SORTINDEX_POLYGON:{configurable:!0},SORTINDEX_MULTIPOLYGON:{configurable:!0},SORTINDEX_GEOMETRYCOLLECTION:{configurable:!0},geometryChangedFilter:{configurable:!0}};ct.prototype.isGeometryCollection=function(){return this.getSortIndex()===ct.SORTINDEX_GEOMETRYCOLLECTION},ct.prototype.getFactory=function(){return this._factory},ct.prototype.getGeometryN=function(t){return this},ct.prototype.getArea=function(){return 0},ct.prototype.isRectangle=function(){return!1},ct.prototype.equals=function(){if(arguments[0]instanceof ct){var t=arguments[0];return null!==t&&this.equalsTopo(t)}if(arguments[0]instanceof Object){var e=arguments[0];return e instanceof ct&&this.equalsExact(e)}},ct.prototype.equalsExact=function(t){return this===t||this.equalsExact(t,0)},ct.prototype.geometryChanged=function(){this.apply(ct.geometryChangedFilter)},ct.prototype.geometryChangedAction=function(){this._envelope=null},ct.prototype.equalsNorm=function(t){return null!==t&&this.norm().equalsExact(t.norm())},ct.prototype.getLength=function(){return 0},ct.prototype.getNumGeometries=function(){return 1},ct.prototype.compareTo=function(){if(1===arguments.length){var t=arguments[0],e=t;return this.getSortIndex()!==e.getSortIndex()?this.getSortIndex()-e.getSortIndex():this.isEmpty()&&e.isEmpty()?0:this.isEmpty()?-1:e.isEmpty()?1:this.compareToSameClass(t)}if(2===arguments.length){var n=arguments[0],i=arguments[1];return this.getSortIndex()!==n.getSortIndex()?this.getSortIndex()-n.getSortIndex():this.isEmpty()&&n.isEmpty()?0:this.isEmpty()?-1:n.isEmpty()?1:this.compareToSameClass(n,i)}},ct.prototype.getUserData=function(){return this._userData},ct.prototype.getSRID=function(){return this._SRID},ct.prototype.getEnvelope=function(){return this.getFactory().toGeometry(this.getEnvelopeInternal())},ct.prototype.checkNotGeometryCollection=function(t){if(t.getSortIndex()===ct.SORTINDEX_GEOMETRYCOLLECTION)throw new m("This method does not support GeometryCollection arguments")},ct.prototype.equal=function(t,e,n){return 0===n?t.equals(e):t.distance(e)<=n},ct.prototype.norm=function(){var t=this.copy();return t.normalize(),t},ct.prototype.getPrecisionModel=function(){return this._factory.getPrecisionModel()},ct.prototype.getEnvelopeInternal=function(){return null===this._envelope&&(this._envelope=this.computeEnvelopeInternal()),new j(this._envelope)},ct.prototype.setSRID=function(t){this._SRID=t},ct.prototype.setUserData=function(t){this._userData=t},ct.prototype.compare=function(t,e){for(var n=t.iterator(),i=e.iterator();n.hasNext()&&i.hasNext();){var r=n.next(),o=i.next(),s=r.compareTo(o);if(0!==s)return s}return n.hasNext()?1:i.hasNext()?-1:0},ct.prototype.hashCode=function(){return this.getEnvelopeInternal().hashCode()},ct.prototype.isGeometryCollectionOrDerived=function(){return this.getSortIndex()===ct.SORTINDEX_GEOMETRYCOLLECTION||this.getSortIndex()===ct.SORTINDEX_MULTIPOINT||this.getSortIndex()===ct.SORTINDEX_MULTILINESTRING||this.getSortIndex()===ct.SORTINDEX_MULTIPOLYGON},ct.prototype.interfaces_=function(){return[E,I,e]},ct.prototype.getClass=function(){return ct},ct.hasNonEmptyElements=function(t){for(var e=0;e<t.length;e++)if(!t[e].isEmpty())return!0;return!1},ct.hasNullElements=function(t){for(var e=0;e<t.length;e++)if(null===t[e])return!0;return!1},ht.serialVersionUID.get=function(){return 0x799ea46522854c00},ht.SORTINDEX_POINT.get=function(){return 0},ht.SORTINDEX_MULTIPOINT.get=function(){return 1},ht.SORTINDEX_LINESTRING.get=function(){return 2},ht.SORTINDEX_LINEARRING.get=function(){return 3},ht.SORTINDEX_MULTILINESTRING.get=function(){return 4},ht.SORTINDEX_POLYGON.get=function(){return 5},ht.SORTINDEX_MULTIPOLYGON.get=function(){return 6},ht.SORTINDEX_GEOMETRYCOLLECTION.get=function(){return 7},ht.geometryChangedFilter.get=function(){return pt},Object.defineProperties(ct,ht);var pt=function(){};pt.interfaces_=function(){return[lt]},pt.filter=function(t){t.geometryChangedAction()};var ft=function(){};ft.prototype.filter=function(t){},ft.prototype.interfaces_=function(){return[]},ft.prototype.getClass=function(){return ft};var gt=function(){},dt={Mod2BoundaryNodeRule:{configurable:!0},EndPointBoundaryNodeRule:{configurable:!0},MultiValentEndPointBoundaryNodeRule:{configurable:!0},MonoValentEndPointBoundaryNodeRule:{configurable:!0},MOD2_BOUNDARY_RULE:{configurable:!0},ENDPOINT_BOUNDARY_RULE:{configurable:!0},MULTIVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},MONOVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},OGC_SFS_BOUNDARY_RULE:{configurable:!0}};gt.prototype.isInBoundary=function(t){},gt.prototype.interfaces_=function(){return[]},gt.prototype.getClass=function(){return gt},dt.Mod2BoundaryNodeRule.get=function(){return yt},dt.EndPointBoundaryNodeRule.get=function(){return _t},dt.MultiValentEndPointBoundaryNodeRule.get=function(){return mt},dt.MonoValentEndPointBoundaryNodeRule.get=function(){return vt},dt.MOD2_BOUNDARY_RULE.get=function(){return new yt},dt.ENDPOINT_BOUNDARY_RULE.get=function(){return new _t},dt.MULTIVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new mt},dt.MONOVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new vt},dt.OGC_SFS_BOUNDARY_RULE.get=function(){return gt.MOD2_BOUNDARY_RULE},Object.defineProperties(gt,dt);var yt=function(){};yt.prototype.isInBoundary=function(t){return t%2==1},yt.prototype.interfaces_=function(){return[gt]},yt.prototype.getClass=function(){return yt};var _t=function(){};_t.prototype.isInBoundary=function(t){return t>0},_t.prototype.interfaces_=function(){return[gt]},_t.prototype.getClass=function(){return _t};var mt=function(){};mt.prototype.isInBoundary=function(t){return t>1},mt.prototype.interfaces_=function(){return[gt]},mt.prototype.getClass=function(){return mt};var vt=function(){};vt.prototype.isInBoundary=function(t){return 1===t},vt.prototype.interfaces_=function(){return[gt]},vt.prototype.getClass=function(){return vt};var xt=function(){};xt.prototype.add=function(){},xt.prototype.addAll=function(){},xt.prototype.isEmpty=function(){},xt.prototype.iterator=function(){},xt.prototype.size=function(){},xt.prototype.toArray=function(){},xt.prototype.remove=function(){},(n.prototype=new Error).name="IndexOutOfBoundsException";var It=function(){};It.prototype.hasNext=function(){},It.prototype.next=function(){},It.prototype.remove=function(){};var Et=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(){},e.prototype.set=function(){},e.prototype.isEmpty=function(){},e}(xt);(i.prototype=new Error).name="NoSuchElementException";var Nt=function(t){function e(){t.call(this),this.array_=[],arguments[0]instanceof xt&&this.addAll(arguments[0])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.ensureCapacity=function(){},e.prototype.interfaces_=function(){return[t,xt]},e.prototype.add=function(t){return 1===arguments.length?this.array_.push(t):this.array_.splice(arguments[0],arguments[1]),!0},e.prototype.clear=function(){this.array_=[]},e.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},e.prototype.set=function(t,e){var n=this.array_[t];return this.array_[t]=e,n},e.prototype.iterator=function(){return new wt(this)},e.prototype.get=function(t){if(t<0||t>=this.size())throw new n;return this.array_[t]},e.prototype.isEmpty=function(){return 0===this.array_.length},e.prototype.size=function(){return this.array_.length},e.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},e.prototype.remove=function(t){for(var e=!1,n=0,i=this.array_.length;n<i;n++)if(this.array_[n]===t){this.array_.splice(n,1),e=!0;break}return e},e}(Et),wt=function(t){function e(e){t.call(this),this.arrayList_=e,this.position_=0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.next=function(){if(this.position_===this.arrayList_.size())throw new i;return this.arrayList_.get(this.position_++)},e.prototype.hasNext=function(){return this.position_<this.arrayList_.size()},e.prototype.set=function(t){return this.arrayList_.set(this.position_-1,t)},e.prototype.remove=function(){this.arrayList_.remove(this.arrayList_.get(this.position_))},e}(It),Ct=function(t){function e(){if(t.call(this),0===arguments.length);else if(1===arguments.length){var e=arguments[0];this.ensureCapacity(e.length),this.add(e,!0)}else if(2===arguments.length){var n=arguments[0],i=arguments[1];this.ensureCapacity(n.length),this.add(n,i)}}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={coordArrayType:{configurable:!0}};return n.coordArrayType.get=function(){return new Array(0).fill(null)},e.prototype.getCoordinate=function(t){return this.get(t)},e.prototype.addAll=function(){if(2===arguments.length){for(var e=arguments[1],n=!1,i=arguments[0].iterator();i.hasNext();)this.add(i.next(),e),n=!0;return n}return t.prototype.addAll.apply(this,arguments)},e.prototype.clone=function(){for(var e=t.prototype.clone.call(this),n=0;n<this.size();n++)e.add(n,this.get(n).copy());return e},e.prototype.toCoordinateArray=function(){return this.toArray(e.coordArrayType)},e.prototype.add=function(){if(1===arguments.length)t.prototype.add.call(this,arguments[0]);else if(2===arguments.length){if(arguments[0]instanceof Array&&"boolean"==typeof arguments[1])return this.add(arguments[0],arguments[1],!0),!0;if(arguments[0]instanceof w&&"boolean"==typeof arguments[1]){var e=arguments[0];if(!arguments[1]&&this.size()>=1&&this.get(this.size()-1).equals2D(e))return null;t.prototype.add.call(this,e)}else if(arguments[0]instanceof Object&&"boolean"==typeof arguments[1])return this.add(arguments[0],arguments[1]),!0}else if(3===arguments.length){if("boolean"==typeof arguments[2]&&arguments[0]instanceof Array&&"boolean"==typeof arguments[1]){var n=arguments[0],i=arguments[1];if(arguments[2])for(var r=0;r<n.length;r++)this.add(n[r],i);else for(var o=n.length-1;o>=0;o--)this.add(n[o],i);return!0}if("boolean"==typeof arguments[2]&&Number.isInteger(arguments[0])&&arguments[1]instanceof w){var s=arguments[0],a=arguments[1];if(!arguments[2]){var u=this.size();if(u>0){if(s>0&&this.get(s-1).equals2D(a))return null;if(s<u&&this.get(s).equals2D(a))return null}}t.prototype.add.call(this,s,a)}}else if(4===arguments.length){var l=arguments[0],c=arguments[1],h=arguments[2],p=arguments[3],f=1;h>p&&(f=-1);for(var g=h;g!==p;g+=f)this.add(l[g],c);return!0}},e.prototype.closeRing=function(){this.size()>0&&this.add(new w(this.get(0)),!1)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},Object.defineProperties(e,n),e}(Nt),St=function(){},bt={ForwardComparator:{configurable:!0},BidirectionalComparator:{configurable:!0},coordArrayType:{configurable:!0}};bt.ForwardComparator.get=function(){return Lt},bt.BidirectionalComparator.get=function(){return Ot},bt.coordArrayType.get=function(){return new Array(0).fill(null)},St.prototype.interfaces_=function(){return[]},St.prototype.getClass=function(){return St},St.isRing=function(t){return!(t.length<4||!t[0].equals2D(t[t.length-1]))},St.ptNotInList=function(t,e){for(var n=0;n<t.length;n++){var i=t[n];if(St.indexOf(i,e)<0)return i}return null},St.scroll=function(t,e){var n=St.indexOf(e,t);if(n<0)return null;var i=new Array(t.length).fill(null);X.arraycopy(t,n,i,0,t.length-n),X.arraycopy(t,0,i,t.length-n,n),X.arraycopy(i,0,t,0,t.length)},St.equals=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];if(t===e)return!0;if(null===t||null===e)return!1;if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].equals(e[n]))return!1;return!0}if(3===arguments.length){var i=arguments[0],r=arguments[1],o=arguments[2];if(i===r)return!0;if(null===i||null===r)return!1;if(i.length!==r.length)return!1;for(var s=0;s<i.length;s++)if(0!==o.compare(i[s],r[s]))return!1;return!0}},St.intersection=function(t,e){for(var n=new Ct,i=0;i<t.length;i++)e.intersects(t[i])&&n.add(t[i],!0);return n.toCoordinateArray()},St.hasRepeatedPoints=function(t){for(var e=1;e<t.length;e++)if(t[e-1].equals(t[e]))return!0;return!1},St.removeRepeatedPoints=function(t){return St.hasRepeatedPoints(t)?new Ct(t,!1).toCoordinateArray():t},St.reverse=function(t){for(var e=t.length-1,n=Math.trunc(e/2),i=0;i<=n;i++){var r=t[i];t[i]=t[e-i],t[e-i]=r}},St.removeNull=function(t){for(var e=0,n=0;n<t.length;n++)null!==t[n]&&e++;var i=new Array(e).fill(null);if(0===e)return i;for(var r=0,o=0;o<t.length;o++)null!==t[o]&&(i[r++]=t[o]);return i},St.copyDeep=function(){if(1===arguments.length){for(var t=arguments[0],e=new Array(t.length).fill(null),n=0;n<t.length;n++)e[n]=new w(t[n]);return e}if(5===arguments.length)for(var i=arguments[0],r=arguments[1],o=arguments[2],s=arguments[3],a=arguments[4],u=0;u<a;u++)o[s+u]=new w(i[r+u])},St.isEqualReversed=function(t,e){for(var n=0;n<t.length;n++)if(0!==t[n].compareTo(e[t.length-n-1]))return!1;return!0},St.envelope=function(t){for(var e=new j,n=0;n<t.length;n++)e.expandToInclude(t[n]);return e},St.toCoordinateArray=function(t){return t.toArray(St.coordArrayType)},St.atLeastNCoordinatesOrNothing=function(t,e){return e.length>=t?e:[]},St.indexOf=function(t,e){for(var n=0;n<e.length;n++)if(t.equals(e[n]))return n;return-1},St.increasingDirection=function(t){for(var e=0;e<Math.trunc(t.length/2);e++){var n=t[e].compareTo(t[t.length-1-e]);if(0!==n)return n}return 1},St.compare=function(t,e){for(var n=0;n<t.length&&n<e.length;){var i=t[n].compareTo(e[n]);if(0!==i)return i;n++}return n<e.length?-1:n<t.length?1:0},St.minCoordinate=function(t){for(var e=null,n=0;n<t.length;n++)(null===e||e.compareTo(t[n])>0)&&(e=t[n]);return e},St.extract=function(t,e,n){e=T.clamp(e,0,t.length);var i=(n=T.clamp(n,-1,t.length))-e+1;n<0&&(i=0),e>=t.length&&(i=0),n<e&&(i=0);var r=new Array(i).fill(null);if(0===i)return r;for(var o=0,s=e;s<=n;s++)r[o++]=t[s];return r},Object.defineProperties(St,bt);var Lt=function(){};Lt.prototype.compare=function(t,e){return St.compare(t,e)},Lt.prototype.interfaces_=function(){return[N]},Lt.prototype.getClass=function(){return Lt};var Ot=function(){};Ot.prototype.compare=function(t,e){var n=t,i=e;if(n.length<i.length)return-1;if(n.length>i.length)return 1;if(0===n.length)return 0;var r=St.compare(n,i);return St.isEqualReversed(n,i)?0:r},Ot.prototype.OLDcompare=function(t,e){var n=t,i=e;if(n.length<i.length)return-1;if(n.length>i.length)return 1;if(0===n.length)return 0;for(var r=St.increasingDirection(n),o=St.increasingDirection(i),s=r>0?0:n.length-1,a=o>0?0:n.length-1,u=0;u<n.length;u++){var l=n[s].compareTo(i[a]);if(0!==l)return l;s+=r,a+=o}return 0},Ot.prototype.interfaces_=function(){return[N]},Ot.prototype.getClass=function(){return Ot};var Pt=function(){};Pt.prototype.get=function(){},Pt.prototype.put=function(){},Pt.prototype.size=function(){},Pt.prototype.values=function(){},Pt.prototype.entrySet=function(){};var Tt=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Pt);(r.prototype=new Error).name="OperationNotSupported",(o.prototype=new xt).contains=function(){};var Mt=function(t){function e(){t.call(this),this.array_=[],arguments[0]instanceof xt&&this.addAll(arguments[0])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.contains=function(t){for(var e=0,n=this.array_.length;e<n;e++)if(this.array_[e]===t)return!0;return!1},e.prototype.add=function(t){return!this.contains(t)&&(this.array_.push(t),!0)},e.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},e.prototype.remove=function(t){throw new Error},e.prototype.size=function(){return this.array_.length},e.prototype.isEmpty=function(){return 0===this.array_.length},e.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},e.prototype.iterator=function(){return new Rt(this)},e}(o),Rt=function(t){function e(e){t.call(this),this.hashSet_=e,this.position_=0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.next=function(){if(this.position_===this.hashSet_.size())throw new i;return this.hashSet_.array_[this.position_++]},e.prototype.hasNext=function(){return this.position_<this.hashSet_.size()},e.prototype.remove=function(){throw new r},e}(It),Dt=0;(h.prototype=new Tt).get=function(t){for(var e=this.root_;null!==e;){var n=t.compareTo(e.key);if(n<0)e=e.left;else{if(!(n>0))return e.value;e=e.right}}return null},h.prototype.put=function(t,e){if(null===this.root_)return this.root_={key:t,value:e,left:null,right:null,parent:null,color:Dt,getValue:function(){return this.value},getKey:function(){return this.key}},this.size_=1,null;var n,i,r=this.root_;do{if(n=r,(i=t.compareTo(r.key))<0)r=r.left;else{if(!(i>0)){var o=r.value;return r.value=e,o}r=r.right}}while(null!==r);var s={key:t,left:null,right:null,value:e,parent:n,color:Dt,getValue:function(){return this.value},getKey:function(){return this.key}};return i<0?n.left=s:n.right=s,this.fixAfterInsertion(s),this.size_++,null},h.prototype.fixAfterInsertion=function(t){for(t.color=1;null!=t&&t!==this.root_&&1===t.parent.color;)if(a(t)===l(a(a(t)))){var e=c(a(a(t)));1===s(e)?(u(a(t),Dt),u(e,Dt),u(a(a(t)),1),t=a(a(t))):(t===c(a(t))&&(t=a(t),this.rotateLeft(t)),u(a(t),Dt),u(a(a(t)),1),this.rotateRight(a(a(t))))}else{var n=l(a(a(t)));1===s(n)?(u(a(t),Dt),u(n,Dt),u(a(a(t)),1),t=a(a(t))):(t===l(a(t))&&(t=a(t),this.rotateRight(t)),u(a(t),Dt),u(a(a(t)),1),this.rotateLeft(a(a(t))))}this.root_.color=Dt},h.prototype.values=function(){var t=new Nt,e=this.getFirstEntry();if(null!==e)for(t.add(e.value);null!==(e=h.successor(e));)t.add(e.value);return t},h.prototype.entrySet=function(){var t=new Mt,e=this.getFirstEntry();if(null!==e)for(t.add(e);null!==(e=h.successor(e));)t.add(e);return t},h.prototype.rotateLeft=function(t){if(null!=t){var e=t.right;t.right=e.left,null!=e.left&&(e.left.parent=t),e.parent=t.parent,null===t.parent?this.root_=e:t.parent.left===t?t.parent.left=e:t.parent.right=e,e.left=t,t.parent=e}},h.prototype.rotateRight=function(t){if(null!=t){var e=t.left;t.left=e.right,null!=e.right&&(e.right.parent=t),e.parent=t.parent,null===t.parent?this.root_=e:t.parent.right===t?t.parent.right=e:t.parent.left=e,e.right=t,t.parent=e}},h.prototype.getFirstEntry=function(){var t=this.root_;if(null!=t)for(;null!=t.left;)t=t.left;return t},h.successor=function(t){if(null===t)return null;if(null!==t.right){for(var e=t.right;null!==e.left;)e=e.left;return e}for(var n=t.parent,i=t;null!==n&&i===n.right;)i=n,n=n.parent;return n},h.prototype.size=function(){return this.size_};var At=function(){};At.prototype.interfaces_=function(){return[]},At.prototype.getClass=function(){return At},p.prototype=new o,(f.prototype=new p).contains=function(t){for(var e=0,n=this.array_.length;e<n;e++)if(0===this.array_[e].compareTo(t))return!0;return!1},f.prototype.add=function(t){if(this.contains(t))return!1;for(var e=0,n=this.array_.length;e<n;e++)if(1===this.array_[e].compareTo(t))return this.array_.splice(e,0,t),!0;return this.array_.push(t),!0},f.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},f.prototype.remove=function(t){throw new r},f.prototype.size=function(){return this.array_.length},f.prototype.isEmpty=function(){return 0===this.array_.length},f.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},f.prototype.iterator=function(){return new Ft(this)};var Ft=function(t){this.treeSet_=t,this.position_=0};Ft.prototype.next=function(){if(this.position_===this.treeSet_.size())throw new i;return this.treeSet_.array_[this.position_++]},Ft.prototype.hasNext=function(){return this.position_<this.treeSet_.size()},Ft.prototype.remove=function(){throw new r};var Gt=function(){};Gt.sort=function(){var t,e,n,i,r=arguments[0];if(1===arguments.length)i=function(t,e){return t.compareTo(e)},r.sort(i);else if(2===arguments.length)n=arguments[1],i=function(t,e){return n.compare(t,e)},r.sort(i);else if(3===arguments.length){(e=r.slice(arguments[1],arguments[2])).sort();var o=r.slice(0,arguments[1]).concat(e,r.slice(arguments[2],r.length));for(r.splice(0,r.length),t=0;t<o.length;t++)r.push(o[t])}else if(4===arguments.length)for(e=r.slice(arguments[1],arguments[2]),n=arguments[3],i=function(t,e){return n.compare(t,e)},e.sort(i),o=r.slice(0,arguments[1]).concat(e,r.slice(arguments[2],r.length)),r.splice(0,r.length),t=0;t<o.length;t++)r.push(o[t])},Gt.asList=function(t){for(var e=new Nt,n=0,i=t.length;n<i;n++)e.add(t[n]);return e};var Vt=function(){},Bt={P:{configurable:!0},L:{configurable:!0},A:{configurable:!0},FALSE:{configurable:!0},TRUE:{configurable:!0},DONTCARE:{configurable:!0},SYM_FALSE:{configurable:!0},SYM_TRUE:{configurable:!0},SYM_DONTCARE:{configurable:!0},SYM_P:{configurable:!0},SYM_L:{configurable:!0},SYM_A:{configurable:!0}};Bt.P.get=function(){return 0},Bt.L.get=function(){return 1},Bt.A.get=function(){return 2},Bt.FALSE.get=function(){return-1},Bt.TRUE.get=function(){return-2},Bt.DONTCARE.get=function(){return-3},Bt.SYM_FALSE.get=function(){return"F"},Bt.SYM_TRUE.get=function(){return"T"},Bt.SYM_DONTCARE.get=function(){return"*"},Bt.SYM_P.get=function(){return"0"},Bt.SYM_L.get=function(){return"1"},Bt.SYM_A.get=function(){return"2"},Vt.prototype.interfaces_=function(){return[]},Vt.prototype.getClass=function(){return Vt},Vt.toDimensionSymbol=function(t){switch(t){case Vt.FALSE:return Vt.SYM_FALSE;case Vt.TRUE:return Vt.SYM_TRUE;case Vt.DONTCARE:return Vt.SYM_DONTCARE;case Vt.P:return Vt.SYM_P;case Vt.L:return Vt.SYM_L;case Vt.A:return Vt.SYM_A}throw new m("Unknown dimension value: "+t)},Vt.toDimensionValue=function(t){switch(A.toUpperCase(t)){case Vt.SYM_FALSE:return Vt.FALSE;case Vt.SYM_TRUE:return Vt.TRUE;case Vt.SYM_DONTCARE:return Vt.DONTCARE;case Vt.SYM_P:return Vt.P;case Vt.SYM_L:return Vt.L;case Vt.SYM_A:return Vt.A}throw new m("Unknown dimension symbol: "+t)},Object.defineProperties(Vt,Bt);var qt=function(){};qt.prototype.filter=function(t){},qt.prototype.interfaces_=function(){return[]},qt.prototype.getClass=function(){return qt};var Ut=function(){};Ut.prototype.filter=function(t,e){},Ut.prototype.isDone=function(){},Ut.prototype.isGeometryChanged=function(){},Ut.prototype.interfaces_=function(){return[]},Ut.prototype.getClass=function(){return Ut};var kt=function(t){function e(e,n){if(t.call(this,n),this._geometries=e||[],t.hasNullElements(this._geometries))throw new m("geometries must not contain null elements")}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){for(var t=new j,e=0;e<this._geometries.length;e++)t.expandToInclude(this._geometries[e].getEnvelopeInternal());return t},e.prototype.getGeometryN=function(t){return this._geometries[t]},e.prototype.getSortIndex=function(){return t.SORTINDEX_GEOMETRYCOLLECTION},e.prototype.getCoordinates=function(){for(var t=new Array(this.getNumPoints()).fill(null),e=-1,n=0;n<this._geometries.length;n++)for(var i=this._geometries[n].getCoordinates(),r=0;r<i.length;r++)t[++e]=i[r];return t},e.prototype.getArea=function(){for(var t=0,e=0;e<this._geometries.length;e++)t+=this._geometries[e].getArea();return t},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];if(!this.isEquivalentClass(e))return!1;var i=e;if(this._geometries.length!==i._geometries.length)return!1;for(var r=0;r<this._geometries.length;r++)if(!this._geometries[r].equalsExact(i._geometries[r],n))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){for(var t=0;t<this._geometries.length;t++)this._geometries[t].normalize();Gt.sort(this._geometries)},e.prototype.getCoordinate=function(){return this.isEmpty()?null:this._geometries[0].getCoordinate()},e.prototype.getBoundaryDimension=function(){for(var t=Vt.FALSE,e=0;e<this._geometries.length;e++)t=Math.max(t,this._geometries[e].getBoundaryDimension());return t},e.prototype.getDimension=function(){for(var t=Vt.FALSE,e=0;e<this._geometries.length;e++)t=Math.max(t,this._geometries[e].getDimension());return t},e.prototype.getLength=function(){for(var t=0,e=0;e<this._geometries.length;e++)t+=this._geometries[e].getLength();return t},e.prototype.getNumPoints=function(){for(var t=0,e=0;e<this._geometries.length;e++)t+=this._geometries[e].getNumPoints();return t},e.prototype.getNumGeometries=function(){return this._geometries.length},e.prototype.reverse=function(){for(var t=new Array(this._geometries.length).fill(null),e=0;e<this._geometries.length;e++)t[e]=this._geometries[e].reverse();return this.getFactory().createGeometryCollection(t)},e.prototype.compareToSameClass=function(){if(1===arguments.length){var t=arguments[0],e=new f(Gt.asList(this._geometries)),n=new f(Gt.asList(t._geometries));return this.compare(e,n)}if(2===arguments.length){for(var i=arguments[1],r=arguments[0],o=this.getNumGeometries(),s=r.getNumGeometries(),a=0;a<o&&a<s;){var u=this.getGeometryN(a),l=r.getGeometryN(a),c=u.compareToSameClass(l,i);if(0!==c)return c;a++}return a<o?1:a<s?-1:0}},e.prototype.apply=function(){if(P(arguments[0],ft))for(var t=arguments[0],e=0;e<this._geometries.length;e++)this._geometries[e].apply(t);else if(P(arguments[0],Ut)){var n=arguments[0];if(0===this._geometries.length)return null;for(var i=0;i<this._geometries.length&&(this._geometries[i].apply(n),!n.isDone());i++);n.isGeometryChanged()&&this.geometryChanged()}else if(P(arguments[0],qt)){var r=arguments[0];r.filter(this);for(var o=0;o<this._geometries.length;o++)this._geometries[o].apply(r)}else if(P(arguments[0],lt)){var s=arguments[0];s.filter(this);for(var a=0;a<this._geometries.length;a++)this._geometries[a].apply(s)}},e.prototype.getBoundary=function(){return this.checkNotGeometryCollection(this),et.shouldNeverReachHere(),null},e.prototype.clone=function(){var e=t.prototype.clone.call(this);e._geometries=new Array(this._geometries.length).fill(null);for(var n=0;n<this._geometries.length;n++)e._geometries[n]=this._geometries[n].clone();return e},e.prototype.getGeometryType=function(){return"GeometryCollection"},e.prototype.copy=function(){for(var t=new Array(this._geometries.length).fill(null),n=0;n<t.length;n++)t[n]=this._geometries[n].copy();return new e(t,this._factory)},e.prototype.isEmpty=function(){for(var t=0;t<this._geometries.length;t++)if(!this._geometries[t].isEmpty())return!1;return!0},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x4f07bcb1f857d800},Object.defineProperties(e,n),e}(ct),zt=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return ct.SORTINDEX_MULTILINESTRING},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return this.isClosed()?Vt.FALSE:0},e.prototype.isClosed=function(){if(this.isEmpty())return!1;for(var t=0;t<this._geometries.length;t++)if(!this._geometries[t].isClosed())return!1;return!0},e.prototype.getDimension=function(){return 1},e.prototype.reverse=function(){for(var t=this._geometries.length,e=new Array(t).fill(null),n=0;n<this._geometries.length;n++)e[t-1-n]=this._geometries[n].reverse();return this.getFactory().createMultiLineString(e)},e.prototype.getBoundary=function(){return new Xt(this).getBoundary()},e.prototype.getGeometryType=function(){return"MultiLineString"},e.prototype.copy=function(){for(var t=new Array(this._geometries.length).fill(null),n=0;n<t.length;n++)t[n]=this._geometries[n].copy();return new e(t,this._factory)},e.prototype.interfaces_=function(){return[At]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x7155d2ab4afa8000},Object.defineProperties(e,n),e}(kt),Xt=function(){if(this._geom=null,this._geomFact=null,this._bnRule=null,this._endpointMap=null,1===arguments.length){var t=arguments[0],e=gt.MOD2_BOUNDARY_RULE;this._geom=t,this._geomFact=t.getFactory(),this._bnRule=e}else if(2===arguments.length){var n=arguments[0],i=arguments[1];this._geom=n,this._geomFact=n.getFactory(),this._bnRule=i}};Xt.prototype.boundaryMultiLineString=function(t){if(this._geom.isEmpty())return this.getEmptyMultiPoint();var e=this.computeBoundaryCoordinates(t);return 1===e.length?this._geomFact.createPoint(e[0]):this._geomFact.createMultiPointFromCoords(e)},Xt.prototype.getBoundary=function(){return this._geom instanceof Jt?this.boundaryLineString(this._geom):this._geom instanceof zt?this.boundaryMultiLineString(this._geom):this._geom.getBoundary()},Xt.prototype.boundaryLineString=function(t){return this._geom.isEmpty()?this.getEmptyMultiPoint():t.isClosed()?this._bnRule.isInBoundary(2)?t.getStartPoint():this._geomFact.createMultiPoint():this._geomFact.createMultiPoint([t.getStartPoint(),t.getEndPoint()])},Xt.prototype.getEmptyMultiPoint=function(){return this._geomFact.createMultiPoint()},Xt.prototype.computeBoundaryCoordinates=function(t){var e=new Nt;this._endpointMap=new h;for(var n=0;n<t.getNumGeometries();n++){var i=t.getGeometryN(n);0!==i.getNumPoints()&&(this.addEndpoint(i.getCoordinateN(0)),this.addEndpoint(i.getCoordinateN(i.getNumPoints()-1)))}for(var r=this._endpointMap.entrySet().iterator();r.hasNext();){var o=r.next(),s=o.getValue().count;this._bnRule.isInBoundary(s)&&e.add(o.getKey())}return St.toCoordinateArray(e)},Xt.prototype.addEndpoint=function(t){var e=this._endpointMap.get(t);null===e&&(e=new Yt,this._endpointMap.put(t,e)),e.count++},Xt.prototype.interfaces_=function(){return[]},Xt.prototype.getClass=function(){return Xt},Xt.getBoundary=function(){return 1===arguments.length?new Xt(arguments[0]).getBoundary():2===arguments.length?new Xt(arguments[0],arguments[1]).getBoundary():void 0};var Yt=function(){this.count=null};Yt.prototype.interfaces_=function(){return[]},Yt.prototype.getClass=function(){return Yt};var jt=function(){},Ht={NEWLINE:{configurable:!0},SIMPLE_ORDINATE_FORMAT:{configurable:!0}};jt.prototype.interfaces_=function(){return[]},jt.prototype.getClass=function(){return jt},jt.chars=function(t,e){for(var n=new Array(e).fill(null),i=0;i<e;i++)n[i]=t;return String(n)},jt.getStackTrace=function(){if(1===arguments.length){var t=arguments[0],e=new function(){},n=new function(){};return t.printStackTrace(n),e.toString()}if(2===arguments.length){for(var i=arguments[1],r="",o=new function(){}(new function(){}(jt.getStackTrace(arguments[0]))),s=0;s<i;s++)try{r+=o.readLine()+jt.NEWLINE}catch(t){if(!(t instanceof g))throw t;et.shouldNeverReachHere()}return r}},jt.split=function(t,e){for(var n=e.length,i=new Nt,r=""+t,o=r.indexOf(e);o>=0;){var s=r.substring(0,o);i.add(s),o=(r=r.substring(o+n)).indexOf(e)}r.length>0&&i.add(r);for(var a=new Array(i.size()).fill(null),u=0;u<a.length;u++)a[u]=i.get(u);return a},jt.toString=function(){if(1===arguments.length)return jt.SIMPLE_ORDINATE_FORMAT.format(arguments[0])},jt.spaces=function(t){return jt.chars(" ",t)},Ht.NEWLINE.get=function(){return X.getProperty("line.separator")},Ht.SIMPLE_ORDINATE_FORMAT.get=function(){return new function(){}},Object.defineProperties(jt,Ht);var Wt=function(){};Wt.prototype.interfaces_=function(){return[]},Wt.prototype.getClass=function(){return Wt},Wt.copyCoord=function(t,e,n,i){for(var r=Math.min(t.getDimension(),n.getDimension()),o=0;o<r;o++)n.setOrdinate(i,o,t.getOrdinate(e,o))},Wt.isRing=function(t){var e=t.size();return 0===e||!(e<=3)&&t.getOrdinate(0,q.X)===t.getOrdinate(e-1,q.X)&&t.getOrdinate(0,q.Y)===t.getOrdinate(e-1,q.Y)},Wt.isEqual=function(t,e){var n=t.size();if(n!==e.size())return!1;for(var i=Math.min(t.getDimension(),e.getDimension()),r=0;r<n;r++)for(var o=0;o<i;o++){var s=t.getOrdinate(r,o),a=e.getOrdinate(r,o);if(!(t.getOrdinate(r,o)===e.getOrdinate(r,o)||v.isNaN(s)&&v.isNaN(a)))return!1}return!0},Wt.extend=function(t,e,n){var i=t.create(n,e.getDimension()),r=e.size();if(Wt.copy(e,0,i,0,r),r>0)for(var o=r;o<n;o++)Wt.copy(e,r-1,i,o,1);return i},Wt.reverse=function(t){for(var e=t.size()-1,n=Math.trunc(e/2),i=0;i<=n;i++)Wt.swap(t,i,e-i)},Wt.swap=function(t,e,n){if(e===n)return null;for(var i=0;i<t.getDimension();i++){var r=t.getOrdinate(e,i);t.setOrdinate(e,i,t.getOrdinate(n,i)),t.setOrdinate(n,i,r)}},Wt.copy=function(t,e,n,i,r){for(var o=0;o<r;o++)Wt.copyCoord(t,e+o,n,i+o)},Wt.toString=function(){if(1===arguments.length){var t=arguments[0],e=t.size();if(0===e)return"()";var n=t.getDimension(),i=new R;i.append("(");for(var r=0;r<e;r++){r>0&&i.append(" ");for(var o=0;o<n;o++)o>0&&i.append(","),i.append(jt.toString(t.getOrdinate(r,o)))}return i.append(")"),i.toString()}},Wt.ensureValidRing=function(t,e){var n=e.size();return 0===n?e:n<=3?Wt.createClosedRing(t,e,4):e.getOrdinate(0,q.X)===e.getOrdinate(n-1,q.X)&&e.getOrdinate(0,q.Y)===e.getOrdinate(n-1,q.Y)?e:Wt.createClosedRing(t,e,n+1)},Wt.createClosedRing=function(t,e,n){var i=t.create(n,e.getDimension()),r=e.size();Wt.copy(e,0,i,0,r);for(var o=r;o<n;o++)Wt.copy(e,0,i,o,1);return i};var Jt=function(t){function e(e,n){t.call(this,n),this._points=null,this.init(e)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){return this.isEmpty()?new j:this._points.expandEnvelope(new j)},e.prototype.isRing=function(){return this.isClosed()&&this.isSimple()},e.prototype.getSortIndex=function(){return t.SORTINDEX_LINESTRING},e.prototype.getCoordinates=function(){return this._points.toCoordinateArray()},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];if(!this.isEquivalentClass(e))return!1;var i=e;if(this._points.size()!==i._points.size())return!1;for(var r=0;r<this._points.size();r++)if(!this.equal(this._points.getCoordinate(r),i._points.getCoordinate(r),n))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){for(var t=0;t<Math.trunc(this._points.size()/2);t++){var e=this._points.size()-1-t;if(!this._points.getCoordinate(t).equals(this._points.getCoordinate(e)))return this._points.getCoordinate(t).compareTo(this._points.getCoordinate(e))>0&&Wt.reverse(this._points),null}},e.prototype.getCoordinate=function(){return this.isEmpty()?null:this._points.getCoordinate(0)},e.prototype.getBoundaryDimension=function(){return this.isClosed()?Vt.FALSE:0},e.prototype.isClosed=function(){return!this.isEmpty()&&this.getCoordinateN(0).equals2D(this.getCoordinateN(this.getNumPoints()-1))},e.prototype.getEndPoint=function(){return this.isEmpty()?null:this.getPointN(this.getNumPoints()-1)},e.prototype.getDimension=function(){return 1},e.prototype.getLength=function(){return at.computeLength(this._points)},e.prototype.getNumPoints=function(){return this._points.size()},e.prototype.reverse=function(){var t=this._points.copy();return Wt.reverse(t),this.getFactory().createLineString(t)},e.prototype.compareToSameClass=function(){if(1===arguments.length){for(var t=arguments[0],e=0,n=0;e<this._points.size()&&n<t._points.size();){var i=this._points.getCoordinate(e).compareTo(t._points.getCoordinate(n));if(0!==i)return i;e++,n++}return e<this._points.size()?1:n<t._points.size()?-1:0}if(2===arguments.length)return arguments[1].compare(this._points,arguments[0]._points)},e.prototype.apply=function(){if(P(arguments[0],ft))for(var t=arguments[0],e=0;e<this._points.size();e++)t.filter(this._points.getCoordinate(e));else if(P(arguments[0],Ut)){var n=arguments[0];if(0===this._points.size())return null;for(var i=0;i<this._points.size()&&(n.filter(this._points,i),!n.isDone());i++);n.isGeometryChanged()&&this.geometryChanged()}else(P(arguments[0],qt)||P(arguments[0],lt))&&arguments[0].filter(this)},e.prototype.getBoundary=function(){return new Xt(this).getBoundary()},e.prototype.isEquivalentClass=function(t){return t instanceof e},e.prototype.clone=function(){var e=t.prototype.clone.call(this);return e._points=this._points.clone(),e},e.prototype.getCoordinateN=function(t){return this._points.getCoordinate(t)},e.prototype.getGeometryType=function(){return"LineString"},e.prototype.copy=function(){return new e(this._points.copy(),this._factory)},e.prototype.getCoordinateSequence=function(){return this._points},e.prototype.isEmpty=function(){return 0===this._points.size()},e.prototype.init=function(t){if(null===t&&(t=this.getFactory().getCoordinateSequenceFactory().create([])),1===t.size())throw new m("Invalid number of points in LineString (found "+t.size()+" - must be 0 or >= 2)");this._points=t},e.prototype.isCoordinate=function(t){for(var e=0;e<this._points.size();e++)if(this._points.getCoordinate(e).equals(t))return!0;return!1},e.prototype.getStartPoint=function(){return this.isEmpty()?null:this.getPointN(0)},e.prototype.getPointN=function(t){return this.getFactory().createPoint(this._points.getCoordinate(t))},e.prototype.interfaces_=function(){return[At]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x2b2b51ba435c8e00},Object.defineProperties(e,n),e}(ct),Kt=function(){};Kt.prototype.interfaces_=function(){return[]},Kt.prototype.getClass=function(){return Kt};var Qt=function(t){function e(e,n){t.call(this,n),this._coordinates=e||null,this.init(this._coordinates)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){if(this.isEmpty())return new j;var t=new j;return t.expandToInclude(this._coordinates.getX(0),this._coordinates.getY(0)),t},e.prototype.getSortIndex=function(){return t.SORTINDEX_POINT},e.prototype.getCoordinates=function(){return this.isEmpty()?[]:[this.getCoordinate()]},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&(!(!this.isEmpty()||!e.isEmpty())||this.isEmpty()===e.isEmpty()&&this.equal(e.getCoordinate(),this.getCoordinate(),n))}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){},e.prototype.getCoordinate=function(){return 0!==this._coordinates.size()?this._coordinates.getCoordinate(0):null},e.prototype.getBoundaryDimension=function(){return Vt.FALSE},e.prototype.getDimension=function(){return 0},e.prototype.getNumPoints=function(){return this.isEmpty()?0:1},e.prototype.reverse=function(){return this.copy()},e.prototype.getX=function(){if(null===this.getCoordinate())throw new Error("getX called on empty Point");return this.getCoordinate().x},e.prototype.compareToSameClass=function(){if(1===arguments.length){var t=arguments[0];return this.getCoordinate().compareTo(t.getCoordinate())}if(2===arguments.length)return arguments[1].compare(this._coordinates,arguments[0]._coordinates)},e.prototype.apply=function(){if(P(arguments[0],ft)){var t=arguments[0];if(this.isEmpty())return null;t.filter(this.getCoordinate())}else if(P(arguments[0],Ut)){var e=arguments[0];if(this.isEmpty())return null;e.filter(this._coordinates,0),e.isGeometryChanged()&&this.geometryChanged()}else(P(arguments[0],qt)||P(arguments[0],lt))&&arguments[0].filter(this)},e.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},e.prototype.clone=function(){var e=t.prototype.clone.call(this);return e._coordinates=this._coordinates.clone(),e},e.prototype.getGeometryType=function(){return"Point"},e.prototype.copy=function(){return new e(this._coordinates.copy(),this._factory)},e.prototype.getCoordinateSequence=function(){return this._coordinates},e.prototype.getY=function(){if(null===this.getCoordinate())throw new Error("getY called on empty Point");return this.getCoordinate().y},e.prototype.isEmpty=function(){return 0===this._coordinates.size()},e.prototype.init=function(t){null===t&&(t=this.getFactory().getCoordinateSequenceFactory().create([])),et.isTrue(t.size()<=1),this._coordinates=t},e.prototype.isSimple=function(){return!0},e.prototype.interfaces_=function(){return[Kt]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x44077bad161cbc00},Object.defineProperties(e,n),e}(ct),$t=function(){};$t.prototype.interfaces_=function(){return[]},$t.prototype.getClass=function(){return $t};var Zt=function(t){function e(e,n,i){if(t.call(this,i),this._shell=null,this._holes=null,null===e&&(e=this.getFactory().createLinearRing()),null===n&&(n=[]),t.hasNullElements(n))throw new m("holes must not contain null elements");if(e.isEmpty()&&t.hasNonEmptyElements(n))throw new m("shell is empty but holes are not");this._shell=e,this._holes=n}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){return this._shell.getEnvelopeInternal()},e.prototype.getSortIndex=function(){return t.SORTINDEX_POLYGON},e.prototype.getCoordinates=function(){if(this.isEmpty())return[];for(var t=new Array(this.getNumPoints()).fill(null),e=-1,n=this._shell.getCoordinates(),i=0;i<n.length;i++)t[++e]=n[i];for(var r=0;r<this._holes.length;r++)for(var o=this._holes[r].getCoordinates(),s=0;s<o.length;s++)t[++e]=o[s];return t},e.prototype.getArea=function(){var t=0;t+=Math.abs(at.signedArea(this._shell.getCoordinateSequence()));for(var e=0;e<this._holes.length;e++)t-=Math.abs(at.signedArea(this._holes[e].getCoordinateSequence()));return t},e.prototype.isRectangle=function(){if(0!==this.getNumInteriorRing())return!1;if(null===this._shell)return!1;if(5!==this._shell.getNumPoints())return!1;for(var t=this._shell.getCoordinateSequence(),e=this.getEnvelopeInternal(),n=0;n<5;n++){var i=t.getX(n);if(i!==e.getMinX()&&i!==e.getMaxX())return!1;var r=t.getY(n);if(r!==e.getMinY()&&r!==e.getMaxY())return!1}for(var o=t.getX(0),s=t.getY(0),a=1;a<=4;a++){var u=t.getX(a),l=t.getY(a);if(u!==o==(l!==s))return!1;o=u,s=l}return!0},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];if(!this.isEquivalentClass(e))return!1;var i=e;if(!this._shell.equalsExact(i._shell,n))return!1;if(this._holes.length!==i._holes.length)return!1;for(var r=0;r<this._holes.length;r++)if(!this._holes[r].equalsExact(i._holes[r],n))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){if(0===arguments.length){this.normalize(this._shell,!0);for(var t=0;t<this._holes.length;t++)this.normalize(this._holes[t],!1);Gt.sort(this._holes)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(e.isEmpty())return null;var i=new Array(e.getCoordinates().length-1).fill(null);X.arraycopy(e.getCoordinates(),0,i,0,i.length);var r=St.minCoordinate(e.getCoordinates());St.scroll(i,r),X.arraycopy(i,0,e.getCoordinates(),0,i.length),e.getCoordinates()[i.length]=i[0],at.isCCW(e.getCoordinates())===n&&St.reverse(e.getCoordinates())}},e.prototype.getCoordinate=function(){return this._shell.getCoordinate()},e.prototype.getNumInteriorRing=function(){return this._holes.length},e.prototype.getBoundaryDimension=function(){return 1},e.prototype.getDimension=function(){return 2},e.prototype.getLength=function(){var t=0;t+=this._shell.getLength();for(var e=0;e<this._holes.length;e++)t+=this._holes[e].getLength();return t},e.prototype.getNumPoints=function(){for(var t=this._shell.getNumPoints(),e=0;e<this._holes.length;e++)t+=this._holes[e].getNumPoints();return t},e.prototype.reverse=function(){var t=this.copy();t._shell=this._shell.copy().reverse(),t._holes=new Array(this._holes.length).fill(null);for(var e=0;e<this._holes.length;e++)t._holes[e]=this._holes[e].copy().reverse();return t},e.prototype.convexHull=function(){return this.getExteriorRing().convexHull()},e.prototype.compareToSameClass=function(){if(1===arguments.length)return this._shell.compareToSameClass(arguments[0]._shell);if(2===arguments.length){var t=arguments[1],e=arguments[0],n=this._shell.compareToSameClass(e._shell,t);if(0!==n)return n;for(var i=this.getNumInteriorRing(),r=e.getNumInteriorRing(),o=0;o<i&&o<r;){var s=this.getInteriorRingN(o),a=e.getInteriorRingN(o),u=s.compareToSameClass(a,t);if(0!==u)return u;o++}return o<i?1:o<r?-1:0}},e.prototype.apply=function(t){if(P(t,ft)){this._shell.apply(t);for(var e=0;e<this._holes.length;e++)this._holes[e].apply(t)}else if(P(t,Ut)){if(this._shell.apply(t),!t.isDone())for(var n=0;n<this._holes.length&&(this._holes[n].apply(t),!t.isDone());n++);t.isGeometryChanged()&&this.geometryChanged()}else if(P(t,qt))t.filter(this);else if(P(t,lt)){t.filter(this),this._shell.apply(t);for(var i=0;i<this._holes.length;i++)this._holes[i].apply(t)}},e.prototype.getBoundary=function(){if(this.isEmpty())return this.getFactory().createMultiLineString();var t=new Array(this._holes.length+1).fill(null);t[0]=this._shell;for(var e=0;e<this._holes.length;e++)t[e+1]=this._holes[e];return t.length<=1?this.getFactory().createLinearRing(t[0].getCoordinateSequence()):this.getFactory().createMultiLineString(t)},e.prototype.clone=function(){var e=t.prototype.clone.call(this);e._shell=this._shell.clone(),e._holes=new Array(this._holes.length).fill(null);for(var n=0;n<this._holes.length;n++)e._holes[n]=this._holes[n].clone();return e},e.prototype.getGeometryType=function(){return"Polygon"},e.prototype.copy=function(){for(var t=this._shell.copy(),n=new Array(this._holes.length).fill(null),i=0;i<n.length;i++)n[i]=this._holes[i].copy();return new e(t,n,this._factory)},e.prototype.getExteriorRing=function(){return this._shell},e.prototype.isEmpty=function(){return this._shell.isEmpty()},e.prototype.getInteriorRingN=function(t){return this._holes[t]},e.prototype.interfaces_=function(){return[$t]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x307ffefd8dc97200},Object.defineProperties(e,n),e}(ct),te=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return ct.SORTINDEX_MULTIPOINT},e.prototype.isValid=function(){return!0},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getCoordinate=function(){return 1===arguments.length?this._geometries[arguments[0]].getCoordinate():t.prototype.getCoordinate.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return Vt.FALSE},e.prototype.getDimension=function(){return 0},e.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},e.prototype.getGeometryType=function(){return"MultiPoint"},e.prototype.copy=function(){for(var t=new Array(this._geometries.length).fill(null),n=0;n<t.length;n++)t[n]=this._geometries[n].copy();return new e(t,this._factory)},e.prototype.interfaces_=function(){return[Kt]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x6fb1ed4162e0fc00},Object.defineProperties(e,n),e}(kt),ee=function(t){function e(e,n){e instanceof w&&n instanceof _e&&(e=n.getCoordinateSequenceFactory().create(e)),t.call(this,e,n),this.validateConstruction()}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={MINIMUM_VALID_SIZE:{configurable:!0},serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return ct.SORTINDEX_LINEARRING},e.prototype.getBoundaryDimension=function(){return Vt.FALSE},e.prototype.isClosed=function(){return!!this.isEmpty()||t.prototype.isClosed.call(this)},e.prototype.reverse=function(){var t=this._points.copy();return Wt.reverse(t),this.getFactory().createLinearRing(t)},e.prototype.validateConstruction=function(){if(!this.isEmpty()&&!t.prototype.isClosed.call(this))throw new m("Points of LinearRing do not form a closed linestring");if(this.getCoordinateSequence().size()>=1&&this.getCoordinateSequence().size()<e.MINIMUM_VALID_SIZE)throw new m("Invalid number of points in LinearRing (found "+this.getCoordinateSequence().size()+" - must be 0 or >= 4)")},e.prototype.getGeometryType=function(){return"LinearRing"},e.prototype.copy=function(){return new e(this._points.copy(),this._factory)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.MINIMUM_VALID_SIZE.get=function(){return 4},n.serialVersionUID.get=function(){return-0x3b229e262367a600},Object.defineProperties(e,n),e}(Jt),ne=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return ct.SORTINDEX_MULTIPOLYGON},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return 1},e.prototype.getDimension=function(){return 2},e.prototype.reverse=function(){for(var t=new Array(this._geometries.length).fill(null),e=0;e<this._geometries.length;e++)t[e]=this._geometries[e].reverse();return this.getFactory().createMultiPolygon(t)},e.prototype.getBoundary=function(){if(this.isEmpty())return this.getFactory().createMultiLineString();for(var t=new Nt,e=0;e<this._geometries.length;e++)for(var n=this._geometries[e].getBoundary(),i=0;i<n.getNumGeometries();i++)t.add(n.getGeometryN(i));var r=new Array(t.size()).fill(null);return this.getFactory().createMultiLineString(t.toArray(r))},e.prototype.getGeometryType=function(){return"MultiPolygon"},e.prototype.copy=function(){for(var t=new Array(this._geometries.length).fill(null),n=0;n<t.length;n++)t[n]=this._geometries[n].copy();return new e(t,this._factory)},e.prototype.interfaces_=function(){return[$t]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x7a5aa1369171980},Object.defineProperties(e,n),e}(kt),ie=function(t){this._factory=t||null,this._isUserDataCopied=!1},re={NoOpGeometryOperation:{configurable:!0},CoordinateOperation:{configurable:!0},CoordinateSequenceOperation:{configurable:!0}};ie.prototype.setCopyUserData=function(t){this._isUserDataCopied=t},ie.prototype.edit=function(t,e){if(null===t)return null;var n=this.editInternal(t,e);return this._isUserDataCopied&&n.setUserData(t.getUserData()),n},ie.prototype.editInternal=function(t,e){return null===this._factory&&(this._factory=t.getFactory()),t instanceof kt?this.editGeometryCollection(t,e):t instanceof Zt?this.editPolygon(t,e):t instanceof Qt||t instanceof Jt?e.edit(t,this._factory):(et.shouldNeverReachHere("Unsupported Geometry class: "+t.getClass().getName()),null)},ie.prototype.editGeometryCollection=function(t,e){for(var n=e.edit(t,this._factory),i=new Nt,r=0;r<n.getNumGeometries();r++){var o=this.edit(n.getGeometryN(r),e);null===o||o.isEmpty()||i.add(o)}return n.getClass()===te?this._factory.createMultiPoint(i.toArray([])):n.getClass()===zt?this._factory.createMultiLineString(i.toArray([])):n.getClass()===ne?this._factory.createMultiPolygon(i.toArray([])):this._factory.createGeometryCollection(i.toArray([]))},ie.prototype.editPolygon=function(t,e){var n=e.edit(t,this._factory);if(null===n&&(n=this._factory.createPolygon(null)),n.isEmpty())return n;var i=this.edit(n.getExteriorRing(),e);if(null===i||i.isEmpty())return this._factory.createPolygon();for(var r=new Nt,o=0;o<n.getNumInteriorRing();o++){var s=this.edit(n.getInteriorRingN(o),e);null===s||s.isEmpty()||r.add(s)}return this._factory.createPolygon(i,r.toArray([]))},ie.prototype.interfaces_=function(){return[]},ie.prototype.getClass=function(){return ie},ie.GeometryEditorOperation=function(){},re.NoOpGeometryOperation.get=function(){return oe},re.CoordinateOperation.get=function(){return se},re.CoordinateSequenceOperation.get=function(){return ae},Object.defineProperties(ie,re);var oe=function(){};oe.prototype.edit=function(t,e){return t},oe.prototype.interfaces_=function(){return[ie.GeometryEditorOperation]},oe.prototype.getClass=function(){return oe};var se=function(){};se.prototype.edit=function(t,e){var n=this.editCoordinates(t.getCoordinates(),t);return null===n?t:t instanceof ee?e.createLinearRing(n):t instanceof Jt?e.createLineString(n):t instanceof Qt?n.length>0?e.createPoint(n[0]):e.createPoint():t},se.prototype.interfaces_=function(){return[ie.GeometryEditorOperation]},se.prototype.getClass=function(){return se};var ae=function(){};ae.prototype.edit=function(t,e){return t instanceof ee?e.createLinearRing(this.edit(t.getCoordinateSequence(),t)):t instanceof Jt?e.createLineString(this.edit(t.getCoordinateSequence(),t)):t instanceof Qt?e.createPoint(this.edit(t.getCoordinateSequence(),t)):t},ae.prototype.interfaces_=function(){return[ie.GeometryEditorOperation]},ae.prototype.getClass=function(){return ae};var ue=function(){if(this._dimension=3,this._coordinates=null,1===arguments.length){if(arguments[0]instanceof Array)this._coordinates=arguments[0],this._dimension=3;else if(Number.isInteger(arguments[0])){var t=arguments[0];this._coordinates=new Array(t).fill(null);for(var e=0;e<t;e++)this._coordinates[e]=new w}else if(P(arguments[0],q)){var n=arguments[0];if(null===n)return this._coordinates=new Array(0).fill(null),null;this._dimension=n.getDimension(),this._coordinates=new Array(n.size()).fill(null);for(var i=0;i<this._coordinates.length;i++)this._coordinates[i]=n.getCoordinateCopy(i)}}else if(2===arguments.length)if(arguments[0]instanceof Array&&Number.isInteger(arguments[1])){var r=arguments[0],o=arguments[1];this._coordinates=r,this._dimension=o,null===r&&(this._coordinates=new Array(0).fill(null))}else if(Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var s=arguments[0],a=arguments[1];this._coordinates=new Array(s).fill(null),this._dimension=a;for(var u=0;u<s;u++)this._coordinates[u]=new w}},le={serialVersionUID:{configurable:!0}};ue.prototype.setOrdinate=function(t,e,n){switch(e){case q.X:this._coordinates[t].x=n;break;case q.Y:this._coordinates[t].y=n;break;case q.Z:this._coordinates[t].z=n;break;default:throw new m("invalid ordinateIndex")}},ue.prototype.size=function(){return this._coordinates.length},ue.prototype.getOrdinate=function(t,e){switch(e){case q.X:return this._coordinates[t].x;case q.Y:return this._coordinates[t].y;case q.Z:return this._coordinates[t].z}return v.NaN},ue.prototype.getCoordinate=function(){if(1===arguments.length)return this._coordinates[arguments[0]];if(2===arguments.length){var t=arguments[0],e=arguments[1];e.x=this._coordinates[t].x,e.y=this._coordinates[t].y,e.z=this._coordinates[t].z}},ue.prototype.getCoordinateCopy=function(t){return new w(this._coordinates[t])},ue.prototype.getDimension=function(){return this._dimension},ue.prototype.getX=function(t){return this._coordinates[t].x},ue.prototype.clone=function(){for(var t=new Array(this.size()).fill(null),e=0;e<this._coordinates.length;e++)t[e]=this._coordinates[e].clone();return new ue(t,this._dimension)},ue.prototype.expandEnvelope=function(t){for(var e=0;e<this._coordinates.length;e++)t.expandToInclude(this._coordinates[e]);return t},ue.prototype.copy=function(){for(var t=new Array(this.size()).fill(null),e=0;e<this._coordinates.length;e++)t[e]=this._coordinates[e].copy();return new ue(t,this._dimension)},ue.prototype.toString=function(){if(this._coordinates.length>0){var t=new R(17*this._coordinates.length);t.append("("),t.append(this._coordinates[0]);for(var e=1;e<this._coordinates.length;e++)t.append(", "),t.append(this._coordinates[e]);return t.append(")"),t.toString()}return"()"},ue.prototype.getY=function(t){return this._coordinates[t].y},ue.prototype.toCoordinateArray=function(){return this._coordinates},ue.prototype.interfaces_=function(){return[q,e]},ue.prototype.getClass=function(){return ue},le.serialVersionUID.get=function(){return-0xcb44a778db18e00},Object.defineProperties(ue,le);var ce=function(){},he={serialVersionUID:{configurable:!0},instanceObject:{configurable:!0}};ce.prototype.readResolve=function(){return ce.instance()},ce.prototype.create=function(){if(1===arguments.length){if(arguments[0]instanceof Array)return new ue(arguments[0]);if(P(arguments[0],q))return new ue(arguments[0])}else if(2===arguments.length){var t=arguments[0],e=arguments[1];return e>3&&(e=3),e<2?new ue(t):new ue(t,e)}},ce.prototype.interfaces_=function(){return[b,e]},ce.prototype.getClass=function(){return ce},ce.instance=function(){return ce.instanceObject},he.serialVersionUID.get=function(){return-0x38e49fa6cf6f2e00},he.instanceObject.get=function(){return new ce},Object.defineProperties(ce,he);var pe=function(t){function e(){t.call(this),this.map_=new Map}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(t){return this.map_.get(t)||null},e.prototype.put=function(t,e){return this.map_.set(t,e),e},e.prototype.values=function(){for(var t=new Nt,e=this.map_.values(),n=e.next();!n.done;)t.add(n.value),n=e.next();return t},e.prototype.entrySet=function(){var t=new Mt;return this.map_.entries().forEach((function(e){return t.add(e)})),t},e.prototype.size=function(){return this.map_.size()},e}(Pt),fe=function t(){if(this._modelType=null,this._scale=null,0===arguments.length)this._modelType=t.FLOATING;else if(1===arguments.length)if(arguments[0]instanceof de){var e=arguments[0];this._modelType=e,e===t.FIXED&&this.setScale(1)}else if("number"==typeof arguments[0]){var n=arguments[0];this._modelType=t.FIXED,this.setScale(n)}else if(arguments[0]instanceof t){var i=arguments[0];this._modelType=i._modelType,this._scale=i._scale}},ge={serialVersionUID:{configurable:!0},maximumPreciseValue:{configurable:!0}};fe.prototype.equals=function(t){return t instanceof fe&&this._modelType===t._modelType&&this._scale===t._scale},fe.prototype.compareTo=function(t){var e=t,n=this.getMaximumSignificantDigits(),i=e.getMaximumSignificantDigits();return new D(n).compareTo(new D(i))},fe.prototype.getScale=function(){return this._scale},fe.prototype.isFloating=function(){return this._modelType===fe.FLOATING||this._modelType===fe.FLOATING_SINGLE},fe.prototype.getType=function(){return this._modelType},fe.prototype.toString=function(){var t="UNKNOWN";return this._modelType===fe.FLOATING?t="Floating":this._modelType===fe.FLOATING_SINGLE?t="Floating-Single":this._modelType===fe.FIXED&&(t="Fixed (Scale="+this.getScale()+")"),t},fe.prototype.makePrecise=function(){if("number"==typeof arguments[0]){var t=arguments[0];return v.isNaN(t)||this._modelType===fe.FLOATING_SINGLE?t:this._modelType===fe.FIXED?Math.round(t*this._scale)/this._scale:t}if(arguments[0]instanceof w){var e=arguments[0];if(this._modelType===fe.FLOATING)return null;e.x=this.makePrecise(e.x),e.y=this.makePrecise(e.y)}},fe.prototype.getMaximumSignificantDigits=function(){var t=16;return this._modelType===fe.FLOATING?t=16:this._modelType===fe.FLOATING_SINGLE?t=6:this._modelType===fe.FIXED&&(t=1+Math.trunc(Math.ceil(Math.log(this.getScale())/Math.log(10)))),t},fe.prototype.setScale=function(t){this._scale=Math.abs(t)},fe.prototype.interfaces_=function(){return[e,I]},fe.prototype.getClass=function(){return fe},fe.mostPrecise=function(t,e){return t.compareTo(e)>=0?t:e},ge.serialVersionUID.get=function(){return 0x6bee6404e9a25c00},ge.maximumPreciseValue.get=function(){return 9007199254740992},Object.defineProperties(fe,ge);var de=function t(e){this._name=e||null,t.nameToTypeMap.put(e,this)},ye={serialVersionUID:{configurable:!0},nameToTypeMap:{configurable:!0}};de.prototype.readResolve=function(){return de.nameToTypeMap.get(this._name)},de.prototype.toString=function(){return this._name},de.prototype.interfaces_=function(){return[e]},de.prototype.getClass=function(){return de},ye.serialVersionUID.get=function(){return-552860263173159e4},ye.nameToTypeMap.get=function(){return new pe},Object.defineProperties(de,ye),fe.Type=de,fe.FIXED=new de("FIXED"),fe.FLOATING=new de("FLOATING"),fe.FLOATING_SINGLE=new de("FLOATING SINGLE");var _e=function t(){this._precisionModel=new fe,this._SRID=0,this._coordinateSequenceFactory=t.getDefaultCoordinateSequenceFactory(),0===arguments.length||(1===arguments.length?P(arguments[0],b)?this._coordinateSequenceFactory=arguments[0]:arguments[0]instanceof fe&&(this._precisionModel=arguments[0]):2===arguments.length?(this._precisionModel=arguments[0],this._SRID=arguments[1]):3===arguments.length&&(this._precisionModel=arguments[0],this._SRID=arguments[1],this._coordinateSequenceFactory=arguments[2]))},me={serialVersionUID:{configurable:!0}};_e.prototype.toGeometry=function(t){return t.isNull()?this.createPoint(null):t.getMinX()===t.getMaxX()&&t.getMinY()===t.getMaxY()?this.createPoint(new w(t.getMinX(),t.getMinY())):t.getMinX()===t.getMaxX()||t.getMinY()===t.getMaxY()?this.createLineString([new w(t.getMinX(),t.getMinY()),new w(t.getMaxX(),t.getMaxY())]):this.createPolygon(this.createLinearRing([new w(t.getMinX(),t.getMinY()),new w(t.getMinX(),t.getMaxY()),new w(t.getMaxX(),t.getMaxY()),new w(t.getMaxX(),t.getMinY()),new w(t.getMinX(),t.getMinY())]),null)},_e.prototype.createLineString=function(t){return t?t instanceof Array?new Jt(this.getCoordinateSequenceFactory().create(t),this):P(t,q)?new Jt(t,this):void 0:new Jt(this.getCoordinateSequenceFactory().create([]),this)},_e.prototype.createMultiLineString=function(){return 0===arguments.length?new zt(null,this):1===arguments.length?new zt(arguments[0],this):void 0},_e.prototype.buildGeometry=function(t){for(var e=null,n=!1,i=!1,r=t.iterator();r.hasNext();){var o=r.next(),s=o.getClass();null===e&&(e=s),s!==e&&(n=!0),o.isGeometryCollectionOrDerived()&&(i=!0)}if(null===e)return this.createGeometryCollection();if(n||i)return this.createGeometryCollection(_e.toGeometryArray(t));var a=t.iterator().next();if(t.size()>1){if(a instanceof Zt)return this.createMultiPolygon(_e.toPolygonArray(t));if(a instanceof Jt)return this.createMultiLineString(_e.toLineStringArray(t));if(a instanceof Qt)return this.createMultiPoint(_e.toPointArray(t));et.shouldNeverReachHere("Unhandled class: "+a.getClass().getName())}return a},_e.prototype.createMultiPointFromCoords=function(t){return this.createMultiPoint(null!==t?this.getCoordinateSequenceFactory().create(t):null)},_e.prototype.createPoint=function(){if(0===arguments.length)return this.createPoint(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof w){var t=arguments[0];return this.createPoint(null!==t?this.getCoordinateSequenceFactory().create([t]):null)}if(P(arguments[0],q))return new Qt(arguments[0],this)}},_e.prototype.getCoordinateSequenceFactory=function(){return this._coordinateSequenceFactory},_e.prototype.createPolygon=function(){if(0===arguments.length)return new Zt(null,null,this);if(1===arguments.length){if(P(arguments[0],q))return this.createPolygon(this.createLinearRing(arguments[0]));if(arguments[0]instanceof Array)return this.createPolygon(this.createLinearRing(arguments[0]));if(arguments[0]instanceof ee)return this.createPolygon(arguments[0],null)}else if(2===arguments.length)return new Zt(arguments[0],arguments[1],this)},_e.prototype.getSRID=function(){return this._SRID},_e.prototype.createGeometryCollection=function(){return 0===arguments.length?new kt(null,this):1===arguments.length?new kt(arguments[0],this):void 0},_e.prototype.createGeometry=function(t){return new ie(this).edit(t,{edit:function(){if(2===arguments.length)return this._coordinateSequenceFactory.create(arguments[0])}})},_e.prototype.getPrecisionModel=function(){return this._precisionModel},_e.prototype.createLinearRing=function(){if(0===arguments.length)return this.createLinearRing(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof Array){var t=arguments[0];return this.createLinearRing(null!==t?this.getCoordinateSequenceFactory().create(t):null)}if(P(arguments[0],q))return new ee(arguments[0],this)}},_e.prototype.createMultiPolygon=function(){return 0===arguments.length?new ne(null,this):1===arguments.length?new ne(arguments[0],this):void 0},_e.prototype.createMultiPoint=function(){if(0===arguments.length)return new te(null,this);if(1===arguments.length){if(arguments[0]instanceof Array)return new te(arguments[0],this);if(arguments[0]instanceof Array){var t=arguments[0];return this.createMultiPoint(null!==t?this.getCoordinateSequenceFactory().create(t):null)}if(P(arguments[0],q)){var e=arguments[0];if(null===e)return this.createMultiPoint(new Array(0).fill(null));for(var n=new Array(e.size()).fill(null),i=0;i<e.size();i++){var r=this.getCoordinateSequenceFactory().create(1,e.getDimension());Wt.copy(e,i,r,0,1),n[i]=this.createPoint(r)}return this.createMultiPoint(n)}}},_e.prototype.interfaces_=function(){return[e]},_e.prototype.getClass=function(){return _e},_e.toMultiPolygonArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},_e.toGeometryArray=function(t){if(null===t)return null;var e=new Array(t.size()).fill(null);return t.toArray(e)},_e.getDefaultCoordinateSequenceFactory=function(){return ce.instance()},_e.toMultiLineStringArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},_e.toLineStringArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},_e.toMultiPointArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},_e.toLinearRingArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},_e.toPointArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},_e.toPolygonArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},_e.createPointFromInternalCoord=function(t,e){return e.getPrecisionModel().makePrecise(t),e.getFactory().createPoint(t)},me.serialVersionUID.get=function(){return-0x5ea75f2051eeb400},Object.defineProperties(_e,me);var ve=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],xe=function(t){this.geometryFactory=t||new _e};xe.prototype.read=function(t){var e,n=(e="string"==typeof t?JSON.parse(t):t).type;if(!Ie[n])throw new Error("Unknown GeoJSON type: "+e.type);return-1!==ve.indexOf(n)?Ie[n].apply(this,[e.coordinates]):Ie[n].apply(this,"GeometryCollection"===n?[e.geometries]:[e])},xe.prototype.write=function(t){var e=t.getGeometryType();if(!Ee[e])throw new Error("Geometry is not supported");return Ee[e].apply(this,[t])};var Ie={Feature:function(t){var e={};for(var n in t)e[n]=t[n];if(t.geometry){if(!Ie[t.geometry.type])throw new Error("Unknown GeoJSON type: "+t.type);e.geometry=this.read(t.geometry)}return t.bbox&&(e.bbox=Ie.bbox.apply(this,[t.bbox])),e},FeatureCollection:function(t){var e={};if(t.features){e.features=[];for(var n=0;n<t.features.length;++n)e.features.push(this.read(t.features[n]))}return t.bbox&&(e.bbox=this.parse.bbox.apply(this,[t.bbox])),e},coordinates:function(t){for(var e=[],n=0;n<t.length;++n){var i=t[n];e.push(new w(i[0],i[1]))}return e},bbox:function(t){return this.geometryFactory.createLinearRing([new w(t[0],t[1]),new w(t[2],t[1]),new w(t[2],t[3]),new w(t[0],t[3]),new w(t[0],t[1])])},Point:function(t){var e=new w(t[0],t[1]);return this.geometryFactory.createPoint(e)},MultiPoint:function(t){for(var e=[],n=0;n<t.length;++n)e.push(Ie.Point.apply(this,[t[n]]));return this.geometryFactory.createMultiPoint(e)},LineString:function(t){var e=Ie.coordinates.apply(this,[t]);return this.geometryFactory.createLineString(e)},MultiLineString:function(t){for(var e=[],n=0;n<t.length;++n)e.push(Ie.LineString.apply(this,[t[n]]));return this.geometryFactory.createMultiLineString(e)},Polygon:function(t){for(var e=Ie.coordinates.apply(this,[t[0]]),n=this.geometryFactory.createLinearRing(e),i=[],r=1;r<t.length;++r){var o=Ie.coordinates.apply(this,[t[r]]),s=this.geometryFactory.createLinearRing(o);i.push(s)}return this.geometryFactory.createPolygon(n,i)},MultiPolygon:function(t){for(var e=[],n=0;n<t.length;++n)e.push(Ie.Polygon.apply(this,[t[n]]));return this.geometryFactory.createMultiPolygon(e)},GeometryCollection:function(t){for(var e=[],n=0;n<t.length;++n)e.push(this.read(t[n]));return this.geometryFactory.createGeometryCollection(e)}},Ee={coordinate:function(t){return[t.x,t.y]},Point:function(t){return{type:"Point",coordinates:Ee.coordinate.apply(this,[t.getCoordinate()])}},MultiPoint:function(t){for(var e=[],n=0;n<t._geometries.length;++n){var i=Ee.Point.apply(this,[t._geometries[n]]);e.push(i.coordinates)}return{type:"MultiPoint",coordinates:e}},LineString:function(t){for(var e=[],n=t.getCoordinates(),i=0;i<n.length;++i)e.push(Ee.coordinate.apply(this,[n[i]]));return{type:"LineString",coordinates:e}},MultiLineString:function(t){for(var e=[],n=0;n<t._geometries.length;++n){var i=Ee.LineString.apply(this,[t._geometries[n]]);e.push(i.coordinates)}return{type:"MultiLineString",coordinates:e}},Polygon:function(t){var e=[],n=Ee.LineString.apply(this,[t._shell]);e.push(n.coordinates);for(var i=0;i<t._holes.length;++i){var r=Ee.LineString.apply(this,[t._holes[i]]);e.push(r.coordinates)}return{type:"Polygon",coordinates:e}},MultiPolygon:function(t){for(var e=[],n=0;n<t._geometries.length;++n){var i=Ee.Polygon.apply(this,[t._geometries[n]]);e.push(i.coordinates)}return{type:"MultiPolygon",coordinates:e}},GeometryCollection:function(t){for(var e=[],n=0;n<t._geometries.length;++n){var i=t._geometries[n],r=i.getGeometryType();e.push(Ee[r].apply(this,[i]))}return{type:"GeometryCollection",geometries:e}}},Ne=function(t){this.geometryFactory=t||new _e,this.precisionModel=this.geometryFactory.getPrecisionModel(),this.parser=new xe(this.geometryFactory)};Ne.prototype.read=function(t){var e=this.parser.read(t);return this.precisionModel.getType()===fe.FIXED&&this.reducePrecision(e),e},Ne.prototype.reducePrecision=function(t){var e,n;if(t.coordinate)this.precisionModel.makePrecise(t.coordinate);else if(t.points)for(e=0,n=t.points.length;e<n;e++)this.precisionModel.makePrecise(t.points[e]);else if(t.geometries)for(e=0,n=t.geometries.length;e<n;e++)this.reducePrecision(t.geometries[e])};var we=function(){this.parser=new xe(this.geometryFactory)};we.prototype.write=function(t){return this.parser.write(t)};var Ce=function(){},Se={ON:{configurable:!0},LEFT:{configurable:!0},RIGHT:{configurable:!0}};Ce.prototype.interfaces_=function(){return[]},Ce.prototype.getClass=function(){return Ce},Ce.opposite=function(t){return t===Ce.LEFT?Ce.RIGHT:t===Ce.RIGHT?Ce.LEFT:t},Se.ON.get=function(){return 0},Se.LEFT.get=function(){return 1},Se.RIGHT.get=function(){return 2},Object.defineProperties(Ce,Se),(d.prototype=new Error).name="EmptyStackException",(y.prototype=new Et).add=function(t){return this.array_.push(t),!0},y.prototype.get=function(t){if(t<0||t>=this.size())throw new Error;return this.array_[t]},y.prototype.push=function(t){return this.array_.push(t),t},y.prototype.pop=function(t){if(0===this.array_.length)throw new d;return this.array_.pop()},y.prototype.peek=function(){if(0===this.array_.length)throw new d;return this.array_[this.array_.length-1]},y.prototype.empty=function(){return 0===this.array_.length},y.prototype.isEmpty=function(){return this.empty()},y.prototype.search=function(t){return this.array_.indexOf(t)},y.prototype.size=function(){return this.array_.length},y.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t};var be=function(){this._minIndex=-1,this._minCoord=null,this._minDe=null,this._orientedDe=null};be.prototype.getCoordinate=function(){return this._minCoord},be.prototype.getRightmostSide=function(t,e){var n=this.getRightmostSideOfSegment(t,e);return n<0&&(n=this.getRightmostSideOfSegment(t,e-1)),n<0&&(this._minCoord=null,this.checkForRightmostCoordinate(t)),n},be.prototype.findRightmostEdgeAtVertex=function(){var t=this._minDe.getEdge().getCoordinates();et.isTrue(this._minIndex>0&&this._minIndex<t.length,"rightmost point expected to be interior vertex of edge");var e=t[this._minIndex-1],n=t[this._minIndex+1],i=at.computeOrientation(this._minCoord,n,e),r=!1;(e.y<this._minCoord.y&&n.y<this._minCoord.y&&i===at.COUNTERCLOCKWISE||e.y>this._minCoord.y&&n.y>this._minCoord.y&&i===at.CLOCKWISE)&&(r=!0),r&&(this._minIndex=this._minIndex-1)},be.prototype.getRightmostSideOfSegment=function(t,e){var n=t.getEdge().getCoordinates();if(e<0||e+1>=n.length)return-1;if(n[e].y===n[e+1].y)return-1;var i=Ce.LEFT;return n[e].y<n[e+1].y&&(i=Ce.RIGHT),i},be.prototype.getEdge=function(){return this._orientedDe},be.prototype.checkForRightmostCoordinate=function(t){for(var e=t.getEdge().getCoordinates(),n=0;n<e.length-1;n++)(null===this._minCoord||e[n].x>this._minCoord.x)&&(this._minDe=t,this._minIndex=n,this._minCoord=e[n])},be.prototype.findRightmostEdgeAtNode=function(){var t=this._minDe.getNode().getEdges();this._minDe=t.getRightmostEdge(),this._minDe.isForward()||(this._minDe=this._minDe.getSym(),this._minIndex=this._minDe.getEdge().getCoordinates().length-1)},be.prototype.findEdge=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();n.isForward()&&this.checkForRightmostCoordinate(n)}et.isTrue(0!==this._minIndex||this._minCoord.equals(this._minDe.getCoordinate()),"inconsistency in rightmost processing"),0===this._minIndex?this.findRightmostEdgeAtNode():this.findRightmostEdgeAtVertex(),this._orientedDe=this._minDe,this.getRightmostSide(this._minDe,this._minIndex)===Ce.LEFT&&(this._orientedDe=this._minDe.getSym())},be.prototype.interfaces_=function(){return[]},be.prototype.getClass=function(){return be};var Le=function(t){function e(n,i){t.call(this,e.msgWithCoord(n,i)),this.pt=i?new w(i):null,this.name="TopologyException"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getCoordinate=function(){return this.pt},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.msgWithCoord=function(t,e){return e?t:t+" [ "+e+" ]"},e}(Z),Oe=function(){this.array_=[]};Oe.prototype.addLast=function(t){this.array_.push(t)},Oe.prototype.removeFirst=function(){return this.array_.shift()},Oe.prototype.isEmpty=function(){return 0===this.array_.length};var Pe=function(){this._finder=null,this._dirEdgeList=new Nt,this._nodes=new Nt,this._rightMostCoord=null,this._env=null,this._finder=new be};Pe.prototype.clearVisitedEdges=function(){for(var t=this._dirEdgeList.iterator();t.hasNext();)t.next().setVisited(!1)},Pe.prototype.getRightmostCoordinate=function(){return this._rightMostCoord},Pe.prototype.computeNodeDepth=function(t){for(var e=null,n=t.getEdges().iterator();n.hasNext();){var i=n.next();if(i.isVisited()||i.getSym().isVisited()){e=i;break}}if(null===e)throw new Le("unable to find edge to compute depths at "+t.getCoordinate());t.getEdges().computeDepths(e);for(var r=t.getEdges().iterator();r.hasNext();){var o=r.next();o.setVisited(!0),this.copySymDepths(o)}},Pe.prototype.computeDepth=function(t){this.clearVisitedEdges();var e=this._finder.getEdge();e.setEdgeDepths(Ce.RIGHT,t),this.copySymDepths(e),this.computeDepths(e)},Pe.prototype.create=function(t){this.addReachable(t),this._finder.findEdge(this._dirEdgeList),this._rightMostCoord=this._finder.getCoordinate()},Pe.prototype.findResultEdges=function(){for(var t=this._dirEdgeList.iterator();t.hasNext();){var e=t.next();e.getDepth(Ce.RIGHT)>=1&&e.getDepth(Ce.LEFT)<=0&&!e.isInteriorAreaEdge()&&e.setInResult(!0)}},Pe.prototype.computeDepths=function(t){var e=new Mt,n=new Oe,i=t.getNode();for(n.addLast(i),e.add(i),t.setVisited(!0);!n.isEmpty();){var r=n.removeFirst();e.add(r),this.computeNodeDepth(r);for(var o=r.getEdges().iterator();o.hasNext();){var s=o.next().getSym();if(!s.isVisited()){var a=s.getNode();e.contains(a)||(n.addLast(a),e.add(a))}}}},Pe.prototype.compareTo=function(t){return this._rightMostCoord.x<t._rightMostCoord.x?-1:this._rightMostCoord.x>t._rightMostCoord.x?1:0},Pe.prototype.getEnvelope=function(){if(null===this._env){for(var t=new j,e=this._dirEdgeList.iterator();e.hasNext();)for(var n=e.next().getEdge().getCoordinates(),i=0;i<n.length-1;i++)t.expandToInclude(n[i]);this._env=t}return this._env},Pe.prototype.addReachable=function(t){var e=new y;for(e.add(t);!e.empty();){var n=e.pop();this.add(n,e)}},Pe.prototype.copySymDepths=function(t){var e=t.getSym();e.setDepth(Ce.LEFT,t.getDepth(Ce.RIGHT)),e.setDepth(Ce.RIGHT,t.getDepth(Ce.LEFT))},Pe.prototype.add=function(t,e){t.setVisited(!0),this._nodes.add(t);for(var n=t.getEdges().iterator();n.hasNext();){var i=n.next();this._dirEdgeList.add(i);var r=i.getSym().getNode();r.isVisited()||e.push(r)}},Pe.prototype.getNodes=function(){return this._nodes},Pe.prototype.getDirectedEdges=function(){return this._dirEdgeList},Pe.prototype.interfaces_=function(){return[I]},Pe.prototype.getClass=function(){return Pe};var Te=function t(){if(this.location=null,1===arguments.length){if(arguments[0]instanceof Array)this.init(arguments[0].length);else if(Number.isInteger(arguments[0])){var e=arguments[0];this.init(1),this.location[Ce.ON]=e}else if(arguments[0]instanceof t){var n=arguments[0];if(this.init(n.location.length),null!==n)for(var i=0;i<this.location.length;i++)this.location[i]=n.location[i]}}else if(3===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2];this.init(3),this.location[Ce.ON]=r,this.location[Ce.LEFT]=o,this.location[Ce.RIGHT]=s}};Te.prototype.setAllLocations=function(t){for(var e=0;e<this.location.length;e++)this.location[e]=t},Te.prototype.isNull=function(){for(var t=0;t<this.location.length;t++)if(this.location[t]!==L.NONE)return!1;return!0},Te.prototype.setAllLocationsIfNull=function(t){for(var e=0;e<this.location.length;e++)this.location[e]===L.NONE&&(this.location[e]=t)},Te.prototype.isLine=function(){return 1===this.location.length},Te.prototype.merge=function(t){if(t.location.length>this.location.length){var e=new Array(3).fill(null);e[Ce.ON]=this.location[Ce.ON],e[Ce.LEFT]=L.NONE,e[Ce.RIGHT]=L.NONE,this.location=e}for(var n=0;n<this.location.length;n++)this.location[n]===L.NONE&&n<t.location.length&&(this.location[n]=t.location[n])},Te.prototype.getLocations=function(){return this.location},Te.prototype.flip=function(){if(this.location.length<=1)return null;var t=this.location[Ce.LEFT];this.location[Ce.LEFT]=this.location[Ce.RIGHT],this.location[Ce.RIGHT]=t},Te.prototype.toString=function(){var t=new R;return this.location.length>1&&t.append(L.toLocationSymbol(this.location[Ce.LEFT])),t.append(L.toLocationSymbol(this.location[Ce.ON])),this.location.length>1&&t.append(L.toLocationSymbol(this.location[Ce.RIGHT])),t.toString()},Te.prototype.setLocations=function(t,e,n){this.location[Ce.ON]=t,this.location[Ce.LEFT]=e,this.location[Ce.RIGHT]=n},Te.prototype.get=function(t){return t<this.location.length?this.location[t]:L.NONE},Te.prototype.isArea=function(){return this.location.length>1},Te.prototype.isAnyNull=function(){for(var t=0;t<this.location.length;t++)if(this.location[t]===L.NONE)return!0;return!1},Te.prototype.setLocation=function(){1===arguments.length?this.setLocation(Ce.ON,arguments[0]):2===arguments.length&&(this.location[arguments[0]]=arguments[1])},Te.prototype.init=function(t){this.location=new Array(t).fill(null),this.setAllLocations(L.NONE)},Te.prototype.isEqualOnSide=function(t,e){return this.location[e]===t.location[e]},Te.prototype.allPositionsEqual=function(t){for(var e=0;e<this.location.length;e++)if(this.location[e]!==t)return!1;return!0},Te.prototype.interfaces_=function(){return[]},Te.prototype.getClass=function(){return Te};var Me=function t(){if(this.elt=new Array(2).fill(null),1===arguments.length){if(Number.isInteger(arguments[0])){var e=arguments[0];this.elt[0]=new Te(e),this.elt[1]=new Te(e)}else if(arguments[0]instanceof t){var n=arguments[0];this.elt[0]=new Te(n.elt[0]),this.elt[1]=new Te(n.elt[1])}}else if(2===arguments.length){var i=arguments[0],r=arguments[1];this.elt[0]=new Te(L.NONE),this.elt[1]=new Te(L.NONE),this.elt[i].setLocation(r)}else if(3===arguments.length){var o=arguments[0],s=arguments[1],a=arguments[2];this.elt[0]=new Te(o,s,a),this.elt[1]=new Te(o,s,a)}else if(4===arguments.length){var u=arguments[0],l=arguments[1],c=arguments[2],h=arguments[3];this.elt[0]=new Te(L.NONE,L.NONE,L.NONE),this.elt[1]=new Te(L.NONE,L.NONE,L.NONE),this.elt[u].setLocations(l,c,h)}};Me.prototype.getGeometryCount=function(){var t=0;return this.elt[0].isNull()||t++,this.elt[1].isNull()||t++,t},Me.prototype.setAllLocations=function(t,e){this.elt[t].setAllLocations(e)},Me.prototype.isNull=function(t){return this.elt[t].isNull()},Me.prototype.setAllLocationsIfNull=function(){if(1===arguments.length){var t=arguments[0];this.setAllLocationsIfNull(0,t),this.setAllLocationsIfNull(1,t)}else 2===arguments.length&&this.elt[arguments[0]].setAllLocationsIfNull(arguments[1])},Me.prototype.isLine=function(t){return this.elt[t].isLine()},Me.prototype.merge=function(t){for(var e=0;e<2;e++)null===this.elt[e]&&null!==t.elt[e]?this.elt[e]=new Te(t.elt[e]):this.elt[e].merge(t.elt[e])},Me.prototype.flip=function(){this.elt[0].flip(),this.elt[1].flip()},Me.prototype.getLocation=function(){return 1===arguments.length?this.elt[arguments[0]].get(Ce.ON):2===arguments.length?this.elt[arguments[0]].get(arguments[1]):void 0},Me.prototype.toString=function(){var t=new R;return null!==this.elt[0]&&(t.append("A:"),t.append(this.elt[0].toString())),null!==this.elt[1]&&(t.append(" B:"),t.append(this.elt[1].toString())),t.toString()},Me.prototype.isArea=function(){return 0===arguments.length?this.elt[0].isArea()||this.elt[1].isArea():1===arguments.length?this.elt[arguments[0]].isArea():void 0},Me.prototype.isAnyNull=function(t){return this.elt[t].isAnyNull()},Me.prototype.setLocation=function(){2===arguments.length?this.elt[arguments[0]].setLocation(Ce.ON,arguments[1]):3===arguments.length&&this.elt[arguments[0]].setLocation(arguments[1],arguments[2])},Me.prototype.isEqualOnSide=function(t,e){return this.elt[0].isEqualOnSide(t.elt[0],e)&&this.elt[1].isEqualOnSide(t.elt[1],e)},Me.prototype.allPositionsEqual=function(t,e){return this.elt[t].allPositionsEqual(e)},Me.prototype.toLine=function(t){this.elt[t].isArea()&&(this.elt[t]=new Te(this.elt[t].location[0]))},Me.prototype.interfaces_=function(){return[]},Me.prototype.getClass=function(){return Me},Me.toLineLabel=function(t){for(var e=new Me(L.NONE),n=0;n<2;n++)e.setLocation(n,t.getLocation(n));return e};var Re=function(){this._startDe=null,this._maxNodeDegree=-1,this._edges=new Nt,this._pts=new Nt,this._label=new Me(L.NONE),this._ring=null,this._isHole=null,this._shell=null,this._holes=new Nt,this._geometryFactory=null;var t=arguments[0];this._geometryFactory=arguments[1],this.computePoints(t),this.computeRing()};Re.prototype.computeRing=function(){if(null!==this._ring)return null;for(var t=new Array(this._pts.size()).fill(null),e=0;e<this._pts.size();e++)t[e]=this._pts.get(e);this._ring=this._geometryFactory.createLinearRing(t),this._isHole=at.isCCW(this._ring.getCoordinates())},Re.prototype.isIsolated=function(){return 1===this._label.getGeometryCount()},Re.prototype.computePoints=function(t){this._startDe=t;var e=t,n=!0;do{if(null===e)throw new Le("Found null DirectedEdge");if(e.getEdgeRing()===this)throw new Le("Directed Edge visited twice during ring-building at "+e.getCoordinate());this._edges.add(e);var i=e.getLabel();et.isTrue(i.isArea()),this.mergeLabel(i),this.addPoints(e.getEdge(),e.isForward(),n),n=!1,this.setEdgeRing(e,this),e=this.getNext(e)}while(e!==this._startDe)},Re.prototype.getLinearRing=function(){return this._ring},Re.prototype.getCoordinate=function(t){return this._pts.get(t)},Re.prototype.computeMaxNodeDegree=function(){this._maxNodeDegree=0;var t=this._startDe;do{var e=t.getNode().getEdges().getOutgoingDegree(this);e>this._maxNodeDegree&&(this._maxNodeDegree=e),t=this.getNext(t)}while(t!==this._startDe);this._maxNodeDegree*=2},Re.prototype.addPoints=function(t,e,n){var i=t.getCoordinates();if(e){var r=1;n&&(r=0);for(var o=r;o<i.length;o++)this._pts.add(i[o])}else{var s=i.length-2;n&&(s=i.length-1);for(var a=s;a>=0;a--)this._pts.add(i[a])}},Re.prototype.isHole=function(){return this._isHole},Re.prototype.setInResult=function(){var t=this._startDe;do{t.getEdge().setInResult(!0),t=t.getNext()}while(t!==this._startDe)},Re.prototype.containsPoint=function(t){var e=this.getLinearRing();if(!e.getEnvelopeInternal().contains(t))return!1;if(!at.isPointInRing(t,e.getCoordinates()))return!1;for(var n=this._holes.iterator();n.hasNext();)if(n.next().containsPoint(t))return!1;return!0},Re.prototype.addHole=function(t){this._holes.add(t)},Re.prototype.isShell=function(){return null===this._shell},Re.prototype.getLabel=function(){return this._label},Re.prototype.getEdges=function(){return this._edges},Re.prototype.getMaxNodeDegree=function(){return this._maxNodeDegree<0&&this.computeMaxNodeDegree(),this._maxNodeDegree},Re.prototype.getShell=function(){return this._shell},Re.prototype.mergeLabel=function(){if(1===arguments.length){var t=arguments[0];this.mergeLabel(t,0),this.mergeLabel(t,1)}else if(2===arguments.length){var e=arguments[1],n=arguments[0].getLocation(e,Ce.RIGHT);if(n===L.NONE)return null;if(this._label.getLocation(e)===L.NONE)return this._label.setLocation(e,n),null}},Re.prototype.setShell=function(t){this._shell=t,null!==t&&t.addHole(this)},Re.prototype.toPolygon=function(t){for(var e=new Array(this._holes.size()).fill(null),n=0;n<this._holes.size();n++)e[n]=this._holes.get(n).getLinearRing();return t.createPolygon(this.getLinearRing(),e)},Re.prototype.interfaces_=function(){return[]},Re.prototype.getClass=function(){return Re};var De=function(t){function e(){t.call(this,arguments[0],arguments[1])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setEdgeRing=function(t,e){t.setMinEdgeRing(e)},e.prototype.getNext=function(t){return t.getNextMin()},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Re),Ae=function(t){function e(){t.call(this,arguments[0],arguments[1])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.buildMinimalRings=function(){var t=new Nt,e=this._startDe;do{if(null===e.getMinEdgeRing()){var n=new De(e,this._geometryFactory);t.add(n)}e=e.getNext()}while(e!==this._startDe);return t},e.prototype.setEdgeRing=function(t,e){t.setEdgeRing(e)},e.prototype.linkDirectedEdgesForMinimalEdgeRings=function(){var t=this._startDe;do{t.getNode().getEdges().linkMinimalDirectedEdges(this),t=t.getNext()}while(t!==this._startDe)},e.prototype.getNext=function(t){return t.getNext()},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Re),Fe=function(){this._label=null,this._isInResult=!1,this._isCovered=!1,this._isCoveredSet=!1,this._isVisited=!1,0===arguments.length||1===arguments.length&&(this._label=arguments[0])};Fe.prototype.setVisited=function(t){this._isVisited=t},Fe.prototype.setInResult=function(t){this._isInResult=t},Fe.prototype.isCovered=function(){return this._isCovered},Fe.prototype.isCoveredSet=function(){return this._isCoveredSet},Fe.prototype.setLabel=function(t){this._label=t},Fe.prototype.getLabel=function(){return this._label},Fe.prototype.setCovered=function(t){this._isCovered=t,this._isCoveredSet=!0},Fe.prototype.updateIM=function(t){et.isTrue(this._label.getGeometryCount()>=2,"found partial label"),this.computeIM(t)},Fe.prototype.isInResult=function(){return this._isInResult},Fe.prototype.isVisited=function(){return this._isVisited},Fe.prototype.interfaces_=function(){return[]},Fe.prototype.getClass=function(){return Fe};var Ge=function(t){function e(){t.call(this),this._coord=null,this._edges=null;var e=arguments[1];this._coord=arguments[0],this._edges=e,this._label=new Me(0,L.NONE)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isIncidentEdgeInResult=function(){for(var t=this.getEdges().getEdges().iterator();t.hasNext();)if(t.next().getEdge().isInResult())return!0;return!1},e.prototype.isIsolated=function(){return 1===this._label.getGeometryCount()},e.prototype.getCoordinate=function(){return this._coord},e.prototype.print=function(t){t.println("node "+this._coord+" lbl: "+this._label)},e.prototype.computeIM=function(t){},e.prototype.computeMergedLocation=function(t,e){var n=L.NONE;if(n=this._label.getLocation(e),!t.isNull(e)){var i=t.getLocation(e);n!==L.BOUNDARY&&(n=i)}return n},e.prototype.setLabel=function(){if(2!==arguments.length)return t.prototype.setLabel.apply(this,arguments);var e=arguments[0],n=arguments[1];null===this._label?this._label=new Me(e,n):this._label.setLocation(e,n)},e.prototype.getEdges=function(){return this._edges},e.prototype.mergeLabel=function(){if(arguments[0]instanceof e)this.mergeLabel(arguments[0]._label);else if(arguments[0]instanceof Me)for(var t=arguments[0],n=0;n<2;n++){var i=this.computeMergedLocation(t,n);this._label.getLocation(n)===L.NONE&&this._label.setLocation(n,i)}},e.prototype.add=function(t){this._edges.insert(t),t.setNode(this)},e.prototype.setLabelBoundary=function(t){if(null===this._label)return null;var e=L.NONE;null!==this._label&&(e=this._label.getLocation(t)),this._label.setLocation(t,e===L.BOUNDARY?L.INTERIOR:L.BOUNDARY)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Fe),Ve=function(){this.nodeMap=new h,this.nodeFact=null,this.nodeFact=arguments[0]};Ve.prototype.find=function(t){return this.nodeMap.get(t)},Ve.prototype.addNode=function(){if(arguments[0]instanceof w){var t=arguments[0],e=this.nodeMap.get(t);return null===e&&(e=this.nodeFact.createNode(t),this.nodeMap.put(t,e)),e}if(arguments[0]instanceof Ge){var n=arguments[0],i=this.nodeMap.get(n.getCoordinate());return null===i?(this.nodeMap.put(n.getCoordinate(),n),n):(i.mergeLabel(n),i)}},Ve.prototype.print=function(t){for(var e=this.iterator();e.hasNext();)e.next().print(t)},Ve.prototype.iterator=function(){return this.nodeMap.values().iterator()},Ve.prototype.values=function(){return this.nodeMap.values()},Ve.prototype.getBoundaryNodes=function(t){for(var e=new Nt,n=this.iterator();n.hasNext();){var i=n.next();i.getLabel().getLocation(t)===L.BOUNDARY&&e.add(i)}return e},Ve.prototype.add=function(t){var e=t.getCoordinate();this.addNode(e).add(t)},Ve.prototype.interfaces_=function(){return[]},Ve.prototype.getClass=function(){return Ve};var Be=function(){},qe={NE:{configurable:!0},NW:{configurable:!0},SW:{configurable:!0},SE:{configurable:!0}};Be.prototype.interfaces_=function(){return[]},Be.prototype.getClass=function(){return Be},Be.isNorthern=function(t){return t===Be.NE||t===Be.NW},Be.isOpposite=function(t,e){return t!==e&&2==(t-e+4)%4},Be.commonHalfPlane=function(t,e){if(t===e)return t;if(2==(t-e+4)%4)return-1;var n=t<e?t:e;return 0===n&&3===(t>e?t:e)?3:n},Be.isInHalfPlane=function(t,e){return e===Be.SE?t===Be.SE||t===Be.SW:t===e||t===e+1},Be.quadrant=function(){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1];if(0===t&&0===e)throw new m("Cannot compute the quadrant for point ( "+t+", "+e+" )");return t>=0?e>=0?Be.NE:Be.SE:e>=0?Be.NW:Be.SW}if(arguments[0]instanceof w&&arguments[1]instanceof w){var n=arguments[0],i=arguments[1];if(i.x===n.x&&i.y===n.y)throw new m("Cannot compute the quadrant for two identical points "+n);return i.x>=n.x?i.y>=n.y?Be.NE:Be.SE:i.y>=n.y?Be.NW:Be.SW}},qe.NE.get=function(){return 0},qe.NW.get=function(){return 1},qe.SW.get=function(){return 2},qe.SE.get=function(){return 3},Object.defineProperties(Be,qe);var Ue=function(){if(this._edge=null,this._label=null,this._node=null,this._p0=null,this._p1=null,this._dx=null,this._dy=null,this._quadrant=null,1===arguments.length)this._edge=arguments[0];else if(3===arguments.length){var t=arguments[1],e=arguments[2];this._edge=arguments[0],this.init(t,e),this._label=null}else if(4===arguments.length){var n=arguments[1],i=arguments[2],r=arguments[3];this._edge=arguments[0],this.init(n,i),this._label=r}};Ue.prototype.compareDirection=function(t){return this._dx===t._dx&&this._dy===t._dy?0:this._quadrant>t._quadrant?1:this._quadrant<t._quadrant?-1:at.computeOrientation(t._p0,t._p1,this._p1)},Ue.prototype.getDy=function(){return this._dy},Ue.prototype.getCoordinate=function(){return this._p0},Ue.prototype.setNode=function(t){this._node=t},Ue.prototype.print=function(t){var e=Math.atan2(this._dy,this._dx),n=this.getClass().getName(),i=n.lastIndexOf("."),r=n.substring(i+1);t.print("  "+r+": "+this._p0+" - "+this._p1+" "+this._quadrant+":"+e+"   "+this._label)},Ue.prototype.compareTo=function(t){return this.compareDirection(t)},Ue.prototype.getDirectedCoordinate=function(){return this._p1},Ue.prototype.getDx=function(){return this._dx},Ue.prototype.getLabel=function(){return this._label},Ue.prototype.getEdge=function(){return this._edge},Ue.prototype.getQuadrant=function(){return this._quadrant},Ue.prototype.getNode=function(){return this._node},Ue.prototype.toString=function(){var t=Math.atan2(this._dy,this._dx),e=this.getClass().getName(),n=e.lastIndexOf(".");return"  "+e.substring(n+1)+": "+this._p0+" - "+this._p1+" "+this._quadrant+":"+t+"   "+this._label},Ue.prototype.computeLabel=function(t){},Ue.prototype.init=function(t,e){this._p0=t,this._p1=e,this._dx=e.x-t.x,this._dy=e.y-t.y,this._quadrant=Be.quadrant(this._dx,this._dy),et.isTrue(!(0===this._dx&&0===this._dy),"EdgeEnd with identical endpoints found")},Ue.prototype.interfaces_=function(){return[I]},Ue.prototype.getClass=function(){return Ue};var ke=function(t){function e(){var e=arguments[0],n=arguments[1];if(t.call(this,e),this._isForward=null,this._isInResult=!1,this._isVisited=!1,this._sym=null,this._next=null,this._nextMin=null,this._edgeRing=null,this._minEdgeRing=null,this._depth=[0,-999,-999],this._isForward=n,n)this.init(e.getCoordinate(0),e.getCoordinate(1));else{var i=e.getNumPoints()-1;this.init(e.getCoordinate(i),e.getCoordinate(i-1))}this.computeDirectedLabel()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getNextMin=function(){return this._nextMin},e.prototype.getDepth=function(t){return this._depth[t]},e.prototype.setVisited=function(t){this._isVisited=t},e.prototype.computeDirectedLabel=function(){this._label=new Me(this._edge.getLabel()),this._isForward||this._label.flip()},e.prototype.getNext=function(){return this._next},e.prototype.setDepth=function(t,e){if(-999!==this._depth[t]&&this._depth[t]!==e)throw new Le("assigned depths do not match",this.getCoordinate());this._depth[t]=e},e.prototype.isInteriorAreaEdge=function(){for(var t=!0,e=0;e<2;e++)this._label.isArea(e)&&this._label.getLocation(e,Ce.LEFT)===L.INTERIOR&&this._label.getLocation(e,Ce.RIGHT)===L.INTERIOR||(t=!1);return t},e.prototype.setNextMin=function(t){this._nextMin=t},e.prototype.print=function(e){t.prototype.print.call(this,e),e.print(" "+this._depth[Ce.LEFT]+"/"+this._depth[Ce.RIGHT]),e.print(" ("+this.getDepthDelta()+")"),this._isInResult&&e.print(" inResult")},e.prototype.setMinEdgeRing=function(t){this._minEdgeRing=t},e.prototype.isLineEdge=function(){var t=this._label.isLine(0)||this._label.isLine(1),e=!this._label.isArea(0)||this._label.allPositionsEqual(0,L.EXTERIOR),n=!this._label.isArea(1)||this._label.allPositionsEqual(1,L.EXTERIOR);return t&&e&&n},e.prototype.setEdgeRing=function(t){this._edgeRing=t},e.prototype.getMinEdgeRing=function(){return this._minEdgeRing},e.prototype.getDepthDelta=function(){var t=this._edge.getDepthDelta();return this._isForward||(t=-t),t},e.prototype.setInResult=function(t){this._isInResult=t},e.prototype.getSym=function(){return this._sym},e.prototype.isForward=function(){return this._isForward},e.prototype.getEdge=function(){return this._edge},e.prototype.printEdge=function(t){this.print(t),t.print(" "),this._isForward?this._edge.print(t):this._edge.printReverse(t)},e.prototype.setSym=function(t){this._sym=t},e.prototype.setVisitedEdge=function(t){this.setVisited(t),this._sym.setVisited(t)},e.prototype.setEdgeDepths=function(t,e){var n=this.getEdge().getDepthDelta();this._isForward||(n=-n);var i=1;t===Ce.LEFT&&(i=-1);var r=Ce.opposite(t),o=e+n*i;this.setDepth(t,e),this.setDepth(r,o)},e.prototype.getEdgeRing=function(){return this._edgeRing},e.prototype.isInResult=function(){return this._isInResult},e.prototype.setNext=function(t){this._next=t},e.prototype.isVisited=function(){return this._isVisited},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.depthFactor=function(t,e){return t===L.EXTERIOR&&e===L.INTERIOR?1:t===L.INTERIOR&&e===L.EXTERIOR?-1:0},e}(Ue),ze=function(){};ze.prototype.createNode=function(t){return new Ge(t,null)},ze.prototype.interfaces_=function(){return[]},ze.prototype.getClass=function(){return ze};var Xe=function(){this._edges=new Nt,this._nodes=null,this._edgeEndList=new Nt,0===arguments.length?this._nodes=new Ve(new ze):1===arguments.length&&(this._nodes=new Ve(arguments[0]))};Xe.prototype.printEdges=function(t){t.println("Edges:");for(var e=0;e<this._edges.size();e++){t.println("edge "+e+":");var n=this._edges.get(e);n.print(t),n.eiList.print(t)}},Xe.prototype.find=function(t){return this._nodes.find(t)},Xe.prototype.addNode=function(){return arguments[0]instanceof Ge||arguments[0]instanceof w?this._nodes.addNode(arguments[0]):void 0},Xe.prototype.getNodeIterator=function(){return this._nodes.iterator()},Xe.prototype.linkResultDirectedEdges=function(){for(var t=this._nodes.iterator();t.hasNext();)t.next().getEdges().linkResultDirectedEdges()},Xe.prototype.debugPrintln=function(t){X.out.println(t)},Xe.prototype.isBoundaryNode=function(t,e){var n=this._nodes.find(e);if(null===n)return!1;var i=n.getLabel();return null!==i&&i.getLocation(t)===L.BOUNDARY},Xe.prototype.linkAllDirectedEdges=function(){for(var t=this._nodes.iterator();t.hasNext();)t.next().getEdges().linkAllDirectedEdges()},Xe.prototype.matchInSameDirection=function(t,e,n,i){return!!t.equals(n)&&at.computeOrientation(t,e,i)===at.COLLINEAR&&Be.quadrant(t,e)===Be.quadrant(n,i)},Xe.prototype.getEdgeEnds=function(){return this._edgeEndList},Xe.prototype.debugPrint=function(t){X.out.print(t)},Xe.prototype.getEdgeIterator=function(){return this._edges.iterator()},Xe.prototype.findEdgeInSameDirection=function(t,e){for(var n=0;n<this._edges.size();n++){var i=this._edges.get(n),r=i.getCoordinates();if(this.matchInSameDirection(t,e,r[0],r[1]))return i;if(this.matchInSameDirection(t,e,r[r.length-1],r[r.length-2]))return i}return null},Xe.prototype.insertEdge=function(t){this._edges.add(t)},Xe.prototype.findEdgeEnd=function(t){for(var e=this.getEdgeEnds().iterator();e.hasNext();){var n=e.next();if(n.getEdge()===t)return n}return null},Xe.prototype.addEdges=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();this._edges.add(n);var i=new ke(n,!0),r=new ke(n,!1);i.setSym(r),r.setSym(i),this.add(i),this.add(r)}},Xe.prototype.add=function(t){this._nodes.add(t),this._edgeEndList.add(t)},Xe.prototype.getNodes=function(){return this._nodes.values()},Xe.prototype.findEdge=function(t,e){for(var n=0;n<this._edges.size();n++){var i=this._edges.get(n),r=i.getCoordinates();if(t.equals(r[0])&&e.equals(r[1]))return i}return null},Xe.prototype.interfaces_=function(){return[]},Xe.prototype.getClass=function(){return Xe},Xe.linkResultDirectedEdges=function(t){for(var e=t.iterator();e.hasNext();)e.next().getEdges().linkResultDirectedEdges()};var Ye=function(){this._geometryFactory=null,this._shellList=new Nt,this._geometryFactory=arguments[0]};Ye.prototype.sortShellsAndHoles=function(t,e,n){for(var i=t.iterator();i.hasNext();){var r=i.next();r.isHole()?n.add(r):e.add(r)}},Ye.prototype.computePolygons=function(t){for(var e=new Nt,n=t.iterator();n.hasNext();){var i=n.next().toPolygon(this._geometryFactory);e.add(i)}return e},Ye.prototype.placeFreeHoles=function(t,e){for(var n=e.iterator();n.hasNext();){var i=n.next();if(null===i.getShell()){var r=this.findEdgeRingContaining(i,t);if(null===r)throw new Le("unable to assign hole to a shell",i.getCoordinate(0));i.setShell(r)}}},Ye.prototype.buildMinimalEdgeRings=function(t,e,n){for(var i=new Nt,r=t.iterator();r.hasNext();){var o=r.next();if(o.getMaxNodeDegree()>2){o.linkDirectedEdgesForMinimalEdgeRings();var s=o.buildMinimalRings(),a=this.findShell(s);null!==a?(this.placePolygonHoles(a,s),e.add(a)):n.addAll(s)}else i.add(o)}return i},Ye.prototype.containsPoint=function(t){for(var e=this._shellList.iterator();e.hasNext();)if(e.next().containsPoint(t))return!0;return!1},Ye.prototype.buildMaximalEdgeRings=function(t){for(var e=new Nt,n=t.iterator();n.hasNext();){var i=n.next();if(i.isInResult()&&i.getLabel().isArea()&&null===i.getEdgeRing()){var r=new Ae(i,this._geometryFactory);e.add(r),r.setInResult()}}return e},Ye.prototype.placePolygonHoles=function(t,e){for(var n=e.iterator();n.hasNext();){var i=n.next();i.isHole()&&i.setShell(t)}},Ye.prototype.getPolygons=function(){return this.computePolygons(this._shellList)},Ye.prototype.findEdgeRingContaining=function(t,e){for(var n=t.getLinearRing(),i=n.getEnvelopeInternal(),r=n.getCoordinateN(0),o=null,s=null,a=e.iterator();a.hasNext();){var u=a.next(),l=u.getLinearRing(),c=l.getEnvelopeInternal();null!==o&&(s=o.getLinearRing().getEnvelopeInternal());var h=!1;c.contains(i)&&at.isPointInRing(r,l.getCoordinates())&&(h=!0),h&&(null===o||s.contains(c))&&(o=u)}return o},Ye.prototype.findShell=function(t){for(var e=0,n=null,i=t.iterator();i.hasNext();){var r=i.next();r.isHole()||(n=r,e++)}return et.isTrue(e<=1,"found two shells in MinimalEdgeRing list"),n},Ye.prototype.add=function(){if(1===arguments.length){var t=arguments[0];this.add(t.getEdgeEnds(),t.getNodes())}else if(2===arguments.length){var e=arguments[0];Xe.linkResultDirectedEdges(arguments[1]);var n=this.buildMaximalEdgeRings(e),i=new Nt,r=this.buildMinimalEdgeRings(n,this._shellList,i);this.sortShellsAndHoles(r,this._shellList,i),this.placeFreeHoles(this._shellList,i)}},Ye.prototype.interfaces_=function(){return[]},Ye.prototype.getClass=function(){return Ye};var je=function(){};je.prototype.getBounds=function(){},je.prototype.interfaces_=function(){return[]},je.prototype.getClass=function(){return je};var He=function(){this._bounds=null,this._item=null;var t=arguments[1];this._bounds=arguments[0],this._item=t};He.prototype.getItem=function(){return this._item},He.prototype.getBounds=function(){return this._bounds},He.prototype.interfaces_=function(){return[je,e]},He.prototype.getClass=function(){return He};var We=function(){this._size=null,this._items=null,this._size=0,this._items=new Nt,this._items.add(null)};We.prototype.poll=function(){if(this.isEmpty())return null;var t=this._items.get(1);return this._items.set(1,this._items.get(this._size)),this._size-=1,this.reorder(1),t},We.prototype.size=function(){return this._size},We.prototype.reorder=function(t){for(var e=null,n=this._items.get(t);2*t<=this._size&&((e=2*t)!==this._size&&this._items.get(e+1).compareTo(this._items.get(e))<0&&e++,this._items.get(e).compareTo(n)<0);t=e)this._items.set(t,this._items.get(e));this._items.set(t,n)},We.prototype.clear=function(){this._size=0,this._items.clear()},We.prototype.isEmpty=function(){return 0===this._size},We.prototype.add=function(t){this._items.add(null),this._size+=1;var e=this._size;for(this._items.set(0,t);t.compareTo(this._items.get(Math.trunc(e/2)))<0;e/=2)this._items.set(e,this._items.get(Math.trunc(e/2)));this._items.set(e,t)},We.prototype.interfaces_=function(){return[]},We.prototype.getClass=function(){return We};var Je=function(){};Je.prototype.visitItem=function(t){},Je.prototype.interfaces_=function(){return[]},Je.prototype.getClass=function(){return Je};var Ke=function(){};Ke.prototype.insert=function(t,e){},Ke.prototype.remove=function(t,e){},Ke.prototype.query=function(){},Ke.prototype.interfaces_=function(){return[]},Ke.prototype.getClass=function(){return Ke};var Qe=function(){this._childBoundables=new Nt,this._bounds=null,this._level=null,0===arguments.length||1===arguments.length&&(this._level=arguments[0])},$e={serialVersionUID:{configurable:!0}};Qe.prototype.getLevel=function(){return this._level},Qe.prototype.size=function(){return this._childBoundables.size()},Qe.prototype.getChildBoundables=function(){return this._childBoundables},Qe.prototype.addChildBoundable=function(t){et.isTrue(null===this._bounds),this._childBoundables.add(t)},Qe.prototype.isEmpty=function(){return this._childBoundables.isEmpty()},Qe.prototype.getBounds=function(){return null===this._bounds&&(this._bounds=this.computeBounds()),this._bounds},Qe.prototype.interfaces_=function(){return[je,e]},Qe.prototype.getClass=function(){return Qe},$e.serialVersionUID.get=function(){return 0x5a1e55ec41369800},Object.defineProperties(Qe,$e);var Ze=function(){};Ze.reverseOrder=function(){return{compare:function(t,e){return e.compareTo(t)}}},Ze.min=function(t){return Ze.sort(t),t.get(0)},Ze.sort=function(t,e){var n=t.toArray();e?Gt.sort(n,e):Gt.sort(n);for(var i=t.iterator(),r=0,o=n.length;r<o;r++)i.next(),i.set(n[r])},Ze.singletonList=function(t){var e=new Nt;return e.add(t),e};var tn=function(){this._boundable1=null,this._boundable2=null,this._distance=null,this._itemDistance=null;var t=arguments[1],e=arguments[2];this._boundable1=arguments[0],this._boundable2=t,this._itemDistance=e,this._distance=this.distance()};tn.prototype.expandToQueue=function(t,e){var n=tn.isComposite(this._boundable1),i=tn.isComposite(this._boundable2);if(n&&i)return tn.area(this._boundable1)>tn.area(this._boundable2)?(this.expand(this._boundable1,this._boundable2,t,e),null):(this.expand(this._boundable2,this._boundable1,t,e),null);if(n)return this.expand(this._boundable1,this._boundable2,t,e),null;if(i)return this.expand(this._boundable2,this._boundable1,t,e),null;throw new m("neither boundable is composite")},tn.prototype.isLeaves=function(){return!(tn.isComposite(this._boundable1)||tn.isComposite(this._boundable2))},tn.prototype.compareTo=function(t){return this._distance<t._distance?-1:this._distance>t._distance?1:0},tn.prototype.expand=function(t,e,n,i){for(var r=t.getChildBoundables().iterator();r.hasNext();){var o=r.next(),s=new tn(o,e,this._itemDistance);s.getDistance()<i&&n.add(s)}},tn.prototype.getBoundable=function(t){return 0===t?this._boundable1:this._boundable2},tn.prototype.getDistance=function(){return this._distance},tn.prototype.distance=function(){return this.isLeaves()?this._itemDistance.distance(this._boundable1,this._boundable2):this._boundable1.getBounds().distance(this._boundable2.getBounds())},tn.prototype.interfaces_=function(){return[I]},tn.prototype.getClass=function(){return tn},tn.area=function(t){return t.getBounds().getArea()},tn.isComposite=function(t){return t instanceof Qe};var en=function t(){if(this._root=null,this._built=!1,this._itemBoundables=new Nt,this._nodeCapacity=null,0===arguments.length)this._nodeCapacity=t.DEFAULT_NODE_CAPACITY;else if(1===arguments.length){var e=arguments[0];et.isTrue(e>1,"Node capacity must be greater than 1"),this._nodeCapacity=e}},nn={IntersectsOp:{configurable:!0},serialVersionUID:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};en.prototype.getNodeCapacity=function(){return this._nodeCapacity},en.prototype.lastNode=function(t){return t.get(t.size()-1)},en.prototype.size=function(){if(0===arguments.length)return this.isEmpty()?0:(this.build(),this.size(this._root));if(1===arguments.length){for(var t=0,e=arguments[0].getChildBoundables().iterator();e.hasNext();){var n=e.next();n instanceof Qe?t+=this.size(n):n instanceof He&&(t+=1)}return t}},en.prototype.removeItem=function(t,e){for(var n=null,i=t.getChildBoundables().iterator();i.hasNext();){var r=i.next();r instanceof He&&r.getItem()===e&&(n=r)}return null!==n&&(t.getChildBoundables().remove(n),!0)},en.prototype.itemsTree=function(){if(0===arguments.length){this.build();var t=this.itemsTree(this._root);return null===t?new Nt:t}if(1===arguments.length){for(var e=arguments[0],n=new Nt,i=e.getChildBoundables().iterator();i.hasNext();){var r=i.next();if(r instanceof Qe){var o=this.itemsTree(r);null!==o&&n.add(o)}else r instanceof He?n.add(r.getItem()):et.shouldNeverReachHere()}return n.size()<=0?null:n}},en.prototype.insert=function(t,e){et.isTrue(!this._built,"Cannot insert items into an STR packed R-tree after it has been built."),this._itemBoundables.add(new He(t,e))},en.prototype.boundablesAtLevel=function(){if(1===arguments.length){var t=arguments[0],e=new Nt;return this.boundablesAtLevel(t,this._root,e),e}if(3===arguments.length){var n=arguments[0],i=arguments[1],r=arguments[2];if(et.isTrue(n>-2),i.getLevel()===n)return r.add(i),null;for(var o=i.getChildBoundables().iterator();o.hasNext();){var s=o.next();s instanceof Qe?this.boundablesAtLevel(n,s,r):(et.isTrue(s instanceof He),-1===n&&r.add(s))}return null}},en.prototype.query=function(){if(1===arguments.length){var t=arguments[0];this.build();var e=new Nt;return this.isEmpty()||this.getIntersectsOp().intersects(this._root.getBounds(),t)&&this.query(t,this._root,e),e}if(2===arguments.length){var n=arguments[0],i=arguments[1];if(this.build(),this.isEmpty())return null;this.getIntersectsOp().intersects(this._root.getBounds(),n)&&this.query(n,this._root,i)}else if(3===arguments.length)if(P(arguments[2],Je)&&arguments[0]instanceof Object&&arguments[1]instanceof Qe)for(var r=arguments[0],o=arguments[2],s=arguments[1].getChildBoundables(),a=0;a<s.size();a++){var u=s.get(a);this.getIntersectsOp().intersects(u.getBounds(),r)&&(u instanceof Qe?this.query(r,u,o):u instanceof He?o.visitItem(u.getItem()):et.shouldNeverReachHere())}else if(P(arguments[2],Et)&&arguments[0]instanceof Object&&arguments[1]instanceof Qe)for(var l=arguments[0],c=arguments[2],h=arguments[1].getChildBoundables(),p=0;p<h.size();p++){var f=h.get(p);this.getIntersectsOp().intersects(f.getBounds(),l)&&(f instanceof Qe?this.query(l,f,c):f instanceof He?c.add(f.getItem()):et.shouldNeverReachHere())}},en.prototype.build=function(){if(this._built)return null;this._root=this._itemBoundables.isEmpty()?this.createNode(0):this.createHigherLevels(this._itemBoundables,-1),this._itemBoundables=null,this._built=!0},en.prototype.getRoot=function(){return this.build(),this._root},en.prototype.remove=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];return this.build(),!!this.getIntersectsOp().intersects(this._root.getBounds(),t)&&this.remove(t,this._root,e)}if(3===arguments.length){var n=arguments[0],i=arguments[1],r=arguments[2],o=this.removeItem(i,r);if(o)return!0;for(var s=null,a=i.getChildBoundables().iterator();a.hasNext();){var u=a.next();if(this.getIntersectsOp().intersects(u.getBounds(),n)&&u instanceof Qe&&(o=this.remove(n,u,r))){s=u;break}}return null!==s&&s.getChildBoundables().isEmpty()&&i.getChildBoundables().remove(s),o}},en.prototype.createHigherLevels=function(t,e){et.isTrue(!t.isEmpty());var n=this.createParentBoundables(t,e+1);return 1===n.size()?n.get(0):this.createHigherLevels(n,e+1)},en.prototype.depth=function(){if(0===arguments.length)return this.isEmpty()?0:(this.build(),this.depth(this._root));if(1===arguments.length){for(var t=0,e=arguments[0].getChildBoundables().iterator();e.hasNext();){var n=e.next();if(n instanceof Qe){var i=this.depth(n);i>t&&(t=i)}}return t+1}},en.prototype.createParentBoundables=function(t,e){et.isTrue(!t.isEmpty());var n=new Nt;n.add(this.createNode(e));var i=new Nt(t);Ze.sort(i,this.getComparator());for(var r=i.iterator();r.hasNext();){var o=r.next();this.lastNode(n).getChildBoundables().size()===this.getNodeCapacity()&&n.add(this.createNode(e)),this.lastNode(n).addChildBoundable(o)}return n},en.prototype.isEmpty=function(){return this._built?this._root.isEmpty():this._itemBoundables.isEmpty()},en.prototype.interfaces_=function(){return[e]},en.prototype.getClass=function(){return en},en.compareDoubles=function(t,e){return t>e?1:t<e?-1:0},nn.IntersectsOp.get=function(){return rn},nn.serialVersionUID.get=function(){return-0x35ef64c82d4c5400},nn.DEFAULT_NODE_CAPACITY.get=function(){return 10},Object.defineProperties(en,nn);var rn=function(){},on=function(){};on.prototype.distance=function(t,e){},on.prototype.interfaces_=function(){return[]},on.prototype.getClass=function(){return on};var sn=function(t){function n(e){t.call(this,e=e||n.DEFAULT_NODE_CAPACITY)}t&&(n.__proto__=t),(n.prototype=Object.create(t&&t.prototype)).constructor=n;var i={STRtreeNode:{configurable:!0},serialVersionUID:{configurable:!0},xComparator:{configurable:!0},yComparator:{configurable:!0},intersectsOp:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};return n.prototype.createParentBoundablesFromVerticalSlices=function(t,e){et.isTrue(t.length>0);for(var n=new Nt,i=0;i<t.length;i++)n.addAll(this.createParentBoundablesFromVerticalSlice(t[i],e));return n},n.prototype.createNode=function(t){return new an(t)},n.prototype.size=function(){return 0===arguments.length?t.prototype.size.call(this):t.prototype.size.apply(this,arguments)},n.prototype.insert=function(){if(2!==arguments.length)return t.prototype.insert.apply(this,arguments);var e=arguments[0],n=arguments[1];if(e.isNull())return null;t.prototype.insert.call(this,e,n)},n.prototype.getIntersectsOp=function(){return n.intersectsOp},n.prototype.verticalSlices=function(t,e){for(var n=Math.trunc(Math.ceil(t.size()/e)),i=new Array(e).fill(null),r=t.iterator(),o=0;o<e;o++){i[o]=new Nt;for(var s=0;r.hasNext()&&s<n;){var a=r.next();i[o].add(a),s++}}return i},n.prototype.query=function(){if(1===arguments.length)return t.prototype.query.call(this,arguments[0]);2===arguments.length?t.prototype.query.call(this,arguments[0],arguments[1]):3===arguments.length&&(P(arguments[2],Je)&&arguments[0]instanceof Object&&arguments[1]instanceof Qe||P(arguments[2],Et)&&arguments[0]instanceof Object&&arguments[1]instanceof Qe)&&t.prototype.query.call(this,arguments[0],arguments[1],arguments[2])},n.prototype.getComparator=function(){return n.yComparator},n.prototype.createParentBoundablesFromVerticalSlice=function(e,n){return t.prototype.createParentBoundables.call(this,e,n)},n.prototype.remove=function(){return 2===arguments.length?t.prototype.remove.call(this,arguments[0],arguments[1]):t.prototype.remove.apply(this,arguments)},n.prototype.depth=function(){return 0===arguments.length?t.prototype.depth.call(this):t.prototype.depth.apply(this,arguments)},n.prototype.createParentBoundables=function(t,e){et.isTrue(!t.isEmpty());var i=Math.trunc(Math.ceil(t.size()/this.getNodeCapacity())),r=new Nt(t);Ze.sort(r,n.xComparator);var o=this.verticalSlices(r,Math.trunc(Math.ceil(Math.sqrt(i))));return this.createParentBoundablesFromVerticalSlices(o,e)},n.prototype.nearestNeighbour=function(){if(1===arguments.length){if(P(arguments[0],on)){var t=arguments[0],e=new tn(this.getRoot(),this.getRoot(),t);return this.nearestNeighbour(e)}if(arguments[0]instanceof tn)return this.nearestNeighbour(arguments[0],v.POSITIVE_INFINITY)}else if(2===arguments.length){if(arguments[0]instanceof n&&P(arguments[1],on)){var i=arguments[0],r=arguments[1],o=new tn(this.getRoot(),i.getRoot(),r);return this.nearestNeighbour(o)}if(arguments[0]instanceof tn&&"number"==typeof arguments[1]){var s=arguments[0],a=arguments[1],u=null,l=new We;for(l.add(s);!l.isEmpty()&&a>0;){var c=l.poll(),h=c.getDistance();if(h>=a)break;c.isLeaves()?(a=h,u=c):c.expandToQueue(l,a)}return[u.getBoundable(0).getItem(),u.getBoundable(1).getItem()]}}else if(3===arguments.length){var p=arguments[2],f=new He(arguments[0],arguments[1]),g=new tn(this.getRoot(),f,p);return this.nearestNeighbour(g)[0]}},n.prototype.interfaces_=function(){return[Ke,e]},n.prototype.getClass=function(){return n},n.centreX=function(t){return n.avg(t.getMinX(),t.getMaxX())},n.avg=function(t,e){return(t+e)/2},n.centreY=function(t){return n.avg(t.getMinY(),t.getMaxY())},i.STRtreeNode.get=function(){return an},i.serialVersionUID.get=function(){return 0x39920f7d5f261e0},i.xComparator.get=function(){return{interfaces_:function(){return[N]},compare:function(e,i){return t.compareDoubles(n.centreX(e.getBounds()),n.centreX(i.getBounds()))}}},i.yComparator.get=function(){return{interfaces_:function(){return[N]},compare:function(e,i){return t.compareDoubles(n.centreY(e.getBounds()),n.centreY(i.getBounds()))}}},i.intersectsOp.get=function(){return{interfaces_:function(){return[t.IntersectsOp]},intersects:function(t,e){return t.intersects(e)}}},i.DEFAULT_NODE_CAPACITY.get=function(){return 10},Object.defineProperties(n,i),n}(en),an=function(t){function e(){t.call(this,arguments[0])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.computeBounds=function(){for(var t=null,e=this.getChildBoundables().iterator();e.hasNext();){var n=e.next();null===t?t=new j(n.getBounds()):t.expandToInclude(n.getBounds())}return t},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Qe),un=function(){};un.prototype.interfaces_=function(){return[]},un.prototype.getClass=function(){return un},un.relativeSign=function(t,e){return t<e?-1:t>e?1:0},un.compare=function(t,e,n){if(e.equals2D(n))return 0;var i=un.relativeSign(e.x,n.x),r=un.relativeSign(e.y,n.y);switch(t){case 0:return un.compareValue(i,r);case 1:return un.compareValue(r,i);case 2:return un.compareValue(r,-i);case 3:return un.compareValue(-i,r);case 4:return un.compareValue(-i,-r);case 5:return un.compareValue(-r,-i);case 6:return un.compareValue(-r,i);case 7:return un.compareValue(i,-r)}return et.shouldNeverReachHere("invalid octant value"),0},un.compareValue=function(t,e){return t<0?-1:t>0?1:e<0?-1:e>0?1:0};var ln=function(){this._segString=null,this.coord=null,this.segmentIndex=null,this._segmentOctant=null,this._isInterior=null;var t=arguments[0],e=arguments[1],n=arguments[2],i=arguments[3];this._segString=t,this.coord=new w(e),this.segmentIndex=n,this._segmentOctant=i,this._isInterior=!e.equals2D(t.getCoordinate(n))};ln.prototype.getCoordinate=function(){return this.coord},ln.prototype.print=function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex)},ln.prototype.compareTo=function(t){var e=t;return this.segmentIndex<e.segmentIndex?-1:this.segmentIndex>e.segmentIndex?1:this.coord.equals2D(e.coord)?0:un.compare(this._segmentOctant,this.coord,e.coord)},ln.prototype.isEndPoint=function(t){return 0===this.segmentIndex&&!this._isInterior||this.segmentIndex===t},ln.prototype.isInterior=function(){return this._isInterior},ln.prototype.interfaces_=function(){return[I]},ln.prototype.getClass=function(){return ln};var cn=function(){this._nodeMap=new h,this._edge=null,this._edge=arguments[0]};cn.prototype.getSplitCoordinates=function(){var t=new Ct;this.addEndpoints();for(var e=this.iterator(),n=e.next();e.hasNext();){var i=e.next();this.addEdgeCoordinates(n,i,t),n=i}return t.toCoordinateArray()},cn.prototype.addCollapsedNodes=function(){var t=new Nt;this.findCollapsesFromInsertedNodes(t),this.findCollapsesFromExistingVertices(t);for(var e=t.iterator();e.hasNext();){var n=e.next().intValue();this.add(this._edge.getCoordinate(n),n)}},cn.prototype.print=function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();)e.next().print(t)},cn.prototype.findCollapsesFromExistingVertices=function(t){for(var e=0;e<this._edge.size()-2;e++){var n=this._edge.getCoordinate(e),i=this._edge.getCoordinate(e+2);n.equals2D(i)&&t.add(new D(e+1))}},cn.prototype.addEdgeCoordinates=function(t,e,n){var i=this._edge.getCoordinate(e.segmentIndex),r=e.isInterior()||!e.coord.equals2D(i);n.add(new w(t.coord),!1);for(var o=t.segmentIndex+1;o<=e.segmentIndex;o++)n.add(this._edge.getCoordinate(o));r&&n.add(new w(e.coord))},cn.prototype.iterator=function(){return this._nodeMap.values().iterator()},cn.prototype.addSplitEdges=function(t){this.addEndpoints(),this.addCollapsedNodes();for(var e=this.iterator(),n=e.next();e.hasNext();){var i=e.next(),r=this.createSplitEdge(n,i);t.add(r),n=i}},cn.prototype.findCollapseIndex=function(t,e,n){if(!t.coord.equals2D(e.coord))return!1;var i=e.segmentIndex-t.segmentIndex;return e.isInterior()||i--,1===i&&(n[0]=t.segmentIndex+1,!0)},cn.prototype.findCollapsesFromInsertedNodes=function(t){for(var e=new Array(1).fill(null),n=this.iterator(),i=n.next();n.hasNext();){var r=n.next();this.findCollapseIndex(i,r,e)&&t.add(new D(e[0])),i=r}},cn.prototype.getEdge=function(){return this._edge},cn.prototype.addEndpoints=function(){var t=this._edge.size()-1;this.add(this._edge.getCoordinate(0),0),this.add(this._edge.getCoordinate(t),t)},cn.prototype.createSplitEdge=function(t,e){var n=e.segmentIndex-t.segmentIndex+2,i=this._edge.getCoordinate(e.segmentIndex),r=e.isInterior()||!e.coord.equals2D(i);r||n--;var o=new Array(n).fill(null),s=0;o[s++]=new w(t.coord);for(var a=t.segmentIndex+1;a<=e.segmentIndex;a++)o[s++]=this._edge.getCoordinate(a);return r&&(o[s]=new w(e.coord)),new gn(o,this._edge.getData())},cn.prototype.add=function(t,e){var n=new ln(this._edge,t,e,this._edge.getSegmentOctant(e)),i=this._nodeMap.get(n);return null!==i?(et.isTrue(i.coord.equals2D(t),"Found equal nodes with different coordinates"),i):(this._nodeMap.put(n,n),n)},cn.prototype.checkSplitEdgesCorrectness=function(t){var e=this._edge.getCoordinates(),n=t.get(0).getCoordinate(0);if(!n.equals2D(e[0]))throw new Z("bad split edge start point at "+n);var i=t.get(t.size()-1).getCoordinates(),r=i[i.length-1];if(!r.equals2D(e[e.length-1]))throw new Z("bad split edge end point at "+r)},cn.prototype.interfaces_=function(){return[]},cn.prototype.getClass=function(){return cn};var hn=function(){};hn.prototype.interfaces_=function(){return[]},hn.prototype.getClass=function(){return hn},hn.octant=function(){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1];if(0===t&&0===e)throw new m("Cannot compute the octant for point ( "+t+", "+e+" )");var n=Math.abs(t),i=Math.abs(e);return t>=0?e>=0?n>=i?0:1:n>=i?7:6:e>=0?n>=i?3:2:n>=i?4:5}if(arguments[0]instanceof w&&arguments[1]instanceof w){var r=arguments[0],o=arguments[1],s=o.x-r.x,a=o.y-r.y;if(0===s&&0===a)throw new m("Cannot compute the octant for two identical points "+r);return hn.octant(s,a)}};var pn=function(){};pn.prototype.getCoordinates=function(){},pn.prototype.size=function(){},pn.prototype.getCoordinate=function(t){},pn.prototype.isClosed=function(){},pn.prototype.setData=function(t){},pn.prototype.getData=function(){},pn.prototype.interfaces_=function(){return[]},pn.prototype.getClass=function(){return pn};var fn=function(){};fn.prototype.addIntersection=function(t,e){},fn.prototype.interfaces_=function(){return[pn]},fn.prototype.getClass=function(){return fn};var gn=function(){this._nodeList=new cn(this),this._pts=null,this._data=null;var t=arguments[1];this._pts=arguments[0],this._data=t};gn.prototype.getCoordinates=function(){return this._pts},gn.prototype.size=function(){return this._pts.length},gn.prototype.getCoordinate=function(t){return this._pts[t]},gn.prototype.isClosed=function(){return this._pts[0].equals(this._pts[this._pts.length-1])},gn.prototype.getSegmentOctant=function(t){return t===this._pts.length-1?-1:this.safeOctant(this.getCoordinate(t),this.getCoordinate(t+1))},gn.prototype.setData=function(t){this._data=t},gn.prototype.safeOctant=function(t,e){return t.equals2D(e)?0:hn.octant(t,e)},gn.prototype.getData=function(){return this._data},gn.prototype.addIntersection=function(){if(2===arguments.length)this.addIntersectionNode(arguments[0],arguments[1]);else if(4===arguments.length){var t=arguments[1],e=new w(arguments[0].getIntersection(arguments[3]));this.addIntersection(e,t)}},gn.prototype.toString=function(){return $.toLineString(new ue(this._pts))},gn.prototype.getNodeList=function(){return this._nodeList},gn.prototype.addIntersectionNode=function(t,e){var n=e,i=n+1;return i<this._pts.length&&t.equals2D(this._pts[i])&&(n=i),this._nodeList.add(t,n)},gn.prototype.addIntersections=function(t,e,n){for(var i=0;i<t.getIntersectionNum();i++)this.addIntersection(t,e,n,i)},gn.prototype.interfaces_=function(){return[fn]},gn.prototype.getClass=function(){return gn},gn.getNodedSubstrings=function(){if(1===arguments.length){var t=arguments[0],e=new Nt;return gn.getNodedSubstrings(t,e),e}if(2===arguments.length)for(var n=arguments[1],i=arguments[0].iterator();i.hasNext();)i.next().getNodeList().addSplitEdges(n)};var dn=function(){if(this.p0=null,this.p1=null,0===arguments.length)this.p0=new w,this.p1=new w;else if(1===arguments.length){var t=arguments[0];this.p0=new w(t.p0),this.p1=new w(t.p1)}else if(2===arguments.length)this.p0=arguments[0],this.p1=arguments[1];else if(4===arguments.length){var e=arguments[2],n=arguments[3];this.p0=new w(arguments[0],arguments[1]),this.p1=new w(e,n)}},yn={serialVersionUID:{configurable:!0}};dn.prototype.minX=function(){return Math.min(this.p0.x,this.p1.x)},dn.prototype.orientationIndex=function(){if(arguments[0]instanceof dn){var t=arguments[0],e=at.orientationIndex(this.p0,this.p1,t.p0),n=at.orientationIndex(this.p0,this.p1,t.p1);return e>=0&&n>=0||e<=0&&n<=0?Math.max(e,n):0}if(arguments[0]instanceof w)return at.orientationIndex(this.p0,this.p1,arguments[0])},dn.prototype.toGeometry=function(t){return t.createLineString([this.p0,this.p1])},dn.prototype.isVertical=function(){return this.p0.x===this.p1.x},dn.prototype.equals=function(t){if(!(t instanceof dn))return!1;var e=t;return this.p0.equals(e.p0)&&this.p1.equals(e.p1)},dn.prototype.intersection=function(t){var e=new rt;return e.computeIntersection(this.p0,this.p1,t.p0,t.p1),e.hasIntersection()?e.getIntersection(0):null},dn.prototype.project=function(){if(arguments[0]instanceof w){var t=arguments[0];if(t.equals(this.p0)||t.equals(this.p1))return new w(t);var e=this.projectionFactor(t),n=new w;return n.x=this.p0.x+e*(this.p1.x-this.p0.x),n.y=this.p0.y+e*(this.p1.y-this.p0.y),n}if(arguments[0]instanceof dn){var i=arguments[0],r=this.projectionFactor(i.p0),o=this.projectionFactor(i.p1);if(r>=1&&o>=1)return null;if(r<=0&&o<=0)return null;var s=this.project(i.p0);r<0&&(s=this.p0),r>1&&(s=this.p1);var a=this.project(i.p1);return o<0&&(a=this.p0),o>1&&(a=this.p1),new dn(s,a)}},dn.prototype.normalize=function(){this.p1.compareTo(this.p0)<0&&this.reverse()},dn.prototype.angle=function(){return Math.atan2(this.p1.y-this.p0.y,this.p1.x-this.p0.x)},dn.prototype.getCoordinate=function(t){return 0===t?this.p0:this.p1},dn.prototype.distancePerpendicular=function(t){return at.distancePointLinePerpendicular(t,this.p0,this.p1)},dn.prototype.minY=function(){return Math.min(this.p0.y,this.p1.y)},dn.prototype.midPoint=function(){return dn.midPoint(this.p0,this.p1)},dn.prototype.projectionFactor=function(t){if(t.equals(this.p0))return 0;if(t.equals(this.p1))return 1;var e=this.p1.x-this.p0.x,n=this.p1.y-this.p0.y,i=e*e+n*n;return i<=0?v.NaN:((t.x-this.p0.x)*e+(t.y-this.p0.y)*n)/i},dn.prototype.closestPoints=function(t){var e=this.intersection(t);if(null!==e)return[e,e];var n=new Array(2).fill(null),i=v.MAX_VALUE,r=null,o=this.closestPoint(t.p0);i=o.distance(t.p0),n[0]=o,n[1]=t.p0;var s=this.closestPoint(t.p1);(r=s.distance(t.p1))<i&&(i=r,n[0]=s,n[1]=t.p1);var a=t.closestPoint(this.p0);(r=a.distance(this.p0))<i&&(i=r,n[0]=this.p0,n[1]=a);var u=t.closestPoint(this.p1);return(r=u.distance(this.p1))<i&&(i=r,n[0]=this.p1,n[1]=u),n},dn.prototype.closestPoint=function(t){var e=this.projectionFactor(t);return e>0&&e<1?this.project(t):this.p0.distance(t)<this.p1.distance(t)?this.p0:this.p1},dn.prototype.maxX=function(){return Math.max(this.p0.x,this.p1.x)},dn.prototype.getLength=function(){return this.p0.distance(this.p1)},dn.prototype.compareTo=function(t){var e=t,n=this.p0.compareTo(e.p0);return 0!==n?n:this.p1.compareTo(e.p1)},dn.prototype.reverse=function(){var t=this.p0;this.p0=this.p1,this.p1=t},dn.prototype.equalsTopo=function(t){return this.p0.equals(t.p0)&&(this.p1.equals(t.p1)||this.p0.equals(t.p1))&&this.p1.equals(t.p0)},dn.prototype.lineIntersection=function(t){try{return Y.intersection(this.p0,this.p1,t.p0,t.p1)}catch(t){if(!(t instanceof z))throw t}return null},dn.prototype.maxY=function(){return Math.max(this.p0.y,this.p1.y)},dn.prototype.pointAlongOffset=function(t,e){var n=this.p0.x+t*(this.p1.x-this.p0.x),i=this.p0.y+t*(this.p1.y-this.p0.y),r=this.p1.x-this.p0.x,o=this.p1.y-this.p0.y,s=Math.sqrt(r*r+o*o),a=0,u=0;if(0!==e){if(s<=0)throw new Error("Cannot compute offset from zero-length line segment");a=e*r/s,u=e*o/s}return new w(n-u,i+a)},dn.prototype.setCoordinates=function(){if(1===arguments.length){var t=arguments[0];this.setCoordinates(t.p0,t.p1)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.p0.x=e.x,this.p0.y=e.y,this.p1.x=n.x,this.p1.y=n.y}},dn.prototype.segmentFraction=function(t){var e=this.projectionFactor(t);return e<0?e=0:(e>1||v.isNaN(e))&&(e=1),e},dn.prototype.toString=function(){return"LINESTRING( "+this.p0.x+" "+this.p0.y+", "+this.p1.x+" "+this.p1.y+")"},dn.prototype.isHorizontal=function(){return this.p0.y===this.p1.y},dn.prototype.distance=function(){if(arguments[0]instanceof dn){var t=arguments[0];return at.distanceLineLine(this.p0,this.p1,t.p0,t.p1)}if(arguments[0]instanceof w)return at.distancePointLine(arguments[0],this.p0,this.p1)},dn.prototype.pointAlong=function(t){var e=new w;return e.x=this.p0.x+t*(this.p1.x-this.p0.x),e.y=this.p0.y+t*(this.p1.y-this.p0.y),e},dn.prototype.hashCode=function(){var t=v.doubleToLongBits(this.p0.x);t^=31*v.doubleToLongBits(this.p0.y);var e=Math.trunc(t)^Math.trunc(t>>32),n=v.doubleToLongBits(this.p1.x);return n^=31*v.doubleToLongBits(this.p1.y),e^Math.trunc(n)^Math.trunc(n>>32)},dn.prototype.interfaces_=function(){return[I,e]},dn.prototype.getClass=function(){return dn},dn.midPoint=function(t,e){return new w((t.x+e.x)/2,(t.y+e.y)/2)},yn.serialVersionUID.get=function(){return 0x2d2172135f411c00},Object.defineProperties(dn,yn);var _n=function(){this.tempEnv1=new j,this.tempEnv2=new j,this._overlapSeg1=new dn,this._overlapSeg2=new dn};_n.prototype.overlap=function(){if(2===arguments.length);else if(4===arguments.length){var t=arguments[2],e=arguments[3];arguments[0].getLineSegment(arguments[1],this._overlapSeg1),t.getLineSegment(e,this._overlapSeg2),this.overlap(this._overlapSeg1,this._overlapSeg2)}},_n.prototype.interfaces_=function(){return[]},_n.prototype.getClass=function(){return _n};var mn=function(){this._pts=null,this._start=null,this._end=null,this._env=null,this._context=null,this._id=null;var t=arguments[1],e=arguments[2],n=arguments[3];this._pts=arguments[0],this._start=t,this._end=e,this._context=n};mn.prototype.getLineSegment=function(t,e){e.p0=this._pts[t],e.p1=this._pts[t+1]},mn.prototype.computeSelect=function(t,e,n,i){if(i.tempEnv1.init(this._pts[e],this._pts[n]),n-e==1)return i.select(this,e),null;if(!t.intersects(i.tempEnv1))return null;var r=Math.trunc((e+n)/2);e<r&&this.computeSelect(t,e,r,i),r<n&&this.computeSelect(t,r,n,i)},mn.prototype.getCoordinates=function(){for(var t=new Array(this._end-this._start+1).fill(null),e=0,n=this._start;n<=this._end;n++)t[e++]=this._pts[n];return t},mn.prototype.computeOverlaps=function(t,e){this.computeOverlapsInternal(this._start,this._end,t,t._start,t._end,e)},mn.prototype.setId=function(t){this._id=t},mn.prototype.select=function(t,e){this.computeSelect(t,this._start,this._end,e)},mn.prototype.getEnvelope=function(){return null===this._env&&(this._env=new j(this._pts[this._start],this._pts[this._end])),this._env},mn.prototype.getEndIndex=function(){return this._end},mn.prototype.getStartIndex=function(){return this._start},mn.prototype.getContext=function(){return this._context},mn.prototype.getId=function(){return this._id},mn.prototype.computeOverlapsInternal=function(t,e,n,i,r,o){var s=this._pts[t],a=this._pts[e],u=n._pts[i],l=n._pts[r];if(e-t==1&&r-i==1)return o.overlap(this,t,n,i),null;if(o.tempEnv1.init(s,a),o.tempEnv2.init(u,l),!o.tempEnv1.intersects(o.tempEnv2))return null;var c=Math.trunc((t+e)/2),h=Math.trunc((i+r)/2);t<c&&(i<h&&this.computeOverlapsInternal(t,c,n,i,h,o),h<r&&this.computeOverlapsInternal(t,c,n,h,r,o)),c<e&&(i<h&&this.computeOverlapsInternal(c,e,n,i,h,o),h<r&&this.computeOverlapsInternal(c,e,n,h,r,o))},mn.prototype.interfaces_=function(){return[]},mn.prototype.getClass=function(){return mn};var vn=function(){};vn.prototype.interfaces_=function(){return[]},vn.prototype.getClass=function(){return vn},vn.getChainStartIndices=function(t){var e=0,n=new Nt;n.add(new D(e));do{var i=vn.findChainEnd(t,e);n.add(new D(i)),e=i}while(e<t.length-1);return vn.toIntArray(n)},vn.findChainEnd=function(t,e){for(var n=e;n<t.length-1&&t[n].equals2D(t[n+1]);)n++;if(n>=t.length-1)return t.length-1;for(var i=Be.quadrant(t[n],t[n+1]),r=e+1;r<t.length&&(t[r-1].equals2D(t[r])||Be.quadrant(t[r-1],t[r])===i);)r++;return r-1},vn.getChains=function(){if(1===arguments.length)return vn.getChains(arguments[0],null);if(2===arguments.length){for(var t=arguments[0],e=arguments[1],n=new Nt,i=vn.getChainStartIndices(t),r=0;r<i.length-1;r++){var o=new mn(t,i[r],i[r+1],e);n.add(o)}return n}},vn.toIntArray=function(t){for(var e=new Array(t.size()).fill(null),n=0;n<e.length;n++)e[n]=t.get(n).intValue();return e};var xn=function(){};xn.prototype.computeNodes=function(t){},xn.prototype.getNodedSubstrings=function(){},xn.prototype.interfaces_=function(){return[]},xn.prototype.getClass=function(){return xn};var In=function(){this._segInt=null,0===arguments.length||1===arguments.length&&this.setSegmentIntersector(arguments[0])};In.prototype.setSegmentIntersector=function(t){this._segInt=t},In.prototype.interfaces_=function(){return[xn]},In.prototype.getClass=function(){return In};var En=function(t){function e(e){e?t.call(this,e):t.call(this),this._monoChains=new Nt,this._index=new sn,this._idCounter=0,this._nodedSegStrings=null,this._nOverlaps=0}t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e;var n={SegmentOverlapAction:{configurable:!0}};return e.prototype.getMonotoneChains=function(){return this._monoChains},e.prototype.getNodedSubstrings=function(){return gn.getNodedSubstrings(this._nodedSegStrings)},e.prototype.getIndex=function(){return this._index},e.prototype.add=function(t){for(var e=vn.getChains(t.getCoordinates(),t).iterator();e.hasNext();){var n=e.next();n.setId(this._idCounter++),this._index.insert(n.getEnvelope(),n),this._monoChains.add(n)}},e.prototype.computeNodes=function(t){this._nodedSegStrings=t;for(var e=t.iterator();e.hasNext();)this.add(e.next());this.intersectChains()},e.prototype.intersectChains=function(){for(var t=new Nn(this._segInt),e=this._monoChains.iterator();e.hasNext();)for(var n=e.next(),i=this._index.query(n.getEnvelope()).iterator();i.hasNext();){var r=i.next();if(r.getId()>n.getId()&&(n.computeOverlaps(r,t),this._nOverlaps++),this._segInt.isDone())return null}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.SegmentOverlapAction.get=function(){return Nn},Object.defineProperties(e,n),e}(In),Nn=function(t){function e(){t.call(this),this._si=null,this._si=arguments[0]}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.overlap=function(){if(4!==arguments.length)return t.prototype.overlap.apply(this,arguments);var e=arguments[1],n=arguments[2],i=arguments[3],r=arguments[0].getContext(),o=n.getContext();this._si.processIntersections(r,e,o,i)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(_n),wn=function t(){if(this._quadrantSegments=t.DEFAULT_QUADRANT_SEGMENTS,this._endCapStyle=t.CAP_ROUND,this._joinStyle=t.JOIN_ROUND,this._mitreLimit=t.DEFAULT_MITRE_LIMIT,this._isSingleSided=!1,this._simplifyFactor=t.DEFAULT_SIMPLIFY_FACTOR,0===arguments.length);else if(1===arguments.length)this.setQuadrantSegments(arguments[0]);else if(2===arguments.length){var e=arguments[1];this.setQuadrantSegments(arguments[0]),this.setEndCapStyle(e)}else if(4===arguments.length){var n=arguments[1],i=arguments[2],r=arguments[3];this.setQuadrantSegments(arguments[0]),this.setEndCapStyle(n),this.setJoinStyle(i),this.setMitreLimit(r)}},Cn={CAP_ROUND:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},JOIN_ROUND:{configurable:!0},JOIN_MITRE:{configurable:!0},JOIN_BEVEL:{configurable:!0},DEFAULT_QUADRANT_SEGMENTS:{configurable:!0},DEFAULT_MITRE_LIMIT:{configurable:!0},DEFAULT_SIMPLIFY_FACTOR:{configurable:!0}};wn.prototype.getEndCapStyle=function(){return this._endCapStyle},wn.prototype.isSingleSided=function(){return this._isSingleSided},wn.prototype.setQuadrantSegments=function(t){this._quadrantSegments=t,0===this._quadrantSegments&&(this._joinStyle=wn.JOIN_BEVEL),this._quadrantSegments<0&&(this._joinStyle=wn.JOIN_MITRE,this._mitreLimit=Math.abs(this._quadrantSegments)),t<=0&&(this._quadrantSegments=1),this._joinStyle!==wn.JOIN_ROUND&&(this._quadrantSegments=wn.DEFAULT_QUADRANT_SEGMENTS)},wn.prototype.getJoinStyle=function(){return this._joinStyle},wn.prototype.setJoinStyle=function(t){this._joinStyle=t},wn.prototype.setSimplifyFactor=function(t){this._simplifyFactor=t<0?0:t},wn.prototype.getSimplifyFactor=function(){return this._simplifyFactor},wn.prototype.getQuadrantSegments=function(){return this._quadrantSegments},wn.prototype.setEndCapStyle=function(t){this._endCapStyle=t},wn.prototype.getMitreLimit=function(){return this._mitreLimit},wn.prototype.setMitreLimit=function(t){this._mitreLimit=t},wn.prototype.setSingleSided=function(t){this._isSingleSided=t},wn.prototype.interfaces_=function(){return[]},wn.prototype.getClass=function(){return wn},wn.bufferDistanceError=function(t){var e=Math.PI/2/t;return 1-Math.cos(e/2)},Cn.CAP_ROUND.get=function(){return 1},Cn.CAP_FLAT.get=function(){return 2},Cn.CAP_SQUARE.get=function(){return 3},Cn.JOIN_ROUND.get=function(){return 1},Cn.JOIN_MITRE.get=function(){return 2},Cn.JOIN_BEVEL.get=function(){return 3},Cn.DEFAULT_QUADRANT_SEGMENTS.get=function(){return 8},Cn.DEFAULT_MITRE_LIMIT.get=function(){return 5},Cn.DEFAULT_SIMPLIFY_FACTOR.get=function(){return.01},Object.defineProperties(wn,Cn);var Sn=function(t){this._distanceTol=null,this._isDeleted=null,this._angleOrientation=at.COUNTERCLOCKWISE,this._inputLine=t||null},bn={INIT:{configurable:!0},DELETE:{configurable:!0},KEEP:{configurable:!0},NUM_PTS_TO_CHECK:{configurable:!0}};Sn.prototype.isDeletable=function(t,e,n,i){var r=this._inputLine[t],o=this._inputLine[e],s=this._inputLine[n];return!!this.isConcave(r,o,s)&&!!this.isShallow(r,o,s,i)&&this.isShallowSampled(r,o,t,n,i)},Sn.prototype.deleteShallowConcavities=function(){for(var t=1,e=this.findNextNonDeletedIndex(t),n=this.findNextNonDeletedIndex(e),i=!1;n<this._inputLine.length;){var r=!1;this.isDeletable(t,e,n,this._distanceTol)&&(this._isDeleted[e]=Sn.DELETE,r=!0,i=!0),e=this.findNextNonDeletedIndex(t=r?n:e),n=this.findNextNonDeletedIndex(e)}return i},Sn.prototype.isShallowConcavity=function(t,e,n,i){return at.computeOrientation(t,e,n)===this._angleOrientation&&at.distancePointLine(e,t,n)<i},Sn.prototype.isShallowSampled=function(t,e,n,i,r){var o=Math.trunc((i-n)/Sn.NUM_PTS_TO_CHECK);o<=0&&(o=1);for(var s=n;s<i;s+=o)if(!this.isShallow(t,e,this._inputLine[s],r))return!1;return!0},Sn.prototype.isConcave=function(t,e,n){return at.computeOrientation(t,e,n)===this._angleOrientation},Sn.prototype.simplify=function(t){this._distanceTol=Math.abs(t),t<0&&(this._angleOrientation=at.CLOCKWISE),this._isDeleted=new Array(this._inputLine.length).fill(null);var e=!1;do{e=this.deleteShallowConcavities()}while(e);return this.collapseLine()},Sn.prototype.findNextNonDeletedIndex=function(t){for(var e=t+1;e<this._inputLine.length&&this._isDeleted[e]===Sn.DELETE;)e++;return e},Sn.prototype.isShallow=function(t,e,n,i){return at.distancePointLine(e,t,n)<i},Sn.prototype.collapseLine=function(){for(var t=new Ct,e=0;e<this._inputLine.length;e++)this._isDeleted[e]!==Sn.DELETE&&t.add(this._inputLine[e]);return t.toCoordinateArray()},Sn.prototype.interfaces_=function(){return[]},Sn.prototype.getClass=function(){return Sn},Sn.simplify=function(t,e){return new Sn(t).simplify(e)},bn.INIT.get=function(){return 0},bn.DELETE.get=function(){return 1},bn.KEEP.get=function(){return 1},bn.NUM_PTS_TO_CHECK.get=function(){return 10},Object.defineProperties(Sn,bn);var Ln=function(){this._ptList=null,this._precisionModel=null,this._minimimVertexDistance=0,this._ptList=new Nt},On={COORDINATE_ARRAY_TYPE:{configurable:!0}};Ln.prototype.getCoordinates=function(){return this._ptList.toArray(Ln.COORDINATE_ARRAY_TYPE)},Ln.prototype.setPrecisionModel=function(t){this._precisionModel=t},Ln.prototype.addPt=function(t){var e=new w(t);if(this._precisionModel.makePrecise(e),this.isRedundant(e))return null;this._ptList.add(e)},Ln.prototype.revere=function(){},Ln.prototype.addPts=function(t,e){if(e)for(var n=0;n<t.length;n++)this.addPt(t[n]);else for(var i=t.length-1;i>=0;i--)this.addPt(t[i])},Ln.prototype.isRedundant=function(t){if(this._ptList.size()<1)return!1;var e=this._ptList.get(this._ptList.size()-1);return t.distance(e)<this._minimimVertexDistance},Ln.prototype.toString=function(){return(new _e).createLineString(this.getCoordinates()).toString()},Ln.prototype.closeRing=function(){if(this._ptList.size()<1)return null;var t=new w(this._ptList.get(0)),e=this._ptList.get(this._ptList.size()-1);if(t.equals(e))return null;this._ptList.add(t)},Ln.prototype.setMinimumVertexDistance=function(t){this._minimimVertexDistance=t},Ln.prototype.interfaces_=function(){return[]},Ln.prototype.getClass=function(){return Ln},On.COORDINATE_ARRAY_TYPE.get=function(){return new Array(0).fill(null)},Object.defineProperties(Ln,On);var Pn=function(){},Tn={PI_TIMES_2:{configurable:!0},PI_OVER_2:{configurable:!0},PI_OVER_4:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},CLOCKWISE:{configurable:!0},NONE:{configurable:!0}};Pn.prototype.interfaces_=function(){return[]},Pn.prototype.getClass=function(){return Pn},Pn.toDegrees=function(t){return 180*t/Math.PI},Pn.normalize=function(t){for(;t>Math.PI;)t-=Pn.PI_TIMES_2;for(;t<=-Math.PI;)t+=Pn.PI_TIMES_2;return t},Pn.angle=function(){if(1===arguments.length){var t=arguments[0];return Math.atan2(t.y,t.x)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return Math.atan2(n.y-e.y,n.x-e.x)}},Pn.isAcute=function(t,e,n){return(t.x-e.x)*(n.x-e.x)+(t.y-e.y)*(n.y-e.y)>0},Pn.isObtuse=function(t,e,n){return(t.x-e.x)*(n.x-e.x)+(t.y-e.y)*(n.y-e.y)<0},Pn.interiorAngle=function(t,e,n){var i=Pn.angle(e,t),r=Pn.angle(e,n);return Math.abs(r-i)},Pn.normalizePositive=function(t){if(t<0){for(;t<0;)t+=Pn.PI_TIMES_2;t>=Pn.PI_TIMES_2&&(t=0)}else{for(;t>=Pn.PI_TIMES_2;)t-=Pn.PI_TIMES_2;t<0&&(t=0)}return t},Pn.angleBetween=function(t,e,n){var i=Pn.angle(e,t),r=Pn.angle(e,n);return Pn.diff(i,r)},Pn.diff=function(t,e){var n=null;return(n=t<e?e-t:t-e)>Math.PI&&(n=2*Math.PI-n),n},Pn.toRadians=function(t){return t*Math.PI/180},Pn.getTurn=function(t,e){var n=Math.sin(e-t);return n>0?Pn.COUNTERCLOCKWISE:n<0?Pn.CLOCKWISE:Pn.NONE},Pn.angleBetweenOriented=function(t,e,n){var i=Pn.angle(e,t),r=Pn.angle(e,n)-i;return r<=-Math.PI?r+Pn.PI_TIMES_2:r>Math.PI?r-Pn.PI_TIMES_2:r},Tn.PI_TIMES_2.get=function(){return 2*Math.PI},Tn.PI_OVER_2.get=function(){return Math.PI/2},Tn.PI_OVER_4.get=function(){return Math.PI/4},Tn.COUNTERCLOCKWISE.get=function(){return at.COUNTERCLOCKWISE},Tn.CLOCKWISE.get=function(){return at.CLOCKWISE},Tn.NONE.get=function(){return at.COLLINEAR},Object.defineProperties(Pn,Tn);var Mn=function t(){this._maxCurveSegmentError=0,this._filletAngleQuantum=null,this._closingSegLengthFactor=1,this._segList=null,this._distance=0,this._precisionModel=null,this._bufParams=null,this._li=null,this._s0=null,this._s1=null,this._s2=null,this._seg0=new dn,this._seg1=new dn,this._offset0=new dn,this._offset1=new dn,this._side=0,this._hasNarrowConcaveAngle=!1;var e=arguments[1],n=arguments[2];this._precisionModel=arguments[0],this._bufParams=e,this._li=new rt,this._filletAngleQuantum=Math.PI/2/e.getQuadrantSegments(),e.getQuadrantSegments()>=8&&e.getJoinStyle()===wn.JOIN_ROUND&&(this._closingSegLengthFactor=t.MAX_CLOSING_SEG_LEN_FACTOR),this.init(n)},Rn={OFFSET_SEGMENT_SEPARATION_FACTOR:{configurable:!0},INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},CURVE_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},MAX_CLOSING_SEG_LEN_FACTOR:{configurable:!0}};Mn.prototype.addNextSegment=function(t,e){if(this._s0=this._s1,this._s1=this._s2,this._s2=t,this._seg0.setCoordinates(this._s0,this._s1),this.computeOffsetSegment(this._seg0,this._side,this._distance,this._offset0),this._seg1.setCoordinates(this._s1,this._s2),this.computeOffsetSegment(this._seg1,this._side,this._distance,this._offset1),this._s1.equals(this._s2))return null;var n=at.computeOrientation(this._s0,this._s1,this._s2),i=n===at.CLOCKWISE&&this._side===Ce.LEFT||n===at.COUNTERCLOCKWISE&&this._side===Ce.RIGHT;0===n?this.addCollinear(e):i?this.addOutsideTurn(n,e):this.addInsideTurn(n,e)},Mn.prototype.addLineEndCap=function(t,e){var n=new dn(t,e),i=new dn;this.computeOffsetSegment(n,Ce.LEFT,this._distance,i);var r=new dn;this.computeOffsetSegment(n,Ce.RIGHT,this._distance,r);var o=Math.atan2(e.y-t.y,e.x-t.x);switch(this._bufParams.getEndCapStyle()){case wn.CAP_ROUND:this._segList.addPt(i.p1),this.addFilletArc(e,o+Math.PI/2,o-Math.PI/2,at.CLOCKWISE,this._distance),this._segList.addPt(r.p1);break;case wn.CAP_FLAT:this._segList.addPt(i.p1),this._segList.addPt(r.p1);break;case wn.CAP_SQUARE:var s=new w;s.x=Math.abs(this._distance)*Math.cos(o),s.y=Math.abs(this._distance)*Math.sin(o);var a=new w(i.p1.x+s.x,i.p1.y+s.y),u=new w(r.p1.x+s.x,r.p1.y+s.y);this._segList.addPt(a),this._segList.addPt(u)}},Mn.prototype.getCoordinates=function(){return this._segList.getCoordinates()},Mn.prototype.addMitreJoin=function(t,e,n,i){var r=!0,o=null;try{o=Y.intersection(e.p0,e.p1,n.p0,n.p1),(i<=0?1:o.distance(t)/Math.abs(i))>this._bufParams.getMitreLimit()&&(r=!1)}catch(t){if(!(t instanceof z))throw t;o=new w(0,0),r=!1}r?this._segList.addPt(o):this.addLimitedMitreJoin(e,n,i,this._bufParams.getMitreLimit())},Mn.prototype.addFilletCorner=function(t,e,n,i,r){var o=Math.atan2(e.y-t.y,e.x-t.x),s=Math.atan2(n.y-t.y,n.x-t.x);i===at.CLOCKWISE?o<=s&&(o+=2*Math.PI):o>=s&&(o-=2*Math.PI),this._segList.addPt(e),this.addFilletArc(t,o,s,i,r),this._segList.addPt(n)},Mn.prototype.addOutsideTurn=function(t,e){if(this._offset0.p1.distance(this._offset1.p0)<this._distance*Mn.OFFSET_SEGMENT_SEPARATION_FACTOR)return this._segList.addPt(this._offset0.p1),null;this._bufParams.getJoinStyle()===wn.JOIN_MITRE?this.addMitreJoin(this._s1,this._offset0,this._offset1,this._distance):this._bufParams.getJoinStyle()===wn.JOIN_BEVEL?this.addBevelJoin(this._offset0,this._offset1):(e&&this._segList.addPt(this._offset0.p1),this.addFilletCorner(this._s1,this._offset0.p1,this._offset1.p0,t,this._distance),this._segList.addPt(this._offset1.p0))},Mn.prototype.createSquare=function(t){this._segList.addPt(new w(t.x+this._distance,t.y+this._distance)),this._segList.addPt(new w(t.x+this._distance,t.y-this._distance)),this._segList.addPt(new w(t.x-this._distance,t.y-this._distance)),this._segList.addPt(new w(t.x-this._distance,t.y+this._distance)),this._segList.closeRing()},Mn.prototype.addSegments=function(t,e){this._segList.addPts(t,e)},Mn.prototype.addFirstSegment=function(){this._segList.addPt(this._offset1.p0)},Mn.prototype.addLastSegment=function(){this._segList.addPt(this._offset1.p1)},Mn.prototype.initSideSegments=function(t,e,n){this._s1=t,this._s2=e,this._side=n,this._seg1.setCoordinates(t,e),this.computeOffsetSegment(this._seg1,n,this._distance,this._offset1)},Mn.prototype.addLimitedMitreJoin=function(t,e,n,i){var r=this._seg0.p1,o=Pn.angle(r,this._seg0.p0),s=Pn.angleBetweenOriented(this._seg0.p0,r,this._seg1.p1)/2,a=Pn.normalize(o+s),u=Pn.normalize(a+Math.PI),l=i*n,c=n-l*Math.abs(Math.sin(s)),h=r.x+l*Math.cos(u),p=r.y+l*Math.sin(u),f=new w(h,p),g=new dn(r,f),d=g.pointAlongOffset(1,c),y=g.pointAlongOffset(1,-c);this._side===Ce.LEFT?(this._segList.addPt(d),this._segList.addPt(y)):(this._segList.addPt(y),this._segList.addPt(d))},Mn.prototype.computeOffsetSegment=function(t,e,n,i){var r=e===Ce.LEFT?1:-1,o=t.p1.x-t.p0.x,s=t.p1.y-t.p0.y,a=Math.sqrt(o*o+s*s),u=r*n*o/a,l=r*n*s/a;i.p0.x=t.p0.x-l,i.p0.y=t.p0.y+u,i.p1.x=t.p1.x-l,i.p1.y=t.p1.y+u},Mn.prototype.addFilletArc=function(t,e,n,i,r){var o=i===at.CLOCKWISE?-1:1,s=Math.abs(e-n),a=Math.trunc(s/this._filletAngleQuantum+.5);if(a<1)return null;for(var u=s/a,l=0,c=new w;l<s;){var h=e+o*l;c.x=t.x+r*Math.cos(h),c.y=t.y+r*Math.sin(h),this._segList.addPt(c),l+=u}},Mn.prototype.addInsideTurn=function(t,e){if(this._li.computeIntersection(this._offset0.p0,this._offset0.p1,this._offset1.p0,this._offset1.p1),this._li.hasIntersection())this._segList.addPt(this._li.getIntersection(0));else if(this._hasNarrowConcaveAngle=!0,this._offset0.p1.distance(this._offset1.p0)<this._distance*Mn.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR)this._segList.addPt(this._offset0.p1);else{if(this._segList.addPt(this._offset0.p1),this._closingSegLengthFactor>0){var n=new w((this._closingSegLengthFactor*this._offset0.p1.x+this._s1.x)/(this._closingSegLengthFactor+1),(this._closingSegLengthFactor*this._offset0.p1.y+this._s1.y)/(this._closingSegLengthFactor+1));this._segList.addPt(n);var i=new w((this._closingSegLengthFactor*this._offset1.p0.x+this._s1.x)/(this._closingSegLengthFactor+1),(this._closingSegLengthFactor*this._offset1.p0.y+this._s1.y)/(this._closingSegLengthFactor+1));this._segList.addPt(i)}else this._segList.addPt(this._s1);this._segList.addPt(this._offset1.p0)}},Mn.prototype.createCircle=function(t){var e=new w(t.x+this._distance,t.y);this._segList.addPt(e),this.addFilletArc(t,0,2*Math.PI,-1,this._distance),this._segList.closeRing()},Mn.prototype.addBevelJoin=function(t,e){this._segList.addPt(t.p1),this._segList.addPt(e.p0)},Mn.prototype.init=function(t){this._distance=t,this._maxCurveSegmentError=t*(1-Math.cos(this._filletAngleQuantum/2)),this._segList=new Ln,this._segList.setPrecisionModel(this._precisionModel),this._segList.setMinimumVertexDistance(t*Mn.CURVE_VERTEX_SNAP_DISTANCE_FACTOR)},Mn.prototype.addCollinear=function(t){this._li.computeIntersection(this._s0,this._s1,this._s1,this._s2),this._li.getIntersectionNum()>=2&&(this._bufParams.getJoinStyle()===wn.JOIN_BEVEL||this._bufParams.getJoinStyle()===wn.JOIN_MITRE?(t&&this._segList.addPt(this._offset0.p1),this._segList.addPt(this._offset1.p0)):this.addFilletCorner(this._s1,this._offset0.p1,this._offset1.p0,at.CLOCKWISE,this._distance))},Mn.prototype.closeRing=function(){this._segList.closeRing()},Mn.prototype.hasNarrowConcaveAngle=function(){return this._hasNarrowConcaveAngle},Mn.prototype.interfaces_=function(){return[]},Mn.prototype.getClass=function(){return Mn},Rn.OFFSET_SEGMENT_SEPARATION_FACTOR.get=function(){return.001},Rn.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return.001},Rn.CURVE_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return 1e-6},Rn.MAX_CLOSING_SEG_LEN_FACTOR.get=function(){return 80},Object.defineProperties(Mn,Rn);var Dn=function(){this._distance=0,this._precisionModel=null,this._bufParams=null;var t=arguments[1];this._precisionModel=arguments[0],this._bufParams=t};Dn.prototype.getOffsetCurve=function(t,e){if(this._distance=e,0===e)return null;var n=e<0,i=Math.abs(e),r=this.getSegGen(i);t.length<=1?this.computePointCurve(t[0],r):this.computeOffsetCurve(t,n,r);var o=r.getCoordinates();return n&&St.reverse(o),o},Dn.prototype.computeSingleSidedBufferCurve=function(t,e,n){var i=this.simplifyTolerance(this._distance);if(e){n.addSegments(t,!0);var r=Sn.simplify(t,-i),o=r.length-1;n.initSideSegments(r[o],r[o-1],Ce.LEFT),n.addFirstSegment();for(var s=o-2;s>=0;s--)n.addNextSegment(r[s],!0)}else{n.addSegments(t,!1);var a=Sn.simplify(t,i),u=a.length-1;n.initSideSegments(a[0],a[1],Ce.LEFT),n.addFirstSegment();for(var l=2;l<=u;l++)n.addNextSegment(a[l],!0)}n.addLastSegment(),n.closeRing()},Dn.prototype.computeRingBufferCurve=function(t,e,n){var i=this.simplifyTolerance(this._distance);e===Ce.RIGHT&&(i=-i);var r=Sn.simplify(t,i),o=r.length-1;n.initSideSegments(r[o-1],r[0],e);for(var s=1;s<=o;s++)n.addNextSegment(r[s],1!==s);n.closeRing()},Dn.prototype.computeLineBufferCurve=function(t,e){var n=this.simplifyTolerance(this._distance),i=Sn.simplify(t,n),r=i.length-1;e.initSideSegments(i[0],i[1],Ce.LEFT);for(var o=2;o<=r;o++)e.addNextSegment(i[o],!0);e.addLastSegment(),e.addLineEndCap(i[r-1],i[r]);var s=Sn.simplify(t,-n),a=s.length-1;e.initSideSegments(s[a],s[a-1],Ce.LEFT);for(var u=a-2;u>=0;u--)e.addNextSegment(s[u],!0);e.addLastSegment(),e.addLineEndCap(s[1],s[0]),e.closeRing()},Dn.prototype.computePointCurve=function(t,e){switch(this._bufParams.getEndCapStyle()){case wn.CAP_ROUND:e.createCircle(t);break;case wn.CAP_SQUARE:e.createSquare(t)}},Dn.prototype.getLineCurve=function(t,e){if(this._distance=e,e<0&&!this._bufParams.isSingleSided())return null;if(0===e)return null;var n=Math.abs(e),i=this.getSegGen(n);return t.length<=1?this.computePointCurve(t[0],i):this._bufParams.isSingleSided()?this.computeSingleSidedBufferCurve(t,e<0,i):this.computeLineBufferCurve(t,i),i.getCoordinates()},Dn.prototype.getBufferParameters=function(){return this._bufParams},Dn.prototype.simplifyTolerance=function(t){return t*this._bufParams.getSimplifyFactor()},Dn.prototype.getRingCurve=function(t,e,n){if(this._distance=n,t.length<=2)return this.getLineCurve(t,n);if(0===n)return Dn.copyCoordinates(t);var i=this.getSegGen(n);return this.computeRingBufferCurve(t,e,i),i.getCoordinates()},Dn.prototype.computeOffsetCurve=function(t,e,n){var i=this.simplifyTolerance(this._distance);if(e){var r=Sn.simplify(t,-i),o=r.length-1;n.initSideSegments(r[o],r[o-1],Ce.LEFT),n.addFirstSegment();for(var s=o-2;s>=0;s--)n.addNextSegment(r[s],!0)}else{var a=Sn.simplify(t,i),u=a.length-1;n.initSideSegments(a[0],a[1],Ce.LEFT),n.addFirstSegment();for(var l=2;l<=u;l++)n.addNextSegment(a[l],!0)}n.addLastSegment()},Dn.prototype.getSegGen=function(t){return new Mn(this._precisionModel,this._bufParams,t)},Dn.prototype.interfaces_=function(){return[]},Dn.prototype.getClass=function(){return Dn},Dn.copyCoordinates=function(t){for(var e=new Array(t.length).fill(null),n=0;n<e.length;n++)e[n]=new w(t[n]);return e};var An=function(){this._subgraphs=null,this._seg=new dn,this._cga=new at,this._subgraphs=arguments[0]},Fn={DepthSegment:{configurable:!0}};An.prototype.findStabbedSegments=function(){if(1===arguments.length){for(var t=arguments[0],e=new Nt,n=this._subgraphs.iterator();n.hasNext();){var i=n.next(),r=i.getEnvelope();t.y<r.getMinY()||t.y>r.getMaxY()||this.findStabbedSegments(t,i.getDirectedEdges(),e)}return e}if(3===arguments.length)if(P(arguments[2],Et)&&arguments[0]instanceof w&&arguments[1]instanceof ke){for(var o=arguments[0],s=arguments[1],a=arguments[2],u=s.getEdge().getCoordinates(),l=0;l<u.length-1;l++)if(this._seg.p0=u[l],this._seg.p1=u[l+1],this._seg.p0.y>this._seg.p1.y&&this._seg.reverse(),!(Math.max(this._seg.p0.x,this._seg.p1.x)<o.x||this._seg.isHorizontal()||o.y<this._seg.p0.y||o.y>this._seg.p1.y||at.computeOrientation(this._seg.p0,this._seg.p1,o)===at.RIGHT)){var c=s.getDepth(Ce.LEFT);this._seg.p0.equals(u[l])||(c=s.getDepth(Ce.RIGHT));var h=new Gn(this._seg,c);a.add(h)}}else if(P(arguments[2],Et)&&arguments[0]instanceof w&&P(arguments[1],Et))for(var p=arguments[0],f=arguments[2],g=arguments[1].iterator();g.hasNext();){var d=g.next();d.isForward()&&this.findStabbedSegments(p,d,f)}},An.prototype.getDepth=function(t){var e=this.findStabbedSegments(t);return 0===e.size()?0:Ze.min(e)._leftDepth},An.prototype.interfaces_=function(){return[]},An.prototype.getClass=function(){return An},Fn.DepthSegment.get=function(){return Gn},Object.defineProperties(An,Fn);var Gn=function(){this._upwardSeg=null,this._leftDepth=null;var t=arguments[1];this._upwardSeg=new dn(arguments[0]),this._leftDepth=t};Gn.prototype.compareTo=function(t){var e=t;if(this._upwardSeg.minX()>=e._upwardSeg.maxX())return 1;if(this._upwardSeg.maxX()<=e._upwardSeg.minX())return-1;var n=this._upwardSeg.orientationIndex(e._upwardSeg);return 0!==n||0!=(n=-1*e._upwardSeg.orientationIndex(this._upwardSeg))?n:this._upwardSeg.compareTo(e._upwardSeg)},Gn.prototype.compareX=function(t,e){var n=t.p0.compareTo(e.p0);return 0!==n?n:t.p1.compareTo(e.p1)},Gn.prototype.toString=function(){return this._upwardSeg.toString()},Gn.prototype.interfaces_=function(){return[I]},Gn.prototype.getClass=function(){return Gn};var Vn=function(t,e,n){this.p0=t||null,this.p1=e||null,this.p2=n||null};Vn.prototype.area=function(){return Vn.area(this.p0,this.p1,this.p2)},Vn.prototype.signedArea=function(){return Vn.signedArea(this.p0,this.p1,this.p2)},Vn.prototype.interpolateZ=function(t){if(null===t)throw new m("Supplied point is null.");return Vn.interpolateZ(t,this.p0,this.p1,this.p2)},Vn.prototype.longestSideLength=function(){return Vn.longestSideLength(this.p0,this.p1,this.p2)},Vn.prototype.isAcute=function(){return Vn.isAcute(this.p0,this.p1,this.p2)},Vn.prototype.circumcentre=function(){return Vn.circumcentre(this.p0,this.p1,this.p2)},Vn.prototype.area3D=function(){return Vn.area3D(this.p0,this.p1,this.p2)},Vn.prototype.centroid=function(){return Vn.centroid(this.p0,this.p1,this.p2)},Vn.prototype.inCentre=function(){return Vn.inCentre(this.p0,this.p1,this.p2)},Vn.prototype.interfaces_=function(){return[]},Vn.prototype.getClass=function(){return Vn},Vn.area=function(t,e,n){return Math.abs(((n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y))/2)},Vn.signedArea=function(t,e,n){return((n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y))/2},Vn.det=function(t,e,n,i){return t*i-e*n},Vn.interpolateZ=function(t,e,n,i){var r=e.x,o=e.y,s=n.x-r,a=i.x-r,u=n.y-o,l=i.y-o,c=s*l-a*u,h=t.x-r,p=t.y-o;return e.z+(l*h-a*p)/c*(n.z-e.z)+(-u*h+s*p)/c*(i.z-e.z)},Vn.longestSideLength=function(t,e,n){var i=t.distance(e),r=e.distance(n),o=n.distance(t),s=i;return r>s&&(s=r),o>s&&(s=o),s},Vn.isAcute=function(t,e,n){return!!Pn.isAcute(t,e,n)&&!!Pn.isAcute(e,n,t)&&!!Pn.isAcute(n,t,e)},Vn.circumcentre=function(t,e,n){var i=n.x,r=n.y,o=t.x-i,s=t.y-r,a=e.x-i,u=e.y-r,l=2*Vn.det(o,s,a,u),c=Vn.det(s,o*o+s*s,u,a*a+u*u),h=Vn.det(o,o*o+s*s,a,a*a+u*u);return new w(i-c/l,r+h/l)},Vn.perpendicularBisector=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=new Y(t.x+n/2,t.y+i/2,1),o=new Y(t.x-i+n/2,t.y+n+i/2,1);return new Y(r,o)},Vn.angleBisector=function(t,e,n){var i=e.distance(t),r=i/(i+e.distance(n));return new w(t.x+r*(n.x-t.x),t.y+r*(n.y-t.y))},Vn.area3D=function(t,e,n){var i=e.x-t.x,r=e.y-t.y,o=e.z-t.z,s=n.x-t.x,a=n.y-t.y,u=n.z-t.z,l=r*u-o*a,c=o*s-i*u,h=i*a-r*s;return Math.sqrt(l*l+c*c+h*h)/2},Vn.centroid=function(t,e,n){return new w((t.x+e.x+n.x)/3,(t.y+e.y+n.y)/3)},Vn.inCentre=function(t,e,n){var i=e.distance(n),r=t.distance(n),o=t.distance(e),s=i+r+o;return new w((i*t.x+r*e.x+o*n.x)/s,(i*t.y+r*e.y+o*n.y)/s)};var Bn=function(){this._inputGeom=null,this._distance=null,this._curveBuilder=null,this._curveList=new Nt;var t=arguments[1],e=arguments[2];this._inputGeom=arguments[0],this._distance=t,this._curveBuilder=e};Bn.prototype.addPoint=function(t){if(this._distance<=0)return null;var e=t.getCoordinates(),n=this._curveBuilder.getLineCurve(e,this._distance);this.addCurve(n,L.EXTERIOR,L.INTERIOR)},Bn.prototype.addPolygon=function(t){var e=this._distance,n=Ce.LEFT;this._distance<0&&(e=-this._distance,n=Ce.RIGHT);var i=t.getExteriorRing(),r=St.removeRepeatedPoints(i.getCoordinates());if(this._distance<0&&this.isErodedCompletely(i,this._distance))return null;if(this._distance<=0&&r.length<3)return null;this.addPolygonRing(r,e,n,L.EXTERIOR,L.INTERIOR);for(var o=0;o<t.getNumInteriorRing();o++){var s=t.getInteriorRingN(o),a=St.removeRepeatedPoints(s.getCoordinates());this._distance>0&&this.isErodedCompletely(s,-this._distance)||this.addPolygonRing(a,e,Ce.opposite(n),L.INTERIOR,L.EXTERIOR)}},Bn.prototype.isTriangleErodedCompletely=function(t,e){var n=new Vn(t[0],t[1],t[2]),i=n.inCentre();return at.distancePointLine(i,n.p0,n.p1)<Math.abs(e)},Bn.prototype.addLineString=function(t){if(this._distance<=0&&!this._curveBuilder.getBufferParameters().isSingleSided())return null;var e=St.removeRepeatedPoints(t.getCoordinates()),n=this._curveBuilder.getLineCurve(e,this._distance);this.addCurve(n,L.EXTERIOR,L.INTERIOR)},Bn.prototype.addCurve=function(t,e,n){if(null===t||t.length<2)return null;var i=new gn(t,new Me(0,L.BOUNDARY,e,n));this._curveList.add(i)},Bn.prototype.getCurves=function(){return this.add(this._inputGeom),this._curveList},Bn.prototype.addPolygonRing=function(t,e,n,i,r){if(0===e&&t.length<ee.MINIMUM_VALID_SIZE)return null;var o=i,s=r;t.length>=ee.MINIMUM_VALID_SIZE&&at.isCCW(t)&&(o=r,s=i,n=Ce.opposite(n));var a=this._curveBuilder.getRingCurve(t,n,e);this.addCurve(a,o,s)},Bn.prototype.add=function(t){if(t.isEmpty())return null;t instanceof Zt?this.addPolygon(t):t instanceof Jt?this.addLineString(t):t instanceof Qt?this.addPoint(t):(t instanceof te||t instanceof zt||t instanceof ne||t instanceof kt)&&this.addCollection(t)},Bn.prototype.isErodedCompletely=function(t,e){var n=t.getCoordinates();if(n.length<4)return e<0;if(4===n.length)return this.isTriangleErodedCompletely(n,e);var i=t.getEnvelopeInternal(),r=Math.min(i.getHeight(),i.getWidth());return e<0&&2*Math.abs(e)>r},Bn.prototype.addCollection=function(t){for(var e=0;e<t.getNumGeometries();e++){var n=t.getGeometryN(e);this.add(n)}},Bn.prototype.interfaces_=function(){return[]},Bn.prototype.getClass=function(){return Bn};var qn=function(){};qn.prototype.locate=function(t){},qn.prototype.interfaces_=function(){return[]},qn.prototype.getClass=function(){return qn};var Un=function(){this._parent=null,this._atStart=null,this._max=null,this._index=null,this._subcollectionIterator=null;var t=arguments[0];this._parent=t,this._atStart=!0,this._index=0,this._max=t.getNumGeometries()};Un.prototype.next=function(){if(this._atStart)return this._atStart=!1,Un.isAtomic(this._parent)&&this._index++,this._parent;if(null!==this._subcollectionIterator){if(this._subcollectionIterator.hasNext())return this._subcollectionIterator.next();this._subcollectionIterator=null}if(this._index>=this._max)throw new i;var t=this._parent.getGeometryN(this._index++);return t instanceof kt?(this._subcollectionIterator=new Un(t),this._subcollectionIterator.next()):t},Un.prototype.remove=function(){throw new Error(this.getClass().getName())},Un.prototype.hasNext=function(){if(this._atStart)return!0;if(null!==this._subcollectionIterator){if(this._subcollectionIterator.hasNext())return!0;this._subcollectionIterator=null}return!(this._index>=this._max)},Un.prototype.interfaces_=function(){return[It]},Un.prototype.getClass=function(){return Un},Un.isAtomic=function(t){return!(t instanceof kt)};var kn=function(){this._geom=null,this._geom=arguments[0]};kn.prototype.locate=function(t){return kn.locate(t,this._geom)},kn.prototype.interfaces_=function(){return[qn]},kn.prototype.getClass=function(){return kn},kn.isPointInRing=function(t,e){return!!e.getEnvelopeInternal().intersects(t)&&at.isPointInRing(t,e.getCoordinates())},kn.containsPointInPolygon=function(t,e){if(e.isEmpty())return!1;var n=e.getExteriorRing();if(!kn.isPointInRing(t,n))return!1;for(var i=0;i<e.getNumInteriorRing();i++){var r=e.getInteriorRingN(i);if(kn.isPointInRing(t,r))return!1}return!0},kn.containsPoint=function(t,e){if(e instanceof Zt)return kn.containsPointInPolygon(t,e);if(e instanceof kt)for(var n=new Un(e);n.hasNext();){var i=n.next();if(i!==e&&kn.containsPoint(t,i))return!0}return!1},kn.locate=function(t,e){return e.isEmpty()?L.EXTERIOR:kn.containsPoint(t,e)?L.INTERIOR:L.EXTERIOR};var zn=function(){this._edgeMap=new h,this._edgeList=null,this._ptInAreaLocation=[L.NONE,L.NONE]};zn.prototype.getNextCW=function(t){this.getEdges();var e=this._edgeList.indexOf(t),n=e-1;return 0===e&&(n=this._edgeList.size()-1),this._edgeList.get(n)},zn.prototype.propagateSideLabels=function(t){for(var e=L.NONE,n=this.iterator();n.hasNext();){var i=n.next().getLabel();i.isArea(t)&&i.getLocation(t,Ce.LEFT)!==L.NONE&&(e=i.getLocation(t,Ce.LEFT))}if(e===L.NONE)return null;for(var r=e,o=this.iterator();o.hasNext();){var s=o.next(),a=s.getLabel();if(a.getLocation(t,Ce.ON)===L.NONE&&a.setLocation(t,Ce.ON,r),a.isArea(t)){var u=a.getLocation(t,Ce.LEFT),l=a.getLocation(t,Ce.RIGHT);if(l!==L.NONE){if(l!==r)throw new Le("side location conflict",s.getCoordinate());u===L.NONE&&et.shouldNeverReachHere("found single null side (at "+s.getCoordinate()+")"),r=u}else et.isTrue(a.getLocation(t,Ce.LEFT)===L.NONE,"found single null side"),a.setLocation(t,Ce.RIGHT,r),a.setLocation(t,Ce.LEFT,r)}}},zn.prototype.getCoordinate=function(){var t=this.iterator();return t.hasNext()?t.next().getCoordinate():null},zn.prototype.print=function(t){X.out.println("EdgeEndStar:   "+this.getCoordinate());for(var e=this.iterator();e.hasNext();)e.next().print(t)},zn.prototype.isAreaLabelsConsistent=function(t){return this.computeEdgeEndLabels(t.getBoundaryNodeRule()),this.checkAreaLabelsConsistent(0)},zn.prototype.checkAreaLabelsConsistent=function(t){var e=this.getEdges();if(e.size()<=0)return!0;var n=e.size()-1,i=e.get(n).getLabel().getLocation(t,Ce.LEFT);et.isTrue(i!==L.NONE,"Found unlabelled area edge");for(var r=i,o=this.iterator();o.hasNext();){var s=o.next().getLabel();et.isTrue(s.isArea(t),"Found non-area edge");var a=s.getLocation(t,Ce.LEFT),u=s.getLocation(t,Ce.RIGHT);if(a===u)return!1;if(u!==r)return!1;r=a}return!0},zn.prototype.findIndex=function(t){this.iterator();for(var e=0;e<this._edgeList.size();e++)if(this._edgeList.get(e)===t)return e;return-1},zn.prototype.iterator=function(){return this.getEdges().iterator()},zn.prototype.getEdges=function(){return null===this._edgeList&&(this._edgeList=new Nt(this._edgeMap.values())),this._edgeList},zn.prototype.getLocation=function(t,e,n){return this._ptInAreaLocation[t]===L.NONE&&(this._ptInAreaLocation[t]=kn.locate(e,n[t].getGeometry())),this._ptInAreaLocation[t]},zn.prototype.toString=function(){var t=new R;t.append("EdgeEndStar:   "+this.getCoordinate()),t.append("\\n");for(var e=this.iterator();e.hasNext();){var n=e.next();t.append(n),t.append("\\n")}return t.toString()},zn.prototype.computeEdgeEndLabels=function(t){for(var e=this.iterator();e.hasNext();)e.next().computeLabel(t)},zn.prototype.computeLabelling=function(t){this.computeEdgeEndLabels(t[0].getBoundaryNodeRule()),this.propagateSideLabels(0),this.propagateSideLabels(1);for(var e=[!1,!1],n=this.iterator();n.hasNext();)for(var i=n.next().getLabel(),r=0;r<2;r++)i.isLine(r)&&i.getLocation(r)===L.BOUNDARY&&(e[r]=!0);for(var o=this.iterator();o.hasNext();)for(var s=o.next(),a=s.getLabel(),u=0;u<2;u++)if(a.isAnyNull(u)){var l=L.NONE;if(e[u])l=L.EXTERIOR;else{var c=s.getCoordinate();l=this.getLocation(u,c,t)}a.setAllLocationsIfNull(u,l)}},zn.prototype.getDegree=function(){return this._edgeMap.size()},zn.prototype.insertEdgeEnd=function(t,e){this._edgeMap.put(t,e),this._edgeList=null},zn.prototype.interfaces_=function(){return[]},zn.prototype.getClass=function(){return zn};var Xn=function(t){function e(){t.call(this),this._resultAreaEdgeList=null,this._label=null,this._SCANNING_FOR_INCOMING=1,this._LINKING_TO_OUTGOING=2}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.linkResultDirectedEdges=function(){this.getResultAreaEdges();for(var t=null,e=null,n=this._SCANNING_FOR_INCOMING,i=0;i<this._resultAreaEdgeList.size();i++){var r=this._resultAreaEdgeList.get(i),o=r.getSym();if(r.getLabel().isArea())switch(null===t&&r.isInResult()&&(t=r),n){case this._SCANNING_FOR_INCOMING:if(!o.isInResult())continue;e=o,n=this._LINKING_TO_OUTGOING;break;case this._LINKING_TO_OUTGOING:if(!r.isInResult())continue;e.setNext(r),n=this._SCANNING_FOR_INCOMING}}if(n===this._LINKING_TO_OUTGOING){if(null===t)throw new Le("no outgoing dirEdge found",this.getCoordinate());et.isTrue(t.isInResult(),"unable to link last incoming dirEdge"),e.setNext(t)}},e.prototype.insert=function(t){this.insertEdgeEnd(t,t)},e.prototype.getRightmostEdge=function(){var t=this.getEdges(),e=t.size();if(e<1)return null;var n=t.get(0);if(1===e)return n;var i=t.get(e-1),r=n.getQuadrant(),o=i.getQuadrant();return Be.isNorthern(r)&&Be.isNorthern(o)?n:Be.isNorthern(r)||Be.isNorthern(o)?0!==n.getDy()?n:0!==i.getDy()?i:(et.shouldNeverReachHere("found two horizontal edges incident on node"),null):i},e.prototype.print=function(t){X.out.println("DirectedEdgeStar: "+this.getCoordinate());for(var e=this.iterator();e.hasNext();){var n=e.next();t.print("out "),n.print(t),t.println(),t.print("in "),n.getSym().print(t),t.println()}},e.prototype.getResultAreaEdges=function(){if(null!==this._resultAreaEdgeList)return this._resultAreaEdgeList;this._resultAreaEdgeList=new Nt;for(var t=this.iterator();t.hasNext();){var e=t.next();(e.isInResult()||e.getSym().isInResult())&&this._resultAreaEdgeList.add(e)}return this._resultAreaEdgeList},e.prototype.updateLabelling=function(t){for(var e=this.iterator();e.hasNext();){var n=e.next().getLabel();n.setAllLocationsIfNull(0,t.getLocation(0)),n.setAllLocationsIfNull(1,t.getLocation(1))}},e.prototype.linkAllDirectedEdges=function(){this.getEdges();for(var t=null,e=null,n=this._edgeList.size()-1;n>=0;n--){var i=this._edgeList.get(n),r=i.getSym();null===e&&(e=r),null!==t&&r.setNext(t),t=i}e.setNext(t)},e.prototype.computeDepths=function(){if(1===arguments.length){var t=arguments[0],e=this.findIndex(t),n=t.getDepth(Ce.LEFT),i=t.getDepth(Ce.RIGHT),r=this.computeDepths(e+1,this._edgeList.size(),n);if(this.computeDepths(0,e,r)!==i)throw new Le("depth mismatch at "+t.getCoordinate())}else if(3===arguments.length){for(var o=arguments[1],s=arguments[2],a=arguments[0];a<o;a++){var u=this._edgeList.get(a);u.setEdgeDepths(Ce.RIGHT,s),s=u.getDepth(Ce.LEFT)}return s}},e.prototype.mergeSymLabels=function(){for(var t=this.iterator();t.hasNext();){var e=t.next();e.getLabel().merge(e.getSym().getLabel())}},e.prototype.linkMinimalDirectedEdges=function(t){for(var e=null,n=null,i=this._SCANNING_FOR_INCOMING,r=this._resultAreaEdgeList.size()-1;r>=0;r--){var o=this._resultAreaEdgeList.get(r),s=o.getSym();switch(null===e&&o.getEdgeRing()===t&&(e=o),i){case this._SCANNING_FOR_INCOMING:if(s.getEdgeRing()!==t)continue;n=s,i=this._LINKING_TO_OUTGOING;break;case this._LINKING_TO_OUTGOING:if(o.getEdgeRing()!==t)continue;n.setNextMin(o),i=this._SCANNING_FOR_INCOMING}}i===this._LINKING_TO_OUTGOING&&(et.isTrue(null!==e,"found null for first outgoing dirEdge"),et.isTrue(e.getEdgeRing()===t,"unable to link last incoming dirEdge"),n.setNextMin(e))},e.prototype.getOutgoingDegree=function(){if(0===arguments.length){for(var t=0,e=this.iterator();e.hasNext();)e.next().isInResult()&&t++;return t}if(1===arguments.length){for(var n=arguments[0],i=0,r=this.iterator();r.hasNext();)r.next().getEdgeRing()===n&&i++;return i}},e.prototype.getLabel=function(){return this._label},e.prototype.findCoveredLineEdges=function(){for(var t=L.NONE,e=this.iterator();e.hasNext();){var n=e.next(),i=n.getSym();if(!n.isLineEdge()){if(n.isInResult()){t=L.INTERIOR;break}if(i.isInResult()){t=L.EXTERIOR;break}}}if(t===L.NONE)return null;for(var r=t,o=this.iterator();o.hasNext();){var s=o.next(),a=s.getSym();s.isLineEdge()?s.getEdge().setCovered(r===L.INTERIOR):(s.isInResult()&&(r=L.EXTERIOR),a.isInResult()&&(r=L.INTERIOR))}},e.prototype.computeLabelling=function(e){t.prototype.computeLabelling.call(this,e),this._label=new Me(L.NONE);for(var n=this.iterator();n.hasNext();)for(var i=n.next().getEdge().getLabel(),r=0;r<2;r++){var o=i.getLocation(r);o!==L.INTERIOR&&o!==L.BOUNDARY||this._label.setLocation(r,L.INTERIOR)}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(zn),Yn=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.createNode=function(t){return new Ge(t,new Xn)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(ze),jn=function t(){this._pts=null,this._orientation=null;var e=arguments[0];this._pts=e,this._orientation=t.orientation(e)};jn.prototype.compareTo=function(t){return jn.compareOriented(this._pts,this._orientation,t._pts,t._orientation)},jn.prototype.interfaces_=function(){return[I]},jn.prototype.getClass=function(){return jn},jn.orientation=function(t){return 1===St.increasingDirection(t)},jn.compareOriented=function(t,e,n,i){for(var r=e?1:-1,o=i?1:-1,s=e?t.length:-1,a=i?n.length:-1,u=e?0:t.length-1,l=i?0:n.length-1;;){var c=t[u].compareTo(n[l]);if(0!==c)return c;var h=(u+=r)===s,p=(l+=o)===a;if(h&&!p)return-1;if(!h&&p)return 1;if(h&&p)return 0}};var Hn=function(){this._edges=new Nt,this._ocaMap=new h};Hn.prototype.print=function(t){t.print("MULTILINESTRING ( ");for(var e=0;e<this._edges.size();e++){var n=this._edges.get(e);e>0&&t.print(","),t.print("(");for(var i=n.getCoordinates(),r=0;r<i.length;r++)r>0&&t.print(","),t.print(i[r].x+" "+i[r].y);t.println(")")}t.print(")  ")},Hn.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next())},Hn.prototype.findEdgeIndex=function(t){for(var e=0;e<this._edges.size();e++)if(this._edges.get(e).equals(t))return e;return-1},Hn.prototype.iterator=function(){return this._edges.iterator()},Hn.prototype.getEdges=function(){return this._edges},Hn.prototype.get=function(t){return this._edges.get(t)},Hn.prototype.findEqualEdge=function(t){var e=new jn(t.getCoordinates());return this._ocaMap.get(e)},Hn.prototype.add=function(t){this._edges.add(t);var e=new jn(t.getCoordinates());this._ocaMap.put(e,t)},Hn.prototype.interfaces_=function(){return[]},Hn.prototype.getClass=function(){return Hn};var Wn=function(){};Wn.prototype.processIntersections=function(t,e,n,i){},Wn.prototype.isDone=function(){},Wn.prototype.interfaces_=function(){return[]},Wn.prototype.getClass=function(){return Wn};var Jn=function(){this._hasIntersection=!1,this._hasProper=!1,this._hasProperInterior=!1,this._hasInterior=!1,this._properIntersectionPoint=null,this._li=null,this._isSelfIntersection=null,this.numIntersections=0,this.numInteriorIntersections=0,this.numProperIntersections=0,this.numTests=0,this._li=arguments[0]};Jn.prototype.isTrivialIntersection=function(t,e,n,i){if(t===n&&1===this._li.getIntersectionNum()){if(Jn.isAdjacentSegments(e,i))return!0;if(t.isClosed()){var r=t.size()-1;if(0===e&&i===r||0===i&&e===r)return!0}}return!1},Jn.prototype.getProperIntersectionPoint=function(){return this._properIntersectionPoint},Jn.prototype.hasProperInteriorIntersection=function(){return this._hasProperInterior},Jn.prototype.getLineIntersector=function(){return this._li},Jn.prototype.hasProperIntersection=function(){return this._hasProper},Jn.prototype.processIntersections=function(t,e,n,i){if(t===n&&e===i)return null;this.numTests++;var r=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[i],a=n.getCoordinates()[i+1];this._li.computeIntersection(r,o,s,a),this._li.hasIntersection()&&(this.numIntersections++,this._li.isInteriorIntersection()&&(this.numInteriorIntersections++,this._hasInterior=!0),this.isTrivialIntersection(t,e,n,i)||(this._hasIntersection=!0,t.addIntersections(this._li,e,0),n.addIntersections(this._li,i,1),this._li.isProper()&&(this.numProperIntersections++,this._hasProper=!0,this._hasProperInterior=!0)))},Jn.prototype.hasIntersection=function(){return this._hasIntersection},Jn.prototype.isDone=function(){return!1},Jn.prototype.hasInteriorIntersection=function(){return this._hasInterior},Jn.prototype.interfaces_=function(){return[Wn]},Jn.prototype.getClass=function(){return Jn},Jn.isAdjacentSegments=function(t,e){return 1===Math.abs(t-e)};var Kn=function(){this.coord=null,this.segmentIndex=null,this.dist=null;var t=arguments[1],e=arguments[2];this.coord=new w(arguments[0]),this.segmentIndex=t,this.dist=e};Kn.prototype.getSegmentIndex=function(){return this.segmentIndex},Kn.prototype.getCoordinate=function(){return this.coord},Kn.prototype.print=function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex),t.println(" dist = "+this.dist)},Kn.prototype.compareTo=function(t){return this.compare(t.segmentIndex,t.dist)},Kn.prototype.isEndPoint=function(t){return 0===this.segmentIndex&&0===this.dist||this.segmentIndex===t},Kn.prototype.toString=function(){return this.coord+" seg # = "+this.segmentIndex+" dist = "+this.dist},Kn.prototype.getDistance=function(){return this.dist},Kn.prototype.compare=function(t,e){return this.segmentIndex<t?-1:this.segmentIndex>t?1:this.dist<e?-1:this.dist>e?1:0},Kn.prototype.interfaces_=function(){return[I]},Kn.prototype.getClass=function(){return Kn};var Qn=function(){this._nodeMap=new h,this.edge=null,this.edge=arguments[0]};Qn.prototype.print=function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();)e.next().print(t)},Qn.prototype.iterator=function(){return this._nodeMap.values().iterator()},Qn.prototype.addSplitEdges=function(t){this.addEndpoints();for(var e=this.iterator(),n=e.next();e.hasNext();){var i=e.next(),r=this.createSplitEdge(n,i);t.add(r),n=i}},Qn.prototype.addEndpoints=function(){var t=this.edge.pts.length-1;this.add(this.edge.pts[0],0,0),this.add(this.edge.pts[t],t,0)},Qn.prototype.createSplitEdge=function(t,e){var n=e.segmentIndex-t.segmentIndex+2,i=e.dist>0||!e.coord.equals2D(this.edge.pts[e.segmentIndex]);i||n--;var r=new Array(n).fill(null),o=0;r[o++]=new w(t.coord);for(var s=t.segmentIndex+1;s<=e.segmentIndex;s++)r[o++]=this.edge.pts[s];return i&&(r[o]=e.coord),new ni(r,new Me(this.edge._label))},Qn.prototype.add=function(t,e,n){var i=new Kn(t,e,n),r=this._nodeMap.get(i);return null!==r?r:(this._nodeMap.put(i,i),i)},Qn.prototype.isIntersection=function(t){for(var e=this.iterator();e.hasNext();)if(e.next().coord.equals(t))return!0;return!1},Qn.prototype.interfaces_=function(){return[]},Qn.prototype.getClass=function(){return Qn};var $n=function(){};$n.prototype.getChainStartIndices=function(t){var e=0,n=new Nt;n.add(new D(e));do{var i=this.findChainEnd(t,e);n.add(new D(i)),e=i}while(e<t.length-1);return $n.toIntArray(n)},$n.prototype.findChainEnd=function(t,e){for(var n=Be.quadrant(t[e],t[e+1]),i=e+1;i<t.length&&Be.quadrant(t[i-1],t[i])===n;)i++;return i-1},$n.prototype.interfaces_=function(){return[]},$n.prototype.getClass=function(){return $n},$n.toIntArray=function(t){for(var e=new Array(t.size()).fill(null),n=0;n<e.length;n++)e[n]=t.get(n).intValue();return e};var Zn=function(){this.e=null,this.pts=null,this.startIndex=null,this.env1=new j,this.env2=new j;var t=arguments[0];this.e=t,this.pts=t.getCoordinates();var e=new $n;this.startIndex=e.getChainStartIndices(this.pts)};Zn.prototype.getCoordinates=function(){return this.pts},Zn.prototype.getMaxX=function(t){var e=this.pts[this.startIndex[t]].x,n=this.pts[this.startIndex[t+1]].x;return e>n?e:n},Zn.prototype.getMinX=function(t){var e=this.pts[this.startIndex[t]].x,n=this.pts[this.startIndex[t+1]].x;return e<n?e:n},Zn.prototype.computeIntersectsForChain=function(){if(4===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2];this.computeIntersectsForChain(this.startIndex[t],this.startIndex[t+1],e,e.startIndex[n],e.startIndex[n+1],arguments[3])}else if(6===arguments.length){var i=arguments[0],r=arguments[1],o=arguments[2],s=arguments[3],a=arguments[4],u=arguments[5],l=this.pts[i],c=this.pts[r],h=o.pts[s],p=o.pts[a];if(r-i==1&&a-s==1)return u.addIntersections(this.e,i,o.e,s),null;if(this.env1.init(l,c),this.env2.init(h,p),!this.env1.intersects(this.env2))return null;var f=Math.trunc((i+r)/2),g=Math.trunc((s+a)/2);i<f&&(s<g&&this.computeIntersectsForChain(i,f,o,s,g,u),g<a&&this.computeIntersectsForChain(i,f,o,g,a,u)),f<r&&(s<g&&this.computeIntersectsForChain(f,r,o,s,g,u),g<a&&this.computeIntersectsForChain(f,r,o,g,a,u))}},Zn.prototype.getStartIndexes=function(){return this.startIndex},Zn.prototype.computeIntersects=function(t,e){for(var n=0;n<this.startIndex.length-1;n++)for(var i=0;i<t.startIndex.length-1;i++)this.computeIntersectsForChain(n,t,i,e)},Zn.prototype.interfaces_=function(){return[]},Zn.prototype.getClass=function(){return Zn};var ti=function t(){this._depth=Array(2).fill().map((function(){return Array(3)}));for(var e=0;e<2;e++)for(var n=0;n<3;n++)this._depth[e][n]=t.NULL_VALUE},ei={NULL_VALUE:{configurable:!0}};ti.prototype.getDepth=function(t,e){return this._depth[t][e]},ti.prototype.setDepth=function(t,e,n){this._depth[t][e]=n},ti.prototype.isNull=function(){if(0===arguments.length){for(var t=0;t<2;t++)for(var e=0;e<3;e++)if(this._depth[t][e]!==ti.NULL_VALUE)return!1;return!0}return 1===arguments.length?this._depth[arguments[0]][1]===ti.NULL_VALUE:2===arguments.length?this._depth[arguments[0]][arguments[1]]===ti.NULL_VALUE:void 0},ti.prototype.normalize=function(){for(var t=0;t<2;t++)if(!this.isNull(t)){var e=this._depth[t][1];this._depth[t][2]<e&&(e=this._depth[t][2]),e<0&&(e=0);for(var n=1;n<3;n++){var i=0;this._depth[t][n]>e&&(i=1),this._depth[t][n]=i}}},ti.prototype.getDelta=function(t){return this._depth[t][Ce.RIGHT]-this._depth[t][Ce.LEFT]},ti.prototype.getLocation=function(t,e){return this._depth[t][e]<=0?L.EXTERIOR:L.INTERIOR},ti.prototype.toString=function(){return"A: "+this._depth[0][1]+","+this._depth[0][2]+" B: "+this._depth[1][1]+","+this._depth[1][2]},ti.prototype.add=function(){if(1===arguments.length)for(var t=arguments[0],e=0;e<2;e++)for(var n=1;n<3;n++){var i=t.getLocation(e,n);i!==L.EXTERIOR&&i!==L.INTERIOR||(this.isNull(e,n)?this._depth[e][n]=ti.depthAtLocation(i):this._depth[e][n]+=ti.depthAtLocation(i))}else 3===arguments.length&&arguments[2]===L.INTERIOR&&this._depth[arguments[0]][arguments[1]]++},ti.prototype.interfaces_=function(){return[]},ti.prototype.getClass=function(){return ti},ti.depthAtLocation=function(t){return t===L.EXTERIOR?0:t===L.INTERIOR?1:ti.NULL_VALUE},ei.NULL_VALUE.get=function(){return-1},Object.defineProperties(ti,ei);var ni=function(t){function e(){if(t.call(this),this.pts=null,this._env=null,this.eiList=new Qn(this),this._name=null,this._mce=null,this._isIsolated=!0,this._depth=new ti,this._depthDelta=0,1===arguments.length)e.call(this,arguments[0],null);else if(2===arguments.length){var n=arguments[1];this.pts=arguments[0],this._label=n}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getDepth=function(){return this._depth},e.prototype.getCollapsedEdge=function(){var t=new Array(2).fill(null);return t[0]=this.pts[0],t[1]=this.pts[1],new e(t,Me.toLineLabel(this._label))},e.prototype.isIsolated=function(){return this._isIsolated},e.prototype.getCoordinates=function(){return this.pts},e.prototype.setIsolated=function(t){this._isIsolated=t},e.prototype.setName=function(t){this._name=t},e.prototype.equals=function(t){if(!(t instanceof e))return!1;var n=t;if(this.pts.length!==n.pts.length)return!1;for(var i=!0,r=!0,o=this.pts.length,s=0;s<this.pts.length;s++)if(this.pts[s].equals2D(n.pts[s])||(i=!1),this.pts[s].equals2D(n.pts[--o])||(r=!1),!i&&!r)return!1;return!0},e.prototype.getCoordinate=function(){return 0===arguments.length?this.pts.length>0?this.pts[0]:null:1===arguments.length?this.pts[arguments[0]]:void 0},e.prototype.print=function(t){t.print("edge "+this._name+": "),t.print("LINESTRING (");for(var e=0;e<this.pts.length;e++)e>0&&t.print(","),t.print(this.pts[e].x+" "+this.pts[e].y);t.print(")  "+this._label+" "+this._depthDelta)},e.prototype.computeIM=function(t){e.updateIM(this._label,t)},e.prototype.isCollapsed=function(){return!!this._label.isArea()&&3===this.pts.length&&!!this.pts[0].equals(this.pts[2])},e.prototype.isClosed=function(){return this.pts[0].equals(this.pts[this.pts.length-1])},e.prototype.getMaximumSegmentIndex=function(){return this.pts.length-1},e.prototype.getDepthDelta=function(){return this._depthDelta},e.prototype.getNumPoints=function(){return this.pts.length},e.prototype.printReverse=function(t){t.print("edge "+this._name+": ");for(var e=this.pts.length-1;e>=0;e--)t.print(this.pts[e]+" ");t.println("")},e.prototype.getMonotoneChainEdge=function(){return null===this._mce&&(this._mce=new Zn(this)),this._mce},e.prototype.getEnvelope=function(){if(null===this._env){this._env=new j;for(var t=0;t<this.pts.length;t++)this._env.expandToInclude(this.pts[t])}return this._env},e.prototype.addIntersection=function(t,e,n,i){var r=new w(t.getIntersection(i)),o=e,s=t.getEdgeDistance(n,i),a=o+1;a<this.pts.length&&r.equals2D(this.pts[a])&&(o=a,s=0),this.eiList.add(r,o,s)},e.prototype.toString=function(){var t=new R;t.append("edge "+this._name+": "),t.append("LINESTRING (");for(var e=0;e<this.pts.length;e++)e>0&&t.append(","),t.append(this.pts[e].x+" "+this.pts[e].y);return t.append(")  "+this._label+" "+this._depthDelta),t.toString()},e.prototype.isPointwiseEqual=function(t){if(this.pts.length!==t.pts.length)return!1;for(var e=0;e<this.pts.length;e++)if(!this.pts[e].equals2D(t.pts[e]))return!1;return!0},e.prototype.setDepthDelta=function(t){this._depthDelta=t},e.prototype.getEdgeIntersectionList=function(){return this.eiList},e.prototype.addIntersections=function(t,e,n){for(var i=0;i<t.getIntersectionNum();i++)this.addIntersection(t,e,n,i)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.updateIM=function(){if(2!==arguments.length)return t.prototype.updateIM.apply(this,arguments);var e=arguments[0],n=arguments[1];n.setAtLeastIfValid(e.getLocation(0,Ce.ON),e.getLocation(1,Ce.ON),1),e.isArea()&&(n.setAtLeastIfValid(e.getLocation(0,Ce.LEFT),e.getLocation(1,Ce.LEFT),2),n.setAtLeastIfValid(e.getLocation(0,Ce.RIGHT),e.getLocation(1,Ce.RIGHT),2))},e}(Fe),ii=function(t){this._workingPrecisionModel=null,this._workingNoder=null,this._geomFact=null,this._graph=null,this._edgeList=new Hn,this._bufParams=t||null};ii.prototype.setWorkingPrecisionModel=function(t){this._workingPrecisionModel=t},ii.prototype.insertUniqueEdge=function(t){var e=this._edgeList.findEqualEdge(t);if(null!==e){var n=e.getLabel(),i=t.getLabel();e.isPointwiseEqual(t)||(i=new Me(t.getLabel())).flip(),n.merge(i);var r=ii.depthDelta(i),o=e.getDepthDelta()+r;e.setDepthDelta(o)}else this._edgeList.add(t),t.setDepthDelta(ii.depthDelta(t.getLabel()))},ii.prototype.buildSubgraphs=function(t,e){for(var n=new Nt,i=t.iterator();i.hasNext();){var r=i.next(),o=r.getRightmostCoordinate(),s=new An(n).getDepth(o);r.computeDepth(s),r.findResultEdges(),n.add(r),e.add(r.getDirectedEdges(),r.getNodes())}},ii.prototype.createSubgraphs=function(t){for(var e=new Nt,n=t.getNodes().iterator();n.hasNext();){var i=n.next();if(!i.isVisited()){var r=new Pe;r.create(i),e.add(r)}}return Ze.sort(e,Ze.reverseOrder()),e},ii.prototype.createEmptyResultGeometry=function(){return this._geomFact.createPolygon()},ii.prototype.getNoder=function(t){if(null!==this._workingNoder)return this._workingNoder;var e=new En,n=new rt;return n.setPrecisionModel(t),e.setSegmentIntersector(new Jn(n)),e},ii.prototype.buffer=function(t,e){var n=this._workingPrecisionModel;null===n&&(n=t.getPrecisionModel()),this._geomFact=t.getFactory();var i=new Dn(n,this._bufParams),r=new Bn(t,e,i).getCurves();if(r.size()<=0)return this.createEmptyResultGeometry();this.computeNodedEdges(r,n),this._graph=new Xe(new Yn),this._graph.addEdges(this._edgeList.getEdges());var o=this.createSubgraphs(this._graph),s=new Ye(this._geomFact);this.buildSubgraphs(o,s);var a=s.getPolygons();return a.size()<=0?this.createEmptyResultGeometry():this._geomFact.buildGeometry(a)},ii.prototype.computeNodedEdges=function(t,e){var n=this.getNoder(e);n.computeNodes(t);for(var i=n.getNodedSubstrings().iterator();i.hasNext();){var r=i.next(),o=r.getCoordinates();if(2!==o.length||!o[0].equals2D(o[1])){var s=r.getData(),a=new ni(r.getCoordinates(),new Me(s));this.insertUniqueEdge(a)}}},ii.prototype.setNoder=function(t){this._workingNoder=t},ii.prototype.interfaces_=function(){return[]},ii.prototype.getClass=function(){return ii},ii.depthDelta=function(t){var e=t.getLocation(0,Ce.LEFT),n=t.getLocation(0,Ce.RIGHT);return e===L.INTERIOR&&n===L.EXTERIOR?1:e===L.EXTERIOR&&n===L.INTERIOR?-1:0},ii.convertSegStrings=function(t){for(var e=new _e,n=new Nt;t.hasNext();){var i=t.next(),r=e.createLineString(i.getCoordinates());n.add(r)}return e.buildGeometry(n)};var ri=function(){if(this._noder=null,this._scaleFactor=null,this._offsetX=null,this._offsetY=null,this._isScaled=!1,2===arguments.length){var t=arguments[1];this._noder=arguments[0],this._scaleFactor=t,this._offsetX=0,this._offsetY=0,this._isScaled=!this.isIntegerPrecision()}else if(4===arguments.length){var e=arguments[1],n=arguments[2],i=arguments[3];this._noder=arguments[0],this._scaleFactor=e,this._offsetX=n,this._offsetY=i,this._isScaled=!this.isIntegerPrecision()}};ri.prototype.rescale=function(){if(P(arguments[0],xt))for(var t=arguments[0].iterator();t.hasNext();){var e=t.next();this.rescale(e.getCoordinates())}else if(arguments[0]instanceof Array){for(var n=arguments[0],i=0;i<n.length;i++)n[i].x=n[i].x/this._scaleFactor+this._offsetX,n[i].y=n[i].y/this._scaleFactor+this._offsetY;2===n.length&&n[0].equals2D(n[1])&&X.out.println(n)}},ri.prototype.scale=function(){if(P(arguments[0],xt)){for(var t=arguments[0],e=new Nt,n=t.iterator();n.hasNext();){var i=n.next();e.add(new gn(this.scale(i.getCoordinates()),i.getData()))}return e}if(arguments[0]instanceof Array){for(var r=arguments[0],o=new Array(r.length).fill(null),s=0;s<r.length;s++)o[s]=new w(Math.round((r[s].x-this._offsetX)*this._scaleFactor),Math.round((r[s].y-this._offsetY)*this._scaleFactor),r[s].z);return St.removeRepeatedPoints(o)}},ri.prototype.isIntegerPrecision=function(){return 1===this._scaleFactor},ri.prototype.getNodedSubstrings=function(){var t=this._noder.getNodedSubstrings();return this._isScaled&&this.rescale(t),t},ri.prototype.computeNodes=function(t){var e=t;this._isScaled&&(e=this.scale(t)),this._noder.computeNodes(e)},ri.prototype.interfaces_=function(){return[xn]},ri.prototype.getClass=function(){return ri};var oi=function(){this._li=new rt,this._segStrings=null,this._segStrings=arguments[0]},si={fact:{configurable:!0}};oi.prototype.checkEndPtVertexIntersections=function(){if(0===arguments.length)for(var t=this._segStrings.iterator();t.hasNext();){var e=t.next().getCoordinates();this.checkEndPtVertexIntersections(e[0],this._segStrings),this.checkEndPtVertexIntersections(e[e.length-1],this._segStrings)}else if(2===arguments.length)for(var n=arguments[0],i=arguments[1].iterator();i.hasNext();)for(var r=i.next().getCoordinates(),o=1;o<r.length-1;o++)if(r[o].equals(n))throw new Z("found endpt/interior pt intersection at index "+o+" :pt "+n)},oi.prototype.checkInteriorIntersections=function(){if(0===arguments.length)for(var t=this._segStrings.iterator();t.hasNext();)for(var e=t.next(),n=this._segStrings.iterator();n.hasNext();){var i=n.next();this.checkInteriorIntersections(e,i)}else if(2===arguments.length)for(var r=arguments[0],o=arguments[1],s=r.getCoordinates(),a=o.getCoordinates(),u=0;u<s.length-1;u++)for(var l=0;l<a.length-1;l++)this.checkInteriorIntersections(r,u,o,l);else if(4===arguments.length){var c=arguments[0],h=arguments[1],p=arguments[2],f=arguments[3];if(c===p&&h===f)return null;var g=c.getCoordinates()[h],d=c.getCoordinates()[h+1],y=p.getCoordinates()[f],_=p.getCoordinates()[f+1];if(this._li.computeIntersection(g,d,y,_),this._li.hasIntersection()&&(this._li.isProper()||this.hasInteriorIntersection(this._li,g,d)||this.hasInteriorIntersection(this._li,y,_)))throw new Z("found non-noded intersection at "+g+"-"+d+" and "+y+"-"+_)}},oi.prototype.checkValid=function(){this.checkEndPtVertexIntersections(),this.checkInteriorIntersections(),this.checkCollapses()},oi.prototype.checkCollapses=function(){if(0===arguments.length)for(var t=this._segStrings.iterator();t.hasNext();){var e=t.next();this.checkCollapses(e)}else if(1===arguments.length)for(var n=arguments[0].getCoordinates(),i=0;i<n.length-2;i++)this.checkCollapse(n[i],n[i+1],n[i+2])},oi.prototype.hasInteriorIntersection=function(t,e,n){for(var i=0;i<t.getIntersectionNum();i++){var r=t.getIntersection(i);if(!r.equals(e)&&!r.equals(n))return!0}return!1},oi.prototype.checkCollapse=function(t,e,n){if(t.equals(n))throw new Z("found non-noded collapse at "+oi.fact.createLineString([t,e,n]))},oi.prototype.interfaces_=function(){return[]},oi.prototype.getClass=function(){return oi},si.fact.get=function(){return new _e},Object.defineProperties(oi,si);var ai=function(){this._li=null,this._pt=null,this._originalPt=null,this._ptScaled=null,this._p0Scaled=null,this._p1Scaled=null,this._scaleFactor=null,this._minx=null,this._maxx=null,this._miny=null,this._maxy=null,this._corner=new Array(4).fill(null),this._safeEnv=null;var t=arguments[0],e=arguments[1],n=arguments[2];if(this._originalPt=t,this._pt=t,this._scaleFactor=e,this._li=n,e<=0)throw new m("Scale factor must be non-zero");1!==e&&(this._pt=new w(this.scale(t.x),this.scale(t.y)),this._p0Scaled=new w,this._p1Scaled=new w),this.initCorners(this._pt)},ui={SAFE_ENV_EXPANSION_FACTOR:{configurable:!0}};ai.prototype.intersectsScaled=function(t,e){var n=Math.min(t.x,e.x),i=Math.max(t.x,e.x),r=Math.min(t.y,e.y),o=Math.max(t.y,e.y),s=this._maxx<n||this._minx>i||this._maxy<r||this._miny>o;if(s)return!1;var a=this.intersectsToleranceSquare(t,e);return et.isTrue(!(s&&a),"Found bad envelope test"),a},ai.prototype.initCorners=function(t){this._minx=t.x-.5,this._maxx=t.x+.5,this._miny=t.y-.5,this._maxy=t.y+.5,this._corner[0]=new w(this._maxx,this._maxy),this._corner[1]=new w(this._minx,this._maxy),this._corner[2]=new w(this._minx,this._miny),this._corner[3]=new w(this._maxx,this._miny)},ai.prototype.intersects=function(t,e){return 1===this._scaleFactor?this.intersectsScaled(t,e):(this.copyScaled(t,this._p0Scaled),this.copyScaled(e,this._p1Scaled),this.intersectsScaled(this._p0Scaled,this._p1Scaled))},ai.prototype.scale=function(t){return Math.round(t*this._scaleFactor)},ai.prototype.getCoordinate=function(){return this._originalPt},ai.prototype.copyScaled=function(t,e){e.x=this.scale(t.x),e.y=this.scale(t.y)},ai.prototype.getSafeEnvelope=function(){if(null===this._safeEnv){var t=ai.SAFE_ENV_EXPANSION_FACTOR/this._scaleFactor;this._safeEnv=new j(this._originalPt.x-t,this._originalPt.x+t,this._originalPt.y-t,this._originalPt.y+t)}return this._safeEnv},ai.prototype.intersectsPixelClosure=function(t,e){return this._li.computeIntersection(t,e,this._corner[0],this._corner[1]),!!(this._li.hasIntersection()||(this._li.computeIntersection(t,e,this._corner[1],this._corner[2]),this._li.hasIntersection()||(this._li.computeIntersection(t,e,this._corner[2],this._corner[3]),this._li.hasIntersection()||(this._li.computeIntersection(t,e,this._corner[3],this._corner[0]),this._li.hasIntersection()))))},ai.prototype.intersectsToleranceSquare=function(t,e){var n=!1,i=!1;return this._li.computeIntersection(t,e,this._corner[0],this._corner[1]),!!(this._li.isProper()||(this._li.computeIntersection(t,e,this._corner[1],this._corner[2]),this._li.isProper()||(this._li.hasIntersection()&&(n=!0),this._li.computeIntersection(t,e,this._corner[2],this._corner[3]),this._li.isProper()||(this._li.hasIntersection()&&(i=!0),this._li.computeIntersection(t,e,this._corner[3],this._corner[0]),this._li.isProper()||n&&i||t.equals(this._pt)||e.equals(this._pt)))))},ai.prototype.addSnappedNode=function(t,e){var n=t.getCoordinate(e),i=t.getCoordinate(e+1);return!!this.intersects(n,i)&&(t.addIntersection(this.getCoordinate(),e),!0)},ai.prototype.interfaces_=function(){return[]},ai.prototype.getClass=function(){return ai},ui.SAFE_ENV_EXPANSION_FACTOR.get=function(){return.75},Object.defineProperties(ai,ui);var li=function(){this.tempEnv1=new j,this.selectedSegment=new dn};li.prototype.select=function(){1===arguments.length||2===arguments.length&&(arguments[0].getLineSegment(arguments[1],this.selectedSegment),this.select(this.selectedSegment))},li.prototype.interfaces_=function(){return[]},li.prototype.getClass=function(){return li};var ci=function(){this._index=null,this._index=arguments[0]},hi={HotPixelSnapAction:{configurable:!0}};ci.prototype.snap=function(){if(1===arguments.length)return this.snap(arguments[0],null,-1);if(3===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2],i=t.getSafeEnvelope(),r=new pi(t,e,n);return this._index.query(i,{interfaces_:function(){return[Je]},visitItem:function(t){t.select(i,r)}}),r.isNodeAdded()}},ci.prototype.interfaces_=function(){return[]},ci.prototype.getClass=function(){return ci},hi.HotPixelSnapAction.get=function(){return pi},Object.defineProperties(ci,hi);var pi=function(t){function e(){t.call(this),this._hotPixel=null,this._parentEdge=null,this._hotPixelVertexIndex=null,this._isNodeAdded=!1;var e=arguments[1],n=arguments[2];this._hotPixel=arguments[0],this._parentEdge=e,this._hotPixelVertexIndex=n}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isNodeAdded=function(){return this._isNodeAdded},e.prototype.select=function(){if(2!==arguments.length)return t.prototype.select.apply(this,arguments);var e=arguments[1],n=arguments[0].getContext();if(null!==this._parentEdge&&n===this._parentEdge&&e===this._hotPixelVertexIndex)return null;this._isNodeAdded=this._hotPixel.addSnappedNode(n,e)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(li),fi=function(){this._li=null,this._interiorIntersections=null,this._li=arguments[0],this._interiorIntersections=new Nt};fi.prototype.processIntersections=function(t,e,n,i){if(t===n&&e===i)return null;var r=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[i],a=n.getCoordinates()[i+1];if(this._li.computeIntersection(r,o,s,a),this._li.hasIntersection()&&this._li.isInteriorIntersection()){for(var u=0;u<this._li.getIntersectionNum();u++)this._interiorIntersections.add(this._li.getIntersection(u));t.addIntersections(this._li,e,0),n.addIntersections(this._li,i,1)}},fi.prototype.isDone=function(){return!1},fi.prototype.getInteriorIntersections=function(){return this._interiorIntersections},fi.prototype.interfaces_=function(){return[Wn]},fi.prototype.getClass=function(){return fi};var gi=function(){this._pm=null,this._li=null,this._scaleFactor=null,this._noder=null,this._pointSnapper=null,this._nodedSegStrings=null;var t=arguments[0];this._pm=t,this._li=new rt,this._li.setPrecisionModel(t),this._scaleFactor=t.getScale()};gi.prototype.checkCorrectness=function(t){var e=gn.getNodedSubstrings(t),n=new oi(e);try{n.checkValid()}catch(t){if(!(t instanceof k))throw t;t.printStackTrace()}},gi.prototype.getNodedSubstrings=function(){return gn.getNodedSubstrings(this._nodedSegStrings)},gi.prototype.snapRound=function(t,e){var n=this.findInteriorIntersections(t,e);this.computeIntersectionSnaps(n),this.computeVertexSnaps(t)},gi.prototype.findInteriorIntersections=function(t,e){var n=new fi(e);return this._noder.setSegmentIntersector(n),this._noder.computeNodes(t),n.getInteriorIntersections()},gi.prototype.computeVertexSnaps=function(){if(P(arguments[0],xt))for(var t=arguments[0].iterator();t.hasNext();){var e=t.next();this.computeVertexSnaps(e)}else if(arguments[0]instanceof gn)for(var n=arguments[0],i=n.getCoordinates(),r=0;r<i.length;r++){var o=new ai(i[r],this._scaleFactor,this._li);this._pointSnapper.snap(o,n,r)&&n.addIntersection(i[r],r)}},gi.prototype.computeNodes=function(t){this._nodedSegStrings=t,this._noder=new En,this._pointSnapper=new ci(this._noder.getIndex()),this.snapRound(t,this._li)},gi.prototype.computeIntersectionSnaps=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next(),i=new ai(n,this._scaleFactor,this._li);this._pointSnapper.snap(i)}},gi.prototype.interfaces_=function(){return[xn]},gi.prototype.getClass=function(){return gi};var di=function(){if(this._argGeom=null,this._distance=null,this._bufParams=new wn,this._resultGeometry=null,this._saveException=null,1===arguments.length)this._argGeom=arguments[0];else if(2===arguments.length){var t=arguments[1];this._argGeom=arguments[0],this._bufParams=t}},yi={CAP_ROUND:{configurable:!0},CAP_BUTT:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},MAX_PRECISION_DIGITS:{configurable:!0}};di.prototype.bufferFixedPrecision=function(t){var e=new ri(new gi(new fe(1)),t.getScale()),n=new ii(this._bufParams);n.setWorkingPrecisionModel(t),n.setNoder(e),this._resultGeometry=n.buffer(this._argGeom,this._distance)},di.prototype.bufferReducedPrecision=function(){var t=this;if(0===arguments.length){for(var e=di.MAX_PRECISION_DIGITS;e>=0;e--){try{t.bufferReducedPrecision(e)}catch(e){if(!(e instanceof Le))throw e;t._saveException=e}if(null!==t._resultGeometry)return null}throw this._saveException}if(1===arguments.length){var n=di.precisionScaleFactor(this._argGeom,this._distance,arguments[0]),i=new fe(n);this.bufferFixedPrecision(i)}},di.prototype.computeGeometry=function(){if(this.bufferOriginalPrecision(),null!==this._resultGeometry)return null;var t=this._argGeom.getFactory().getPrecisionModel();t.getType()===fe.FIXED?this.bufferFixedPrecision(t):this.bufferReducedPrecision()},di.prototype.setQuadrantSegments=function(t){this._bufParams.setQuadrantSegments(t)},di.prototype.bufferOriginalPrecision=function(){try{var t=new ii(this._bufParams);this._resultGeometry=t.buffer(this._argGeom,this._distance)}catch(t){if(!(t instanceof Z))throw t;this._saveException=t}},di.prototype.getResultGeometry=function(t){return this._distance=t,this.computeGeometry(),this._resultGeometry},di.prototype.setEndCapStyle=function(t){this._bufParams.setEndCapStyle(t)},di.prototype.interfaces_=function(){return[]},di.prototype.getClass=function(){return di},di.bufferOp=function(){if(2===arguments.length){var t=arguments[1];return new di(arguments[0]).getResultGeometry(t)}if(3===arguments.length){if(Number.isInteger(arguments[2])&&arguments[0]instanceof ct&&"number"==typeof arguments[1]){var e=arguments[1],n=arguments[2],i=new di(arguments[0]);return i.setQuadrantSegments(n),i.getResultGeometry(e)}if(arguments[2]instanceof wn&&arguments[0]instanceof ct&&"number"==typeof arguments[1]){var r=arguments[1];return new di(arguments[0],arguments[2]).getResultGeometry(r)}}else if(4===arguments.length){var o=arguments[1],s=arguments[2],a=arguments[3],u=new di(arguments[0]);return u.setQuadrantSegments(s),u.setEndCapStyle(a),u.getResultGeometry(o)}},di.precisionScaleFactor=function(t,e,n){var i=t.getEnvelopeInternal(),r=T.max(Math.abs(i.getMaxX()),Math.abs(i.getMaxY()),Math.abs(i.getMinX()),Math.abs(i.getMinY()))+2*(e>0?e:0),o=n-Math.trunc(Math.log(r)/Math.log(10)+1);return Math.pow(10,o)},yi.CAP_ROUND.get=function(){return wn.CAP_ROUND},yi.CAP_BUTT.get=function(){return wn.CAP_FLAT},yi.CAP_FLAT.get=function(){return wn.CAP_FLAT},yi.CAP_SQUARE.get=function(){return wn.CAP_SQUARE},yi.MAX_PRECISION_DIGITS.get=function(){return 12},Object.defineProperties(di,yi);var _i=function(){this._pt=[new w,new w],this._distance=v.NaN,this._isNull=!0};_i.prototype.getCoordinates=function(){return this._pt},_i.prototype.getCoordinate=function(t){return this._pt[t]},_i.prototype.setMinimum=function(){if(1===arguments.length){var t=arguments[0];this.setMinimum(t._pt[0],t._pt[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this._isNull)return this.initialize(e,n),null;var i=e.distance(n);i<this._distance&&this.initialize(e,n,i)}},_i.prototype.initialize=function(){if(0===arguments.length)this._isNull=!0;else if(2===arguments.length){var t=arguments[0],e=arguments[1];this._pt[0].setCoordinate(t),this._pt[1].setCoordinate(e),this._distance=t.distance(e),this._isNull=!1}else if(3===arguments.length){var n=arguments[1],i=arguments[2];this._pt[0].setCoordinate(arguments[0]),this._pt[1].setCoordinate(n),this._distance=i,this._isNull=!1}},_i.prototype.getDistance=function(){return this._distance},_i.prototype.setMaximum=function(){if(1===arguments.length){var t=arguments[0];this.setMaximum(t._pt[0],t._pt[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this._isNull)return this.initialize(e,n),null;var i=e.distance(n);i>this._distance&&this.initialize(e,n,i)}},_i.prototype.interfaces_=function(){return[]},_i.prototype.getClass=function(){return _i};var mi=function(){};mi.prototype.interfaces_=function(){return[]},mi.prototype.getClass=function(){return mi},mi.computeDistance=function(){if(arguments[2]instanceof _i&&arguments[0]instanceof Jt&&arguments[1]instanceof w)for(var t=arguments[1],e=arguments[2],n=arguments[0].getCoordinates(),i=new dn,r=0;r<n.length-1;r++){i.setCoordinates(n[r],n[r+1]);var o=i.closestPoint(t);e.setMinimum(o,t)}else if(arguments[2]instanceof _i&&arguments[0]instanceof Zt&&arguments[1]instanceof w){var s=arguments[0],a=arguments[1],u=arguments[2];mi.computeDistance(s.getExteriorRing(),a,u);for(var l=0;l<s.getNumInteriorRing();l++)mi.computeDistance(s.getInteriorRingN(l),a,u)}else if(arguments[2]instanceof _i&&arguments[0]instanceof ct&&arguments[1]instanceof w){var c=arguments[0],h=arguments[1],p=arguments[2];if(c instanceof Jt)mi.computeDistance(c,h,p);else if(c instanceof Zt)mi.computeDistance(c,h,p);else if(c instanceof kt)for(var f=c,g=0;g<f.getNumGeometries();g++){var d=f.getGeometryN(g);mi.computeDistance(d,h,p)}else p.setMinimum(c.getCoordinate(),h)}else if(arguments[2]instanceof _i&&arguments[0]instanceof dn&&arguments[1]instanceof w){var y=arguments[1],_=arguments[2],m=arguments[0].closestPoint(y);_.setMinimum(m,y)}};var vi=function(t){this._maxPtDist=new _i,this._inputGeom=t||null},xi={MaxPointDistanceFilter:{configurable:!0},MaxMidpointDistanceFilter:{configurable:!0}};vi.prototype.computeMaxMidpointDistance=function(t){var e=new Ei(this._inputGeom);t.apply(e),this._maxPtDist.setMaximum(e.getMaxPointDistance())},vi.prototype.computeMaxVertexDistance=function(t){var e=new Ii(this._inputGeom);t.apply(e),this._maxPtDist.setMaximum(e.getMaxPointDistance())},vi.prototype.findDistance=function(t){return this.computeMaxVertexDistance(t),this.computeMaxMidpointDistance(t),this._maxPtDist.getDistance()},vi.prototype.getDistancePoints=function(){return this._maxPtDist},vi.prototype.interfaces_=function(){return[]},vi.prototype.getClass=function(){return vi},xi.MaxPointDistanceFilter.get=function(){return Ii},xi.MaxMidpointDistanceFilter.get=function(){return Ei},Object.defineProperties(vi,xi);var Ii=function(t){this._maxPtDist=new _i,this._minPtDist=new _i,this._geom=t||null};Ii.prototype.filter=function(t){this._minPtDist.initialize(),mi.computeDistance(this._geom,t,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)},Ii.prototype.getMaxPointDistance=function(){return this._maxPtDist},Ii.prototype.interfaces_=function(){return[ft]},Ii.prototype.getClass=function(){return Ii};var Ei=function(t){this._maxPtDist=new _i,this._minPtDist=new _i,this._geom=t||null};Ei.prototype.filter=function(t,e){if(0===e)return null;var n=t.getCoordinate(e-1),i=t.getCoordinate(e),r=new w((n.x+i.x)/2,(n.y+i.y)/2);this._minPtDist.initialize(),mi.computeDistance(this._geom,r,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)},Ei.prototype.isDone=function(){return!1},Ei.prototype.isGeometryChanged=function(){return!1},Ei.prototype.getMaxPointDistance=function(){return this._maxPtDist},Ei.prototype.interfaces_=function(){return[Ut]},Ei.prototype.getClass=function(){return Ei};var Ni=function(t){this._comps=t||null};Ni.prototype.filter=function(t){t instanceof Zt&&this._comps.add(t)},Ni.prototype.interfaces_=function(){return[qt]},Ni.prototype.getClass=function(){return Ni},Ni.getPolygons=function(){if(1===arguments.length)return Ni.getPolygons(arguments[0],new Nt);if(2===arguments.length){var t=arguments[0],e=arguments[1];return t instanceof Zt?e.add(t):t instanceof kt&&t.apply(new Ni(e)),e}};var wi=function(){if(this._lines=null,this._isForcedToLineString=!1,1===arguments.length)this._lines=arguments[0];else if(2===arguments.length){var t=arguments[1];this._lines=arguments[0],this._isForcedToLineString=t}};wi.prototype.filter=function(t){if(this._isForcedToLineString&&t instanceof ee){var e=t.getFactory().createLineString(t.getCoordinateSequence());return this._lines.add(e),null}t instanceof Jt&&this._lines.add(t)},wi.prototype.setForceToLineString=function(t){this._isForcedToLineString=t},wi.prototype.interfaces_=function(){return[lt]},wi.prototype.getClass=function(){return wi},wi.getGeometry=function(){if(1===arguments.length){var t=arguments[0];return t.getFactory().buildGeometry(wi.getLines(t))}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e.getFactory().buildGeometry(wi.getLines(e,n))}},wi.getLines=function(){if(1===arguments.length)return wi.getLines(arguments[0],!1);if(2===arguments.length){if(P(arguments[0],xt)&&P(arguments[1],xt)){for(var t=arguments[1],e=arguments[0].iterator();e.hasNext();){var n=e.next();wi.getLines(n,t)}return t}if(arguments[0]instanceof ct&&"boolean"==typeof arguments[1]){var i=arguments[0],r=arguments[1],o=new Nt;return i.apply(new wi(o,r)),o}if(arguments[0]instanceof ct&&P(arguments[1],xt)){var s=arguments[0],a=arguments[1];return s instanceof Jt?a.add(s):s.apply(new wi(a)),a}}else if(3===arguments.length){if("boolean"==typeof arguments[2]&&P(arguments[0],xt)&&P(arguments[1],xt)){for(var u=arguments[1],l=arguments[2],c=arguments[0].iterator();c.hasNext();){var h=c.next();wi.getLines(h,u,l)}return u}if("boolean"==typeof arguments[2]&&arguments[0]instanceof ct&&P(arguments[1],xt)){var p=arguments[1];return arguments[0].apply(new wi(p,arguments[2])),p}}};var Ci=function(){if(this._boundaryRule=gt.OGC_SFS_BOUNDARY_RULE,this._isIn=null,this._numBoundaries=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];if(null===t)throw new m("Rule must be non-null");this._boundaryRule=t}};Ci.prototype.locateInternal=function(){if(arguments[0]instanceof w&&arguments[1]instanceof Zt){var t=arguments[0],e=arguments[1];if(e.isEmpty())return L.EXTERIOR;var n=e.getExteriorRing(),i=this.locateInPolygonRing(t,n);if(i===L.EXTERIOR)return L.EXTERIOR;if(i===L.BOUNDARY)return L.BOUNDARY;for(var r=0;r<e.getNumInteriorRing();r++){var o=e.getInteriorRingN(r),s=this.locateInPolygonRing(t,o);if(s===L.INTERIOR)return L.EXTERIOR;if(s===L.BOUNDARY)return L.BOUNDARY}return L.INTERIOR}if(arguments[0]instanceof w&&arguments[1]instanceof Jt){var a=arguments[0],u=arguments[1];if(!u.getEnvelopeInternal().intersects(a))return L.EXTERIOR;var l=u.getCoordinates();return u.isClosed()||!a.equals(l[0])&&!a.equals(l[l.length-1])?at.isOnLine(a,l)?L.INTERIOR:L.EXTERIOR:L.BOUNDARY}if(arguments[0]instanceof w&&arguments[1]instanceof Qt){var c=arguments[0];return arguments[1].getCoordinate().equals2D(c)?L.INTERIOR:L.EXTERIOR}},Ci.prototype.locateInPolygonRing=function(t,e){return e.getEnvelopeInternal().intersects(t)?at.locatePointInRing(t,e.getCoordinates()):L.EXTERIOR},Ci.prototype.intersects=function(t,e){return this.locate(t,e)!==L.EXTERIOR},Ci.prototype.updateLocationInfo=function(t){t===L.INTERIOR&&(this._isIn=!0),t===L.BOUNDARY&&this._numBoundaries++},Ci.prototype.computeLocation=function(t,e){if(e instanceof Qt&&this.updateLocationInfo(this.locateInternal(t,e)),e instanceof Jt)this.updateLocationInfo(this.locateInternal(t,e));else if(e instanceof Zt)this.updateLocationInfo(this.locateInternal(t,e));else if(e instanceof zt)for(var n=e,i=0;i<n.getNumGeometries();i++){var r=n.getGeometryN(i);this.updateLocationInfo(this.locateInternal(t,r))}else if(e instanceof ne)for(var o=e,s=0;s<o.getNumGeometries();s++){var a=o.getGeometryN(s);this.updateLocationInfo(this.locateInternal(t,a))}else if(e instanceof kt)for(var u=new Un(e);u.hasNext();){var l=u.next();l!==e&&this.computeLocation(t,l)}},Ci.prototype.locate=function(t,e){return e.isEmpty()?L.EXTERIOR:e instanceof Jt||e instanceof Zt?this.locateInternal(t,e):(this._isIn=!1,this._numBoundaries=0,this.computeLocation(t,e),this._boundaryRule.isInBoundary(this._numBoundaries)?L.BOUNDARY:this._numBoundaries>0||this._isIn?L.INTERIOR:L.EXTERIOR)},Ci.prototype.interfaces_=function(){return[]},Ci.prototype.getClass=function(){return Ci};var Si=function t(){if(this._component=null,this._segIndex=null,this._pt=null,2===arguments.length)t.call(this,arguments[0],t.INSIDE_AREA,arguments[1]);else if(3===arguments.length){var e=arguments[1],n=arguments[2];this._component=arguments[0],this._segIndex=e,this._pt=n}},bi={INSIDE_AREA:{configurable:!0}};Si.prototype.isInsideArea=function(){return this._segIndex===Si.INSIDE_AREA},Si.prototype.getCoordinate=function(){return this._pt},Si.prototype.getGeometryComponent=function(){return this._component},Si.prototype.getSegmentIndex=function(){return this._segIndex},Si.prototype.interfaces_=function(){return[]},Si.prototype.getClass=function(){return Si},bi.INSIDE_AREA.get=function(){return-1},Object.defineProperties(Si,bi);var Li=function(t){this._pts=t||null};Li.prototype.filter=function(t){t instanceof Qt&&this._pts.add(t)},Li.prototype.interfaces_=function(){return[qt]},Li.prototype.getClass=function(){return Li},Li.getPoints=function(){if(1===arguments.length){var t=arguments[0];return t instanceof Qt?Ze.singletonList(t):Li.getPoints(t,new Nt)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e instanceof Qt?n.add(e):e instanceof kt&&e.apply(new Li(n)),n}};var Oi=function(){this._locations=null,this._locations=arguments[0]};Oi.prototype.filter=function(t){(t instanceof Qt||t instanceof Jt||t instanceof Zt)&&this._locations.add(new Si(t,0,t.getCoordinate()))},Oi.prototype.interfaces_=function(){return[qt]},Oi.prototype.getClass=function(){return Oi},Oi.getLocations=function(t){var e=new Nt;return t.apply(new Oi(e)),e};var Pi=function(){if(this._geom=null,this._terminateDistance=0,this._ptLocator=new Ci,this._minDistanceLocation=null,this._minDistance=v.MAX_VALUE,2===arguments.length)this._geom=[arguments[0],arguments[1]],this._terminateDistance=0;else if(3===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2];this._geom=new Array(2).fill(null),this._geom[0]=t,this._geom[1]=e,this._terminateDistance=n}};Pi.prototype.computeContainmentDistance=function(){if(0===arguments.length){var t=new Array(2).fill(null);if(this.computeContainmentDistance(0,t),this._minDistance<=this._terminateDistance)return null;this.computeContainmentDistance(1,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1],i=1-e,r=Ni.getPolygons(this._geom[e]);if(r.size()>0){var o=Oi.getLocations(this._geom[i]);if(this.computeContainmentDistance(o,r,n),this._minDistance<=this._terminateDistance)return this._minDistanceLocation[i]=n[0],this._minDistanceLocation[e]=n[1],null}}else if(3===arguments.length)if(arguments[2]instanceof Array&&P(arguments[0],Et)&&P(arguments[1],Et)){for(var s=arguments[0],a=arguments[1],u=arguments[2],l=0;l<s.size();l++)for(var c=s.get(l),h=0;h<a.size();h++)if(this.computeContainmentDistance(c,a.get(h),u),this._minDistance<=this._terminateDistance)return null}else if(arguments[2]instanceof Array&&arguments[0]instanceof Si&&arguments[1]instanceof Zt){var p=arguments[0],f=arguments[1],g=arguments[2],d=p.getCoordinate();if(L.EXTERIOR!==this._ptLocator.locate(d,f))return this._minDistance=0,g[0]=p,g[1]=new Si(f,d),null}},Pi.prototype.computeMinDistanceLinesPoints=function(t,e,n){for(var i=0;i<t.size();i++)for(var r=t.get(i),o=0;o<e.size();o++){var s=e.get(o);if(this.computeMinDistance(r,s,n),this._minDistance<=this._terminateDistance)return null}},Pi.prototype.computeFacetDistance=function(){var t=new Array(2).fill(null),e=wi.getLines(this._geom[0]),n=wi.getLines(this._geom[1]),i=Li.getPoints(this._geom[0]),r=Li.getPoints(this._geom[1]);return this.computeMinDistanceLines(e,n,t),this.updateMinDistance(t,!1),this._minDistance<=this._terminateDistance?null:(t[0]=null,t[1]=null,this.computeMinDistanceLinesPoints(e,r,t),this.updateMinDistance(t,!1),this._minDistance<=this._terminateDistance?null:(t[0]=null,t[1]=null,this.computeMinDistanceLinesPoints(n,i,t),this.updateMinDistance(t,!0),this._minDistance<=this._terminateDistance?null:(t[0]=null,t[1]=null,this.computeMinDistancePoints(i,r,t),void this.updateMinDistance(t,!1))))},Pi.prototype.nearestLocations=function(){return this.computeMinDistance(),this._minDistanceLocation},Pi.prototype.updateMinDistance=function(t,e){if(null===t[0])return null;e?(this._minDistanceLocation[0]=t[1],this._minDistanceLocation[1]=t[0]):(this._minDistanceLocation[0]=t[0],this._minDistanceLocation[1]=t[1])},Pi.prototype.nearestPoints=function(){return this.computeMinDistance(),[this._minDistanceLocation[0].getCoordinate(),this._minDistanceLocation[1].getCoordinate()]},Pi.prototype.computeMinDistance=function(){if(0===arguments.length){if(null!==this._minDistanceLocation)return null;if(this._minDistanceLocation=new Array(2).fill(null),this.computeContainmentDistance(),this._minDistance<=this._terminateDistance)return null;this.computeFacetDistance()}else if(3===arguments.length)if(arguments[2]instanceof Array&&arguments[0]instanceof Jt&&arguments[1]instanceof Qt){var t=arguments[0],e=arguments[1],n=arguments[2];if(t.getEnvelopeInternal().distance(e.getEnvelopeInternal())>this._minDistance)return null;for(var i=t.getCoordinates(),r=e.getCoordinate(),o=0;o<i.length-1;o++){var s=at.distancePointLine(r,i[o],i[o+1]);if(s<this._minDistance){this._minDistance=s;var a=new dn(i[o],i[o+1]).closestPoint(r);n[0]=new Si(t,o,a),n[1]=new Si(e,0,r)}if(this._minDistance<=this._terminateDistance)return null}}else if(arguments[2]instanceof Array&&arguments[0]instanceof Jt&&arguments[1]instanceof Jt){var u=arguments[0],l=arguments[1],c=arguments[2];if(u.getEnvelopeInternal().distance(l.getEnvelopeInternal())>this._minDistance)return null;for(var h=u.getCoordinates(),p=l.getCoordinates(),f=0;f<h.length-1;f++)for(var g=0;g<p.length-1;g++){var d=at.distanceLineLine(h[f],h[f+1],p[g],p[g+1]);if(d<this._minDistance){this._minDistance=d;var y=new dn(h[f],h[f+1]),_=new dn(p[g],p[g+1]),m=y.closestPoints(_);c[0]=new Si(u,f,m[0]),c[1]=new Si(l,g,m[1])}if(this._minDistance<=this._terminateDistance)return null}}},Pi.prototype.computeMinDistancePoints=function(t,e,n){for(var i=0;i<t.size();i++)for(var r=t.get(i),o=0;o<e.size();o++){var s=e.get(o),a=r.getCoordinate().distance(s.getCoordinate());if(a<this._minDistance&&(this._minDistance=a,n[0]=new Si(r,0,r.getCoordinate()),n[1]=new Si(s,0,s.getCoordinate())),this._minDistance<=this._terminateDistance)return null}},Pi.prototype.distance=function(){if(null===this._geom[0]||null===this._geom[1])throw new m("null geometries are not supported");return this._geom[0].isEmpty()||this._geom[1].isEmpty()?0:(this.computeMinDistance(),this._minDistance)},Pi.prototype.computeMinDistanceLines=function(t,e,n){for(var i=0;i<t.size();i++)for(var r=t.get(i),o=0;o<e.size();o++){var s=e.get(o);if(this.computeMinDistance(r,s,n),this._minDistance<=this._terminateDistance)return null}},Pi.prototype.interfaces_=function(){return[]},Pi.prototype.getClass=function(){return Pi},Pi.distance=function(t,e){return new Pi(t,e).distance()},Pi.isWithinDistance=function(t,e,n){return new Pi(t,e,n).distance()<=n},Pi.nearestPoints=function(t,e){return new Pi(t,e).nearestPoints()};var Ti=function(){this._pt=[new w,new w],this._distance=v.NaN,this._isNull=!0};Ti.prototype.getCoordinates=function(){return this._pt},Ti.prototype.getCoordinate=function(t){return this._pt[t]},Ti.prototype.setMinimum=function(){if(1===arguments.length){var t=arguments[0];this.setMinimum(t._pt[0],t._pt[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this._isNull)return this.initialize(e,n),null;var i=e.distance(n);i<this._distance&&this.initialize(e,n,i)}},Ti.prototype.initialize=function(){if(0===arguments.length)this._isNull=!0;else if(2===arguments.length){var t=arguments[0],e=arguments[1];this._pt[0].setCoordinate(t),this._pt[1].setCoordinate(e),this._distance=t.distance(e),this._isNull=!1}else if(3===arguments.length){var n=arguments[1],i=arguments[2];this._pt[0].setCoordinate(arguments[0]),this._pt[1].setCoordinate(n),this._distance=i,this._isNull=!1}},Ti.prototype.toString=function(){return $.toLineString(this._pt[0],this._pt[1])},Ti.prototype.getDistance=function(){return this._distance},Ti.prototype.setMaximum=function(){if(1===arguments.length){var t=arguments[0];this.setMaximum(t._pt[0],t._pt[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this._isNull)return this.initialize(e,n),null;var i=e.distance(n);i>this._distance&&this.initialize(e,n,i)}},Ti.prototype.interfaces_=function(){return[]},Ti.prototype.getClass=function(){return Ti};var Mi=function(){};Mi.prototype.interfaces_=function(){return[]},Mi.prototype.getClass=function(){return Mi},Mi.computeDistance=function(){if(arguments[2]instanceof Ti&&arguments[0]instanceof Jt&&arguments[1]instanceof w)for(var t=arguments[0],e=arguments[1],n=arguments[2],i=new dn,r=t.getCoordinates(),o=0;o<r.length-1;o++){i.setCoordinates(r[o],r[o+1]);var s=i.closestPoint(e);n.setMinimum(s,e)}else if(arguments[2]instanceof Ti&&arguments[0]instanceof Zt&&arguments[1]instanceof w){var a=arguments[0],u=arguments[1],l=arguments[2];Mi.computeDistance(a.getExteriorRing(),u,l);for(var c=0;c<a.getNumInteriorRing();c++)Mi.computeDistance(a.getInteriorRingN(c),u,l)}else if(arguments[2]instanceof Ti&&arguments[0]instanceof ct&&arguments[1]instanceof w){var h=arguments[0],p=arguments[1],f=arguments[2];if(h instanceof Jt)Mi.computeDistance(h,p,f);else if(h instanceof Zt)Mi.computeDistance(h,p,f);else if(h instanceof kt)for(var g=h,d=0;d<g.getNumGeometries();d++){var y=g.getGeometryN(d);Mi.computeDistance(y,p,f)}else f.setMinimum(h.getCoordinate(),p)}else if(arguments[2]instanceof Ti&&arguments[0]instanceof dn&&arguments[1]instanceof w){var _=arguments[1],m=arguments[2],v=arguments[0].closestPoint(_);m.setMinimum(v,_)}};var Ri=function(){this._g0=null,this._g1=null,this._ptDist=new Ti,this._densifyFrac=0;var t=arguments[1];this._g0=arguments[0],this._g1=t},Di={MaxPointDistanceFilter:{configurable:!0},MaxDensifiedByFractionDistanceFilter:{configurable:!0}};Ri.prototype.getCoordinates=function(){return this._ptDist.getCoordinates()},Ri.prototype.setDensifyFraction=function(t){if(t>1||t<=0)throw new m("Fraction is not in range (0.0 - 1.0]");this._densifyFrac=t},Ri.prototype.compute=function(t,e){this.computeOrientedDistance(t,e,this._ptDist),this.computeOrientedDistance(e,t,this._ptDist)},Ri.prototype.distance=function(){return this.compute(this._g0,this._g1),this._ptDist.getDistance()},Ri.prototype.computeOrientedDistance=function(t,e,n){var i=new Ai(e);if(t.apply(i),n.setMaximum(i.getMaxPointDistance()),this._densifyFrac>0){var r=new Fi(e,this._densifyFrac);t.apply(r),n.setMaximum(r.getMaxPointDistance())}},Ri.prototype.orientedDistance=function(){return this.computeOrientedDistance(this._g0,this._g1,this._ptDist),this._ptDist.getDistance()},Ri.prototype.interfaces_=function(){return[]},Ri.prototype.getClass=function(){return Ri},Ri.distance=function(){if(2===arguments.length)return new Ri(arguments[0],arguments[1]).distance();if(3===arguments.length){var t=arguments[2],e=new Ri(arguments[0],arguments[1]);return e.setDensifyFraction(t),e.distance()}},Di.MaxPointDistanceFilter.get=function(){return Ai},Di.MaxDensifiedByFractionDistanceFilter.get=function(){return Fi},Object.defineProperties(Ri,Di);var Ai=function(){this._maxPtDist=new Ti,this._minPtDist=new Ti,this._euclideanDist=new Mi,this._geom=null,this._geom=arguments[0]};Ai.prototype.filter=function(t){this._minPtDist.initialize(),Mi.computeDistance(this._geom,t,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)},Ai.prototype.getMaxPointDistance=function(){return this._maxPtDist},Ai.prototype.interfaces_=function(){return[ft]},Ai.prototype.getClass=function(){return Ai};var Fi=function(){this._maxPtDist=new Ti,this._minPtDist=new Ti,this._geom=null,this._numSubSegs=0;var t=arguments[1];this._geom=arguments[0],this._numSubSegs=Math.trunc(Math.round(1/t))};Fi.prototype.filter=function(t,e){if(0===e)return null;for(var n=t.getCoordinate(e-1),i=t.getCoordinate(e),r=(i.x-n.x)/this._numSubSegs,o=(i.y-n.y)/this._numSubSegs,s=0;s<this._numSubSegs;s++){var a=new w(n.x+s*r,n.y+s*o);this._minPtDist.initialize(),Mi.computeDistance(this._geom,a,this._minPtDist),this._maxPtDist.setMaximum(this._minPtDist)}},Fi.prototype.isDone=function(){return!1},Fi.prototype.isGeometryChanged=function(){return!1},Fi.prototype.getMaxPointDistance=function(){return this._maxPtDist},Fi.prototype.interfaces_=function(){return[Ut]},Fi.prototype.getClass=function(){return Fi};var Gi=function(t,e,n){this._minValidDistance=null,this._maxValidDistance=null,this._minDistanceFound=null,this._maxDistanceFound=null,this._isValid=!0,this._errMsg=null,this._errorLocation=null,this._errorIndicator=null,this._input=t||null,this._bufDistance=e||null,this._result=n||null},Vi={VERBOSE:{configurable:!0},MAX_DISTANCE_DIFF_FRAC:{configurable:!0}};Gi.prototype.checkMaximumDistance=function(t,e,n){var i=new Ri(e,t);if(i.setDensifyFraction(.25),this._maxDistanceFound=i.orientedDistance(),this._maxDistanceFound>n){this._isValid=!1;var r=i.getCoordinates();this._errorLocation=r[1],this._errorIndicator=t.getFactory().createLineString(r),this._errMsg="Distance between buffer curve and input is too large ("+this._maxDistanceFound+" at "+$.toLineString(r[0],r[1])+")"}},Gi.prototype.isValid=function(){var t=Math.abs(this._bufDistance),e=Gi.MAX_DISTANCE_DIFF_FRAC*t;return this._minValidDistance=t-e,this._maxValidDistance=t+e,!(!this._input.isEmpty()&&!this._result.isEmpty())||(this._bufDistance>0?this.checkPositiveValid():this.checkNegativeValid(),Gi.VERBOSE&&X.out.println("Min Dist= "+this._minDistanceFound+"  err= "+(1-this._minDistanceFound/this._bufDistance)+"  Max Dist= "+this._maxDistanceFound+"  err= "+(this._maxDistanceFound/this._bufDistance-1)),this._isValid)},Gi.prototype.checkNegativeValid=function(){if(!(this._input instanceof Zt||this._input instanceof ne||this._input instanceof kt))return null;var t=this.getPolygonLines(this._input);if(this.checkMinimumDistance(t,this._result,this._minValidDistance),!this._isValid)return null;this.checkMaximumDistance(t,this._result,this._maxValidDistance)},Gi.prototype.getErrorIndicator=function(){return this._errorIndicator},Gi.prototype.checkMinimumDistance=function(t,e,n){var i=new Pi(t,e,n);if(this._minDistanceFound=i.distance(),this._minDistanceFound<n){this._isValid=!1;var r=i.nearestPoints();this._errorLocation=i.nearestPoints()[1],this._errorIndicator=t.getFactory().createLineString(r),this._errMsg="Distance between buffer curve and input is too small ("+this._minDistanceFound+" at "+$.toLineString(r[0],r[1])+" )"}},Gi.prototype.checkPositiveValid=function(){var t=this._result.getBoundary();if(this.checkMinimumDistance(this._input,t,this._minValidDistance),!this._isValid)return null;this.checkMaximumDistance(this._input,t,this._maxValidDistance)},Gi.prototype.getErrorLocation=function(){return this._errorLocation},Gi.prototype.getPolygonLines=function(t){for(var e=new Nt,n=new wi(e),i=Ni.getPolygons(t).iterator();i.hasNext();)i.next().apply(n);return t.getFactory().buildGeometry(e)},Gi.prototype.getErrorMessage=function(){return this._errMsg},Gi.prototype.interfaces_=function(){return[]},Gi.prototype.getClass=function(){return Gi},Vi.VERBOSE.get=function(){return!1},Vi.MAX_DISTANCE_DIFF_FRAC.get=function(){return.012},Object.defineProperties(Gi,Vi);var Bi=function(t,e,n){this._isValid=!0,this._errorMsg=null,this._errorLocation=null,this._errorIndicator=null,this._input=t||null,this._distance=e||null,this._result=n||null},qi={VERBOSE:{configurable:!0},MAX_ENV_DIFF_FRAC:{configurable:!0}};Bi.prototype.isValid=function(){return this.checkPolygonal(),this._isValid?(this.checkExpectedEmpty(),this._isValid?(this.checkEnvelope(),this._isValid?(this.checkArea(),this._isValid?(this.checkDistance(),this._isValid):this._isValid):this._isValid):this._isValid):this._isValid},Bi.prototype.checkEnvelope=function(){if(this._distance<0)return null;var t=this._distance*Bi.MAX_ENV_DIFF_FRAC;0===t&&(t=.001);var e=new j(this._input.getEnvelopeInternal());e.expandBy(this._distance);var n=new j(this._result.getEnvelopeInternal());n.expandBy(t),n.contains(e)||(this._isValid=!1,this._errorMsg="Buffer envelope is incorrect",this._errorIndicator=this._input.getFactory().toGeometry(n)),this.report("Envelope")},Bi.prototype.checkDistance=function(){var t=new Gi(this._input,this._distance,this._result);t.isValid()||(this._isValid=!1,this._errorMsg=t.getErrorMessage(),this._errorLocation=t.getErrorLocation(),this._errorIndicator=t.getErrorIndicator()),this.report("Distance")},Bi.prototype.checkArea=function(){var t=this._input.getArea(),e=this._result.getArea();this._distance>0&&t>e&&(this._isValid=!1,this._errorMsg="Area of positive buffer is smaller than input",this._errorIndicator=this._result),this._distance<0&&t<e&&(this._isValid=!1,this._errorMsg="Area of negative buffer is larger than input",this._errorIndicator=this._result),this.report("Area")},Bi.prototype.checkPolygonal=function(){this._result instanceof Zt||this._result instanceof ne||(this._isValid=!1),this._errorMsg="Result is not polygonal",this._errorIndicator=this._result,this.report("Polygonal")},Bi.prototype.getErrorIndicator=function(){return this._errorIndicator},Bi.prototype.getErrorLocation=function(){return this._errorLocation},Bi.prototype.checkExpectedEmpty=function(){return this._input.getDimension()>=2||this._distance>0?null:(this._result.isEmpty()||(this._isValid=!1,this._errorMsg="Result is non-empty",this._errorIndicator=this._result),void this.report("ExpectedEmpty"))},Bi.prototype.report=function(t){if(!Bi.VERBOSE)return null;X.out.println("Check "+t+": "+(this._isValid?"passed":"FAILED"))},Bi.prototype.getErrorMessage=function(){return this._errorMsg},Bi.prototype.interfaces_=function(){return[]},Bi.prototype.getClass=function(){return Bi},Bi.isValidMsg=function(t,e,n){var i=new Bi(t,e,n);return i.isValid()?null:i.getErrorMessage()},Bi.isValid=function(t,e,n){return!!new Bi(t,e,n).isValid()},qi.VERBOSE.get=function(){return!1},qi.MAX_ENV_DIFF_FRAC.get=function(){return.012},Object.defineProperties(Bi,qi);var Ui=function(){this._pts=null,this._data=null;var t=arguments[1];this._pts=arguments[0],this._data=t};Ui.prototype.getCoordinates=function(){return this._pts},Ui.prototype.size=function(){return this._pts.length},Ui.prototype.getCoordinate=function(t){return this._pts[t]},Ui.prototype.isClosed=function(){return this._pts[0].equals(this._pts[this._pts.length-1])},Ui.prototype.getSegmentOctant=function(t){return t===this._pts.length-1?-1:hn.octant(this.getCoordinate(t),this.getCoordinate(t+1))},Ui.prototype.setData=function(t){this._data=t},Ui.prototype.getData=function(){return this._data},Ui.prototype.toString=function(){return $.toLineString(new ue(this._pts))},Ui.prototype.interfaces_=function(){return[pn]},Ui.prototype.getClass=function(){return Ui};var ki=function(){this._findAllIntersections=!1,this._isCheckEndSegmentsOnly=!1,this._li=null,this._interiorIntersection=null,this._intSegments=null,this._intersections=new Nt,this._intersectionCount=0,this._keepIntersections=!0,this._li=arguments[0],this._interiorIntersection=null};ki.prototype.getInteriorIntersection=function(){return this._interiorIntersection},ki.prototype.setCheckEndSegmentsOnly=function(t){this._isCheckEndSegmentsOnly=t},ki.prototype.getIntersectionSegments=function(){return this._intSegments},ki.prototype.count=function(){return this._intersectionCount},ki.prototype.getIntersections=function(){return this._intersections},ki.prototype.setFindAllIntersections=function(t){this._findAllIntersections=t},ki.prototype.setKeepIntersections=function(t){this._keepIntersections=t},ki.prototype.processIntersections=function(t,e,n,i){if(!this._findAllIntersections&&this.hasIntersection())return null;if(t===n&&e===i)return null;if(this._isCheckEndSegmentsOnly&&!this.isEndSegment(t,e)&&!this.isEndSegment(n,i))return null;var r=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[i],a=n.getCoordinates()[i+1];this._li.computeIntersection(r,o,s,a),this._li.hasIntersection()&&this._li.isInteriorIntersection()&&(this._intSegments=new Array(4).fill(null),this._intSegments[0]=r,this._intSegments[1]=o,this._intSegments[2]=s,this._intSegments[3]=a,this._interiorIntersection=this._li.getIntersection(0),this._keepIntersections&&this._intersections.add(this._interiorIntersection),this._intersectionCount++)},ki.prototype.isEndSegment=function(t,e){return 0===e||e>=t.size()-2},ki.prototype.hasIntersection=function(){return null!==this._interiorIntersection},ki.prototype.isDone=function(){return!this._findAllIntersections&&null!==this._interiorIntersection},ki.prototype.interfaces_=function(){return[Wn]},ki.prototype.getClass=function(){return ki},ki.createAllIntersectionsFinder=function(t){var e=new ki(t);return e.setFindAllIntersections(!0),e},ki.createAnyIntersectionFinder=function(t){return new ki(t)},ki.createIntersectionCounter=function(t){var e=new ki(t);return e.setFindAllIntersections(!0),e.setKeepIntersections(!1),e};var zi=function(){this._li=new rt,this._segStrings=null,this._findAllIntersections=!1,this._segInt=null,this._isValid=!0,this._segStrings=arguments[0]};zi.prototype.execute=function(){if(null!==this._segInt)return null;this.checkInteriorIntersections()},zi.prototype.getIntersections=function(){return this._segInt.getIntersections()},zi.prototype.isValid=function(){return this.execute(),this._isValid},zi.prototype.setFindAllIntersections=function(t){this._findAllIntersections=t},zi.prototype.checkInteriorIntersections=function(){this._isValid=!0,this._segInt=new ki(this._li),this._segInt.setFindAllIntersections(this._findAllIntersections);var t=new En;if(t.setSegmentIntersector(this._segInt),t.computeNodes(this._segStrings),this._segInt.hasIntersection())return this._isValid=!1,null},zi.prototype.checkValid=function(){if(this.execute(),!this._isValid)throw new Le(this.getErrorMessage(),this._segInt.getInteriorIntersection())},zi.prototype.getErrorMessage=function(){if(this._isValid)return"no intersections found";var t=this._segInt.getIntersectionSegments();return"found non-noded intersection between "+$.toLineString(t[0],t[1])+" and "+$.toLineString(t[2],t[3])},zi.prototype.interfaces_=function(){return[]},zi.prototype.getClass=function(){return zi},zi.computeIntersections=function(t){var e=new zi(t);return e.setFindAllIntersections(!0),e.isValid(),e.getIntersections()};var Xi=function t(){this._nv=null,this._nv=new zi(t.toSegmentStrings(arguments[0]))};Xi.prototype.checkValid=function(){this._nv.checkValid()},Xi.prototype.interfaces_=function(){return[]},Xi.prototype.getClass=function(){return Xi},Xi.toSegmentStrings=function(t){for(var e=new Nt,n=t.iterator();n.hasNext();){var i=n.next();e.add(new Ui(i.getCoordinates(),i))}return e},Xi.checkValid=function(t){new Xi(t).checkValid()};var Yi=function(t){this._mapOp=t};Yi.prototype.map=function(t){for(var e=new Nt,n=0;n<t.getNumGeometries();n++){var i=this._mapOp.map(t.getGeometryN(n));i.isEmpty()||e.add(i)}return t.getFactory().createGeometryCollection(_e.toGeometryArray(e))},Yi.prototype.interfaces_=function(){return[]},Yi.prototype.getClass=function(){return Yi},Yi.map=function(t,e){return new Yi(e).map(t)};var ji=function(){this._op=null,this._geometryFactory=null,this._ptLocator=null,this._lineEdgesList=new Nt,this._resultLineList=new Nt;var t=arguments[1],e=arguments[2];this._op=arguments[0],this._geometryFactory=t,this._ptLocator=e};ji.prototype.collectLines=function(t){for(var e=this._op.getGraph().getEdgeEnds().iterator();e.hasNext();){var n=e.next();this.collectLineEdge(n,t,this._lineEdgesList),this.collectBoundaryTouchEdge(n,t,this._lineEdgesList)}},ji.prototype.labelIsolatedLine=function(t,e){var n=this._ptLocator.locate(t.getCoordinate(),this._op.getArgGeometry(e));t.getLabel().setLocation(e,n)},ji.prototype.build=function(t){return this.findCoveredLineEdges(),this.collectLines(t),this.buildLines(t),this._resultLineList},ji.prototype.collectLineEdge=function(t,e,n){var i=t.getLabel(),r=t.getEdge();t.isLineEdge()&&(t.isVisited()||!Sr.isResultOfOp(i,e)||r.isCovered()||(n.add(r),t.setVisitedEdge(!0)))},ji.prototype.findCoveredLineEdges=function(){for(var t=this._op.getGraph().getNodes().iterator();t.hasNext();)t.next().getEdges().findCoveredLineEdges();for(var e=this._op.getGraph().getEdgeEnds().iterator();e.hasNext();){var n=e.next(),i=n.getEdge();if(n.isLineEdge()&&!i.isCoveredSet()){var r=this._op.isCoveredByA(n.getCoordinate());i.setCovered(r)}}},ji.prototype.labelIsolatedLines=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next(),i=n.getLabel();n.isIsolated()&&(i.isNull(0)?this.labelIsolatedLine(n,0):this.labelIsolatedLine(n,1))}},ji.prototype.buildLines=function(t){for(var e=this._lineEdgesList.iterator();e.hasNext();){var n=e.next(),i=this._geometryFactory.createLineString(n.getCoordinates());this._resultLineList.add(i),n.setInResult(!0)}},ji.prototype.collectBoundaryTouchEdge=function(t,e,n){var i=t.getLabel();return t.isLineEdge()||t.isVisited()||t.isInteriorAreaEdge()||t.getEdge().isInResult()?null:(et.isTrue(!(t.isInResult()||t.getSym().isInResult())||!t.getEdge().isInResult()),void(Sr.isResultOfOp(i,e)&&e===Sr.INTERSECTION&&(n.add(t.getEdge()),t.setVisitedEdge(!0))))},ji.prototype.interfaces_=function(){return[]},ji.prototype.getClass=function(){return ji};var Hi=function(){this._op=null,this._geometryFactory=null,this._resultPointList=new Nt;var t=arguments[1];this._op=arguments[0],this._geometryFactory=t};Hi.prototype.filterCoveredNodeToPoint=function(t){var e=t.getCoordinate();if(!this._op.isCoveredByLA(e)){var n=this._geometryFactory.createPoint(e);this._resultPointList.add(n)}},Hi.prototype.extractNonCoveredResultNodes=function(t){for(var e=this._op.getGraph().getNodes().iterator();e.hasNext();){var n=e.next();if(!(n.isInResult()||n.isIncidentEdgeInResult()||0!==n.getEdges().getDegree()&&t!==Sr.INTERSECTION)){var i=n.getLabel();Sr.isResultOfOp(i,t)&&this.filterCoveredNodeToPoint(n)}}},Hi.prototype.build=function(t){return this.extractNonCoveredResultNodes(t),this._resultPointList},Hi.prototype.interfaces_=function(){return[]},Hi.prototype.getClass=function(){return Hi};var Wi=function(){this._inputGeom=null,this._factory=null,this._pruneEmptyGeometry=!0,this._preserveGeometryCollectionType=!0,this._preserveCollections=!1,this._preserveType=!1};Wi.prototype.transformPoint=function(t,e){return this._factory.createPoint(this.transformCoordinates(t.getCoordinateSequence(),t))},Wi.prototype.transformPolygon=function(t,e){var n=!0,i=this.transformLinearRing(t.getExteriorRing(),t);null!==i&&i instanceof ee&&!i.isEmpty()||(n=!1);for(var r=new Nt,o=0;o<t.getNumInteriorRing();o++){var s=this.transformLinearRing(t.getInteriorRingN(o),t);null===s||s.isEmpty()||(s instanceof ee||(n=!1),r.add(s))}if(n)return this._factory.createPolygon(i,r.toArray([]));var a=new Nt;return null!==i&&a.add(i),a.addAll(r),this._factory.buildGeometry(a)},Wi.prototype.createCoordinateSequence=function(t){return this._factory.getCoordinateSequenceFactory().create(t)},Wi.prototype.getInputGeometry=function(){return this._inputGeom},Wi.prototype.transformMultiLineString=function(t,e){for(var n=new Nt,i=0;i<t.getNumGeometries();i++){var r=this.transformLineString(t.getGeometryN(i),t);null!==r&&(r.isEmpty()||n.add(r))}return this._factory.buildGeometry(n)},Wi.prototype.transformCoordinates=function(t,e){return this.copy(t)},Wi.prototype.transformLineString=function(t,e){return this._factory.createLineString(this.transformCoordinates(t.getCoordinateSequence(),t))},Wi.prototype.transformMultiPoint=function(t,e){for(var n=new Nt,i=0;i<t.getNumGeometries();i++){var r=this.transformPoint(t.getGeometryN(i),t);null!==r&&(r.isEmpty()||n.add(r))}return this._factory.buildGeometry(n)},Wi.prototype.transformMultiPolygon=function(t,e){for(var n=new Nt,i=0;i<t.getNumGeometries();i++){var r=this.transformPolygon(t.getGeometryN(i),t);null!==r&&(r.isEmpty()||n.add(r))}return this._factory.buildGeometry(n)},Wi.prototype.copy=function(t){return t.copy()},Wi.prototype.transformGeometryCollection=function(t,e){for(var n=new Nt,i=0;i<t.getNumGeometries();i++){var r=this.transform(t.getGeometryN(i));null!==r&&(this._pruneEmptyGeometry&&r.isEmpty()||n.add(r))}return this._preserveGeometryCollectionType?this._factory.createGeometryCollection(_e.toGeometryArray(n)):this._factory.buildGeometry(n)},Wi.prototype.transform=function(t){if(this._inputGeom=t,this._factory=t.getFactory(),t instanceof Qt)return this.transformPoint(t,null);if(t instanceof te)return this.transformMultiPoint(t,null);if(t instanceof ee)return this.transformLinearRing(t,null);if(t instanceof Jt)return this.transformLineString(t,null);if(t instanceof zt)return this.transformMultiLineString(t,null);if(t instanceof Zt)return this.transformPolygon(t,null);if(t instanceof ne)return this.transformMultiPolygon(t,null);if(t instanceof kt)return this.transformGeometryCollection(t,null);throw new m("Unknown Geometry subtype: "+t.getClass().getName())},Wi.prototype.transformLinearRing=function(t,e){var n=this.transformCoordinates(t.getCoordinateSequence(),t);if(null===n)return this._factory.createLinearRing(null);var i=n.size();return i>0&&i<4&&!this._preserveType?this._factory.createLineString(n):this._factory.createLinearRing(n)},Wi.prototype.interfaces_=function(){return[]},Wi.prototype.getClass=function(){return Wi};var Ji=function t(){if(this._snapTolerance=0,this._srcPts=null,this._seg=new dn,this._allowSnappingToSourceVertices=!1,this._isClosed=!1,arguments[0]instanceof Jt&&"number"==typeof arguments[1]){var e=arguments[1];t.call(this,arguments[0].getCoordinates(),e)}else if(arguments[0]instanceof Array&&"number"==typeof arguments[1]){var n=arguments[0],i=arguments[1];this._srcPts=n,this._isClosed=t.isClosed(n),this._snapTolerance=i}};Ji.prototype.snapVertices=function(t,e){for(var n=this._isClosed?t.size()-1:t.size(),i=0;i<n;i++){var r=t.get(i),o=this.findSnapForVertex(r,e);null!==o&&(t.set(i,new w(o)),0===i&&this._isClosed&&t.set(t.size()-1,new w(o)))}},Ji.prototype.findSnapForVertex=function(t,e){for(var n=0;n<e.length;n++){if(t.equals2D(e[n]))return null;if(t.distance(e[n])<this._snapTolerance)return e[n]}return null},Ji.prototype.snapTo=function(t){var e=new Ct(this._srcPts);return this.snapVertices(e,t),this.snapSegments(e,t),e.toCoordinateArray()},Ji.prototype.snapSegments=function(t,e){if(0===e.length)return null;var n=e.length;e[0].equals2D(e[e.length-1])&&(n=e.length-1);for(var i=0;i<n;i++){var r=e[i],o=this.findSegmentIndexToSnap(r,t);o>=0&&t.add(o+1,new w(r),!1)}},Ji.prototype.findSegmentIndexToSnap=function(t,e){for(var n=v.MAX_VALUE,i=-1,r=0;r<e.size()-1;r++){if(this._seg.p0=e.get(r),this._seg.p1=e.get(r+1),this._seg.p0.equals2D(t)||this._seg.p1.equals2D(t)){if(this._allowSnappingToSourceVertices)continue;return-1}var o=this._seg.distance(t);o<this._snapTolerance&&o<n&&(n=o,i=r)}return i},Ji.prototype.setAllowSnappingToSourceVertices=function(t){this._allowSnappingToSourceVertices=t},Ji.prototype.interfaces_=function(){return[]},Ji.prototype.getClass=function(){return Ji},Ji.isClosed=function(t){return!(t.length<=1)&&t[0].equals2D(t[t.length-1])};var Ki=function(t){this._srcGeom=t||null},Qi={SNAP_PRECISION_FACTOR:{configurable:!0}};Ki.prototype.snapTo=function(t,e){var n=this.extractTargetCoordinates(t);return new $i(e,n).transform(this._srcGeom)},Ki.prototype.snapToSelf=function(t,e){var n=this.extractTargetCoordinates(this._srcGeom),i=new $i(t,n,!0).transform(this._srcGeom),r=i;return e&&P(r,$t)&&(r=i.buffer(0)),r},Ki.prototype.computeSnapTolerance=function(t){return this.computeMinimumSegmentLength(t)/10},Ki.prototype.extractTargetCoordinates=function(t){for(var e=new f,n=t.getCoordinates(),i=0;i<n.length;i++)e.add(n[i]);return e.toArray(new Array(0).fill(null))},Ki.prototype.computeMinimumSegmentLength=function(t){for(var e=v.MAX_VALUE,n=0;n<t.length-1;n++){var i=t[n].distance(t[n+1]);i<e&&(e=i)}return e},Ki.prototype.interfaces_=function(){return[]},Ki.prototype.getClass=function(){return Ki},Ki.snap=function(t,e,n){var i=new Array(2).fill(null),r=new Ki(t);i[0]=r.snapTo(e,n);var o=new Ki(e);return i[1]=o.snapTo(i[0],n),i},Ki.computeOverlaySnapTolerance=function(){if(1===arguments.length){var t=arguments[0],e=Ki.computeSizeBasedSnapTolerance(t),n=t.getPrecisionModel();if(n.getType()===fe.FIXED){var i=1/n.getScale()*2/1.415;i>e&&(e=i)}return e}if(2===arguments.length){var r=arguments[1];return Math.min(Ki.computeOverlaySnapTolerance(arguments[0]),Ki.computeOverlaySnapTolerance(r))}},Ki.computeSizeBasedSnapTolerance=function(t){var e=t.getEnvelopeInternal();return Math.min(e.getHeight(),e.getWidth())*Ki.SNAP_PRECISION_FACTOR},Ki.snapToSelf=function(t,e,n){return new Ki(t).snapToSelf(e,n)},Qi.SNAP_PRECISION_FACTOR.get=function(){return 1e-9},Object.defineProperties(Ki,Qi);var $i=function(t){function e(e,n,i){t.call(this),this._snapTolerance=e||null,this._snapPts=n||null,this._isSelfSnap=void 0!==i&&i}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.snapLine=function(t,e){var n=new Ji(t,this._snapTolerance);return n.setAllowSnappingToSourceVertices(this._isSelfSnap),n.snapTo(e)},e.prototype.transformCoordinates=function(t,e){var n=t.toCoordinateArray(),i=this.snapLine(n,this._snapPts);return this._factory.getCoordinateSequenceFactory().create(i)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Wi),Zi=function(){this._isFirst=!0,this._commonMantissaBitsCount=53,this._commonBits=0,this._commonSignExp=null};Zi.prototype.getCommon=function(){return v.longBitsToDouble(this._commonBits)},Zi.prototype.add=function(t){var e=v.doubleToLongBits(t);return this._isFirst?(this._commonBits=e,this._commonSignExp=Zi.signExpBits(this._commonBits),this._isFirst=!1,null):Zi.signExpBits(e)!==this._commonSignExp?(this._commonBits=0,null):(this._commonMantissaBitsCount=Zi.numCommonMostSigMantissaBits(this._commonBits,e),void(this._commonBits=Zi.zeroLowerBits(this._commonBits,64-(12+this._commonMantissaBitsCount))))},Zi.prototype.toString=function(){if(1===arguments.length){var t=arguments[0],e=v.longBitsToDouble(t),n="0000000000000000000000000000000000000000000000000000000000000000"+v.toBinaryString(t),i=n.substring(n.length-64);return i.substring(0,1)+"  "+i.substring(1,12)+"(exp) "+i.substring(12)+" [ "+e+" ]"}},Zi.prototype.interfaces_=function(){return[]},Zi.prototype.getClass=function(){return Zi},Zi.getBit=function(t,e){return t&1<<e?1:0},Zi.signExpBits=function(t){return t>>52},Zi.zeroLowerBits=function(t,e){return t&~((1<<e)-1)},Zi.numCommonMostSigMantissaBits=function(t,e){for(var n=0,i=52;i>=0;i--){if(Zi.getBit(t,i)!==Zi.getBit(e,i))return n;n++}return 52};var tr=function(){this._commonCoord=null,this._ccFilter=new nr},er={CommonCoordinateFilter:{configurable:!0},Translater:{configurable:!0}};tr.prototype.addCommonBits=function(t){var e=new ir(this._commonCoord);t.apply(e),t.geometryChanged()},tr.prototype.removeCommonBits=function(t){if(0===this._commonCoord.x&&0===this._commonCoord.y)return t;var e=new w(this._commonCoord);e.x=-e.x,e.y=-e.y;var n=new ir(e);return t.apply(n),t.geometryChanged(),t},tr.prototype.getCommonCoordinate=function(){return this._commonCoord},tr.prototype.add=function(t){t.apply(this._ccFilter),this._commonCoord=this._ccFilter.getCommonCoordinate()},tr.prototype.interfaces_=function(){return[]},tr.prototype.getClass=function(){return tr},er.CommonCoordinateFilter.get=function(){return nr},er.Translater.get=function(){return ir},Object.defineProperties(tr,er);var nr=function(){this._commonBitsX=new Zi,this._commonBitsY=new Zi};nr.prototype.filter=function(t){this._commonBitsX.add(t.x),this._commonBitsY.add(t.y)},nr.prototype.getCommonCoordinate=function(){return new w(this._commonBitsX.getCommon(),this._commonBitsY.getCommon())},nr.prototype.interfaces_=function(){return[ft]},nr.prototype.getClass=function(){return nr};var ir=function(){this.trans=null,this.trans=arguments[0]};ir.prototype.filter=function(t,e){var n=t.getOrdinate(e,0)+this.trans.x,i=t.getOrdinate(e,1)+this.trans.y;t.setOrdinate(e,0,n),t.setOrdinate(e,1,i)},ir.prototype.isDone=function(){return!1},ir.prototype.isGeometryChanged=function(){return!0},ir.prototype.interfaces_=function(){return[Ut]},ir.prototype.getClass=function(){return ir};var rr=function(t,e){this._geom=new Array(2).fill(null),this._snapTolerance=null,this._cbr=null,this._geom[0]=t,this._geom[1]=e,this.computeSnapTolerance()};rr.prototype.selfSnap=function(t){return new Ki(t).snapTo(t,this._snapTolerance)},rr.prototype.removeCommonBits=function(t){this._cbr=new tr,this._cbr.add(t[0]),this._cbr.add(t[1]);var e=new Array(2).fill(null);return e[0]=this._cbr.removeCommonBits(t[0].copy()),e[1]=this._cbr.removeCommonBits(t[1].copy()),e},rr.prototype.prepareResult=function(t){return this._cbr.addCommonBits(t),t},rr.prototype.getResultGeometry=function(t){var e=this.snap(this._geom),n=Sr.overlayOp(e[0],e[1],t);return this.prepareResult(n)},rr.prototype.checkValid=function(t){t.isValid()||X.out.println("Snapped geometry is invalid")},rr.prototype.computeSnapTolerance=function(){this._snapTolerance=Ki.computeOverlaySnapTolerance(this._geom[0],this._geom[1])},rr.prototype.snap=function(t){var e=this.removeCommonBits(t);return Ki.snap(e[0],e[1],this._snapTolerance)},rr.prototype.interfaces_=function(){return[]},rr.prototype.getClass=function(){return rr},rr.overlayOp=function(t,e,n){return new rr(t,e).getResultGeometry(n)},rr.union=function(t,e){return rr.overlayOp(t,e,Sr.UNION)},rr.intersection=function(t,e){return rr.overlayOp(t,e,Sr.INTERSECTION)},rr.symDifference=function(t,e){return rr.overlayOp(t,e,Sr.SYMDIFFERENCE)},rr.difference=function(t,e){return rr.overlayOp(t,e,Sr.DIFFERENCE)};var or=function(t,e){this._geom=new Array(2).fill(null),this._geom[0]=t,this._geom[1]=e};or.prototype.getResultGeometry=function(t){var e=null,n=!1,i=null;try{e=Sr.overlayOp(this._geom[0],this._geom[1],t),n=!0}catch(t){if(!(t instanceof Z))throw t;i=t}if(!n)try{e=rr.overlayOp(this._geom[0],this._geom[1],t)}catch(t){throw t instanceof Z?i:t}return e},or.prototype.interfaces_=function(){return[]},or.prototype.getClass=function(){return or},or.overlayOp=function(t,e,n){return new or(t,e).getResultGeometry(n)},or.union=function(t,e){return or.overlayOp(t,e,Sr.UNION)},or.intersection=function(t,e){return or.overlayOp(t,e,Sr.INTERSECTION)},or.symDifference=function(t,e){return or.overlayOp(t,e,Sr.SYMDIFFERENCE)},or.difference=function(t,e){return or.overlayOp(t,e,Sr.DIFFERENCE)};var sr=function(){this.mce=null,this.chainIndex=null;var t=arguments[1];this.mce=arguments[0],this.chainIndex=t};sr.prototype.computeIntersections=function(t,e){this.mce.computeIntersectsForChain(this.chainIndex,t.mce,t.chainIndex,e)},sr.prototype.interfaces_=function(){return[]},sr.prototype.getClass=function(){return sr};var ar=function t(){if(this._label=null,this._xValue=null,this._eventType=null,this._insertEvent=null,this._deleteEventIndex=null,this._obj=null,2===arguments.length){var e=arguments[0],n=arguments[1];this._eventType=t.DELETE,this._xValue=e,this._insertEvent=n}else if(3===arguments.length){var i=arguments[0],r=arguments[1],o=arguments[2];this._eventType=t.INSERT,this._label=i,this._xValue=r,this._obj=o}},ur={INSERT:{configurable:!0},DELETE:{configurable:!0}};ar.prototype.isDelete=function(){return this._eventType===ar.DELETE},ar.prototype.setDeleteEventIndex=function(t){this._deleteEventIndex=t},ar.prototype.getObject=function(){return this._obj},ar.prototype.compareTo=function(t){return this._xValue<t._xValue?-1:this._xValue>t._xValue?1:this._eventType<t._eventType?-1:this._eventType>t._eventType?1:0},ar.prototype.getInsertEvent=function(){return this._insertEvent},ar.prototype.isInsert=function(){return this._eventType===ar.INSERT},ar.prototype.isSameLabel=function(t){return null!==this._label&&this._label===t._label},ar.prototype.getDeleteEventIndex=function(){return this._deleteEventIndex},ar.prototype.interfaces_=function(){return[I]},ar.prototype.getClass=function(){return ar},ur.INSERT.get=function(){return 1},ur.DELETE.get=function(){return 2},Object.defineProperties(ar,ur);var lr=function(){};lr.prototype.interfaces_=function(){return[]},lr.prototype.getClass=function(){return lr};var cr=function(){this._hasIntersection=!1,this._hasProper=!1,this._hasProperInterior=!1,this._properIntersectionPoint=null,this._li=null,this._includeProper=null,this._recordIsolated=null,this._isSelfIntersection=null,this._numIntersections=0,this.numTests=0,this._bdyNodes=null,this._isDone=!1,this._isDoneWhenProperInt=!1;var t=arguments[1],e=arguments[2];this._li=arguments[0],this._includeProper=t,this._recordIsolated=e};cr.prototype.isTrivialIntersection=function(t,e,n,i){if(t===n&&1===this._li.getIntersectionNum()){if(cr.isAdjacentSegments(e,i))return!0;if(t.isClosed()){var r=t.getNumPoints()-1;if(0===e&&i===r||0===i&&e===r)return!0}}return!1},cr.prototype.getProperIntersectionPoint=function(){return this._properIntersectionPoint},cr.prototype.setIsDoneIfProperInt=function(t){this._isDoneWhenProperInt=t},cr.prototype.hasProperInteriorIntersection=function(){return this._hasProperInterior},cr.prototype.isBoundaryPointInternal=function(t,e){for(var n=e.iterator();n.hasNext();){var i=n.next().getCoordinate();if(t.isIntersection(i))return!0}return!1},cr.prototype.hasProperIntersection=function(){return this._hasProper},cr.prototype.hasIntersection=function(){return this._hasIntersection},cr.prototype.isDone=function(){return this._isDone},cr.prototype.isBoundaryPoint=function(t,e){return!(null===e||!this.isBoundaryPointInternal(t,e[0])&&!this.isBoundaryPointInternal(t,e[1]))},cr.prototype.setBoundaryNodes=function(t,e){this._bdyNodes=new Array(2).fill(null),this._bdyNodes[0]=t,this._bdyNodes[1]=e},cr.prototype.addIntersections=function(t,e,n,i){if(t===n&&e===i)return null;this.numTests++;var r=t.getCoordinates()[e],o=t.getCoordinates()[e+1],s=n.getCoordinates()[i],a=n.getCoordinates()[i+1];this._li.computeIntersection(r,o,s,a),this._li.hasIntersection()&&(this._recordIsolated&&(t.setIsolated(!1),n.setIsolated(!1)),this._numIntersections++,this.isTrivialIntersection(t,e,n,i)||(this._hasIntersection=!0,!this._includeProper&&this._li.isProper()||(t.addIntersections(this._li,e,0),n.addIntersections(this._li,i,1)),this._li.isProper()&&(this._properIntersectionPoint=this._li.getIntersection(0).copy(),this._hasProper=!0,this._isDoneWhenProperInt&&(this._isDone=!0),this.isBoundaryPoint(this._li,this._bdyNodes)||(this._hasProperInterior=!0))))},cr.prototype.interfaces_=function(){return[]},cr.prototype.getClass=function(){return cr},cr.isAdjacentSegments=function(t,e){return 1===Math.abs(t-e)};var hr=function(t){function e(){t.call(this),this.events=new Nt,this.nOverlaps=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.prepareEvents=function(){Ze.sort(this.events);for(var t=0;t<this.events.size();t++){var e=this.events.get(t);e.isDelete()&&e.getInsertEvent().setDeleteEventIndex(t)}},e.prototype.computeIntersections=function(){if(1===arguments.length){var t=arguments[0];this.nOverlaps=0,this.prepareEvents();for(var e=0;e<this.events.size();e++){var n=this.events.get(e);if(n.isInsert()&&this.processOverlaps(e,n.getDeleteEventIndex(),n,t),t.isDone())break}}else if(3===arguments.length)if(arguments[2]instanceof cr&&P(arguments[0],Et)&&P(arguments[1],Et)){var i=arguments[0],r=arguments[1],o=arguments[2];this.addEdges(i,i),this.addEdges(r,r),this.computeIntersections(o)}else if("boolean"==typeof arguments[2]&&P(arguments[0],Et)&&arguments[1]instanceof cr){var s=arguments[0],a=arguments[1];arguments[2]?this.addEdges(s,null):this.addEdges(s),this.computeIntersections(a)}},e.prototype.addEdge=function(t,e){for(var n=t.getMonotoneChainEdge(),i=n.getStartIndexes(),r=0;r<i.length-1;r++){var o=new sr(n,r),s=new ar(e,n.getMinX(r),o);this.events.add(s),this.events.add(new ar(n.getMaxX(r),s))}},e.prototype.processOverlaps=function(t,e,n,i){for(var r=n.getObject(),o=t;o<e;o++){var s=this.events.get(o);if(s.isInsert()){var a=s.getObject();n.isSameLabel(s)||(r.computeIntersections(a,i),this.nOverlaps++)}}},e.prototype.addEdges=function(){if(1===arguments.length)for(var t=arguments[0].iterator();t.hasNext();){var e=t.next();this.addEdge(e,e)}else if(2===arguments.length)for(var n=arguments[1],i=arguments[0].iterator();i.hasNext();){var r=i.next();this.addEdge(r,n)}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(lr),pr=function(){this._min=v.POSITIVE_INFINITY,this._max=v.NEGATIVE_INFINITY},fr={NodeComparator:{configurable:!0}};pr.prototype.getMin=function(){return this._min},pr.prototype.intersects=function(t,e){return!(this._min>e||this._max<t)},pr.prototype.getMax=function(){return this._max},pr.prototype.toString=function(){return $.toLineString(new w(this._min,0),new w(this._max,0))},pr.prototype.interfaces_=function(){return[]},pr.prototype.getClass=function(){return pr},fr.NodeComparator.get=function(){return gr},Object.defineProperties(pr,fr);var gr=function(){};gr.prototype.compare=function(t,e){var n=(t._min+t._max)/2,i=(e._min+e._max)/2;return n<i?-1:n>i?1:0},gr.prototype.interfaces_=function(){return[N]},gr.prototype.getClass=function(){return gr};var dr=function(t){function e(){t.call(this),this._item=null;var e=arguments[1],n=arguments[2];this._min=arguments[0],this._max=e,this._item=n}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.query=function(t,e,n){if(!this.intersects(t,e))return null;n.visitItem(this._item)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(pr),yr=function(t){function e(){t.call(this),this._node1=null,this._node2=null;var e=arguments[1];this._node1=arguments[0],this._node2=e,this.buildExtent(this._node1,this._node2)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.buildExtent=function(t,e){this._min=Math.min(t._min,e._min),this._max=Math.max(t._max,e._max)},e.prototype.query=function(t,e,n){if(!this.intersects(t,e))return null;null!==this._node1&&this._node1.query(t,e,n),null!==this._node2&&this._node2.query(t,e,n)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(pr),_r=function(){this._leaves=new Nt,this._root=null,this._level=0};_r.prototype.buildTree=function(){Ze.sort(this._leaves,new pr.NodeComparator);for(var t=this._leaves,e=null,n=new Nt;;){if(this.buildLevel(t,n),1===n.size())return n.get(0);e=t,t=n,n=e}},_r.prototype.insert=function(t,e,n){if(null!==this._root)throw new Error("Index cannot be added to once it has been queried");this._leaves.add(new dr(t,e,n))},_r.prototype.query=function(t,e,n){this.init(),this._root.query(t,e,n)},_r.prototype.buildRoot=function(){if(null!==this._root)return null;this._root=this.buildTree()},_r.prototype.printNode=function(t){X.out.println($.toLineString(new w(t._min,this._level),new w(t._max,this._level)))},_r.prototype.init=function(){if(null!==this._root)return null;this.buildRoot()},_r.prototype.buildLevel=function(t,e){this._level++,e.clear();for(var n=0;n<t.size();n+=2){var i=t.get(n);if(null===(n+1<t.size()?t.get(n):null))e.add(i);else{var r=new yr(t.get(n),t.get(n+1));e.add(r)}}},_r.prototype.interfaces_=function(){return[]},_r.prototype.getClass=function(){return _r};var mr=function(){this._items=new Nt};mr.prototype.visitItem=function(t){this._items.add(t)},mr.prototype.getItems=function(){return this._items},mr.prototype.interfaces_=function(){return[Je]},mr.prototype.getClass=function(){return mr};var vr=function(){this._index=null;var t=arguments[0];if(!P(t,$t))throw new m("Argument must be Polygonal");this._index=new Er(t)},xr={SegmentVisitor:{configurable:!0},IntervalIndexedGeometry:{configurable:!0}};vr.prototype.locate=function(t){var e=new st(t),n=new Ir(e);return this._index.query(t.y,t.y,n),e.getLocation()},vr.prototype.interfaces_=function(){return[qn]},vr.prototype.getClass=function(){return vr},xr.SegmentVisitor.get=function(){return Ir},xr.IntervalIndexedGeometry.get=function(){return Er},Object.defineProperties(vr,xr);var Ir=function(){this._counter=null,this._counter=arguments[0]};Ir.prototype.visitItem=function(t){var e=t;this._counter.countSegment(e.getCoordinate(0),e.getCoordinate(1))},Ir.prototype.interfaces_=function(){return[Je]},Ir.prototype.getClass=function(){return Ir};var Er=function(){this._index=new _r,this.init(arguments[0])};Er.prototype.init=function(t){for(var e=wi.getLines(t).iterator();e.hasNext();){var n=e.next().getCoordinates();this.addLine(n)}},Er.prototype.addLine=function(t){for(var e=1;e<t.length;e++){var n=new dn(t[e-1],t[e]),i=Math.min(n.p0.y,n.p1.y),r=Math.max(n.p0.y,n.p1.y);this._index.insert(i,r,n)}},Er.prototype.query=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=new mr;return this._index.query(t,e,n),n.getItems()}3===arguments.length&&this._index.query(arguments[0],arguments[1],arguments[2])},Er.prototype.interfaces_=function(){return[]},Er.prototype.getClass=function(){return Er};var Nr=function(t){function e(){if(t.call(this),this._parentGeom=null,this._lineEdgeMap=new pe,this._boundaryNodeRule=null,this._useBoundaryDeterminationRule=!0,this._argIndex=null,this._boundaryNodes=null,this._hasTooFewPoints=!1,this._invalidPoint=null,this._areaPtLocator=null,this._ptLocator=new Ci,2===arguments.length){var e=arguments[1],n=gt.OGC_SFS_BOUNDARY_RULE;this._argIndex=arguments[0],this._parentGeom=e,this._boundaryNodeRule=n,null!==e&&this.add(e)}else if(3===arguments.length){var i=arguments[1],r=arguments[2];this._argIndex=arguments[0],this._parentGeom=i,this._boundaryNodeRule=r,null!==i&&this.add(i)}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.insertBoundaryPoint=function(t,n){var i=this._nodes.addNode(n).getLabel(),r=1;i.getLocation(t,Ce.ON)===L.BOUNDARY&&r++;var o=e.determineBoundary(this._boundaryNodeRule,r);i.setLocation(t,o)},e.prototype.computeSelfNodes=function(){if(2===arguments.length)return this.computeSelfNodes(arguments[0],arguments[1],!1);if(3===arguments.length){var t=arguments[1],e=arguments[2],n=new cr(arguments[0],!0,!1);return n.setIsDoneIfProperInt(e),this.createEdgeSetIntersector().computeIntersections(this._edges,n,t||!(this._parentGeom instanceof ee||this._parentGeom instanceof Zt||this._parentGeom instanceof ne)),this.addSelfIntersectionNodes(this._argIndex),n}},e.prototype.computeSplitEdges=function(t){for(var e=this._edges.iterator();e.hasNext();)e.next().eiList.addSplitEdges(t)},e.prototype.computeEdgeIntersections=function(t,e,n){var i=new cr(e,n,!0);return i.setBoundaryNodes(this.getBoundaryNodes(),t.getBoundaryNodes()),this.createEdgeSetIntersector().computeIntersections(this._edges,t._edges,i),i},e.prototype.getGeometry=function(){return this._parentGeom},e.prototype.getBoundaryNodeRule=function(){return this._boundaryNodeRule},e.prototype.hasTooFewPoints=function(){return this._hasTooFewPoints},e.prototype.addPoint=function(){if(arguments[0]instanceof Qt){var t=arguments[0].getCoordinate();this.insertPoint(this._argIndex,t,L.INTERIOR)}else arguments[0]instanceof w&&this.insertPoint(this._argIndex,arguments[0],L.INTERIOR)},e.prototype.addPolygon=function(t){this.addPolygonRing(t.getExteriorRing(),L.EXTERIOR,L.INTERIOR);for(var e=0;e<t.getNumInteriorRing();e++){var n=t.getInteriorRingN(e);this.addPolygonRing(n,L.INTERIOR,L.EXTERIOR)}},e.prototype.addEdge=function(t){this.insertEdge(t);var e=t.getCoordinates();this.insertPoint(this._argIndex,e[0],L.BOUNDARY),this.insertPoint(this._argIndex,e[e.length-1],L.BOUNDARY)},e.prototype.addLineString=function(t){var e=St.removeRepeatedPoints(t.getCoordinates());if(e.length<2)return this._hasTooFewPoints=!0,this._invalidPoint=e[0],null;var n=new ni(e,new Me(this._argIndex,L.INTERIOR));this._lineEdgeMap.put(t,n),this.insertEdge(n),et.isTrue(e.length>=2,"found LineString with single point"),this.insertBoundaryPoint(this._argIndex,e[0]),this.insertBoundaryPoint(this._argIndex,e[e.length-1])},e.prototype.getInvalidPoint=function(){return this._invalidPoint},e.prototype.getBoundaryPoints=function(){for(var t=this.getBoundaryNodes(),e=new Array(t.size()).fill(null),n=0,i=t.iterator();i.hasNext();){var r=i.next();e[n++]=r.getCoordinate().copy()}return e},e.prototype.getBoundaryNodes=function(){return null===this._boundaryNodes&&(this._boundaryNodes=this._nodes.getBoundaryNodes(this._argIndex)),this._boundaryNodes},e.prototype.addSelfIntersectionNode=function(t,e,n){if(this.isBoundaryNode(t,e))return null;n===L.BOUNDARY&&this._useBoundaryDeterminationRule?this.insertBoundaryPoint(t,e):this.insertPoint(t,e,n)},e.prototype.addPolygonRing=function(t,e,n){if(t.isEmpty())return null;var i=St.removeRepeatedPoints(t.getCoordinates());if(i.length<4)return this._hasTooFewPoints=!0,this._invalidPoint=i[0],null;var r=e,o=n;at.isCCW(i)&&(r=n,o=e);var s=new ni(i,new Me(this._argIndex,L.BOUNDARY,r,o));this._lineEdgeMap.put(t,s),this.insertEdge(s),this.insertPoint(this._argIndex,i[0],L.BOUNDARY)},e.prototype.insertPoint=function(t,e,n){var i=this._nodes.addNode(e),r=i.getLabel();null===r?i._label=new Me(t,n):r.setLocation(t,n)},e.prototype.createEdgeSetIntersector=function(){return new hr},e.prototype.addSelfIntersectionNodes=function(t){for(var e=this._edges.iterator();e.hasNext();)for(var n=e.next(),i=n.getLabel().getLocation(t),r=n.eiList.iterator();r.hasNext();){var o=r.next();this.addSelfIntersectionNode(t,o.coord,i)}},e.prototype.add=function(){if(1!==arguments.length)return t.prototype.add.apply(this,arguments);var e=arguments[0];if(e.isEmpty())return null;if(e instanceof ne&&(this._useBoundaryDeterminationRule=!1),e instanceof Zt)this.addPolygon(e);else if(e instanceof Jt)this.addLineString(e);else if(e instanceof Qt)this.addPoint(e);else if(e instanceof te)this.addCollection(e);else if(e instanceof zt)this.addCollection(e);else if(e instanceof ne)this.addCollection(e);else{if(!(e instanceof kt))throw new Error(e.getClass().getName());this.addCollection(e)}},e.prototype.addCollection=function(t){for(var e=0;e<t.getNumGeometries();e++){var n=t.getGeometryN(e);this.add(n)}},e.prototype.locate=function(t){return P(this._parentGeom,$t)&&this._parentGeom.getNumGeometries()>50?(null===this._areaPtLocator&&(this._areaPtLocator=new vr(this._parentGeom)),this._areaPtLocator.locate(t)):this._ptLocator.locate(t,this._parentGeom)},e.prototype.findEdge=function(){return 1===arguments.length?this._lineEdgeMap.get(arguments[0]):t.prototype.findEdge.apply(this,arguments)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.determineBoundary=function(t,e){return t.isInBoundary(e)?L.BOUNDARY:L.INTERIOR},e}(Xe),wr=function(){if(this._li=new rt,this._resultPrecisionModel=null,this._arg=null,1===arguments.length){var t=arguments[0];this.setComputationPrecision(t.getPrecisionModel()),this._arg=new Array(1).fill(null),this._arg[0]=new Nr(0,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1],i=gt.OGC_SFS_BOUNDARY_RULE;e.getPrecisionModel().compareTo(n.getPrecisionModel())>=0?this.setComputationPrecision(e.getPrecisionModel()):this.setComputationPrecision(n.getPrecisionModel()),this._arg=new Array(2).fill(null),this._arg[0]=new Nr(0,e,i),this._arg[1]=new Nr(1,n,i)}else if(3===arguments.length){var r=arguments[0],o=arguments[1],s=arguments[2];r.getPrecisionModel().compareTo(o.getPrecisionModel())>=0?this.setComputationPrecision(r.getPrecisionModel()):this.setComputationPrecision(o.getPrecisionModel()),this._arg=new Array(2).fill(null),this._arg[0]=new Nr(0,r,s),this._arg[1]=new Nr(1,o,s)}};wr.prototype.getArgGeometry=function(t){return this._arg[t].getGeometry()},wr.prototype.setComputationPrecision=function(t){this._resultPrecisionModel=t,this._li.setPrecisionModel(this._resultPrecisionModel)},wr.prototype.interfaces_=function(){return[]},wr.prototype.getClass=function(){return wr};var Cr=function(){};Cr.prototype.interfaces_=function(){return[]},Cr.prototype.getClass=function(){return Cr},Cr.map=function(){if(arguments[0]instanceof ct&&P(arguments[1],Cr.MapOp)){for(var t=arguments[0],e=arguments[1],n=new Nt,i=0;i<t.getNumGeometries();i++){var r=e.map(t.getGeometryN(i));null!==r&&n.add(r)}return t.getFactory().buildGeometry(n)}if(P(arguments[0],xt)&&P(arguments[1],Cr.MapOp)){for(var o=arguments[0],s=arguments[1],a=new Nt,u=o.iterator();u.hasNext();){var l=u.next(),c=s.map(l);null!==c&&a.add(c)}return a}},Cr.MapOp=function(){};var Sr=function(t){function e(){var e=arguments[0];t.call(this,e,arguments[1]),this._ptLocator=new Ci,this._geomFact=null,this._resultGeom=null,this._graph=null,this._edgeList=new Hn,this._resultPolyList=new Nt,this._resultLineList=new Nt,this._resultPointList=new Nt,this._graph=new Xe(new Yn),this._geomFact=e.getFactory()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.insertUniqueEdge=function(t){var e=this._edgeList.findEqualEdge(t);if(null!==e){var n=e.getLabel(),i=t.getLabel();e.isPointwiseEqual(t)||(i=new Me(t.getLabel())).flip();var r=e.getDepth();r.isNull()&&r.add(n),r.add(i),n.merge(i)}else this._edgeList.add(t)},e.prototype.getGraph=function(){return this._graph},e.prototype.cancelDuplicateResultEdges=function(){for(var t=this._graph.getEdgeEnds().iterator();t.hasNext();){var e=t.next(),n=e.getSym();e.isInResult()&&n.isInResult()&&(e.setInResult(!1),n.setInResult(!1))}},e.prototype.isCoveredByLA=function(t){return!!this.isCovered(t,this._resultLineList)||!!this.isCovered(t,this._resultPolyList)},e.prototype.computeGeometry=function(t,n,i,r){var o=new Nt;return o.addAll(t),o.addAll(n),o.addAll(i),o.isEmpty()?e.createEmptyResult(r,this._arg[0].getGeometry(),this._arg[1].getGeometry(),this._geomFact):this._geomFact.buildGeometry(o)},e.prototype.mergeSymLabels=function(){for(var t=this._graph.getNodes().iterator();t.hasNext();)t.next().getEdges().mergeSymLabels()},e.prototype.isCovered=function(t,e){for(var n=e.iterator();n.hasNext();){var i=n.next();if(this._ptLocator.locate(t,i)!==L.EXTERIOR)return!0}return!1},e.prototype.replaceCollapsedEdges=function(){for(var t=new Nt,e=this._edgeList.iterator();e.hasNext();){var n=e.next();n.isCollapsed()&&(e.remove(),t.add(n.getCollapsedEdge()))}this._edgeList.addAll(t)},e.prototype.updateNodeLabelling=function(){for(var t=this._graph.getNodes().iterator();t.hasNext();){var e=t.next(),n=e.getEdges().getLabel();e.getLabel().merge(n)}},e.prototype.getResultGeometry=function(t){return this.computeOverlay(t),this._resultGeom},e.prototype.insertUniqueEdges=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();this.insertUniqueEdge(n)}},e.prototype.computeOverlay=function(t){this.copyPoints(0),this.copyPoints(1),this._arg[0].computeSelfNodes(this._li,!1),this._arg[1].computeSelfNodes(this._li,!1),this._arg[0].computeEdgeIntersections(this._arg[1],this._li,!0);var e=new Nt;this._arg[0].computeSplitEdges(e),this._arg[1].computeSplitEdges(e),this.insertUniqueEdges(e),this.computeLabelsFromDepths(),this.replaceCollapsedEdges(),Xi.checkValid(this._edgeList.getEdges()),this._graph.addEdges(this._edgeList.getEdges()),this.computeLabelling(),this.labelIncompleteNodes(),this.findResultAreaEdges(t),this.cancelDuplicateResultEdges();var n=new Ye(this._geomFact);n.add(this._graph),this._resultPolyList=n.getPolygons();var i=new ji(this,this._geomFact,this._ptLocator);this._resultLineList=i.build(t);var r=new Hi(this,this._geomFact,this._ptLocator);this._resultPointList=r.build(t),this._resultGeom=this.computeGeometry(this._resultPointList,this._resultLineList,this._resultPolyList,t)},e.prototype.labelIncompleteNode=function(t,e){var n=this._ptLocator.locate(t.getCoordinate(),this._arg[e].getGeometry());t.getLabel().setLocation(e,n)},e.prototype.copyPoints=function(t){for(var e=this._arg[t].getNodeIterator();e.hasNext();){var n=e.next();this._graph.addNode(n.getCoordinate()).setLabel(t,n.getLabel().getLocation(t))}},e.prototype.findResultAreaEdges=function(t){for(var n=this._graph.getEdgeEnds().iterator();n.hasNext();){var i=n.next(),r=i.getLabel();r.isArea()&&!i.isInteriorAreaEdge()&&e.isResultOfOp(r.getLocation(0,Ce.RIGHT),r.getLocation(1,Ce.RIGHT),t)&&i.setInResult(!0)}},e.prototype.computeLabelsFromDepths=function(){for(var t=this._edgeList.iterator();t.hasNext();){var e=t.next(),n=e.getLabel(),i=e.getDepth();if(!i.isNull()){i.normalize();for(var r=0;r<2;r++)n.isNull(r)||!n.isArea()||i.isNull(r)||(0===i.getDelta(r)?n.toLine(r):(et.isTrue(!i.isNull(r,Ce.LEFT),"depth of LEFT side has not been initialized"),n.setLocation(r,Ce.LEFT,i.getLocation(r,Ce.LEFT)),et.isTrue(!i.isNull(r,Ce.RIGHT),"depth of RIGHT side has not been initialized"),n.setLocation(r,Ce.RIGHT,i.getLocation(r,Ce.RIGHT))))}}},e.prototype.computeLabelling=function(){for(var t=this._graph.getNodes().iterator();t.hasNext();)t.next().getEdges().computeLabelling(this._arg);this.mergeSymLabels(),this.updateNodeLabelling()},e.prototype.labelIncompleteNodes=function(){for(var t=this._graph.getNodes().iterator();t.hasNext();){var e=t.next(),n=e.getLabel();e.isIsolated()&&(n.isNull(0)?this.labelIncompleteNode(e,0):this.labelIncompleteNode(e,1)),e.getEdges().updateLabelling(n)}},e.prototype.isCoveredByA=function(t){return!!this.isCovered(t,this._resultPolyList)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(wr);Sr.overlayOp=function(t,e,n){return new Sr(t,e).getResultGeometry(n)},Sr.intersection=function(t,e){if(t.isEmpty()||e.isEmpty())return Sr.createEmptyResult(Sr.INTERSECTION,t,e,t.getFactory());if(t.isGeometryCollection()){var n=e;return Yi.map(t,{interfaces_:function(){return[Cr.MapOp]},map:function(t){return t.intersection(n)}})}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),or.overlayOp(t,e,Sr.INTERSECTION)},Sr.symDifference=function(t,e){if(t.isEmpty()||e.isEmpty()){if(t.isEmpty()&&e.isEmpty())return Sr.createEmptyResult(Sr.SYMDIFFERENCE,t,e,t.getFactory());if(t.isEmpty())return e.copy();if(e.isEmpty())return t.copy()}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),or.overlayOp(t,e,Sr.SYMDIFFERENCE)},Sr.resultDimension=function(t,e,n){var i=e.getDimension(),r=n.getDimension(),o=-1;switch(t){case Sr.INTERSECTION:o=Math.min(i,r);break;case Sr.UNION:o=Math.max(i,r);break;case Sr.DIFFERENCE:o=i;break;case Sr.SYMDIFFERENCE:o=Math.max(i,r)}return o},Sr.createEmptyResult=function(t,e,n,i){var r=null;switch(Sr.resultDimension(t,e,n)){case-1:r=i.createGeometryCollection(new Array(0).fill(null));break;case 0:r=i.createPoint();break;case 1:r=i.createLineString();break;case 2:r=i.createPolygon()}return r},Sr.difference=function(t,e){return t.isEmpty()?Sr.createEmptyResult(Sr.DIFFERENCE,t,e,t.getFactory()):e.isEmpty()?t.copy():(t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),or.overlayOp(t,e,Sr.DIFFERENCE))},Sr.isResultOfOp=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=t.getLocation(0),i=t.getLocation(1);return Sr.isResultOfOp(n,i,e)}if(3===arguments.length){var r=arguments[0],o=arguments[1];switch(r===L.BOUNDARY&&(r=L.INTERIOR),o===L.BOUNDARY&&(o=L.INTERIOR),arguments[2]){case Sr.INTERSECTION:return r===L.INTERIOR&&o===L.INTERIOR;case Sr.UNION:return r===L.INTERIOR||o===L.INTERIOR;case Sr.DIFFERENCE:return r===L.INTERIOR&&o!==L.INTERIOR;case Sr.SYMDIFFERENCE:return r===L.INTERIOR&&o!==L.INTERIOR||r!==L.INTERIOR&&o===L.INTERIOR}return!1}},Sr.INTERSECTION=1,Sr.UNION=2,Sr.DIFFERENCE=3,Sr.SYMDIFFERENCE=4;var br=function(){this._g=null,this._boundaryDistanceTolerance=null,this._linework=null,this._ptLocator=new Ci,this._seg=new dn;var t=arguments[0],e=arguments[1];this._g=t,this._boundaryDistanceTolerance=e,this._linework=this.extractLinework(t)};br.prototype.isWithinToleranceOfBoundary=function(t){for(var e=0;e<this._linework.getNumGeometries();e++)for(var n=this._linework.getGeometryN(e).getCoordinateSequence(),i=0;i<n.size()-1;i++)if(n.getCoordinate(i,this._seg.p0),n.getCoordinate(i+1,this._seg.p1),this._seg.distance(t)<=this._boundaryDistanceTolerance)return!0;return!1},br.prototype.getLocation=function(t){return this.isWithinToleranceOfBoundary(t)?L.BOUNDARY:this._ptLocator.locate(t,this._g)},br.prototype.extractLinework=function(t){var e=new Lr;t.apply(e);var n=e.getLinework(),i=_e.toLineStringArray(n);return t.getFactory().createMultiLineString(i)},br.prototype.interfaces_=function(){return[]},br.prototype.getClass=function(){return br};var Lr=function(){this._linework=null,this._linework=new Nt};Lr.prototype.getLinework=function(){return this._linework},Lr.prototype.filter=function(t){if(t instanceof Zt){var e=t;this._linework.add(e.getExteriorRing());for(var n=0;n<e.getNumInteriorRing();n++)this._linework.add(e.getInteriorRingN(n))}},Lr.prototype.interfaces_=function(){return[qt]},Lr.prototype.getClass=function(){return Lr};var Or=function(){this._g=null,this._doLeft=!0,this._doRight=!0,this._g=arguments[0]};Or.prototype.extractPoints=function(t,e,n){for(var i=t.getCoordinates(),r=0;r<i.length-1;r++)this.computeOffsetPoints(i[r],i[r+1],e,n)},Or.prototype.setSidesToGenerate=function(t,e){this._doLeft=t,this._doRight=e},Or.prototype.getPoints=function(t){for(var e=new Nt,n=wi.getLines(this._g).iterator();n.hasNext();){var i=n.next();this.extractPoints(i,t,e)}return e},Or.prototype.computeOffsetPoints=function(t,e,n,i){var r=e.x-t.x,o=e.y-t.y,s=Math.sqrt(r*r+o*o),a=n*r/s,u=n*o/s,l=(e.x+t.x)/2,c=(e.y+t.y)/2;if(this._doLeft){var h=new w(l-u,c+a);i.add(h)}if(this._doRight){var p=new w(l+u,c-a);i.add(p)}},Or.prototype.interfaces_=function(){return[]},Or.prototype.getClass=function(){return Or};var Pr=function t(){this._geom=null,this._locFinder=null,this._location=new Array(3).fill(null),this._invalidLocation=null,this._boundaryDistanceTolerance=t.TOLERANCE,this._testCoords=new Nt;var e=arguments[0],n=arguments[1],i=arguments[2];this._boundaryDistanceTolerance=t.computeBoundaryDistanceTolerance(e,n),this._geom=[e,n,i],this._locFinder=[new br(this._geom[0],this._boundaryDistanceTolerance),new br(this._geom[1],this._boundaryDistanceTolerance),new br(this._geom[2],this._boundaryDistanceTolerance)]},Tr={TOLERANCE:{configurable:!0}};Pr.prototype.reportResult=function(t,e,n){X.out.println("Overlay result invalid - A:"+L.toLocationSymbol(e[0])+" B:"+L.toLocationSymbol(e[1])+" expected:"+(n?"i":"e")+" actual:"+L.toLocationSymbol(e[2]))},Pr.prototype.isValid=function(t){return this.addTestPts(this._geom[0]),this.addTestPts(this._geom[1]),this.checkValid(t)},Pr.prototype.checkValid=function(){if(1===arguments.length){for(var t=arguments[0],e=0;e<this._testCoords.size();e++){var n=this._testCoords.get(e);if(!this.checkValid(t,n))return this._invalidLocation=n,!1}return!0}if(2===arguments.length){var i=arguments[0],r=arguments[1];return this._location[0]=this._locFinder[0].getLocation(r),this._location[1]=this._locFinder[1].getLocation(r),this._location[2]=this._locFinder[2].getLocation(r),!!Pr.hasLocation(this._location,L.BOUNDARY)||this.isValidResult(i,this._location)}},Pr.prototype.addTestPts=function(t){var e=new Or(t);this._testCoords.addAll(e.getPoints(5*this._boundaryDistanceTolerance))},Pr.prototype.isValidResult=function(t,e){var n=Sr.isResultOfOp(e[0],e[1],t),i=!(n^e[2]===L.INTERIOR);return i||this.reportResult(t,e,n),i},Pr.prototype.getInvalidLocation=function(){return this._invalidLocation},Pr.prototype.interfaces_=function(){return[]},Pr.prototype.getClass=function(){return Pr},Pr.hasLocation=function(t,e){for(var n=0;n<3;n++)if(t[n]===e)return!0;return!1},Pr.computeBoundaryDistanceTolerance=function(t,e){return Math.min(Ki.computeSizeBasedSnapTolerance(t),Ki.computeSizeBasedSnapTolerance(e))},Pr.isValid=function(t,e,n,i){return new Pr(t,e,i).isValid(n)},Tr.TOLERANCE.get=function(){return 1e-6},Object.defineProperties(Pr,Tr);var Mr=function t(e){this._geomFactory=null,this._skipEmpty=!1,this._inputGeoms=null,this._geomFactory=t.extractFactory(e),this._inputGeoms=e};Mr.prototype.extractElements=function(t,e){if(null===t)return null;for(var n=0;n<t.getNumGeometries();n++){var i=t.getGeometryN(n);this._skipEmpty&&i.isEmpty()||e.add(i)}},Mr.prototype.combine=function(){for(var t=new Nt,e=this._inputGeoms.iterator();e.hasNext();){var n=e.next();this.extractElements(n,t)}return 0===t.size()?null!==this._geomFactory?this._geomFactory.createGeometryCollection(null):null:this._geomFactory.buildGeometry(t)},Mr.prototype.interfaces_=function(){return[]},Mr.prototype.getClass=function(){return Mr},Mr.combine=function(){return 1===arguments.length?new Mr(arguments[0]).combine():2===arguments.length?new Mr(Mr.createList(arguments[0],arguments[1])).combine():3===arguments.length?new Mr(Mr.createList(arguments[0],arguments[1],arguments[2])).combine():void 0},Mr.extractFactory=function(t){return t.isEmpty()?null:t.iterator().next().getFactory()},Mr.createList=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=new Nt;return n.add(t),n.add(e),n}if(3===arguments.length){var i=arguments[0],r=arguments[1],o=arguments[2],s=new Nt;return s.add(i),s.add(r),s.add(o),s}};var Rr=function(){this._inputPolys=null,this._geomFactory=null,this._inputPolys=arguments[0],null===this._inputPolys&&(this._inputPolys=new Nt)},Dr={STRTREE_NODE_CAPACITY:{configurable:!0}};Rr.prototype.reduceToGeometries=function(t){for(var e=new Nt,n=t.iterator();n.hasNext();){var i=n.next(),r=null;P(i,Et)?r=this.unionTree(i):i instanceof ct&&(r=i),e.add(r)}return e},Rr.prototype.extractByEnvelope=function(t,e,n){for(var i=new Nt,r=0;r<e.getNumGeometries();r++){var o=e.getGeometryN(r);o.getEnvelopeInternal().intersects(t)?i.add(o):n.add(o)}return this._geomFactory.buildGeometry(i)},Rr.prototype.unionOptimized=function(t,e){var n=t.getEnvelopeInternal(),i=e.getEnvelopeInternal();if(!n.intersects(i))return Mr.combine(t,e);if(t.getNumGeometries()<=1&&e.getNumGeometries()<=1)return this.unionActual(t,e);var r=n.intersection(i);return this.unionUsingEnvelopeIntersection(t,e,r)},Rr.prototype.union=function(){if(null===this._inputPolys)throw new Error("union() method cannot be called twice");if(this._inputPolys.isEmpty())return null;this._geomFactory=this._inputPolys.iterator().next().getFactory();for(var t=new sn(Rr.STRTREE_NODE_CAPACITY),e=this._inputPolys.iterator();e.hasNext();){var n=e.next();t.insert(n.getEnvelopeInternal(),n)}this._inputPolys=null;var i=t.itemsTree();return this.unionTree(i)},Rr.prototype.binaryUnion=function(){if(1===arguments.length){var t=arguments[0];return this.binaryUnion(t,0,t.size())}if(3===arguments.length){var e=arguments[0],n=arguments[1],i=arguments[2];if(i-n<=1){var r=Rr.getGeometry(e,n);return this.unionSafe(r,null)}if(i-n==2)return this.unionSafe(Rr.getGeometry(e,n),Rr.getGeometry(e,n+1));var o=Math.trunc((i+n)/2),s=this.binaryUnion(e,n,o),a=this.binaryUnion(e,o,i);return this.unionSafe(s,a)}},Rr.prototype.repeatedUnion=function(t){for(var e=null,n=t.iterator();n.hasNext();){var i=n.next();e=null===e?i.copy():e.union(i)}return e},Rr.prototype.unionSafe=function(t,e){return null===t&&null===e?null:null===t?e.copy():null===e?t.copy():this.unionOptimized(t,e)},Rr.prototype.unionActual=function(t,e){return Rr.restrictToPolygons(t.union(e))},Rr.prototype.unionTree=function(t){var e=this.reduceToGeometries(t);return this.binaryUnion(e)},Rr.prototype.unionUsingEnvelopeIntersection=function(t,e,n){var i=new Nt,r=this.extractByEnvelope(n,t,i),o=this.extractByEnvelope(n,e,i),s=this.unionActual(r,o);return i.add(s),Mr.combine(i)},Rr.prototype.bufferUnion=function(){if(1===arguments.length){var t=arguments[0];return t.get(0).getFactory().buildGeometry(t).buffer(0)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e.getFactory().createGeometryCollection([e,n]).buffer(0)}},Rr.prototype.interfaces_=function(){return[]},Rr.prototype.getClass=function(){return Rr},Rr.restrictToPolygons=function(t){if(P(t,$t))return t;var e=Ni.getPolygons(t);return 1===e.size()?e.get(0):t.getFactory().createMultiPolygon(_e.toPolygonArray(e))},Rr.getGeometry=function(t,e){return e>=t.size()?null:t.get(e)},Rr.union=function(t){return new Rr(t).union()},Dr.STRTREE_NODE_CAPACITY.get=function(){return 4},Object.defineProperties(Rr,Dr);var Ar=function(){};Ar.prototype.interfaces_=function(){return[]},Ar.prototype.getClass=function(){return Ar},Ar.union=function(t,e){if(t.isEmpty()||e.isEmpty()){if(t.isEmpty()&&e.isEmpty())return Sr.createEmptyResult(Sr.UNION,t,e,t.getFactory());if(t.isEmpty())return e.copy();if(e.isEmpty())return t.copy()}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),or.overlayOp(t,e,Sr.UNION)},t.GeoJSONReader=Ne,t.GeoJSONWriter=we,t.OverlayOp=Sr,t.UnionOp=Ar,t.BufferOp=di,Object.defineProperty(t,"__esModule",{value:!0})}(v.exports)),v.exports);function I(t){if(!t)throw new Error("geojson is required");switch(t.type){case"Feature":return E(t);case"FeatureCollection":return function(t){var e={type:"FeatureCollection"};return Object.keys(t).forEach((function(n){switch(n){case"type":case"features":return;default:e[n]=t[n]}})),e.features=t.features.map((function(t){return E(t)})),e}(t);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return w(t);default:throw new Error("unknown GeoJSON type")}}function E(t){var e={type:"Feature"};return Object.keys(t).forEach((function(n){switch(n){case"type":case"properties":case"geometry":return;default:e[n]=t[n]}})),e.properties=N(t.properties),e.geometry=w(t.geometry),e}function N(t){var e={};return t?(Object.keys(t).forEach((function(n){var i=t[n];e[n]="object"==typeof i?null===i?null:i.length?i.map((function(t){return t})):N(i):i})),e):e}function w(t){var e={type:t.type};return t.bbox&&(e.bbox=t.bbox),"GeometryCollection"===t.type?(e.geometries=t.geometries.map((function(t){return w(t)})),e):(e.coordinates=C(t.coordinates),e)}function C(t){return"object"!=typeof t[0]?t.slice():t.map((function(t){return C(t)}))}function S(t,e,n){if(!l(n=n||{}))throw new Error("options is invalid");var i=n.mutate;if(!t)throw new Error("geojson is required");return Array.isArray(t)&&u(t[0])?t="mercator"===e?b(t):L(t):(!0!==i&&(t=I(t)),p(t,(function(t){var n="mercator"===e?b(t):L(t);t[0]=n[0],t[1]=n[1]}))),t}function b(t){var e=Math.PI/180,n=6378137,i=20037508.342789244,r=Math.abs(t[0])<=180?t[0]:t[0]-360*function(t){return t<0?-1:t>0?1:0}(t[0]),o=[n*r*e,n*Math.log(Math.tan(.25*Math.PI+.5*t[1]*e))];return o[0]>i&&(o[0]=i),o[0]<-i&&(o[0]=-i),o[1]>i&&(o[1]=i),o[1]<-i&&(o[1]=-i),o}function L(t){var e=180/Math.PI,n=6378137;return[t[0]*e/n,(.5*Math.PI-2*Math.atan(Math.exp(-t[1]/n)))*e]}function O(){return new P}function P(){this.reset()}P.prototype={constructor:P,reset:function(){this.s=this.t=0},add:function(t){M(T,t,this.t),M(this,T.s,this.s),this.s?this.t+=T.t:this.s=T.t},valueOf:function(){return this.s}};var T=new P;function M(t,e,n){var i=t.s=e+n,r=i-e;t.t=e-(i-r)+(n-r)}var R=1e-6,D=Math.PI,A=D/2,F=D/4,G=2*D,V=180/D,B=D/180,q=Math.abs,U=Math.atan,k=Math.atan2,z=Math.cos,X=Math.exp,Y=Math.log,j=Math.sin,H=Math.sqrt,W=Math.tan;function J(t){return t>1?A:t<-1?-A:Math.asin(t)}function K(){}function Q(t,e){t&&et.hasOwnProperty(t.type)&&et[t.type](t,e)}var $,Z,tt={Feature:function(t,e){Q(t.geometry,e)},FeatureCollection:function(t,e){for(var n=t.features,i=-1,r=n.length;++i<r;)Q(n[i].geometry,e)}},et={Sphere:function(t,e){e.sphere()},Point:function(t,e){e.point((t=t.coordinates)[0],t[1],t[2])},MultiPoint:function(t,e){for(var n=t.coordinates,i=-1,r=n.length;++i<r;)e.point((t=n[i])[0],t[1],t[2])},LineString:function(t,e){nt(t.coordinates,e,0)},MultiLineString:function(t,e){for(var n=t.coordinates,i=-1,r=n.length;++i<r;)nt(n[i],e,0)},Polygon:function(t,e){it(t.coordinates,e)},MultiPolygon:function(t,e){for(var n=t.coordinates,i=-1,r=n.length;++i<r;)it(n[i],e)},GeometryCollection:function(t,e){for(var n=t.geometries,i=-1,r=n.length;++i<r;)Q(n[i],e)}};function nt(t,e,n){var i,r=-1,o=t.length-n;for(e.lineStart();++r<o;)e.point((i=t[r])[0],i[1],i[2]);e.lineEnd()}function it(t,e){var n=-1,i=t.length;for(e.polygonStart();++n<i;)nt(t[n],e,1);e.polygonEnd()}function rt(t){return[k(t[1],t[0]),J(t[2])]}function ot(t){var e=t[0],n=t[1],i=z(n);return[i*z(e),i*j(e),j(n)]}function st(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function at(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function ut(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]}function lt(t,e){return[t[0]*e,t[1]*e,t[2]*e]}function ct(t){var e=H(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=e,t[1]/=e,t[2]/=e}function ht(t,e){function n(n,i){return n=t(n,i),e(n[0],n[1])}return t.invert&&e.invert&&(n.invert=function(n,i){return(n=e.invert(n,i))&&t.invert(n[0],n[1])}),n}function pt(t,e){return[t>D?t-G:t<-D?t+G:t,e]}function ft(t,e,n){return(t%=G)?e||n?ht(dt(t),yt(e,n)):dt(t):e||n?yt(e,n):pt}function gt(t){return function(e,n){return[(e+=t)>D?e-G:e<-D?e+G:e,n]}}function dt(t){var e=gt(t);return e.invert=gt(-t),e}function yt(t,e){var n=z(t),i=j(t),r=z(e),o=j(e);function s(t,e){var s=z(e),a=z(t)*s,u=j(t)*s,l=j(e),c=l*n+a*i;return[k(u*r-c*o,a*n-l*i),J(c*r+u*o)]}return s.invert=function(t,e){var s=z(e),a=z(t)*s,u=j(t)*s,l=j(e),c=l*r-u*o;return[k(u*r+l*o,a*n+c*i),J(c*n-a*i)]},s}function _t(t,e){(e=ot(e))[0]-=t,ct(e);var n=function(t){return t>1?0:t<-1?D:Math.acos(t)}(-e[1]);return((-e[2]<0?-n:n)+G-R)%G}function mt(){var t,e=[];return{point:function(e,n){t.push([e,n])},lineStart:function(){e.push(t=[])},lineEnd:K,rejoin:function(){e.length>1&&e.push(e.pop().concat(e.shift()))},result:function(){var n=e;return e=[],t=null,n}}}function vt(t,e){return q(t[0]-e[0])<R&&q(t[1]-e[1])<R}function xt(t,e,n,i){this.x=t,this.z=e,this.o=n,this.e=i,this.v=!1,this.n=this.p=null}function It(t,e,n,i,r){var o,s,a=[],u=[];if(t.forEach((function(t){if(!((e=t.length-1)<=0)){var e,n,i=t[0],s=t[e];if(vt(i,s)){for(r.lineStart(),o=0;o<e;++o)r.point((i=t[o])[0],i[1]);r.lineEnd()}else a.push(n=new xt(i,t,null,!0)),u.push(n.o=new xt(i,null,n,!1)),a.push(n=new xt(s,t,null,!1)),u.push(n.o=new xt(s,null,n,!0))}})),a.length){for(u.sort(e),Et(a),Et(u),o=0,s=u.length;o<s;++o)u[o].e=n=!n;for(var l,c,h=a[0];;){for(var p=h,f=!0;p.v;)if((p=p.n)===h)return;l=p.z,r.lineStart();do{if(p.v=p.o.v=!0,p.e){if(f)for(o=0,s=l.length;o<s;++o)r.point((c=l[o])[0],c[1]);else i(p.x,p.n.x,1,r);p=p.n}else{if(f)for(o=(l=p.p.z).length-1;o>=0;--o)r.point((c=l[o])[0],c[1]);else i(p.x,p.p.x,-1,r);p=p.p}l=(p=p.o).z,f=!f}while(!p.v);r.lineEnd()}}}function Et(t){if(e=t.length){for(var e,n,i=0,r=t[0];++i<e;)r.n=n=t[i],n.p=r,r=n;r.n=n=t[0],n.p=r}}function Nt(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function wt(t){for(var e,n,i,r=t.length,o=-1,s=0;++o<r;)s+=t[o].length;for(n=new Array(s);--r>=0;)for(e=(i=t[r]).length;--e>=0;)n[--s]=i[e];return n}O(),O(),O(),pt.invert=pt,1===($=Nt).length&&(Z=$,$=function(t,e){return Nt(Z(t),e)});var Ct=1e9,St=-Ct;function bt(t,e,n,i){function r(r,o){return t<=r&&r<=n&&e<=o&&o<=i}function o(r,o,a,l){var c=0,h=0;if(null==r||(c=s(r,a))!==(h=s(o,a))||u(r,o)<0^a>0)do{l.point(0===c||3===c?t:n,c>1?i:e)}while((c=(c+a+4)%4)!==h);else l.point(o[0],o[1])}function s(i,r){return q(i[0]-t)<R?r>0?0:3:q(i[0]-n)<R?r>0?2:1:q(i[1]-e)<R?r>0?1:0:r>0?3:2}function a(t,e){return u(t.x,e.x)}function u(t,e){var n=s(t,1),i=s(e,1);return n!==i?n-i:0===n?e[1]-t[1]:1===n?t[0]-e[0]:2===n?t[1]-e[1]:e[0]-t[0]}return function(s){var u,l,c,h,p,f,g,d,y,_,m,v=s,x=mt(),I={point:E,lineStart:function(){I.point=N,l&&l.push(c=[]);_=!0,y=!1,g=d=NaN},lineEnd:function(){u&&(N(h,p),f&&y&&x.rejoin(),u.push(x.result()));I.point=E,y&&v.lineEnd()},polygonStart:function(){v=x,u=[],l=[],m=!0},polygonEnd:function(){var e=function(){for(var e=0,n=0,r=l.length;n<r;++n)for(var o,s,a=l[n],u=1,c=a.length,h=a[0],p=h[0],f=h[1];u<c;++u)o=p,s=f,p=(h=a[u])[0],f=h[1],s<=i?f>i&&(p-o)*(i-s)>(f-s)*(t-o)&&++e:f<=i&&(p-o)*(i-s)<(f-s)*(t-o)&&--e;return e}(),n=m&&e,r=(u=wt(u)).length;(n||r)&&(s.polygonStart(),n&&(s.lineStart(),o(null,null,1,s),s.lineEnd()),r&&It(u,a,e,o,s),s.polygonEnd());v=s,u=l=c=null}};function E(t,e){r(t,e)&&v.point(t,e)}function N(o,s){var a=r(o,s);if(l&&c.push([o,s]),_)h=o,p=s,f=a,_=!1,a&&(v.lineStart(),v.point(o,s));else if(a&&y)v.point(o,s);else{var u=[g=Math.max(St,Math.min(Ct,g)),d=Math.max(St,Math.min(Ct,d))],x=[o=Math.max(St,Math.min(Ct,o)),s=Math.max(St,Math.min(Ct,s))];!function(t,e,n,i,r,o){var s,a=t[0],u=t[1],l=0,c=1,h=e[0]-a,p=e[1]-u;if(s=n-a,h||!(s>0)){if(s/=h,h<0){if(s<l)return;s<c&&(c=s)}else if(h>0){if(s>c)return;s>l&&(l=s)}if(s=r-a,h||!(s<0)){if(s/=h,h<0){if(s>c)return;s>l&&(l=s)}else if(h>0){if(s<l)return;s<c&&(c=s)}if(s=i-u,p||!(s>0)){if(s/=p,p<0){if(s<l)return;s<c&&(c=s)}else if(p>0){if(s>c)return;s>l&&(l=s)}if(s=o-u,p||!(s<0)){if(s/=p,p<0){if(s>c)return;s>l&&(l=s)}else if(p>0){if(s<l)return;s<c&&(c=s)}return l>0&&(t[0]=a+l*h,t[1]=u+l*p),c<1&&(e[0]=a+c*h,e[1]=u+c*p),!0}}}}}(u,x,t,e,n,i)?a&&(v.lineStart(),v.point(o,s),m=!1):(y||(v.lineStart(),v.point(u[0],u[1])),v.point(x[0],x[1]),a||v.lineEnd(),m=!1)}g=o,d=s,y=a}return I}}var Lt=O();function Ot(t){return t}O(),O(),O();var Pt=1/0,Tt=Pt,Mt=-Pt,Rt=Mt,Dt={point:function(t,e){t<Pt&&(Pt=t);t>Mt&&(Mt=t);e<Tt&&(Tt=e);e>Rt&&(Rt=e)},lineStart:K,lineEnd:K,polygonStart:K,polygonEnd:K,result:function(){var t=[[Pt,Tt],[Mt,Rt]];return Mt=Rt=-(Tt=Pt=1/0),t}};function At(t,e,n,i){return function(r,o){var s,a,u,l=e(o),c=r.invert(i[0],i[1]),h=mt(),p=e(h),f=!1,g={point:d,lineStart:_,lineEnd:m,polygonStart:function(){g.point=v,g.lineStart=x,g.lineEnd=I,a=[],s=[]},polygonEnd:function(){g.point=d,g.lineStart=_,g.lineEnd=m,a=wt(a);var t=function(t,e){var n=e[0],i=e[1],r=[j(n),-z(n),0],o=0,s=0;Lt.reset();for(var a=0,u=t.length;a<u;++a)if(c=(l=t[a]).length)for(var l,c,h=l[c-1],p=h[0],f=h[1]/2+F,g=j(f),d=z(f),y=0;y<c;++y,p=m,g=x,d=I,h=_){var _=l[y],m=_[0],v=_[1]/2+F,x=j(v),I=z(v),E=m-p,N=E>=0?1:-1,w=N*E,C=w>D,S=g*x;if(Lt.add(k(S*N*j(w),d*I+S*z(w))),o+=C?E+N*G:E,C^p>=n^m>=n){var b=at(ot(h),ot(_));ct(b);var L=at(r,b);ct(L);var O=(C^E>=0?-1:1)*J(L[2]);(i>O||i===O&&(b[0]||b[1]))&&(s+=C^E>=0?1:-1)}}return(o<-R||o<R&&Lt<-R)^1&s}(s,c);a.length?(f||(o.polygonStart(),f=!0),It(a,Gt,t,n,o)):t&&(f||(o.polygonStart(),f=!0),o.lineStart(),n(null,null,1,o),o.lineEnd()),f&&(o.polygonEnd(),f=!1),a=s=null},sphere:function(){o.polygonStart(),o.lineStart(),n(null,null,1,o),o.lineEnd(),o.polygonEnd()}};function d(e,n){var i=r(e,n);t(e=i[0],n=i[1])&&o.point(e,n)}function y(t,e){var n=r(t,e);l.point(n[0],n[1])}function _(){g.point=y,l.lineStart()}function m(){g.point=d,l.lineEnd()}function v(t,e){u.push([t,e]);var n=r(t,e);p.point(n[0],n[1])}function x(){p.lineStart(),u=[]}function I(){v(u[0][0],u[0][1]),p.lineEnd();var t,e,n,i,r=p.clean(),l=h.result(),c=l.length;if(u.pop(),s.push(u),u=null,c)if(1&r){if((e=(n=l[0]).length-1)>0){for(f||(o.polygonStart(),f=!0),o.lineStart(),t=0;t<e;++t)o.point((i=n[t])[0],i[1]);o.lineEnd()}}else c>1&&2&r&&l.push(l.pop().concat(l.shift())),a.push(l.filter(Ft))}return g}}function Ft(t){return t.length>1}function Gt(t,e){return((t=t.x)[0]<0?t[1]-A-R:A-t[1])-((e=e.x)[0]<0?e[1]-A-R:A-e[1])}O();var Vt=At((function(){return!0}),(function(t){var e,n=NaN,i=NaN,r=NaN;return{lineStart:function(){t.lineStart(),e=1},point:function(o,s){var a=o>0?D:-D,u=q(o-n);q(u-D)<R?(t.point(n,i=(i+s)/2>0?A:-A),t.point(r,i),t.lineEnd(),t.lineStart(),t.point(a,i),t.point(o,i),e=0):r!==a&&u>=D&&(q(n-r)<R&&(n-=r*R),q(o-a)<R&&(o-=a*R),i=function(t,e,n,i){var r,o,s=j(t-n);return q(s)>R?U((j(e)*(o=z(i))*j(n)-j(i)*(r=z(e))*j(t))/(r*o*s)):(e+i)/2}(n,i,o,s),t.point(r,i),t.lineEnd(),t.lineStart(),t.point(a,i),e=0),t.point(n=o,i=s),r=a},lineEnd:function(){t.lineEnd(),n=i=NaN},clean:function(){return 2-e}}}),(function(t,e,n,i){var r;if(null==t)i.point(-D,r=n*A),i.point(0,r),i.point(D,r),i.point(D,0),i.point(D,-r),i.point(0,-r),i.point(-D,-r),i.point(-D,0),i.point(-D,r);else if(q(t[0]-e[0])>R){var o=t[0]<e[0]?D:-D;i.point(-o,r=n*o/2),i.point(0,r),i.point(o,r)}else i.point(e[0],e[1])}),[-D,-A]);function Bt(t,e){var n=z(t),i=n>0,r=q(n)>R;function o(t,e){return z(t)*z(e)>n}function s(t,e,i){var r=[1,0,0],o=at(ot(t),ot(e)),s=st(o,o),a=o[0],u=s-a*a;if(!u)return!i&&t;var l=n*s/u,c=-n*a/u,h=at(r,o),p=lt(r,l);ut(p,lt(o,c));var f=h,g=st(p,f),d=st(f,f),y=g*g-d*(st(p,p)-1);if(!(y<0)){var _=H(y),m=lt(f,(-g-_)/d);if(ut(m,p),m=rt(m),!i)return m;var v,x=t[0],I=e[0],E=t[1],N=e[1];I<x&&(v=x,x=I,I=v);var w=I-x,C=q(w-D)<R;if(!C&&N<E&&(v=E,E=N,N=v),C||w<R?C?E+N>0^m[1]<(q(m[0]-x)<R?E:N):E<=m[1]&&m[1]<=N:w>D^(x<=m[0]&&m[0]<=I)){var S=lt(f,(-g+_)/d);return ut(S,p),[m,rt(S)]}}}function a(e,n){var r=i?t:D-t,o=0;return e<-r?o|=1:e>r&&(o|=2),n<-r?o|=4:n>r&&(o|=8),o}return At(o,(function(t){var e,n,u,l,c;return{lineStart:function(){l=u=!1,c=1},point:function(h,p){var f,g=[h,p],d=o(h,p),y=i?d?0:a(h,p):d?a(h+(h<0?D:-D),p):0;if(!e&&(l=u=d)&&t.lineStart(),d!==u&&(!(f=s(e,g))||vt(e,f)||vt(g,f))&&(g[0]+=R,g[1]+=R,d=o(g[0],g[1])),d!==u)c=0,d?(t.lineStart(),f=s(g,e),t.point(f[0],f[1])):(f=s(e,g),t.point(f[0],f[1]),t.lineEnd()),e=f;else if(r&&e&&i^d){var _;y&n||!(_=s(g,e,!0))||(c=0,i?(t.lineStart(),t.point(_[0][0],_[0][1]),t.point(_[1][0],_[1][1]),t.lineEnd()):(t.point(_[1][0],_[1][1]),t.lineEnd(),t.lineStart(),t.point(_[0][0],_[0][1])))}!d||e&&vt(e,g)||t.point(g[0],g[1]),e=g,u=d,n=y},lineEnd:function(){u&&t.lineEnd(),e=null},clean:function(){return c|(l&&u)<<1}}}),(function(n,i,r,o){!function(t,e,n,i,r,o){if(n){var s=z(e),a=j(e),u=i*n;null==r?(r=e+i*G,o=e-u/2):(r=_t(s,r),o=_t(s,o),(i>0?r<o:r>o)&&(r+=i*G));for(var l,c=r;i>0?c>o:c<o;c-=u)l=rt([s,-a*z(c),-a*j(c)]),t.point(l[0],l[1])}}(o,t,e,r,n,i)}),i?[0,-t]:[-D,t-D])}function qt(t){return function(e){var n=new Ut;for(var i in t)n[i]=t[i];return n.stream=e,n}}function Ut(){}function kt(t,e,n){var i=e[1][0]-e[0][0],r=e[1][1]-e[0][1],o=t.clipExtent&&t.clipExtent();t.scale(150).translate([0,0]),null!=o&&t.clipExtent(null),function(t,e){t&&tt.hasOwnProperty(t.type)?tt[t.type](t,e):Q(t,e)}(n,t.stream(Dt));var s=Dt.result(),a=Math.min(i/(s[1][0]-s[0][0]),r/(s[1][1]-s[0][1])),u=+e[0][0]+(i-a*(s[1][0]+s[0][0]))/2,l=+e[0][1]+(r-a*(s[1][1]+s[0][1]))/2;return null!=o&&t.clipExtent(o),t.scale(150*a).translate([u,l])}Ut.prototype={constructor:Ut,point:function(t,e){this.stream.point(t,e)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};var zt=z(30*B);function Xt(t,e){return+e?function(t,e){function n(i,r,o,s,a,u,l,c,h,p,f,g,d,y){var _=l-i,m=c-r,v=_*_+m*m;if(v>4*e&&d--){var x=s+p,I=a+f,E=u+g,N=H(x*x+I*I+E*E),w=J(E/=N),C=q(q(E)-1)<R||q(o-h)<R?(o+h)/2:k(I,x),S=t(C,w),b=S[0],L=S[1],O=b-i,P=L-r,T=m*O-_*P;(T*T/v>e||q((_*O+m*P)/v-.5)>.3||s*p+a*f+u*g<zt)&&(n(i,r,o,s,a,u,b,L,C,x/=N,I/=N,E,d,y),y.point(b,L),n(b,L,C,x,I,E,l,c,h,p,f,g,d,y))}}return function(e){var i,r,o,s,a,u,l,c,h,p,f,g,d={point:y,lineStart:_,lineEnd:v,polygonStart:function(){e.polygonStart(),d.lineStart=x},polygonEnd:function(){e.polygonEnd(),d.lineStart=_}};function y(n,i){n=t(n,i),e.point(n[0],n[1])}function _(){c=NaN,d.point=m,e.lineStart()}function m(i,r){var o=ot([i,r]),s=t(i,r);n(c,h,l,p,f,g,c=s[0],h=s[1],l=i,p=o[0],f=o[1],g=o[2],16,e),e.point(c,h)}function v(){d.point=y,e.lineEnd()}function x(){_(),d.point=I,d.lineEnd=E}function I(t,e){m(i=t,e),r=c,o=h,s=p,a=f,u=g,d.point=m}function E(){n(c,h,l,p,f,g,r,o,i,s,a,u,16,e),d.lineEnd=v,v()}return d}}(t,e):function(t){return qt({point:function(e,n){e=t(e,n),this.stream.point(e[0],e[1])}})}(t)}var Yt=qt({point:function(t,e){this.stream.point(t*B,e*B)}});function jt(t){return function(t){var e,n,i,r,o,s,a,u,l,c,h=150,p=480,f=250,g=0,d=0,y=0,_=0,m=0,v=null,x=Vt,I=null,E=Ot,N=.5,w=Xt(b,N);function C(t){return[(t=o(t[0]*B,t[1]*B))[0]*h+n,i-t[1]*h]}function S(t){return(t=o.invert((t[0]-n)/h,(i-t[1])/h))&&[t[0]*V,t[1]*V]}function b(t,r){return[(t=e(t,r))[0]*h+n,i-t[1]*h]}function L(){o=ht(r=ft(y,_,m),e);var t=e(g,d);return n=p-t[0]*h,i=f+t[1]*h,O()}function O(){return l=c=null,C}return C.stream=function(t){return l&&c===t?l:l=Yt(x(r,w(E(c=t))))},C.clipAngle=function(t){return arguments.length?(x=+t?Bt(v=t*B,6*B):(v=null,Vt),O()):v*V},C.clipExtent=function(t){return arguments.length?(E=null==t?(I=s=a=u=null,Ot):bt(I=+t[0][0],s=+t[0][1],a=+t[1][0],u=+t[1][1]),O()):null==I?null:[[I,s],[a,u]]},C.scale=function(t){return arguments.length?(h=+t,L()):h},C.translate=function(t){return arguments.length?(p=+t[0],f=+t[1],L()):[p,f]},C.center=function(t){return arguments.length?(g=t[0]%360*B,d=t[1]%360*B,L()):[g*V,d*V]},C.rotate=function(t){return arguments.length?(y=t[0]%360*B,_=t[1]%360*B,m=t.length>2?t[2]%360*B:0,L()):[y*V,_*V,m*V]},C.precision=function(t){return arguments.length?(w=Xt(b,N=t*t),O()):H(N)},C.fitExtent=function(t,e){return kt(C,t,e)},C.fitSize=function(t,e){return function(t,e,n){return kt(t,[[0,0],e],n)}(C,t,e)},function(){return e=t.apply(this,arguments),C.invert=e.invert&&S,L()}}((function(){return t}))()}function Ht(t,e){return[t,Y(W((A+e)/2))]}function Wt(t){var e,n,i,r=jt(t),o=r.center,s=r.scale,a=r.translate,u=r.clipExtent,l=null;function c(){var o=D*s(),a=r(function(t){function e(e){return(e=t(e[0]*B,e[1]*B))[0]*=V,e[1]*=V,e}return t=ft(t[0]*B,t[1]*B,t.length>2?t[2]*B:0),e.invert=function(e){return(e=t.invert(e[0]*B,e[1]*B))[0]*=V,e[1]*=V,e},e}(r.rotate()).invert([0,0]));return u(null==l?[[a[0]-o,a[1]-o],[a[0]+o,a[1]+o]]:t===Ht?[[Math.max(a[0]-o,l),e],[Math.min(a[0]+o,n),i]]:[[l,Math.max(a[1]-o,e)],[n,Math.min(a[1]+o,i)]])}return r.scale=function(t){return arguments.length?(s(t),c()):s()},r.translate=function(t){return arguments.length?(a(t),c()):a()},r.center=function(t){return arguments.length?(o(t),c()):o()},r.clipExtent=function(t){return arguments.length?(null==t?l=e=n=i=null:(l=+t[0][0],e=+t[0][1],n=+t[1][0],i=+t[1][1]),c()):null==l?null:[[l,e],[n,i]]},c()}function Jt(t,e){return[t,e]}function Kt(t,e){return[Y(W((A+e)/2)),-t]}function Qt(t,e,n){var i=(n=n||{}).units,r=n.steps||64;if(!t)throw new Error("geojson is required");if("object"!=typeof n)throw new Error("options must be an object");if("number"!=typeof r)throw new Error("steps must be an number");if(void 0===e)throw new Error("radius is required");if(r<=0)throw new Error("steps must be greater than 0");r=r||64,i=i||"kilometers";var s=[];switch(t.type){case"GeometryCollection":return g(t,(function(t){var n=$t(t,e,i);n&&s.push(n)})),o(s);case"FeatureCollection":return f(t,(function(t){var n=$t(t,e,i);n&&f(n,(function(t){t&&s.push(t)}))})),o(s)}return $t(t,e,i)}function $t(t,i,r,a){var u,l=t.properties||{},c="Feature"===t.type?t.geometry:t;if("GeometryCollection"===c.type){var h=[];return g(t,(function(t){var e=$t(t,i,r);e&&h.push(e)})),o(h)}var p=d(t),f=p[1]>50&&p[3]>50;u=f?{type:c.type,coordinates:te(c.coordinates,ne(c))}:function(t,e){return S(t,"mercator",e)}(c);var y,_=(new x.GeoJSONReader).read(u),m=s(function(t,n){if(null==t)throw new Error("distance is required");if(n&&"string"!=typeof n)throw new Error("units must be a string");var i=e[n||"kilometers"];if(!i)throw new Error(n+" units is invalid");return t/i}(i,r),"meters"),v=x.BufferOp.bufferOp(_,m);if(!Zt((v=(new x.GeoJSONWriter).write(v)).coordinates))return y=f?{type:v.type,coordinates:ee(v.coordinates,ne(c))}:function(t,e){return S(t,"wgs84",e)}(v),y.geometry?y:n(y,l)}function Zt(t){return Array.isArray(t[0])?Zt(t[0]):isNaN(t[0])}function te(t,e){return"object"!=typeof t[0]?e(t):t.map((function(t){return te(t,e)}))}function ee(t,e){return"object"!=typeof t[0]?e.invert(t):t.map((function(t){return ee(t,e)}))}function ne(e){var n=function(t,e){if(!l(e=e||{}))throw new Error("options is invalid");var n=e.properties;if(!t)throw new Error("geojson is required");var r=d(t);return i([(r[0]+r[2])/2,(r[1]+r[3])/2],n)}(e).geometry.coordinates.reverse(),r=n.map((function(t){return-t}));return function(){var t=Wt(Kt),e=t.center,n=t.rotate;return t.center=function(t){return arguments.length?e([-t[1],t[0]]):[(t=e())[1],-t[0]]},t.rotate=function(t){return arguments.length?n([t[0],t[1],t.length>2?t[2]+90:90]):[(t=n())[0],t[1],t[2]-90]},n([0,0,90]).scale(159.155)}().center(n).rotate(r).scale(t)}function ie(){for(var t=new x.GeoJSONReader,e=t.read(JSON.stringify(arguments[0].geometry)),n=1;n<arguments.length;n++)e=x.UnionOp.union(e,t.read(JSON.stringify(arguments[n].geometry)));return{type:"Feature",geometry:e=(new x.GeoJSONWriter).write(e),properties:arguments[0].properties}}\n/**\n * @license\n * Copyright 2019 Google LLC\n * SPDX-License-Identifier: Apache-2.0\n */Ht.invert=function(t,e){return[t,2*U(X(e))-A]},Jt.invert=Jt,Kt.invert=function(t,e){return[-e,2*U(X(t))-A]};const re=Symbol("Comlink.proxy"),oe=Symbol("Comlink.endpoint"),se=Symbol("Comlink.releaseProxy"),ae=Symbol("Comlink.finalizer"),ue=Symbol("Comlink.thrown"),le=t=>"object"==typeof t&&null!==t||"function"==typeof t,ce={canHandle:t=>le(t)&&t[re],serialize(t){const{port1:e,port2:n}=new MessageChannel;return pe(t,e),[n,[n]]},deserialize:t=>(t.start(),function(t,e){const n=new Map;return t.addEventListener("message",(function(t){const{data:e}=t;if(!e||!e.id)return;const i=n.get(e.id);if(i)try{i(e)}finally{n.delete(e.id)}})),me(t,n,[],e)}(t))},he=new Map([["proxy",ce],["throw",{canHandle:t=>le(t)&&ue in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function pe(t,e=globalThis,n=["*"]){e.addEventListener("message",(function i(r){if(!r||!r.data)return;if(!function(t,e){for(const n of t){if(e===n||"*"===n)return!0;if(n instanceof RegExp&&n.test(e))return!0}return!1}(n,r.origin))return void console.warn(`Invalid origin \'${r.origin}\' for comlink proxy`);const{id:o,type:s,path:a}=Object.assign({path:[]},r.data),u=(r.data.argumentList||[]).map(Ne);let l;try{const e=a.slice(0,-1).reduce(((t,e)=>t[e]),t),n=a.reduce(((t,e)=>t[e]),t);switch(s){case"GET":l=n;break;case"SET":e[a.slice(-1)[0]]=Ne(r.data.value),l=!0;break;case"APPLY":l=n.apply(e,u);break;case"CONSTRUCT":l=function(t){return Object.assign(t,{[re]:!0})}(new n(...u));break;case"ENDPOINT":{const{port1:e,port2:n}=new MessageChannel;pe(t,n),l=Ie(e,[e])}break;case"RELEASE":l=void 0;break;default:return}}catch(t){l={value:t,[ue]:0}}Promise.resolve(l).catch((t=>({value:t,[ue]:0}))).then((n=>{const[r,a]=Ee(n);e.postMessage(Object.assign(Object.assign({},r),{id:o}),a),"RELEASE"===s&&(e.removeEventListener("message",i),fe(e),ae in t&&"function"==typeof t[ae]&&t[ae]())})).catch((t=>{const[n,i]=Ee({value:new TypeError("Unserializable return value"),[ue]:0});e.postMessage(Object.assign(Object.assign({},n),{id:o}),i)}))})),e.start&&e.start()}function fe(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function ge(t){if(t)throw new Error("Proxy has been released and is not useable")}function de(t){return we(t,new Map,{type:"RELEASE"}).then((()=>{fe(t)}))}const ye=new WeakMap,_e="FinalizationRegistry"in globalThis&&new FinalizationRegistry((t=>{const e=(ye.get(t)||0)-1;ye.set(t,e),0===e&&de(t)}));function me(t,e,n=[],i=function(){}){let r=!1;const o=new Proxy(i,{get(i,s){if(ge(r),s===se)return()=>{!function(t){_e&&_e.unregister(t)}(o),de(t),e.clear(),r=!0};if("then"===s){if(0===n.length)return{then:()=>o};const i=we(t,e,{type:"GET",path:n.map((t=>t.toString()))}).then(Ne);return i.then.bind(i)}return me(t,e,[...n,s])},set(i,o,s){ge(r);const[a,u]=Ee(s);return we(t,e,{type:"SET",path:[...n,o].map((t=>t.toString())),value:a},u).then(Ne)},apply(i,o,s){ge(r);const a=n[n.length-1];if(a===oe)return we(t,e,{type:"ENDPOINT"}).then(Ne);if("bind"===a)return me(t,e,n.slice(0,-1));const[u,l]=ve(s);return we(t,e,{type:"APPLY",path:n.map((t=>t.toString())),argumentList:u},l).then(Ne)},construct(i,o){ge(r);const[s,a]=ve(o);return we(t,e,{type:"CONSTRUCT",path:n.map((t=>t.toString())),argumentList:s},a).then(Ne)}});return function(t,e){const n=(ye.get(e)||0)+1;ye.set(e,n),_e&&_e.register(t,e,t)}(o,t),o}function ve(t){const e=t.map(Ee);return[e.map((t=>t[0])),(n=e.map((t=>t[1])),Array.prototype.concat.apply([],n))];var n}const xe=new WeakMap;function Ie(t,e){return xe.set(t,e),t}function Ee(t){for(const[e,n]of he)if(n.canHandle(t)){const[i,r]=n.serialize(t);return[{type:"HANDLER",name:e,value:i},r]}return[{type:"RAW",value:t},xe.get(t)||[]]}function Ne(t){switch(t.type){case"HANDLER":return he.get(t.name).deserialize(t.value);case"RAW":return t.value}}function we(t,e,n,i){return new Promise((r=>{const o=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.set(o,r),t.start&&t.start(),t.postMessage(Object.assign({id:o},n),i)}))}var Ce=Uint8Array,Se=Uint16Array,be=Int32Array,Le=new Ce([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Oe=new Ce([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Pe=new Ce([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Te=function(t,e){for(var n=new Se(31),i=0;i<31;++i)n[i]=e+=1<<t[i-1];var r=new be(n[30]);for(i=1;i<30;++i)for(var o=n[i];o<n[i+1];++o)r[o]=o-n[i]<<5|i;return{b:n,r:r}},Me=Te(Le,2),Re=Me.b,De=Me.r;Re[28]=258,De[258]=28;for(var Ae=Te(Oe,0).b,Fe=new Se(32768),Ge=0;Ge<32768;++Ge){var Ve=(43690&Ge)>>1|(21845&Ge)<<1;Fe[Ge]=((65280&(Ve=(61680&(Ve=(52428&Ve)>>2|(13107&Ve)<<2))>>4|(3855&Ve)<<4))>>8|(255&Ve)<<8)>>1}var Be=function(t,e,n){for(var i=t.length,r=0,o=new Se(e);r<i;++r)t[r]&&++o[t[r]-1];var s,a=new Se(e);for(r=1;r<e;++r)a[r]=a[r-1]+o[r-1]<<1;if(n){s=new Se(1<<e);var u=15-e;for(r=0;r<i;++r)if(t[r])for(var l=r<<4|t[r],c=e-t[r],h=a[t[r]-1]++<<c,p=h|(1<<c)-1;h<=p;++h)s[Fe[h]>>u]=l}else for(s=new Se(i),r=0;r<i;++r)t[r]&&(s[r]=Fe[a[t[r]-1]++]>>15-t[r]);return s},qe=new Ce(288);for(Ge=0;Ge<144;++Ge)qe[Ge]=8;for(Ge=144;Ge<256;++Ge)qe[Ge]=9;for(Ge=256;Ge<280;++Ge)qe[Ge]=7;for(Ge=280;Ge<288;++Ge)qe[Ge]=8;var Ue=new Ce(32);for(Ge=0;Ge<32;++Ge)Ue[Ge]=5;var ke=Be(qe,9,1),ze=Be(Ue,5,1),Xe=function(t){for(var e=t[0],n=1;n<t.length;++n)t[n]>e&&(e=t[n]);return e},Ye=function(t,e,n){var i=e/8|0;return(t[i]|t[i+1]<<8)>>(7&e)&n},je=function(t,e){var n=e/8|0;return(t[n]|t[n+1]<<8|t[n+2]<<16)>>(7&e)},He=function(t,e,n){return(null==e||e<0)&&(e=0),(null==n||n>t.length)&&(n=t.length),new Ce(t.subarray(e,n))},We=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Je=function(t,e,n){var i=new Error(e||We[t]);if(i.code=t,Error.captureStackTrace&&Error.captureStackTrace(i,Je),!n)throw i;return i},Ke=new Ce(0),Qe=function(t,e){return t[e]|t[e+1]<<8},$e=function(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0},Ze=function(t,e){return $e(t,e)+4294967296*$e(t,e+4)},tn=function(){function t(t,e){"function"==typeof t&&(e=t,t={}),this.ondata=e;var n=t&&t.dictionary&&t.dictionary.subarray(-32768);this.s={i:0,b:n?n.length:0},this.o=new Ce(32768),this.p=new Ce(0),n&&this.o.set(n)}return t.prototype.e=function(t){if(this.ondata||Je(5),this.d&&Je(4),this.p.length){if(t.length){var e=new Ce(this.p.length+t.length);e.set(this.p),e.set(t,this.p.length),this.p=e}}else this.p=t},t.prototype.c=function(t){this.s.i=+(this.d=t||!1);var e=this.s.b,n=function(t,e,n,i){var r=t.length;if(!r||e.f&&!e.l)return n||new Ce(0);var o=!n,s=o||2!=e.i,a=e.i;o&&(n=new Ce(3*r));var u=function(t){var e=n.length;if(t>e){var i=new Ce(Math.max(2*e,t));i.set(n),n=i}},l=e.f||0,c=e.p||0,h=e.b||0,p=e.l,f=e.d,g=e.m,d=e.n,y=8*r;do{if(!p){l=Ye(t,c,1);var _=Ye(t,c+1,3);if(c+=3,!_){var m=t[(O=4+((c+7)/8|0))-4]|t[O-3]<<8,v=O+m;if(v>r){a&&Je(0);break}s&&u(h+m),n.set(t.subarray(O,v),h),e.b=h+=m,e.p=c=8*v,e.f=l;continue}if(1==_)p=ke,f=ze,g=9,d=5;else if(2==_){var x=Ye(t,c,31)+257,I=Ye(t,c+10,15)+4,E=x+Ye(t,c+5,31)+1;c+=14;for(var N=new Ce(E),w=new Ce(19),C=0;C<I;++C)w[Pe[C]]=Ye(t,c+3*C,7);c+=3*I;var S=Xe(w),b=(1<<S)-1,L=Be(w,S,1);for(C=0;C<E;){var O,P=L[Ye(t,c,b)];if(c+=15&P,(O=P>>4)<16)N[C++]=O;else{var T=0,M=0;for(16==O?(M=3+Ye(t,c,3),c+=2,T=N[C-1]):17==O?(M=3+Ye(t,c,7),c+=3):18==O&&(M=11+Ye(t,c,127),c+=7);M--;)N[C++]=T}}var R=N.subarray(0,x),D=N.subarray(x);g=Xe(R),d=Xe(D),p=Be(R,g,1),f=Be(D,d,1)}else Je(1);if(c>y){a&&Je(0);break}}s&&u(h+131072);for(var A=(1<<g)-1,F=(1<<d)-1,G=c;;G=c){var V=(T=p[je(t,c)&A])>>4;if((c+=15&T)>y){a&&Je(0);break}if(T||Je(2),V<256)n[h++]=V;else{if(256==V){G=c,p=null;break}var B=V-254;V>264&&(B=Ye(t,c,(1<<(k=Le[C=V-257]))-1)+Re[C],c+=k);var q=f[je(t,c)&F],U=q>>4;if(q||Je(3),c+=15&q,D=Ae[U],U>3){var k=Oe[U];D+=je(t,c)&(1<<k)-1,c+=k}if(c>y){a&&Je(0);break}s&&u(h+131072);var z=h+B;if(h<D){var X=0-D,Y=Math.min(D,z);for(X+h<0&&Je(3);h<Y;++h)n[h]=i[X+h]}for(;h<z;++h)n[h]=n[h-D]}}e.l=p,e.p=G,e.b=h,e.f=l,p&&(l=1,e.m=g,e.d=f,e.n=d)}while(!l);return h!=n.length&&o?He(n,0,h):n.subarray(0,h)}(this.p,this.s,this.o);this.ondata(He(n,e,this.s.b),this.d),this.o=He(n,this.s.b-32768),this.s.b=this.o.length,this.p=He(this.p,this.s.p/8|0),this.s.p&=7},t.prototype.push=function(t,e){this.e(t),this.c(e)},t}(),en="undefined"!=typeof TextDecoder&&new TextDecoder,nn=0;try{en.decode(Ke,{stream:!0}),nn=1}catch(t){}var rn=function(t){for(var e="",n=0;;){var i=t[n++],r=(i>127)+(i>223)+(i>239);if(n+r>t.length)return{s:e,r:He(t,n-1)};r?3==r?(i=((15&i)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536,e+=String.fromCharCode(55296|i>>10,56320|1023&i)):e+=String.fromCharCode(1&r?(31&i)<<6|63&t[n++]:(15&i)<<12|(63&t[n++])<<6|63&t[n++]):e+=String.fromCharCode(i)}},on=function(){function t(t){this.ondata=t,nn?this.t=new TextDecoder:this.p=Ke}return t.prototype.push=function(t,e){if(this.ondata||Je(5),e=!!e,this.t)return this.ondata(this.t.decode(t,{stream:!0}),e),void(e&&(this.t.decode().length&&Je(8),this.t=null));this.p||Je(4);var n=new Ce(this.p.length+t.length);n.set(this.p),n.set(t,this.p.length);var i=rn(n),r=i.s,o=i.r;e?(o.length&&Je(8),this.p=null):this.p=o,this.ondata(r,e)},t}();var sn,an,un,ln,cn,hn=function(){function t(){}return t.prototype.push=function(t,e){this.ondata(null,t,e)},t.compression=0,t}(),pn=function(){function t(){var t=this;this.i=new tn((function(e,n){t.ondata(null,e,n)}))}return t.prototype.push=function(t,e){try{this.i.push(t,e)}catch(t){this.ondata(t,null,e)}},t.compression=8,t}(),fn=function(){function t(t){this.onfile=t,this.k=[],this.o={0:hn},this.p=Ke}return t.prototype.push=function(t,e){var n=this;if(this.onfile||Je(5),this.p||Je(4),this.c>0){var i=Math.min(this.c,t.length),r=t.subarray(0,i);if(this.c-=i,this.d?this.d.push(r,!this.c):this.k[0].push(r),(t=t.subarray(i)).length)return this.push(t,e)}else{var o=0,s=0,a=void 0,u=void 0;this.p.length?t.length?((u=new Ce(this.p.length+t.length)).set(this.p),u.set(t,this.p.length)):u=this.p:u=t;for(var l=u.length,c=this.c,h=c&&this.d,p=function(){var t,e=$e(u,s);if(67324752==e){o=1,a=s,f.d=null,f.c=0;var i=Qe(u,s+6),r=Qe(u,s+8),h=2048&i,p=8&i,g=Qe(u,s+26),d=Qe(u,s+28);if(l>s+30+g+d){var y=[];f.k.unshift(y),o=2;var _,m=$e(u,s+18),v=$e(u,s+22),x=function(t,e){if(e){for(var n="",i=0;i<t.length;i+=16384)n+=String.fromCharCode.apply(null,t.subarray(i,i+16384));return n}if(en)return en.decode(t);var r=rn(t),o=r.s;return(n=r.r).length&&Je(8),o}(u.subarray(s+30,s+=30+g),!h);4294967295==m?(t=p?[-2]:function(t,e){for(;1!=Qe(t,e);e+=4+Qe(t,e+2));return[Ze(t,e+12),Ze(t,e+4),Ze(t,e+20)]}(u,s),m=t[0],v=t[1]):p&&(m=-1),s+=d,f.c=m;var I={name:x,compression:r,start:function(){if(I.ondata||Je(5),m){var t=n.o[r];t||I.ondata(Je(14,"unknown compression type "+r,1),null,!1),(_=m<0?new t(x):new t(x,m,v)).ondata=function(t,e,n){I.ondata(t,e,n)};for(var e=0,i=y;e<i.length;e++){_.push(i[e],!1)}n.k[0]==y&&n.c?n.d=_:_.push(Ke,!0)}else I.ondata(null,Ke,!0)},terminate:function(){_&&_.terminate&&_.terminate()}};m>=0&&(I.size=m,I.originalSize=v),f.onfile(I)}return"break"}if(c){if(134695760==e)return a=s+=12+(-2==c&&8),o=3,f.c=0,"break";if(33639248==e)return a=s-=4,o=3,f.c=0,"break"}},f=this;s<l-4;++s){if("break"===p())break}if(this.p=Ke,c<0){var g=u.subarray(0,o?a-12-(-2==c&&8)-(134695760==$e(u,a-16)&&4):s);h?h.push(g,!!o):this.k[+(2==o)].push(g)}if(2&o)return this.push(u.subarray(s),e);this.p=u.subarray(s)}e&&(this.c&&Je(13),this.p=null)},t.prototype.register=function(t){this.o[t.compression]=t},t}(),gn={};function dn(){if(an)return sn;an=1,sn=function(s,u){t={},n=[],e=0,i=0,r=1,a(s),r=Math.min(r,o);for(var l=Math.ceil(Math.log(r)/Math.LN10),c=0;c<n.length;c++)u.writeStringField(1,n[c]);2!==i&&u.writeVarintField(2,i);6!==l&&u.writeVarintField(3,l);"FeatureCollection"===s.type?u.writeMessage(4,p,s):"Feature"===s.type?u.writeMessage(5,f,s):u.writeMessage(6,g,s);return t=null,u.finish()};var t,e,n,i,r,o=1e6,s={Point:0,MultiPoint:1,LineString:2,MultiLineString:3,Polygon:4,MultiPolygon:5,GeometryCollection:6};function a(t){var e,n;if("FeatureCollection"===t.type)for(e=0;e<t.features.length;e++)a(t.features[e]);else if("Feature"===t.type)for(n in null!==t.geometry&&a(t.geometry),t.properties)h(n);else if("Point"===t.type)c(t.coordinates);else if("MultiPoint"===t.type)l(t.coordinates);else if("GeometryCollection"===t.type)for(e=0;e<t.geometries.length;e++)a(t.geometries[e]);else if("LineString"===t.type)l(t.coordinates);else if("Polygon"===t.type||"MultiLineString"===t.type)u(t.coordinates);else if("MultiPolygon"===t.type)for(e=0;e<t.coordinates.length;e++)u(t.coordinates[e]);for(n in t)x(n,t.type)||h(n)}function u(t){for(var e=0;e<t.length;e++)l(t[e])}function l(t){for(var e=0;e<t.length;e++)c(t[e])}function c(t){i=Math.max(i,t.length);for(var e=0;e<t.length;e++)for(;Math.round(t[e]*r)/r!==t[e]&&r<o;)r*=10}function h(i){void 0===t[i]&&(n.push(i),t[i]=e++)}function p(t,e){for(var n=0;n<t.features.length;n++)e.writeMessage(1,f,t.features[n]);d(t,e,!0)}function f(t,e){null!==t.geometry&&e.writeMessage(1,g,t.geometry),void 0!==t.id&&("number"==typeof t.id&&t.id%1==0?e.writeSVarintField(12,t.id):e.writeStringField(11,t.id)),t.properties&&d(t.properties,e),d(t,e,!0)}function g(t,e){e.writeVarintField(1,s[t.type]);var n=t.coordinates;if("Point"===t.type)!function(t,e){for(var n=[],o=0;o<i;o++)n.push(Math.round(t[o]*r));e.writePackedSVarint(3,n)}(n,e);else if("MultiPoint"===t.type)_(n,e);else if("LineString"===t.type)_(n,e);else if("MultiLineString"===t.type)m(n,e);else if("Polygon"===t.type)m(n,e,!0);else if("MultiPolygon"===t.type)!function(t,e){var n,i,r=t.length;if(1!==r||1!==t[0].length){var o=[r];for(n=0;n<r;n++)for(o.push(t[n].length),i=0;i<t[n].length;i++)o.push(t[n][i].length-1);e.writePackedVarint(2,o)}var s=[];for(n=0;n<r;n++)for(i=0;i<t[n].length;i++)v(s,t[n][i],!0);e.writePackedSVarint(3,s)}(n,e);else if("GeometryCollection"===t.type)for(var o=0;o<t.geometries.length;o++)e.writeMessage(4,g,t.geometries[o]);d(t,e,!0)}function d(e,n,i){var r=[],o=0;for(var s in e)i&&x(s,e.type)||(n.writeMessage(13,y,e[s]),r.push(t[s]),r.push(o++));n.writePackedVarint(i?15:14,r)}function y(t,e){if(null!==t){var n=typeof t;"string"===n?e.writeStringField(1,t):"boolean"===n?e.writeBooleanField(5,t):"object"===n?e.writeStringField(6,JSON.stringify(t)):"number"===n&&(t%1!=0?e.writeDoubleField(2,t):t>=0?e.writeVarintField(3,t):e.writeVarintField(4,-t))}}function _(t,e){var n=[];v(n,t),e.writePackedSVarint(3,n)}function m(t,e,n){var i,r=t.length;if(1!==r){var o=[];for(i=0;i<r;i++)o.push(t[i].length-(n?1:0));e.writePackedVarint(2,o)}var s=[];for(i=0;i<r;i++)v(s,t[i],n);e.writePackedSVarint(3,s)}function v(t,e,n){var o,s,a=e.length-(n?1:0),u=new Array(i);for(s=0;s<i;s++)u[s]=0;for(o=0;o<a;o++)for(s=0;s<i;s++){var l=Math.round(e[o][s]*r)-u[s];t.push(l),u[s]+=l}}function x(t,e){if("type"===t)return!0;if("FeatureCollection"===e){if("features"===t)return!0}else if("Feature"===e){if("id"===t||"properties"===t||"geometry"===t)return!0}else if("GeometryCollection"===e){if("geometries"===t)return!0}else if("coordinates"===t)return!0;return!1}return sn}function yn(){if(ln)return un;var t,e,n,i,r;ln=1;var o=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeometryCollection"];function s(e,n,o){1===e?t.push(o.readString()):2===e?i=o.readVarint():3===e?r=Math.pow(10,o.readVarint()):4===e?function(t,e){e.type="FeatureCollection",e.features=[],t.readMessage(l,e)}(o,n):5===e?a(o,n):6===e&&u(o,n)}function a(t,e){e.type="Feature";var n=t.readMessage(c,e);return"geometry"in n||(n.geometry=null),n}function u(t,e){return e.type="Point",t.readMessage(h,e)}function l(t,n,i){1===t?n.features.push(a(i,{})):13===t?e.push(p(i)):15===t&&f(i,n)}function c(t,n,i){1===t?n.geometry=u(i,{}):11===t?n.id=i.readString():12===t?n.id=i.readSVarint():13===t?e.push(p(i)):14===t?n.properties=f(i,{}):15===t&&f(i,n)}function h(t,i,s){1===t?i.type=o[s.readVarint()]:2===t?n=s.readPackedVarint():3===t?function(t,e,i){"Point"===i?t.coordinates=function(t){var e=t.readVarint()+t.pos,n=[];for(;t.pos<e;)n.push(t.readSVarint()/r);return n}(e):"MultiPoint"===i||"LineString"===i?t.coordinates=d(e):"MultiLineString"===i?t.coordinates=y(e):"Polygon"===i?t.coordinates=y(e,!0):"MultiPolygon"===i&&(t.coordinates=function(t){var e=t.readVarint()+t.pos;if(!n)return[[g(t,e,null,!0)]];for(var i=[],r=1,o=0;o<n[0];o++){for(var s=[],a=0;a<n[r];a++)s.push(g(t,e,n[r+1+a],!0));r+=n[r]+1,i.push(s)}return n=null,i}(e))}(i,s,i.type):4===t?(i.geometries=i.geometries||[],i.geometries.push(u(s,{}))):13===t?e.push(p(s)):15===t&&f(s,i)}function p(t){for(var e=t.readVarint()+t.pos,n=null;t.pos<e;){var i=t.readVarint()>>3;1===i?n=t.readString():2===i?n=t.readDouble():3===i?n=t.readVarint():4===i?n=-t.readVarint():5===i?n=t.readBoolean():6===i&&(n=JSON.parse(t.readString()))}return n}function f(n,i){for(var r=n.readVarint()+n.pos;n.pos<r;)i[t[n.readVarint()]]=e[n.readVarint()];return e=[],i}function g(t,e,n,o){var s,a,u=0,l=[],c=[];for(a=0;a<i;a++)c[a]=0;for(;n?u<n:t.pos<e;){for(s=[],a=0;a<i;a++)c[a]+=t.readSVarint(),s[a]=c[a]/r;l.push(s),u++}return o&&l.push(l[0]),l}function d(t){return g(t,t.readVarint()+t.pos)}function y(t,e){var i=t.readVarint()+t.pos;if(!n)return[g(t,i,null,e)];for(var r=[],o=0;o<n.length;o++)r.push(g(t,i,n[o],e));return n=null,r}return un=function(o){i=2,r=Math.pow(10,6),n=null,t=[],e=[];var a=o.readFields(s,{});return t=null,a}}var _n=y((cn||(cn=1,gn.encode=dn(),gn.decode=yn()),gn));const mn=4294967296,vn=1/mn,xn="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");class In{constructor(t=new Uint8Array(16)){this.buf=ArrayBuffer.isView(t)?t:new Uint8Array(t),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(t,e,n=this.length){for(;this.pos<n;){const n=this.readVarint(),i=n>>3,r=this.pos;this.type=7&n,t(i,e,this),this.pos===r&&this.skip(n)}return e}readMessage(t,e){return this.readFields(t,e,this.readVarint()+this.pos)}readFixed32(){const t=this.dataView.getUint32(this.pos,!0);return this.pos+=4,t}readSFixed32(){const t=this.dataView.getInt32(this.pos,!0);return this.pos+=4,t}readFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*mn;return this.pos+=8,t}readSFixed64(){const t=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*mn;return this.pos+=8,t}readFloat(){const t=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,t}readDouble(){const t=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,t}readVarint(t){const e=this.buf;let n,i;return i=e[this.pos++],n=127&i,i<128?n:(i=e[this.pos++],n|=(127&i)<<7,i<128?n:(i=e[this.pos++],n|=(127&i)<<14,i<128?n:(i=e[this.pos++],n|=(127&i)<<21,i<128?n:(i=e[this.pos],n|=(15&i)<<28,function(t,e,n){const i=n.buf;let r,o;if(o=i[n.pos++],r=(112&o)>>4,o<128)return En(t,r,e);if(o=i[n.pos++],r|=(127&o)<<3,o<128)return En(t,r,e);if(o=i[n.pos++],r|=(127&o)<<10,o<128)return En(t,r,e);if(o=i[n.pos++],r|=(127&o)<<17,o<128)return En(t,r,e);if(o=i[n.pos++],r|=(127&o)<<24,o<128)return En(t,r,e);if(o=i[n.pos++],r|=(1&o)<<31,o<128)return En(t,r,e);throw new Error("Expected varint not more than 10 bytes")}(n,t,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const t=this.readVarint();return t%2==1?(t+1)/-2:t/2}readBoolean(){return Boolean(this.readVarint())}readString(){const t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&xn?xn.decode(this.buf.subarray(e,t)):function(t,e,n){let i="",r=e;for(;r<n;){const e=t[r];let o,s,a,u=null,l=e>239?4:e>223?3:e>191?2:1;if(r+l>n)break;1===l?e<128&&(u=e):2===l?(o=t[r+1],128==(192&o)&&(u=(31&e)<<6|63&o,u<=127&&(u=null))):3===l?(o=t[r+1],s=t[r+2],128==(192&o)&&128==(192&s)&&(u=(15&e)<<12|(63&o)<<6|63&s,(u<=2047||u>=55296&&u<=57343)&&(u=null))):4===l&&(o=t[r+1],s=t[r+2],a=t[r+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(u=(15&e)<<18|(63&o)<<12|(63&s)<<6|63&a,(u<=65535||u>=1114112)&&(u=null))),null===u?(u=65533,l=1):u>65535&&(u-=65536,i+=String.fromCharCode(u>>>10&1023|55296),u=56320|1023&u),i+=String.fromCharCode(u),r+=l}return i}(this.buf,e,t)}readBytes(){const t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e}readPackedVarint(t=[],e){const n=this.readPackedEnd();for(;this.pos<n;)t.push(this.readVarint(e));return t}readPackedSVarint(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSVarint());return t}readPackedBoolean(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readBoolean());return t}readPackedFloat(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFloat());return t}readPackedDouble(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readDouble());return t}readPackedFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed32());return t}readPackedSFixed32(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed32());return t}readPackedFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readFixed64());return t}readPackedSFixed64(t=[]){const e=this.readPackedEnd();for(;this.pos<e;)t.push(this.readSFixed64());return t}readPackedEnd(){return 2===this.type?this.readVarint()+this.pos:this.pos+1}skip(t){const e=7&t;if(0===e)for(;this.buf[this.pos++]>127;);else if(2===e)this.pos=this.readVarint()+this.pos;else if(5===e)this.pos+=4;else{if(1!==e)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(t,e){this.writeVarint(t<<3|e)}realloc(t){let e=this.length||16;for(;e<this.pos+t;)e*=2;if(e!==this.length){const t=new Uint8Array(e);t.set(this.buf),this.buf=t,this.dataView=new DataView(t.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeSFixed32(t){this.realloc(4),this.dataView.setInt32(this.pos,t,!0),this.pos+=4}writeFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,-1&t,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*vn),!0),this.pos+=8}writeSFixed64(t){this.realloc(8),this.dataView.setInt32(this.pos,-1&t,!0),this.dataView.setInt32(this.pos+4,Math.floor(t*vn),!0),this.pos+=8}writeVarint(t){(t=+t||0)>268435455||t<0?function(t,e){let n,i;t>=0?(n=t%4294967296|0,i=t/4294967296|0):(n=~(-t%4294967296),i=~(-t/4294967296),4294967295^n?n=n+1|0:(n=0,i=i+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn\'t fit into 10 bytes");e.realloc(10),function(t,e,n){n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos++]=127&t|128,t>>>=7,n.buf[n.pos]=127&t}(n,0,e),function(t,e){const n=(7&t)<<4;if(e.buf[e.pos++]|=n|((t>>>=3)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;e.buf[e.pos++]=127&t}(i,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))}writeSVarint(t){this.writeVarint(t<0?2*-t-1:2*t)}writeBoolean(t){this.writeVarint(+t)}writeString(t){t=String(t),this.realloc(4*t.length),this.pos++;const e=this.pos;this.pos=function(t,e,n){for(let i,r,o=0;o<e.length;o++){if(i=e.charCodeAt(o),i>55295&&i<57344){if(!r){i>56319||o+1===e.length?(t[n++]=239,t[n++]=191,t[n++]=189):r=i;continue}if(i<56320){t[n++]=239,t[n++]=191,t[n++]=189,r=i;continue}i=r-55296<<10|i-56320|65536,r=null}else r&&(t[n++]=239,t[n++]=191,t[n++]=189,r=null);i<128?t[n++]=i:(i<2048?t[n++]=i>>6|192:(i<65536?t[n++]=i>>12|224:(t[n++]=i>>18|240,t[n++]=i>>12&63|128),t[n++]=i>>6&63|128),t[n++]=63&i|128)}return n}(this.buf,t,this.pos);const n=this.pos-e;n>=128&&Nn(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n}writeFloat(t){this.realloc(4),this.dataView.setFloat32(this.pos,t,!0),this.pos+=4}writeDouble(t){this.realloc(8),this.dataView.setFloat64(this.pos,t,!0),this.pos+=8}writeBytes(t){const e=t.length;this.writeVarint(e),this.realloc(e);for(let n=0;n<e;n++)this.buf[this.pos++]=t[n]}writeRawMessage(t,e){this.pos++;const n=this.pos;t(e,this);const i=this.pos-n;i>=128&&Nn(n,i,this),this.pos=n-1,this.writeVarint(i),this.pos+=i}writeMessage(t,e,n){this.writeTag(t,2),this.writeRawMessage(e,n)}writePackedVarint(t,e){e.length&&this.writeMessage(t,wn,e)}writePackedSVarint(t,e){e.length&&this.writeMessage(t,Cn,e)}writePackedBoolean(t,e){e.length&&this.writeMessage(t,Ln,e)}writePackedFloat(t,e){e.length&&this.writeMessage(t,Sn,e)}writePackedDouble(t,e){e.length&&this.writeMessage(t,bn,e)}writePackedFixed32(t,e){e.length&&this.writeMessage(t,On,e)}writePackedSFixed32(t,e){e.length&&this.writeMessage(t,Pn,e)}writePackedFixed64(t,e){e.length&&this.writeMessage(t,Tn,e)}writePackedSFixed64(t,e){e.length&&this.writeMessage(t,Mn,e)}writeBytesField(t,e){this.writeTag(t,2),this.writeBytes(e)}writeFixed32Field(t,e){this.writeTag(t,5),this.writeFixed32(e)}writeSFixed32Field(t,e){this.writeTag(t,5),this.writeSFixed32(e)}writeFixed64Field(t,e){this.writeTag(t,1),this.writeFixed64(e)}writeSFixed64Field(t,e){this.writeTag(t,1),this.writeSFixed64(e)}writeVarintField(t,e){this.writeTag(t,0),this.writeVarint(e)}writeSVarintField(t,e){this.writeTag(t,0),this.writeSVarint(e)}writeStringField(t,e){this.writeTag(t,2),this.writeString(e)}writeFloatField(t,e){this.writeTag(t,5),this.writeFloat(e)}writeDoubleField(t,e){this.writeTag(t,1),this.writeDouble(e)}writeBooleanField(t,e){this.writeVarintField(t,+e)}}function En(t,e,n){return n?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function Nn(t,e,n){const i=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));n.realloc(i);for(let e=n.pos-1;e>=t;e--)n.buf[e+i]=n.buf[e]}function wn(t,e){for(let n=0;n<t.length;n++)e.writeVarint(t[n])}function Cn(t,e){for(let n=0;n<t.length;n++)e.writeSVarint(t[n])}function Sn(t,e){for(let n=0;n<t.length;n++)e.writeFloat(t[n])}function bn(t,e){for(let n=0;n<t.length;n++)e.writeDouble(t[n])}function Ln(t,e){for(let n=0;n<t.length;n++)e.writeBoolean(t[n])}function On(t,e){for(let n=0;n<t.length;n++)e.writeFixed32(t[n])}function Pn(t,e){for(let n=0;n<t.length;n++)e.writeSFixed32(t[n])}function Tn(t,e){for(let n=0;n<t.length;n++)e.writeFixed64(t[n])}function Mn(t,e){for(let n=0;n<t.length;n++)e.writeSFixed64(t[n])}const Rn={langs:["de","en","es","fr","ja","ko","ne","pt-BR","th","zh-Hans","zh-Hant"]};function Dn(t,e){let n,i;if(!Array.isArray(t)&&"string"!=typeof t)return!1;if(!Array.isArray(e))return-1!==t.indexOf(e);for(n=0,i=e.length;n<i;n++)if(-1===t.indexOf(e[n]))return!1;return!0}function An(...t){const e=new Map;for(const n of t)for(const[t,i]of n)e.set(t,i);return e}function Fn(t){return Dn(Rn.langs.map((t=>t.replace("pt-BR","pt"))),t=t.match(/^zh-(Hant|TW|HK|MO)/)?"zh-Hant":t.match(/^zh/)?"zh-Hans":t.substring(0,2))?t:void 0}function Gn(t){if(!t)throw new Error("coord is required");if("Feature"===t.type&&null!==t.geometry&&"Point"===t.geometry.type)return t.geometry.coordinates;if("Point"===t.type)return t.coordinates;if(Array.isArray(t)&&t.length>=2&&void 0===t[0].length&&void 0===t[1].length)return t;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Vn(t,e,n){if(!l(n=n||{}))throw new Error("options is invalid");if(!0===n.final)return function(t,e){var n=Vn(e,t);return n=(n+180)%360}(t,e);var i=Gn(t),r=Gn(e),o=a(i[0]),s=a(r[0]),u=a(i[1]),c=a(r[1]),h=Math.sin(s-o)*Math.cos(c),p=Math.cos(u)*Math.sin(c)-Math.sin(u)*Math.cos(c)*Math.cos(s-o);return function(t){if(null==t)throw new Error("radians is required");return t%(2*Math.PI)*180/Math.PI}(Math.atan2(h,p))}"undefined"!=typeof window&&window.addEventListener("touchstart",(()=>{}),{once:!0});var Bn,qn={exports:{}},Un={exports:{}};function kn(){return Bn||(Bn=1,Un.exports=function(){function t(t,i,r,o,s){!function t(n,i,r,o,s){for(;o>r;){if(o-r>600){var a=o-r+1,u=i-r+1,l=Math.log(a),c=.5*Math.exp(2*l/3),h=.5*Math.sqrt(l*c*(a-c)/a)*(u-a/2<0?-1:1);t(n,i,Math.max(r,Math.floor(i-u*c/a+h)),Math.min(o,Math.floor(i+(a-u)*c/a+h)),s)}var p=n[i],f=r,g=o;for(e(n,r,i),s(n[o],p)>0&&e(n,r,o);f<g;){for(e(n,f,g),f++,g--;s(n[f],p)<0;)f++;for(;s(n[g],p)>0;)g--}0===s(n[r],p)?e(n,r,g):e(n,++g,o),g<=i&&(r=g+1),i<=g&&(o=g-1)}}(t,i,r||0,o||t.length-1,s||n)}function e(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function n(t,e){return t<e?-1:t>e?1:0}var i=function(t){void 0===t&&(t=9),this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function r(t,e,n){if(!n)return e.indexOf(t);for(var i=0;i<e.length;i++)if(n(t,e[i]))return i;return-1}function o(t,e){s(t,0,t.children.length,e,t)}function s(t,e,n,i,r){r||(r=g(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var o=e;o<n;o++){var s=t.children[o];a(r,t.leaf?i(s):s)}return r}function a(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function u(t,e){return t.minX-e.minX}function l(t,e){return t.minY-e.minY}function c(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function h(t){return t.maxX-t.minX+(t.maxY-t.minY)}function p(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function f(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function g(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function d(e,n,i,r,o){for(var s=[n,i];s.length;)if(!((i=s.pop())-(n=s.pop())<=r)){var a=n+Math.ceil((i-n)/r/2)*r;t(e,a,n,i,o),s.push(n,a,a,i)}}return i.prototype.all=function(){return this._all(this.data,[])},i.prototype.search=function(t){var e=this.data,n=[];if(!f(t,e))return n;for(var i=this.toBBox,r=[];e;){for(var o=0;o<e.children.length;o++){var s=e.children[o],a=e.leaf?i(s):s;f(t,a)&&(e.leaf?n.push(s):p(t,a)?this._all(s,n):r.push(s))}e=r.pop()}return n},i.prototype.collides=function(t){var e=this.data;if(!f(t,e))return!1;for(var n=[];e;){for(var i=0;i<e.children.length;i++){var r=e.children[i],o=e.leaf?this.toBBox(r):r;if(f(t,o)){if(e.leaf||p(t,o))return!0;n.push(r)}}e=n.pop()}return!1},i.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0;e<t.length;e++)this.insert(t[e]);return this}var n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var i=this.data;this.data=n,n=i}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},i.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},i.prototype.clear=function(){return this.data=g([]),this},i.prototype.remove=function(t,e){if(!t)return this;for(var n,i,o,s=this.data,a=this.toBBox(t),u=[],l=[];s||u.length;){if(s||(s=u.pop(),i=u[u.length-1],n=l.pop(),o=!0),s.leaf){var c=r(t,s.children,e);if(-1!==c)return s.children.splice(c,1),u.push(s),this._condense(u),this}o||s.leaf||!p(s,a)?i?(n++,s=i.children[n],o=!1):s=null:(u.push(s),l.push(n),n=0,i=s,s=s.children[0])}return this},i.prototype.toBBox=function(t){return t},i.prototype.compareMinX=function(t,e){return t.minX-e.minX},i.prototype.compareMinY=function(t,e){return t.minY-e.minY},i.prototype.toJSON=function(){return this.data},i.prototype.fromJSON=function(t){return this.data=t,this},i.prototype._all=function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},i.prototype._build=function(t,e,n,i){var r,s=n-e+1,a=this._maxEntries;if(s<=a)return o(r=g(t.slice(e,n+1)),this.toBBox),r;i||(i=Math.ceil(Math.log(s)/Math.log(a)),a=Math.ceil(s/Math.pow(a,i-1))),(r=g([])).leaf=!1,r.height=i;var u=Math.ceil(s/a),l=u*Math.ceil(Math.sqrt(a));d(t,e,n,l,this.compareMinX);for(var c=e;c<=n;c+=l){var h=Math.min(c+l-1,n);d(t,c,h,u,this.compareMinY);for(var p=c;p<=h;p+=u){var f=Math.min(p+u-1,h);r.children.push(this._build(t,p,f,i-1))}}return o(r,this.toBBox),r},i.prototype._chooseSubtree=function(t,e,n,i){for(;i.push(e),!e.leaf&&i.length-1!==n;){for(var r=1/0,o=1/0,s=void 0,a=0;a<e.children.length;a++){var u=e.children[a],l=c(u),h=(p=t,f=u,(Math.max(f.maxX,p.maxX)-Math.min(f.minX,p.minX))*(Math.max(f.maxY,p.maxY)-Math.min(f.minY,p.minY))-l);h<o?(o=h,r=l<r?l:r,s=u):h===o&&l<r&&(r=l,s=u)}e=s||e.children[0]}var p,f;return e},i.prototype._insert=function(t,e,n){var i=n?t:this.toBBox(t),r=[],o=this._chooseSubtree(i,this.data,e,r);for(o.children.push(t),a(o,i);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(i,r,e)},i.prototype._split=function(t,e){var n=t[e],i=n.children.length,r=this._minEntries;this._chooseSplitAxis(n,r,i);var s=this._chooseSplitIndex(n,r,i),a=g(n.children.splice(s,n.children.length-s));a.height=n.height,a.leaf=n.leaf,o(n,this.toBBox),o(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(n,a)},i.prototype._splitRoot=function(t,e){this.data=g([t,e]),this.data.height=t.height+1,this.data.leaf=!1,o(this.data,this.toBBox)},i.prototype._chooseSplitIndex=function(t,e,n){for(var i,r,o,a,u,l,h,p=1/0,f=1/0,g=e;g<=n-e;g++){var d=s(t,0,g,this.toBBox),y=s(t,g,n,this.toBBox),_=(r=d,o=y,a=void 0,u=void 0,l=void 0,h=void 0,a=Math.max(r.minX,o.minX),u=Math.max(r.minY,o.minY),l=Math.min(r.maxX,o.maxX),h=Math.min(r.maxY,o.maxY),Math.max(0,l-a)*Math.max(0,h-u)),m=c(d)+c(y);_<p?(p=_,i=g,f=m<f?m:f):_===p&&m<f&&(f=m,i=g)}return i||n-e},i.prototype._chooseSplitAxis=function(t,e,n){var i=t.leaf?this.compareMinX:u,r=t.leaf?this.compareMinY:l;this._allDistMargin(t,e,n,i)<this._allDistMargin(t,e,n,r)&&t.children.sort(i)},i.prototype._allDistMargin=function(t,e,n,i){t.children.sort(i);for(var r=this.toBBox,o=s(t,0,e,r),u=s(t,n-e,n,r),l=h(o)+h(u),c=e;c<n-e;c++){var p=t.children[c];a(o,t.leaf?r(p):p),l+=h(o)}for(var f=n-e-1;f>=e;f--){var g=t.children[f];a(u,t.leaf?r(g):g),l+=h(u)}return l},i.prototype._adjustParentBBoxes=function(t,e,n){for(var i=n;i>=0;i--)a(e[i],t)},i.prototype._condense=function(t){for(var e=t.length-1,n=void 0;e>=0;e--)0===t[e].children.length?e>0?(n=t[e-1].children).splice(n.indexOf(t[e]),1):this.clear():o(t[e],this.toBBox)},i}()),Un.exports}function zn(t,e){return t<e?-1:t>e?1:0}var Xn,Yn,jn,Hn,Wn,Jn=Object.freeze({__proto__:null,default:class{constructor(t=[],e=zn){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:n}=this,i=e[t];for(;t>0;){const r=t-1>>1,o=e[r];if(n(i,o)>=0)break;e[t]=o,t=r}e[t]=i}_down(t){const{data:e,compare:n}=this,i=this.length>>1,r=e[t];for(;t<i;){let i=1+(t<<1),o=e[i];const s=i+1;if(s<this.length&&n(e[s],o)<0&&(i=s,o=e[s]),n(o,r)>=0)break;e[t]=o,t=i}e[t]=r}}}),Kn=_(Jn),Qn={exports:{}};function $n(){if(Wn)return Qn.exports;Wn=1;var t=(Yn||(Yn=1,Xn=function(t,e,n,i){var r=t[0],o=t[1],s=!1;void 0===n&&(n=0),void 0===i&&(i=e.length);for(var a=(i-n)/2,u=0,l=a-1;u<a;l=u++){var c=e[n+2*u+0],h=e[n+2*u+1],p=e[n+2*l+1];h>o!=p>o&&r<(e[n+2*l+0]-c)*(o-h)/(p-h)+c&&(s=!s)}return s}),Xn),e=(Hn||(Hn=1,jn=function(t,e,n,i){var r=t[0],o=t[1],s=!1;void 0===n&&(n=0),void 0===i&&(i=e.length);for(var a=i-n,u=0,l=a-1;u<a;l=u++){var c=e[u+n][0],h=e[u+n][1],p=e[l+n][1];h>o!=p>o&&r<(e[l+n][0]-c)*(o-h)/(p-h)+c&&(s=!s)}return s}),jn);return Qn.exports=function(n,i,r,o){return i.length>0&&Array.isArray(i[0])?e(n,i,r,o):t(n,i,r,o)},Qn.exports.nested=e,Qn.exports.flat=t,Qn.exports}var Zn,ti,ei={exports:{}};function ni(){return Zn||(Zn=1,function(t){const e=134217729,n=33306690738754706e-32;function i(t,e,n,i,r){let o,s,a,u,l=e[0],c=i[0],h=0,p=0;c>l==c>-l?(o=l,l=e[++h]):(o=c,c=i[++p]);let f=0;if(h<t&&p<n)for(c>l==c>-l?(a=o-((s=l+o)-l),l=e[++h]):(a=o-((s=c+o)-c),c=i[++p]),o=s,0!==a&&(r[f++]=a);h<t&&p<n;)c>l==c>-l?(a=o-((s=o+l)-(u=s-o))+(l-u),l=e[++h]):(a=o-((s=o+c)-(u=s-o))+(c-u),c=i[++p]),o=s,0!==a&&(r[f++]=a);for(;h<t;)a=o-((s=o+l)-(u=s-o))+(l-u),l=e[++h],o=s,0!==a&&(r[f++]=a);for(;p<n;)a=o-((s=o+c)-(u=s-o))+(c-u),c=i[++p],o=s,0!==a&&(r[f++]=a);return 0===o&&0!==f||(r[f++]=o),f}function r(t){return new Float64Array(t)}const o=33306690738754716e-32,s=22204460492503146e-32,a=11093356479670487e-47,u=r(4),l=r(8),c=r(12),h=r(16),p=r(4);t.orient2d=function(t,r,f,g,d,y){const _=(r-y)*(f-d),m=(t-d)*(g-y),v=_-m;if(0===_||0===m||_>0!=m>0)return v;const x=Math.abs(_+m);return Math.abs(v)>=o*x?v:-function(t,r,o,f,g,d,y){let _,m,v,x,I,E,N,w,C,S,b,L,O,P,T,M,R,D;const A=t-g,F=o-g,G=r-d,V=f-d;I=(T=(w=A-(N=(E=e*A)-(E-A)))*(S=V-(C=(E=e*V)-(E-V)))-((P=A*V)-N*C-w*C-N*S))-(b=T-(R=(w=G-(N=(E=e*G)-(E-G)))*(S=F-(C=(E=e*F)-(E-F)))-((M=G*F)-N*C-w*C-N*S))),u[0]=T-(b+I)+(I-R),I=(O=P-((L=P+b)-(I=L-P))+(b-I))-(b=O-M),u[1]=O-(b+I)+(I-M),I=(D=L+b)-L,u[2]=L-(D-I)+(b-I),u[3]=D;let B=function(t,e){let n=e[0];for(let i=1;i<t;i++)n+=e[i];return n}(4,u),q=s*y;if(B>=q||-B>=q)return B;if(_=t-(A+(I=t-A))+(I-g),v=o-(F+(I=o-F))+(I-g),m=r-(G+(I=r-G))+(I-d),x=f-(V+(I=f-V))+(I-d),0===_&&0===m&&0===v&&0===x)return B;if(q=a*y+n*Math.abs(B),(B+=A*x+V*_-(G*v+F*m))>=q||-B>=q)return B;I=(T=(w=_-(N=(E=e*_)-(E-_)))*(S=V-(C=(E=e*V)-(E-V)))-((P=_*V)-N*C-w*C-N*S))-(b=T-(R=(w=m-(N=(E=e*m)-(E-m)))*(S=F-(C=(E=e*F)-(E-F)))-((M=m*F)-N*C-w*C-N*S))),p[0]=T-(b+I)+(I-R),I=(O=P-((L=P+b)-(I=L-P))+(b-I))-(b=O-M),p[1]=O-(b+I)+(I-M),I=(D=L+b)-L,p[2]=L-(D-I)+(b-I),p[3]=D;const U=i(4,u,4,p,l);I=(T=(w=A-(N=(E=e*A)-(E-A)))*(S=x-(C=(E=e*x)-(E-x)))-((P=A*x)-N*C-w*C-N*S))-(b=T-(R=(w=G-(N=(E=e*G)-(E-G)))*(S=v-(C=(E=e*v)-(E-v)))-((M=G*v)-N*C-w*C-N*S))),p[0]=T-(b+I)+(I-R),I=(O=P-((L=P+b)-(I=L-P))+(b-I))-(b=O-M),p[1]=O-(b+I)+(I-M),I=(D=L+b)-L,p[2]=L-(D-I)+(b-I),p[3]=D;const k=i(U,l,4,p,c);I=(T=(w=_-(N=(E=e*_)-(E-_)))*(S=x-(C=(E=e*x)-(E-x)))-((P=_*x)-N*C-w*C-N*S))-(b=T-(R=(w=m-(N=(E=e*m)-(E-m)))*(S=v-(C=(E=e*v)-(E-v)))-((M=m*v)-N*C-w*C-N*S))),p[0]=T-(b+I)+(I-R),I=(O=P-((L=P+b)-(I=L-P))+(b-I))-(b=O-M),p[1]=O-(b+I)+(I-M),I=(D=L+b)-L,p[2]=L-(D-I)+(b-I),p[3]=D;const z=i(k,c,4,p,h);return h[z-1]}(t,r,f,g,d,y,x)},t.orient2dfast=function(t,e,n,i,r,o){return(e-o)*(n-r)-(t-r)*(i-o)},Object.defineProperty(t,"__esModule",{value:!0})}(ei.exports)),ei.exports}function ii(t,e,n){if(!l(n=n||{}))throw new Error("options is invalid");var i=n.units,r=Gn(t),o=Gn(e),u=a(o[1]-r[1]),c=a(o[0]-r[0]),h=a(r[1]),p=a(o[1]),f=Math.pow(Math.sin(u/2),2)+Math.pow(Math.sin(c/2),2)*Math.cos(h)*Math.cos(p);return s(2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f)),i)}function ri(t){const e=function(t){if(!t)throw new Error("coords is required");if("Feature"===t.type&&null!==t.geometry)return t.geometry.coordinates;if(t.coordinates)return t.coordinates;if(Array.isArray(t))return t;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}(t),n=t.properties.distances=[];let i,r,o,s=0,a=e[0];for(let t=0,u=e.length;t<u-1;t++){const u=a;a=e[t+1];const l=ii(u,a);i=Vn(u,a),r=((a[2]||0)-(u[2]||0))/l,o=Math.atan(r/1e3),n.push([s,i,r,o]),s+=l}n.push([s,i,r,o])}function oi(t,e){e.writeStringField(1,t.agency);for(const n of t.stops)e.writeMessage(2,((t,e)=>{e.writeStringField(1,t.id),e.writeStringField(2,t.name),e.writePackedDouble(3,t.coord)}),n);for(const n of t.routes)e.writeMessage(3,((t,e)=>{e.writeStringField(1,t.id),t.shortName&&e.writeStringField(2,t.shortName),t.longName&&e.writeStringField(3,t.longName),t.color&&e.writeStringField(4,t.color),t.textColor&&e.writeStringField(5,t.textColor);for(const n of t.shapes)e.writeStringField(6,n)}),n);for(const n of t.trips)e.writeMessage(4,((t,e)=>{e.writeStringField(1,t.id),e.writeStringField(2,t.route),e.writeStringField(3,t.shape),e.writePackedVarint(4,t.departureTimes);for(const n of t.stops)e.writeStringField(5,n);e.writePackedVarint(6,t.stopSequences);for(const n of t.headsigns)e.writeStringField(7,n)}),n);return e.writeStringField(5,t.version),e.finish()}function si(t){const e=[""];let n=0,i="",r=!0;for(const o of t)\'"\'===o?(r&&o===i&&(e[n]+=o),r=!r):","===o&&r?e[++n]="":e[n]+=o,i=o;return e}function ai(t){const e=t.split(":");return 1e3*(60*(60*(+e[0]-3)+ +e[1])+ +e[2])}!function(){if(ti)return qn.exports;ti=1;var t=kn(),e=Kn,n=$n(),i=ni().orient2d;function r(e,i,r){i=Math.max(0,void 0===i?2:i),r=r||0;var s=function(t){for(var e=t[0],i=t[0],r=t[0],o=t[0],s=0;s<t.length;s++){var a=t[s];a[0]<e[0]&&(e=a),a[0]>r[0]&&(r=a),a[1]<i[1]&&(i=a),a[1]>o[1]&&(o=a)}var u=[e,i,r,o],l=u.slice();for(s=0;s<t.length;s++)n(t[s],u)||l.push(t[s]);return function(t){t.sort(y);for(var e=[],n=0;n<t.length;n++){for(;e.length>=2&&c(e[e.length-2],e[e.length-1],t[n])<=0;)e.pop();e.push(t[n])}for(var i=[],r=t.length-1;r>=0;r--){for(;i.length>=2&&c(i[i.length-2],i[i.length-1],t[r])<=0;)i.pop();i.push(t[r])}return i.pop(),e.pop(),e.concat(i)}(l)}(e),a=new t(16);a.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},a.compareMinX=function(t,e){return t[0]-e[0]},a.compareMinY=function(t,e){return t[1]-e[1]},a.load(e);for(var u,l=[],g=0;g<s.length;g++){var d=s[g];a.remove(d),u=p(d,u),l.push(u)}var _=new t(16);for(g=0;g<l.length;g++)_.insert(h(l[g]));for(var m=i*i,v=r*r;l.length;){var x=l.shift(),I=x.p,E=x.next.p,N=f(I,E);if(!(N<v)){var w=N/m;(d=o(a,x.prev.p,I,E,x.next.next.p,w,_))&&Math.min(f(d,I),f(d,E))<=w&&(l.push(x),l.push(p(d,x)),a.remove(d),_.remove(x),_.insert(h(x)),_.insert(h(x.next)))}}x=u;var C=[];do{C.push(x.p),x=x.next}while(x!==u);return C.push(x.p),C}function o(t,n,i,r,o,u,c){for(var h=new e([],s),p=t.data;p;){for(var f=0;f<p.children.length;f++){var d=p.children[f],y=p.leaf?g(d,i,r):a(i,r,d);y>u||h.push({node:d,dist:y})}for(;h.length&&!h.peek().node.children;){var _=h.pop(),m=_.node,v=g(m,n,i),x=g(m,r,o);if(_.dist<v&&_.dist<x&&l(i,m,c)&&l(r,m,c))return m}(p=h.pop())&&(p=p.node)}return null}function s(t,e){return t.dist-e.dist}function a(t,e,n){if(u(t,n)||u(e,n))return 0;var i=d(t[0],t[1],e[0],e[1],n.minX,n.minY,n.maxX,n.minY);if(0===i)return 0;var r=d(t[0],t[1],e[0],e[1],n.minX,n.minY,n.minX,n.maxY);if(0===r)return 0;var o=d(t[0],t[1],e[0],e[1],n.maxX,n.minY,n.maxX,n.maxY);if(0===o)return 0;var s=d(t[0],t[1],e[0],e[1],n.minX,n.maxY,n.maxX,n.maxY);return 0===s?0:Math.min(i,r,o,s)}function u(t,e){return t[0]>=e.minX&&t[0]<=e.maxX&&t[1]>=e.minY&&t[1]<=e.maxY}function l(t,e,n){for(var i,r,o,s,a=Math.min(t[0],e[0]),u=Math.min(t[1],e[1]),l=Math.max(t[0],e[0]),h=Math.max(t[1],e[1]),p=n.search({minX:a,minY:u,maxX:l,maxY:h}),f=0;f<p.length;f++)if(r=p[f].next.p,o=t,(i=p[f].p)!==(s=e)&&r!==o&&c(i,r,o)>0!=c(i,r,s)>0&&c(o,s,i)>0!=c(o,s,r)>0)return!1;return!0}function c(t,e,n){return i(t[0],t[1],e[0],e[1],n[0],n[1])}function h(t){var e=t.p,n=t.next.p;return t.minX=Math.min(e[0],n[0]),t.minY=Math.min(e[1],n[1]),t.maxX=Math.max(e[0],n[0]),t.maxY=Math.max(e[1],n[1]),t}function p(t,e){var n={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function f(t,e){var n=t[0]-e[0],i=t[1]-e[1];return n*n+i*i}function g(t,e,n){var i=e[0],r=e[1],o=n[0]-i,s=n[1]-r;if(0!==o||0!==s){var a=((t[0]-i)*o+(t[1]-r)*s)/(o*o+s*s);a>1?(i=n[0],r=n[1]):a>0&&(i+=o*a,r+=s*a)}return(o=t[0]-i)*o+(s=t[1]-r)*s}function d(t,e,n,i,r,o,s,a){var u,l,c,h,p=n-t,f=i-e,g=s-r,d=a-o,y=t-r,_=e-o,m=p*p+f*f,v=p*g+f*d,x=g*g+d*d,I=p*y+f*_,E=g*y+d*_,N=m*x-v*v,w=N,C=N;0===N?(l=0,w=1,h=E,C=x):(h=m*E-v*I,(l=v*E-x*I)<0?(l=0,h=E,C=x):l>w&&(l=w,h=E+v,C=x)),h<0?(h=0,-I<0?l=0:-I>m?l=w:(l=-I,w=m)):h>C&&(h=C,-I+v<0?l=0:-I+v>m?l=w:(l=-I+v,w=m));var S=(1-(c=0===h?0:h/C))*r+c*s-((1-(u=0===l?0:l/w))*t+u*n),b=(1-c)*o+c*a-((1-u)*e+u*i);return S*S+b*b}function y(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}e.default&&(e=e.default),qn.exports=r,qn.exports.default=r}();const ui={agency:class{read(t){const e=this,n=si(t);void 0===e.agencyNameIndex?e.agencyNameIndex=n.indexOf("agency_name"):e.agencyName=n[e.agencyNameIndex]}get result(){return this.agencyName}},calendar:class{constructor({date:t,day:e}){const n=this;n.date=t,n.day=e,n.services=new Set}read(t){const e=this,n=si(t);void 0===e.serviceIdIndex?(e.serviceIdIndex=n.indexOf("service_id"),e.dayIndex=n.indexOf(e.day),e.startDateIndex=n.indexOf("start_date"),e.endDateIndex=n.indexOf("end_date")):e.date>=n[e.startDateIndex]&&e.date<=n[e.endDateIndex]&&"1"===n[e.dayIndex]&&e.services.add(n[e.serviceIdIndex])}get result(){return this.services}},calendar_dates:class{constructor({date:t}){const e=this;e.date=t,e.additions=new Set,e.deletions=new Set}read(t){const e=this,n=si(t);if(void 0===e.serviceIdIndex)e.serviceIdIndex=n.indexOf("service_id"),e.dateIndex=n.indexOf("date"),e.exceptionTypeIndex=n.indexOf("exception_type");else{const t=n[e.serviceIdIndex];e.date===n[e.dateIndex]&&("1"===n[e.exceptionTypeIndex]?e.additions.add(t):e.deletions.add(t))}}get result(){return[this.additions,this.deletions]}},feed_info:class{constructor({lang:t}){this.lang=t}read(t){const e=this,n=si(t);void 0===e.feedLangIndex?(e.feedLangIndex=n.indexOf("feed_lang"),e.feedVersionIndex=n.indexOf("feed_version")):(e.feedLang=n[e.feedLangIndex],e.feedVersion=n[e.feedVersionIndex])}get result(){const t=this;return{needTranslation:Fn(t.feedLang)!==t.lang,version:t.feedVersion}}},routes:class{constructor(){this.array=[]}read(t){const e=this,n=si(t);if(void 0===e.routeIdIndex)e.routeIdIndex=n.indexOf("route_id"),e.routeShortNameIndex=n.indexOf("route_short_name"),e.routeLongNameIndex=n.indexOf("route_long_name"),e.routeColorIndex=n.indexOf("route_color"),e.routeTextColorIndex=n.indexOf("route_text_color");else{const t=n[e.routeColorIndex],i=n[e.routeTextColorIndex];e.array.push({id:n[e.routeIdIndex],shortName:n[e.routeShortNameIndex],longName:n[e.routeLongNameIndex],color:t?`#${t}`:void 0,textColor:i?`#${i}`:void 0})}}get result(){return this.array}},shapes:class{constructor({color:t}){this.color=t,this.lookup=new Map}read(t){const e=this,n=si(t),i=e.lookup;if(void 0===e.shapeIdIndex)e.shapeIdIndex=n.indexOf("shape_id"),e.shapePtLatIdIndex=n.indexOf("shape_pt_lat"),e.shapePtLonIdIndex=n.indexOf("shape_pt_lon"),e.shapePtSequenceIndex=n.indexOf("shape_pt_sequence");else if(n.length>1){const t=n[e.shapeIdIndex];let r;i.has(t)?r=i.get(t):(r=[],i.set(t,r)),r.push([+n[e.shapePtLonIdIndex],+n[e.shapePtLatIdIndex],+n[e.shapePtSequenceIndex]])}}get result(){const t=this,e=[];for(const[n,i]of t.lookup.entries()){const o=r(i.sort(((t,e)=>t[2]-e[2])),{id:n,type:0,color:t.color,width:2});for(const t of i)t.pop();ri(o),e.push(o)}return e}},stops:class{constructor(){this.array=[]}read(t){const e=this,n=si(t);void 0===e.stopIdIndex?(e.stopIdIndex=n.indexOf("stop_id"),e.stopNameIndex=n.indexOf("stop_name"),e.stopLatIndex=n.indexOf("stop_lat"),e.stopLonIndex=n.indexOf("stop_lon")):e.array.push({id:n[e.stopIdIndex],name:n[e.stopNameIndex],coord:[+n[e.stopLonIndex],+n[e.stopLatIndex]]})}get result(){return this.array}},stop_times:class{constructor(){this.lookup=new Map}read(t){const e=this,n=si(t),i=e.lookup;if(void 0===e.tripIdIndex)e.tripIdIndex=n.indexOf("trip_id"),e.departureTimeIndex=n.indexOf("departure_time"),e.stopIdIndex=n.indexOf("stop_id"),e.stopSequenceIndex=n.indexOf("stop_sequence"),e.stopHeadsignIndex=n.indexOf("stop_headsign");else{const t=n[e.tripIdIndex];let r;i.has(t)?r=i.get(t):(r=[],i.set(t,r)),r.push([ai(n[e.departureTimeIndex]),n[e.stopIdIndex],+n[e.stopSequenceIndex],n[e.stopHeadsignIndex]])}}get result(){const t=new Map;for(const[e,n]of this.lookup.entries())n.sort(((t,e)=>t[2]-e[2])),t.set(e,{departureTimes:n.map((t=>t[0])),stops:n.map((t=>t[1])),stopSequences:n.map((t=>t[2])),stopHeadsigns:n.map((t=>t[3]))});return t}},translations:class{constructor({lang:t}){this.lang=t,this.lookup=new Map}read(t){const e=this,n=si(t),i=e.lookup;if(void 0===e.tableNameIndex)e.tableNameIndex=n.indexOf("table_name"),e.fieldNameIndex=n.indexOf("field_name"),e.recordIdIndex=n.indexOf("record_id"),e.fieldValueIndex=n.indexOf("field_value"),e.languageIndex=n.indexOf("language"),e.translationIndex=n.indexOf("translation");else{const t=n[e.languageIndex];let r;i.has(t)?r=i.get(t):(r=new Map,i.set(t,r)),r.set(`${n[e.tableNameIndex]}.${n[e.fieldNameIndex]}.${n[e.recordIdIndex]||n[e.fieldValueIndex]}`,n[e.translationIndex])}}get result(){const t=this,e=t.lookup,n=e.get("en")||new Map;if("en"===t.lang)return n;if(e.has(t.lang))return An(n,e.get(t.lang));for(const[i,r]of e){const e=Fn(i);if(e===t.lang||"zh-Hans"===e&&"zh-Hant"===t.lang)return An(n,r)}return n}},trips:class{constructor(){this.array=[]}read(t){const e=this,n=si(t);void 0===e.tripIdIndex?(e.tripIdIndex=n.indexOf("trip_id"),e.serviceIdIndex=n.indexOf("service_id"),e.routeIdIndex=n.indexOf("route_id"),e.shapeIdIndex=n.indexOf("shape_id"),e.headsignIndex=n.indexOf("trip_headsign")):e.array.push({id:n[e.tripIdIndex],service:n[e.serviceIdIndex],route:n[e.routeIdIndex],shape:n[e.shapeIdIndex],headsign:n[e.headsignIndex]})}get result(){return this.array}}},li=Object.keys(ui);function ci(t,e,n){const r=t,s=new Map;for(const{id:t,name:o,coord:a}of e)r.push(i(a,{type:2,name:n&&(n.get(`stops.stop_name.${t}`)||n.get(`stops.stop_name.${o}`))||o})),s.has(o)?s.get(o).push(a):s.set(o,[a]);for(const t of[14,15,16,17,18]){const e=.1*Math.pow(2,14-t);for(const n of s.values()){const o=ie(...n.map((t=>Qt(i(t),e/4))));o.properties={type:1,outlineColor:"#000000",width:2,color:"#FFFFFF",zoom:t},r.push(o)}}return o(r)}function hi(t,e){return t.map((({id:t,name:n,coord:i})=>({id:t,name:e&&(e.get(`stops.stop_name.${t}`)||e.get(`stops.stop_name.${n}`))||n,coord:i})))}function pi(t,e,n){const i=new Map;for(const{route:t,shape:n}of e)i.has(t)?i.get(t).add(n):i.set(t,new Set([n]));return t.map((({id:t,shortName:e,longName:r,color:o,textColor:s})=>({id:t,shortName:n&&(n.get(`routes.route_short_name.${t}`)||n.get(`routes.route_short_name.${e}`))||e,longName:n&&(n.get(`routes.route_long_name.${t}`)||n.get(`routes.route_long_name.${r}`))||r,color:o,textColor:s,shapes:Array.from((i.get(t)||new Set).values())})))}function fi(t,e=new Set,n=[new Set,new Set],i,r){const o=e.union(n[0]).difference(n[1]),s=[];for(const{id:e,service:n,route:a,shape:u,headsign:l}of t)if(o.has(n)){const{departureTimes:t,stops:n,stopSequences:o,stopHeadsigns:c}=i.get(e),h=[];if(new Set(c).size>1)for(const t of c)h.push(r&&r.get(`stop_times.stop_headsign.${t}`)||t);else l?h.push(r&&(r.get(`trips.trip_headsign.${e}`)||r.get(`trips.trip_headsign.${l}`))||l):c[0]&&h.push(r&&r.get(`stop_times.stop_headsign.${c[0]}`)||c[0]);s.push({id:e,route:a,shape:u,departureTimes:t,stops:n,stopSequences:o,headsigns:h})}return s}pe({load:(t,e,n,i,r)=>function(t,e,n,i){return new Promise(((r,o)=>{fetch(t.gtfsUrl).then((s=>{const a={},u=s.body.getReader(),l=new fn((r=>{const s=r.name.split(".")[0];if(Dn(li,s)){let u="";const l=new ui[s]({date:e,day:n,lang:i,color:t.color}),c=new on(((t,e)=>{const n=t.split(/\\r?\\n/);n.length>1&&(l.read(u+n[0]),u="");for(let t=1;t<n.length-1;t++)l.read(n[t]);u+=n[n.length-1],e&&(u&&l.read(u),a[s]=l.result)}));r.ondata=(t,e,n)=>{if(t)o(t);else try{c.push(e,n)}catch(t){o(t)}},r.start()}}));return l.register(pn),u.read().then((function t({done:e,value:n}){if(e)return l.push(new Uint8Array(0),!0),void r(a);l.push(n),u.read().then(t)}))}))})).then((t=>{const e=t.feed_info&&t.feed_info.needTranslation&&t.translations,n=ci(t.shapes,t.stops,e),i={agency:t.agency,version:t.feed_info?t.feed_info.version:"N/A",stops:hi(t.stops,e),routes:pi(t.routes,t.trips,e),trips:fi(t.trips,t.calendar,t.calendar_dates,t.stop_times,e)};return[_n.encode(n,new In),oi(i,new In)]}))}(t,e,n,i).then((t=>r(Ie(t,t.map((({buffer:t})=>t))))))})}));\n'],{type:"text/javascript"})),r=new Worker(n),o=wrap(r),s=t.getDate(),a=s.getHours();a<3&&s.setHours(a-24);const l=s.getFullYear(),c=`0${s.getMonth()+1}`.slice(-2),u=`0${s.getDate()}`.slice(-2),h=s.getDay(),d=`${l}${c}${u}`,p=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][h];return new Promise((t=>{o.load(e,d,p,i,proxy((e=>{o[releaseProxy](),r.terminate(),t(Object.assign({featureCollection:geobuf.decode(new Pbf(e[0]))},decode(new Pbf(e[1]))))})))}))}function loadDynamicBusData(e){return fetch(e).then((e=>e.arrayBuffer())).then((e=>GtfsRealtimeBindings.transit_realtime.FeedMessage.decode(new Uint8Array(e))))}function updateOdptUrl(e,t){if(isString(e))return e.startsWith("https://api.odpt.org/")&&!e.match(/acl:consumerKey/)?`${e}${e.match(/\?/)?"&":"?"}acl:consumerKey=${t.odpt}`:e.startsWith("https://api-challenge.odpt.org/")&&!e.match(/acl:consumerKey/)?`${e}${e.match(/\?/)?"&":"?"}acl:consumerKey=${t.challenge2025}`:e}const isWindows=includes(navigator.userAgent,"Windows");class Panel{constructor(e){this._options=Object.assign({modal:!1},e)}setTitle(e){const t=this,i=t._container;return t._title=e,i&&(i.querySelector("#panel-title").innerHTML=e),t}setHTML(e){const t=this,i=t._container;return t._html=e,i&&(i.querySelector("#panel-content").innerHTML=e),t}setButtons(e){const t=this,i=t._container;if(t._buttons=e,i){const t=i.querySelector("#panel-button-group"),n=t.children;for(let e=n.length-1;e>0;e--)t.removeChild(n[e]);for(const i of e||[])t.appendChild(i)}return t}addTo(e){const t=this,i=t._options;if(t._map=e,i.modal){(t._background=createElement$1("div",{className:"modal-panel-background closed"},e.container)).addEventListener("click",(()=>{t.remove()}))}const n=t._container=createElement$1("div",{className:`panel closed ${i.className||""}`,innerHTML:['<div id="panel-header">','<div id="panel-title"></div>','<div id="panel-button-group" class="panel-button-group">',`<div id="panel-button" class="${i.modal?"close-button":"slide-button"}"></div>`,"</div>","</div>",`<div id="panel-body"${isWindows?' class="windows"':""}>`,'<div id="panel-content"></div>',"</div>"].join("")},e.container);return t._title&&t.setTitle(t._title),t._html&&t.setHTML(t._html),t._buttons&&t.setButtons(t._buttons),i.modal?n.querySelector("#panel-button").addEventListener("click",(()=>{t.remove()})):(n.querySelector("#panel-header").addEventListener("click",(()=>{const e=n.classList;e.contains("collapsed")?e.remove("collapsed"):e.add("collapsed")})),n.querySelector("#panel-header").style.cursor="pointer"),requestAnimationFrame((()=>{i.modal&&(t._background.classList.remove("closed"),n.style.height=`min(calc(100% - 10px), ${n.querySelector("#panel-content").offsetHeight+50}px)`),n.classList.remove("closed")})),t}remove(){const e=this,t=e._options,i=e._background,n=e._container;return t.modal&&i.classList.add("closed"),n.style.removeProperty("height"),n.classList.add("closed"),setTimeout((()=>{t.modal&&(i.parentNode.removeChild(i),delete e._background),n.parentNode.removeChild(n),delete e._container,delete e._map}),300),e}isOpen(){return!!this._map}}class AboutPanel extends Panel{constructor(e){super(Object.assign({className:"about-panel",modal:!0},e))}addTo(e){return super.addTo(e).setTitle(e.dict.about).updateContent()}updateContent(){const e=this;if(e.isOpen()){const{dict:t,gtfs:i,lastDynamicUpdate:n}=e._map,r=[...i.values()];e.setHTML([t.description.replace(/<h3>.*<\/h3>/,""),`<p>${configs.copyright}</p>`,`<div class="card-title">${t["static-update"]}</div>`,`<div class="card-body">${configs.lastStaticUpdate}</div>`,`<div class="card-title">${t["dynamic-update"]}</div>`,'<div class="card-body">',n.Toei||"N/A",` (${t.toei})<br>`,n.Keikyu||"N/A",` (${t.keikyu})<br>`,n.Tobu||"N/A",` (${t.tobu})<br>`,n["HND-JAT"]||"N/A",` (${t["hnd-jat"]})<br>`,n["HND-TIAT"]||"N/A",` (${t["hnd-tiat"]})<br>`,n.NAA||"N/A",` (${t.naa})<br>`,r.filter((({date:e})=>e)).map((({date:e,agency:t})=>`${e} (${t})`)).join("<br>"),"</div>",r.length>0?[`<div class="card-title">${t["gtfs-feed-version"]}</div>`,'<div class="card-body">',r.map((({version:e,agency:t})=>`${e} (${t})`)).join("<br>"),"</div>"].join(""):""].join(""))}return e}}class BusPanel extends Panel{constructor(e){super(Object.assign({className:"bus-panel"},e))}addTo(e){const t=this,i=[],n=[],r=t._options.object,o=e.gtfs.get(r.gtfsId),s=r.trip,{route:a,stops:l,departureTimes:c}=s,u=o.routes.get(a).color,h=o.stops;for(let e=0,t=l.length;e<t;e++){const t=h.get(l[e]),n=getTimeString(c[e]);i.push(['<div class="busstop-row">',`<div class="busstop-title-box">${t.name}</div>`,`<div class="busstop-time-box">${n}</div>`,"</div>"].join(""))}super.addTo(e),t.updateHeader(),t.setHTML(['<div id="timetable-content">',...i,"</div>",'<svg id="busroute-mark"></svg>','<svg id="bus-mark"></svg>'].join(""));const d=t._container,p=d.querySelector("#panel-body");for(const e of d.querySelector("#timetable-content").children)n.push(e.offsetTop+e.getBoundingClientRect().height/2);return d.querySelector("#busroute-mark").innerHTML=[`<line stroke="${u||o.color}" stroke-width="10" x1="12" y1="${n[0]}" x2="12" y2="${n[n.length-1]}" stroke-linecap="round" />`].concat(n.map((e=>`<circle cx="12" cy="${e}" r="3" fill="#ffffff" />`))).join(""),function e(){const i=p.getBoundingClientRect().height,o=r.sectionIndex+r.sectionLength,s=lerp$5(n[Math.max(0,o-1)],n[o],r._t),a=performance.now()%1500/1500;d.querySelector("#bus-mark").innerHTML=`<circle cx="22" cy="${s}" r="${7+15*a}" fill="#ffffff" opacity="${1-a}" /><circle cx="22" cy="${s}" r="7" fill="#ffffff" />`,void 0!==t._scrollTop&&t._scrollTop!==p.scrollTop||(t._scrollTop=p.scrollTop=Math.round(s-i/2+4)),t._container&&requestAnimationFrame(e)}(),t}updateHeader(){const e=this._options.object,t=this._map.gtfs.get(e.gtfsId),{route:i,headsigns:n}=e.trip,{shortName:r,longName:o,color:s,textColor:a}=t.routes.get(i),l=[a?`color: ${a};`:"",s?`background-color: ${s};`:""].join(" ");this.setTitle(['<div class="desc-header">',`<div style="background-color: ${t.color};"></div>`,'<div><div class="desc-first-row">',t.agency,void 0!==e.stop?'<span class="realtime-icon"></span>':"",'</div><div class="desc-second-row">',r||o?` <span class="bus-route-label" style="${l}">${r||o}</span> `:"",0===n.length?o:n[1===n.length?0:e.sectionIndex],"</div></div></div>"].join(""))}reset(){delete this._scrollTop}}class LayerPanel extends Panel{constructor(e){super(Object.assign({className:"layer-panel",modal:!0},e))}addTo(e){const t=this,i=t._options.layers;super.addTo(e).setTitle(e.dict.layers).setHTML(i.map((t=>[`<div id="${t.getId()}-layer" class="layer-row">`,'<div class="layer-icon"></div>',`<div>${t.getName(e.lang)}</div>`,"</div>"].join(""))).join(""));for(const e of i){const i=t._container.querySelector(`#${e.getId()}-layer .layer-icon`),n=i.classList;Object.assign(i.style,e.getIconStyle()),e.isEnabled()&&n.add("layer-icon-enabled"),i.addEventListener("click",(()=>{e.isEnabled()?(n.remove("layer-icon-enabled"),e.disable()):(n.add("layer-icon-enabled"),e.enable())}))}return t}}class SharePanel{constructor(e){this._object=e.object}addTo(e){const t=this,i=e.dict,n=t._object,r=n instanceof Train?"train":"flight",o=t._container=createElement$1("div",{className:"share-panel"},e.container);return(t._button=createElement$1("button",{className:"share-button",innerHTML:i["share-this"].replace("$1",i[r])},o)).onclick=()=>{window.navigator.share({title:i.my.replace("$1",i[r]),text:i["on-this"].replace("$1",i[r]),url:`${configs.shareUrl}?selection=${n.id}`}).then((()=>{showNotification(e.container,i.shared)})).catch((()=>{}))},t._map=e,t}remove(){const e=this,t=e._container;return t.parentNode.removeChild(t),delete e._container,delete e._map,e}}function isObject$1(e){return null!==e&&"object"==typeof e&&"constructor"in e&&e.constructor===Object}function extend$2(e={},t={}){const i=["__proto__","constructor","prototype"];Object.keys(t).filter((e=>i.indexOf(e)<0)).forEach((i=>{void 0===e[i]?e[i]=t[i]:isObject$1(t[i])&&isObject$1(e[i])&&Object.keys(t[i]).length>0&&extend$2(e[i],t[i])}))}const ssrDocument={body:{},addEventListener(){},removeEventListener(){},activeElement:{blur(){},nodeName:""},querySelector:()=>null,querySelectorAll:()=>[],getElementById:()=>null,createEvent:()=>({initEvent(){}}),createElement:()=>({children:[],childNodes:[],style:{},setAttribute(){},getElementsByTagName:()=>[]}),createElementNS:()=>({}),importNode:()=>null,location:{hash:"",host:"",hostname:"",href:"",origin:"",pathname:"",protocol:"",search:""}};function getDocument(){const e="undefined"!=typeof document?document:{};return extend$2(e,ssrDocument),e}const ssrWindow={document:ssrDocument,navigator:{userAgent:""},location:{hash:"",host:"",hostname:"",href:"",origin:"",pathname:"",protocol:"",search:""},history:{replaceState(){},pushState(){},go(){},back(){}},CustomEvent:function(){return this},addEventListener(){},removeEventListener(){},getComputedStyle:()=>({getPropertyValue:()=>""}),Image(){},Date(){},screen:{},setTimeout(){},clearTimeout(){},matchMedia:()=>({}),requestAnimationFrame:e=>"undefined"==typeof setTimeout?(e(),null):setTimeout(e,0),cancelAnimationFrame(e){"undefined"!=typeof setTimeout&&clearTimeout(e)}};function getWindow(){const e="undefined"!=typeof window?window:{};return extend$2(e,ssrWindow),e}function classesToTokens(e=""){return e.trim().split(" ").filter((e=>!!e.trim()))}function deleteProps(e){const t=e;Object.keys(t).forEach((e=>{try{t[e]=null}catch(e){}try{delete t[e]}catch(e){}}))}function nextTick(e,t=0){return setTimeout(e,t)}function now(){return Date.now()}function getComputedStyle$1(e){const t=getWindow();let i;return t.getComputedStyle&&(i=t.getComputedStyle(e,null)),!i&&e.currentStyle&&(i=e.currentStyle),i||(i=e.style),i}function getTranslate(e,t="x"){const i=getWindow();let n,r,o;const s=getComputedStyle$1(e);return i.WebKitCSSMatrix?(r=s.transform||s.webkitTransform,r.split(",").length>6&&(r=r.split(", ").map((e=>e.replace(",","."))).join(", ")),o=new i.WebKitCSSMatrix("none"===r?"":r)):(o=s.MozTransform||s.OTransform||s.MsTransform||s.msTransform||s.transform||s.getPropertyValue("transform").replace("translate(","matrix(1, 0, 0, 1,"),n=o.toString().split(",")),"x"===t&&(r=i.WebKitCSSMatrix?o.m41:16===n.length?parseFloat(n[12]):parseFloat(n[4])),"y"===t&&(r=i.WebKitCSSMatrix?o.m42:16===n.length?parseFloat(n[13]):parseFloat(n[5])),r||0}function isObject(e){return"object"==typeof e&&null!==e&&e.constructor&&"Object"===Object.prototype.toString.call(e).slice(8,-1)}function isNode(e){return"undefined"!=typeof window&&void 0!==window.HTMLElement?e instanceof HTMLElement:e&&(1===e.nodeType||11===e.nodeType)}function extend$1(...e){const t=Object(e[0]),i=["__proto__","constructor","prototype"];for(let n=1;n<e.length;n+=1){const r=e[n];if(null!=r&&!isNode(r)){const e=Object.keys(Object(r)).filter((e=>i.indexOf(e)<0));for(let i=0,n=e.length;i<n;i+=1){const n=e[i],o=Object.getOwnPropertyDescriptor(r,n);void 0!==o&&o.enumerable&&(isObject(t[n])&&isObject(r[n])?r[n].__swiper__?t[n]=r[n]:extend$1(t[n],r[n]):!isObject(t[n])&&isObject(r[n])?(t[n]={},r[n].__swiper__?t[n]=r[n]:extend$1(t[n],r[n])):t[n]=r[n])}}}return t}function setCSSProperty(e,t,i){e.style.setProperty(t,i)}function animateCSSModeScroll({swiper:e,targetPosition:t,side:i}){const n=getWindow(),r=-e.translate;let o,s=null;const a=e.params.speed;e.wrapperEl.style.scrollSnapType="none",n.cancelAnimationFrame(e.cssModeFrameID);const l=t>r?"next":"prev",c=(e,t)=>"next"===l&&e>=t||"prev"===l&&e<=t,u=()=>{o=(new Date).getTime(),null===s&&(s=o);const l=Math.max(Math.min((o-s)/a,1),0),h=.5-Math.cos(l*Math.PI)/2;let d=r+h*(t-r);if(c(d,t)&&(d=t),e.wrapperEl.scrollTo({[i]:d}),c(d,t))return e.wrapperEl.style.overflow="hidden",e.wrapperEl.style.scrollSnapType="",setTimeout((()=>{e.wrapperEl.style.overflow="",e.wrapperEl.scrollTo({[i]:d})})),void n.cancelAnimationFrame(e.cssModeFrameID);e.cssModeFrameID=n.requestAnimationFrame(u)};u()}function elementChildren(e,t=""){const i=getWindow(),n=[...e.children];return i.HTMLSlotElement&&e instanceof HTMLSlotElement&&n.push(...e.assignedElements()),t?n.filter((e=>e.matches(t))):n}function elementIsChildOfSlot(e,t){const i=[t];for(;i.length>0;){const t=i.shift();if(e===t)return!0;i.push(...t.children,...t.shadowRoot?t.shadowRoot.children:[],...t.assignedElements?t.assignedElements():[])}}function elementIsChildOf(e,t){const i=getWindow();let n=t.contains(e);if(!n&&i.HTMLSlotElement&&t instanceof HTMLSlotElement){n=[...t.assignedElements()].includes(e),n||(n=elementIsChildOfSlot(e,t))}return n}function showWarning(e){try{return void console.warn(e)}catch(e){}}function createElement(e,t=[]){const i=document.createElement(e);return i.classList.add(...Array.isArray(t)?t:classesToTokens(t)),i}function elementPrevAll(e,t){const i=[];for(;e.previousElementSibling;){const n=e.previousElementSibling;t?n.matches(t)&&i.push(n):i.push(n),e=n}return i}function elementNextAll(e,t){const i=[];for(;e.nextElementSibling;){const n=e.nextElementSibling;t?n.matches(t)&&i.push(n):i.push(n),e=n}return i}function elementStyle(e,t){return getWindow().getComputedStyle(e,null).getPropertyValue(t)}function elementIndex(e){let t,i=e;if(i){for(t=0;null!==(i=i.previousSibling);)1===i.nodeType&&(t+=1);return t}}function elementParents(e,t){const i=[];let n=e.parentElement;for(;n;)t?n.matches(t)&&i.push(n):i.push(n),n=n.parentElement;return i}function elementOuterSize(e,t,i){const n=getWindow();return e["width"===t?"offsetWidth":"offsetHeight"]+parseFloat(n.getComputedStyle(e,null).getPropertyValue("width"===t?"margin-right":"margin-top"))+parseFloat(n.getComputedStyle(e,null).getPropertyValue("width"===t?"margin-left":"margin-bottom"))}function makeElementsArray(e){return(Array.isArray(e)?e:[e]).filter((e=>!!e))}function setInnerHTML(e,t=""){e.innerHTML="undefined"!=typeof trustedTypes?trustedTypes.createPolicy("html",{createHTML:e=>e}).createHTML(t):t}let support,deviceCached,browser;function calcSupport(){const e=getWindow(),t=getDocument();return{smoothScroll:t.documentElement&&t.documentElement.style&&"scrollBehavior"in t.documentElement.style,touch:!!("ontouchstart"in e||e.DocumentTouch&&t instanceof e.DocumentTouch)}}function getSupport(){return support||(support=calcSupport()),support}function calcDevice({userAgent:e}={}){const t=getSupport(),i=getWindow(),n=i.navigator.platform,r=e||i.navigator.userAgent,o={ios:!1,android:!1},s=i.screen.width,a=i.screen.height,l=r.match(/(Android);?[\s\/]+([\d.]+)?/);let c=r.match(/(iPad)(?!\1).*OS\s([\d_]+)/);const u=r.match(/(iPod)(.*OS\s([\d_]+))?/),h=!c&&r.match(/(iPhone\sOS|iOS)\s([\d_]+)/),d="Win32"===n;let p="MacIntel"===n;return!c&&p&&t.touch&&["1024x1366","1366x1024","834x1194","1194x834","834x1112","1112x834","768x1024","1024x768","820x1180","1180x820","810x1080","1080x810"].indexOf(`${s}x${a}`)>=0&&(c=r.match(/(Version)\/([\d.]+)/),c||(c=[0,1,"13_0_0"]),p=!1),l&&!d&&(o.os="android",o.android=!0),(c||h||u)&&(o.os="ios",o.ios=!0),o}function getDevice(e={}){return deviceCached||(deviceCached=calcDevice(e)),deviceCached}function calcBrowser(){const e=getWindow(),t=getDevice();let i=!1;function n(){const t=e.navigator.userAgent.toLowerCase();return t.indexOf("safari")>=0&&t.indexOf("chrome")<0&&t.indexOf("android")<0}if(n()){const t=String(e.navigator.userAgent);if(t.includes("Version/")){const[e,n]=t.split("Version/")[1].split(" ")[0].split(".").map((e=>Number(e)));i=e<16||16===e&&n<2}}const r=/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(e.navigator.userAgent),o=n();return{isSafari:i||o,needPerspectiveFix:i,need3dFix:o||r&&t.ios,isWebView:r}}function getBrowser(){return browser||(browser=calcBrowser()),browser}function Resize({swiper:e,on:t,emit:i}){const n=getWindow();let r=null,o=null;const s=()=>{e&&!e.destroyed&&e.initialized&&(i("beforeResize"),i("resize"))},a=()=>{e&&!e.destroyed&&e.initialized&&i("orientationchange")};t("init",(()=>{e.params.resizeObserver&&void 0!==n.ResizeObserver?e&&!e.destroyed&&e.initialized&&(r=new ResizeObserver((t=>{o=n.requestAnimationFrame((()=>{const{width:i,height:n}=e;let r=i,o=n;t.forEach((({contentBoxSize:t,contentRect:i,target:n})=>{n&&n!==e.el||(r=i?i.width:(t[0]||t).inlineSize,o=i?i.height:(t[0]||t).blockSize)})),r===i&&o===n||s()}))})),r.observe(e.el)):(n.addEventListener("resize",s),n.addEventListener("orientationchange",a))})),t("destroy",(()=>{o&&n.cancelAnimationFrame(o),r&&r.unobserve&&e.el&&(r.unobserve(e.el),r=null),n.removeEventListener("resize",s),n.removeEventListener("orientationchange",a)}))}function Observer({swiper:e,extendParams:t,on:i,emit:n}){const r=[],o=getWindow(),s=(t,i={})=>{const s=new(o.MutationObserver||o.WebkitMutationObserver)((t=>{if(e.__preventObserver__)return;if(1===t.length)return void n("observerUpdate",t[0]);const i=function(){n("observerUpdate",t[0])};o.requestAnimationFrame?o.requestAnimationFrame(i):o.setTimeout(i,0)}));s.observe(t,{attributes:void 0===i.attributes||i.attributes,childList:e.isElement||(void 0===i.childList||i).childList,characterData:void 0===i.characterData||i.characterData}),r.push(s)};t({observer:!1,observeParents:!1,observeSlideChildren:!1}),i("init",(()=>{if(e.params.observer){if(e.params.observeParents){const t=elementParents(e.hostEl);for(let e=0;e<t.length;e+=1)s(t[e])}s(e.hostEl,{childList:e.params.observeSlideChildren}),s(e.wrapperEl,{attributes:!1})}})),i("destroy",(()=>{r.forEach((e=>{e.disconnect()})),r.splice(0,r.length)}))}var eventsEmitter={on(e,t,i){const n=this;if(!n.eventsListeners||n.destroyed)return n;if("function"!=typeof t)return n;const r=i?"unshift":"push";return e.split(" ").forEach((e=>{n.eventsListeners[e]||(n.eventsListeners[e]=[]),n.eventsListeners[e][r](t)})),n},once(e,t,i){const n=this;if(!n.eventsListeners||n.destroyed)return n;if("function"!=typeof t)return n;function r(...i){n.off(e,r),r.__emitterProxy&&delete r.__emitterProxy,t.apply(n,i)}return r.__emitterProxy=t,n.on(e,r,i)},onAny(e,t){const i=this;if(!i.eventsListeners||i.destroyed)return i;if("function"!=typeof e)return i;const n=t?"unshift":"push";return i.eventsAnyListeners.indexOf(e)<0&&i.eventsAnyListeners[n](e),i},offAny(e){const t=this;if(!t.eventsListeners||t.destroyed)return t;if(!t.eventsAnyListeners)return t;const i=t.eventsAnyListeners.indexOf(e);return i>=0&&t.eventsAnyListeners.splice(i,1),t},off(e,t){const i=this;return!i.eventsListeners||i.destroyed?i:i.eventsListeners?(e.split(" ").forEach((e=>{void 0===t?i.eventsListeners[e]=[]:i.eventsListeners[e]&&i.eventsListeners[e].forEach(((n,r)=>{(n===t||n.__emitterProxy&&n.__emitterProxy===t)&&i.eventsListeners[e].splice(r,1)}))})),i):i},emit(...e){const t=this;if(!t.eventsListeners||t.destroyed)return t;if(!t.eventsListeners)return t;let i,n,r;"string"==typeof e[0]||Array.isArray(e[0])?(i=e[0],n=e.slice(1,e.length),r=t):(i=e[0].events,n=e[0].data,r=e[0].context||t),n.unshift(r);return(Array.isArray(i)?i:i.split(" ")).forEach((e=>{t.eventsAnyListeners&&t.eventsAnyListeners.length&&t.eventsAnyListeners.forEach((t=>{t.apply(r,[e,...n])})),t.eventsListeners&&t.eventsListeners[e]&&t.eventsListeners[e].forEach((e=>{e.apply(r,n)}))})),t}};function updateSize(){const e=this;let t,i;const n=e.el;t=null!=e.params.width?e.params.width:n.clientWidth,i=null!=e.params.height?e.params.height:n.clientHeight,0===t&&e.isHorizontal()||0===i&&e.isVertical()||(t=t-parseInt(elementStyle(n,"padding-left")||0,10)-parseInt(elementStyle(n,"padding-right")||0,10),i=i-parseInt(elementStyle(n,"padding-top")||0,10)-parseInt(elementStyle(n,"padding-bottom")||0,10),Number.isNaN(t)&&(t=0),Number.isNaN(i)&&(i=0),Object.assign(e,{width:t,height:i,size:e.isHorizontal()?t:i}))}function updateSlides(){const e=this;function t(t,i){return parseFloat(t.getPropertyValue(e.getDirectionLabel(i))||0)}const i=e.params,{wrapperEl:n,slidesEl:r,rtlTranslate:o,wrongRTL:s}=e,a=e.virtual&&i.virtual.enabled,l=a?e.virtual.slides.length:e.slides.length,c=elementChildren(r,`.${e.params.slideClass}, swiper-slide`),u=a?e.virtual.slides.length:c.length;let h=[];const d=[],p=[];let f=i.slidesOffsetBefore;"function"==typeof f&&(f=i.slidesOffsetBefore.call(e));let m=i.slidesOffsetAfter;"function"==typeof m&&(m=i.slidesOffsetAfter.call(e));const g=e.snapGrid.length,_=e.slidesGrid.length,y=e.size-f-m;let v=i.spaceBetween,x=-f,b=0,T=0;if(void 0===y)return;"string"==typeof v&&v.indexOf("%")>=0?v=parseFloat(v.replace("%",""))/100*y:"string"==typeof v&&(v=parseFloat(v)),e.virtualSize=-v-f-m,c.forEach((e=>{o?e.style.marginLeft="":e.style.marginRight="",e.style.marginBottom="",e.style.marginTop=""})),i.centeredSlides&&i.cssMode&&(setCSSProperty(n,"--swiper-centered-offset-before",""),setCSSProperty(n,"--swiper-centered-offset-after","")),i.cssMode&&(setCSSProperty(n,"--swiper-slides-offset-before",`${f}px`),setCSSProperty(n,"--swiper-slides-offset-after",`${m}px`));const w=i.grid&&i.grid.rows>1&&e.grid;let E;w?e.grid.initSlides(c):e.grid&&e.grid.unsetSlides();const S="auto"===i.slidesPerView&&i.breakpoints&&Object.keys(i.breakpoints).filter((e=>void 0!==i.breakpoints[e].slidesPerView)).length>0;for(let n=0;n<u;n+=1){E=0;const r=c[n];if(!r||(w&&e.grid.updateSlide(n,r,c),"none"!==elementStyle(r,"display"))){if(a&&"auto"===i.slidesPerView)i.virtual.slidesPerViewAutoSlideSize&&(E=i.virtual.slidesPerViewAutoSlideSize),E&&r&&(i.roundLengths&&(E=Math.floor(E)),r.style[e.getDirectionLabel("width")]=`${E}px`);else if("auto"===i.slidesPerView){S&&(r.style[e.getDirectionLabel("width")]="");const n=getComputedStyle(r),o=r.style.transform,s=r.style.webkitTransform;if(o&&(r.style.transform="none"),s&&(r.style.webkitTransform="none"),i.roundLengths)E=e.isHorizontal()?elementOuterSize(r,"width"):elementOuterSize(r,"height");else{const e=t(n,"width"),i=t(n,"padding-left"),o=t(n,"padding-right"),s=t(n,"margin-left"),a=t(n,"margin-right"),l=n.getPropertyValue("box-sizing");if(l&&"border-box"===l)E=e+s+a;else{const{clientWidth:t,offsetWidth:n}=r;E=e+i+o+s+a+(n-t)}}o&&(r.style.transform=o),s&&(r.style.webkitTransform=s),i.roundLengths&&(E=Math.floor(E))}else E=(y-(i.slidesPerView-1)*v)/i.slidesPerView,i.roundLengths&&(E=Math.floor(E)),r&&(r.style[e.getDirectionLabel("width")]=`${E}px`);r&&(r.swiperSlideSize=E),p.push(E),i.centeredSlides?(x=x+E/2+b/2+v,0===b&&0!==n&&(x=x-y/2-v),0===n&&(x=x-y/2-v),Math.abs(x)<.001&&(x=0),i.roundLengths&&(x=Math.floor(x)),T%i.slidesPerGroup==0&&h.push(x),d.push(x)):(i.roundLengths&&(x=Math.floor(x)),(T-Math.min(e.params.slidesPerGroupSkip,T))%e.params.slidesPerGroup==0&&h.push(x),d.push(x),x=x+E+v),e.virtualSize+=E+v,b=E,T+=1}}if(e.virtualSize=Math.max(e.virtualSize,y)+m,o&&s&&("slide"===i.effect||"coverflow"===i.effect)&&(n.style.width=`${e.virtualSize+v}px`),i.setWrapperSize&&(n.style[e.getDirectionLabel("width")]=`${e.virtualSize+v}px`),w&&e.grid.updateWrapperSize(E,h),!i.centeredSlides){const t=i.snapToSlideEdge&&!i.loop&&("auto"===i.slidesPerView||"auto"!==i.slidesPerView&&i.slidesPerView%1!=0);let n=h.length;if(t){let e;if("auto"===i.slidesPerView){e=1;let t=0;for(let i=p.length-1;i>=0&&(t+=p[i]+(i<p.length-1?v:0),t<=y);i-=1)e=p.length-i}else e=Math.floor(i.slidesPerView);n=Math.max(u-e,0)}const r=[];for(let o=0;o<h.length;o+=1){let s=h[o];i.roundLengths&&(s=Math.floor(s)),t?o<=n&&r.push(s):h[o]<=e.virtualSize-y&&r.push(s)}h=r,Math.floor(e.virtualSize-y)-Math.floor(h[h.length-1])>1&&(t||h.push(e.virtualSize-y))}if(a&&i.loop){const t=p[0]+v;if(i.slidesPerGroup>1){const n=Math.ceil((e.virtual.slidesBefore+e.virtual.slidesAfter)/i.slidesPerGroup),r=t*i.slidesPerGroup;for(let e=0;e<n;e+=1)h.push(h[h.length-1]+r)}for(let n=0;n<e.virtual.slidesBefore+e.virtual.slidesAfter;n+=1)1===i.slidesPerGroup&&h.push(h[h.length-1]+t),d.push(d[d.length-1]+t),e.virtualSize+=t}if(0===h.length&&(h=[0]),0!==v){const t=e.isHorizontal()&&o?"marginLeft":e.getDirectionLabel("marginRight");c.filter(((e,t)=>!(i.cssMode&&!i.loop)||t!==c.length-1)).forEach((e=>{e.style[t]=`${v}px`}))}if(i.centeredSlides&&i.centeredSlidesBounds){let e=0;p.forEach((t=>{e+=t+(v||0)})),e-=v;const t=e>y?e-y:0;h=h.map((e=>e<=0?-f:e>t?t+m:e))}if(i.centerInsufficientSlides){let e=0;p.forEach((t=>{e+=t+(v||0)})),e-=v;const t=(f||0)+(m||0);if(e+t<y){const i=(y-e-t)/2;h.forEach(((e,t)=>{h[t]=e-i})),d.forEach(((e,t)=>{d[t]=e+i}))}}if(Object.assign(e,{slides:c,snapGrid:h,slidesGrid:d,slidesSizesGrid:p}),i.centeredSlides&&i.cssMode&&!i.centeredSlidesBounds){setCSSProperty(n,"--swiper-centered-offset-before",-h[0]+"px"),setCSSProperty(n,"--swiper-centered-offset-after",e.size/2-p[p.length-1]/2+"px");const t=-e.snapGrid[0],i=-e.slidesGrid[0];e.snapGrid=e.snapGrid.map((e=>e+t)),e.slidesGrid=e.slidesGrid.map((e=>e+i))}if(u!==l&&e.emit("slidesLengthChange"),h.length!==g&&(e.params.watchOverflow&&e.checkOverflow(),e.emit("snapGridLengthChange")),d.length!==_&&e.emit("slidesGridLengthChange"),i.watchSlidesProgress&&e.updateSlidesOffset(),e.emit("slidesUpdated"),!(a||i.cssMode||"slide"!==i.effect&&"fade"!==i.effect)){const t=`${i.containerModifierClass}backface-hidden`,n=e.el.classList.contains(t);u<=i.maxBackfaceHiddenSlides?n||e.el.classList.add(t):n&&e.el.classList.remove(t)}}function updateAutoHeight(e){const t=this,i=[],n=t.virtual&&t.params.virtual.enabled;let r,o=0;"number"==typeof e?t.setTransition(e):!0===e&&t.setTransition(t.params.speed);const s=e=>n?t.slides[t.getSlideIndexByData(e)]:t.slides[e];if("auto"!==t.params.slidesPerView&&t.params.slidesPerView>1)if(t.params.centeredSlides)(t.visibleSlides||[]).forEach((e=>{i.push(e)}));else for(r=0;r<Math.ceil(t.params.slidesPerView);r+=1){const e=t.activeIndex+r;if(e>t.slides.length&&!n)break;i.push(s(e))}else i.push(s(t.activeIndex));for(r=0;r<i.length;r+=1)if(void 0!==i[r]){const e=i[r].offsetHeight;o=e>o?e:o}(o||0===o)&&(t.wrapperEl.style.height=`${o}px`)}function updateSlidesOffset(){const e=this,t=e.slides,i=e.isElement?e.isHorizontal()?e.wrapperEl.offsetLeft:e.wrapperEl.offsetTop:0;for(let n=0;n<t.length;n+=1)t[n].swiperSlideOffset=(e.isHorizontal()?t[n].offsetLeft:t[n].offsetTop)-i-e.cssOverflowAdjustment()}const toggleSlideClasses$1=(e,t,i)=>{t&&!e.classList.contains(i)?e.classList.add(i):!t&&e.classList.contains(i)&&e.classList.remove(i)};function updateSlidesProgress(e=this&&this.translate||0){const t=this,i=t.params,{slides:n,rtlTranslate:r,snapGrid:o}=t;if(0===n.length)return;void 0===n[0].swiperSlideOffset&&t.updateSlidesOffset();let s=-e;r&&(s=e),t.visibleSlidesIndexes=[],t.visibleSlides=[];let a=i.spaceBetween;"string"==typeof a&&a.indexOf("%")>=0?a=parseFloat(a.replace("%",""))/100*t.size:"string"==typeof a&&(a=parseFloat(a));for(let e=0;e<n.length;e+=1){const l=n[e];let c=l.swiperSlideOffset;i.cssMode&&i.centeredSlides&&(c-=n[0].swiperSlideOffset);const u=(s+(i.centeredSlides?t.minTranslate():0)-c)/(l.swiperSlideSize+a),h=(s-o[0]+(i.centeredSlides?t.minTranslate():0)-c)/(l.swiperSlideSize+a),d=-(s-c),p=d+t.slidesSizesGrid[e],f=d>=0&&d<=t.size-t.slidesSizesGrid[e],m=d>=0&&d<t.size-1||p>1&&p<=t.size||d<=0&&p>=t.size;m&&(t.visibleSlides.push(l),t.visibleSlidesIndexes.push(e)),toggleSlideClasses$1(l,m,i.slideVisibleClass),toggleSlideClasses$1(l,f,i.slideFullyVisibleClass),l.progress=r?-u:u,l.originalProgress=r?-h:h}}function updateProgress(e){const t=this;if(void 0===e){e=t&&t.translate&&t.translate*(t.rtlTranslate?-1:1)||0}const i=t.params,n=t.maxTranslate()-t.minTranslate();let{progress:r,isBeginning:o,isEnd:s,progressLoop:a}=t;const l=o,c=s;if(0===n)r=0,o=!0,s=!0;else{r=(e-t.minTranslate())/n;const i=Math.abs(e-t.minTranslate())<1,a=Math.abs(e-t.maxTranslate())<1;o=i||r<=0,s=a||r>=1,i&&(r=0),a&&(r=1)}if(i.loop){const i=t.getSlideIndexByData(0),n=t.getSlideIndexByData(t.slides.length-1),r=t.slidesGrid[i],o=t.slidesGrid[n],s=t.slidesGrid[t.slidesGrid.length-1],l=Math.abs(e);a=l>=r?(l-r)/s:(l+s-o)/s,a>1&&(a-=1)}Object.assign(t,{progress:r,progressLoop:a,isBeginning:o,isEnd:s}),(i.watchSlidesProgress||i.centeredSlides&&i.autoHeight)&&t.updateSlidesProgress(e),o&&!l&&t.emit("reachBeginning toEdge"),s&&!c&&t.emit("reachEnd toEdge"),(l&&!o||c&&!s)&&t.emit("fromEdge"),t.emit("progress",r)}const toggleSlideClasses=(e,t,i)=>{t&&!e.classList.contains(i)?e.classList.add(i):!t&&e.classList.contains(i)&&e.classList.remove(i)};function updateSlidesClasses(){const e=this,{slides:t,params:i,slidesEl:n,activeIndex:r}=e,o=e.grid&&i.grid&&i.grid.rows>1,s=e=>elementChildren(n,`.${i.slideClass}${e}, swiper-slide${e}`)[0];let a,l,c;if(e.virtual&&i.virtual.enabled)if(i.loop){let t=r-e.virtual.slidesBefore;t<0&&(t=e.virtual.slides.length+t),t>=e.virtual.slides.length&&(t-=e.virtual.slides.length),a=s(`[data-swiper-slide-index="${t}"]`)}else a=s(`[data-swiper-slide-index="${r}"]`);else o?(a=t.find((e=>e.column===r)),c=t.find((e=>e.column===r+1)),l=t.find((e=>e.column===r-1))):a=t[r];a&&(o||(c=elementNextAll(a,`.${i.slideClass}, swiper-slide`)[0],i.loop&&!c&&(c=t[0]),l=elementPrevAll(a,`.${i.slideClass}, swiper-slide`)[0],i.loop&&0===!l&&(l=t[t.length-1]))),t.forEach((e=>{toggleSlideClasses(e,e===a,i.slideActiveClass),toggleSlideClasses(e,e===c,i.slideNextClass),toggleSlideClasses(e,e===l,i.slidePrevClass)})),e.emitSlidesClasses()}const processLazyPreloader=(e,t)=>{if(!e||e.destroyed||!e.params)return;const i=t.closest(e.isElement?"swiper-slide":`.${e.params.slideClass}`);if(i){let t=i.querySelector(`.${e.params.lazyPreloaderClass}`);!t&&e.isElement&&(i.shadowRoot?t=i.shadowRoot.querySelector(`.${e.params.lazyPreloaderClass}`):requestAnimationFrame((()=>{i.shadowRoot&&(t=i.shadowRoot.querySelector(`.${e.params.lazyPreloaderClass}`),t&&!t.lazyPreloaderManaged&&t.remove())}))),t&&!t.lazyPreloaderManaged&&t.remove()}},unlazy=(e,t)=>{if(!e.slides[t])return;const i=e.slides[t].querySelector('[loading="lazy"]');i&&i.removeAttribute("loading")},preload=e=>{if(!e||e.destroyed||!e.params)return;let t=e.params.lazyPreloadPrevNext;const i=e.slides.length;if(!i||!t||t<0)return;t=Math.min(t,i);const n="auto"===e.params.slidesPerView?e.slidesPerViewDynamic():Math.ceil(e.params.slidesPerView),r=e.activeIndex;if(e.params.grid&&e.params.grid.rows>1){const i=r,o=[i-t];return o.push(...Array.from({length:t}).map(((e,t)=>i+n+t))),void e.slides.forEach(((t,i)=>{o.includes(t.column)&&unlazy(e,i)}))}const o=r+n-1;if(e.params.rewind||e.params.loop)for(let n=r-t;n<=o+t;n+=1){const t=(n%i+i)%i;(t<r||t>o)&&unlazy(e,t)}else for(let n=Math.max(r-t,0);n<=Math.min(o+t,i-1);n+=1)n!==r&&(n>o||n<r)&&unlazy(e,n)};function getActiveIndexByTranslate(e){const{slidesGrid:t,params:i}=e,n=e.rtlTranslate?e.translate:-e.translate;let r;for(let e=0;e<t.length;e+=1)void 0!==t[e+1]?n>=t[e]&&n<t[e+1]-(t[e+1]-t[e])/2?r=e:n>=t[e]&&n<t[e+1]&&(r=e+1):n>=t[e]&&(r=e);return i.normalizeSlideIndex&&(r<0||void 0===r)&&(r=0),r}function updateActiveIndex(e){const t=this,i=t.rtlTranslate?t.translate:-t.translate,{snapGrid:n,params:r,activeIndex:o,realIndex:s,snapIndex:a}=t;let l,c=e;const u=e=>{let i=e-t.virtual.slidesBefore;return i<0&&(i=t.virtual.slides.length+i),i>=t.virtual.slides.length&&(i-=t.virtual.slides.length),i};if(void 0===c&&(c=getActiveIndexByTranslate(t)),n.indexOf(i)>=0)l=n.indexOf(i);else{const e=Math.min(r.slidesPerGroupSkip,c);l=e+Math.floor((c-e)/r.slidesPerGroup)}if(l>=n.length&&(l=n.length-1),c===o&&!t.params.loop)return void(l!==a&&(t.snapIndex=l,t.emit("snapIndexChange")));if(c===o&&t.params.loop&&t.virtual&&t.params.virtual.enabled)return void(t.realIndex=u(c));const h=t.grid&&r.grid&&r.grid.rows>1;let d;if(t.virtual&&r.virtual.enabled)d=r.loop?u(c):c;else if(h){const e=t.slides.find((e=>e.column===c));let i=parseInt(e.getAttribute("data-swiper-slide-index"),10);Number.isNaN(i)&&(i=Math.max(t.slides.indexOf(e),0)),d=Math.floor(i/r.grid.rows)}else if(t.slides[c]){const e=t.slides[c].getAttribute("data-swiper-slide-index");d=e?parseInt(e,10):c}else d=c;Object.assign(t,{previousSnapIndex:a,snapIndex:l,previousRealIndex:s,realIndex:d,previousIndex:o,activeIndex:c}),t.initialized&&preload(t),t.emit("activeIndexChange"),t.emit("snapIndexChange"),(t.initialized||t.params.runCallbacksOnInit)&&(s!==d&&t.emit("realIndexChange"),t.emit("slideChange"))}function updateClickedSlide(e,t){const i=this,n=i.params;let r=e.closest(`.${n.slideClass}, swiper-slide`);!r&&i.isElement&&t&&t.length>1&&t.includes(e)&&[...t.slice(t.indexOf(e)+1,t.length)].forEach((e=>{!r&&e.matches&&e.matches(`.${n.slideClass}, swiper-slide`)&&(r=e)}));let o,s=!1;if(r)for(let e=0;e<i.slides.length;e+=1)if(i.slides[e]===r){s=!0,o=e;break}if(!r||!s)return i.clickedSlide=void 0,void(i.clickedIndex=void 0);i.clickedSlide=r,i.clickedIndex=i.virtual&&i.params.virtual.enabled?parseInt(r.getAttribute("data-swiper-slide-index"),10):o,n.slideToClickedSlide&&void 0!==i.clickedIndex&&i.clickedIndex!==i.activeIndex&&i.slideToClickedSlide()}var update={updateSize:updateSize,updateSlides:updateSlides,updateAutoHeight:updateAutoHeight,updateSlidesOffset:updateSlidesOffset,updateSlidesProgress:updateSlidesProgress,updateProgress:updateProgress,updateSlidesClasses:updateSlidesClasses,updateActiveIndex:updateActiveIndex,updateClickedSlide:updateClickedSlide};function getSwiperTranslate(e=(this.isHorizontal()?"x":"y")){const{params:t,rtlTranslate:i,translate:n,wrapperEl:r}=this;if(t.virtualTranslate)return i?-n:n;if(t.cssMode)return n;let o=getTranslate(r,e);return o+=this.cssOverflowAdjustment(),i&&(o=-o),o||0}function setTranslate(e,t){const i=this,{rtlTranslate:n,params:r,wrapperEl:o,progress:s}=i;let a=0,l=0;let c;i.isHorizontal()?a=n?-e:e:l=e,r.roundLengths&&(a=Math.floor(a),l=Math.floor(l)),i.previousTranslate=i.translate,i.translate=i.isHorizontal()?a:l,r.cssMode?o[i.isHorizontal()?"scrollLeft":"scrollTop"]=i.isHorizontal()?-a:-l:r.virtualTranslate||(i.isHorizontal()?a-=i.cssOverflowAdjustment():l-=i.cssOverflowAdjustment(),o.style.transform=`translate3d(${a}px, ${l}px, 0px)`);const u=i.maxTranslate()-i.minTranslate();c=0===u?0:(e-i.minTranslate())/u,c!==s&&i.updateProgress(e),i.emit("setTranslate",i.translate,t)}function minTranslate(){return-this.snapGrid[0]}function maxTranslate(){return-this.snapGrid[this.snapGrid.length-1]}function translateTo(e=0,t=this.params.speed,i=!0,n=!0,r){const o=this,{params:s,wrapperEl:a}=o;if(o.animating&&s.preventInteractionOnTransition)return!1;const l=o.minTranslate(),c=o.maxTranslate();let u;if(u=n&&e>l?l:n&&e<c?c:e,o.updateProgress(u),s.cssMode){const e=o.isHorizontal();if(0===t)a[e?"scrollLeft":"scrollTop"]=-u;else{if(!o.support.smoothScroll)return animateCSSModeScroll({swiper:o,targetPosition:-u,side:e?"left":"top"}),!0;a.scrollTo({[e?"left":"top"]:-u,behavior:"smooth"})}return!0}return 0===t?(o.setTransition(0),o.setTranslate(u),i&&(o.emit("beforeTransitionStart",t,r),o.emit("transitionEnd"))):(o.setTransition(t),o.setTranslate(u),i&&(o.emit("beforeTransitionStart",t,r),o.emit("transitionStart")),o.animating||(o.animating=!0,o.onTranslateToWrapperTransitionEnd||(o.onTranslateToWrapperTransitionEnd=function(e){o&&!o.destroyed&&e.target===this&&(o.wrapperEl.removeEventListener("transitionend",o.onTranslateToWrapperTransitionEnd),o.onTranslateToWrapperTransitionEnd=null,delete o.onTranslateToWrapperTransitionEnd,o.animating=!1,i&&o.emit("transitionEnd"))}),o.wrapperEl.addEventListener("transitionend",o.onTranslateToWrapperTransitionEnd))),!0}var translate={getTranslate:getSwiperTranslate,setTranslate:setTranslate,minTranslate:minTranslate,maxTranslate:maxTranslate,translateTo:translateTo};function setTransition(e,t){const i=this;i.params.cssMode||(i.wrapperEl.style.transitionDuration=`${e}ms`,i.wrapperEl.style.transitionDelay=0===e?"0ms":""),i.emit("setTransition",e,t)}function transitionEmit({swiper:e,runCallbacks:t,direction:i,step:n}){const{activeIndex:r,previousIndex:o}=e;let s=i;s||(s=r>o?"next":r<o?"prev":"reset"),e.emit(`transition${n}`),t&&"reset"===s?e.emit(`slideResetTransition${n}`):t&&r!==o&&(e.emit(`slideChangeTransition${n}`),e.emit("next"===s?`slideNextTransition${n}`:`slidePrevTransition${n}`))}function transitionStart(e=!0,t){const i=this,{params:n}=i;n.cssMode||(n.autoHeight&&i.updateAutoHeight(),transitionEmit({swiper:i,runCallbacks:e,direction:t,step:"Start"}))}function transitionEnd(e=!0,t){const i=this,{params:n}=i;i.animating=!1,n.cssMode||(i.setTransition(0),transitionEmit({swiper:i,runCallbacks:e,direction:t,step:"End"}))}var transition={setTransition:setTransition,transitionStart:transitionStart,transitionEnd:transitionEnd};function slideTo(e=0,t,i=!0,n,r){"string"==typeof e&&(e=parseInt(e,10));const o=this;let s=e;s<0&&(s=0);const{params:a,snapGrid:l,slidesGrid:c,previousIndex:u,activeIndex:h,rtlTranslate:d,wrapperEl:p,enabled:f}=o;if(!f&&!n&&!r||o.destroyed||o.animating&&a.preventInteractionOnTransition)return!1;void 0===t&&(t=o.params.speed);const m=Math.min(o.params.slidesPerGroupSkip,s);let g=m+Math.floor((s-m)/o.params.slidesPerGroup);g>=l.length&&(g=l.length-1);const _=-l[g];if(a.normalizeSlideIndex)for(let e=0;e<c.length;e+=1){const t=-Math.floor(100*_),i=Math.floor(100*c[e]),n=Math.floor(100*c[e+1]);void 0!==c[e+1]?t>=i&&t<n-(n-i)/2?s=e:t>=i&&t<n&&(s=e+1):t>=i&&(s=e)}if(o.initialized&&s!==h){if(!o.allowSlideNext&&(d?_>o.translate&&_>o.minTranslate():_<o.translate&&_<o.minTranslate()))return!1;if(!o.allowSlidePrev&&_>o.translate&&_>o.maxTranslate()&&(h||0)!==s)return!1}let y;s!==(u||0)&&i&&o.emit("beforeSlideChangeStart"),o.updateProgress(_),y=s>h?"next":s<h?"prev":"reset";const v=o.virtual&&o.params.virtual.enabled;if(!(v&&r)&&(d&&-_===o.translate||!d&&_===o.translate))return o.updateActiveIndex(s),a.autoHeight&&o.updateAutoHeight(),o.updateSlidesClasses(),"slide"!==a.effect&&o.setTranslate(_),"reset"!==y&&(o.transitionStart(i,y),o.transitionEnd(i,y)),!1;if(a.cssMode){const e=o.isHorizontal(),i=d?_:-_;if(0===t)v&&(o.wrapperEl.style.scrollSnapType="none",o._immediateVirtual=!0),v&&!o._cssModeVirtualInitialSet&&o.params.initialSlide>0?(o._cssModeVirtualInitialSet=!0,requestAnimationFrame((()=>{p[e?"scrollLeft":"scrollTop"]=i}))):p[e?"scrollLeft":"scrollTop"]=i,v&&requestAnimationFrame((()=>{o.wrapperEl.style.scrollSnapType="",o._immediateVirtual=!1}));else{if(!o.support.smoothScroll)return animateCSSModeScroll({swiper:o,targetPosition:i,side:e?"left":"top"}),!0;p.scrollTo({[e?"left":"top"]:i,behavior:"smooth"})}return!0}const x=getBrowser();return v&&!r&&x.isSafari&&o.isElement&&o.virtual.update(!1,!1,s),o.setTransition(t),o.setTranslate(_),o.updateActiveIndex(s),o.updateSlidesClasses(),o.emit("beforeTransitionStart",t,n),o.transitionStart(i,y),0===t?o.transitionEnd(i,y):o.animating||(o.animating=!0,o.onSlideToWrapperTransitionEnd||(o.onSlideToWrapperTransitionEnd=function(e){o&&!o.destroyed&&e.target===this&&(o.wrapperEl.removeEventListener("transitionend",o.onSlideToWrapperTransitionEnd),o.onSlideToWrapperTransitionEnd=null,delete o.onSlideToWrapperTransitionEnd,o.transitionEnd(i,y))}),o.wrapperEl.addEventListener("transitionend",o.onSlideToWrapperTransitionEnd)),!0}function slideToLoop(e=0,t,i=!0,n){if("string"==typeof e){e=parseInt(e,10)}const r=this;if(r.destroyed)return;void 0===t&&(t=r.params.speed);const o=r.grid&&r.params.grid&&r.params.grid.rows>1;let s=e;if(r.params.loop)if(r.virtual&&r.params.virtual.enabled)s+=r.virtual.slidesBefore;else{let e;if(o){const t=s*r.params.grid.rows;e=r.slides.find((e=>1*e.getAttribute("data-swiper-slide-index")===t)).column}else e=r.getSlideIndexByData(s);const t=o?Math.ceil(r.slides.length/r.params.grid.rows):r.slides.length,{centeredSlides:i,slidesOffsetBefore:a,slidesOffsetAfter:l}=r.params,c=i||!!a||!!l;let u=r.params.slidesPerView;"auto"===u?u=r.slidesPerViewDynamic():(u=Math.ceil(parseFloat(r.params.slidesPerView,10)),c&&u%2==0&&(u+=1));let h=t-e<u;if(c&&(h=h||e<Math.ceil(u/2)),n&&c&&"auto"!==r.params.slidesPerView&&!o&&(h=!1),h){const i=c?e<r.activeIndex?"prev":"next":e-r.activeIndex-1<r.params.slidesPerView?"next":"prev";r.loopFix({direction:i,slideTo:!0,activeSlideIndex:"next"===i?e+1:e-t+1,slideRealIndex:"next"===i?r.realIndex:void 0})}if(o){const e=s*r.params.grid.rows;s=r.slides.find((t=>1*t.getAttribute("data-swiper-slide-index")===e)).column}else s=r.getSlideIndexByData(s)}return requestAnimationFrame((()=>{r.slideTo(s,t,i,n)})),r}function slideNext(e,t=!0,i){const n=this,{enabled:r,params:o,animating:s}=n;if(!r||n.destroyed)return n;void 0===e&&(e=n.params.speed);let a=o.slidesPerGroup;"auto"===o.slidesPerView&&1===o.slidesPerGroup&&o.slidesPerGroupAuto&&(a=Math.max(n.slidesPerViewDynamic("current",!0),1));const l=n.activeIndex<o.slidesPerGroupSkip?1:a;if(o.loop){if(s&&!(n.virtual&&o.virtual.enabled)&&o.loopPreventsSliding)return!1;if(n.loopFix({direction:"next"}),n._clientLeft=n.wrapperEl.clientLeft,n.activeIndex===n.slides.length-1&&o.cssMode)return requestAnimationFrame((()=>{n.slideTo(n.activeIndex+l,e,t,i)})),!0}return n.slideTo(o.rewind&&n.isEnd?0:n.activeIndex+l,e,t,i)}function slidePrev(e,t=!0,i){const n=this,{params:r,snapGrid:o,slidesGrid:s,rtlTranslate:a,enabled:l,animating:c}=n;if(!l||n.destroyed)return n;void 0===e&&(e=n.params.speed);if(r.loop){if(c&&!(n.virtual&&r.virtual.enabled)&&r.loopPreventsSliding)return!1;n.loopFix({direction:"prev"}),n._clientLeft=n.wrapperEl.clientLeft}function u(e){return e<0?-Math.floor(Math.abs(e)):Math.floor(e)}const h=u(a?n.translate:-n.translate),d=o.map((e=>u(e))),p=r.freeMode&&r.freeMode.enabled;let f=o[d.indexOf(h)-1];if(void 0===f&&(r.cssMode||p)){let e;o.forEach(((t,i)=>{h>=t&&(e=i)})),void 0!==e&&(f=p?o[e]:o[e>0?e-1:e])}let m=0;if(void 0!==f&&(m=s.indexOf(f),m<0&&(m=n.activeIndex-1),"auto"===r.slidesPerView&&1===r.slidesPerGroup&&r.slidesPerGroupAuto&&(m=m-n.slidesPerViewDynamic("previous",!0)+1,m=Math.max(m,0))),r.rewind&&n.isBeginning){return n.slideTo(n.params.virtual&&n.params.virtual.enabled&&n.virtual?n.virtual.slides.length-1:n.slides.length-1,e,t,i)}return r.loop&&0===n.activeIndex&&r.cssMode?(requestAnimationFrame((()=>{n.slideTo(m,e,t,i)})),!0):n.slideTo(m,e,t,i)}function slideReset(e,t=!0,i){const n=this;if(!n.destroyed)return void 0===e&&(e=n.params.speed),n.slideTo(n.activeIndex,e,t,i)}function slideToClosest(e,t=!0,i,n=.5){const r=this;if(r.destroyed)return;void 0===e&&(e=r.params.speed);let o=r.activeIndex;const s=Math.min(r.params.slidesPerGroupSkip,o),a=s+Math.floor((o-s)/r.params.slidesPerGroup),l=r.rtlTranslate?r.translate:-r.translate;if(l>=r.snapGrid[a]){const e=r.snapGrid[a];l-e>(r.snapGrid[a+1]-e)*n&&(o+=r.params.slidesPerGroup)}else{const e=r.snapGrid[a-1];l-e<=(r.snapGrid[a]-e)*n&&(o-=r.params.slidesPerGroup)}return o=Math.max(o,0),o=Math.min(o,r.slidesGrid.length-1),r.slideTo(o,e,t,i)}function slideToClickedSlide(){const e=this;if(e.destroyed)return;const{params:t,slidesEl:i}=e,n="auto"===t.slidesPerView?e.slidesPerViewDynamic():t.slidesPerView;let r,o=e.getSlideIndexWhenGrid(e.clickedIndex);const s=e.isElement?"swiper-slide":`.${t.slideClass}`,a=e.grid&&e.params.grid&&e.params.grid.rows>1;if(t.loop){if(e.animating)return;r=parseInt(e.clickedSlide.getAttribute("data-swiper-slide-index"),10),t.centeredSlides?e.slideToLoop(r):o>(a?(e.slides.length-n)/2-(e.params.grid.rows-1):e.slides.length-n)?(e.loopFix(),o=e.getSlideIndex(elementChildren(i,`${s}[data-swiper-slide-index="${r}"]`)[0]),nextTick((()=>{e.slideTo(o)}))):e.slideTo(o)}else e.slideTo(o)}var slide={slideTo:slideTo,slideToLoop:slideToLoop,slideNext:slideNext,slidePrev:slidePrev,slideReset:slideReset,slideToClosest:slideToClosest,slideToClickedSlide:slideToClickedSlide};function loopCreate(e,t){const i=this,{params:n,slidesEl:r}=i;if(!n.loop||i.virtual&&i.params.virtual.enabled)return;const o=()=>{elementChildren(r,`.${n.slideClass}, swiper-slide`).forEach(((e,t)=>{e.setAttribute("data-swiper-slide-index",t)}))},s=i.grid&&n.grid&&n.grid.rows>1;n.loopAddBlankSlides&&(n.slidesPerGroup>1||s)&&(()=>{const e=elementChildren(r,`.${n.slideBlankClass}`);e.forEach((e=>{e.remove()})),e.length>0&&(i.recalcSlides(),i.updateSlides())})();const a=n.slidesPerGroup*(s?n.grid.rows:1),l=s&&i.slides.length%n.grid.rows!=0,c=e=>{for(let t=0;t<e;t+=1){const e=i.isElement?createElement("swiper-slide",[n.slideBlankClass]):createElement("div",[n.slideClass,n.slideBlankClass]);i.slidesEl.append(e)}};if(i.slides.length%a!=0){if(n.loopAddBlankSlides){c(a-i.slides.length%a),i.recalcSlides(),i.updateSlides()}else showWarning("Swiper Loop Warning: The number of slides is not even to slidesPerGroup, loop mode may not function properly. You need to add more slides (or make duplicates, or empty slides)");o()}else if(l){if(n.loopAddBlankSlides){c(n.grid.rows-i.slides.length%n.grid.rows),i.recalcSlides(),i.updateSlides()}else showWarning("Swiper Loop Warning: The number of slides is not even to grid.rows, loop mode may not function properly. You need to add more slides (or make duplicates, or empty slides)");o()}else o();i.loopFix({slideRealIndex:e,direction:n.centeredSlides||!!n.slidesOffsetBefore||!!n.slidesOffsetAfter?void 0:"next",initial:t})}function loopFix({slideRealIndex:e,slideTo:t=!0,direction:i,setTranslate:n,activeSlideIndex:r,initial:o,byController:s,byMousewheel:a}={}){const l=this;if(!l.params.loop)return;l.emit("beforeLoopFix");const{slides:c,allowSlidePrev:u,allowSlideNext:h,slidesEl:d,params:p}=l,{centeredSlides:f,slidesOffsetBefore:m,slidesOffsetAfter:g,initialSlide:_}=p,y=f||!!m||!!g;if(l.allowSlidePrev=!0,l.allowSlideNext=!0,l.virtual&&p.virtual.enabled)return t&&(y||0!==l.snapIndex?y&&l.snapIndex<p.slidesPerView?l.slideTo(l.virtual.slides.length+l.snapIndex,0,!1,!0):l.snapIndex===l.snapGrid.length-1&&l.slideTo(l.virtual.slidesBefore,0,!1,!0):l.slideTo(l.virtual.slides.length,0,!1,!0)),l.allowSlidePrev=u,l.allowSlideNext=h,void l.emit("loopFix");let v=p.slidesPerView;"auto"===v?v=l.slidesPerViewDynamic():(v=Math.ceil(parseFloat(p.slidesPerView,10)),y&&v%2==0&&(v+=1));const x=p.slidesPerGroupAuto?v:p.slidesPerGroup;let b=y?Math.max(x,Math.ceil(v/2)):x;b%x!=0&&(b+=x-b%x),b+=p.loopAdditionalSlides,l.loopedSlides=b;const T=l.grid&&p.grid&&p.grid.rows>1;c.length<v+b||"cards"===l.params.effect&&c.length<v+2*b?showWarning("Swiper Loop Warning: The number of slides is not enough for loop mode, it will be disabled or not function properly. You need to add more slides (or make duplicates) or lower the values of slidesPerView and slidesPerGroup parameters"):T&&"row"===p.grid.fill&&showWarning("Swiper Loop Warning: Loop mode is not compatible with grid.fill = `row`");const w=[],E=[],S=T?Math.ceil(c.length/p.grid.rows):c.length,A=o&&S-_<v&&!y;let M=A?_:l.activeIndex;void 0===r?r=l.getSlideIndex(c.find((e=>e.classList.contains(p.slideActiveClass)))):M=r;const I="next"===i||!i,C="prev"===i||!i;let P=0,L=0;const R=(T?c[r].column:r)+(y&&void 0===n?-v/2+.5:0);if(R<b){P=Math.max(b-R,x);for(let e=0;e<b-R;e+=1){const t=e-Math.floor(e/S)*S;if(T){const e=S-t-1;for(let t=c.length-1;t>=0;t-=1)c[t].column===e&&w.push(t)}else w.push(S-t-1)}}else if(R+v>S-b){L=Math.max(R-(S-2*b),x),A&&(L=Math.max(L,v-S+_+1));for(let e=0;e<L;e+=1){const t=e-Math.floor(e/S)*S;T?c.forEach(((e,i)=>{e.column===t&&E.push(i)})):E.push(t)}}if(l.__preventObserver__=!0,requestAnimationFrame((()=>{l.__preventObserver__=!1})),"cards"===l.params.effect&&c.length<v+2*b&&(E.includes(r)&&E.splice(E.indexOf(r),1),w.includes(r)&&w.splice(w.indexOf(r),1)),C&&w.forEach((e=>{c[e].swiperLoopMoveDOM=!0,d.prepend(c[e]),c[e].swiperLoopMoveDOM=!1})),I&&E.forEach((e=>{c[e].swiperLoopMoveDOM=!0,d.append(c[e]),c[e].swiperLoopMoveDOM=!1})),l.recalcSlides(),"auto"===p.slidesPerView?l.updateSlides():T&&(w.length>0&&C||E.length>0&&I)&&l.slides.forEach(((e,t)=>{l.grid.updateSlide(t,e,l.slides)})),p.watchSlidesProgress&&l.updateSlidesOffset(),t)if(w.length>0&&C){if(void 0===e){const e=l.slidesGrid[M+P]-l.slidesGrid[M];a?l.setTranslate(l.translate-e):(l.slideTo(M+Math.ceil(P),0,!1,!0),n&&(l.touchEventsData.startTranslate=l.touchEventsData.startTranslate-e,l.touchEventsData.currentTranslate=l.touchEventsData.currentTranslate-e))}else if(n){l.slideTo(l.activeIndex+(T?w.length/p.grid.rows:w.length),0,!1,!0),l.touchEventsData.currentTranslate=l.translate}}else if(E.length>0&&I)if(void 0===e){const e=l.slidesGrid[M-L]-l.slidesGrid[M];a?l.setTranslate(l.translate-e):(l.slideTo(M-L,0,!1,!0),n&&(l.touchEventsData.startTranslate=l.touchEventsData.startTranslate-e,l.touchEventsData.currentTranslate=l.touchEventsData.currentTranslate-e))}else{l.slideTo(l.activeIndex-(T?E.length/p.grid.rows:E.length),0,!1,!0)}if(l.allowSlidePrev=u,l.allowSlideNext=h,l.controller&&l.controller.control&&!s){const o={slideRealIndex:e,direction:i,setTranslate:n,activeSlideIndex:r,byController:!0};Array.isArray(l.controller.control)?l.controller.control.forEach((e=>{!e.destroyed&&e.params.loop&&e.loopFix({...o,slideTo:e.params.slidesPerView===p.slidesPerView&&t})})):l.controller.control instanceof l.constructor&&l.controller.control.params.loop&&l.controller.control.loopFix({...o,slideTo:l.controller.control.params.slidesPerView===p.slidesPerView&&t})}l.emit("loopFix")}function loopDestroy(){const e=this,{params:t,slidesEl:i}=e;if(!t.loop||!i||e.virtual&&e.params.virtual.enabled)return;e.recalcSlides();const n=[];e.slides.forEach((e=>{const t=void 0===e.swiperSlideIndex?1*e.getAttribute("data-swiper-slide-index"):e.swiperSlideIndex;n[t]=e})),e.slides.forEach((e=>{e.removeAttribute("data-swiper-slide-index")})),n.forEach((e=>{i.append(e)})),e.recalcSlides(),e.slideTo(e.realIndex,0)}var loop={loopCreate:loopCreate,loopFix:loopFix,loopDestroy:loopDestroy};function setGrabCursor(e){const t=this;if(!t.params.simulateTouch||t.params.watchOverflow&&t.isLocked||t.params.cssMode)return;const i="container"===t.params.touchEventsTarget?t.el:t.wrapperEl;t.isElement&&(t.__preventObserver__=!0),i.style.cursor="move",i.style.cursor=e?"grabbing":"grab",t.isElement&&requestAnimationFrame((()=>{t.__preventObserver__=!1}))}function unsetGrabCursor(){const e=this;e.params.watchOverflow&&e.isLocked||e.params.cssMode||(e.isElement&&(e.__preventObserver__=!0),e["container"===e.params.touchEventsTarget?"el":"wrapperEl"].style.cursor="",e.isElement&&requestAnimationFrame((()=>{e.__preventObserver__=!1})))}var grabCursor={setGrabCursor:setGrabCursor,unsetGrabCursor:unsetGrabCursor};function closestElement(e,t=this){return function t(i){if(!i||i===getDocument()||i===getWindow())return null;i.assignedSlot&&(i=i.assignedSlot);const n=i.closest(e);return n||i.getRootNode?n||t(i.getRootNode().host):null}(t)}function preventEdgeSwipe(e,t,i){const n=getWindow(),{params:r}=e,o=r.edgeSwipeDetection,s=r.edgeSwipeThreshold;return!o||!(i<=s||i>=n.innerWidth-s)||"prevent"===o&&(t.preventDefault(),!0)}function onTouchStart(e){const t=this,i=getDocument();let n=e;n.originalEvent&&(n=n.originalEvent);const r=t.touchEventsData;if("pointerdown"===n.type){if(null!==r.pointerId&&r.pointerId!==n.pointerId)return;r.pointerId=n.pointerId}else"touchstart"===n.type&&1===n.targetTouches.length&&(r.touchId=n.targetTouches[0].identifier);if("touchstart"===n.type)return void preventEdgeSwipe(t,n,n.targetTouches[0].pageX);const{params:o,touches:s,enabled:a}=t;if(!a)return;if(!o.simulateTouch&&"mouse"===n.pointerType)return;if(t.animating&&o.preventInteractionOnTransition)return;!t.animating&&o.cssMode&&o.loop&&t.loopFix();let l=n.target;if("wrapper"===o.touchEventsTarget&&!elementIsChildOf(l,t.wrapperEl))return;if("which"in n&&3===n.which)return;if("button"in n&&n.button>0)return;if(r.isTouched&&r.isMoved)return;const c=!!o.noSwipingClass&&""!==o.noSwipingClass,u=n.composedPath?n.composedPath():n.path;c&&n.target&&n.target.shadowRoot&&u&&(l=u[0]);const h=o.noSwipingSelector?o.noSwipingSelector:`.${o.noSwipingClass}`;if(o.noSwiping&&(!(!n.target||!n.target.shadowRoot)?closestElement(h,l):l.closest(h)))return void(t.allowClick=!0);if(o.swipeHandler&&!l.closest(o.swipeHandler))return;s.currentX=n.pageX,s.currentY=n.pageY;const d=s.currentX,p=s.currentY;if(!preventEdgeSwipe(t,n,d))return;Object.assign(r,{isTouched:!0,isMoved:!1,allowTouchCallbacks:!0,isScrolling:void 0,startMoving:void 0}),s.startX=d,s.startY=p,r.touchStartTime=now(),t.allowClick=!0,t.updateSize(),t.swipeDirection=void 0,o.threshold>0&&(r.allowThresholdMove=!1);let f=!0;l.matches(r.focusableElements)&&(f=!1,"SELECT"===l.nodeName&&(r.isTouched=!1)),i.activeElement&&i.activeElement.matches(r.focusableElements)&&i.activeElement!==l&&("mouse"===n.pointerType||"mouse"!==n.pointerType&&!l.matches(r.focusableElements))&&i.activeElement.blur();!o.touchStartForcePreventDefault&&!(f&&t.allowTouchMove&&o.touchStartPreventDefault)||l.isContentEditable||n.preventDefault(),o.freeMode&&o.freeMode.enabled&&t.freeMode&&t.animating&&!o.cssMode&&t.freeMode.onTouchStart(),t.emit("touchStart",n)}function onTouchMove(e){const t=getDocument(),i=this,n=i.touchEventsData,{params:r,touches:o,rtlTranslate:s,enabled:a}=i;if(!a)return;if(!r.simulateTouch&&"mouse"===e.pointerType)return;let l,c=e;if(c.originalEvent&&(c=c.originalEvent),"pointermove"===c.type){if(null!==n.touchId)return;if(c.pointerId!==n.pointerId)return}if("touchmove"===c.type){if(l=[...c.changedTouches].find((e=>e.identifier===n.touchId)),!l||l.identifier!==n.touchId)return}else l=c;if(!n.isTouched)return void(n.startMoving&&n.isScrolling&&i.emit("touchMoveOpposite",c));const u=l.pageX,h=l.pageY;if(c.preventedByNestedSwiper)return o.startX=u,void(o.startY=h);if(!i.allowTouchMove)return c.target.matches(n.focusableElements)||(i.allowClick=!1),void(n.isTouched&&(Object.assign(o,{startX:u,startY:h,currentX:u,currentY:h}),n.touchStartTime=now()));if(r.touchReleaseOnEdges&&!r.loop)if(i.isVertical()){if(h<o.startY&&i.translate<=i.maxTranslate()||h>o.startY&&i.translate>=i.minTranslate())return n.isTouched=!1,void(n.isMoved=!1)}else{if(s&&(u>o.startX&&-i.translate<=i.maxTranslate()||u<o.startX&&-i.translate>=i.minTranslate()))return;if(!s&&(u<o.startX&&i.translate<=i.maxTranslate()||u>o.startX&&i.translate>=i.minTranslate()))return}if(t.activeElement&&t.activeElement.matches(n.focusableElements)&&t.activeElement!==c.target&&"mouse"!==c.pointerType&&t.activeElement.blur(),t.activeElement&&c.target===t.activeElement&&c.target.matches(n.focusableElements))return n.isMoved=!0,void(i.allowClick=!1);n.allowTouchCallbacks&&i.emit("touchMove",c),o.previousX=o.currentX,o.previousY=o.currentY,o.currentX=u,o.currentY=h;const d=o.currentX-o.startX,p=o.currentY-o.startY;if(i.params.threshold&&Math.sqrt(d**2+p**2)<i.params.threshold)return;if(void 0===n.isScrolling){let e;i.isHorizontal()&&o.currentY===o.startY||i.isVertical()&&o.currentX===o.startX?n.isScrolling=!1:d*d+p*p>=25&&(e=180*Math.atan2(Math.abs(p),Math.abs(d))/Math.PI,n.isScrolling=i.isHorizontal()?e>r.touchAngle:90-e>r.touchAngle)}if(n.isScrolling&&i.emit("touchMoveOpposite",c),void 0===n.startMoving&&(o.currentX===o.startX&&o.currentY===o.startY||(n.startMoving=!0)),n.isScrolling||"touchmove"===c.type&&n.preventTouchMoveFromPointerMove)return void(n.isTouched=!1);if(!n.startMoving)return;i.allowClick=!1,!r.cssMode&&c.cancelable&&c.preventDefault(),r.touchMoveStopPropagation&&!r.nested&&c.stopPropagation();let f=i.isHorizontal()?d:p,m=i.isHorizontal()?o.currentX-o.previousX:o.currentY-o.previousY;r.oneWayMovement&&(f=Math.abs(f)*(s?1:-1),m=Math.abs(m)*(s?1:-1)),o.diff=f,f*=r.touchRatio,s&&(f=-f,m=-m);const g=i.touchesDirection;i.swipeDirection=f>0?"prev":"next",i.touchesDirection=m>0?"prev":"next";const _=i.params.loop&&!r.cssMode,y="next"===i.touchesDirection&&i.allowSlideNext||"prev"===i.touchesDirection&&i.allowSlidePrev;if(!n.isMoved){if(_&&y&&i.loopFix({direction:i.swipeDirection}),n.startTranslate=i.getTranslate(),i.setTransition(0),i.animating){const e=new window.CustomEvent("transitionend",{bubbles:!0,cancelable:!0,detail:{bySwiperTouchMove:!0}});i.wrapperEl.dispatchEvent(e)}n.allowMomentumBounce=!1,!r.grabCursor||!0!==i.allowSlideNext&&!0!==i.allowSlidePrev||i.setGrabCursor(!0),i.emit("sliderFirstMove",c)}if((new Date).getTime(),!1!==r._loopSwapReset&&n.isMoved&&n.allowThresholdMove&&g!==i.touchesDirection&&_&&y&&Math.abs(f)>=1)return Object.assign(o,{startX:u,startY:h,currentX:u,currentY:h,startTranslate:n.currentTranslate}),n.loopSwapReset=!0,void(n.startTranslate=n.currentTranslate);i.emit("sliderMove",c),n.isMoved=!0,n.currentTranslate=f+n.startTranslate;let v=!0,x=r.resistanceRatio;if(r.touchReleaseOnEdges&&(x=0),f>0?(_&&y&&n.allowThresholdMove&&n.currentTranslate>(r.centeredSlides?i.minTranslate()-i.slidesSizesGrid[i.activeIndex+1]-("auto"!==r.slidesPerView&&i.slides.length-r.slidesPerView>=2?i.slidesSizesGrid[i.activeIndex+1]+i.params.spaceBetween:0)-i.params.spaceBetween:i.minTranslate())&&i.loopFix({direction:"prev",setTranslate:!0,activeSlideIndex:0}),n.currentTranslate>i.minTranslate()&&(v=!1,r.resistance&&(n.currentTranslate=i.minTranslate()-1+(-i.minTranslate()+n.startTranslate+f)**x))):f<0&&(_&&y&&n.allowThresholdMove&&n.currentTranslate<(r.centeredSlides?i.maxTranslate()+i.slidesSizesGrid[i.slidesSizesGrid.length-1]+i.params.spaceBetween+("auto"!==r.slidesPerView&&i.slides.length-r.slidesPerView>=2?i.slidesSizesGrid[i.slidesSizesGrid.length-1]+i.params.spaceBetween:0):i.maxTranslate())&&i.loopFix({direction:"next",setTranslate:!0,activeSlideIndex:i.slides.length-("auto"===r.slidesPerView?i.slidesPerViewDynamic():Math.ceil(parseFloat(r.slidesPerView,10)))}),n.currentTranslate<i.maxTranslate()&&(v=!1,r.resistance&&(n.currentTranslate=i.maxTranslate()+1-(i.maxTranslate()-n.startTranslate-f)**x))),v&&(c.preventedByNestedSwiper=!0),!i.allowSlideNext&&"next"===i.swipeDirection&&n.currentTranslate<n.startTranslate&&(n.currentTranslate=n.startTranslate),!i.allowSlidePrev&&"prev"===i.swipeDirection&&n.currentTranslate>n.startTranslate&&(n.currentTranslate=n.startTranslate),i.allowSlidePrev||i.allowSlideNext||(n.currentTranslate=n.startTranslate),r.threshold>0){if(!(Math.abs(f)>r.threshold||n.allowThresholdMove))return void(n.currentTranslate=n.startTranslate);if(!n.allowThresholdMove)return n.allowThresholdMove=!0,o.startX=o.currentX,o.startY=o.currentY,n.currentTranslate=n.startTranslate,void(o.diff=i.isHorizontal()?o.currentX-o.startX:o.currentY-o.startY)}r.followFinger&&!r.cssMode&&((r.freeMode&&r.freeMode.enabled&&i.freeMode||r.watchSlidesProgress)&&(i.updateActiveIndex(),i.updateSlidesClasses()),r.freeMode&&r.freeMode.enabled&&i.freeMode&&i.freeMode.onTouchMove(),i.updateProgress(n.currentTranslate),i.setTranslate(n.currentTranslate))}function onTouchEnd(e){const t=this,i=t.touchEventsData;let n,r=e;r.originalEvent&&(r=r.originalEvent);if("touchend"===r.type||"touchcancel"===r.type){if(n=[...r.changedTouches].find((e=>e.identifier===i.touchId)),!n||n.identifier!==i.touchId)return}else{if(null!==i.touchId)return;if(r.pointerId!==i.pointerId)return;n=r}if(["pointercancel","pointerout","pointerleave","contextmenu"].includes(r.type)){if(!(["pointercancel","contextmenu"].includes(r.type)&&(t.browser.isSafari||t.browser.isWebView)))return}i.pointerId=null,i.touchId=null;const{params:o,touches:s,rtlTranslate:a,slidesGrid:l,enabled:c}=t;if(!c)return;if(!o.simulateTouch&&"mouse"===r.pointerType)return;if(i.allowTouchCallbacks&&t.emit("touchEnd",r),i.allowTouchCallbacks=!1,!i.isTouched)return i.isMoved&&o.grabCursor&&t.setGrabCursor(!1),i.isMoved=!1,void(i.startMoving=!1);o.grabCursor&&i.isMoved&&i.isTouched&&(!0===t.allowSlideNext||!0===t.allowSlidePrev)&&t.setGrabCursor(!1);const u=now(),h=u-i.touchStartTime;if(t.allowClick){const e=r.path||r.composedPath&&r.composedPath();t.updateClickedSlide(e&&e[0]||r.target,e),t.emit("tap click",r),h<300&&u-i.lastClickTime<300&&t.emit("doubleTap doubleClick",r)}if(i.lastClickTime=now(),nextTick((()=>{t.destroyed||(t.allowClick=!0)})),!i.isTouched||!i.isMoved||!t.swipeDirection||0===s.diff&&!i.loopSwapReset||i.currentTranslate===i.startTranslate&&!i.loopSwapReset)return i.isTouched=!1,i.isMoved=!1,void(i.startMoving=!1);let d;if(i.isTouched=!1,i.isMoved=!1,i.startMoving=!1,d=o.followFinger?a?t.translate:-t.translate:-i.currentTranslate,o.cssMode)return;if(o.freeMode&&o.freeMode.enabled)return void t.freeMode.onTouchEnd({currentPos:d});const p=d>=-t.maxTranslate()&&!t.params.loop;let f=0,m=t.slidesSizesGrid[0];for(let e=0;e<l.length;e+=e<o.slidesPerGroupSkip?1:o.slidesPerGroup){const t=e<o.slidesPerGroupSkip-1?1:o.slidesPerGroup;void 0!==l[e+t]?(p||d>=l[e]&&d<l[e+t])&&(f=e,m=l[e+t]-l[e]):(p||d>=l[e])&&(f=e,m=l[l.length-1]-l[l.length-2])}let g=null,_=null;o.rewind&&(t.isBeginning?_=o.virtual&&o.virtual.enabled&&t.virtual?t.virtual.slides.length-1:t.slides.length-1:t.isEnd&&(g=0));const y=(d-l[f])/m,v=f<o.slidesPerGroupSkip-1?1:o.slidesPerGroup;if(h>o.longSwipesMs){if(!o.longSwipes)return void t.slideTo(t.activeIndex);"next"===t.swipeDirection&&t.slideTo(y>=o.longSwipesRatio?o.rewind&&t.isEnd?g:f+v:f),"prev"===t.swipeDirection&&(y>1-o.longSwipesRatio?t.slideTo(f+v):null!==_&&y<0&&Math.abs(y)>o.longSwipesRatio?t.slideTo(_):t.slideTo(f))}else{if(!o.shortSwipes)return void t.slideTo(t.activeIndex);t.navigation&&(r.target===t.navigation.nextEl||r.target===t.navigation.prevEl)?t.slideTo(r.target===t.navigation.nextEl?f+v:f):("next"===t.swipeDirection&&t.slideTo(null!==g?g:f+v),"prev"===t.swipeDirection&&t.slideTo(null!==_?_:f))}}function onResize(){const e=this,{params:t,el:i}=e;if(i&&0===i.offsetWidth)return;t.breakpoints&&e.setBreakpoint();const{allowSlideNext:n,allowSlidePrev:r,snapGrid:o}=e,s=e.virtual&&e.params.virtual.enabled;e.allowSlideNext=!0,e.allowSlidePrev=!0,e.updateSize(),e.updateSlides(),e.updateSlidesClasses();!("auto"===t.slidesPerView||t.slidesPerView>1)||!e.isEnd||e.isBeginning||e.params.centeredSlides||s&&t.loop?e.params.loop&&!s?e.slideToLoop(e.realIndex,0,!1,!0):e.slideTo(e.activeIndex,0,!1,!0):e.slideTo(e.slides.length-1,0,!1,!0),e.autoplay&&e.autoplay.running&&e.autoplay.paused&&(clearTimeout(e.autoplay.resizeTimeout),e.autoplay.resizeTimeout=setTimeout((()=>{e.autoplay&&e.autoplay.running&&e.autoplay.paused&&e.autoplay.resume()}),500)),e.allowSlidePrev=r,e.allowSlideNext=n,e.params.watchOverflow&&o!==e.snapGrid&&e.checkOverflow()}function onClick(e){const t=this;t.enabled&&(t.allowClick||(t.params.preventClicks&&e.preventDefault(),t.params.preventClicksPropagation&&t.animating&&(e.stopPropagation(),e.stopImmediatePropagation())))}function onScroll(){const e=this,{wrapperEl:t,rtlTranslate:i,enabled:n}=e;if(!n)return;let r;e.previousTranslate=e.translate,e.translate=e.isHorizontal()?-t.scrollLeft:-t.scrollTop,0===e.translate&&(e.translate=0),e.updateActiveIndex(),e.updateSlidesClasses();const o=e.maxTranslate()-e.minTranslate();r=0===o?0:(e.translate-e.minTranslate())/o,r!==e.progress&&e.updateProgress(i?-e.translate:e.translate),e.emit("setTranslate",e.translate,!1)}function onLoad(e){const t=this;processLazyPreloader(t,e.target),t.params.cssMode||"auto"!==t.params.slidesPerView&&!t.params.autoHeight||t.update()}function onDocumentTouchStart(){const e=this;e.documentTouchHandlerProceeded||(e.documentTouchHandlerProceeded=!0,e.params.touchReleaseOnEdges&&(e.el.style.touchAction="auto"))}const events=(e,t)=>{const i=getDocument(),{params:n,el:r,wrapperEl:o,device:s}=e,a=!!n.nested,l="on"===t?"addEventListener":"removeEventListener",c=t;r&&"string"!=typeof r&&(i[l]("touchstart",e.onDocumentTouchStart,{passive:!1,capture:a}),r[l]("touchstart",e.onTouchStart,{passive:!1}),r[l]("pointerdown",e.onTouchStart,{passive:!1}),i[l]("touchmove",e.onTouchMove,{passive:!1,capture:a}),i[l]("pointermove",e.onTouchMove,{passive:!1,capture:a}),i[l]("touchend",e.onTouchEnd,{passive:!0}),i[l]("pointerup",e.onTouchEnd,{passive:!0}),i[l]("pointercancel",e.onTouchEnd,{passive:!0}),i[l]("touchcancel",e.onTouchEnd,{passive:!0}),i[l]("pointerout",e.onTouchEnd,{passive:!0}),i[l]("pointerleave",e.onTouchEnd,{passive:!0}),i[l]("contextmenu",e.onTouchEnd,{passive:!0}),(n.preventClicks||n.preventClicksPropagation)&&r[l]("click",e.onClick,!0),n.cssMode&&o[l]("scroll",e.onScroll),e[c](n.updateOnWindowResize?s.ios||s.android?"resize orientationchange observerUpdate":"resize observerUpdate":"observerUpdate",onResize,!0),r[l]("load",e.onLoad,{capture:!0}))};function attachEvents(){const e=this,{params:t}=e;e.onTouchStart=onTouchStart.bind(e),e.onTouchMove=onTouchMove.bind(e),e.onTouchEnd=onTouchEnd.bind(e),e.onDocumentTouchStart=onDocumentTouchStart.bind(e),t.cssMode&&(e.onScroll=onScroll.bind(e)),e.onClick=onClick.bind(e),e.onLoad=onLoad.bind(e),events(e,"on")}function detachEvents(){events(this,"off")}var events$1={attachEvents:attachEvents,detachEvents:detachEvents};const isGridEnabled=(e,t)=>e.grid&&t.grid&&t.grid.rows>1;function setBreakpoint(){const e=this,{realIndex:t,initialized:i,params:n,el:r}=e,o=n.breakpoints;if(!o||o&&0===Object.keys(o).length)return;const s=getDocument(),a="window"!==n.breakpointsBase&&n.breakpointsBase?"container":n.breakpointsBase,l=["window","container"].includes(n.breakpointsBase)||!n.breakpointsBase?e.el:s.querySelector(n.breakpointsBase),c=e.getBreakpoint(o,a,l);if(!c||e.currentBreakpoint===c)return;const u=(c in o?o[c]:void 0)||e.originalParams,h=isGridEnabled(e,n),d=isGridEnabled(e,u),p=e.params.grabCursor,f=u.grabCursor,m=n.enabled;h&&!d?(r.classList.remove(`${n.containerModifierClass}grid`,`${n.containerModifierClass}grid-column`),e.emitContainerClasses()):!h&&d&&(r.classList.add(`${n.containerModifierClass}grid`),(u.grid.fill&&"column"===u.grid.fill||!u.grid.fill&&"column"===n.grid.fill)&&r.classList.add(`${n.containerModifierClass}grid-column`),e.emitContainerClasses()),p&&!f?e.unsetGrabCursor():!p&&f&&e.setGrabCursor(),["navigation","pagination","scrollbar"].forEach((t=>{if(void 0===u[t])return;const i=n[t]&&n[t].enabled,r=u[t]&&u[t].enabled;i&&!r&&e[t].disable(),!i&&r&&e[t].enable()}));const g=u.direction&&u.direction!==n.direction,_=n.loop&&(u.slidesPerView!==n.slidesPerView||g),y=n.loop;g&&i&&e.changeDirection(),extend$1(e.params,u);const v=e.params.enabled,x=e.params.loop;Object.assign(e,{allowTouchMove:e.params.allowTouchMove,allowSlideNext:e.params.allowSlideNext,allowSlidePrev:e.params.allowSlidePrev}),m&&!v?e.disable():!m&&v&&e.enable(),e.currentBreakpoint=c,e.emit("_beforeBreakpoint",u),i&&(_?(e.loopDestroy(),e.loopCreate(t),e.updateSlides()):!y&&x?(e.loopCreate(t),e.updateSlides()):y&&!x&&e.loopDestroy()),e.emit("breakpoint",u)}function getBreakpoint(e,t="window",i){if(!e||"container"===t&&!i)return;let n=!1;const r=getWindow(),o="window"===t?r.innerHeight:i.clientHeight,s=Object.keys(e).map((e=>{if("string"==typeof e&&0===e.indexOf("@")){const t=parseFloat(e.substr(1));return{value:o*t,point:e}}return{value:e,point:e}}));s.sort(((e,t)=>parseInt(e.value,10)-parseInt(t.value,10)));for(let e=0;e<s.length;e+=1){const{point:o,value:a}=s[e];"window"===t?r.matchMedia(`(min-width: ${a}px)`).matches&&(n=o):a<=i.clientWidth&&(n=o)}return n||"max"}var breakpoints={setBreakpoint:setBreakpoint,getBreakpoint:getBreakpoint};function prepareClasses(e,t){const i=[];return e.forEach((e=>{"object"==typeof e?Object.keys(e).forEach((n=>{e[n]&&i.push(t+n)})):"string"==typeof e&&i.push(t+e)})),i}function addClasses(){const e=this,{classNames:t,params:i,rtl:n,el:r,device:o}=e,s=prepareClasses(["initialized",i.direction,{"free-mode":e.params.freeMode&&i.freeMode.enabled},{autoheight:i.autoHeight},{rtl:n},{grid:i.grid&&i.grid.rows>1},{"grid-column":i.grid&&i.grid.rows>1&&"column"===i.grid.fill},{android:o.android},{ios:o.ios},{"css-mode":i.cssMode},{centered:i.cssMode&&i.centeredSlides},{"watch-progress":i.watchSlidesProgress}],i.containerModifierClass);t.push(...s),r.classList.add(...t),e.emitContainerClasses()}function removeClasses(){const{el:e,classNames:t}=this;e&&"string"!=typeof e&&(e.classList.remove(...t),this.emitContainerClasses())}var classes={addClasses:addClasses,removeClasses:removeClasses};function checkOverflow(){const e=this,{isLocked:t,params:i}=e,{slidesOffsetBefore:n}=i;if(n){const t=e.slides.length-1;e.isLocked=e.size>e.slidesGrid[t]+e.slidesSizesGrid[t]+2*n}else e.isLocked=1===e.snapGrid.length;!0===i.allowSlideNext&&(e.allowSlideNext=!e.isLocked),!0===i.allowSlidePrev&&(e.allowSlidePrev=!e.isLocked),t&&t!==e.isLocked&&(e.isEnd=!1),t!==e.isLocked&&e.emit(e.isLocked?"lock":"unlock")}var checkOverflow$1={checkOverflow:checkOverflow},defaults={init:!0,direction:"horizontal",oneWayMovement:!1,swiperElementNodeName:"SWIPER-CONTAINER",touchEventsTarget:"wrapper",initialSlide:0,speed:300,cssMode:!1,updateOnWindowResize:!0,resizeObserver:!0,nested:!1,createElements:!1,eventsPrefix:"swiper",enabled:!0,focusableElements:"input, select, option, textarea, button, video, label",width:null,height:null,preventInteractionOnTransition:!1,userAgent:null,url:null,edgeSwipeDetection:!1,edgeSwipeThreshold:20,autoHeight:!1,setWrapperSize:!1,virtualTranslate:!1,effect:"slide",breakpoints:void 0,breakpointsBase:"window",spaceBetween:0,slidesPerView:1,slidesPerGroup:1,slidesPerGroupSkip:0,slidesPerGroupAuto:!1,centeredSlides:!1,centeredSlidesBounds:!1,slidesOffsetBefore:0,slidesOffsetAfter:0,normalizeSlideIndex:!0,centerInsufficientSlides:!1,snapToSlideEdge:!1,watchOverflow:!0,roundLengths:!1,touchRatio:1,touchAngle:45,simulateTouch:!0,shortSwipes:!0,longSwipes:!0,longSwipesRatio:.5,longSwipesMs:300,followFinger:!0,allowTouchMove:!0,threshold:5,touchMoveStopPropagation:!1,touchStartPreventDefault:!0,touchStartForcePreventDefault:!1,touchReleaseOnEdges:!1,uniqueNavElements:!0,resistance:!0,resistanceRatio:.85,watchSlidesProgress:!1,grabCursor:!1,preventClicks:!0,preventClicksPropagation:!0,slideToClickedSlide:!1,loop:!1,loopAddBlankSlides:!0,loopAdditionalSlides:0,loopPreventsSliding:!0,rewind:!1,allowSlidePrev:!0,allowSlideNext:!0,swipeHandler:null,noSwiping:!0,noSwipingClass:"swiper-no-swiping",noSwipingSelector:null,passiveListeners:!0,maxBackfaceHiddenSlides:10,containerModifierClass:"swiper-",slideClass:"swiper-slide",slideBlankClass:"swiper-slide-blank",slideActiveClass:"swiper-slide-active",slideVisibleClass:"swiper-slide-visible",slideFullyVisibleClass:"swiper-slide-fully-visible",slideNextClass:"swiper-slide-next",slidePrevClass:"swiper-slide-prev",wrapperClass:"swiper-wrapper",lazyPreloaderClass:"swiper-lazy-preloader",lazyPreloadPrevNext:0,runCallbacksOnInit:!0,_emitClasses:!1};function moduleExtendParams(e,t){return function(i={}){const n=Object.keys(i)[0],r=i[n];"object"==typeof r&&null!==r?(!0===e[n]&&(e[n]={enabled:!0}),"navigation"===n&&e[n]&&e[n].enabled&&!e[n].prevEl&&!e[n].nextEl&&(e[n].auto=!0),["pagination","scrollbar"].indexOf(n)>=0&&e[n]&&e[n].enabled&&!e[n].el&&(e[n].auto=!0),n in e&&"enabled"in r?("object"!=typeof e[n]||"enabled"in e[n]||(e[n].enabled=!0),e[n]||(e[n]={enabled:!1}),extend$1(t,i)):extend$1(t,i)):extend$1(t,i)}}const prototypes={eventsEmitter:eventsEmitter,update:update,translate:translate,transition:transition,slide:slide,loop:loop,grabCursor:grabCursor,events:events$1,breakpoints:breakpoints,checkOverflow:checkOverflow$1,classes:classes},extendedDefaults={};class Swiper{constructor(...e){let t,i;1===e.length&&e[0].constructor&&"Object"===Object.prototype.toString.call(e[0]).slice(8,-1)?i=e[0]:[t,i]=e,i||(i={}),i=extend$1({},i),t&&!i.el&&(i.el=t);const n=getDocument();if(i.el&&"string"==typeof i.el&&n.querySelectorAll(i.el).length>1){const e=[];return n.querySelectorAll(i.el).forEach((t=>{const n=extend$1({},i,{el:t});e.push(new Swiper(n))})),e}const r=this;r.__swiper__=!0,r.support=getSupport(),r.device=getDevice({userAgent:i.userAgent}),r.browser=getBrowser(),r.eventsListeners={},r.eventsAnyListeners=[],r.modules=[...r.__modules__],i.modules&&Array.isArray(i.modules)&&r.modules.push(...i.modules);const o={};r.modules.forEach((e=>{e({params:i,swiper:r,extendParams:moduleExtendParams(i,o),on:r.on.bind(r),once:r.once.bind(r),off:r.off.bind(r),emit:r.emit.bind(r)})}));const s=extend$1({},defaults,o);return r.params=extend$1({},s,extendedDefaults,i),r.originalParams=extend$1({},r.params),r.passedParams=extend$1({},i),r.params&&r.params.on&&Object.keys(r.params.on).forEach((e=>{r.on(e,r.params.on[e])})),r.params&&r.params.onAny&&r.onAny(r.params.onAny),Object.assign(r,{enabled:r.params.enabled,el:t,classNames:[],slides:[],slidesGrid:[],snapGrid:[],slidesSizesGrid:[],isHorizontal:()=>"horizontal"===r.params.direction,isVertical:()=>"vertical"===r.params.direction,activeIndex:0,realIndex:0,isBeginning:!0,isEnd:!1,translate:0,previousTranslate:0,progress:0,velocity:0,animating:!1,cssOverflowAdjustment(){return Math.trunc(this.translate/2**23)*2**23},allowSlideNext:r.params.allowSlideNext,allowSlidePrev:r.params.allowSlidePrev,touchEventsData:{isTouched:void 0,isMoved:void 0,allowTouchCallbacks:void 0,touchStartTime:void 0,isScrolling:void 0,currentTranslate:void 0,startTranslate:void 0,allowThresholdMove:void 0,focusableElements:r.params.focusableElements,lastClickTime:0,clickTimeout:void 0,velocities:[],allowMomentumBounce:void 0,startMoving:void 0,pointerId:null,touchId:null},allowClick:!0,allowTouchMove:r.params.allowTouchMove,touches:{startX:0,startY:0,currentX:0,currentY:0,diff:0},imagesToLoad:[],imagesLoaded:0}),r.emit("_swiper"),r.params.init&&r.init(),r}getDirectionLabel(e){return this.isHorizontal()?e:{width:"height","margin-top":"margin-left","margin-bottom ":"margin-right","margin-left":"margin-top","margin-right":"margin-bottom","padding-left":"padding-top","padding-right":"padding-bottom",marginRight:"marginBottom"}[e]}getSlideIndex(e){const{slidesEl:t,params:i}=this,n=elementIndex(elementChildren(t,`.${i.slideClass}, swiper-slide`)[0]);return elementIndex(e)-n}getSlideIndexByData(e){return this.getSlideIndex(this.slides.find((t=>1*t.getAttribute("data-swiper-slide-index")===e)))}getSlideIndexWhenGrid(e){return this.grid&&this.params.grid&&this.params.grid.rows>1&&("column"===this.params.grid.fill?e=Math.floor(e/this.params.grid.rows):"row"===this.params.grid.fill&&(e%=Math.ceil(this.slides.length/this.params.grid.rows))),e}recalcSlides(){const{slidesEl:e,params:t}=this;this.slides=elementChildren(e,`.${t.slideClass}, swiper-slide`)}enable(){const e=this;e.enabled||(e.enabled=!0,e.params.grabCursor&&e.setGrabCursor(),e.emit("enable"))}disable(){const e=this;e.enabled&&(e.enabled=!1,e.params.grabCursor&&e.unsetGrabCursor(),e.emit("disable"))}setProgress(e,t){const i=this;e=Math.min(Math.max(e,0),1);const n=i.minTranslate(),r=i.maxTranslate();i.translateTo((r-n)*e+n,void 0===t?0:t),i.updateActiveIndex(),i.updateSlidesClasses()}emitContainerClasses(){const e=this;if(!e.params._emitClasses||!e.el)return;const t=e.el.className.split(" ").filter((t=>0===t.indexOf("swiper")||0===t.indexOf(e.params.containerModifierClass)));e.emit("_containerClasses",t.join(" "))}getSlideClasses(e){const t=this;return t.destroyed?"":e.className.split(" ").filter((e=>0===e.indexOf("swiper-slide")||0===e.indexOf(t.params.slideClass))).join(" ")}emitSlidesClasses(){const e=this;if(!e.params._emitClasses||!e.el)return;const t=[];e.slides.forEach((i=>{const n=e.getSlideClasses(i);t.push({slideEl:i,classNames:n}),e.emit("_slideClass",i,n)})),e.emit("_slideClasses",t)}slidesPerViewDynamic(e="current",t=!1){const{params:i,slides:n,slidesGrid:r,slidesSizesGrid:o,size:s,activeIndex:a}=this;let l=1;if("number"==typeof i.slidesPerView)return i.slidesPerView;if(i.centeredSlides){let e,t=n[a]?Math.ceil(n[a].swiperSlideSize):0;for(let i=a+1;i<n.length;i+=1)n[i]&&!e&&(t+=Math.ceil(n[i].swiperSlideSize),l+=1,t>s&&(e=!0));for(let i=a-1;i>=0;i-=1)n[i]&&!e&&(t+=n[i].swiperSlideSize,l+=1,t>s&&(e=!0))}else if("current"===e)for(let e=a+1;e<n.length;e+=1){(t?r[e]+o[e]-r[a]<s:r[e]-r[a]<s)&&(l+=1)}else for(let e=a-1;e>=0;e-=1){r[a]-r[e]<s&&(l+=1)}return l}update(){const e=this;if(!e||e.destroyed)return;const{snapGrid:t,params:i}=e;function n(){const t=Math.min(Math.max(e.rtlTranslate?-1*e.translate:e.translate,e.maxTranslate()),e.minTranslate());e.setTranslate(t),e.updateActiveIndex(),e.updateSlidesClasses()}let r;if(i.breakpoints&&e.setBreakpoint(),[...e.el.querySelectorAll('[loading="lazy"]')].forEach((t=>{t.complete&&processLazyPreloader(e,t)})),e.updateSize(),e.updateSlides(),e.updateProgress(),e.updateSlidesClasses(),i.freeMode&&i.freeMode.enabled&&!i.cssMode)n(),i.autoHeight&&e.updateAutoHeight();else{if(("auto"===i.slidesPerView||i.slidesPerView>1)&&e.isEnd&&!i.centeredSlides){r=e.slideTo((e.virtual&&i.virtual.enabled?e.virtual.slides:e.slides).length-1,0,!1,!0)}else r=e.slideTo(e.activeIndex,0,!1,!0);r||n()}i.watchOverflow&&t!==e.snapGrid&&e.checkOverflow(),e.emit("update")}changeDirection(e,t=!0){const i=this,n=i.params.direction;return e||(e="horizontal"===n?"vertical":"horizontal"),e===n||"horizontal"!==e&&"vertical"!==e||(i.el.classList.remove(`${i.params.containerModifierClass}${n}`),i.el.classList.add(`${i.params.containerModifierClass}${e}`),i.emitContainerClasses(),i.params.direction=e,i.slides.forEach((t=>{"vertical"===e?t.style.width="":t.style.height=""})),i.emit("changeDirection"),t&&i.update()),i}changeLanguageDirection(e){const t=this;t.rtl&&"rtl"===e||!t.rtl&&"ltr"===e||(t.rtl="rtl"===e,t.rtlTranslate="horizontal"===t.params.direction&&t.rtl,t.rtl?(t.el.classList.add(`${t.params.containerModifierClass}rtl`),t.el.dir="rtl"):(t.el.classList.remove(`${t.params.containerModifierClass}rtl`),t.el.dir="ltr"),t.update())}mount(e){const t=this;if(t.mounted)return!0;let i=e||t.params.el;if("string"==typeof i&&(i=document.querySelector(i)),!i)return!1;i.swiper=t,i.parentNode&&i.parentNode.host&&i.parentNode.host.nodeName===t.params.swiperElementNodeName.toUpperCase()&&(t.isElement=!0);const n=()=>`.${(t.params.wrapperClass||"").trim().split(" ").join(".")}`;let r=(()=>{if(i&&i.shadowRoot&&i.shadowRoot.querySelector){return i.shadowRoot.querySelector(n())}return elementChildren(i,n())[0]})();return!r&&t.params.createElements&&(r=createElement("div",t.params.wrapperClass),i.append(r),elementChildren(i,`.${t.params.slideClass}`).forEach((e=>{r.append(e)}))),Object.assign(t,{el:i,wrapperEl:r,slidesEl:t.isElement&&!i.parentNode.host.slideSlots?i.parentNode.host:r,hostEl:t.isElement?i.parentNode.host:i,mounted:!0,rtl:"rtl"===i.dir.toLowerCase()||"rtl"===elementStyle(i,"direction"),rtlTranslate:"horizontal"===t.params.direction&&("rtl"===i.dir.toLowerCase()||"rtl"===elementStyle(i,"direction")),wrongRTL:"-webkit-box"===elementStyle(r,"display")}),!0}init(e){const t=this;if(t.initialized)return t;if(!1===t.mount(e))return t;t.emit("beforeInit"),t.params.breakpoints&&t.setBreakpoint(),t.addClasses(),t.updateSize(),t.updateSlides(),t.params.watchOverflow&&t.checkOverflow(),t.params.grabCursor&&t.enabled&&t.setGrabCursor(),t.slideTo(t.params.loop&&t.virtual&&t.params.virtual.enabled?t.params.initialSlide+t.virtual.slidesBefore:t.params.initialSlide,0,t.params.runCallbacksOnInit,!1,!0),t.params.loop&&t.loopCreate(void 0,!0),t.attachEvents();const i=[...t.el.querySelectorAll('[loading="lazy"]')];return t.isElement&&i.push(...t.hostEl.querySelectorAll('[loading="lazy"]')),i.forEach((e=>{e.complete?processLazyPreloader(t,e):e.addEventListener("load",(e=>{processLazyPreloader(t,e.target)}))})),preload(t),t.initialized=!0,preload(t),t.emit("init"),t.emit("afterInit"),t}destroy(e=!0,t=!0){const i=this,{params:n,el:r,wrapperEl:o,slides:s}=i;return void 0===i.params||i.destroyed||(i.emit("beforeDestroy"),i.initialized=!1,i.detachEvents(),n.loop&&i.loopDestroy(),t&&(i.removeClasses(),r&&"string"!=typeof r&&r.removeAttribute("style"),o&&o.removeAttribute("style"),s&&s.length&&s.forEach((e=>{e.classList.remove(n.slideVisibleClass,n.slideFullyVisibleClass,n.slideActiveClass,n.slideNextClass,n.slidePrevClass),e.removeAttribute("style"),e.removeAttribute("data-swiper-slide-index")}))),i.emit("destroy"),Object.keys(i.eventsListeners).forEach((e=>{i.off(e)})),!1!==e&&(i.el&&"string"!=typeof i.el&&(i.el.swiper=null),deleteProps(i)),i.destroyed=!0),null}static extendDefaults(e){extend$1(extendedDefaults,e)}static get extendedDefaults(){return extendedDefaults}static get defaults(){return defaults}static installModule(e){Swiper.prototype.__modules__||(Swiper.prototype.__modules__=[]);const t=Swiper.prototype.__modules__;"function"==typeof e&&t.indexOf(e)<0&&t.push(e)}static use(e){return Array.isArray(e)?(e.forEach((e=>Swiper.installModule(e))),Swiper):(Swiper.installModule(e),Swiper)}}function createElementIfNotDefined(e,t,i,n){return e.params.createElements&&Object.keys(n).forEach((r=>{if(!i[r]&&!0===i.auto){let o=elementChildren(e.el,`.${n[r]}`)[0];o||(o=createElement("div",n[r]),o.className=n[r],e.el.append(o)),i[r]=o,t[r]=o}})),i}function classesToSelector(e=""){return`.${e.trim().replace(/([\.:!+\/()[\]#>~*^$|=,'"@{}\\])/g,"\\$1").replace(/ /g,".")}`}function Pagination({swiper:e,extendParams:t,on:i,emit:n}){const r="swiper-pagination";let o;t({pagination:{el:null,bulletElement:"span",clickable:!1,hideOnClick:!1,renderBullet:null,renderProgressbar:null,renderFraction:null,renderCustom:null,progressbarOpposite:!1,type:"bullets",dynamicBullets:!1,dynamicMainBullets:1,formatFractionCurrent:e=>e,formatFractionTotal:e=>e,bulletClass:`${r}-bullet`,bulletActiveClass:`${r}-bullet-active`,modifierClass:`${r}-`,currentClass:`${r}-current`,totalClass:`${r}-total`,hiddenClass:`${r}-hidden`,progressbarFillClass:`${r}-progressbar-fill`,progressbarOppositeClass:`${r}-progressbar-opposite`,clickableClass:`${r}-clickable`,lockClass:`${r}-lock`,horizontalClass:`${r}-horizontal`,verticalClass:`${r}-vertical`,paginationDisabledClass:`${r}-disabled`}}),e.pagination={el:null,bullets:[]};let s=0;function a(){return!e.params.pagination.el||!e.pagination.el||Array.isArray(e.pagination.el)&&0===e.pagination.el.length}function l(t,i){const{bulletActiveClass:n}=e.params.pagination;t&&(t=t[("prev"===i?"previous":"next")+"ElementSibling"])&&(t.classList.add(`${n}-${i}`),(t=t[("prev"===i?"previous":"next")+"ElementSibling"])&&t.classList.add(`${n}-${i}-${i}`))}function c(t){const i=t.target.closest(classesToSelector(e.params.pagination.bulletClass));if(!i)return;t.preventDefault();const n=elementIndex(i)*e.params.slidesPerGroup;if(e.params.loop){if(e.realIndex===n)return;const t=function(e,t,i){return(t%=i)==1+(e%=i)?"next":t===e-1?"previous":void 0}(e.realIndex,n,e.slides.length);"next"===t?e.slideNext():"previous"===t?e.slidePrev():e.slideToLoop(n)}else e.slideTo(n)}function u(){const t=e.rtl,i=e.params.pagination;if(a())return;let r,c,u=e.pagination.el;u=makeElementsArray(u);const h=e.params.loop?Math.ceil((e.virtual&&e.params.virtual.enabled?e.virtual.slides.length:e.slides.length)/e.params.slidesPerGroup):e.snapGrid.length;if(e.params.loop?(c=e.previousRealIndex||0,r=e.params.slidesPerGroup>1?Math.floor(e.realIndex/e.params.slidesPerGroup):e.realIndex):void 0!==e.snapIndex?(r=e.snapIndex,c=e.previousSnapIndex):(c=e.previousIndex||0,r=e.activeIndex||0),"bullets"===i.type&&e.pagination.bullets&&e.pagination.bullets.length>0){const n=e.pagination.bullets;let a,h,d;if(i.dynamicBullets&&(o=elementOuterSize(n[0],e.isHorizontal()?"width":"height"),u.forEach((t=>{t.style[e.isHorizontal()?"width":"height"]=o*(i.dynamicMainBullets+4)+"px"})),i.dynamicMainBullets>1&&void 0!==c&&(s+=r-(c||0),s>i.dynamicMainBullets-1?s=i.dynamicMainBullets-1:s<0&&(s=0)),a=Math.max(r-s,0),h=a+(Math.min(n.length,i.dynamicMainBullets)-1),d=(h+a)/2),n.forEach((e=>{const t=[...["","-next","-next-next","-prev","-prev-prev","-main"].map((e=>`${i.bulletActiveClass}${e}`))].map((e=>"string"==typeof e&&e.includes(" ")?e.split(" "):e)).flat();e.classList.remove(...t)})),u.length>1)n.forEach((t=>{const n=elementIndex(t);n===r?t.classList.add(...i.bulletActiveClass.split(" ")):e.isElement&&t.setAttribute("part","bullet"),i.dynamicBullets&&(n>=a&&n<=h&&t.classList.add(...`${i.bulletActiveClass}-main`.split(" ")),n===a&&l(t,"prev"),n===h&&l(t,"next"))}));else{const t=n[r];if(t&&t.classList.add(...i.bulletActiveClass.split(" ")),e.isElement&&n.forEach(((e,t)=>{e.setAttribute("part",t===r?"bullet-active":"bullet")})),i.dynamicBullets){const e=n[a],t=n[h];for(let e=a;e<=h;e+=1)n[e]&&n[e].classList.add(...`${i.bulletActiveClass}-main`.split(" "));l(e,"prev"),l(t,"next")}}if(i.dynamicBullets){const r=Math.min(n.length,i.dynamicMainBullets+4),s=(o*r-o)/2-d*o,a=t?"right":"left";n.forEach((t=>{t.style[e.isHorizontal()?a:"top"]=`${s}px`}))}}u.forEach(((t,o)=>{if("fraction"===i.type&&(t.querySelectorAll(classesToSelector(i.currentClass)).forEach((e=>{e.textContent=i.formatFractionCurrent(r+1)})),t.querySelectorAll(classesToSelector(i.totalClass)).forEach((e=>{e.textContent=i.formatFractionTotal(h)}))),"progressbar"===i.type){let n;n=i.progressbarOpposite?e.isHorizontal()?"vertical":"horizontal":e.isHorizontal()?"horizontal":"vertical";const o=(r+1)/h;let s=1,a=1;"horizontal"===n?s=o:a=o,t.querySelectorAll(classesToSelector(i.progressbarFillClass)).forEach((t=>{t.style.transform=`translate3d(0,0,0) scaleX(${s}) scaleY(${a})`,t.style.transitionDuration=`${e.params.speed}ms`}))}"custom"===i.type&&i.renderCustom?(setInnerHTML(t,i.renderCustom(e,r+1,h)),0===o&&n("paginationRender",t)):(0===o&&n("paginationRender",t),n("paginationUpdate",t)),e.params.watchOverflow&&e.enabled&&t.classList[e.isLocked?"add":"remove"](i.lockClass)}))}function h(){const t=e.params.pagination;if(a())return;const i=e.virtual&&e.params.virtual.enabled?e.virtual.slides.length:e.grid&&e.params.grid.rows>1?e.slides.length/Math.ceil(e.params.grid.rows):e.slides.length;let r=e.pagination.el;r=makeElementsArray(r);let o="";if("bullets"===t.type){let n=e.params.loop?Math.ceil(i/e.params.slidesPerGroup):e.snapGrid.length;e.params.freeMode&&e.params.freeMode.enabled&&n>i&&(n=i);for(let i=0;i<n;i+=1)o+=t.renderBullet?t.renderBullet.call(e,i,t.bulletClass):`<${t.bulletElement} ${e.isElement?'part="bullet"':""} class="${t.bulletClass}"></${t.bulletElement}>`}"fraction"===t.type&&(o=t.renderFraction?t.renderFraction.call(e,t.currentClass,t.totalClass):`<span class="${t.currentClass}"></span> / <span class="${t.totalClass}"></span>`),"progressbar"===t.type&&(o=t.renderProgressbar?t.renderProgressbar.call(e,t.progressbarFillClass):`<span class="${t.progressbarFillClass}"></span>`),e.pagination.bullets=[],r.forEach((i=>{"custom"!==t.type&&setInnerHTML(i,o||""),"bullets"===t.type&&e.pagination.bullets.push(...i.querySelectorAll(classesToSelector(t.bulletClass)))})),"custom"!==t.type&&n("paginationRender",r[0])}function d(){e.params.pagination=createElementIfNotDefined(e,e.originalParams.pagination,e.params.pagination,{el:"swiper-pagination"});const t=e.params.pagination;if(!t.el)return;let i;"string"==typeof t.el&&e.isElement&&(i=e.el.querySelector(t.el)),i||"string"!=typeof t.el||(i=[...document.querySelectorAll(t.el)]),i||(i=t.el),i&&0!==i.length&&(e.params.uniqueNavElements&&"string"==typeof t.el&&Array.isArray(i)&&i.length>1&&(i=[...e.el.querySelectorAll(t.el)],i.length>1&&(i=i.find((t=>elementParents(t,".swiper")[0]===e.el)))),Array.isArray(i)&&1===i.length&&(i=i[0]),Object.assign(e.pagination,{el:i}),i=makeElementsArray(i),i.forEach((i=>{"bullets"===t.type&&t.clickable&&i.classList.add(...(t.clickableClass||"").split(" ")),i.classList.add(t.modifierClass+t.type),i.classList.add(e.isHorizontal()?t.horizontalClass:t.verticalClass),"bullets"===t.type&&t.dynamicBullets&&(i.classList.add(`${t.modifierClass}${t.type}-dynamic`),s=0,t.dynamicMainBullets<1&&(t.dynamicMainBullets=1)),"progressbar"===t.type&&t.progressbarOpposite&&i.classList.add(t.progressbarOppositeClass),t.clickable&&i.addEventListener("click",c),e.enabled||i.classList.add(t.lockClass)})))}function p(){const t=e.params.pagination;if(a())return;let i=e.pagination.el;i&&(i=makeElementsArray(i),i.forEach((i=>{i.classList.remove(t.hiddenClass),i.classList.remove(t.modifierClass+t.type),i.classList.remove(e.isHorizontal()?t.horizontalClass:t.verticalClass),t.clickable&&(i.classList.remove(...(t.clickableClass||"").split(" ")),i.removeEventListener("click",c))}))),e.pagination.bullets&&e.pagination.bullets.forEach((e=>e.classList.remove(...t.bulletActiveClass.split(" "))))}i("changeDirection",(()=>{if(!e.pagination||!e.pagination.el)return;const t=e.params.pagination;let{el:i}=e.pagination;i=makeElementsArray(i),i.forEach((i=>{i.classList.remove(t.horizontalClass,t.verticalClass),i.classList.add(e.isHorizontal()?t.horizontalClass:t.verticalClass)}))})),i("init",(()=>{!1===e.params.pagination.enabled?f():(d(),h(),u())})),i("activeIndexChange",(()=>{void 0===e.snapIndex&&u()})),i("snapIndexChange",(()=>{u()})),i("snapGridLengthChange",(()=>{h(),u()})),i("destroy",(()=>{p()})),i("enable disable",(()=>{let{el:t}=e.pagination;t&&(t=makeElementsArray(t),t.forEach((t=>t.classList[e.enabled?"remove":"add"](e.params.pagination.lockClass))))})),i("lock unlock",(()=>{u()})),i("click",((t,i)=>{const r=i.target,o=makeElementsArray(e.pagination.el);if(e.params.pagination.el&&e.params.pagination.hideOnClick&&o&&o.length>0&&!r.classList.contains(e.params.pagination.bulletClass)){if(e.navigation&&(e.navigation.nextEl&&r===e.navigation.nextEl||e.navigation.prevEl&&r===e.navigation.prevEl))return;const t=o[0].classList.contains(e.params.pagination.hiddenClass);n(!0===t?"paginationShow":"paginationHide"),o.forEach((t=>t.classList.toggle(e.params.pagination.hiddenClass)))}}));const f=()=>{e.el.classList.add(e.params.pagination.paginationDisabledClass);let{el:t}=e.pagination;t&&(t=makeElementsArray(t),t.forEach((t=>t.classList.add(e.params.pagination.paginationDisabledClass)))),p()};Object.assign(e.pagination,{enable:()=>{e.el.classList.remove(e.params.pagination.paginationDisabledClass);let{el:t}=e.pagination;t&&(t=makeElementsArray(t),t.forEach((t=>t.classList.remove(e.params.pagination.paginationDisabledClass)))),d(),h(),u()},disable:f,render:h,update:u,init:d,destroy:p})}Object.keys(prototypes).forEach((e=>{Object.keys(prototypes[e]).forEach((t=>{Swiper.prototype[t]=prototypes[e][t]}))})),Swiper.use([Resize,Observer]);const MODE_CLASSES=["station-departure","station-to","station-from","station-exits","station-searching","station-routes","station-noroute"];class StationPanel extends Panel{constructor(e){super(Object.assign({className:"station-panel"},e))}addTo(e){const t=this,i=t._options,n=i.object,r=[],o={},s=i.mode||"departure",a=t._departures=[],l=t._exits=[].concat(...n.map((e=>e.exit||[]))),c=e.getPitch(),{lang:u,dict:h,clock:d}=e,p=d.getDate(),f=p.getMonth()+1,m=p.getDate(),g=p.getHours(),_=p.getMinutes();for(const t of n){const i=e.getLocalizedStationTitle(t),n=t.railway.id;includes(r,i)||r.push(i),o[n]||(o[n]=[]),includes(o[n],i)||o[n].push(i)}for(const t of n){const{railway:i,alternate:n,ascending:r,descending:s}=t,{stations:l,ascending:c,descending:u,color:h}=i;for(const{direction:d,altDirection:p}of[{direction:c,altDirection:r},{direction:u,altDirection:s}])if(null!==p)if(n){for(const{railways:e}of a)if(e[0].station===n&&e[0].direction===p){e.push({railway:i,station:t,direction:d});break}}else{let n;if(l[0]!==l[l.length-1])for(let e=0,t=l.length;e<t;e++){const i=l[d===c?t-1-e:e];if(!i.alternate){n=i;break}}t!==n&&a.push({railways:[{railway:i,station:t,direction:d}],color:h,label:[e.getLocalizedRailwayTitle(i),o[i.id].length>1?`(${e.getLocalizedStationTitle(t)})`:"",e.getLocalizedRailDirectionTitle(p||d)].join(" ")})}}super.addTo(e).setTitle(['<div id="station-title-name">',`<div>${r.join(h.and)}</div>`,'<div class="station-content-selector">',"<span>",'<input id="station-departure-button" type="radio" name="station">',`<label for="station-departure-button">${h.departures}</label>`,"</span>","<span>",'<input id="station-to-button" type="radio" name="station">',`<label for="station-to-button">${h["to-here"]}</label>`,"</span>","<span>",'<input id="station-from-button" type="radio" name="station">',`<label for="station-from-button">${h["from-here"]}</label>`,"</span>",l.length?["<span>",'<input id="station-exits-button" type="radio" name="station">',`<label for="station-exits-button">${h.exits}</label>`,"</span>"].join(""):"","</div>","</div>",`<div id="station-title-searching">${h["route-search"]}</div>`,'<div id="station-title-routes"></div>'].join("")).setHTML(['<div id="station-departure"></div>','<div id="station-to">',`<div class="search-form-element">${h["from-station"]} <input id="origin" class="search-input search-focus" type="text" list="stations" placeholder="${h["enter-station-name"]}"></div>`,'<div class="search-form-element">','<select id="to-type" class="search-select">',`<option value="departure" selected>${h["depart-at"]}</option>`,"</select>",'<select id="to-month" class="search-select">',`<option value="${f}" selected>${p.toLocaleDateString(u,{month:"short"})}</option>`,"</select>",'<select id="to-date" class="search-select">',`<option value="${m}" selected>${p.toLocaleDateString(u,{day:"numeric"})}</option>`,"</select>",'<select id="to-hours" class="search-select"></select>','<select id="to-minutes" class="search-select"></select>',"</div>",`<div class="search-form-element"><button id="to-search-button" class="search-button" disabled>${h["search-route"]}</button></div>`,"</div>",'<div id="station-from">',`<div class="search-form-element">${h["to-station"]} <input id="destination" class="search-input search-focus" type="text" list="stations" placeholder="${h["enter-station-name"]}"></div>`,'<div class="search-form-element">','<select id="from-type" class="search-select">',`<option value="departure" selected>${h["depart-at"]}</option>`,"</select>",'<select id="from-month" class="search-select">',`<option value="${f}" selected>${p.toLocaleDateString(u,{month:"short"})}</option>`,"</select>",'<select id="from-date" class="search-select">',`<option value="${m}" selected>${p.toLocaleDateString(u,{day:"numeric"})}</option>`,"</select>",'<select id="from-hours" class="search-select"></select>','<select id="from-minutes" class="search-select"></select>',"</div>",`<div class="search-form-element"><button id="from-search-button" class="search-button" disabled>${h["search-route"]}</button></div>`,"</div>",'<div id="station-exits"></div>','<div id="station-searching">','<div class="ball-pulse"><div></div><div></div><div></div></div>',"</div>",'<div id="station-routes" class="swiper">','<div class="swiper-wrapper"></div>','<div class="swiper-pagination"></div>',"</div>",`<div id="station-noroute">${h["cannot-find-train"]}</div>`].join(""));const y=t._container,v=y.querySelector("#origin"),x=y.querySelector("#destination");y.classList.add(`station-${s}`),y.querySelector(`#station-${s}-button`).checked=!0;for(const t of["station-departure","station-to","station-from","station-exits"]){const i=y.querySelector(`#${t}-button`);i&&i.addEventListener("click",(()=>{const i=y.classList;i.contains(t)||(i.remove(...MODE_CLASSES),i.add(t),"station-to"===t?v.focus():"station-from"===t&&x.focus(),"station-exits"!==t?(e.hideStationExits(),e.map.flyTo({center:e.lastCameraParams.center,zoom:15.5,pitch:c})):e.showStationExits(n),e._setSearchMode(includes(["station-to","station-from"],t)?"edit":"none"))}))}t.updateContent();for(const i of["to","from"]){const r=y.querySelector(`#${i}-hours`),o=y.querySelector(`#${i}-minutes`),s="to"===i?v:x,a=y.querySelector(`#${i}-search-button`);for(let e=0;e<24;e++)p.setHours(e),createElement$1("option",{value:e,text:p.toLocaleTimeString(u,{hour:"numeric"}),selected:e===g},r);for(let e=0;e<60;e++)p.setMinutes(e),createElement$1("option",{value:e,text:`${p.toLocaleTimeString(u,{minute:"numeric"})}${h.minute}`,selected:e===_},o);s.addEventListener("input",(()=>{const t=e.stationTitleLookup.get(s.value.toUpperCase());a.disabled=!t||includes(n,t)})),a.addEventListener("click",(()=>{const s=y.classList,a=e.stationTitleLookup,l="to"===i?a.get(v.value.toUpperCase()):n[0],c="from"===i?a.get(x.value.toUpperCase()):n[0],u=y.querySelector(`#${i}-type`).value,h=y.querySelector(`#${i}-month`).value,d=y.querySelector(`#${i}-date`).value,p=r.value,f=o.value;s.remove(...MODE_CLASSES),s.add("station-searching"),t.setButtons([t._backButton]),loadJSON(`${configs.searchUrl}?origin=${l.id}&destination=${c.id}&type=${u}&month=${h}&date=${d}&hours=${p}&minutes=${f}`).then((e=>{const i=y.classList;i.contains("station-searching")&&(i.remove(...MODE_CLASSES),t.showResult(e))}))}))}t.popups=[];const b=t._backButton=createElement$1("div",{innerHTML:['<button id="back-button" class="back-button">','<span class="back-icon"></span>',"</button>"].join("")});return b.addEventListener("click",(e=>{e.stopPropagation()})),b.querySelector("#back-button").addEventListener("click",(()=>{const i=t._swiper,n=y.classList;i&&(i.destroy(),delete t._swiper,t.hideRoute()),n.remove(...MODE_CLASSES),y.querySelector("#station-to-button").checked?(n.add("station-to"),v.focus()):(n.add("station-from"),x.focus()),t.setButtons(),e.map.flyTo({center:e.lastCameraParams.center,zoom:15.5}),e._setSearchMode("edit")})),t}reset(){const e=this,{_map:t,_container:i,_swiper:n}=e,r=i.classList;n&&(n.destroy(),delete e._swiper,e.hideRoute()),r.remove(...MODE_CLASSES),r.add("station-departure"),i.querySelector(":checked").checked=!1,i.querySelector("#station-departure-button").checked=!0,e.setButtons(),t.hideStationExits(),t.map.flyTo({center:t.lastCameraParams.center,zoom:15.5}),t._setSearchMode("none")}updateContent(){const{_map:e,_container:t,_exits:i,_departures:n}=this,{dict:r,clock:o,container:s}=e,a=o.getTimeOffset(),l=o.getCalendar(),c=t.querySelector("#station-exits");if(this.isOpen()){for(const t of n){const i=[];for(const{railway:n,station:r,direction:o}of t.railways)for(const t of e.timetables.getByDirectionId(n.id,o.id)){const n=e.activeTrainLookup.get(t.t)||e.standbyTrainLookup.get(t.id),o=n&&n.delay||0,s=t.stations;if(!(t.end+o<=a))for(let e=0,n=s.length-1;e<n;e++)if(s[e]===r){const n=t.departureTimes[e]+o;n>a&&(0===i.length||n<i[0].time?(i.unshift({timetable:t,time:n,delay:o}),i.splice(2,1)):(1===i.length||n<i[1].time)&&i.splice(1,1,{timetable:t,time:n,delay:o}));break}}t.trains=i}t.querySelector("#station-departure").innerHTML=n.map((({color:t,label:i,trains:n})=>['<div class="direction-row">',`<div class="line-strip" style="background-color: ${t};"></div>`,`<div class="direction-label">${i}</div>`,"</div>",'<div class="trains-row">',n.length?n.map((({timetable:t,time:i,delay:n})=>['<div class="train-row">',`<div class="train-time-box${n>=6e4?" desc-caution":""}">${getTimeString(i)}</div>`,'<div class="train-title-box">',`<span class="train-type-label">${e.getLocalizedTrainTypeTitle(t.y)}</span> `,t.nm?`${e.getLocalizedTrainNameOrRailwayTitle(t.nm)} `:"",e.getLocalizedDestinationTitle(t.ds,t.d),n>=6e4?` <span class="desc-caution">${r.delay.replace("$1",Math.floor(n/6e4))}</span>`:"","</div>","</div>"].join(""))).join(""):`<div class="train-row desc-caution">${r["service-has-ended"]}</div>`,"</div>"].join(""))).join(""),c.innerHTML="";for(let t=0,n=i.length;t<n;t++){const n=i[t],r=n.uptime&&n.uptime.reduce(((e,t)=>!t.calendar||includes(t.calendar,l)?t:e),{}),o=createElement$1("div",{className:"exit-row"+(r&&(a<r.open||a>=r.close||r.open===r.close)?" closed":""),innerHTML:['<div class="exit-icon-box"></div>','<div class="exit-title-box">',e.getLocalizedPOIDescription(n),r&&r.open!==r.close?` (${getTimeString(r.open)}-${getTimeString(r.close)})`:"","</div>",(n.facilities||[]).map((e=>`<div class="exit-${e}-icon"></div>`)).join(""),'<div class="exit-share-button"></div>'].join("")},c);o.addEventListener("click",(()=>{e.map.flyTo({center:n.coord,zoom:19,pitch:30})})),o.addEventListener("mouseenter",(()=>{const e=s.querySelector(`#exit-${t}`);e&&e.classList.add("highlighted")})),o.addEventListener("mouseleave",(()=>{const e=s.querySelector(`#exit-${t}`);e&&e.classList.remove("highlighted")}))}}}fillStationName(e){const t=this._container,i=t.classList;if(i.contains("station-to")){const i=t.querySelector("#origin");i.value=e,i.dispatchEvent(new Event("input")),i.focus()}else if(i.contains("station-from")){const i=t.querySelector("#destination");i.value=e,i.dispatchEvent(new Event("input")),i.focus()}}showResult(e){const t=this,{_map:i,_container:n,_backButton:r}=t,o=i.dict,s=n.classList,a=createElement$1("div",{className:"page-controller",innerHTML:['<span><button id="previous-button" class="previous-button">','<span class="previous-icon"></span>',"</button></span>",'<span><button id="next-button" class="next-button">','<span class="next-icon"></span>',"</button></span>"].join("")}),l=n.querySelector(".swiper-wrapper"),c=e.routes;if(t._result=e,i._setSearchMode("route"),a.addEventListener("click",(e=>{e.stopPropagation()})),a.querySelector("#previous-button").addEventListener("click",(()=>{t._swiper.slidePrev()})),a.querySelector("#next-button").addEventListener("click",(()=>{t._swiper.slideNext()})),l.innerHTML="",c){s.add("station-routes"),t.setButtons([r,a]);for(const e of c){const t=createElement$1("div",{className:"swiper-slide",innerHTML:['<div class="swiper-slide-content">','<div id="search-routes"></div>','<svg id="railway-mark"></svg>',"</div>"].join("")},l),n=t.querySelector("#search-routes"),r=t.querySelector("#railway-mark"),s=[],a=[],c=[];let u;for(const{r:t,y:n,ds:r,d:l,tt:c,nm:h,transfer:d,delay:p}of e.trains){const e=c[0],f=c[c.length-1],m=i.getLocalizedTrainNameOrRailwayTitle(h,i.railways.get(t)),g=i.getLocalizedTrainTypeTitle(i.trainTypes.get(n)),_=i.getLocalizedDestinationTitle(r?r.map((e=>i.stations.get(e))):void 0,i.railDirections.get(l)),y={};if(y.start=a.length,a.push(['<div class="station-row">',`<div class="station-title-box">${i.getLocalizedStationTitle(i.stations.get(e.s))}</div>`,`<div class="station-time-box${p?" desc-caution":""}">`,void 0!==u?`${getTimeString(u+6e4*p)}<br>`:"",getTimeString(getTimeOffset(e.d)+6e4*p),"</div></div>"].join("")),a.push(['<div class="station-row">',`<div class="train-title-box">${m} <span class="train-type-label">${g}</span> ${_}`,p?` <span class="desc-caution">${o.delay.replace("$1",p)}</span>`:"","</div></div>"].join("")),y.end=a.length,y.color=i.railways.get(t).color,s.push(y),0===d)u=getTimeOffset(f.a);else{if(a.push(['<div class="station-row">',`<div class="station-title-box">${i.getLocalizedStationTitle(i.stations.get(f.s))}</div>`,`<div class="station-time-box${p?" desc-caution":""}">`,getTimeString(getTimeOffset(f.a||f.d)+6e4*p),"</div></div>"].join("")),d>0){const e={};e.start=a.length-1,a.push(['<div class="station-row">',`<div class="train-title-box">${o["transfer-and-wait"].replace("$1",d)}</div>`,"</div>"].join("")),e.end=a.length,s.push(e)}u=void 0}}n.innerHTML=a.join("");for(const e of n.children)c.push(e.offsetTop+e.getBoundingClientRect().height/2);r.innerHTML=s.map((({color:e,start:t,end:i})=>e?`<line stroke="${e}" stroke-width="10" x1="12" y1="${c[t]}" x2="12" y2="${c[i]}" stroke-linecap="round" />`:`<line stroke="#7f7f7f" stroke-width="4" x1="12" y1="${c[t]}" x2="12" y2="${c[i]}" stroke-dasharray="4 4" />`)).concat(c.map(((e,t)=>t%2==0?`<circle cx="12" cy="${e}" r="3" fill="#ffffff" />`:""))).join("")}t._swiper=new Swiper(".swiper",{modules:[Pagination],pagination:{el:".swiper-pagination",clickable:!0}}),t._swiper.on("slideChange",(()=>{t.hideRoute()})),t._swiper.on("slideChangeTransitionEnd",(()=>{t.switchRoute()})),t.switchRoute()}else s.add("station-noroute"),t.setButtons([r]),l.innerHTML=['<div class="swiper-slide">','<div class="swiper-slide-content">',o["cannot-find-train"],"</div></div>"].join("")}switchRoute(){const e=this,{_map:t,_container:i,_swiper:n}=e,{dict:r,map:o,featureCollection:s}=t,a=n.activeIndex,l=e._result.routes[a],c=l.trains,u=[],h=[],d=[];i.querySelector("#station-title-routes").innerHTML=[`${r.route}${a+1} `,r.transfers.replace("$1",l.numTransfers)].join(""),i.querySelector("#previous-button").disabled=n.isBeginning,i.querySelector("#next-button").disabled=n.isEnd;for(const{r:e,tt:i,d:n}of c){const{stations:r,ascending:o}=t.railways.get(e),s=r.map((({id:e})=>e)),a=i[0].s,l=i[i.length-1].s;for(const e of i){const i=t.stations.get(e.s);h.push(i.group),d.push(i.coord)}if(n===o.id){const t=s.indexOf(a),i=s.indexOf(l,t);for(let n=t;n<i;n++)u.push(`${e}.${n+1}`)}else{const t=s.lastIndexOf(a),i=s.lastIndexOf(l,t);for(let n=t;n>i;n--)u.push(`${e}.${n}`)}}for(const e of[13,14,15,16,17,18])o.getLayer(`railways-routeug-${e}`).setProps({data:featureFilter(s,(t=>t.zoom===e&&t.altitude<0&&includes(u,t.section)))}),o.getLayer(`stations-routeug-${e}`).setProps({data:featureFilter(s,(t=>t.zoom===e&&t.altitude<0&&includes(h,t.group)))}),o.getLayer(`railways-routeog-${e}`).setProps({data:featureFilter(s,(t=>t.zoom===e&&0===t.altitude&&includes(u,t.section)))}),o.getLayer(`stations-routeog-${e}`).setProps({data:featureFilter(s,(t=>t.zoom===e&&0===t.altitude&&includes(h,t.group)))});o.fitBounds(getBounds$1(d),{bearing:o.getBearing(),pitch:o.getPitch(),offset:[0,-o.transform.height/12],padding:{top:20,bottom:20,left:10,right:50},linear:!0,maxZoom:18}),t.refreshMap();const p=[c[0].tt[0].s];for(const e of c)(e.transfer>0||e===c[c.length-1])&&p.push(e.tt[e.tt.length-1].s);e.popups=p.map(((i,n)=>setTimeout((()=>{const s=new Popup$1({className:"popup-route",closeButton:!1,closeOnClick:!1});s.setLngLat(t.stations.get(i).coord).setHTML(0===n?r["from-station"]:n===p.length-1?r["to-station"]:`${r.transfer}${n}`).addTo(o),e.popups[n]=s}),n/p.length*1e3+500)))}hideRoute(){const e=this,t=e._map.map;for(const e of[13,14,15,16,17,18])for(const i of["routeug","routeog"])for(const n of["railways","stations"])setLayerProps(t,`${n}-${i}-${e}`,{data:emptyFeatureCollection()});for(const t of e.popups)t instanceof Popup$1?t.remove():clearTimeout(t)}remove(){return this.hideRoute(),super.remove()}}const trackingModes=["position","back","topback","front","topfront","helicopter","drone","bird"];class TrackingModePanel extends Panel{constructor(e){super(Object.assign({className:"tracking-mode-panel",modal:!0},e));const t=this;t._onModeChanged=e=>{const i=t._container,n=e.mode.replace("heading","topback");i.querySelector(".tracking-mode-icon-enabled").classList.remove("tracking-mode-icon-enabled"),i.querySelector(`#${n}-tracking-mode .tracking-mode-icon`).classList.add("tracking-mode-icon-enabled")}}addTo(e){const t=this,i=e.dict,n=e.getTrackingMode();super.addTo(e).setTitle(i["tracking-modes"]).setHTML(trackingModes.map((e=>[`<div id="${e}-tracking-mode" class="tracking-mode-row">`,'<div class="tracking-mode-icon"></div>',`<div>${i[e]}</div>`,"</div>"].join(""))).join(""));for(const i of trackingModes){const r=t._container.querySelector(`#${i}-tracking-mode .tracking-mode-icon`);(i===n||"topback"===i&&"heading"===n)&&r.classList.add("tracking-mode-icon-enabled"),r.addEventListener("click",(()=>{e.getTrackingMode()!==i&&e.setTrackingMode(i)}))}return e.on("trackingmode",t._onModeChanged),t}remove(){return this._map.off("trackingmode",this._onModeChanged),super.remove()}}class TrainPanel extends Panel{constructor(e){super(Object.assign({className:"train-panel"},e))}addTo(e){const t=this,i=[],n=[],r=[],o=[],s=t._options.object,{r:a,timetable:l}=s,c=(s.v||a).color,u=s.delay||0;let h,d;for(let e=l;e;e=e.pt&&e.pt[0])i.unshift(e);for(let e=l.nt&&l.nt[0];e;e=e.nt&&e.nt[0])i.push(e);for(const t of i){const i={},o=t.stations;i.start=r.length;for(let i=0,n=o.length;i<n;i++){const s=t.arrivalTimes[i]||d,a=t.departureTimes[i];if(i===n-1&&t.nt){d=s;break}d=void 0,r.push(['<div class="station-row">',`<div class="station-title-box">${e.getLocalizedStationTitle(o[i])}</div>`,'<div class="station-time-box',u>=6e4?" desc-caution":"",'">',void 0!==s?getTimeString(s+u):"",void 0!==s&&void 0!==a?"<br>":"",void 0!==a?getTimeString(a+u):"","</div></div>"].join(""))}i.end=r.length-(t.nt?0:1),i.color=t.r.color,n.push(i),t===l&&(h=i)}super.addTo(e).setTitle(['<div class="desc-header">',Array.isArray(c)?["<div>",...c.slice(0,3).map((e=>`<div class="line-strip-long" style="background-color: ${e};"></div>`)),"</div>"].join(""):`<div style="background-color: ${c};"></div>`,'<div><div class="desc-first-row">',e.getLocalizedTrainNameOrRailwayTitle(s.nm,a),'</div><div class="desc-second-row">',`<span class="train-type-label">${e.getLocalizedTrainTypeTitle(s.y)}</span> `,e.getLocalizedDestinationTitle(s.ds,s.d),"</div></div></div>"].join("")).setHTML(['<div id="timetable-content">',...r,"</div>",'<svg id="railway-mark"></svg>','<svg id="train-mark"></svg>'].join(""));const p=t._container,f=p.querySelector("#panel-body");for(const e of p.querySelector("#timetable-content").children)o.push(e.offsetTop+e.getBoundingClientRect().height/2);p.querySelector("#railway-mark").innerHTML=n.map((({color:e,start:t,end:i})=>`<line stroke="${e}" stroke-width="10" x1="12" y1="${o[t]}" x2="12" y2="${o[i]}" stroke-linecap="round" />`)).concat(o.map((e=>`<circle cx="12" cy="${e}" r="3" fill="#ffffff" />`))).join("");const m=o.slice(h.start,h.end+1);return function e(){const i=f.getBoundingClientRect().height,n=s.timetableIndex,r=m[n],o=lerp$5(r,s.arrivalStation?m[n+1]:r,s._t),a=performance.now()%1500/1500;p.querySelector("#train-mark").innerHTML=`<circle cx="22" cy="${o}" r="${7+15*a}" fill="#ffffff" opacity="${1-a}" /><circle cx="22" cy="${o}" r="7" fill="#ffffff" />`,void 0!==t._scrollTop&&t._scrollTop!==f.scrollTop||(f.scrollTop=Math.round(o-i/2+4),t._scrollTop=f.scrollTop),t._container&&requestAnimationFrame(e)}(),t}reset(){delete this._scrollTop}}class Plugin{constructor(e){const t=this;t.implementation=e,t.enabled=!1,t.clockModes=e.clockModes||["realtime","playback"],t.viewModes=e.viewModes||["ground","underground"],t.searchModes=e.searchModes||["none"],t._onModeChanged=()=>{t.setVisibility(!0)}}addTo(e){const t=this,i=t.implementation;return t.map=e,i.onAdd&&i.onAdd(e),valueOrDefault(i.enabled,!0)&&t.enable(),t}remove(){const e=this,t=e.implementation;return e.disable(),t.onRemove&&t.onRemove(e.map),delete e.map,e}enable(){const e=this,{map:t,_onModeChanged:i,implementation:n}=e;return e.enabled||(e.enabled=!0,t.on("clockmode",i),t.on("viewmode",i),n.onEnabled&&n.onEnabled(),e.setVisibility(!0)),e}disable(){const e=this,{map:t,_onModeChanged:i,implementation:n}=e;return e.enabled&&(e.enabled=!1,t.off("clockmode",i),t.off("viewmode",i),e.setVisibility(!1),n.onDisabled&&n.onDisabled()),e}setVisibility(e){const t=this,{map:i,implementation:n}=t;n.onVisibilityChanged&&n.onVisibilityChanged(e&&t.enabled&&includes(t.clockModes,i.getClockMode())&&includes(t.viewModes,i.getViewMode())&&includes(t.searchModes,i.searchMode))}getId(){return this.implementation.id}getName(e){const t=this.implementation.name;return t[e]||t.en}getIconStyle(){return this.implementation.iconStyle}isEnabled(){return this.enabled}}function destination(e,t,i,n){if(!isObject$5(n=n||{}))throw new Error("options is invalid");var r=n.units,o=n.properties,s=getCoord(e),a=degreesToRadians(s[0]),l=degreesToRadians(s[1]),c=degreesToRadians(i),u=lengthToRadians(t,r),h=Math.asin(Math.sin(l)*Math.cos(u)+Math.cos(l)*Math.sin(u)*Math.cos(c));return point([radiansToDegrees(a+Math.atan2(Math.sin(c)*Math.sin(u)*Math.cos(l),Math.cos(u)-Math.sin(l)*Math.sin(h))),radiansToDegrees(h)],o)}function quickselect(e,t,i,n,r){quickselectStep(e,t,i||0,n||e.length-1,r||defaultCompare)}function quickselectStep(e,t,i,n,r){for(;n>i;){if(n-i>600){var o=n-i+1,s=t-i+1,a=Math.log(o),l=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*l*(o-l)/o)*(s-o/2<0?-1:1);quickselectStep(e,t,Math.max(i,Math.floor(t-s*l/o+c)),Math.min(n,Math.floor(t+(o-s)*l/o+c)),r)}var u=e[t],h=i,d=n;for(swap(e,i,t),r(e[n],u)>0&&swap(e,i,n);h<d;){for(swap(e,h,d),h++,d--;r(e[h],u)<0;)h++;for(;r(e[d],u)>0;)d--}0===r(e[i],u)?swap(e,i,d):swap(e,++d,n),d<=t&&(i=d+1),t<=d&&(n=d-1)}}function swap(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function defaultCompare(e,t){return e<t?-1:e>t?1:0}function rbush(e,t){if(!(this instanceof rbush))return new rbush(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&this._initFormat(t),this.clear()}function findItem(e,t,i){if(!i)return t.indexOf(e);for(var n=0;n<t.length;n++)if(i(e,t[n]))return n;return-1}function calcBBox(e,t){distBBox(e,0,e.children.length,t,e)}function distBBox(e,t,i,n,r){r||(r=createNode(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var o,s=t;s<i;s++)o=e.children[s],extend(r,e.leaf?n(o):o);return r}function extend(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function compareNodeMinX(e,t){return e.minX-t.minX}function compareNodeMinY(e,t){return e.minY-t.minY}function bboxArea(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function bboxMargin(e){return e.maxX-e.minX+(e.maxY-e.minY)}function enlargedArea(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function intersectionArea(e,t){var i=Math.max(e.minX,t.minX),n=Math.max(e.minY,t.minY),r=Math.min(e.maxX,t.maxX),o=Math.min(e.maxY,t.maxY);return Math.max(0,r-i)*Math.max(0,o-n)}function contains(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function intersects$1(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function createNode(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function multiSelect(e,t,i,n,r){for(var o,s=[t,i];s.length;)(i=s.pop())-(t=s.pop())<=n||(quickselect(e,o=t+Math.ceil((i-t)/n/2)*n,t,i,r),s.push(t,o,o,i))}function geojsonRbush(e){var t=rbush(e);return t.insert=function(e){if(Array.isArray(e)){var t=e;(e=bboxPolygon(t)).bbox=t}else e.bbox=e.bbox?e.bbox:turfBBox(e);return rbush.prototype.insert.call(this,e)},t.load=function(e){var t=[];return Array.isArray(e)?e.forEach((function(e){var i=bboxPolygon(e);i.bbox=e,t.push(i)})):featureEach(e,(function(e){e.bbox=e.bbox?e.bbox:turfBBox(e),t.push(e)})),rbush.prototype.load.call(this,t)},t.remove=function(e){if(Array.isArray(e)){var t=e;(e=bboxPolygon(t)).bbox=t}return rbush.prototype.remove.call(this,e)},t.clear=function(){return rbush.prototype.clear.call(this)},t.search=function(e){return{type:"FeatureCollection",features:rbush.prototype.search.call(this,this.toBBox(e))}},t.collides=function(e){return rbush.prototype.collides.call(this,this.toBBox(e))},t.all=function(){return{type:"FeatureCollection",features:rbush.prototype.all.call(this)}},t.toJSON=function(){return rbush.prototype.toJSON.call(this)},t.fromJSON=function(e){return rbush.prototype.fromJSON.call(this,e)},t.toBBox=function(e){var t;return{minX:(t=e.bbox?e.bbox:Array.isArray(e)&&4===e.length?e:turfBBox(e))[0],minY:t[1],maxX:t[2],maxY:t[3]}},t}function bboxPolygon(e){var t=[e[0],e[1]];return{type:"Feature",bbox:e,properties:{},geometry:{type:"Polygon",coordinates:[[t,[e[2],e[1]],[e[2],e[3]],[e[0],e[3]],t]]}}}function turfBBox(e){var t=[1/0,1/0,-1/0,-1/0];return coordEach(e,(function(e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1])})),t}function lineSegment(e){if(!e)throw new Error("geojson is required");var t=[];return flattenEach(e,(function(e){lineSegmentFeature(e,t)})),featureCollection(t)}function lineSegmentFeature(e,t){var i=[],n=e.geometry;switch(n.type){case"Polygon":i=getCoords(n);break;case"LineString":i=[getCoords(n)]}i.forEach((function(i){createSegments(i,e.properties).forEach((function(e){e.id=t.length,t.push(e)}))}))}function createSegments(e,t){var i=[];return e.reduce((function(e,n){var r=lineString([e,n],t);return r.bbox=bbox(e,n),i.push(r),n})),i}function bbox(e,t){var i=e[0],n=e[1],r=t[0],o=t[1];return[i<r?i:r,n<o?n:o,i>r?i:r,n>o?n:o]}function lineIntersect(e,t){var i={},n=[];if("LineString"===e.type&&(e=feature(e)),"LineString"===t.type&&(t=feature(t)),"Feature"===e.type&&"Feature"===t.type&&"LineString"===e.geometry.type&&"LineString"===t.geometry.type&&2===e.geometry.coordinates.length&&2===t.geometry.coordinates.length){var r=intersects(e,t);return r&&n.push(r),featureCollection(n)}var o=geojsonRbush();return o.load(lineSegment(t)),featureEach(lineSegment(e),(function(e){featureEach(o.search(e),(function(t){var r=intersects(e,t);if(r){var o=getCoords(r).join(",");i[o]||(i[o]=!0,n.push(r))}}))})),featureCollection(n)}function intersects(e,t){var i=getCoords(e),n=getCoords(t);if(2!==i.length)throw new Error("<intersects> line1 must only contain 2 coordinates");if(2!==n.length)throw new Error("<intersects> line2 must only contain 2 coordinates");var r=i[0][0],o=i[0][1],s=i[1][0],a=i[1][1],l=n[0][0],c=n[0][1],u=n[1][0],h=n[1][1],d=(h-c)*(s-r)-(u-l)*(a-o),p=(u-l)*(o-c)-(h-c)*(r-l),f=(s-r)*(o-c)-(a-o)*(r-l);if(0===d)return null;var m=p/d,g=f/d;return m>=0&&m<=1&&g>=0&&g<=1?point([r+m*(s-r),o+m*(a-o)]):null}function nearestCloserPointOnLine(e,t,i,n){if(!isObject$5(n=n||{}))throw new Error("options is invalid");const r=e.geometry?e.geometry.type:e.type;if("LineString"!==r&&"MultiLineString"!==r)throw new Error("lines must be LineString or MultiLineString");let o=point([1/0,1/0],{dist:1/0,score:1/0}),s=0;return flattenEach(e,(e=>{const r=getCoords(e);for(let e=0;e<r.length-1;e++){const a=point(r[e]);a.properties.dist=distance$1(t,a,n),a.properties.score=a.properties.dist+Math.abs(s-i)/100;const l=point(r[e+1]);l.properties.dist=distance$1(t,l,n);const c=distance$1(a,l,n);l.properties.score=l.properties.dist+Math.abs(s+c-i)/100;const u=Math.max(a.properties.dist,l.properties.dist),h=bearing(a,l),d=destination(t,u,h+90,n),p=destination(t,u,h-90,n),f=lineIntersect(lineString([d.geometry.coordinates,p.geometry.coordinates]),lineString([a.geometry.coordinates,l.geometry.coordinates]));let m=null;f.features.length>0&&(m=f.features[0],m.properties.dist=distance$1(t,m,n),m.properties.location=s+distance$1(a,m,n),m.properties.score=m.properties.dist+Math.abs(m.properties.location-i)/100),a.properties.score<o.properties.score&&(o=a,o.properties.index=e,o.properties.location=s),l.properties.score<o.properties.score&&(o=l,o.properties.index=e+1,o.properties.location=s+c),m&&m.properties.score<o.properties.score&&(o=m,o.properties.index=e),s+=c}})),o}rbush.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,i=[],n=this.toBBox;if(!intersects$1(e,t))return i;for(var r,o,s,a,l=[];t;){for(r=0,o=t.children.length;r<o;r++)s=t.children[r],intersects$1(e,a=t.leaf?n(s):s)&&(t.leaf?i.push(s):contains(e,a)?this._all(s,i):l.push(s));t=l.pop()}return i},collides:function(e){var t=this.data,i=this.toBBox;if(!intersects$1(e,t))return!1;for(var n,r,o,s,a=[];t;){for(n=0,r=t.children.length;n<r;n++)if(o=t.children[n],intersects$1(e,s=t.leaf?i(o):o)){if(t.leaf||contains(e,s))return!0;a.push(o)}t=a.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}var n=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var r=this.data;this.data=n,n=r}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=createNode([]),this},remove:function(e,t){if(!e)return this;for(var i,n,r,o,s=this.data,a=this.toBBox(e),l=[],c=[];s||l.length;){if(s||(s=l.pop(),n=l[l.length-1],i=c.pop(),o=!0),s.leaf&&-1!==(r=findItem(e,s.children,t)))return s.children.splice(r,1),l.push(s),this._condense(l),this;o||s.leaf||!contains(s,a)?n?(i++,s=n.children[i],o=!1):s=null:(l.push(s),c.push(i),i=0,n=s,s=s.children[0])}return this},toBBox:function(e){return e},compareMinX:compareNodeMinX,compareMinY:compareNodeMinY,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var i=[];e;)e.leaf?t.push.apply(t,e.children):i.push.apply(i,e.children),e=i.pop();return t},_build:function(e,t,i,n){var r,o=i-t+1,s=this._maxEntries;if(o<=s)return calcBBox(r=createNode(e.slice(t,i+1)),this.toBBox),r;n||(n=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,n-1))),(r=createNode([])).leaf=!1,r.height=n;var a,l,c,u,h=Math.ceil(o/s),d=h*Math.ceil(Math.sqrt(s));for(multiSelect(e,t,i,d,this.compareMinX),a=t;a<=i;a+=d)for(multiSelect(e,a,c=Math.min(a+d-1,i),h,this.compareMinY),l=a;l<=c;l+=h)u=Math.min(l+h-1,c),r.children.push(this._build(e,l,u,n-1));return calcBBox(r,this.toBBox),r},_chooseSubtree:function(e,t,i,n){for(var r,o,s,a,l,c,u,h;n.push(t),!t.leaf&&n.length-1!==i;){for(u=h=1/0,r=0,o=t.children.length;r<o;r++)l=bboxArea(s=t.children[r]),(c=enlargedArea(e,s)-l)<h?(h=c,u=l<u?l:u,a=s):c===h&&l<u&&(u=l,a=s);t=a||t.children[0]}return t},_insert:function(e,t,i){var n=i?e:(0,this.toBBox)(e),r=[],o=this._chooseSubtree(n,this.data,t,r);for(o.children.push(e),extend(o,n);t>=0&&r[t].children.length>this._maxEntries;)this._split(r,t),t--;this._adjustParentBBoxes(n,r,t)},_split:function(e,t){var i=e[t],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);var o=this._chooseSplitIndex(i,r,n),s=createNode(i.children.splice(o,i.children.length-o));s.height=i.height,s.leaf=i.leaf,calcBBox(i,this.toBBox),calcBBox(s,this.toBBox),t?e[t-1].children.push(s):this._splitRoot(i,s)},_splitRoot:function(e,t){this.data=createNode([e,t]),this.data.height=e.height+1,this.data.leaf=!1,calcBBox(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,i){var n,r,o,s,a,l,c,u;for(l=c=1/0,n=t;n<=i-t;n++)s=intersectionArea(r=distBBox(e,0,n,this.toBBox),o=distBBox(e,n,i,this.toBBox)),a=bboxArea(r)+bboxArea(o),s<l?(l=s,u=n,c=a<c?a:c):s===l&&a<c&&(c=a,u=n);return u},_chooseSplitAxis:function(e,t,i){var n=e.leaf?this.compareMinX:compareNodeMinX,r=e.leaf?this.compareMinY:compareNodeMinY;this._allDistMargin(e,t,i,n)<this._allDistMargin(e,t,i,r)&&e.children.sort(n)},_allDistMargin:function(e,t,i,n){e.children.sort(n);var r,o,s=this.toBBox,a=distBBox(e,0,t,s),l=distBBox(e,i-t,i,s),c=bboxMargin(a)+bboxMargin(l);for(r=t;r<i-t;r++)o=e.children[r],extend(a,e.leaf?s(o):o),c+=bboxMargin(a);for(r=i-t-1;r>=t;r--)o=e.children[r],extend(l,e.leaf?s(o):o),c+=bboxMargin(l);return c},_adjustParentBBoxes:function(e,t,i){for(var n=i;n>=0;n--)extend(t[n],e)},_condense:function(e){for(var t,i=e.length-1;i>=0;i--)0===e[i].children.length?i>0?(t=e[i-1].children).splice(t.indexOf(e[i]),1):this.clear():calcBBox(e[i],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}};const RAILWAY_NAMBOKU="TokyoMetro.Namboku",RAILWAY_MITA="Toei.Mita",RAILWAY_ARAKAWA="Toei.Arakawa",AIRLINES_FOR_ANA_CODE_SHARE=["ADO","SFJ","SNJ"],DEGREE_TO_RADIAN=Math.PI/180,_updateZoomButtons=mapboxGlExports.NavigationControl.prototype._updateZoomButtons;mapboxGlExports.NavigationControl.prototype._updateZoomButtons=function(){const{_disabled:e,_zoomInButton:t,_zoomOutButton:i,_compass:n}=this;_updateZoomButtons.apply(this),e&&(t.disabled=i.disabled=!0,t.setAttribute("aria-disabled","true"),i.setAttribute("aria-disabled","true")),n.disabled=!!e,n.setAttribute("aria-disabled",(!!e).toString())},mapboxGlExports.NavigationControl.prototype.enable=function(){delete this._disabled,this._updateZoomButtons()},mapboxGlExports.NavigationControl.prototype.disable=function(){this._disabled=!0,this._updateZoomButtons()};class Map$1 extends mapboxGlExports.Evented{constructor(e){super();const t=this;e=extend$3({hash:!1,useWebGL2:!0,center:configs.defaultCenter,zoom:configs.defaultZoom,bearing:configs.defaultBearing,pitch:configs.defaultPitch,dataUrl:configs.dataUrl,dataSources:configs.dataSources,clockControl:!0,searchControl:!0,navigationControl:!0,fullscreenControl:!0,modeControl:!0,configControl:!0,trackingMode:configs.defaultTrackingMode,ecoMode:configs.defaultEcoMode,ecoFrameRate:configs.defaultEcoFrameRate},e),t.lang=getLang(e.lang),t.dataUrl=e.dataUrl,t.dataSources=e.dataSources.map((({gtfsUrl:t,vehiclePositionUrl:i,color:n})=>({gtfsUrl:updateOdptUrl(t,e.secrets),vehiclePositionUrl:updateOdptUrl(i,e.secrets),color:n}))),t.container="string"==typeof e.container?document.getElementById(e.container):e.container,t.secrets=e.secrets,t.modelOrigin=mapboxGlExports.MercatorCoordinate.fromLngLat(e.center),t.exitPopups=[],t.clockControl=e.clockControl,t.searchControl=e.searchControl,t.navigationControl=e.navigationControl,t.fullscreenControl=e.fullscreenControl,t.modeControl=e.modeControl,t.configControl=e.configControl,t.clock=new Clock$1,t.plugins=(e.plugins||[]).map((e=>new Plugin(e))),t.searchMode="none",t.viewMode=configs.defaultViewMode,t.trackingMode=e.trackingMode,t.trackingParams={zoom:{},bearing:{},pitch:{}},t.lastCameraParams={},t.initialSelection=e.selection,t.clockMode=configs.defaultClockMode,t.isEditingTime=!1,t.ecoMode=e.ecoMode,t.ecoFrameRate=e.ecoFrameRate,t.lastDynamicUpdate={},t.lastRepaint=0,t.frameRateFactor=1,e.container=initContainer(t.container),e.style="assets/style.json",e.configControl||(e.customAttribution=flat$1([e.customAttribution,configs.customAttribution])),t.map=new mapboxGlExports.Map(e);for(const e of configs.events)t.map.on(e,t.fire.bind(t));t.map.once("idle",(()=>{measureFrameRate().then((e=>{t.frameRateFactor=Math.min(60/e,2)}))}));const i=e.center===configs.defaultCenter?new Promise((e=>{e(t.clock)})):fetchTimezoneOffset(e.center,e.accessToken).then((e=>t.clock.setTimezoneOffset(e)));Promise.all([loadStaticData(t.dataUrl,t.lang,i).then(t.initData.bind(t)).catch((e=>{throw showErrorMessage(t.container),e})),new Promise((e=>{t.map.once("styledata",e)}))]).then(t.initialize.bind(t)),i.then((()=>{t.gtfs=new Map,t.refreshBusData()}))}getMapboxMap(){return this.map}getCenter(){return this.map.getCenter()}setCenter(e){const t=this;return t.trackObject(),t.map.setCenter(e),t}getZoom(){return this.map.getZoom()}setZoom(e){return this.map.setZoom(e),this}getBearing(){return this.map.getBearing()}setBearing(e){const t=this;return t.trackObject(),t.map.setBearing(e),t}getPitch(){return this.map.getPitch()}setPitch(e){return this.map.setPitch(e),this}easeTo(e){const t=this;return void 0===e.center&&void 0===e.bearing||t.trackObject(),t.map.easeTo(e),t}flyTo(e){const t=this;return void 0===e.center&&void 0===e.bearing||t.trackObject(),t.map.flyTo(e),t}jumpTo(e){const t=this;return void 0===e.center&&void 0===e.bearing||t.trackObject(),t.map.jumpTo(e),t}getViewMode(){return this.viewMode}setViewMode(e){const t=this;return t.initialized&&t._setViewMode(e),t}getTrackingMode(){return this.trackingMode}setTrackingMode(e){return this._setTrackingMode(e),this}getSelection(){const e=this.trackedObject;return isVehicle(e)?e.id:isStation(e)?e.stations:void 0}setSelection(e){const t=this,i=removePrefix(e),n=t.stations.get(i);if(n)t.trackObject(t.stationGroupLookup.get(n.group)),delete t.initialSelection;else if(i.match(/NRT|HND/))if(t.flightLoaded){const e=t.activeFlightLookup.get(i);e?t.trackObject(e):showNotification(t.container,t.dict["flight-terminated"]),delete t.initialSelection}else t.initialSelection=i;else if(t.trainLoaded){let e;for(const n of t.timetables.getConnectingTrainIds(i))if(e=t.activeTrainLookup.get(n))break;e?t.trackObject(e):showNotification(t.container,t.dict["train-terminated"]),delete t.initialSelection}else t.initialSelection=i;return t}getClockMode(){return this.clockMode}setClockMode(e){const t=this;return t.initialized&&t._setClockMode(e),t}getEcoMode(){return this.ecoMode}setEcoMode(e){return this._setEcoMode(e),this}addLayer(e,t){const i=this,n=e.type;return"three"===n?new ThreeLayer(e).onAdd(i,t):"geojson"===n?new GeoJsonLayer(e).onAdd(i,t):"tile-3d"===n?(new Tile3DLayer(e).onAdd(i,t),i.layerVisibility.tile3d.set(e.id,"visible"),i.updateLayerVisibility()):i.map.addLayer(e,t||"poi"),i}removeLayer(e){const t=this,i=t.layerVisibility.tile3d;return t.map.removeLayer(e),i.has(e)&&(i.delete(e),t.updateLayerVisibility()),t}setLayerVisibility(e,t){const i=this,{model:n,tile3d:r}=i.layerVisibility;let o=t;return n.has(e)?(n.set(e,t),r.values().some((e=>"visible"===e))&&(o="none")):r.has(e)&&(r.set(e,t),i.updateLayerVisibility()),i.map.setLayoutProperty(e,"visibility",o),i}getModelOrigin(){return this.modelOrigin}getModelScale(){return this.modelOrigin.meterInMercatorCoordinateUnits()}getModelPosition(e,t){const i=this,n=mapboxGlExports.MercatorCoordinate.fromLngLat(e,t);return{x:n.x-i.modelOrigin.x,y:-(n.y-i.modelOrigin.y),z:n.z-i.modelOrigin.z}}hasDarkBackground(){return hasDarkBackground(this.map)}setDataSources(e){const t=this;t.dataSources=e.map((({gtfsUrl:e,vehiclePositionUrl:i,color:n})=>({gtfsUrl:updateOdptUrl(e,t.secrets),vehiclePositionUrl:updateOdptUrl(i,t.secrets),color:n}))),t.refreshBusData()}initData(e){const t=this,i=t.featureLookup=new Map,n=t.stationGroupLookup=new Map;t.dict=e.dict,t.featureCollection=e.featureCollection,t.stations=new Dataset(Station),t.railDirections=new Dataset(RailDirection,e.railDirectionData),t.railways=new Dataset(Railway,e.railwayData,{stations:t.stations,railDirections:t.railDirections}),t.pois=new Dataset(POI,e.poiData),t.stations.load(e.stationData,{stations:t.stations,railways:t.railways,railDirections:t.railDirections,pois:t.pois}),featureEach(t.featureCollection,(e=>{const r=e.properties,{group:o,altitude:s}=r;1===r.type?(i.set(`${o}.${r.zoom}`,e),n.has(o)||n.set(o,{id:o,type:"station",stations:r.ids.map((e=>t.stations.get(e))),layer:0===s?"ground":"underground"})):s<=0||(i.set(r.id,e),updateDistances(e))}));for(const e of t.stations.getAll())if(e.alternate)for(const t of["og","ug"]){const i=e.group.replace(/.g$/,t),r=n.get(i);r&&(r.hidden||(r.hidden=[]),r.hidden.push(e))}t.trainTypes=new Dataset(TrainType,e.trainTypeData),t.trainVehicleTypes=new Dataset(TrainVehicleType,e.trainVehicleData),t.lastTimetableRefresh=t.clock.getTime("03:00"),t.dataReferences={railways:t.railways,stations:t.stations,railDirections:t.railDirections,trainTypes:t.trainTypes,trainVehicleTypes:t.trainVehicleTypes},t.timetables=new TrainTimetables(e.timetableData,t.dataReferences),t.operators=new Dataset(Operator,e.operatorData),t.airports=new Dataset(Airport,e.airportData),t.flightStatuses=new Dataset(FlightStatus,e.flightStatusData),t.activeTrainLookup=new Map,t.standbyTrainLookup=new Map,t.realtimeTrains=new Set,t.adTrains=new Set,t.activeFlightLookup=new Map,t.flightLookup=new Map}initialize(){const e=this,{lang:t,dict:i,clock:n,map:r,container:o,featureCollection:s}=e,a=r.getZoom(),l=e.layerZoom=getLayerZoom(a);r.loaded()?hideLoader(o):r.once("load",(()=>{hideLoader(o)})),e.trafficLayer=new TrafficLayer({id:"traffic"}),r.addLayer({id:"sky",type:"sky",paint:{"sky-opacity":["interpolate",["linear"],["zoom"],0,0,5,.3,8,1],"sky-type":"atmosphere","sky-atmosphere-color":"hsl(220, 100%, 70%)","sky-atmosphere-sun-intensity":20}},"background"),setSunlight(r,n.getTime()),r.setLayoutProperty("poi","text-field",["coalesce",["get",`name_${t}`],["get","name_en"],["get","name"]]);for(const t of[13,14,15,16,17,18]){const i={type:"geojson",lineWidthUnits:"pixels",lineWidthScale:13===t?clamp$3(Math.pow(2,a-12),.125,1):18===t?clamp$3(Math.pow(2,a-19),1,8):1,parameters:{depthTest:!1},minzoom:t<=13?0:t,maxzoom:t>=18?24:t+1};for(const n of["marked","selected"])e.addLayer(Object.assign({},i,{id:`stations-${n}-${t}`,getLineWidth:12,getLineColor:[255,255,255],getFillColor:[255,255,255],visible:!1}),"trees");for(const n of["ug","routeug","routeog"])for(const r of["railways","stations"]){const o="railways"===r?0:1;e.addLayer(Object.assign({},i,{id:`${r}-${n}-${t}`,data:"ug"===n?featureFilter(s,(e=>e.zoom===t&&e.type===o&&e.altitude<0)):emptyFeatureCollection()},{railways:{filled:!1,getLineWidth:e=>e.properties.width,getLineColor:e=>colorToRGBArray(e.properties.color)},stations:{getLineWidth:4,getFillColor:[255,255,255,179]}}[r],{ug:{opacity:.0625,pickable:"stations"===r,metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":.0625,"mt3d:opacity-route":.005,"mt3d:opacity-underground":1,"mt3d:opacity-underground-route":.005}},routeug:{opacity:.0625,metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":.125,"mt3d:opacity-underground":1}},routeog:{metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":1,"mt3d:opacity-underground":.25}}}[n]),"trees")}}r.__deck.props.getCursor=()=>r.getCanvas().style.cursor,r.addSource("odpt",{type:"geojson",data:featureFilter(s,(e=>0===e.altitude))});for(const e of[13,14,15,16,17,18]){const t=["interpolate",["exponential",2],["zoom"]],i=["get","width"],n=["get","color"],o=13===e?[...t,9,["/",i,8],12,i]:18===e?[...t,19,i,22,["*",i,8]]:i;for(const t of["railways","stations","stations-outline"])r.addLayer({id:`${t}-og-${e}`,type:"stations"===t?"fill":"line",source:"odpt",filter:["all",["==",["get","zoom"],e],["==",["get","type"],"railways"===t?0:1]],layout:{visibility:e===l?"visible":"none"},paint:{railways:{"line-color":n,"line-width":o,"line-emissive-strength":1},stations:{"fill-color":n,"fill-opacity":.7,"fill-emissive-strength":1},"stations-outline":{"line-color":["get","outlineColor"],"line-width":o,"line-emissive-strength":1}}[t],metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":1,"mt3d:opacity-route":.1,"mt3d:opacity-underground":.25,"mt3d:opacity-underground-route":.1}},"trees")}e.addLayer(e.trafficLayer,"trees");const c=[],u=[];for(const{id:t,color:i}of e.railways.getAll())c.push({id:t,feature:[13,14,15,16,17,18].map((i=>e.featureLookup.get(`${t}.${i}`)))}),u.push({id:t,color:i});for(const[t,i]of e.featureLookup)i.properties.altitude>0&&c.push({id:t,feature:i});for(const{id:t,color:i}of e.trainVehicleTypes.getAll())u.push({id:t,color:i});for(const{id:t,color:i,tailcolor:n}of e.operators.getAll())u.push({id:t,color:[i,n]});e.trafficLayer.addRouteGroup(c),e.trafficLayer.addColorGroup(u),e.styleOpacities=getStyleOpacities(r,"mt3d:opacity-effect"),e.layerVisibility={model:new Map,tile3d:new Map};for(const{id:t,type:i}of r.getStyle().layers)"model"!==i&&"fill-extrusion"!==i||e.layerVisibility.model.set(t,"visible");const h=createElement$1("datalist",{id:"stations"},document.body),d=e.stationTitleLookup=new Map;for(const i of[t,"en"])for(const t of e.railways.getAll())for(const e of t.stations){const{title:t,utitle:n}=e,r=n&&n[i]||normalize$5(t[i]||t.en),o=r.toUpperCase();d.has(o)||(createElement$1("option",{value:r},h),d.set(o,e))}if(e.searchControl){const t=new SearchControl({title:e.dict.search,placeholder:e.dict["station-name"],list:"stations",eventHandler:({value:t})=>{const i=e.stationTitleLookup.get(t.toUpperCase());if(i&&i.coord)return e.markObject(),e.trackObject(e.stationGroupLookup.get(i.group)),!0}});r.addControl(t)}if(e.navigationControl){const t=e.navControl=new mapboxGlExports.NavigationControl;t._setButtonTitle=function(e){const{_zoomInButton:t,_zoomOutButton:n,_compass:r}=this,o=e===t?i["zoom-in"]:e===n?i["zoom-out"]:e===r?i.compass:"";e.title=o,e.setAttribute("aria-label",o)},r.addControl(t)}if(e.fullscreenControl){const e=new mapboxGlExports.FullscreenControl({container:o});e._updateTitle=function(){const e=this._fullscreenButton,t=i[this._isFullscreen()?"exit-fullscreen":"enter-fullscreen"];e.title=t,e.setAttribute("aria-label",t)},r.addControl(e)}if(e.modeControl){const t=new MapboxGLButtonControl([{className:"mapboxgl-ctrl-underground",title:i["enter-underground"],eventHandler(){e._setViewMode("ground"===e.viewMode?"underground":"ground")}},{className:"mapboxgl-ctrl-playback",title:i["enter-playback"],eventHandler(){e._setClockMode("realtime"===e.clockMode?"playback":"realtime")}},{className:"mapboxgl-ctrl-eco",title:i["enter-eco"],eventHandler(){e._setEcoMode("eco"===e.ecoMode?"normal":"eco")}}]);r.addControl(t)}if(e.layerPanel=new LayerPanel({layers:e.plugins}),e.trackingModePanel=new TrackingModePanel,e.aboutPanel=new AboutPanel,e.configControl&&r.addControl(new MapboxGLButtonControl([{className:"mapboxgl-ctrl-layers",title:i["select-layers"],eventHandler(){e.layerPanel.addTo(e)}},{className:"mapboxgl-ctrl-tracking-mode",title:i["select-tracking-mode"],eventHandler(){e.trackingModePanel.addTo(e)}},{className:"mapboxgl-ctrl-about",title:i.about,eventHandler(){e.aboutPanel.addTo(e)}}])),e.clockControl){const o=e.clockCtrl=new ClockControl({lang:t,dict:i,clock:n});o.on("change",e.onClockChange.bind(e)),r.addControl(o)}r.on("mousemove",(t=>{e.markObject(e.pickObject(t.point))})),r.on("mouseout",(()=>{e.markObject()})),r.on("click",(t=>{const i=e.pickObject(t.point);e.markObject(i),e.trackObject(i)})),r.on("zoom",(t=>{t.tracking||e.updateBaseZoom();const i=r.getZoom(),n=e.layerZoom,o=e.layerZoom=getLayerZoom(i);if(i<13){const e=clamp$3(Math.pow(2,i-12),.125,1);for(const t of["stations-marked-13","stations-selected-13","railways-ug-13","stations-ug-13","railways-routeug-13","stations-routeug-13","railways-routeog-13","stations-routeog-13"])setLayerProps(r,t,{lineWidthScale:e})}else if(i>19){const e=clamp$3(Math.pow(2,i-19),1,8);for(const t of["stations-marked-18","stations-selected-18","railways-ug-18","stations-ug-18","railways-routeug-18","stations-routeug-18","railways-routeog-18","stations-routeog-18"])setLayerProps(r,t,{lineWidthScale:e})}if(n!==o){for(const t of["railways","stations","stations-outline"])e.setLayerVisibility(`${t}-og-${n}`,"none"),e.setLayerVisibility(`${t}-og-${o}`,"visible");for(const{id:t}of e.gtfs.values())for(const i of["busstops","busstops-outline"])n>=14&&e.setLayerVisibility(`${i}-${t}-og-${n}`,"none"),o>=14&&e.setLayerVisibility(`${i}-${t}-og-${o}`,"visible");t.tracking?e.prevLayerZoom=n:delete e.prevLayerZoom}})),r.on("render",(()=>{e.markedObject&&e.updatePopup(),e.updateAdTrainPopup()}));for(const t of e.plugins.slice().reverse())t.addTo(e);animation.init(),animation.start({callback:()=>{const t=e.clock,i=t.getTime(),{minDelay:n,refreshInterval:o,realtimeCheckInterval:s}=configs;if(i-e.lastTimetableRefresh>=864e5&&(e.refreshTrainTimetableData(),e.refreshBusData(!0),e.lastTimetableRefresh=t.getTime("03:00")),Date.now()-e.lastFrameRefresh>=configs.refreshTimeout&&e.stopAll(),e.lastFrameRefresh=Date.now(),Math.floor((i-n)/o)!==Math.floor(e.lastRefresh/o)&&(e.setLayerVisibility("building-models",t.speed<=30?"visible":"none"),setSunlight(r,i),"none"!==e.searchMode||"playback"!==e.clockMode||e.removing||(e.refreshTrains(),e.refreshFlights(),e.refreshBuses(),isStation(e.trackedObject)&&e.detailPanel.updateContent()),e.lastRefresh=i-n),Math.floor((i-n)/s)!==Math.floor(e.lastRealtimeCheck/s)&&("none"!==e.searchMode||"realtime"!==e.clockMode||e.removing||(e.refreshRealtimeTrainData(),e.refreshRealtimeFlightData(),e.refreshRealtimeBusData(),isStation(e.trackedObject)&&e.detailPanel.updateContent()),e.lastRealtimeCheck=i-n),"normal"===e.ecoMode&&r._loaded||Date.now()-e.lastRepaint>=1e3/e.ecoFrameRate){let i;if(e.trafficLayer.setTimeOffset(t.getTimeOffset()),e.markedObject&&isVehicle(e.markedObject)&&(i=e.updateObjectPosition(e.markedObject),void 0!==i.standing&&e.updatePopup({setHTML:!0})),e.trackedObject&&isVehicle(e.trackedObject)&&(e.trackedObject!==e.markedObject&&(i=e.updateObjectPosition(e.trackedObject)),i.viewMode&&e._setViewMode(i.viewMode),!(e.viewAnimationID||r._zooming||r._rotating||r._pitching))){const{coord:t,altitude:i,bearing:n}=e.trackedObject;e._jumpTo({center:t,altitude:i,bearing:n,bearingFactor:.02}),e.markedObject===e.trackedObject&&e.updatePopup()}for(const t of e.adTrains)e.updateObjectPosition(t);isVehicle(e.trackedObject)||e.trackedObject&&e.refreshStationOutline(),r.triggerRepaint(),e.lastRepaint=Date.now()}}}),e.initialized=!0,e.fire({type:"initialized"})}_jumpTo(e){const t=this,{map:i,trackingMode:n,trackingParams:r}=t,o="normal"===t.ecoMode||t.viewAnimationID?t.frameRateFactor:60/t.ecoFrameRate,s=performance.now(),a=i.getZoom(),l=i.getBearing(),c=i.getPitch(),u=i.scrollZoom._active;let h,d,{center:p,altitude:f,bearing:m,easeOutFactor:g,easeInFactor:_,bearingFactor:y}=e;"position"===n?(h=t.baseZoom,m=l,d=c):"helicopter"===n?(h=15,m=r.bearing.fn(s),d=60):"drone"===n?(h=17,m=r.bearing.fn(s),d=75):"bird"===n?(t.updateTrackingParams(),h=r.zoom.fn(s),m=r.bearing.fn(s),d=r.pitch.fn(s)):("front"!==n&&"topfront"!==n||(m=(m+360)%360-180),y>=0&&(y=1-Math.pow(1-y,o),m=l+((m-l+540)%360-180)*y),"back"===n||"front"===n?(h=18.5,d=85):(h=15,d=60));const v=i.getFreeCameraOptions().position.z/Math.cos(c*DEGREE_TO_RADIAN)*Math.pow(2,a-h),x=t.getModelPosition(p,f).z/Math.cos(d*DEGREE_TO_RADIAN);if(h=Math.min(h-Math.log2(Math.max(v+x,0)/v),22),p=t.adjustCoord(p,f,m),g>=0){const e=i.getCenter();g=1-Math.pow(1-g,o),p=new mapboxGlExports.LngLat(lerp$5(e.lng,p.lng,g),lerp$5(e.lat,p.lat,g))}_>=0&&(_=1-Math.pow(1-_,o),h=lerp$5(a,h,_),d=lerp$5(c,d,_)),Math.floor(h+1)-h<1e-6&&(h=Math.floor(h+1)),t.prevLayerZoom===getLayerZoom(h)?h=a:delete t.prevLayerZoom,i.jumpTo({center:p,zoom:h,bearing:m,pitch:d},{tracking:!0}),u&&(i.scrollZoom._active=!0)}refreshTrains(){const e=this,t=e.initialSelection,i=e.clock.getTimeOffset();for(const t of e.timetables.getAll())t.start<=i&&i<=t.end&&!e.standbyTrainLookup.has(t.id)&&e.trainStart(new Train(t));e.trafficLayer.refreshDelayMarkers(),e.trainLoaded=!0,t&&e.setSelection(t)}trainStart(e,t={}){const i=this,n=e.r;i.checkActiveTrains(e)||n.status&&n.dynamic&&!i.realtimeTrains.has(e.id)||n.suspended||i.setSectionData(e,t.index)&&(i.activeTrainLookup.set(e.id,e),i.trafficLayer.addObject(e),i.trainRepeat(e,t.index),t.marked&&i.markObject(e),t.tracked&&i.trackObject(e),e.ad&&i.showAdTrainPopup(e))}trainRepeat(e,t){const i=this,{activeTrainLookup:n,clock:r}=i,o=e.timetable,s=r.getTimeOffset(),a=configs.minStandingDuration;let l;if(o){if(l=!i.setSectionData(e,t),l){const e=o.nt;if(e){let t=!1;for(const{t:i}of e[0].pt){const e=n.get(i);e&&e.arrivalStation&&(t=!0)}if(!t){let t=!1,r=!1;for(const{t:o}of e[0].pt){const e=n.get(o);e&&(i.markedObject===e&&(t=!0),i.trackedObject===e&&(r=!0),i.stopTrain(e))}e.forEach(((e,n)=>{const o=i.standbyTrainLookup.get(e.id)||new Train(e);i.trainStart(o,0===n?{index:0,marked:t,tracked:r}:{index:0})}))}return}}}else l=!i.setSectionData(e,void 0,!i.realtimeTrains.has(e.id));i.markedObject===e&&(e.standing=!0,i.updatePopup({setHTML:!0}));const c=e.sectionLength;if(l||0===c)e.animationID=animation.start({complete:()=>{l?i.stopTrain(e):i.trainRepeat(e)},duration:o?Math.max(e.departureTime-s,a):l?a:configs.realtimeCheckInterval,clock:r});else{const n=e.delay||0,l=configs.minDelay,{departureTime:u,arrivalTime:h,nextDepartureTime:d,sectionIndex:p}=e,f=i.featureLookup.get(`${e.r.id}.18`).properties["station-offsets"],m=Math.abs(f[p+c]-f[p]),g=void 0!==t?Math.max(u+n,s+(1===r.speed?a:0)):void 0!==u?u+n:s;let _,y,v,x,{maxSpeed:b,acceleration:T,maxAccelerationTime:w,maxAccDistance:E}=configs;void 0!==d&&(v=d-a+6e4+n-l-g),void 0!==h&&(y=h+n-l-g,v<y+6e4||(v=y+6e4)),m<=2*E?(_=2*Math.sqrt(m/T),v>0&&(_=clamp$3(_,y||0,v),T=4*m/_/_),x=_/2):(_=2*w+(m-2*E)/b,v>0&&(_=clamp$3(_,y||0,v),E=T*_*_/8,m>=2*E?(b=2*m/_,T=2*b/_):b=T*_/2-Math.sqrt(T*(2*E-m))),x=b/T),i.trafficLayer.updateObject(e,g,_,x,T/m,x,T/m),e.animationID=animation.start({complete:()=>{i.trainRepeat(e,o?e.timetableIndex+1:void 0)},duration:g+_-s,clock:r})}}refreshFlights(){const e=this,t=e.initialSelection,i=e.clock.getTimeOffset();for(const t of e.flightLookup.values())t.entry<=i&&i<=t.end&&e.flightStart(t);e.flightLoaded=!0,t&&e.setSelection(t)}flightStart(e){const t=this,{activeFlightLookup:i,clock:n}=t,r=e.id;if(i.has(r))return;i.set(r,e),t.trafficLayer.addObject(e);const o=n.getTimeOffset(),s=e.feature.properties.length,a=e.maxSpeed,l=e.acceleration>0?e.acceleration:0,c=e.acceleration>0?0:-e.acceleration,u=l>0?a/l:0,h=c>0?a/c:0;t.trafficLayer.updateObject(e,e.start,u/2+s/a+h/2,u,l/s,h,c/s),e.animationID=animation.start({complete:()=>{t.stopFlight(e)},duration:e.end-o,clock:n})}refreshBuses(e){const t=this,i=t.clock.getTimeOffset();for(const n of e?[t.gtfs.get(e)]:t.gtfs.values())for(const e of n.trips.getAll()){const r=e.departureTimes,o=n.routes.get(e.route);if(r[0]<=i&&i<=r[r.length-1]&&!n.activeBusLookup.has(e.id)&&o&&!o.hidden){let i=0;const r=n.featureLookup.get(e.shape);if(!r)continue;const o=e.stops.map((e=>i=nearestCloserPointOnLine(r,n.stops.get(e).coord,i).properties.location));t.busStart(new Bus({gtfsId:n.id,trip:e,feature:r,offsets:o,offset:0}))}}}busStart(e){const t=this;t.setBusSectionData(e)&&(t.gtfs.get(e.gtfsId).activeBusLookup.set(e.trip.id,e),t.trafficLayer.addObject(e),t.busRepeat(e))}busRepeat(e,t){const i=this,n=i.clock,r=n.getTimeOffset(),o=configs.minBusStandingDuration;let s;s=void 0===e.stop?!i.setBusSectionData(e,t):!i.setBusSectionData(e,void 0,!i.gtfs.get(e.gtfsId).realtimeBuses.has(e.trip.id)),i.markedObject===e&&i.updatePopup({setHTML:!0}),i.trackedObject===e&&i.detailPanel&&i.detailPanel.updateHeader();const{offsets:a,sectionIndex:l,sectionLength:c}=e,u=Math.abs(a[l+c]-a[l]);if(!s&&c>0&&u>0){const s=configs.minDelay,{departureTime:a,nextDepartureTime:l}=e,c=void 0!==t?Math.max(a,r+(1===n.speed?o:0)):valueOrDefault(a,r);let h,d,p,{maxBusSpeed:f,busAcceleration:m,maxBusAccelerationTime:g,maxBusAccDistance:_}=configs;void 0!==l&&(d=l-o+6e4-s-c),u<=2*_?(h=2*Math.sqrt(u/m),d>0&&(h=clamp$3(h,0,d),m=4*u/h/h),p=h/2):(h=2*g+(u-2*_)/f,d>0&&(h=clamp$3(h,0,d),_=m*h*h/8,u>=2*_?(f=2*u/h,m=2*f/h):f=m*h/2-Math.sqrt(m*(2*_-u))),p=f/m),i.trafficLayer.updateObject(e,c,h,p,m/u,p,m/u),e.animationID=animation.start({complete:()=>{i.busRepeat(e,void 0===e.stop?e.sectionIndex+1:void 0)},duration:c+h-r,clock:n})}else e.animationID=animation.start({complete:()=>{s?i.stopBus(e):i.busRepeat(e)},duration:void 0===e.stop?Math.max(e.nextDepartureTime-r,o):s?o:configs.realtimeCheckInterval,clock:n})}updateTrackingParams(e){const t=this,{map:i,trackingMode:n,trackingParams:r}=t,o=performance.now();if("bird"===n){const{zoom:n,bearing:s,pitch:a}=r;if(!n.time||e){const e=n.time=[0,o,0,0],i=n.value=[0,t.baseZoom,0,0];for(const[t,n]of[[0,1],[2,1],[3,2]])e[t]=e[n]+Math.sign(t-n)*(1e4*Math.random()+3e4),i[t]=5*Math.random()+15;n.fn=createInterpolant(e,i)}else o>=n.time[2]&&(n.time=n.time.slice(1).concat(n.time[3]+1e4*Math.random()+3e4),n.value=n.value.slice(1).concat(5*Math.random()+15),n.fn=createInterpolant(n.time,n.value));if(!s.time||e){const e=s.time=[0,o,0,0],t=s.value=[0,i.getBearing(),0,0];for(const[i,n]of[[0,1],[2,1],[3,2]])e[i]=e[n]+Math.sign(i-n)*(1e4*Math.random()+4e4),t[i]=360*Math.random()-180;s.fn=createInterpolant(e,t)}else o>=s.time[2]&&(s.time=s.time.slice(1).concat(s.time[3]+1e4*Math.random()+4e4),s.value=s.value.slice(1).concat(360*Math.random()-180),s.fn=createInterpolant(s.time,s.value));if(!a.time||e){const e=a.time=[0,o,0,0],t=a.value=[0,i.getPitch(),0,0];for(const[i,n]of[[0,1],[2,1],[3,2]])e[i]=e[n]+Math.sign(i-n)*(1e4*Math.random()+2e4),t[i]=30*Math.random()+45;a.fn=createInterpolant(e,t)}else o>=a.time[2]&&(a.time=a.time.slice(1).concat(a.time[3]+1e4*Math.random()+2e4),a.value=a.value.slice(1).concat(30*Math.random()+45),a.fn=createInterpolant(a.time,a.value))}else if(delete r.zoom.time,delete r.bearing.time,delete r.pitch.time,"drone"===n){const e=i.getBearing();r.bearing.fn=t=>(e-(t-o)/200)%360}else if("helicopter"===n){const e=i.getBearing();r.bearing.fn=t=>(e+(t-o)/400)%360}}updateHandlersAndControls(){const e=this,{map:t,trackedObject:i,trackingMode:n}=e,r=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate","touchPitch"];if(isVehicle(i)&&"position"!==n){for(const e of r)t[e].disable();e.navControl.disable()}else{for(const e of r)t[e].enable();isVehicle(i)&&"position"===n&&t.dragPan.disable(),e.navControl.enable()}}startViewAnimation(){const e=this;let t=0,i=0;e.viewAnimationID=animation.start({callback:(n,r)=>{const o=e.trackedObject,s=easeOutQuart(n/r),a=1-(1-s)/(1-t),l=easeInQuad(n/r);e._jumpTo({center:o.coord,altitude:o.altitude,bearing:o.bearing,easeOutFactor:a,easeInFactor:1-(1-l)/(1-i),bearingFactor:a}),t=s,i=l},complete:()=>{delete e.viewAnimationID},duration:1e3})}stopViewAnimation(){const e=this;e.viewAnimationID&&(animation.stop(e.viewAnimationID),delete e.viewAnimationID)}adjustCoord(e,t,i){if(!t)return mapboxGlExports.LngLat.convert(e);const{map:n,trafficLayer:r}=this;if(!isNaN(i)){const r=mapboxGlExports.MercatorCoordinate.fromLngLat(e,t),o=r.z*Math.tan(n.getPitch()*DEGREE_TO_RADIAN),s=r.x+o*Math.sin(i*DEGREE_TO_RADIAN),a=r.y-o*Math.cos(i*DEGREE_TO_RADIAN);return new mapboxGlExports.MercatorCoordinate(s,a,0).toLngLat()}return n.unproject(r.project(e,t))}getLocalizedRailwayTitle(e){const t=(e||{}).title||{};return t[this.lang]||t.en}getLocalizedTrainNameOrRailwayTitle(e,t){const i=this;return e?e.map((e=>e[i.lang]||e.en)).join(i.dict.and):i.getLocalizedRailwayTitle(t)}getLocalizedTrainTypeTitle(e){const t=(e||{}).title||{};return t[this.lang]||t.en}getLocalizedStationTitle(e){const t=this;return(Array.isArray(e)?e:[e]).map((e=>{const i=(e||{}).title||{};return i[t.lang]||i.en})).join(t.dict.and)}getLocalizedRailDirectionTitle(e){const t=(e||{}).title||{};return t[this.lang]||t.en}getLocalizedDestinationTitle(e,t){const i=this;return e?i.dict.for.replace("$1",i.getLocalizedStationTitle(e)):i.getLocalizedRailDirectionTitle(t)}getLocalizedOperatorTitle(e){const t=(e||{}).title||{};return t[this.lang]||t.en}getLocalizedAirportTitle(e){const t=(e||{}).title||{};return t[this.lang]||t.en}getLocalizedFlightStatusTitle(e){const t=(e||{}).title||{};return t[this.lang]||t.en}getLocalizedPOITitle(e){const t=(e||{}).title||{};return t[this.lang]||t.en}getLocalizedPOIDescription(e){const t=(e||{}).description||{};return t[this.lang]||t.en}getTrainDescription(e){const t=this,{lang:i,dict:n}=t,{r:r,ad:o,departureTime:s,arrivalStation:a}=e,l=o&&o.color||(e.v||r).color,c=e.delay||0,u=valueOrDefault(e.arrivalTime,e.nextDepartureTime),h=r.status;return['<div class="desc-header">',Array.isArray(l)?["<div>",...l.slice(0,3).map((e=>`<div class="line-strip" style="background-color: ${e};"></div>`)),"</div>"].join(""):`<div style="background-color: ${l};"></div>`,"<div><strong>",t.getLocalizedTrainNameOrRailwayTitle(e.nm,r),"</strong>",`<br> <span class="train-type-label">${t.getLocalizedTrainTypeTitle(e.y)}</span> `,t.getLocalizedDestinationTitle(e.ds,e.d),"</div></div>",`<strong>${n["train-number"]}:</strong> ${e.n}`,e.timetable?"":` <span class="desc-caution">${n.special}</span>`,"<br>",o?`<span class="desc-ad-cars" style="color: ${o.textcolor};">${o.description[i]}</span><br>`:"",c>=6e4?'<span class="desc-caution">':"","<strong>",n[e.standing?"standing-at":"previous-stop"],":</strong> ",t.getLocalizedStationTitle(e.departureStation),void 0!==s?` ${getTimeString(s+c)}`:"",a?[`<br><strong>${n["next-stop"]}:</strong> `,t.getLocalizedStationTitle(a),void 0!==u?` ${getTimeString(u+c)}`:""].join(""):"",c>=6e4?`<br>${n.delay.replace("$1",Math.floor(c/6e4))}</span>`:"",h&&"ja"===i?`<br><span class="desc-caution"><strong>${h}:</strong> ${r.text}</span>`:""].join("")}getFlightDescription(e){const t=this,i=t.dict,{a:n,n:r,ds:o}=e,s=n.tailcolor||"#FFFFFF",a=valueOrDefault(e.sdt,e.sat),l=valueOrDefault(e.edt,e.eat),c=valueOrDefault(e.adt,e.aat),u=(void 0!==l||void 0!==c)&&a!==valueOrDefault(l,c);return['<div class="desc-header">',`<div style="background-color: ${s};"></div>`,`<div><strong>${t.getLocalizedOperatorTitle(n)}</strong>`,`<br>${r[0]} `,i[o?"to":"from"].replace("$1",t.getLocalizedAirportTitle(o||e.or)),"</div></div>",`<strong>${i.status}:</strong> ${t.getLocalizedFlightStatusTitle(e.s)}`,"<br><strong>",i[o?"scheduled-departure-time":"scheduled-arrival-time"],`:</strong> ${getTimeString(a)}`,u?'<span class="desc-caution">':"",void 0!==l?["<br><strong>",i[o?"estimated-departure-time":"estimated-arrival-time"],`:</strong> ${getTimeString(l)}`].join(""):void 0!==c?["<br><strong>",i[o?"actual-departure-time":"actual-arrival-time"],`:</strong> ${getTimeString(c)}`].join(""):"",u?"</span>":"",r.length>1?`<br><strong>${i["code-share"]}:</strong> ${r.slice(1).join(" ")}`:""].join("")}getBusDescription(e){const t=this.dict,i=this.gtfs.get(e.gtfsId),n=i.stops,{route:r,headsigns:o,stops:s}=e.trip,{shortName:a,longName:l,color:c,textColor:u}=i.routes.get(r),h=[u?`color: ${u};`:"",c?`background-color: ${c};`:""].join(" "),d=e.sectionIndex+(e.standing?0:e.sectionLength),p=n.get(s[d]).name,f=Math.max(0,d-1),m=n.get(s[f]).name;return['<div class="desc-header">',`<div style="background-color: ${i.color};"></div>`,`<div><strong>${i.agency}</strong>`,void 0!==e.stop?'<span class="realtime-small-icon"></span>':"","<br>",a||l?` <span class="bus-route-label" style="${h}">${a||l}</span> `:"",0===o.length?l:o[1===o.length?0:f],"</div></div>",e.id?`<strong>${t["vehicle-number"]}:</strong> ${e.id}<br>`:"",`<strong>${t["previous-busstop"]}:</strong> ${m}<br>`,`<strong>${t["next-busstop"]}:</strong> ${p}`].join("")}checkActiveTrains(e){const t=this;function i(e,n){const r=t.activeTrainLookup.get(e.t);if(r&&e.id===r.timetable.id)return!0;const o=e[n];if(o)for(const e of o)if(i(e,n))return!0;return!1}return!!e.timetable&&(i(e.timetable,"pt")||i(e.timetable,"nt"))}stopTrain(e){const t=this;return animation.stop(e.animationID),t.hideAdTrainPopup(e),e===t.markedObject&&t.markObject(),e===t.trackedObject&&t.trackObject(),t.activeTrainLookup.delete(e.id),t.trafficLayer.removeObject(e)}stopFlight(e){const t=this;return animation.stop(e.animationID),e===t.markedObject&&t.markObject(),e===t.trackedObject&&t.trackObject(),t.activeFlightLookup.delete(e.id),t.trafficLayer.removeObject(e)}stopBus(e){const t=this;return animation.stop(e.animationID),e===t.markedObject&&t.markObject(),e===t.trackedObject&&t.trackObject(),t.gtfs.get(e.gtfsId).activeBusLookup.delete(e.trip.id),t.trafficLayer.removeObject(e)}stopAll(){const e=this,t=[];for(const i of e.activeTrainLookup.values())t.push(e.stopTrain(i));e.standbyTrainLookup.clear(),e.realtimeTrains.clear(),e.adTrains.clear();for(const i of e.activeFlightLookup.values())t.push(e.stopFlight(i));for(const{activeBusLookup:i,realtimeBuses:n}of e.gtfs.values()){for(const n of i.values())t.push(e.stopBus(n));n.clear()}e.removing=!0,Promise.all(t).then((()=>{delete e.removing,delete e.lastRefresh,delete e.lastRealtimeCheck}))}resetRailwayStatus(){for(const e of this.railways.getAll())delete e.status,delete e.text,delete e.suspended}refreshTrainTimetableData(){const e=this;showLoader(e.container),e.timetables.clear(),loadTimetableData(e.dataUrl,e.clock).then((t=>{e.timetables=new TrainTimetables(t,e.dataReferences),delete e.lastRefresh,delete e.lastRealtimeCheck,hideLoader(e.container)}))}refreshBusData(e){const t=this,i=t.map,n=new Set(t.dataSources.map((({gtfsUrl:e})=>e))),r=({id:e,activeBusLookup:n,layerIds:r,routeGroupIndex:o,colorGroupIndex:s})=>{const a=t.styleOpacities,l=[];for(const e of r){t.removeLayer(e);for(let t=0,i=a.length;t<i;t++)if(a[t].id===e){a.splice(t,1);break}}i.removeSource(e);for(const e of n.values())l.push(t.stopBus(e));return t.gtfs.delete(e),Promise.all(l).then((()=>{t.trafficLayer.removeRouteGroup(o),t.trafficLayer.removeColorGroup(s)}))};for(const[e,i]of t.gtfs)n.has(e)||r(i);for(const n of t.dataSources){const o=n.gtfsUrl;t.gtfs.has(o)&&!e||loadBusData(n,t.clock,t.lang).then((e=>t.initialized?e:new Promise((i=>{t.once("initialized",(()=>i(e)))})))).then((e=>t.gtfs.has(o)?r(t.gtfs.get(o)).then((()=>e)):e)).then((e=>{const{agency:r,featureCollection:s,version:a}=e,l=new Map,c=new Set,u=[];featureEach(s,(e=>{const t=e.properties;0===t.type&&(l.set(t.id,e),u.push({id:`${o}.${t.id}`,feature:e}))})),t.gtfs.set(o,{id:o,agency:r,version:a,featureLookup:l,stops:new Dataset(GTFSStop,e.stops),routes:new Dataset(GTFSRoute,e.routes),trips:new Dataset(GTFSTrip,e.trips),layerIds:c,activeBusLookup:new Map,realtimeBuses:new Set,vehiclePositionUrl:n.vehiclePositionUrl,color:n.color,routeGroupIndex:t.trafficLayer.addRouteGroup(u),colorGroupIndex:t.trafficLayer.addColorGroup([{id:o,color:n.color}])}),i.addSource(o,{type:"geojson",data:s,promoteId:"id"});for(const e of["busroute","busroute-highlighted"]){const i="busroute"===e?["get","width"]:["*",["get","width"],4];t.addLayer({id:`${e}-${o}-og-`,type:"line",source:o,filter:["==",["get","type"],0],paint:{"line-color":{busroute:["get","color"],"busroute-highlighted":["string",["feature-state","route-highlight"],["feature-state","trip-highlight"],["get","color"]]}[e],"line-opacity":{busroute:["case",["to-boolean",["feature-state","hidden"]],0,1],"busroute-highlighted":["case",["all",["any",["to-boolean",["feature-state","route-highlight"]],["to-boolean",["feature-state","trip-highlight"]]],["!",["to-boolean",["feature-state","hidden"]]]],1,0]}[e],"line-width":["interpolate",["exponential",2],["zoom"],11,["/",i,2],12,i,19,i,22,["*",i,8]],"line-emissive-strength":1},metadata:{busroute:{"mt3d:opacity-effect":!0,"mt3d:opacity":1,"mt3d:opacity-route":.1,"mt3d:opacity-underground":0,"mt3d:opacity-underground-route":0},"busroute-highlighted":{"mt3d:opacity-effect":!0,"mt3d:opacity":1,"mt3d:opacity-route":.1,"mt3d:opacity-underground":.25,"mt3d:opacity-underground-route":.1}}[e]},"railways-og-13"),c.add(`${e}-${o}-og-`)}for(const e of[14,15,16,17,18]){const i=["get","width"],n=18===e?[...["interpolate",["exponential",2],["zoom"]],19,i,22,["*",i,8]]:i;for(const i of["busstops","busstops-outline"])t.addLayer({id:`${i}-${o}-og-${e}`,type:"busstops"===i?"fill":"line",source:o,filter:["all",["==",["get","zoom"],e],["==",["get","type"],1]],layout:{visibility:e===t.layerZoom?"visible":"none"},paint:{busstops:{"fill-color":["get","color"],"fill-opacity":.7,"fill-emissive-strength":1},"busstops-outline":{"line-color":["get","outlineColor"],"line-width":n,"line-emissive-strength":1}}[i],metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":1,"mt3d:opacity-route":.1,"mt3d:opacity-underground":.25,"mt3d:opacity-underground-route":.1}},"railways-og-13"),c.add(`${i}-${o}-og-${e}`)}t.addLayer({id:`busstops-poi-${o}`,type:"symbol",source:o,filter:["==",["get","type"],2],layout:{"text-field":["get","name"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-max-width":9,"text-padding":2,"text-size":12,"text-anchor":"bottom","text-offset":[0,-1]},paint:{"text-color":"rgba(102,102,102,1)","text-halo-blur":.5,"text-halo-color":"rgba(255,255,255,1)","text-halo-width":1},minzoom:14}),c.add(`busstops-poi-${o}`);const h=t.styleOpacities,d=new Set(h.map((({id:e})=>e)));for(const e of getStyleOpacities(i,"mt3d:opacity-effect"))d.has(e.id)||h.push(e);t.refreshMap(),"none"===t.searchMode&&("playback"===t.clockMode?t.refreshBuses(o):"realtime"===t.clockMode&&t.refreshRealtimeBusData(o))}))}t.updateBusRouteVisibility()}refreshRealtimeTrainData(){const e=this;loadDynamicTrainData(e.secrets).then((({trainData:t,trainInfoData:i})=>{const{activeTrainLookup:n,standbyTrainLookup:r,realtimeTrains:o,dataReferences:s}=e,a=e.clock.getTimeOffset();e.resetRailwayStatus();for(const t of i){const i=e.railways.get(t.railway),n=t.status;i&&n&&n.ja&&(i.status=n.ja,i.text=t.text.ja),t.suspended&&(i.suspended=!0)}r.clear(),o.clear();for(const i of t){const{id:t,r:l,n:c,y:u,d:h,os:d,ds:p,ts:f,fs:m,v:g,ad:_,delay:y,carComposition:v}=i,x=t.replace(".Marunouchi.",".MarunouchiBranch.");e.lastDynamicUpdate[i.o]=i.date,o.add(i.id);const b=n.get(t)||n.get(x);let T,w;if(b){if(!(u&&u!==b.y.id||d&&b.os&&d[0]!==b.os[0].id||p&&b.ds&&p[0]!==b.ds[0].id||g&&g!==(b.v||{}).id||_&&!b.ad||!isNaN(v)&&v!==b.carComposition||!isNaN(y)&&y!==b.delay)){b.timetable||b.update({ts:f,fs:m},s);continue}T=e.markedObject===b,w=e.trackedObject===b,e.stopTrain(b)}let E=e.timetables.getByTrainId(t);if(0===E.length&&(E=e.timetables.getByTrainId(x)),0===E.length)l&&(l===RAILWAY_NAMBOKU&&(d[0].startsWith(RAILWAY_MITA)||p[0].startsWith(RAILWAY_MITA))||l!==RAILWAY_ARAKAWA&&e.trainStart(new Train({id:t,r:l,n:c,y:u,d:h,os:d,ds:p,ts:f,fs:m,delay:y,carComposition:v},s)));else for(const t of E){const i=new Train(t);i.update({y:u,os:d,ds:p,v:g,ad:_,delay:y,carComposition:v},s),t.start+(y||0)<=a&&a<=t.end+(y||0)?e.trainStart(i,{marked:T,tracked:w}):r.set(t.id,i)}}for(const t of n.values()){const i=t.r;((i.status&&i.dynamic||!t.timetable)&&!o.has(t.id)||i.suspended)&&e.stopTrain(t)}e.refreshTrains(),e.aboutPanel.updateContent()})).catch((t=>{e.refreshTrains()}))}refreshRealtimeFlightData(){const e=this;loadDynamicFlightData(e.secrets).then((({atisData:t,flightData:i})=>{const n=e.flightLookup,{landing:r,departure:o}=t,s=[r.join("/"),o.join("/")].join(" "),a={},l={};let c={},u={},h=!0;if(e.flightPattern!==s){e.flightPattern=s,e.lastFlightPatternChanged=Date.now();for(const t of e.activeFlightLookup.values())e.stopFlight(t)}includes(r,["R16L","R16R"])?(c={S:"R16L",N:"R16R"},u={S:"22",N:"16R"},h=!1):includes(r,["L22","L23"])?(c={S:"L23",N:"L22"},u={S:"O16R",N:"16L"},h=!1):includes(r,["I16L","I16R"])?(c={S:"I16L",N:"I16R"},u={S:"22",N:"16R"},h=!1):includes(r,["I22","I23"])?(c={S:"I23",N:"I22"},u={S:"16R",N:"16L"},h=!1):includes(r,["I34L","H34R"])?(c={S:"IX34L",N:"H34R"},u={S:"05",N:"34R"},h=!0):includes(r,["I34L","I34R"])?(c={S:"IZ34L",N:"H34R"},u={S:"05",N:"34R"},h=!0):1!==r.length||(includes(r,"I23")?(c={S:"IY23",N:"IY23"},h=!1):includes(r,"L23")?(c={S:"LY23",N:"LY23"},h=!1):includes(r,"I34L")?(c={S:"IX34L",N:"IX34L"},h=!0):includes(r,"I34R")?(c={S:"IY34R",N:"IY34R"},h=!0):includes(r,"L22")&&(c={S:"L22",N:"L22"},h=!1),includes(o,"16L")?u={S:"N16L",N:"N16L"}:includes(o,"05")?u={S:"N05",N:"N05"}:includes(o,"16R")&&(u={S:"16R",N:"16R"}));for(const e of i)if(includes(AIRLINES_FOR_ANA_CODE_SHARE,e.a)){const{dp:t,ds:i,sdt:n,or:r,ar:o,sat:s}=e;a[`${t||r}.${i||o}.${n||s}`]=e}for(const t of i){const{id:i,n:r,dp:o,ds:s,sdt:d,or:p,ar:f,sat:m}=t;let g=n.get(i),_=t.s,{maxFlightSpeed:y,flightAcceleration:v}=configs;if(i.match(/NH\d{4}$/)){const e=a[`${o||p}.${s||f}.${d||m}`];if(e){e.n.push(...r);continue}}if(!g){if(includes(["Cancelled","PostponedTomorrow"],_))continue;const a=e.airports.get(s||p),l=a?a.direction:"S",d="NRT"===o?`NRT.${h?"34L":"16R"}.Dep`:"NRT"===f?`NRT.${h?"34R":"16L"}.Arr`:"HND"===o?`HND.${u[l]}.Dep`:"HND"===f?`HND.${c[l]}.Arr`:void 0,m=e.featureLookup.get(d);if(!m)continue;g=new Flight({id:i,n:r,a:t.a,dp:o,ar:f,ds:s,or:p},{airports:e.airports,operators:e.operators}),g.runway=d.replace(/^([^.]+\.)[A-Z]*([^.]+).+/,"$1$2"),g.feature=m,n.set(g.id,g)}g.update({edt:t.edt,adt:t.adt,sdt:d,eat:t.eat,aat:t.aat,sat:m});const x=valueOrDefault(g.edt,valueOrDefault(g.adt,g.sdt)),b=valueOrDefault(g.eat,valueOrDefault(g.aat,g.sat));void 0===b||_?void 0===x||_&&"CheckIn"!==_&&"NowBoarding"!==_&&"FinalCall"!==_&&"BoardingComplete"!==_&&"Departed"!==_||(x<g.sdt?_="NewTime":x>g.sdt?_="Delayed":x===g.sdt&&(_="OnTime")):b<g.sat?_="NewTime":b>g.sat?_="Delayed":b===g.sat&&(_="OnTime"),g.update({s:_},{flightStatuses:e.flightStatuses}),void 0!==b&&(y/=2,v/=-2);const T=y/Math.abs(v)/2+g.feature.properties.length/y,w=configs.standingDuration;x?(g.start=g.base=x,g.entry=g.start-w,g.end=g.start+T):(g.start=g.entry=b-T,g.base=g.start+T-w,g.end=g.start+T+w),g.maxSpeed=y,g.acceleration=v;(l[g.runway]=l[g.runway]||[]).push(g),e.lastDynamicUpdate[t.o]=t.date}for(const e of Object.keys(l)){const t=l[e];let i=0;t.sort(((e,t)=>e.base-t.base));for(const e of t){const t=e.base,n=Math.max(t,i+configs.minFlightInterval)-t;n&&(e.start+=n,e.base+=n,e.entry+=n,e.end+=n),i=e.base}}e.refreshFlights(),e.aboutPanel.updateContent()})).catch((t=>{e.refreshFlights()}))}refreshRealtimeBusData(e){const t=this;for(const i of e?[t.gtfs.get(e)]:t.gtfs.values()){const{id:e,vehiclePositionUrl:n,featureLookup:r,stops:o,routes:s,trips:a,activeBusLookup:l,realtimeBuses:c}=i;n?loadDynamicBusData(n).then((n=>{c.clear(),i.date=t.clock.getString(1e3*n.header.timestamp);for(const{id:i,vehicle:u}of n.entity){if(!u)continue;const n=u.vehicle,h=u.currentStopSequence,d=u.position,p=u.trip&&u.trip.tripId;if(!h&&!d||!p)continue;c.add(p);const f=a.get(p),m=f&&r.get(f.shape),g=f&&s.get(f.route);if(!f||!m||!g||g.hidden)continue;const _=l.has(p);let y;if(_)y=l.get(p);else{let t=0;const r=f.stops.map((e=>t=nearestCloserPointOnLine(m,o.get(e).coord,t).properties.location));y=new Bus({id:n?n.licensePlate||n.id:i,gtfsId:e,trip:f,feature:m,offsets:r,offset:0})}if(h)y.stop=h;else{const e=y.offsets,t=y.offset=nearestCloserPointOnLine(m,[d.longitude,d.latitude],y.offset).properties.location;y.stop=f.stopSequences[e.reduce(((i,n,r)=>n<t?Math.min(r+1,e.length-1):i),0)]}_||t.busStart(y)}t.aboutPanel.updateContent()})).catch((e=>{})):t.refreshBuses(e)}}updateUndergroundButton(e){const{container:t,dict:i}=this,n=t.querySelector(".mapboxgl-ctrl-underground");if(n){const t=n.classList;"underground"===e?(n.title=i["exit-underground"],t.add("mapboxgl-ctrl-underground-visible")):(n.title=i["enter-underground"],t.remove("mapboxgl-ctrl-underground-visible"))}}updatePlaybackButton(e){const{container:t,dict:i}=this,n=t.querySelector(".mapboxgl-ctrl-playback");if(n){const t=n.classList;"playback"===e?(n.title=i["exit-playback"],t.add("mapboxgl-ctrl-playback-active")):(n.title=i["enter-playback"],t.remove("mapboxgl-ctrl-playback-active"))}}updateEcoButton(e){const{container:t,dict:i}=this,n=t.querySelector(".mapboxgl-ctrl-eco");if(n){const t=n.classList;"eco"===e?(n.title=i["exit-eco"],t.add("mapboxgl-ctrl-eco-active")):(n.title=i["enter-eco"],t.remove("mapboxgl-ctrl-eco-active"))}}refreshMap(){const e=this,{viewMode:t,searchMode:i}=e,n="mt3d:opacity"+("underground"===t?"-underground":"");setStyleOpacities(e.map,e.styleOpacities,"none"===i||"edit"===i?n:[`${n}-route`,n]),e.trafficLayer.setMode(t,i)}updateLayerVisibility(){const e=this,t=e.layerVisibility,i=t.tile3d.values().some((e=>"visible"===e));for(const[n,r]of t.model.entries())e.map.setLayoutProperty(n,"visibility",i?"none":r)}_setSearchMode(e){const t=this;if(t.searchMode!==e){t.searchMode=e,t.stopAll();for(const i of t.plugins)i.setVisibility("none"===e);t.refreshMap()}}_setViewMode(e){const t=this;t.viewMode!==e&&(t.updateUndergroundButton(e),t.viewMode=e,t.refreshMap(),t.fire({type:"viewmode",mode:e}))}_setTrackingMode(e){const t=this;t.trackingMode!==e&&(t.trackingMode=e,isVehicle(t.trackedObject)&&(t.updateBaseZoom(),t.updateTrackingParams(!0),t.updateHandlersAndControls(),t.startViewAnimation()),t.fire({type:"trackingmode",mode:e}))}_setClockMode(e){const t=this;t.clockMode!==e&&(t.updatePlaybackButton(e),t.clockMode=e,t.clock.reset(),t.onClockChange(),t.clockControl&&t.clockCtrl.setMode(e),"playback"===e&&t.resetRailwayStatus(),t.fire({type:"clockmode",mode:e}))}_setEcoMode(e){const t=this;t.ecoMode!==e&&(t.updateEcoButton(e),t.ecoMode=e,t.fire({type:"ecomode",mode:e}))}onClockChange(){const e=this,t=e.clock.getTime("03:00");e.stopAll(),e.markObject(),e.trackObject(),e.lastTimetableRefresh!==t&&(e.refreshTrainTimetableData(),e.lastTimetableRefresh=t)}getLightColor(){return getSunlightColor(this.map,this.clock.getTime())}pickObject(e){const t=this,{map:i,layerZoom:n}=t,r=["ground","underground"];let o;"underground"===t.viewMode&&r.reverse();for(const s of r){if(o=t.trafficLayer.pickObject(s,e),o)return o;if(o="ground"===s?i.queryRenderedFeatures(e,{layers:[`stations-og-${n}`]})[0]:pickObject(i,`stations-ug-${n}`,e),o)return t.stationGroupLookup.get(o.properties.group)}}markObject(e){const t=this,{markedObject:i,trafficLayer:n,map:r,popup:o}=t;isEqualObject(i,e)||(i&&(delete t.markedObject,isVehicle(i)?(n.markObject(),"bus"===i.type&&t.updateBusTripHighlight(i)):t.removeStationOutline("stations-marked"),o&&o.isOpen()&&(r.getCanvas().style.cursor="",o.remove())),e&&(t.markedObject=e,isVehicle(e)?(t.updateObjectPosition(e),n.markObject(e),"bus"===e.type&&t.updateBusTripHighlight(e)):t.addStationOutline(e,"stations-marked"),r.getCanvas().style.cursor="pointer",t.popup=new Popup$1({className:isTouchDevice()?"popup-object popup-touch":"popup-object",closeButton:!1,closeOnClick:!1,maxWidth:"300px",offset:{top:[0,10],bottom:[0,-30]},openingAnimation:{duration:300,easing:"easeOutBack"}}),t.updatePopup({setHTML:!0,addToMap:!0})),t.updateAdTrainPopup(),r.triggerRepaint())}trackObject(e){const t=this,{searchMode:i,lang:n,map:r,trackedObject:o,trafficLayer:s,lastCameraParams:a,sharePanel:l,detailPanel:c}=t;if("edit"===i&&c&&isStation(e)){const{title:t,utitle:i}=e.stations[0],r=i&&i[n]||normalize$5(t[n]||t.en);c.fillStationName(r)}else if(isEqualObject(o,e))(isVehicle(e)||isStation(e))&&c&&c.reset();else if(!o&&e?(a.viewMode=t.getViewMode(),delete a.center,a.zoom=r.getZoom(),a.bearing=r.getBearing(),a.pitch=r.getPitch()):o&&!e&&(t._setViewMode(a.viewMode),r.flyTo({center:a.center||r.getCenter(),zoom:a.zoom,bearing:a.bearing,pitch:a.pitch})),o&&(delete t.trackedObject,isVehicle(o)?(s.trackObject(),"bus"===o.type&&t.updateBusTripHighlight(o),t.fire({type:"deselection",deselection:o.id})):isStation(o)?(t.removeStationOutline("stations-selected"),t.fire({type:"deselection",deselection:o.stations.map((({id:e})=>e))}),t._setSearchMode("none"),t.hideStationExits()):t.fire(Object.assign({type:"deselection"},o)),t.updateHandlersAndControls(),t.stopViewAnimation(),l&&(l.remove(),delete t.sharePanel),c&&(c.remove(),delete t.detailPanel)),e)if(t.trackedObject=e,isVehicle(e))t.updateObjectPosition(e),t.updateBaseZoom(),t.updateTrackingParams(!0),t.updateHandlersAndControls(),t.startViewAnimation(),t._setViewMode(e.altitude<0?"underground":"ground"),includes(["train","flight"],e.type)&&"realtime"===t.clockMode&&navigator.share&&(t.sharePanel=new SharePanel({object:e}),t.sharePanel.addTo(t)),e.timetable?(t.detailPanel=new TrainPanel({object:e}),t.detailPanel.addTo(t)):e.trip&&(t.detailPanel=new BusPanel({object:e}),t.detailPanel.addTo(t)),s.trackObject(e),"bus"===e.type&&t.updateBusTripHighlight(e),t.fire({type:"selection",selection:e.id});else if(isStation(e)){const i=e.stations.concat(e.hidden||[]),n=i.map((e=>e.coord)),o=a.center=getBounds$1(n).getCenter();if("ground"===e.layer)t._setViewMode("ground");else if(r.getCenter().distanceTo(o)){let e=r.getZoom();const i=e,n=()=>{const n=r.getZoom();n<e&&n<i-.5?t._setViewMode("ground"):n>e&&n>15&&t._setViewMode("underground"),e=n};r.on("zoom",n),r.once("zoomend",(()=>{t._setViewMode("underground"),r.off("zoom",n)}))}else t._setViewMode("underground");r.flyTo({center:o,zoom:15.5}),t.detailPanel=new StationPanel({object:i}),t.detailPanel.addTo(t),t.addStationOutline(e,"stations-selected"),t.fire({type:"selection",selection:e.stations.map((({id:e})=>e))})}else t.fire(Object.assign({type:"selection"},e))}updateObjectPosition(e){const{altitude:t,standing:i}=e,{coord:n,altitude:r,bearing:o,_t:s}=this.trafficLayer.getObjectPosition(e);let a,l;return e.coord=n,e.altitude=r,e.bearing=o,e._t=s,e.standing=0===s||1===s,t<0&&r>=0?a="ground":t>=0&&r<0&&(a="underground"),i&&!e.standing&&(l=e.standing),{viewMode:a,standing:l}}showAdTrainPopup(e){const t=this,i=t.adTrains;if(i.has(e))return;const n=e.ad;e.popup=new Popup$1({className:"popup-ad-cars",closeButton:!1,closeOnClick:!1,offset:{top:[0,10],bottom:[0,-30]}}),e.popup.setHTML(`<span style="color: ${n.textcolor};">${n.title[t.lang]}</span>`),i.add(e),t.updateObjectPosition(e),t.updateAdTrainPopup()}updateAdTrainPopup(){const e=this,t=e.markedObject;for(const i of e.adTrains)i.popup.setLngLat(e.adjustCoord(i.coord,i.altitude)),i===t||i.popupVisible?i===t&&i.popupVisible&&(i.popup.remove(),delete i.popupVisible):(i.popup.addTo(e.map),i.popupVisible=!0)}hideAdTrainPopup(e){const t=this.adTrains;t.has(e)&&e.popup&&(e.popup.remove(),delete e.popup,delete e.popupVisible,t.delete(e))}showStationExits(e){const t=this,i=t.map,n=[].concat(...e.map((e=>e.exit||[])));if(n.length>0){const e=[];t.exitPopups=n.map(((r,o)=>{const{coord:s,facilities:a=[]}=r,l=a.map((e=>`<span class="exit-${e}-small-icon"></span>`)).join(""),c=()=>{t.exitPopups[o]=setTimeout((()=>{const e=new Popup$1({className:"popup-exit",closeButton:!1,closeOnClick:!1});e.setLngLat(s).setHTML(l+t.getLocalizedPOITitle(r)).addTo(i).getElement().id=`exit-${o}`,t.exitPopups[o]=e}),o/n.length*1e3)};return i.once("moveend",c),e.push(s),c})),i.fitBounds(getBounds$1(e),{bearing:i.getBearing(),pitch:i.getPitch(),offset:[0,-i.transform.height/12],padding:{top:20,bottom:20,left:10,right:50},maxZoom:18})}}hideStationExits(){const e=this;for(const t of e.exitPopups)t instanceof Popup$1?t.remove():"function"==typeof t?e.map.off("moveend",t):clearTimeout(t);e.exitPopups=[]}updateBaseZoom(){const e=this,{map:t,trackedObject:i}=e;if(isVehicle(i)){const n=e.getModelPosition(i.coord,i.altitude).z,r=t.getFreeCameraOptions().position.z;e.baseZoom=t.getZoom()+Math.log2(r/Math.abs(r-n))}}updatePopup(e){const t=this,{markedObject:i,map:n,popup:r}=t,{setHTML:o,addToMap:s}=e||{};if(isVehicle(i)){const e=i===t.trackedObject?n.getBearing():void 0;r.setLngLat(t.adjustCoord(i.coord,i.altitude,e)),o&&r.setHTML("train"===i.type?t.getTrainDescription(i):"flight"===i.type?t.getFlightDescription(i):t.getBusDescription(i))}else{const e=t.featureLookup.get(`${i.id}.${t.layerZoom}`),n=getCenterCoord(e),s=getAltitude(e);if(r.setLngLat(t.adjustCoord(n,s)),o){const e=i.stations,n={};for(const i of e){const e=t.getLocalizedStationTitle(i),r=i.railway;(n[e]=n[e]||{})[t.getLocalizedRailwayTitle(r)]=r.color}r.setHTML(['<div class="thumbnail-image-container">','<div class="ball-pulse"><div></div><div></div><div></div></div>',`<div class="thumbnail-image" style="background-image: url('${e[0].thumbnail}');"></div>`,"</div>",'<div class="railway-list">',Object.keys(n).map((e=>{const t=Object.keys(n[e]).map((t=>`<div class="line-strip" style="background-color: ${n[e][t]};"></div><span>${t}</span>`)).join("<br>");return`<strong>${e}</strong><br>${t}`})).join("<br>"),"</div>"].join(""))}}s&&r.addTo(n)}updateBusRouteVisibility(){const e=this,t=e.map;for(const i of e.gtfs.values()){const{id:n,routes:r}=i,o=new Set;for(const e of r.getAll())if(!e.hidden)for(const t of e.shapes)o.add(t);for(const e of i.featureLookup.keys())o.has(e)?t.removeFeatureState({source:n,id:e},"hidden"):t.setFeatureState({source:n,id:e},{hidden:!0});for(const t of i.activeBusLookup.values()){const i=r.get(t.trip.route);i&&!i.hidden||e.stopBus(t)}}delete e.lastRefresh,delete e.lastRealtimeCheck}updateBusRouteHighlight(e,t){const i=this,n=i.map;if(e){const r=i.gtfs.get(e),o=r.routes.get(t);for(const t of o.shapes)n.setFeatureState({source:e,id:t},{"route-highlight":o.color||r.color})}else for(const e of i.gtfs.values())for(const t of e.featureLookup.keys())n.removeFeatureState({source:e.id,id:t},"route-highlight")}updateBusTripHighlight(e){const t=this,{map:i,markedObject:n,trackedObject:r}=t,{gtfsId:o,trip:s}=e,a=o,l=s.shape;if(n&&"bus"===n.type&&n.gtfsId===o&&n.trip.shape===l||r&&"bus"===r.type&&r.gtfsId===o&&r.trip.shape===l){const e=t.gtfs.get(o),n=e.routes.get(s.route).color;i.setFeatureState({source:a,id:l},{"trip-highlight":n||e.color})}else i.removeFeatureState({source:a,id:l},"trip-highlight")}addStationOutline(e,t){const i=this,n=e.stations[0].id;for(const e of[13,14,15,16,17,18])setLayerProps(i.map,`${t}-${e}`,{data:featureFilter(i.featureCollection,(t=>t.zoom===e&&t.ids&&t.ids[0]===n)),opacity:1,visible:!0})}removeStationOutline(e){for(const t of[13,14,15,16,17,18])setLayerProps(this.map,`${e}-${t}`,{visible:!1})}refreshStationOutline(){const e=blink();for(const t of[13,14,15,16,17,18])setLayerProps(this.map,`stations-selected-${t}`,{opacity:e,visible:!0})}setSectionData(e,t,i){const n=e.r.stations,{direction:r,timetable:o}=e,s=(e.ds||[])[0],a=e.delay||0,l=this.clock.getTimeOffset();let c,u,h,d,p,f,m,g;if(o){const e=o.stations;c=o.arrivalTimes,u=o.departureTimes,h=valueOrDefault(t,u.reduce(((e,t,i)=>void 0!==t&&t+a<=l?i:e),0)),d=e[h],p=e[h+1]}else d=e.fs||e.ts,p=e.ts||e.fs;if(r>0?(f=n.indexOf(d),m=n.indexOf(p,f),g=n.indexOf(s,f),-1===g&&(g=n.length-1)):(f=n.lastIndexOf(d),m=n.lastIndexOf(p,f),g=n.lastIndexOf(s,f),-1===g&&(g=0)),o){if(e.timetableIndex=h,e.departureStation=d,e.departureTime=valueOrDefault(u[h],c[h]),f>=0&&m>=0)return e.sectionIndex=f,e.sectionLength=m-f,e.arrivalStation=p,e.arrivalTime=c[h+1],e.nextDepartureTime=u[h+1],!0}else{let t;if(t=void 0===e.sectionIndex?m=f:e.sectionIndex+e.sectionLength,e.departureStation=d,t>=0&&t!==g&&(!i&&m>=0||i&&g>=0))return e.sectionIndex=t,e.sectionLength=(i?g:m)-t,e.arrivalStation=p===d?n[t+r]:p,!0}e.arrivalStation=e.arrivalTime=void 0}setBusSectionData(e,t,i){const n=e.trip.stopSequences,r=this.clock.getTimeOffset();let o,s;void 0===e.stop?(o=e.trip.departureTimes,s=valueOrDefault(t,o.reduce(((e,t,i)=>t<=r?i:e),0))):s=n.indexOf(e.stop);const a=n.length-1;if(void 0===e.stop){if(s!==a)return e.sectionIndex=s,e.sectionLength=1,e.departureTime=o[s],e.nextDepartureTime=o[s+1],!0}else{let t,n;if(void 0===e.sectionIndex?t=n=s:(t=e.sectionIndex+e.sectionLength,n=Math.min(s+1,a)),!i&&t!==a)return e.sectionIndex=t,e.sectionLength=n-t,!0}}}function initContainer(e){const t=createElement$1("div",{id:"map"},e);return createElement$1("div",{id:"loader",className:"loader-inner ball-pulse",innerHTML:"<div></div><div></div><div></div>"},e),createElement$1("div",{id:"loading-error"},e),e.classList.add("mini-tokyo-3d"),t}function showLoader(e){const t=e.querySelector("#loader");t.style.opacity=1,t.style.display="block"}function hideLoader(e){const t=e.querySelector("#loader");t.style.opacity=0,setTimeout((()=>{t.style.display="none"}),1e3)}function showErrorMessage(e){const t=e.querySelector("#loader"),i=e.querySelector("#loading-error");t.style.display="none",i.innerHTML="Loading failed. Please reload the page.",i.style.display="block"}function easeInQuad(e){return e*e}function easeOutQuart(e){return-((e-=1)*e*e*e-1)}function createInterpolant(e,t){const i=e.length,n=[],r=[];for(let o=0;o<i-1;o++){const i=e[o+1]-e[o],s=t[o+1]-t[o];n.push(i),r.push(s/i)}const o=[r[0]];for(let e=0;e<n.length-1;e++){const t=r[e],i=r[e+1];if(t*i<=0)o.push(0);else{const r=n[e],s=n[e+1],a=r+s;o.push(3*a/((a+s)/t+(a+r)/i))}}o.push(r[r.length-1]);const s=[],a=[];for(let e=0;e<o.length-1;e++){const t=o[e],i=r[e],l=1/n[e],c=t+o[e+1]-i-i;s.push((i-t-c)*l),a.push(c*l*l)}return i=>{let n=e.length-1;if(i===e[n])return t[n];let r,l=0,c=a.length-1;for(;l<=c;){r=Math.floor(.5*(l+c));const n=e[r];if(n<i)l=r+1;else{if(!(n>i))return t[r];c=r-1}}n=Math.max(0,c);const u=i-e[n],h=u*u;return t[n]+o[n]*u+s[n]*h+a[n]*u*h}}function getLayerZoom(e){return clamp$3(Math.floor(e),13,18)}function isVehicle(e){return e&&includes(["train","flight","bus"],e.type)}function isStation(e){return e&&"station"===e.type}function isEqualObject(e,t){return e===t||!!(e&&e.properties&&t&&t.properties&&e.properties.ids===t.properties.ids)}class Popup{constructor(){this._popup=new Popup$1({className:isTouchDevice()?"popup-object popup-touch":"popup-object",closeButton:!1,closeOnClick:!1,maxWidth:"300px",offset:{top:[0,10],bottom:[0,-30]},openingAnimation:{duration:300,easing:"easeOutBack"}})}addTo(e){return this._popup.addTo(e.map),this}remove(){return this._popup.remove(),this}setLngLat(e){return this._popup.setLngLat(e),this}setHTML(e){return this._popup.setHTML(e),this}}class GLTFLoader extends Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new GLTFMaterialsClearcoatExtension(e)})),this.register((function(e){return new GLTFMaterialsDispersionExtension(e)})),this.register((function(e){return new GLTFTextureBasisUExtension(e)})),this.register((function(e){return new GLTFTextureWebPExtension(e)})),this.register((function(e){return new GLTFTextureAVIFExtension(e)})),this.register((function(e){return new GLTFMaterialsSheenExtension(e)})),this.register((function(e){return new GLTFMaterialsTransmissionExtension(e)})),this.register((function(e){return new GLTFMaterialsVolumeExtension(e)})),this.register((function(e){return new GLTFMaterialsIorExtension(e)})),this.register((function(e){return new GLTFMaterialsEmissiveStrengthExtension(e)})),this.register((function(e){return new GLTFMaterialsSpecularExtension(e)})),this.register((function(e){return new GLTFMaterialsIridescenceExtension(e)})),this.register((function(e){return new GLTFMaterialsAnisotropyExtension(e)})),this.register((function(e){return new GLTFMaterialsBumpExtension(e)})),this.register((function(e){return new GLTFLightsExtension(e)})),this.register((function(e){return new GLTFMeshoptCompression(e)})),this.register((function(e){return new GLTFMeshGpuInstancing(e)}))}load(e,t,i,n){const r=this;let o;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){const t=LoaderUtils.extractUrlBase(e);o=LoaderUtils.resolveURL(t,this.path)}else o=LoaderUtils.extractUrlBase(e);this.manager.itemStart(e);const s=function(t){n&&n(t),r.manager.itemError(e),r.manager.itemEnd(e)},a=new FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,(function(i){try{r.parse(i,o,(function(i){t(i),r.manager.itemEnd(e)}),s)}catch(e){s(e)}}),i,s)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,n){let r;const o={},s={},a=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){if(a.decode(new Uint8Array(e,0,4))===BINARY_EXTENSION_HEADER_MAGIC){try{o[EXTENSIONS.KHR_BINARY_GLTF]=new GLTFBinaryExtension(e)}catch(e){return void(n&&n(e))}r=JSON.parse(o[EXTENSIONS.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new GLTFParser(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);s[t.name]=t,o[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){const t=r.extensionsUsed[e],i=r.extensionsRequired||[];switch(t){case EXTENSIONS.KHR_MATERIALS_UNLIT:o[t]=new GLTFMaterialsUnlitExtension;break;case EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:o[t]=new GLTFDracoMeshCompressionExtension(r,this.dracoLoader);break;case EXTENSIONS.KHR_TEXTURE_TRANSFORM:o[t]=new GLTFTextureTransformExtension;break;case EXTENSIONS.KHR_MESH_QUANTIZATION:o[t]=new GLTFMeshQuantizationExtension;break;default:i.indexOf(t)}}l.setExtensions(o),l.setPlugins(s),l.parse(i,n)}parseAsync(e,t){const i=this;return new Promise((function(n,r){i.parse(e,t,n,r)}))}}function GLTFRegistry(){let e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const EXTENSIONS={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class GLTFLightsExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,n=t.length;i<n;i++){const n=t[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let n=t.cache.get(i);if(n)return n;const r=t.json,o=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let s;const a=new Color(16777215);void 0!==o.color&&a.setRGB(o.color[0],o.color[1],o.color[2],LinearSRGBColorSpace);const l=void 0!==o.range?o.range:0;switch(o.type){case"directional":s=new DirectionalLight(a),s.target.position.set(0,0,-1),s.add(s.target);break;case"point":s=new PointLight(a),s.distance=l;break;case"spot":s=new SpotLight(a),s.distance=l,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,s.angle=o.spot.outerConeAngle,s.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return s.position.set(0,0,0),assignExtrasToUserData(s,o),void 0!==o.intensity&&(s.intensity=o.intensity),s.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(s),t.cache.add(i,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,n=i.json.nodes[e],r=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return i._getNodeRef(t.cache,r,e)}))}}class GLTFMaterialsUnlitExtension{constructor(){this.name=EXTENSIONS.KHR_MATERIALS_UNLIT}getMaterialType(){return MeshBasicMaterial}extendParams(e,t,i){const n=[];e.color=new Color(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],LinearSRGBColorSpace),e.opacity=t[3]}void 0!==r.baseColorTexture&&n.push(i.assignTexture(e,"map",r.baseColorTexture,SRGBColorSpace))}return Promise.all(n)}}class GLTFMaterialsEmissiveStrengthExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}}class GLTFMaterialsClearcoatExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&r.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&r.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(r.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Vector2(e,e)}return Promise.all(r)}}class GLTFMaterialsDispersionExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.dispersion=void 0!==n.dispersion?n.dispersion:0,Promise.resolve()}}class GLTFMaterialsIridescenceExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&r.push(i.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&r.push(i.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class GLTFMaterialsSheenExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new Color(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(void 0!==o.sheenColorFactor){const e=o.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],LinearSRGBColorSpace)}return void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&r.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,SRGBColorSpace)),void 0!==o.sheenRoughnessTexture&&r.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class GLTFMaterialsTransmissionExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&r.push(i.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class GLTFMaterialsVolumeExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&r.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const s=o.attenuationColor||[1,1,1];return t.attenuationColor=(new Color).setRGB(s[0],s[1],s[2],LinearSRGBColorSpace),Promise.all(r)}}class GLTFMaterialsIorExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class GLTFMaterialsSpecularExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&r.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const s=o.specularColorFactor||[1,1,1];return t.specularColor=(new Color).setRGB(s[0],s[1],s[2],LinearSRGBColorSpace),void 0!==o.specularColorTexture&&r.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,SRGBColorSpace)),Promise.all(r)}}class GLTFMaterialsBumpExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&r.push(i.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(r)}}class GLTFMaterialsAnisotropyExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],o=n.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&r.push(i.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class GLTFTextureBasisUExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class GLTFTextureWebPExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,i=this.parser,n=i.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],s=n.images[o.source];let a=i.textureLoader;if(s.uri){const e=i.options.manager.getHandler(s.uri);null!==e&&(a=e)}return i.loadTextureImage(e,o.source,a)}}class GLTFTextureAVIFExtension{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,i=this.parser,n=i.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],s=n.images[o.source];let a=i.textureLoader;if(s.uri){const e=i.options.manager.getHandler(s.uri);null!==e&&(a=e)}return i.loadTextureImage(e,o.source,a)}}class GLTFMeshoptCompression{constructor(e){this.name=EXTENSIONS.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const e=i.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then((function(t){const i=e.count,n=e.byteStride,o=new Uint8Array(t,e.byteOffset||0,e.byteLength||0);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(i,n,o,e.mode,e.filter).then((function(e){return e.buffer})):r.ready.then((function(){const t=new ArrayBuffer(i*n);return r.decodeGltfBuffer(new Uint8Array(t),i,n,o,e.mode,e.filter),t}))}))}return null}}class GLTFMeshGpuInstancing{constructor(e){this.name=EXTENSIONS.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||void 0===i.mesh)return null;const n=t.meshes[i.mesh];for(const e of n.primitives)if(e.mode!==WEBGL_CONSTANTS.TRIANGLES&&e.mode!==WEBGL_CONSTANTS.TRIANGLE_STRIP&&e.mode!==WEBGL_CONSTANTS.TRIANGLE_FAN&&void 0!==e.mode)return null;const r=i.extensions[this.name].attributes,o=[],s={};for(const e in r)o.push(this.parser.getDependency("accessor",r[e]).then((t=>(s[e]=t,s[e]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then((e=>{const t=e.pop(),i=t.isGroup?t.children:[t],n=e[0].count,r=[];for(const e of i){const t=new Matrix4,i=new Vector3,o=new Quaternion,a=new Vector3(1,1,1),l=new InstancedMesh(e.geometry,e.material,n);for(let e=0;e<n;e++)s.TRANSLATION&&i.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&o.fromBufferAttribute(s.ROTATION,e),s.SCALE&&a.fromBufferAttribute(s.SCALE,e),l.setMatrixAt(e,t.compose(i,o,a));for(const t in s)if("_COLOR_0"===t){const e=s[t];l.instanceColor=new InstancedBufferAttribute(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);Object3D.prototype.copy.call(l,e),this.parser.assignFinalMaterial(l),r.push(l)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]})))}}const BINARY_EXTENSION_HEADER_MAGIC="glTF",BINARY_EXTENSION_HEADER_LENGTH=12,BINARY_EXTENSION_CHUNK_TYPES={JSON:1313821514,BIN:5130562};class GLTFBinaryExtension{constructor(e){this.name=EXTENSIONS.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,BINARY_EXTENSION_HEADER_LENGTH),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==BINARY_EXTENSION_HEADER_MAGIC)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-BINARY_EXTENSION_HEADER_LENGTH,r=new DataView(e,BINARY_EXTENSION_HEADER_LENGTH);let o=0;for(;o<n;){const t=r.getUint32(o,!0);o+=4;const n=r.getUint32(o,!0);if(o+=4,n===BINARY_EXTENSION_CHUNK_TYPES.JSON){const n=new Uint8Array(e,BINARY_EXTENSION_HEADER_LENGTH+o,t);this.content=i.decode(n)}else if(n===BINARY_EXTENSION_CHUNK_TYPES.BIN){const i=BINARY_EXTENSION_HEADER_LENGTH+o;this.body=e.slice(i,i+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class GLTFDracoMeshCompressionExtension{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=EXTENSIONS.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,s={},a={},l={};for(const e in o){const t=ATTRIBUTES[e]||e.toLowerCase();s[t]=o[e]}for(const t in e.attributes){const n=ATTRIBUTES[t]||t.toLowerCase();if(void 0!==o[t]){const r=i.accessors[e.attributes[t]];l[n]=WEBGL_COMPONENT_TYPES[r.componentType].name,a[n]=!0===r.normalized}}return t.getDependency("bufferView",r).then((function(e){return new Promise((function(t,i){n.decodeDracoFile(e,(function(e){for(const t in e.attributes){const i=a[t];void 0!==i&&(e.attributes[t].normalized=i)}t(e)}),s,l,LinearSRGBColorSpace,i)}))}))}}class GLTFTextureTransformExtension{constructor(){this.name=EXTENSIONS.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class GLTFMeshQuantizationExtension{constructor(){this.name=EXTENSIONS.KHR_MESH_QUANTIZATION}}class GLTFCubicSplineInterpolant extends Interpolant{constructor(e,t,i,n){super(e,t,i,n)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let e=0;e!==n;e++)t[e]=i[r+e];return t}interpolate_(e,t,i,n){const r=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=n-t,u=(i-t)/c,h=u*u,d=h*u,p=e*l,f=p-l,m=-2*d+3*h,g=d-h,_=1-m,y=g-h+u;for(let e=0;e!==s;e++){r[e]=_*o[f+e+s]+y*(o[f+e+a]*c)+m*o[p+e+s]+g*(o[p+e]*c)}return r}}const _quaternion=new Quaternion;class GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant{interpolate_(e,t,i,n){const r=super.interpolate_(e,t,i,n);return _quaternion.fromArray(r).normalize().toArray(r),r}}const WEBGL_CONSTANTS={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},WEBGL_COMPONENT_TYPES={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},WEBGL_FILTERS={9728:NearestFilter,9729:LinearFilter,9984:NearestMipmapNearestFilter,9985:LinearMipmapNearestFilter,9986:NearestMipmapLinearFilter,9987:LinearMipmapLinearFilter},WEBGL_WRAPPINGS={33071:ClampToEdgeWrapping,33648:MirroredRepeatWrapping,10497:RepeatWrapping},WEBGL_TYPE_SIZES={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTES={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},PATH_PROPERTIES={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},INTERPOLATION={CUBICSPLINE:void 0,LINEAR:InterpolateLinear,STEP:InterpolateDiscrete},ALPHA_MODES={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function createDefaultMaterial(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:FrontSide})),e.DefaultMaterial}function addUnknownExtensionsToUserData(e,t,i){for(const n in i.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=i.extensions[n])}function assignExtrasToUserData(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function addMorphTargets(e,t,i){let n=!1,r=!1,o=!1;for(let e=0,i=t.length;e<i;e++){const i=t[e];if(void 0!==i.POSITION&&(n=!0),void 0!==i.NORMAL&&(r=!0),void 0!==i.COLOR_0&&(o=!0),n&&r&&o)break}if(!n&&!r&&!o)return Promise.resolve(e);const s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){const u=t[c];if(n){const t=void 0!==u.POSITION?i.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(r){const t=void 0!==u.NORMAL?i.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){const t=void 0!==u.COLOR_0?i.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then((function(t){const i=t[1],s=t[2];return n&&(e.morphAttributes.position=t[0]),r&&(e.morphAttributes.normal=i),o&&(e.morphAttributes.color=s),e.morphTargetsRelative=!0,e}))}function updateMorphTargets(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let i=0,n=t.weights.length;i<n;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){const i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(let t=0,n=i.length;t<n;t++)e.morphTargetDictionary[i[t]]=t}}}function createPrimitiveKey(e){let t;const i=e.extensions&&e.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION];if(t=i?"draco:"+i.bufferView+":"+i.indices+":"+createAttributesKey(i.attributes):e.indices+":"+createAttributesKey(e.attributes)+":"+e.mode,void 0!==e.targets)for(let i=0,n=e.targets.length;i<n;i++)t+=":"+createAttributesKey(e.targets[i]);return t}function createAttributesKey(e){let t="";const i=Object.keys(e).sort();for(let n=0,r=i.length;n<r;n++)t+=i[n]+":"+e[i[n]]+";";return t}function getNormalizedComponentScale(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function getImageURIMimeType(e){return e.search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":e.search(/\.ktx2($|\?)/i)>0||0===e.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"}const _identityMatrix=new Matrix4;class GLTFParser{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,n=-1,r=!1,o=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;i=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);n=i&&t?parseInt(t[1],10):-1,r=e.indexOf("Firefox")>-1,o=r?e.match(/Firefox\/([0-9]+)\./)[1]:-1}this.textureLoader="undefined"==typeof createImageBitmap||i&&n<17||r&&o<98?new TextureLoader(this.options.manager):new ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){const o={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:i,userData:{}};return addUnknownExtensionsToUserData(r,o,n),assignExtrasToUserData(o,n),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(o)}))).then((function(){for(const e of o.scenes)e.updateMatrixWorld();e(o)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let i=0,n=t.length;i<n;i++){const n=t[i].joints;for(let t=0,i=n.length;t<i;t++)e[n[t]].isBone=!0}for(let t=0,n=e.length;t<n;t++){const n=e[t];void 0!==n.mesh&&(this._addNodeRef(this.meshCache,n.mesh),void 0!==n.skin&&(i[n.mesh].isSkinnedMesh=!0)),void 0!==n.camera&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const n=i.clone(),r=(e,t)=>{const i=this.associations.get(e);null!=i&&this.associations.set(t,i);for(const[i,n]of e.children.entries())r(n,t.children[i])};return r(i,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const n=e(t[i]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&i.push(r)}return i}getDependency(e,t){const i=e+":"+t;let n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne((function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)})),!n)throw new Error("Unknown type: "+e)}this.cache.add(i,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map((function(t,n){return i.getDependency(e,n)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[EXTENSIONS.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,r){i.load(LoaderUtils.resolveURL(t.uri,n.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const i=t.byteOffset||0;return e.slice(i,i+(t.byteLength||0))}))}loadAccessor(e){const t=this,i=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=WEBGL_TYPE_SIZES[n.type],t=!0===n.normalized,i=new(0,WEBGL_COMPONENT_TYPES[n.componentType])(n.count*e);return Promise.resolve(new BufferAttribute(i,e,t))}const r=[];return r.push(void 0!==n.bufferView?this.getDependency("bufferView",n.bufferView):null),void 0!==n.sparse&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],o=WEBGL_TYPE_SIZES[n.type],s=WEBGL_COMPONENT_TYPES[n.componentType],a=s.BYTES_PER_ELEMENT,l=n.byteOffset||0,c=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,u=!0===n.normalized;let h,d;if(c&&c!==a*o){const e=Math.floor(l/c),i="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let p=t.cache.get(i);p||(h=new s(r,e*c,n.count*c/a),p=new InterleavedBuffer(h,c/a),t.cache.add(i,p)),d=new InterleavedBufferAttribute(p,o,l%c/a,u)}else h=null===r?new s(n.count*o):new s(r,l,n.count*o),d=new BufferAttribute(h,o,u);if(void 0!==n.sparse){const t=n.sparse.values.byteOffset||0,i=new(0,WEBGL_COMPONENT_TYPES[n.sparse.indices.componentType])(e[1],n.sparse.indices.byteOffset||0,n.sparse.count*WEBGL_TYPE_SIZES.SCALAR),a=new s(e[2],t,n.sparse.count*o);null!==r&&(d=new BufferAttribute(d.array.slice(),d.itemSize,d.normalized)),d.normalized=!1;for(let e=0,t=i.length;e<t;e++){const t=i[e];if(d.setX(t,a[e*o]),o>=2&&d.setY(t,a[e*o+1]),o>=3&&d.setZ(t,a[e*o+2]),o>=4&&d.setW(t,a[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}d.normalized=u}return d}))}loadTexture(e){const t=this.json,i=t.textures[e].source,n=t.images[i];let r=this.textureLoader;if(n.uri){const e=this.options.manager.getHandler(n.uri);null!==e&&(r=e)}return this.loadTextureImage(e,i,r)}loadTextureImage(e,t,i){const n=this,r=this.json,o=r.textures[e],s=r.images[t],a=(s.uri||s.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const l=this.loadImageSource(t,i).then((function(t){t.flipY=!1,t.name=o.name||s.name||"",""===t.name&&"string"==typeof s.uri&&!1===s.uri.startsWith("data:image/")&&(t.name=s.uri);const i=(r.samplers||{})[o.sampler]||{};return t.magFilter=WEBGL_FILTERS[i.magFilter]||LinearFilter,t.minFilter=WEBGL_FILTERS[i.minFilter]||LinearMipmapLinearFilter,t.wrapS=WEBGL_WRAPPINGS[i.wrapS]||RepeatWrapping,t.wrapT=WEBGL_WRAPPINGS[i.wrapT]||RepeatWrapping,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==NearestFilter&&t.minFilter!==LinearFilter,n.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[a]=l,l}loadImageSource(e,t){const i=this,n=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const o=n.images[e],s=self.URL||self.webkitURL;let a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=i.getDependency("bufferView",o.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t),a}));else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(a).then((function(e){return new Promise((function(i,n){let o=i;!0===t.isImageBitmapLoader&&(o=function(e){const t=new Texture(e);t.needsUpdate=!0,i(t)}),t.load(LoaderUtils.resolveURL(e,r.path),o,void 0,n)}))})).then((function(e){return!0===l&&s.revokeObjectURL(a),assignExtrasToUserData(e,o),e.userData.mimeType=o.mimeType||getImageURIMimeType(o.uri),e})).catch((function(e){throw e}));return this.sourceCache[e]=c,c}assignTexture(e,t,i,n){const r=this;return this.getDependency("texture",i.index).then((function(o){if(!o)return null;if(void 0!==i.texCoord&&i.texCoord>0&&((o=o.clone()).channel=i.texCoord),r.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]){const e=void 0!==i.extensions?i.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(o);o=r.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),r.associations.set(o,t)}}return void 0!==n&&(o.colorSpace=n),e[t]=o,o}))}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const n=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new PointsMaterial,Material.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,t.sizeAttenuation=!1,this.cache.add(e,t)),i=t}else if(e.isLine){const e="LineBasicMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new LineBasicMaterial,Material.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,this.cache.add(e,t)),i=t}if(n||r||o){let e="ClonedMaterial:"+i.uuid+":";n&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=i.clone(),r&&(t.vertexColors=!0),o&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(i))),i=t}e.material=i}getMaterialType(){return MeshStandardMaterial}loadMaterial(e){const t=this,i=this.extensions,n=this.json.materials[e];let r;const o={},s=[];if((n.extensions||{})[EXTENSIONS.KHR_MATERIALS_UNLIT]){const e=i[EXTENSIONS.KHR_MATERIALS_UNLIT];r=e.getMaterialType(),s.push(e.extendParams(o,n,t))}else{const i=n.pbrMetallicRoughness||{};if(o.color=new Color(1,1,1),o.opacity=1,Array.isArray(i.baseColorFactor)){const e=i.baseColorFactor;o.color.setRGB(e[0],e[1],e[2],LinearSRGBColorSpace),o.opacity=e[3]}void 0!==i.baseColorTexture&&s.push(t.assignTexture(o,"map",i.baseColorTexture,SRGBColorSpace)),o.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,o.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(s.push(t.assignTexture(o,"metalnessMap",i.metallicRoughnessTexture)),s.push(t.assignTexture(o,"roughnessMap",i.metallicRoughnessTexture))),r=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),s.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===n.doubleSided&&(o.side=DoubleSide);const a=n.alphaMode||ALPHA_MODES.OPAQUE;if(a===ALPHA_MODES.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,a===ALPHA_MODES.MASK&&(o.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&r!==MeshBasicMaterial&&(s.push(t.assignTexture(o,"normalMap",n.normalTexture)),o.normalScale=new Vector2(1,1),void 0!==n.normalTexture.scale)){const e=n.normalTexture.scale;o.normalScale.set(e,e)}if(void 0!==n.occlusionTexture&&r!==MeshBasicMaterial&&(s.push(t.assignTexture(o,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(o.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&r!==MeshBasicMaterial){const e=n.emissiveFactor;o.emissive=(new Color).setRGB(e[0],e[1],e[2],LinearSRGBColorSpace)}return void 0!==n.emissiveTexture&&r!==MeshBasicMaterial&&s.push(t.assignTexture(o,"emissiveMap",n.emissiveTexture,SRGBColorSpace)),Promise.all(s).then((function(){const s=new r(o);return n.name&&(s.name=n.name),assignExtrasToUserData(s,n),t.associations.set(s,{materials:e}),n.extensions&&addUnknownExtensionsToUserData(i,s,n),s}))}createUniqueName(e){const t=PropertyBinding.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,n=this.primitiveCache;function r(e){return i[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return addPrimitiveAttributes(i,e,t)}))}const o=[];for(let i=0,s=e.length;i<s;i++){const s=e[i],a=createPrimitiveKey(s),l=n[a];if(l)o.push(l.promise);else{let e;e=s.extensions&&s.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION]?r(s):addPrimitiveAttributes(new BufferGeometry,s,t),n[a]={primitive:s,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.extensions,n=this.json.meshes[e],r=n.primitives,o=[];for(let e=0,t=r.length;e<t;e++){const t=void 0===r[e].material?createDefaultMaterial(this.cache):this.getDependency("material",r[e].material);o.push(t)}return o.push(t.loadGeometries(r)),Promise.all(o).then((function(o){const s=o.slice(0,o.length-1),a=o[o.length-1],l=[];for(let o=0,c=a.length;o<c;o++){const c=a[o],u=r[o];let h;const d=s[o];if(u.mode===WEBGL_CONSTANTS.TRIANGLES||u.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP||u.mode===WEBGL_CONSTANTS.TRIANGLE_FAN||void 0===u.mode)h=!0===n.isSkinnedMesh?new SkinnedMesh(c,d):new Mesh(c,d),!0===h.isSkinnedMesh&&h.normalizeSkinWeights(),u.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP?h.geometry=toTrianglesDrawMode(h.geometry,TriangleStripDrawMode):u.mode===WEBGL_CONSTANTS.TRIANGLE_FAN&&(h.geometry=toTrianglesDrawMode(h.geometry,TriangleFanDrawMode));else if(u.mode===WEBGL_CONSTANTS.LINES)h=new LineSegments(c,d);else if(u.mode===WEBGL_CONSTANTS.LINE_STRIP)h=new Line(c,d);else if(u.mode===WEBGL_CONSTANTS.LINE_LOOP)h=new LineLoop(c,d);else{if(u.mode!==WEBGL_CONSTANTS.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);h=new Points(c,d)}Object.keys(h.geometry.morphAttributes).length>0&&updateMorphTargets(h,n),h.name=t.createUniqueName(n.name||"mesh_"+e),assignExtrasToUserData(h,n),u.extensions&&addUnknownExtensionsToUserData(i,h,u),t.assignFinalMaterial(h),l.push(h)}for(let i=0,n=l.length;i<n;i++)t.associations.set(l[i],{meshes:e,primitives:i});if(1===l.length)return n.extensions&&addUnknownExtensionsToUserData(i,l[0],n),l[0];const c=new Group;n.extensions&&addUnknownExtensionsToUserData(i,c,n),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c}))}loadCamera(e){let t;const i=this.json.cameras[e],n=i[i.type];if(n)return"perspective"===i.type?t=new PerspectiveCamera(MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(t=new OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),assignExtrasToUserData(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let e=0,n=t.joints.length;e<n;e++)i.push(this._loadNodeShallow(t.joints[e]));return i.push(void 0!==t.inverseBindMatrices?this.getDependency("accessor",t.inverseBindMatrices):null),Promise.all(i).then((function(e){const t=e.pop(),i=e,n=[],r=[];for(let e=0,o=i.length;e<o;e++){const o=i[e];if(o){n.push(o);const i=new Matrix4;null!==t&&i.fromArray(t.array,16*e),r.push(i)}}return new Skeleton(n,r)}))}loadAnimation(e){const t=this,i=this.json.animations[e],n=i.name?i.name:"animation_"+e,r=[],o=[],s=[],a=[],l=[];for(let e=0,t=i.channels.length;e<t;e++){const t=i.channels[e],n=i.samplers[t.sampler],c=t.target,u=void 0!==i.parameters?i.parameters[n.input]:n.input,h=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==c.node&&(r.push(this.getDependency("node",c.node)),o.push(this.getDependency("accessor",u)),s.push(this.getDependency("accessor",h)),a.push(n),l.push(c))}return Promise.all([Promise.all(r),Promise.all(o),Promise.all(s),Promise.all(a),Promise.all(l)]).then((function(e){const r=e[0],o=e[1],s=e[2],a=e[3],l=e[4],c=[];for(let e=0,i=r.length;e<i;e++){const i=r[e],n=o[e],u=s[e],h=a[e],d=l[e];if(void 0===i)continue;i.updateMatrix&&i.updateMatrix();const p=t._createAnimationTracks(i,n,u,h,d);if(p)for(let e=0;e<p.length;e++)c.push(p[e])}const u=new AnimationClip(n,void 0,c);return assignExtrasToUserData(u,i),u}))}createNodeMesh(e){const t=this,i=this.json.nodes[e];return void 0===i.mesh?null:t.getDependency("mesh",i.mesh).then((function(e){const n=t._getNodeRef(t.meshCache,i.mesh,e);return void 0!==i.weights&&n.traverse((function(e){if(e.isMesh)for(let t=0,n=i.weights.length;t<n;t++)e.morphTargetInfluences[t]=i.weights[t]})),n}))}loadNode(e){const t=this,i=this.json.nodes[e],n=t._loadNodeShallow(e),r=[],o=i.children||[];for(let e=0,i=o.length;e<i;e++)r.push(t.getDependency("node",o[e]));const s=void 0===i.skin?Promise.resolve(null):t.getDependency("skin",i.skin);return Promise.all([n,Promise.all(r),s]).then((function(e){const t=e[0],i=e[1],n=e[2];null!==n&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(n,_identityMatrix)}));for(let e=0,n=i.length;e<n;e++)t.add(i[e]);return t}))}_loadNodeShallow(e){const t=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const n=this.json.nodes[e],r=n.name?i.createUniqueName(n.name):"",o=[],s=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return s&&o.push(s),void 0!==n.camera&&o.push(i.getDependency("camera",n.camera).then((function(e){return i._getNodeRef(i.cameraCache,n.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){o.push(e)})),this.nodeCache[e]=Promise.all(o).then((function(o){let s;if(s=!0===n.isBone?new Bone:o.length>1?new Group:1===o.length?o[0]:new Object3D,s!==o[0])for(let e=0,t=o.length;e<t;e++)s.add(o[e]);if(n.name&&(s.userData.name=n.name,s.name=r),assignExtrasToUserData(s,n),n.extensions&&addUnknownExtensionsToUserData(t,s,n),void 0!==n.matrix){const e=new Matrix4;e.fromArray(n.matrix),s.applyMatrix4(e)}else void 0!==n.translation&&s.position.fromArray(n.translation),void 0!==n.rotation&&s.quaternion.fromArray(n.rotation),void 0!==n.scale&&s.scale.fromArray(n.scale);if(i.associations.has(s)){if(void 0!==n.mesh&&i.meshCache.refs[n.mesh]>1){const e=i.associations.get(s);i.associations.set(s,{...e})}}else i.associations.set(s,{});return i.associations.get(s).nodes=e,s})),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],n=this,r=new Group;i.name&&(r.name=n.createUniqueName(i.name)),assignExtrasToUserData(r,i),i.extensions&&addUnknownExtensionsToUserData(t,r,i);const o=i.nodes||[],s=[];for(let e=0,t=o.length;e<t;e++)s.push(n.getDependency("node",o[e]));return Promise.all(s).then((function(e){for(let t=0,i=e.length;t<i;t++)r.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[e,i]of n.associations)(e instanceof Material||e instanceof Texture)&&t.set(e,i);return e.traverse((e=>{const i=n.associations.get(e);null!=i&&t.set(e,i)})),t})(r),r}))}_createAnimationTracks(e,t,i,n,r){const o=[],s=e.name?e.name:e.uuid,a=[];let l;switch(PATH_PROPERTIES[r.path]===PATH_PROPERTIES.weights?e.traverse((function(e){e.morphTargetInfluences&&a.push(e.name?e.name:e.uuid)})):a.push(s),PATH_PROPERTIES[r.path]){case PATH_PROPERTIES.weights:l=NumberKeyframeTrack;break;case PATH_PROPERTIES.rotation:l=QuaternionKeyframeTrack;break;case PATH_PROPERTIES.translation:case PATH_PROPERTIES.scale:l=VectorKeyframeTrack;break;default:if(1===i.itemSize)l=NumberKeyframeTrack;else l=VectorKeyframeTrack}const c=void 0!==n.interpolation?INTERPOLATION[n.interpolation]:InterpolateLinear,u=this._getArrayFromAccessor(i);for(let e=0,i=a.length;e<i;e++){const i=new l(a[e]+"."+PATH_PROPERTIES[r.path],t.array,u,c);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(i),o.push(i)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=getNormalizedComponentScale(t.constructor),i=new Float32Array(t.length);for(let n=0,r=t.length;n<r;n++)i[n]=t[n]*e;t=i}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof QuaternionKeyframeTrack?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function computeBounds(e,t,i){const n=t.attributes,r=new Box3;if(void 0===n.POSITION)return;{const e=i.json.accessors[n.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return;if(r.set(new Vector3(t[0],t[1],t[2]),new Vector3(o[0],o[1],o[2])),e.normalized){const t=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new Vector3,t=new Vector3;for(let n=0,r=o.length;n<r;n++){const r=o[n];if(void 0!==r.POSITION){const n=i.json.accessors[r.POSITION],o=n.min,s=n.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),n.normalized){const e=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[n.componentType]);t.multiplyScalar(e)}e.max(t)}}}r.expandByVector(e)}e.boundingBox=r;const s=new Sphere;r.getCenter(s.center),s.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=s}function addPrimitiveAttributes(e,t,i){const n=t.attributes,r=[];function o(t,n){return i.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(const t in n){const i=ATTRIBUTES[t]||t.toLowerCase();i in e.attributes||r.push(o(n[t],i))}if(void 0!==t.indices&&!e.index){const n=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(n)}return assignExtrasToUserData(e,t),computeBounds(e,t,i),Promise.all(r).then((function(){return void 0!==t.targets?addMorphTargets(e,t.targets,i):e}))}const THREE=Object.assign({GLTFLoader:GLTFLoader},three);var index={mapboxgl:mapboxgl,Marker:Marker,Map:Map$1,Panel:Panel,Popup:Popup,THREE:THREE};return index}));
//# sourceMappingURL=mini-tokyo-3d.min.js.map
